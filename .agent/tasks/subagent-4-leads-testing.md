# Subagent 4: æµ‹è¯•å€ºåŠ¡æ¸…å¿ä»»åŠ¡

## èƒŒæ™¯ä¸èŒè´£
ä½ åœ¨æ‰§è¡Œä¸€æ¡é’ˆå¯¹ Leads (çº¿ç´¢) æ¨¡å—çš„"é¦–è½®æ¨¡å—å®¡è®¡"æ•´æ”¹ä»»åŠ¡ã€‚ä½ çš„èŒè´£èŒƒå›´ä¸“æ³¨äº**æµ‹è¯•æ–‡ä»¶ä¸­ `as any` çš„ç±»å‹å®‰å…¨æ¶ˆé™¤ã€å·²çŸ¥æµ‹è¯•å¤±è´¥çš„ä¿®å¤ã€ä»¥åŠæµ‹è¯•é€»è¾‘çš„å¥å£®æ€§æå‡**ã€‚

**é‡è¦å‰æ**ï¼š
- Subagent 1 å·²å®Œæˆæ•°æ®åº“ Schema ä¿®æ”¹ï¼ˆæ–°å¢äº†æšä¸¾å€¼å’Œå­—æ®µï¼Œè¿è¡Œäº† `pnpm db:generate`ï¼‰ã€‚
- Subagent 2 å’Œ 3 å°†å¹¶è¡Œå¤„ç†å®‰å…¨å’Œ UI/æ–‡æ¡£é—®é¢˜ï¼Œå¯èƒ½ä¿®æ”¹äº† `actions/mutations.ts`, `actions/queries.ts` ç­‰æ–‡ä»¶çš„å‡½æ•°ç­¾åã€‚ä½†ä½ çš„æ ¸å¿ƒå·¥ä½œé›†ä¸­åœ¨ `__tests__/` ç›®å½•ä¸‹ï¼Œå†²çªæ¦‚ç‡å¾ˆä½ã€‚

## ä»»åŠ¡åˆ—è¡¨ (Issues to Fix)

### 1. [Issue 6.1 â€” æœ€é«˜ä¼˜å…ˆçº§] ä¿®å¤ `restore.test.ts` çš„æ–­è¨€å¤±è´¥
- **å—å½±å“æ–‡ä»¶**ï¼š`src/features/leads/__tests__/restore.test.ts`
- **å½“å‰é”™è¯¯ä¿¡æ¯**ï¼š
  ```
  FAIL  src/features/leads/__tests__/restore.test.ts
  Ã— should restore lead successfully
  
  Expected: true
  Received: false
  
  â¯ src/features/leads/__tests__/restore.test.ts:159:36
      157|  const result = await restoreLeadAction(validInput);
      158|
      159|  expect(result.success).toBe(true);
                                       ^
      160|  expect(result.targetStatus).toBe('FOLLOWING_UP');
  ```
- **æ“ä½œè¦æ±‚**ï¼š
  1. é¦–å…ˆé˜…è¯» `src/features/leads/actions/restore.ts` äº†è§£æ¢å¤é€»è¾‘çš„å®Œæ•´æµç¨‹ã€‚
  2. é˜…è¯»æµ‹è¯•æ–‡ä»¶ `restore.test.ts` ä¸­çš„ mock è®¾ç½®å’Œæµ‹è¯•ç”¨ä¾‹ã€‚
  3. åˆ†ææ ¹å› ï¼š
     - Mock æ•°æ®æ˜¯å¦æ­£ç¡®è®¾ç½®äº† `status: 'INVALID'`ï¼Ÿ
     - `db.query.leads.findFirst` çš„ mock è¿”å›å€¼æ˜¯å¦åŒ…å«äº†å‡½æ•°æœŸæœ›çš„æ‰€æœ‰å­—æ®µï¼Ÿ
     - `auth()` çš„ mock æ˜¯å¦è¿”å›äº†æ­£ç¡®çš„ `session` ç»“æ„ï¼ˆå« `tenantId` å’Œ `user.id`ï¼‰ï¼Ÿ
     - `db.transaction` çš„ mock æ˜¯å¦æ­£ç¡®æ¨¡æ‹Ÿäº†äº‹åŠ¡è¡Œä¸ºï¼Ÿ
     - `checkPermission` çš„ mock æ˜¯å¦æ­£ç¡®ï¼Ÿ
  4. æ‰¾åˆ°æ ¹å› åä¿®å¤ mock æˆ–æ–­è¨€ï¼Œä½¿è¯¥æµ‹è¯•é€šè¿‡ã€‚

### 2. [Issue 2.1 â€” Quality éƒ¨åˆ†] æ¶ˆé™¤æµ‹è¯•ä¸­çš„ `as any` ç±»å‹æ–­è¨€
- **å—å½±å“æ–‡ä»¶**ï¼š`src/features/leads/__tests__/` ç›®å½•ä¸‹çš„æ‰€æœ‰æµ‹è¯•æ–‡ä»¶
- **é—®é¢˜è¯´æ˜**ï¼šæµ‹è¯•ä»£ç ä¸­å¤§é‡ä½¿ç”¨ `as any` æ¥ç»•è¿‡ TypeScript ç±»å‹æ£€æŸ¥ï¼Œè¿™é™ä½äº†æµ‹è¯•çš„å¯é æ€§ï¼Œå› ä¸ºå®ƒæ©ç›–äº†æ¥å£å˜æ›´å¸¦æ¥çš„çœŸæ­£ç ´åã€‚
- **æ“ä½œè¦æ±‚**ï¼š
  - åœ¨æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä¸­æœç´¢ `as any`ã€‚
  - é€ä¸€åˆ†ææ¯ä¸ª `as any` çš„ä½¿ç”¨åœºæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„æ›¿æ¢ç­–ç•¥ï¼š
    - **Mock å¯¹è±¡ä¸å®Œæ•´**ï¼šè¡¥å…¨ç¼ºå¤±çš„å¿…éœ€å±æ€§ï¼Œä½¿å…¶åŒ¹é…å®é™…ç±»å‹ã€‚å¦‚æœå±æ€§å¾ˆå¤šï¼Œå¯ä»¥ä½¿ç”¨ `Partial<T>` æˆ–æ„é€ è¾…åŠ©å·¥å‚å‡½æ•°ã€‚
    - **å‡½æ•°è¿”å›å€¼ç±»å‹**ï¼šä½¿ç”¨ `vi.fn<() => ReturnType>()` çš„æ³›å‹å½¢å¼ã€‚
    - **æ•°æ®åº“ Mock**ï¼šæ„å»ºç¬¦åˆ Drizzle ç±»å‹çš„å®Œæ•´ mock å¯¹è±¡ï¼Œå¯ä»¥åˆ›å»ºå·¥å‚å‡½æ•°å¦‚ï¼š
      ```typescript
      function createMockLead(overrides?: Partial<typeof leads.$inferSelect>) {
        return {
          id: 'test-lead-id',
          tenantId: 'test-tenant',
          status: 'PENDING_ASSIGNMENT' as const,
          customerName: 'æµ‹è¯•å®¢æˆ·',
          // ... æ‰€æœ‰å¿…éœ€å­—æ®µçš„é»˜è®¤å€¼
          ...overrides,
        };
      }
      ```
  - **ç›®æ ‡**ï¼šå°† `as any` çš„æ•°é‡é™è‡³ **0**ï¼ˆé›¶å®¹å¿ï¼‰ã€‚

### 3. [Issue 2.2-2.5] æµ‹è¯•é€»è¾‘å¥å£®æ€§æå‡
- **å—å½±å“æ–‡ä»¶**ï¼š`src/features/leads/__tests__/` ç›®å½•ä¸‹çš„ç›¸å…³æµ‹è¯•
- **æ“ä½œè¦æ±‚**ï¼š
  - æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»¥ä¸‹æ¨¡å¼å¹¶ä¿®å¤ï¼š
    - æµ‹è¯•ä¸­ç¡¬ç¼–ç çš„ magic string ç¼ºå°‘å¸¸é‡æå–
    - Mock çš„ `vi.fn()` æœªæ­£ç¡®ä½¿ç”¨ `mockResolvedValue` / `mockReturnValue`
    - äº‹åŠ¡ç›¸å…³æµ‹è¯•æœª mock `db.transaction` çš„å›è°ƒè¡Œä¸º
  - ç¡®ä¿æ‰€æœ‰æµ‹è¯•çš„ `describe` å’Œ `it` æè¿°è¯­ä½¿ç”¨ä¸­æ–‡ã€‚

---

## éªŒè¯è®¡åˆ’
å®Œæˆæ‰€æœ‰ä¿®æ”¹åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¹¶ç¡®ä¿**å…¨éƒ¨é€šè¿‡**ï¼š

```bash
# 1. ç±»å‹æ£€æŸ¥ (ä»…å…³æ³¨ leads æµ‹è¯•æ–‡ä»¶ï¼Œå…¶ä»–æ¨¡å—çš„å·²æœ‰ tsc é”™è¯¯å¯å¿½ç•¥)
npx tsc --noEmit

# 2. è¿è¡Œå…¨éƒ¨ leads æµ‹è¯• â€” ç›®æ ‡: 0 å¤±è´¥
pnpm test:run src/features/leads
```

**ä½ çš„æˆåŠŸæ ‡å‡†**ï¼š
- `restore.test.ts` ä¸­ä¹‹å‰å¤±è´¥çš„ç”¨ä¾‹ç°åœ¨é€šè¿‡
- æ‰€æœ‰ leads æµ‹è¯•æ–‡ä»¶ä¸­çš„ `as any` æ•°é‡é™è‡³ 0
- `pnpm test:run src/features/leads` æ˜¾ç¤º **0 failed**

---

## ä½ çš„å·¥ä½œè§„èŒƒ
1. **èº«ä»½å£°æ˜**ï¼šä½ æ˜¯ **Subagent 4 (æµ‹è¯•å€ºåŠ¡æ¸…å¿)**ã€‚æ¯æ¬¡å›å¤ç”¨æˆ·æ—¶ï¼Œå¿…é¡»åœ¨å¼€å¤´ç¬¬ä¸€è¡Œæ³¨æ˜ï¼š`ğŸ§ª [Subagent 4 â€” æµ‹è¯•]`ï¼Œä»¥ä¾¿ç”¨æˆ·åŒºåˆ†ä¸åŒ Agent çš„è¾“å‡ºã€‚
2. ä½ çš„å·¥ä½œèŒƒå›´é™å®šåœ¨ `src/features/leads/__tests__/` ç›®å½•ã€‚å¦‚æœéœ€è¦ç†è§£è¢«æµ‹å‡½æ•°çš„é€»è¾‘ï¼Œå¯ä»¥é˜…è¯» `src/features/leads/actions/` ä¸‹çš„æºæ–‡ä»¶ï¼Œä½†**ä¸è¦ä¿®æ”¹å®ƒä»¬**ã€‚
3. å¦‚æœå‘ç°æŸä¸ªæµ‹è¯•å¤±è´¥æ˜¯å› ä¸ºè¢«æµ‹å‡½æ•°æœ¬èº«æœ‰ bugï¼ˆè€Œé mock é—®é¢˜ï¼‰ï¼Œè¯·åœ¨åé¦ˆä¸­æ ‡æ³¨å‡ºæ¥ï¼Œä¸è¦è‡ªè¡Œä¿®å¤æºæ–‡ä»¶ã€‚
4. ä½ å¿…é¡»å®Œå…¨é‡‡ç”¨ä¸­æ–‡è¾“å‡ºæ€è€ƒå’Œåé¦ˆè¿›å±•ã€‚
5. è¯·é€šè¿‡æ‰§è¡Œæœ¬ä»»åŠ¡æ‰€è¦æ±‚çš„å˜æ›´ï¼Œç»“æŸåå®Œæˆè‡ªèº«è¯„å®¡ã€‚

> æ­¤ä»»åŠ¡å·²å‡†å¤‡å°±ç»ªã€‚å½“ä½ è¿è¡Œå®Œæˆä¸”è‡ªå®¡é€šè¿‡åï¼Œè¯·å°†è¿›å±•æ±‡æŠ¥ç»™ç”¨æˆ·ï¼ˆä½œä¸ºä¸Šçº§ä»£ç†å¸ä»¤å‘˜ï¼‰ã€‚
