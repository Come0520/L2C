name: Deploy to Aliyun ECS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment artifact
        run: git archive --format=tar.gz -o site.tar.gz HEAD

      # 1. Setup Swap FIRST to ensure server can handle subsequent connections
      - name: Setup Server (Swap & Cleanup)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: root
          key: ${{ secrets.ECS_SSH_KEY }}
          script_stop: true
          script: |
            # --- Setup Swap (Prevent OOM) ---
            echo "Checking swap status..."
            
            # 检查 swap 是否已激活
            if swapon --show | grep -q "/swapfile"; then
              echo "Swap already active."
              free -h
            elif [ -f /swapfile ]; then
              # swapfile 存在但未激活，尝试激活
              echo "Swapfile exists but not active, activating..."
              swapon /swapfile || {
                echo "Failed to activate existing swap, recreating..."
                swapoff /swapfile 2>/dev/null || true
                rm -f /swapfile
                fallocate -l 4G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=4096
                chmod 600 /swapfile
                mkswap /swapfile
                swapon /swapfile
              }
              echo "Swap enabled."
              free -h
            else
              # swapfile 不存在，创建它
              echo "Creating 4GB swapfile..."
              fallocate -l 4G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=4096
              chmod 600 /swapfile
              mkswap /swapfile
              swapon /swapfile
              echo "Swap enabled."
              free -h
            fi
            
            # Clean temp dir
            rm -f /tmp/site.tar.gz

      - name: Upload artifact to ECS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: root
          key: ${{ secrets.ECS_SSH_KEY }}
          source: "site.tar.gz"
          target: "/tmp"

      - name: Deploy and Restart
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ECS_HOST }}
          username: root
          key: ${{ secrets.ECS_SSH_KEY }}
          script_stop: true
          command_timeout: 45m
          script: |
            # --- Deploy Source Code ---
            echo "Deploying new source code..."
            mkdir -p /opt/L2C
            
            # Extract to a temp directory first to ensure clean overwrite
            mkdir -p /opt/L2C_tmp
            tar -xzf /tmp/site.tar.gz -C /opt/L2C_tmp
            
            # Back up .env
            if [ -f /opt/L2C/.env ]; then
              cp /opt/L2C/.env /tmp/L2C.env.bak
            fi
            
            # Extract to target
            tar -xzf /tmp/site.tar.gz -C /opt/L2C
            rm /tmp/site.tar.gz
            
            cd /opt/L2C
            
            # --- Rebuild & Restart ---
            echo "Rebuilding containers..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            
            echo "Restarting services..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # --- Cleanup ---
            echo "Cleaning up..."
            docker image prune -f
