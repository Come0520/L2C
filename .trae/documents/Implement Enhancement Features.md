## 实施计划

### 1. 增加更多的导出格式选项

**目标**：支持Excel和PDF导出格式

**实施步骤**：

#### 后端API修改
1. **更新API路由**：
   - 修改 `src/app/api/batch/export/route.ts`
   - 添加 `format` 参数支持（csv, excel, pdf）
   - 根据不同格式返回相应的文件类型

2. **添加Excel导出支持**：
   - 使用现有的 `xlsx` 库生成Excel文件
   - 添加Excel生成逻辑

3. **添加PDF导出支持**：
   - 使用现有的 `jspdf` 和 `jspdf-autotable` 库生成PDF
   - 添加PDF生成逻辑

#### 前端修改
1. **更新导出服务**：
   - 修改 `batchService.exportData` 方法，添加 `format` 参数
   - 支持传递导出格式

2. **更新导出UI**：
   - 修改 `LeadTable` 组件，添加导出格式选择下拉菜单
   - 支持选择CSV、Excel、PDF格式

3. **更新导出处理**：
   - 修改前端导出逻辑，根据不同格式处理文件下载
   - 支持Excel和PDF文件的正确下载

### 2. 优化大数据量下的筛选性能

**目标**：提高大数据量下的筛选速度

**实施步骤**：

#### 后端优化
1. **确保筛选在后端执行**：
   - 验证 `useLeads` 钩子是否正确传递所有筛选参数到后端
   - 确保后端API支持所有筛选条件

2. **添加索引**：
   - 在数据库中为常用筛选字段添加索引
   - 如：status, businessTags, customerLevel, source, owner

3. **优化查询**：
   - 确保查询只选择必要的字段
   - 优化JOIN和过滤条件

#### 前端优化
1. **延迟加载**：
   - 为筛选组件添加防抖处理，避免频繁请求
   - 优化筛选参数的传递方式

2. **虚拟滚动**：
   - 考虑为长列表添加虚拟滚动
   - 提高列表渲染性能

3. **缓存机制**：
   - 优化React Query缓存策略
   - 减少不必要的重新请求

### 3. 增加线索状态变更的历史记录

**目标**：记录并展示线索状态变更的历史

**实施步骤**：

#### 数据模型设计
1. **创建状态变更历史表**：
   - 设计 `lead_status_history` 表结构
   - 包含字段：id, lead_id, old_status, new_status, changed_by, changed_at, comment

#### 后端实现
1. **添加历史记录API**：
   - 创建API路由用于获取和创建状态变更历史
   - 支持批量查询历史记录

2. **修改状态更新逻辑**：
   - 更新 `updateLeadStatus` 方法，在更新状态时记录历史
   - 确保历史记录包含完整的变更信息

#### 前端实现
1. **添加历史记录服务**：
   - 在 `leadService` 中添加获取和创建历史记录的方法

2. **更新状态更新调用**：
   - 修改所有调用 `updateLeadStatus` 的地方，支持添加备注
   - 确保历史记录包含足够的上下文信息

3. **添加历史记录UI**：
   - 在线索详情抽屉中添加状态变更历史标签页
   - 展示历史记录列表，包含时间、操作人、状态变更和备注
   - 支持按时间排序和筛选

### 4. 执行计划

1. **第1-2天**：实现导出格式扩展
   - 后端API修改
   - 前端UI和逻辑更新

2. **第3-4天**：优化大数据量筛选性能
   - 后端索引和查询优化
   - 前端防抖和缓存优化

3. **第5-7天**：添加状态变更历史记录
   - 数据模型设计和迁移
   - 后端API实现
   - 前端UI和逻辑更新

4. **第8天**：测试和修复
   - 功能测试
   - 性能测试
   - 边界情况测试

### 5. 预期成果

- ✅ 支持Excel和PDF导出格式
- ✅ 大数据量下筛选性能提升
- ✅ 完整的线索状态变更历史记录
- ✅ 良好的用户体验和性能

### 6. 技术栈

- **Excel导出**：xlsx库
- **PDF导出**：jspdf和jspdf-autotable库
- **状态管理**：React Query
- **UI组件**：现有的UI组件库

这个计划涵盖了所有三个需求的详细实施步骤，确保每个功能都能正确实现并提供良好的用户体验。