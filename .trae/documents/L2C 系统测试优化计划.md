# L2C 系统测试优化计划

## 一、测试目标

1. **提高测试通过率**：将核心功能测试通过率提升至 90% 以上
2. **增强测试隔离性**：确保测试能够独立运行，减少相互依赖
3. **改进测试模拟**：提供更准确的模拟数据，减少与实际代码的不匹配
4. **统一测试环境**：确保测试环境配置一致，避免环境变量问题
5. **优化测试维护**：使测试更容易维护和扩展

## 二、测试范围

### 核心功能优先
1. **线索管理**：创建、编辑、分配、跟进、状态变更
2. **报价管理**：创建、修订、审批、转换为订单
3. **订单管理**：创建、状态变更、发货、完成
4. **测量服务**：任务创建、指派、完成
5. **安装服务**：任务创建、指派、完成

### 辅助功能
6. **客户管理**：创建、编辑、关联线索
7. **财务管理**：应收账款、应付账款
8. **供应链管理**：采购订单、库存管理

## 三、测试策略

### 1. 分层测试策略

| 测试层级 | 测试重点 | 测试工具 | 执行方式 |
|----------|----------|----------|----------|
| 单元测试 | 单个函数、组件 | Vitest + React Testing Library | 开发过程中执行 |
| 集成测试 | 模块间交互 | Vitest + React Testing Library | 开发完成后执行 |
| 端到端测试 | 完整业务流程 | Playwright | 部署前执行 |

### 2. 测试环境优化

#### 环境配置
- 为测试环境添加统一的 `.env.test` 文件
- 确保所有必要的环境变量都在测试环境中设置
- 优先使用模拟数据，减少对实际数据库的依赖

#### 数据库模拟
- 为数据库连接添加全局模拟，避免测试依赖实际数据库
- 使用 `vi.mock` 模拟数据库操作，确保测试隔离性
- 为不同测试场景提供准确的模拟数据

### 3. 测试用例设计原则

1. **独立性**：每个测试用例应能独立运行，不依赖其他测试
2. **原子性**：每个测试用例只测试一个功能点
3. **可读性**：测试代码应清晰易读，便于维护
4. **全面性**：覆盖正常流程和异常情况
5. **可重复性**：测试结果应可重复，不受环境影响

### 4. 测试执行策略

#### 本地执行
```bash
# 运行特定模块测试
pnpm test src/features/leads/

# 运行单元测试
pnpm test --mode unit

# 运行集成测试
pnpm test --mode integration
```

#### CI/CD 集成
- 在 PR 提交时运行单元测试和集成测试
- 在主分支合并时运行完整测试套件
- 部署前运行端到端测试

## 四、测试用例设计

### 1. 线索管理测试

#### 单元测试
- `lead-form.test.tsx` - 测试线索表单验证
- `lead-actions.test.ts` - 测试线索相关 Server Actions

#### 集成测试
- `leads-page-client.test.tsx` - 测试线索列表页面功能
- `lead-detail.test.tsx` - 测试线索详情页面功能

#### 端到端测试
- `lead-status-workflow.spec.ts` - 测试线索完整生命周期

### 2. 报价管理测试

#### 单元测试
- `quote-form.test.tsx` - 测试报价表单验证
- `quote-calc.test.ts` - 测试报价计算逻辑

#### 集成测试
- `quotes-page.test.tsx` - 测试报价列表页面功能
- `quote-detail.test.tsx` - 测试报价详情页面功能

#### 端到端测试
- `quote-lifecycle.spec.ts` - 测试报价完整生命周期

### 3. 测量服务测试

#### 单元测试
- `measure-actions.test.ts` - 测试测量任务相关 Server Actions

#### 集成测试
- `measure-task-detail.test.tsx` - 测试测量任务详情页面功能

#### 端到端测试
- `measurement-workflow.spec.ts` - 测试测量服务完整流程

## 五、测试维护与持续改进

### 1. 测试维护计划
- 当代码发生变化时，及时更新相关测试
- 每两周运行一次完整测试套件
- 每月审查测试覆盖率报告，添加缺失的测试

### 2. 测试优化措施
- 定期清理过期的测试用例
- 优化测试执行速度，减少不必要的等待
- 使用快照测试验证 UI 组件的渲染结果
- 为复杂业务逻辑添加性能测试

### 3. 测试报告与分析
- 生成详细的测试报告，包括通过率、覆盖率、执行时间
- 分析测试失败原因，优先修复高频失败的测试
- 跟踪测试覆盖率趋势，确保覆盖率稳步提升

## 六、执行计划

### 第一阶段：基础环境优化（1周）
1. 设置统一的测试环境变量
2. 改进数据库模拟
3. 修复核心功能的单元测试

### 第二阶段：核心功能测试（2周）
1. 完善线索管理测试
2. 完善报价管理测试
3. 完善订单管理测试

### 第三阶段：辅助功能测试（2周）
1. 完善测量服务测试
2. 完善安装服务测试
3. 完善客户管理测试

### 第四阶段：端到端测试（1周）
1. 编写核心业务流程的端到端测试
2. 集成到 CI/CD 流程

## 七、预期效果

1. **测试通过率提升**：核心功能测试通过率达到 90% 以上
2. **测试执行时间缩短**：优化后测试执行时间减少 30%
3. **测试覆盖率提升**：总体测试覆盖率达到 70% 以上
4. **维护成本降低**：测试更容易维护和扩展
5. **开发效率提升**：通过测试提前发现问题，减少调试时间

## 八、工具与资源

### 测试工具
- **Vitest**：单元测试和集成测试
- **React Testing Library**：React 组件测试
- **Playwright**：端到端测试
- **@vitest/coverage-v8**：测试覆盖率报告

### 资源需求
- 测试环境配置：1人/周
- 测试用例编写：3人/周
- 测试维护：1人/周

## 九、风险与应对

### 1. 风险：测试模拟不准确
**应对措施**：定期审查模拟数据，确保与实际代码期望一致

### 2. 风险：测试环境配置不一致
**应对措施**：使用 Docker 容器化测试环境，确保配置一致

### 3. 风险：测试执行时间过长
**应对措施**：优化测试执行顺序，并行运行测试，减少不必要的依赖

### 4. 风险：测试维护成本高
**应对措施**：使用测试生成工具，减少手动编写测试的工作量；建立测试模板，统一测试风格

## 十、结论

通过实施这个优化计划，我们将显著提高 L2C 系统测试的质量和效率，确保系统的稳定性和可靠性。测试将成为开发过程中的有力工具，帮助我们提前发现问题，减少生产环境的故障，提高用户满意度。