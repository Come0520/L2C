# L2C项目50%工作量实施计划

## 一、当前项目状态分析

### 已完成工作
- ✅ 核心需求文档整理完成
- ✅ 业务流程图优化完成
- ✅ 数据库缺口分析完成
- ✅ 前端框架搭建（Next.js 15 + React 19 + Tailwind CSS v4）
- ✅ 后端框架搭建（NestJS + TypeORM + PostgreSQL）
- ✅ 订单创建页面基础功能
- ✅ 待测量页面基础功能
- ✅ 开始扩展 leads 表，添加了多个字段和关联表

### 核心问题
- ❌ 线索管理：lead_leads表字段严重不足，无标签系统、无跟踪记录
- ❌ 25状态流转：当前仅5个状态，与需求中的25个状态完全不匹配
- ❌ 积分激励系统：完全缺失
- ❌ 罗莱好伙伴：仅有partner_level字段，无详细管理
- ⚠️ 财务管理：无发票表、无回款表
- ⚠️ 测量/安装：表存在但字段不足

## 二、25个状态的具体内容

### 线索阶段状态（5个）
1. **待分配**：线索创建后等待分配给销售人员
2. **待跟踪**：已分配但尚未开始跟踪
3. **跟踪中**：正在跟踪客户
4. **草签**：客户初步同意，准备进入测量阶段
5. **已失效**：手动关闭的线索

### 订单阶段状态（15个）
6. **预算中**：预算报价阶段
7. **等待推单**：等待推单处理
8. **待测量**：等待安排测量师上门测量
9. **测量中-待分配**：测量需求单已生成，等待派单员分配
10. **测量中-分配中**：派单员正在分配测量师
11. **测量中-待上门**：测量师已接单，等待上门测量
12. **测量中-待确认**：测量完成，等待销售确认测量单
13. **方案待确认**：测量单已确认，等待客户确认方案
14. **待推单**：方案已确认，等待推单处理
15. **待下单**：订单客服确认采购需求后，订单进入待下单状态
16. **生产中**：订单已下单，正在生产
17. **备货完成**：所有生产单号备货完成
18. **安装中-待分配**：安排安装，等待派单员分配安装师
19. **安装中-分配中**：派单员正在分配安装师
20. **安装中-待上门**：安装师已接单，等待上门安装
21. **安装中-待确认**：安装完成，等待销售确认
22. **待对账**：安装确认完成，等待财务对账

### 财务阶段状态（2个）
23. **待回款**：财务已开具销售发票并填写发票单号，等待客户回款
24. **已完成**：回款确认完成，订单结束

### 异常状态（3个）
25. **已取消**：订单被取消
26. **暂停**：订单暂停处理
27. **异常**：订单出现异常情况

## 三、下一步工作规划

### 总体目标
**用50%的工作量，搭建可运行的MVP系统，覆盖核心业务闭环**

### 核心原则
1. **数据库优先**：先完善数据模型，确保业务逻辑有数据支撑
2. **MVP优先**：聚焦线索→报价→销售单的最小闭环
3. **积分系统优先**：第一阶段明确的重点功能
4. **渐进式开发**：先实现核心状态，后续迭代补全25状态

### 详细工作安排

#### Phase 1: 数据库架构完善（P0）

1. **完成线索管理表扩展**
   - [x] 扩展 lead_leads 表（15个字段）
   - [x] 创建 lead_tags 表（标签定义）
   - [x] 创建 lead_tag_assignments 表（标签关联）
   - [x] 创建 lead_followups 表（跟踪记录）
   - [x] 创建 lead_assignments 表（分配历史）
   - [ ] 更新线索状态枚举（5个状态）

2. **创建销售单25状态体系**
   - [ ] 重新设计 sales_orders.status 字段（VARCHAR(50)）
   - [ ] 创建 order_statuses 表（25个状态定义）
   - [ ] 创建 sales_order_status_history 表（状态流转历史）
   - [ ] 扩展 sales_orders 表（12个字段）

3. **创建积分系统表**
   - [ ] 创建 points_accounts 表（积分账户）
   - [ ] 创建 points_transactions 表（积分交易）
   - [ ] 创建 points_rules 表（积分规则配置）
   - [ ] 创建 points_products 表（积分商品）
   - [ ] 创建 points_orders 表（兑换订单）
   - [ ] 创建 points_order_items 表（兑换明细）
   - [ ] 创建 points_product_categories 表（商品分类）

4. **创建好伙伴管理表**
   - [ ] 创建 partner_profiles 表（好伙伴档案）
   - [ ] 创建 sales_order_partners 表（订单关联）

#### Phase 2: 后端API开发（P0）

1. **线索管理API**
   - [ ] POST /api/leads - 创建线索
   - [ ] GET /api/leads - 线索列表（支持筛选、分页）
   - [ ] GET /api/leads/:id - 线索详情
   - [ ] PUT /api/leads/:id - 更新线索
   - [ ] POST /api/leads/:id/assign - 分配线索
   - [ ] POST /api/leads/:id/followup - 添加跟踪记录
   - [ ] GET /api/leads/:id/followups - 跟踪历史
   - [ ] POST /api/leads/:id/tags - 添加标签
   - [ ] DELETE /api/leads/:id/tags/:tagId - 移除标签
   - [ ] POST /api/leads/import - Excel批量导入
   - [ ] POST /api/leads/check-duplicate - 重复检查

2. **报价单API**
   - [ ] POST /api/quotes - 创建报价单
   - [ ] GET /api/quotes/:id - 报价单详情
   - [ ] POST /api/quotes/:id/versions - 创建新版本
   - [ ] PUT /api/quotes/:id/versions/:versionId - 更新版本
   - [ ] POST /api/quotes/:id/versions/:versionId/set-current - 设为当前版本
   - [ ] POST /api/quotes/:id/generate-order - 生成销售单

3. **销售单API**
   - [ ] POST /api/sales-orders - 创建销售单
   - [ ] GET /api/sales-orders - 销售单列表
   - [ ] GET /api/sales-orders/:id - 销售单详情
   - [ ] PUT /api/sales-orders/:id/status - 更新状态
   - [ ] GET /api/sales-orders/:id/status-history - 状态历史
   - [ ] POST /api/sales-orders/:id/partners - 关联好伙伴

4. **积分系统API**
   - [ ] GET /api/points/account - 我的积分账户
   - [ ] GET /api/points/transactions - 积分交易记录
   - [ ] GET /api/points/products - 积分商品列表
   - [ ] GET /api/points/products/:id - 商品详情
   - [ ] POST /api/points/orders - 创建兑换订单
   - [ ] GET /api/points/orders - 我的兑换订单
   - [ ] POST /api/points/calculate - 积分计算（内部API）

#### Phase 3: 前端页面开发（P0）

1. **线索管理页面**
   - [ ] 线索列表页（/leads）
   - [ ] 线索详情页（/leads/:id）
   - [ ] 线索创建/编辑页
   - [ ] Excel导入对话框

2. **报价单页面**
   - [ ] 报价单列表页（/quotes）
   - [ ] 报价单详情页（/quotes/:id）

3. **销售单页面**
   - [ ] 销售单列表页（/sales-orders）
   - [ ] 销售单详情页（/sales-orders/:id）

4. **积分商城页面**
   - [ ] 积分商城首页（/points-mall）
   - [ ] 商品详情页（/points-mall/products/:id）
   - [ ] 我的积分页（/points/account）
   - [ ] 兑换订单页（/points/orders）

#### Phase 4: 业务逻辑实现（P0）

1. **线索重复检查引擎**
   - [ ] 实现姓名+地址完全匹配检测（高预警）
   - [ ] 实现地址相似度算法（中预警）
   - [ ] 实现姓名+设计师/导购组合检测（低预警）

2. **积分计算引擎**
   - [ ] 实现积分计算公式
   - [ ] 实现在途积分机制
   - [ ] 实现好伙伴积分计算
   - [ ] 实现积分触发点事件监听

3. **状态流转引擎**
   - [ ] 实现状态机逻辑（10个核心状态）
   - [ ] 实现状态变更权限控制
   - [ ] 实现状态历史记录
   - [ ] 实现状态变更通知（简化版）

## 四、优先级排序

### 第一优先级（立即开始）
1. 完成线索管理表扩展和相关表创建
2. 创建销售单状态流转相关表
3. 创建积分系统表
4. 创建好伙伴管理表

### 第二优先级
1. 实现线索管理API
2. 实现销售单API
3. 实现积分系统API

### 第三优先级
1. 实现前端核心页面
2. 实现业务逻辑引擎

## 五、验收标准

### 功能验收
1. **线索管理**
   - ✅ 可创建线索并自动分配
   - ✅ 可添加跟踪记录并查看历史
   - ✅ 可打标签并按标签筛选
   - ✅ Excel导入成功，重复检测有效

2. **报价单流转**
   - ✅ 可创建报价单并管理多版本
   - ✅ 可从报价单生成销售单
   - ✅ 版本切换正确同步状态

3. **销售单流转**
   - ✅ 10个核心状态可正常流转
   - ✅ 状态历史可追溯
   - ✅ 状态变更权限控制生效

4. **积分系统**
   - ✅ 线索/订单操作自动发放积分
   - ✅ 积分账户余额计算正确
   - ✅ 可在商城兑换商品
   - ✅ 在途积分机制生效

### 技术验收
1. **代码质量**
   - ✅ 代码通过所有lint检查
   - ✅ 单元测试全部通过
   - ✅ 无未使用的导入和变量
   - ✅ 提交信息符合规范

2. **数据库**
   - ✅ 迁移成功执行
   - ✅ 所有迁移已应用

3. **启动运行**
   - ✅ 后端启动成功（监听3001端口）
   - ✅ 前端启动成功（监听3000端口）
   - ✅ 访问 http://localhost:3000 系统正常

## 六、风险与缓解

### 高风险
1. **数据库迁移失败**
   - 缓解：迁移前备份数据库；先在开发环境测试；编写回滚脚本

2. **积分计算逻辑错误**
   - 缓解：编写详细单元测试；手工验证典型案例；实现积分调整功能

3. **状态流转逻辑混乱**
   - 缓解：先实现10个核心状态；状态机图文档化；Phase 2补全剩余状态

### 中风险
4. **性能问题**
   - 缓解：提前添加数据库索引；实现分页；考虑缓存策略

5. **前后端联调问题**
   - 缓解：使用TypeScript共享类型；Swagger文档先行；Mock数据测试

6. **工期延误**
   - 缓解：严格MVP范围；每日站会跟进；及时调整优先级

## 七、下一步具体工作

1. **完成线索管理表扩展**
   - 更新线索状态枚举
   - 完善lead_leads表的剩余字段

2. **创建销售单25状态体系**
   - 重新设计sales_orders.status字段
   - 创建order_statuses表
   - 创建sales_order_status_history表
   - 扩展sales_orders表

3. **创建积分系统表**
   - 创建points_accounts表
   - 创建points_transactions表
   - 创建points_rules表
   - 创建points_products表
   - 创建points_orders表
   - 创建points_order_items表
   - 创建points_product_categories表

4. **创建好伙伴管理表**
   - 创建partner_profiles表
   - 创建sales_order_partners表

5. **编写对应的TypeORM实体**

6. **实现基础的API功能**

## 八、预期交付时间

按照2周（10个工作日）的计划周期，预计在12月13日前完成所有50%工作量的开发任务。