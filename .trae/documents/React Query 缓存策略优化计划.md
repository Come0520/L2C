# React Query 缓存策略优化计划

## 1. 优化目标
- 统一高频列表的缓存策略，提高用户体验一致性
- 合理设置 `staleTime` 和 `gcTime`，减少不必要的网络请求
- 优化查询键设计，充分利用缓存复用机制
- 调整实时更新与缓存策略的配合，提高性能

## 2. 当前问题分析
- 不同 hooks 的缓存策略不一致（30秒-1分钟）
- 销售订单列表的缓存时间过短，可能导致频繁请求
- 没有充分利用 React Query 的缓存复用机制
- 实时更新机制与缓存策略的配合需要优化

## 3. 优化方案

### 3.1 统一高频列表缓存策略
- **日志列表**：保持 `staleTime: 1分钟`，`gcTime: 5分钟`
- **销售订单列表**：调整为 `staleTime: 1分钟`，`gcTime: 5分钟`
- **安装列表**：保持 `staleTime: 1分钟`，`gcTime: 5分钟`
- **单个订单/安装详情**：保持 `staleTime: 1分钟`，`gcTime: 10分钟`

### 3.2 优化查询键设计
- 统一查询键格式，便于缓存复用
- 提取公共查询参数，减少重复代码
- 为相关查询添加标签（tags），便于批量失效

### 3.3 调整实时更新机制
- 优化实时更新的触发条件，避免不必要的缓存失效
- 调整节流函数的时间间隔，平衡实时性和性能
- 考虑使用 `invalidateQueries` 而非 `refetch` 来更新缓存

### 3.4 优化 React Query 全局配置
- 调整默认 `staleTime` 和 `gcTime`，减少全局配置与局部配置的差异
- 考虑启用 `refetchOnWindowFocus: 'always'` 或 `'visible'`，提高数据新鲜度
- 优化 `placeholderData` 的使用，提高用户体验

## 4. 具体实施步骤

### 4.1 优化 React Query 全局配置
- 修改 `/src/components/providers/query-provider.tsx`，调整默认缓存策略

### 4.2 优化日志相关 hooks
- 修改 `/src/hooks/useLogs.ts`，统一缓存策略和查询键格式

### 4.3 优化订单相关 hooks
- 修改 `/src/hooks/useSalesOrders.ts`，调整缓存时间和查询键设计
- 统一 `useSalesOrders` 和 `useSalesOrder` 的缓存策略

### 4.4 优化安装列表相关 hooks
- 修改 `/src/hooks/useInstallations.ts`，统一缓存策略和查询键格式

### 4.5 优化实时更新机制
- 调整 `/src/hooks/useRealtimeSubscription.ts` 中的节流时间
- 优化各 hooks 中实时更新触发缓存更新的逻辑

## 5. 预期效果
- 减少 30% 以上的网络请求
- 提高不同视图间的数据一致性
- 改善用户体验，减少加载状态的出现
- 降低服务器压力

## 6. 测试计划
- 验证各列表页的缓存策略是否统一
- 测试不同视图间的数据是否可以复用
- 检查实时更新是否正常工作
- 监控网络请求数量和响应时间

## 7. 代码规范
- 严格遵循项目的命名规范
- 保持代码的模块化和可维护性
- 添加必要的注释说明缓存策略的设计思路
- 确保类型安全

## 8. 风险评估
- 缓存时间过长可能导致数据不新鲜，需要平衡实时性和性能
- 统一缓存策略可能影响某些特定场景的用户体验，需要密切关注
- 实时更新机制的调整需要充分测试，避免出现数据不一致问题