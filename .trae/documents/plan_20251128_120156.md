# 报价单多版本调整计划

## 1. 状态调整

### 1.1 添加"再稿"状态
- 更新报价单版本的状态类型，添加"revised"（再稿）状态
- 调整状态流转图，支持草稿 → 初稿 → 再稿 → 已确认的流转
- 更新状态说明，明确再稿状态的含义和使用场景

### 1.2 状态流转规则
- 草稿状态可转为初稿或取消
- 初稿状态可转为再稿、已确认、取消或过期
- 再稿状态可转为已确认、取消或过期
- 已确认状态为最终状态，不可再修改
- 支持从任意状态创建新版本

## 2. 业务逻辑调整

### 2.1 自动取消逻辑
- 实现当一个报价单版本被确认后，自动取消同一客户的其他报价单版本
- 确保同一客户只有一个已确认的报价单版本

### 2.2 再稿生成逻辑
- 支持根据测量师测量数据调整报价单，生成再稿
- 实现再稿的选中和更换功能

### 2.3 已确认状态增强
- 支持上传HOME系统推单截图
- 支持填写PO号

## 3. 实体类调整

### 3.1 更新QuoteVersion实体
- 添加"revised"状态到状态类型
- 添加PO号字段
- 添加HOME系统推单截图URL字段

### 3.2 更新相关实体关系
- 确保实体间的关联关系正确
- 更新数据库表结构

## 4. 服务层调整

### 4.1 更新状态流转方法
- 添加再稿状态的相关方法
- 实现自动取消同一客户其他版本的逻辑

### 4.2 添加新的业务方法
- 实现再稿生成方法
- 实现已确认状态的增强功能

## 5. API调整

### 5.1 更新API接口
- 添加再稿相关的API接口
- 更新已确认状态的API接口，支持上传截图和填写PO号

### 5.2 调整API参数
- 更新状态流转API的参数
- 添加新的请求和响应类型

## 6. 前端调整建议

### 6.1 界面调整
- 更新报价单详情页面，支持再稿状态
- 添加再稿生成和管理功能
- 实现已确认状态的截图上传和PO号填写

### 6.2 状态显示调整
- 更新状态标签和颜色
- 显示再稿状态的特殊标识

## 7. 测试验证

### 7.1 单元测试
- 测试新增的状态流转逻辑
- 测试自动取消功能
- 测试再稿生成功能

### 7.2 集成测试
- 测试API接口的正确性
- 测试前后端集成

### 7.3 功能测试
- 测试完整的报价单流程
- 测试各种状态转换场景

## 8. 实施步骤

1. 更新实体类和数据库结构
2. 更新服务层业务逻辑
3. 更新API接口
4. 更新前端界面（如果需要）
5. 进行测试验证
6. 部署上线

## 9. 技术栈

- 后端：NestJS + TypeORM + PostgreSQL
- 前端：Next.js 14+ + React + TypeScript
- 数据库：PostgreSQL

## 10. 关键注意事项

- 确保数据一致性，同一客户只有一个已确认的报价单版本
- 确保状态流转的正确性和完整性
- 确保API接口的向后兼容性
- 确保前端界面的用户体验良好

这个调整计划将确保报价单多版本功能符合最新的业务需求，支持再稿状态和相关的业务逻辑。