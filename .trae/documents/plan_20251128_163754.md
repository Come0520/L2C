# 业务流程一致性修复计划

## 1. 问题识别

通过对比业务流程图与各模块设计文档，发现以下不一致之处：

### 1.1 报价管理模块
- **状态流转不一致**：缺少`measuring`和`revised`状态，多了`expired`和`converted`状态
- **版本号格式不一致**：流程图使用V1.0、V1.1格式，模块使用数字版本号

### 1.2 订单管理模块
- **状态流转不一致**：缺少`purchasing`、`shipping`、`confirming`、`reconciliation`状态
- **多了`pending_production`、`in_production`、`pending_delivery`、`delivered`、`evaluated`状态**
- **缺少明确的状态同步机制**：安装单状态未同步到销售单

### 1.3 测量管理模块
- **测量单生成时机错误**：流程图中由报价单生成，模块中由销售订单生成
- **状态流转不一致**：缺少`assigning`状态，多了`scheduled`、`data_submitted`状态
- **状态名称不一致**：`waiting` vs `scheduled`，`confirming` vs `data_submitted`

### 1.4 安装管理模块
- **状态流转不一致**：缺少`assigning`状态，多了`scheduled`、`pending_acceptance`、`archived`状态
- **状态名称不一致**：`waiting` vs `scheduled`，`confirming` vs `pending_acceptance`

## 2. 修复方案

### 2.1 报价管理模块修复
- 修改状态流转，添加`measuring`和`revised`状态
- 删除`expired`状态，将`converted`状态改为`confirmed`
- 实现V1.0、V1.1格式的版本号管理
- 确保测量单状态同步到报价单版本和报价单主记录

### 2.2 订单管理模块修复
- 修改状态流转，使用流程图中定义的状态
- 删除多余状态，添加缺失状态
- 实现安装单状态到销售单的自动同步机制
- 实现对账单状态到销售单的自动同步机制

### 2.3 测量管理模块修复
- 调整测量单生成时机，由报价单初稿状态生成
- 修改状态流转，使用流程图中定义的状态
- 确保测量单状态同步到报价单版本和报价单主记录

### 2.4 安装管理模块修复
- 修改状态流转，使用流程图中定义的状态
- 确保安装单状态同步到销售单

### 2.5 对账单状态统一
- 确保所有模块使用流程图中定义的对账单状态

## 3. 实施步骤

1. **更新数据库设计**：修改各模块的状态字段定义
2. **更新业务逻辑**：修改状态流转逻辑，实现状态同步机制
3. **更新API设计**：修改API接口中的状态定义
4. **更新前端界面**：修改前端组件中的状态展示和处理
5. **更新文档**：确保所有文档与流程图保持一致

## 4. 关键注意事项

- **状态机实现**：使用状态机模式确保状态变更的合法性和一致性
- **事件驱动**：使用事件驱动架构实现状态同步
- **幂等性保证**：确保状态变更操作的幂等性
- **日志记录**：记录所有状态变更日志
- **权限控制**：根据角色设置状态变更权限

## 5. 验证标准

- 所有模块的状态流转与业务流程图一致
- 测量单状态正确同步到报价单
- 安装单状态正确同步到销售单
- 对账单状态正确同步到销售单
- 报价单版本号格式为V1.0、V1.1
- 所有文档与流程图保持一致