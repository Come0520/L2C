# 全面测试覆盖计划

## 1. 核心组件测试

### 1.1 LeadFilters 组件测试

**测试用例设计**：
- ✅ 组件渲染测试
  - 验证所有筛选条件字段正确渲染
  - 验证初始值正确显示
- ✅ 交互逻辑测试
  - 搜索框输入和防抖功能
  - 状态下拉选择
  - 标签筛选选择
  - 客户等级筛选
  - 来源渠道输入
  - 归属输入
  - 设计师输入
  - 导购输入
  - 日期范围选择
- ✅ 防抖功能测试
  - 验证防抖延迟效果（300ms 搜索，200ms 其他筛选）
  - 验证频繁输入时只触发一次回调
  - 验证防抖函数清除机制
- ✅ 事件处理测试
  - 验证所有 onChange 事件正确触发
  - 验证回调函数参数正确传递

**测试文件**：`src/features/leads/components/list/__tests__/lead-filters.test.tsx`

### 1.2 LeadActionButtons 组件测试

**测试用例设计**：
- ✅ 基于不同状态渲染不同按钮
- ✅ 权限控制测试（不同角色显示不同按钮）
- ✅ 按钮点击事件测试
- ✅ 状态流转逻辑测试

### 1.3 其他核心组件测试

**测试范围**：
- 订单状态流转组件
- 测量任务管理组件
- 安装日历组件
- 权限控制组件（RoleGuard）

## 2. 服务层测试

### 2.1 线索管理服务测试

**测试用例设计**：
- ✅ 线索创建、查询、更新、删除
- ✅ 线索分配和状态变更
- ✅ 线索筛选和搜索
- ✅ 线索标签管理

### 2.2 订单管理服务测试

**测试用例设计**：
- ✅ 订单创建和更新
- ✅ 订单状态流转
- ✅ 订单催办和通知
- ✅ 订单对账和差异处理

### 2.3 测量管理服务测试

**测试用例设计**：
- ✅ 测量任务创建和分配
- ✅ 测量状态变更
- ✅ 测量数据提交和确认
- ✅ 测量模板管理

## 3. 钩子函数测试

### 3.1 useLeads 钩子测试

**测试用例设计**：
- ✅ 实时数据获取和订阅
- ✅ 线索筛选和分页
- ✅ 线索状态变更
- ✅ 错误处理机制

### 3.2 useMeasurements 钩子测试

**测试用例设计**：
- ✅ 测量任务列表获取
- ✅ 测量状态更新
- ✅ 实时订阅功能
- ✅ 测量模板集成

### 3.3 useOrders 钩子测试

**测试用例设计**：
- ✅ 订单列表获取和筛选
- ✅ 订单状态变更
- ✅ 订单操作（催办、审核等）
- ✅ 实时更新机制

## 4. 工具函数测试

### 4.1 debounce 函数测试

**测试用例设计**：
- ✅ 防抖延迟效果验证
- ✅ 频繁调用时的触发次数控制
- ✅ 防抖函数清除机制
- ✅ 不同延迟时间配置

### 4.2 其他工具函数测试

**测试范围**：
- 格式化函数（日期、数字、字符串）
- 导出功能（Excel、PDF）
- 文件处理函数
- 事件处理函数

## 5. 状态管理测试

### 5.1 线索状态机测试

**测试用例设计**：
- ✅ 所有状态定义正确性
- ✅ 状态流转规则验证
- ✅ 每个状态对应的允许操作
- ✅ 状态时间限制和提醒机制

### 5.2 订单状态流转测试

**测试用例设计**：
- ✅ 订单状态定义和流转
- ✅ 不同角色的状态操作权限
- ✅ 状态变更的副作用（通知、日志等）

## 6. E2E 测试

### 6.1 线索管理流程

**测试场景**：
- ✅ 线索创建和分配
- ✅ 线索状态跟踪和更新
- ✅ 线索筛选和搜索
- ✅ 线索转订单流程

### 6.2 测量管理流程

**测试场景**：
- ✅ 测量任务创建和分配
- ✅ 测量人员上门执行
- ✅ 测量数据提交和确认
- ✅ 测量报告生成

### 6.3 订单管理流程

**测试场景**：
- ✅ 订单创建和编辑
- ✅ 订单状态流转
- ✅ 订单催办和通知
- ✅ 订单对账和结算

## 7. 测试配置优化

### 7.1 覆盖率配置

**配置内容**：
- ✅ 在 `vitest.config.ts` 中设置覆盖率阈值
  - 全局覆盖率：80%
  - 分支覆盖率：70%
  - 函数覆盖率：80%
  - 行覆盖率：80%
- ✅ 配置覆盖率报告排除项（如类型定义、测试文件等）
- ✅ 生成详细的 HTML 覆盖率报告

### 7.2 CI/CD 集成

**集成内容**：
- ✅ 提交代码时运行单元测试和覆盖率检查
- ✅ 合并请求时运行完整测试套件
- ✅ 定期运行 E2E 测试
- ✅ 将覆盖率指标纳入代码审查流程

## 8. 测试执行策略

### 8.1 本地开发测试

**执行方式**：
- 开发过程中使用 `npm run test:watch` 进行实时测试
- 提交代码前运行 `npm run test:coverage` 检查覆盖率
- 使用 `npm run test -- --grep <test-name>` 运行特定测试

### 8.2 自动化测试

**执行计划**：
- ✅ 单元测试：每次代码提交时执行
- ✅ 集成测试：每日夜间执行
- ✅ E2E 测试：每周执行一次完整测试

## 9. 测试工具和框架

### 9.1 单元测试

**工具栈**：
- Vitest：测试运行器
- React Testing Library：组件测试
- MSW：API 模拟
- Mock Service Worker：模拟 Supabase 服务

### 9.2 E2E 测试

**工具栈**：
- Playwright：E2E 测试框架
- TypeScript：类型安全测试
- Allure Report：测试报告生成

## 10. 预期成果

### 10.1 测试覆盖率目标

| 模块 | 覆盖率目标 |
|------|------------|
| 核心组件 | 90%+ |
| 服务层 | 85%+ |
| 钩子函数 | 80%+ |
| 工具函数 | 95%+ |
| 整体项目 | 80%+ |

### 10.2 质量提升

- ✅ 减少生产环境 bug
- ✅ 提高代码可维护性
- ✅ 增强重构信心
- ✅ 确保业务逻辑正确性
- ✅ 提高开发效率（减少调试时间）

## 11. 实施步骤

1. **第一阶段**：编写 LeadFilters 组件测试（1 天）
2. **第二阶段**：补充其他核心组件测试（2-3 天）
3. **第三阶段**：编写服务层和钩子测试（3-4 天）
4. **第四阶段**：配置覆盖率阈值和报告（1 天）
5. **第五阶段**：编写 E2E 测试（3-5 天）
6. **第六阶段**：集成 CI/CD 和自动化测试（2 天）

## 12. 测试维护

- ✅ 每次添加新功能时同步编写测试
- ✅ 定期更新测试用例以适应业务变化
- ✅ 分析测试覆盖率报告，补充缺失测试
- ✅ 定期审查和优化测试用例
- ✅ 建立测试用例管理机制

**本计划确保项目的每个关键组件、业务流程和核心逻辑都得到充分测试，达到 80% 以上的测试覆盖率目标，为项目质量提供坚实保障。**