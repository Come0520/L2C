# 安全合规修复计划

## 1. 补充 CSP 与安全响应头

### 问题分析
- 当前 CSP 配置存在重复设置（next.config.js 和中间件中都有）
- CSP 中使用了不安全的 'unsafe-inline' 和 'unsafe-eval'
- 安全响应头需要统一管理和优化

### 修复方案
- 统一 CSP 配置，移除重复设置
- 优化 CSP 策略，减少不安全指令
- 确保所有安全响应头完整配置
- 实现基于环境的 CSP 配置

### 实施步骤
1. 修改 `next.config.js` 中的 CSP 配置，移除不安全指令
2. 统一安全响应头管理，确保一致性
3. 添加适当的 CSP 报告机制
4. 测试 CSP 配置，确保不影响正常功能

## 2. 验证 Cookie 安全属性

### 问题分析
- 当前 Cookie 设置可能缺少必要的安全属性
- 需要确保所有 Cookie 都设置了 HttpOnly、Secure 和 SameSite
- Supabase Cookie 配置需要验证

### 修复方案
- 确保所有 Cookie 都设置了适当的安全属性
- 优化 Supabase Cookie 配置
- 实现 Cookie 安全策略的统一管理

### 实施步骤
1. 检查并修改 `session-refresh.ts` 中间件中的 Cookie 配置
2. 确保所有 API 响应中的 Cookie 都设置了安全属性
3. 测试 Cookie 安全属性，确保符合安全标准

## 3. 文件与分享治理

### 问题分析
- 分享令牌可能存在无有效期的情况（expiresAt 为 null）
- 需要加强分享令牌的权限控制
- 分享功能需要更严格的安全验证

### 修复方案
- 确保所有分享令牌都有明确的有效期
- 加强分享令牌的权限验证
- 实现分享令牌的定期清理机制
- 优化分享功能的安全流程

### 实施步骤
1. 修改分享令牌生成逻辑，确保所有令牌都有有效期
2. 加强 `/api/sharing/validate` 端点的验证逻辑
3. 实现分享令牌的过期检查
4. 添加分享令牌的使用日志
5. 测试分享功能的安全性

## 预期效果

- 安全扫描无高危漏洞
- Lighthouse 安全项全部通过
- 敏感数据访问可控
- 符合安全合规要求

## 验收标准

1. CSP 配置符合安全最佳实践
2. 所有 Cookie 都设置了适当的安全属性
3. 分享令牌有明确的有效期和权限控制
4. 安全扫描工具检测通过
5. Lighthouse 安全评分达到满分