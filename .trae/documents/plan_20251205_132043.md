# 类型与 Lint 严格度导致 CI 易失败问题修复计划

## 问题分析
通过运行 `npm run typecheck` 和 `npm run lint`，发现项目存在大量 TypeScript 错误和 lint 警告，主要包括：

1. **TypeScript 错误**：688 个错误，分布在 67 个文件中
2. **Lint 问题**：4142 个问题（3516 个错误，626 个警告）
3. **文档明确提到的问题**：
   - `Blob` 构造参数问题
   - `Record<UserRole, …>` 键覆盖不完整
   - 未使用依赖与变量
   - 不符合 `prefer-const` 与 `no-var` 规则
   - Hooks 依赖问题

## 修复策略

### 1. 优先处理文档明确提到的问题

#### a. 修复 `Record<UserRole, …>` 键覆盖问题
- **文件**：`src/app/page.tsx:325-359`
- **问题**：检查 `UserRole` 枚举所有值是否都在 `roleMap` 中被覆盖
- **解决方案**：补充缺失的角色映射，确保所有 `UserRole` 值都有对应的中文名称

#### b. 修复 Hooks 依赖问题
- **文件**：`src/features/leads/components/list/lead-filters.tsx:46,55`
- **问题**：`debounce` 函数在组件内部创建，可能导致不必要的重渲染
- **解决方案**：使用 `useCallback` 包装 debounce 函数，添加适当的依赖项

#### c. 修复其他明确提到的文件
- **文件**：`src/app/orders/status/[status]/page.tsx:326`
- **文件**：`src/app/page.tsx:319,350`
- **解决方案**：检查并修复这些文件中的具体错误

### 2. 自动修复可修复的 lint 问题
- **命令**：`npm run lint -- --fix`
- **预期效果**：修复 1008 个可自动修复的错误
- **包括**：
  - `prefer-const` 规则
  - `no-var` 规则
  - 未使用的导入和变量
  - 一些格式问题

### 3. 处理高频出现的 TypeScript 错误

#### a. 数据库相关错误
- **问题**：数据库表名和字段名不匹配（如 `order_items` 不存在）
- **解决方案**：检查数据库 schema，修正表名和字段名引用

#### b. RPC 函数调用错误
- **问题**：RPC 函数参数不匹配
- **解决方案**：检查 RPC 函数定义，修正调用参数

#### c. 类型不匹配错误
- **问题**：如 `string` 不能赋值给 `number`
- **解决方案**：添加适当的类型转换或修正类型定义

### 4. 处理 `react-hooks/exhaustive-deps` 警告
- **策略**：
  1. 为 Hooks 添加缺失的依赖项
  2. 对于无法添加依赖的情况，使用 `useCallback` 或 `useMemo` 优化
  3. 必要时使用 `// eslint-disable-next-line react-hooks/exhaustive-deps` 并添加注释说明

## 实施步骤

1. **第 1 步**：运行 `npm run lint -- --fix` 自动修复可修复问题
2. **第 2 步**：修复文档明确提到的文件和问题
3. **第 3 步**：处理高频出现的 TypeScript 错误
4. **第 4 步**：处理 `react-hooks/exhaustive-deps` 警告
5. **第 5 步**：运行 `npm run typecheck` 验证 TypeScript 错误是否已修复
6. **第 6 步**：运行 `npm run lint` 验证 lint 警告是否已修复
7. **第 7 步**：运行 `npm run test:ci` 验证所有测试是否通过

## 预期结果

- ✅ `npm run typecheck` 零错误
- ✅ `npm run lint` 零警告
- ✅ `npm run test:ci` 全绿
- ✅ CI 构建稳定，不再因类型和 lint 问题失败

## 注意事项

1. **优先级**：优先处理影响 CI 构建的关键错误
2. **测试**：修复后确保相关功能正常工作
3. **代码审查**：确保修复符合项目的命名规范和代码风格
4. **逐步修复**：由于错误数量较多，采用逐步修复、逐步验证的方式