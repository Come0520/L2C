# 线索管理功能自动化测试方案

## 测试框架

### 1. 单元测试与集成测试
- **框架**：Vitest + React Testing Library
- **配置文件**：`vitest.config.ts`
- **测试目录**：`src/features/leads/__tests__/`

### 2. 端到端测试
- **框架**：Playwright
- **配置文件**：`playwright.config.ts`
- **测试目录**：`e2e/flows/`

## 测试用例设计

### 1. 线索列表页面测试 (组件测试)

**测试文件**：`src/features/leads/__tests__/leads-page-client.test.tsx`

| 测试项 | 测试步骤 | 预期结果 |
|--------|----------|----------|
| 页面渲染 | 渲染 LeadsPageClient 组件 | 页面正常加载，显示线索列表和筛选控件 |
| 状态筛选 | 点击不同状态标签 | 列表显示对应状态的线索，URL 参数更新 |
| 高级筛选 | 设置筛选条件 | 列表显示符合条件的线索 |
| 搜索功能 | 输入搜索关键词 | 列表显示匹配的线索 |
| 分页功能 | 点击页码或「下一页」按钮 | 列表显示对应页的线索 |
| 创建线索按钮 | 点击「创建线索」按钮 | 弹出创建线索对话框 |

### 2. 线索创建功能测试 (集成测试)

**测试文件**：`src/features/leads/__tests__/create-lead.test.tsx`

| 测试项 | 测试步骤 | 预期结果 |
|--------|----------|----------|
| 完整表单提交 | 填写完整线索信息并提交 | 线索创建成功，显示成功提示 |
| 必填字段验证 | 不填写必填字段提交 | 表单验证失败，显示错误提示 |
| 电话号码格式验证 | 输入无效电话号码提交 | 表单验证失败，显示错误提示 |
| 手机号唯一性验证 | 输入已存在手机号提交 | 表单验证失败，显示错误提示 |

### 3. 线索详情页面测试 (集成测试)

**测试文件**：`src/features/leads/__tests__/lead-detail.test.tsx`

| 测试项 | 测试步骤 | 预期结果 |
|--------|----------|----------|
| 基本信息显示 | 渲染 LeadDetailPage 组件 | 显示线索的详细信息 |
| 编辑功能 | 修改线索信息并保存 | 线索信息更新成功 |
| 添加跟进 | 添加跟进记录 | 跟进记录添加成功，线索状态更新为「跟进中」 |
| 标记作废 | 标记线索为无效 | 线索状态更新为「已作废」，记录作废原因 |
| 快速报价 | 点击「快速报价」按钮 | 跳转到快速报价页面 |

### 4. 线索状态变更测试 (端到端测试)

**测试文件**：`e2e/flows/lead-status-workflow.spec.ts`

| 测试项 | 测试步骤 | 预期结果 |
|--------|----------|----------|
| 线索分配 | 创建线索并分配给销售 | 线索状态从「待分配」变为「待跟进」 |
| 开始跟进 | 销售开始跟进线索 | 线索状态从「待跟进」变为「跟进中」 |
| 标记成交 | 标记线索为成交 | 线索状态从「跟进中」变为「已成交」 |
| 标记作废 | 标记线索为无效 | 线索状态从「跟进中」变为「已作废」 |

### 5. 测量服务功能测试 (端到端测试)

**测试文件**：`e2e/flows/lead-measurement.spec.ts`

| 测试项 | 测试步骤 | 预期结果 |
|--------|----------|----------|
| 发起测量任务 | 在线索详情页发起测量任务 | 测量任务创建成功，显示在任务列表中 |
| 指派测量师傅 | 为测量任务指派师傅 | 测量师傅指派成功，任务状态更新 |
| 查看任务列表 | 查看测量任务列表 | 显示该线索的所有测量任务 |

### 6. 活动日志功能测试 (组件测试)

**测试文件**：`src/features/leads/__tests__/lead-activity-log.test.tsx`

| 测试项 | 测试步骤 | 预期结果 |
|--------|----------|----------|
| 日志加载 | 渲染 LeadActivityLog 组件 | 加载并显示活动日志 |
| 日志顺序 | 检查日志顺序 | 日志按时间倒序排列 |
| 展开/收起 | 点击展开/收起按钮 | 切换显示所有日志或仅显示最新一条 |

### 7. 报价版本功能测试 (组件测试)

**测试文件**：`src/features/leads/__tests__/lead-quote-versions.test.tsx`

| 测试项 | 测试步骤 | 预期结果 |
|--------|----------|----------|
| 报价版本显示 | 渲染 LeadQuoteVersions 组件 | 显示该线索的所有报价版本 |
| 最新版本标识 | 检查最新版本 | 最新报价版本被高亮显示 |
| 版本修订 | 点击「修订」按钮 | 创建新的报价修订版本 |

## 测试执行策略

### 1. 本地开发
```bash
# 运行所有测试
pnpm test

# 运行特定测试文件
pnpm test src/features/leads/__tests__/actions.test.ts

# 运行测试并监听文件变化
pnpm test:watch
```

### 2. 端到端测试
```bash
# 安装依赖
pnpm playwright install

# 运行端到端测试
pnpm e2e

# 运行特定端到端测试
pnpm e2e lead-status-workflow

# 调试端到端测试
pnpm e2e:debug
```

### 3. CI/CD 集成
- **GitHub Actions**：在 PR 提交和主分支合并时运行所有测试
- **测试覆盖要求**：代码覆盖率达到 80% 以上
- **测试结果报告**：生成测试覆盖率报告和端到端测试视频

## 测试数据管理

### 1. 测试数据生成
- **种子数据**：使用 `seed-test-user.ts` 和 `seed-channels.ts` 生成测试数据
- **Mock 数据**：在单元测试中使用 Mock 数据模拟 API 响应

### 2. 测试数据清理
- **单元测试**：使用 Mock 数据，无需清理
- **端到端测试**：在测试前清理测试数据，测试后恢复

## 测试监控与报告

### 1. 测试覆盖率报告
- **工具**：Vitest 内置覆盖率报告
- **格式**：HTML、JSON
- **查看命令**：`pnpm test --coverage`

### 2. 端到端测试报告
- **工具**：Playwright HTML 报告
- **查看命令**：`pnpm e2e:report`
- **功能**：包含测试视频、截图和跟踪信息

## 测试维护策略

1. **定期更新测试用例**：当功能变更时，及时更新相关测试用例
2. **添加新测试**：为新功能添加相应的测试用例
3. **修复失败测试**：及时修复因代码变更导致的测试失败
4. **优化测试性能**：减少测试执行时间，提高测试效率

## 预期效果

通过实施该自动化测试方案，我们将：
1. 提高代码质量和稳定性
2. 减少手动测试工作量
3. 快速发现和修复 bug
4. 确保功能变更不会破坏现有功能
5. 为 CI/CD 流程提供可靠的质量保障

## 实施计划

1. **第一阶段**：编写核心功能的单元测试和集成测试
2. **第二阶段**：编写端到端测试用例
3. **第三阶段**：集成到 CI/CD 流程
4. **第四阶段**：优化测试性能和覆盖率

## 资源需求

1. **人员**：测试开发工程师 1 名
2. **时间**：2-3 周完成初始测试框架搭建和核心测试用例编写
3. **环境**：开发环境和 CI/CD 环境

该自动化测试方案将为 L2C 系统的线索管理功能提供全面的质量保障，确保系统的稳定性和可靠性。