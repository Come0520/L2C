# 上线计划

## 1. 目标与范围
- 上线目标：在生产环境稳定发布 L2C 前端（Next.js 15）与 Supabase 后端（Auth/DB/Realtime/Storage），保证登录、线索、订单、权限、实时订阅等核心流程可用。
- 范围：前端托管与管道、Supabase 生产实例准备与迁移、环境变量与密钥、性能与可访问性基线、监控与回滚。

## 2. 部署架构选型
- 推荐方案：Vercel（前端）+ Supabase Cloud（后端）
  - 优点：零运维、全球加速、与 Next.js 原生集成、Supabase 自带监控。
  - 做法：Vercel 连接 GitHub 仓库主分支自动部署；Supabase Cloud 创建项目并应用迁移。
- 备选方案：容器化自托管（前端 + 自托管 Supabase）
  - 需新增 `slideboard-frontend/Dockerfile`，完善 CI 构建与推送镜像，配置自托管 Supabase 组件与反向代理。

## 3. 上线前准备
### 3.1 质量门槛
- 前端质量门槛全部通过：
  - 代码规范：`npm run lint`
  - 类型检查：`npm run typecheck`
  - 单元测试：`npm run test`（94 用例通过）
  - 构建：`npm run build`
- 已进行修复：
  - 性能规则：将 `<img>` 改为 `next/image`（`slideboard-frontend/src/components/slide-card.tsx:64-71`）
  - TS 类型：确保位置与尺寸完整更新（`slideboard-frontend/src/components/properties-panel.tsx:52-61,63-71`）
  - 未使用变量清理（`slideboard-frontend/src/components/slide-editor.tsx:3-4,75-78`；`slideboard-frontend/src/components/slide-card.tsx:6`）
  - 登录测试断言对齐真实签名（`slideboard-frontend/src/app/__tests__/login.test.tsx:120-123`）

### 3.2 环境变量与密钥
- 前端生产环境必须配置：
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- 文件与平台：
  - `slideboard-frontend/.env.production` 填入真实值并通过部署平台的环境设置注入（不要提交密钥到仓库）。
  - 删除不再使用的 `NEXT_PUBLIC_API_URL`，避免混淆“纯 Supabase”架构。

### 3.3 Supabase 生产实例与迁移
- 创建 Supabase 项目（Cloud 推荐），然后执行迁移：
  - 迁移目录：`supabase/migrations/`
  - 关键文件：
    - 初始与 RLS：`20251120000001_init_tables.sql`、`20251123000001_rls_init.sql`、`20251201000002_rls_policies.sql`
    - 业务强化：`20251203000011_enhance_sales_orders_for_27_status.sql`、`20251203000010_enhance_lead_tags_system.sql`
    - 超级管理员：`20251203000020_create_super_admin.sql`
  - 执行方式：可使用 Supabase CLI（`npx supabase db push`）或在 Supabase SQL 控制台逐个执行。
- 验证：
  - 认证触发器与策略：`20251130000001_auth_trigger.sql`、`20251201000004_fix_update_order_function.sql`、`20251203000021_fix_auth_trigger.sql`
  - 行级安全（RLS）与角色权限覆盖关键业务表。

### 3.4 CI/CD 工作流修正
- `.github/workflows/ci-cd.yml`：
  - 移除所有 `slideboard-backend` 的安装、测试和镜像步骤。
  - 将所有前端步骤 `working-directory` 指向 `./slideboard-frontend`。
  - Lighthouse CI：将 `startServerCommand` 改为在前端目录启动，例如：`npm run start --prefix slideboard-frontend`。
- `.github/workflows/security-scan.yml`：
  - 将 `frontend`/`backend` 路径更新为 `slideboard-frontend`。
- 镜像构建：
  - 若采用容器化，需要新增 `slideboard-frontend/Dockerfile` 并在 `build-images` Job 中构建与推送前端镜像。

### 3.5 规范与配置一致性
- 规则要求“不使用邮箱”，建议首版上线禁用邮箱登录入口，仅保留手机号 + 密码/验证码：
  - 修改文件：`slideboard-frontend/src/app/(auth)/login/page.tsx:186-200,202-345`
  - 做法：隐藏邮箱切换按钮与邮箱输入块，仅保留手机号登录 UI 与逻辑。

## 4. 发布流程（推荐：Vercel + Supabase Cloud）
1. Vercel 项目创建并连接 Git 分支，设置生产域名与 HTTPS。
2. 在 Vercel 环境变量中配置 `NEXT_PUBLIC_SUPABASE_URL` 与 `NEXT_PUBLIC_SUPABASE_ANON_KEY`。
3. 在 Supabase Cloud 创建项目并执行迁移，验证 RLS 与触发器。
4. 推送代码到主分支触发构建与部署。
5. 执行 LHCI：在 CI 中运行 `lhci autorun`（或手动），验证性能与可访问性阈值：
   - `categories:performance ≥ 0.85`
   - `categories:accessibility ≥ 0.90`
6. 冒烟测试与验收：登录、线索、订单状态变更与历史、实时订阅、权限控制。
7. 切流发布（如需）：先将生产流量部分导向新版本，监控稳定后全量切换。

## 5. 回滚方案
- Vercel：回滚至上一个成功构建（选择历史构建上线）。
- 容器化：保持上一版本镜像标签，使用 `docker-compose` 切回旧镜像。
- 数据库：迁移脚本严格按前滚设计；如需回滚，准备对应逆向迁移脚本或快照恢复（生产必须开启定时备份）。

## 6. 时间估算
- 修正 CI/CD 工作流：0.5 天
- 部署策略落地（Vercel 或容器化）：0.5–1 天
- 生产环境变量与密钥配置：0.5 天
- Supabase 生产实例迁移与验证：1 天
- 域名与证书：0.5 天
- 监控与日志（Sentry/Supabase Dashboard）：0.5 天
- 性能与可访问性基线（LHCI）：0.5 天
- 发布演练与回滚方案：0.5 天
- 合计：约 4–6 天（并行可缩短至 3–4 天）

## 7. 上线验收清单
- 质量门槛：lint/typecheck/test/build 全绿。
- 环境变量与密钥：生产环境注入正确，无明文密钥入库。
- Supabase：迁移成功、RLS 生效、触发器正确。
- 登录：手机号 + 密码/验证码可用，邮箱入口已禁用。
- 核心流程：线索/订单/权限/实时订阅全功能走查通过。
- 性能与可访问性：LHCI 阈值达标。
- 域名与 HTTPS：生效且强制跳转。
- 监控：Sentry 上报正常、Supabase Dashboard 可见数据库健康。
- 回滚：一键回滚能力验证通过。

## 8. 运维与监控
- 错误追踪：Sentry（Next.js 集成）。
- 数据库监控：Supabase Dashboard（健康、日志）。
- 性能采集：Vercel Analytics 或自建端点。
- 报警：必要时接入飞书/企业微信 Webhook（已有 `.env.example` 字段）。

## 9. 风险与缓解
- CI/CD 引用不存在目录导致失败：已在计划中优先修复。
- 环境变量缺失：统一通过平台注入并在构建前校验。
- 迁移风险：先在预生产实例演练，确认后再生产执行。
- 实时订阅稳定性：只在关键页面启用并设置断线重连策略。

## 10. 版本与里程碑
- v1.0（MVP）发布：完成本计划全部验收项即可标记为 v1.0。
- v1.1：优化性能与用户体验，补充更多自动化测试与可观测性。

---

最后更新：自动生成于 CI 通过后，依据当前仓库状态与建议整理。
