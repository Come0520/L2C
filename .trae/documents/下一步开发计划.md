# 下一步开发计划

## 📊 项目现状

### 已完成工作
- ✅ 核心需求文档整理完成
- ✅ 业务流程图优化完成
- ✅ 数据库缺口分析完成
- ✅ 前端框架搭建（Next.js 15 + React 19 + Tailwind CSS v4）
- ✅ 后端框架搭建（NestJS + TypeORM + PostgreSQL）
- ✅ 订单创建页面基础功能
- ✅ 待测量页面基础功能

### 核心问题
1. ❌ 线索管理：字段严重不足，无标签系统、无跟踪记录
2. ❌ 状态流转：当前仅5个状态，与需求中的25个状态不匹配
3. ❌ 积分激励系统：完全缺失
4. ❌ 罗莱好伙伴：仅有partner_level字段，无详细管理
5. ⚠️ 财务管理：无发票表、无回款表
6. ⚠️ 测量/安装：表存在但字段不足

## 🎯 下一步开发目标

**用50%的工作量，搭建可运行的MVP系统，覆盖核心业务闭环**

## 🗓️ 详细开发计划

### 阶段1：数据库架构完善（3天）

#### 任务1.1：扩展现有表字段
- **线索表（leads）**：扩展15个关键字段
- **销售订单表（sales_orders）**：扩展12个字段，重新设计status字段
- **测量订单表（measurement_orders）**：完善字段
- **安装订单表（installation_orders）**：完善字段

#### 任务1.2：创建缺失表
- **线索管理**：lead_tags, lead_tag_assignments, lead_followups, lead_assignments
- **销售订单**：order_statuses, sales_order_status_history
- **积分系统**：points_accounts, points_transactions, points_rules, points_products, points_orders, points_order_items, points_product_categories
- **好伙伴管理**：partner_profiles, sales_order_partners

#### 任务1.3：编写数据库迁移脚本
- 使用TypeORM编写迁移脚本
- 确保迁移脚本可在开发环境正常执行
- 编写回滚脚本以应对迁移失败情况

### 阶段2：后端API开发（4天）

#### 任务2.1：线索管理API
- 创建线索API：POST /api/leads
- 线索列表与详情API：GET /api/leads, GET /api/leads/:id
- 线索分配与跟踪API：POST /api/leads/:id/assign, POST /api/leads/:id/followup
- 线索标签管理API：POST /api/leads/:id/tags, DELETE /api/leads/:id/tags/:tagId
- Excel导入API：POST /api/leads/import

#### 任务2.2：报价单API
- 创建报价单API：POST /api/quotes
- 报价单版本管理API：POST /api/quotes/:id/versions, PUT /api/quotes/:id/versions/:versionId
- 生成销售单API：POST /api/quotes/:id/generate-order

#### 任务2.3：销售订单API
- 创建销售订单API：POST /api/sales-orders
- 销售订单状态管理API：PUT /api/sales-orders/:id/status
- 销售订单状态历史API：GET /api/sales-orders/:id/status-history

#### 任务2.4：积分系统API
- 积分账户API：GET /api/points/account
- 积分交易记录API：GET /api/points/transactions
- 积分商品API：GET /api/points/products
- 积分兑换订单API：POST /api/points/orders

### 阶段3：业务逻辑实现（3天）

#### 任务3.1：线索重复检查引擎
- 实现姓名+地址完全匹配检测
- 实现地址相似度算法
- 实现姓名+设计师/导购组合检测

#### 任务3.2：积分计算引擎
- 实现积分计算公式：积分 = 成交金额 × 产品品类系数 × 时间段系数 × 门店系数
- 实现在途积分机制
- 实现好伙伴积分计算
- 实现积分触发点事件监听

#### 任务3.3：状态流转引擎
- 实现10个核心状态的状态机逻辑
- 实现状态变更权限控制
- 实现状态历史记录
- 实现状态变更通知（简化版）

### 阶段4：前端页面开发（4天）

#### 任务4.1：线索管理页面
- 线索列表页（/leads）：表格展示、筛选、分页、标签筛选、批量操作
- 线索详情页（/leads/:id）：基本信息、跟踪记录时间线、标签管理、分配操作
- 线索创建/编辑页
- Excel导入对话框

#### 任务4.2：报价单页面
- 报价单列表页（/quotes）
- 报价单详情页（/quotes/:id）：版本列表、版本对比、生成销售单

#### 任务4.3：销售订单页面
- 销售订单列表页（/sales-orders）：状态筛选、状态看板视图
- 销售订单详情页（/sales-orders/:id）：订单信息、状态流转时间线、操作按钮

#### 任务4.4：积分商城页面
- 积分商城首页（/points-mall）：商品分类、商品列表、搜索功能
- 商品详情页（/points-mall/products/:id）
- 我的积分页（/points/account）：积分余额、在途积分、交易记录
- 兑换订单页（/points/orders）

### 阶段5：集成测试与部署准备（2天）

#### 任务5.1：功能测试
- 编写核心API单元测试（覆盖率>60%）
- 编写端到端测试（主流程）
- 修复测试中发现的Bug

#### 任务5.2：代码质量检查
- 修复ESLint错误
- 修复TypeScript类型错误
- 确保代码符合团队规范

#### 任务5.3：文档生成与部署准备
- 生成API文档（Swagger）
- 编写部署文档
- 配置CI流水线

## 🎯 核心功能验收标准

### 线索管理
- ✅ 可创建线索并自动分配
- ✅ 可添加跟踪记录并查看历史
- ✅ 可打标签并按标签筛选
- ✅ Excel导入成功，重复检测有效

### 报价单流转
- ✅ 可创建报价单并管理多版本
- ✅ 可从报价单生成销售单
- ✅ 版本切换正确同步状态

### 销售订单流转
- ✅ 10个核心状态可正常流转
- ✅ 状态历史可追溯
- ✅ 状态变更权限控制生效

### 积分系统
- ✅ 线索/订单操作自动发放积分
- ✅ 积分账户余额计算正确
- ✅ 可在商城兑换商品
- ✅ 在途积分机制生效
- ✅ 好伙伴积分计算正确

## 🔄 迭代优化计划

### Phase 2（后续迭代）
- ✅ 完整的25状态流转实现
- ✅ 审批流程系统
- ✅ 通知系统
- ✅ 完整的测量/安装派单系统

### Phase 3（长期规划）
- ✅ 权限管理RBAC
- ✅ 操作审计日志
- ✅ 高级数据分析与报表
- ✅ 移动端支持

## ⚠️ 风险与缓解措施

### 高风险
1. **数据库迁移失败**
   - 缓解：迁移前备份数据库；先在开发环境测试；编写回滚脚本

2. **积分计算逻辑错误**
   - 缓解：编写详细单元测试；手工验证典型案例；实现积分调整功能

3. **状态流转逻辑混乱**
   - 缓解：先实现10个核心状态；状态机图文档化；Phase 2补全剩余状态

### 中风险
4. **性能问题**
   - 缓解：提前添加数据库索引；实现分页；考虑缓存策略

5. **前后端联调问题**
   - 缓解：使用TypeScript共享类型；Swagger文档先行；Mock数据测试

6. **工期延误**
   - 缓解：严格MVP范围；每日站会跟进；及时调整优先级

## 👥 角色与分工

| 角色 | 职责 | 关键任务 |
|------|------|----------|
| **项目经理** | 节奏把控、风险管理、里程碑验收 | 每日站会、风险跟踪、文档审核 |
| **后端开发** | 数据库设计、API开发、业务逻辑 | 迁移脚本、Service层、积分引擎 |
| **前端开发** | 页面开发、组件封装、API集成 | 页面实现、状态管理、用户体验优化 |
| **测试** | 功能测试、集成测试、性能测试 | 测试用例、Bug跟踪、验收测试 |
| **产品** | 需求确认、优先级调整、验收标准 | 原型评审、功能验收、用户反馈 |

## 📈 状态汇报节奏

### 每日站会（15分钟）
- 时间：每天早上10:00
- 内容：昨日完成、今日计划、遇到阻塞、需要协助

### 里程碑评审
- **M1评审**（Day 3）：数据库架构评审
- **M2评审**（Day 7）：线索管理与销售流程演示
- **M3评审**（Day 9）：积分系统演示
- **M4评审**（Day 11）：最终验收

### 周报
- 时间：每周五下午
- 内容：周进度、下周计划、风险提示

## 📚 参考文档

- [核心需求速查](./需求/00-核心需求速查.md)
- [数据库设计缺口分析报告](./需求/06-数据库/数据库设计缺口分析报告.md)
- [业务单据生命周期流程图](./business-document-lifecycle-flowchart.md)
- [流程图优化报告](./流程图优化报告.md)
- [项目架构演进策略](./项目架构演进策略.md)