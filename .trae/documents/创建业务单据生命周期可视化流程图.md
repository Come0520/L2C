# 业务单据生命周期可视化流程图设计方案

## 1. 设计目标
创建一个全面的可视化流程图，展示线索、报价单、销售单、测量单、安装单和对账单的完整生命周期及状态变化流程，清晰呈现各单据之间的关联关系、数据流转路径及交互方式，特别关注报价单的多版本管理，确保被选中为当前方案的报价单版本的状态同步为报价单的状态。

## 2. 设计内容

### 2.1 流程图结构
- **主流程图**：展示从线索到对账单的完整业务流程
- **子流程图**：详细展示每个单据的状态流转
- **关联关系图**：展示单据之间的关联和数据流转

### 2.2 单据状态节点

#### 线索（Lead）
- 状态：new（新建）、assigned（已分配）、following（跟进中）、converted（已转化）、invalid（已失效）
- 触发事件：录入线索、分配销售、开始跟踪、转化、关闭线索、重新激活

#### 报价单（Quote）
- 状态：draft（草稿）、preliminary（初稿）、confirmed（已确认）、cancelled（已取消）、expired（已过期）
- 触发事件：创建报价单、状态同步（从当前选中版本）、手动更新
- 特殊规则：报价单状态与当前选中的报价单版本状态保持同步

#### 报价单版本（QuoteVersion）
- 状态：draft（草稿）、preliminary（初稿）、confirmed（已确认）、cancelled（已取消）、expired（已过期）
- 触发事件：创建报价单版本、设置为当前版本、客户确认、取消、过期
- 特殊规则：
  - 当一个报价单版本被设置为当前版本时，其状态同步到报价单主记录
  - 当一个报价单版本被确认后，其他版本自动变为已取消状态
  - 当当前版本状态变化时，报价单主记录状态同步更新

#### 销售单（SalesOrder）
- 状态：draft（草稿）、confirmed（已确认）、measuring（测量中）、production（生产中）、delivery（配送中）、installing（安装中）、completed（已完成）、cancelled（已取消）
- 触发事件：创建订单、确认订单、开始测量、测量完成、生产完成、开始配送、开始安装、安装完成、取消订单

#### 测量单（MeasurementOrder）
- 状态：pending（待分配）、assigned（已分配）、in_progress（测量中）、completed（已完成）、cancelled（已取消）
- 触发事件：创建测量单、分配测量师、测量师接单、完成测量、取消测量

#### 安装单（InstallationOrder）
- 状态：pending（待分配）、assigned（已分配）、in_progress（安装中）、completed（已完成）、cancelled（已取消）
- 触发事件：创建安装单、分配安装师、安装师接单、完成安装、取消安装

#### 对账单（ReconciliationOrder）
- 状态：pending（待对账）、reconciling（对账中）、completed（已完成）、discrepancy（有差异）、adjusted（已调整）、cancelled（已取消）
- 触发事件：创建对账单、开始对账、对账完成、发现差异、调整差异、取消对账

### 2.3 单据关联关系
- 线索 → 报价单：线索跟进中创建报价单
- 报价单 → 报价单版本：一个报价单可以有多个版本
- 报价单版本 → 销售单：客户确认报价单版本后生成销售单
- 销售单 → 测量单：销售单确认后生成测量单
- 销售单 → 安装单：生产完成后生成安装单
- 销售单 → 对账单：安装完成后生成对账单

### 2.4 状态同步机制
1. **初始同步**：当报价单版本被设置为当前版本时，其状态同步到报价单主记录
2. **实时同步**：当前版本状态变化时，报价单主记录状态自动同步更新
3. **版本切换同步**：当切换当前版本时，报价单主记录状态同步为新的当前版本状态
4. **自动取消同步**：当一个版本被确认后，其他版本自动变为已取消，不影响报价单主记录状态

### 2.5 流程图符号
- **圆角矩形**：表示状态节点
- **箭头**：表示状态转换
- **菱形**：表示决策点
- **矩形**：表示触发事件/操作
- **虚线箭头**：表示单据之间的关联关系
- **双线箭头**：表示状态同步关系
- **双线矩形**：表示主实体
- **单线矩形**：表示子实体

## 3. 实现方式
使用Mermaid绘制流程图，创建一个Markdown文件，包含完整的流程图代码和图例说明。

## 4. 输出文件
- 文件名：`business-document-lifecycle-flowchart.md`
- 位置：项目根目录

## 5. 设计原则
- 清晰明了：使用简洁的符号和文字，确保流程图易于理解
- 层次分明：主流程图和子流程图分离，便于查看整体和细节
- 完整全面：覆盖所有单据的所有状态和转换
- 规范统一：使用统一的符号和格式
- 可读性强：提供详细的图例说明
- 符合业务需求：准确反映报价单多版本管理及状态同步机制

## 6. 预期效果
- 直观展示从线索到对账单的完整业务流程
- 清晰呈现每个单据的状态流转，特别是报价单的多版本管理和状态同步机制
- 明确展示单据之间的关联关系和数据流转
- 便于理解和学习业务流程
- 支持后续业务流程优化和调整