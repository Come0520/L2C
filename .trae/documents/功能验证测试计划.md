# 功能验证测试计划

## 1. 测试框架与环境

### 1.1 现有测试框架
- **测试工具**: Vitest + React Testing Library
- **覆盖率工具**: V8 Coverage
- **浏览器模拟**: jsdom
- **CI/CD集成**: 支持CI环境运行

### 1.2 测试环境配置
```bash
# 安装依赖
npm install

# 运行测试
npm run test          # 单次运行所有测试
npm run test:watch    # 监视模式运行测试
npm run test:coverage # 生成覆盖率报告
npm run test:ci       # CI环境运行
```

## 2. 核心业务流程测试矩阵

### 2.1 线索管理流程测试
| 测试场景 | 测试方法 | 负责人 | 状态 |
|---------|---------|--------|------|
| 创建线索 | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 分配线索 | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 跟踪线索 | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 添加标签 | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 上传预报价 | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 草签转订单 | 自动化测试 + 手动测试 | 待定 | 待执行 |

### 2.2 销售单25状态流转测试
| 测试场景 | 测试方法 | 负责人 | 状态 |
|---------|---------|--------|------|
| 预算中 → 等待推单 | 手动测试 | 待定 | 待执行 |
| 等待推单 → 待测量 | 手动测试 | 待定 | 待执行 |
| 待测量 → 测量中-待确认 | 手动测试 | 待定 | 待执行 |
| ... (所有25个状态流转) | 手动测试 | 待定 | 待执行 |
| 待回款 → 已完成 | 手动测试 | 待定 | 待执行 |

### 2.3 积分系统测试
| 测试场景 | 测试方法 | 负责人 | 状态 |
|---------|---------|--------|------|
| 线索创建积分发放(+5分) | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 销售单完成积分(+30分) | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 罗莱好伙伴在途积分 | 手动测试 | 待定 | 待执行 |
| 积分商城兑换流程 | 手动测试 | 待定 | 待执行 |
| 订单金额计算积分系数 | 自动化测试 | 待定 | 待执行 |

### 2.4 权限控制测试
| 测试场景 | 测试方法 | 负责人 | 状态 |
|---------|---------|--------|------|
| 8种角色权限验证 | RLS策略测试 | 待定 | 待执行 |

### 2.5 产品管理测试
| 测试场景 | 测试方法 | 负责人 | 状态 |
|---------|---------|--------|------|
| 产品CRUD操作 | 自动化测试 + 手动测试 | 待定 | 待执行 |
| 库存管理 | 自动化测试 + 手动测试 | 待定 | 待执行 |

## 3. 自动化测试实现

### 3.1 测试文件结构
```
src/
├── app/
│   └── __tests__/
│       ├── leads.test.tsx          # 线索管理测试
│       ├── sales-orders.test.tsx   # 销售单测试
│       ├── points.test.tsx         # 积分系统测试
│       ├── permissions.test.tsx    # 权限控制测试
│       └── products.test.tsx       # 产品管理测试
├── features/
│   ├── leads/
│   │   └── __tests__/
│   │       ├── create-lead.test.tsx
│   │       └── lead-assignment.test.tsx
│   └── orders/
│       └── __tests__/
│           ├── status-flow.test.tsx
│           └── order-creation.test.tsx
└── services/
    └── __tests__/
        ├── leads-service.test.ts
        ├── orders-service.test.ts
        └── points-service.test.ts
```

### 3.2 核心测试用例设计

#### 3.2.1 线索管理测试
```typescript
// leads.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import LeadsPage from '../leads/page';
import { leadService } from '@/services/leads.client';

vi.mock('@/services/leads.client', () => ({
  leadService: {
    createLead: vi.fn(),
    assignLead: vi.fn(),
    updateLeadStatus: vi.fn()
  }
}));

describe('线索管理测试', () => {
  it('应该成功创建线索', async () => {
    // 测试步骤：
    // 1. 渲染线索页面
    // 2. 点击"新建线索"按钮
    // 3. 填写线索表单
    // 4. 提交表单
    // 5. 验证createLead方法被调用
  });

  it('应该成功分配线索', async () => {
    // 测试步骤：
    // 1. 渲染线索详情页面
    // 2. 选择分配人员
    // 3. 点击"分配"按钮
    // 4. 验证assignLead方法被调用
  });

  it('应该成功更新线索状态', async () => {
    // 测试步骤：
    // 1. 渲染线索详情页面
    // 2. 选择新状态
    // 3. 点击"更新状态"按钮
    // 4. 验证updateLeadStatus方法被调用
  });
});
```

#### 3.2.2 销售单状态流转测试
```typescript
// sales-orders.test.tsx
import { ORDER_STATUS, ORDER_STATUS_TRANSITIONS } from '@/constants/order-status';
import { orderService } from '@/services/orders.client';

vi.mock('@/services/orders.client', () => ({
  orderService: {
    updateOrderStatus: vi.fn()
  }
}));

describe('销售单状态流转测试', () => {
  // 测试所有合法的状态流转
  Object.entries(ORDER_STATUS_TRANSITIONS).forEach(([fromStatus, toStatuses]) => {
    toStatuses.forEach(toStatus => {
      it(`应该允许从 ${fromStatus} 流转到 ${toStatus}`, async () => {
        // 测试步骤：
        // 1. 调用updateOrderStatus方法
        // 2. 验证状态更新成功
      });
    });
  });

  it('应该验证销售单完整流程', async () => {
    // 测试完整的销售单流程：
    // 线索创建 → 分配 → 跟踪 → 草签 → 测量 → 生产 → 发货 → 安装 → 完成
  });
});
```

#### 3.2.3 积分系统测试
```typescript
// points.test.tsx
import { pointsService } from '@/services/points.client';
import { leadService } from '@/services/leads.client';
import { orderService } from '@/services/orders.client';

vi.mock('@/services/points.client', () => ({
  pointsService: {
    getPoints: vi.fn(),
    redeemPoints: vi.fn()
  }
}));

describe('积分系统测试', () => {
  it('应该在创建线索时发放5积分', async () => {
    // 测试步骤：
    // 1. 创建线索
    // 2. 验证积分增加5分
  });

  it('应该在销售单完成时发放30积分', async () => {
    // 测试步骤：
    // 1. 完成销售单
    // 2. 验证积分增加30分
  });

  it('应该支持积分商城兑换', async () => {
    // 测试步骤：
    // 1. 获取用户积分
    // 2. 兑换商品
    // 3. 验证积分减少
    // 4. 验证兑换记录
  });
});
```

## 4. 手动测试清单

### 4.1 线索管理流程

#### 4.1.1 创建线索(驻店销售角色)
1. 登录系统
2. 进入线索管理页面
3. 点击"新建线索"按钮
4. 填写客户信息：姓名、电话、地址、需求等
5. 点击"保存"按钮
6. 验证线索创建成功

#### 4.1.2 分配线索(销售负责人角色)
1. 登录系统(销售负责人角色)
2. 进入线索管理页面
3. 选择待分配的线索
4. 点击"分配"按钮
5. 选择销售人员
6. 点击"确认"按钮
7. 验证线索分配成功

#### 4.1.3 跟踪并添加标签
1. 登录系统(销售人员角色)
2. 进入线索详情页面
3. 点击"跟踪"按钮
4. 添加跟踪记录
5. 点击"添加标签"按钮
6. 选择或创建标签
7. 点击"保存"按钮
8. 验证标签添加成功

#### 4.1.4 上传预报价(验证90天有效期)
1. 进入线索详情页面
2. 点击"上传预报价"按钮
3. 选择报价文件
4. 填写报价信息
5. 点击"保存"按钮
6. 验证预报价上传成功
7. 验证预报价显示90天有效期

#### 4.1.5 草签转订单
1. 进入线索详情页面
2. 点击"草签转订单"按钮
3. 填写订单信息
4. 点击"确认"按钮
5. 验证订单创建成功
6. 验证线索状态更新

### 4.2 销售单25状态流转

| 状态流转 | 操作步骤 | 验证要点 |
|---------|---------|---------|
| 预算中 → 等待推单 | 上传预算报价单 | 状态更新为"等待推单" |
| 等待推单 → 待测量 | 远程销售上传推单 | 状态更新为"待测量" |
| 待测量 → 测量中-待确认 | 分配测量人员并完成测量 | 状态更新为"测量中-待确认" |
| ... | ... | ... |
| 待回款 → 已完成 | 财务确认回款 | 状态更新为"已完成" |

### 4.3 积分系统

#### 4.3.1 验证线索创建积分发放
1. 创建新线索
2. 查看用户积分记录
3. 验证积分增加5分

#### 4.3.2 验证销售单完成积分
1. 完成销售单
2. 查看用户积分记录
3. 验证积分增加30分

#### 4.3.3 验证罗莱好伙伴在途积分
1. 查看积分明细
2. 验证罗莱好伙伴相关积分显示为"在途"
3. 验证在途积分的计算规则

#### 4.3.4 积分商城兑换流程
1. 进入积分商城
2. 选择可兑换商品
3. 点击"兑换"按钮
4. 确认兑换信息
5. 验证积分扣除
6. 验证兑换记录生成

#### 4.3.5 订单金额计算积分系数
1. 创建不同金额的销售单
2. 完成销售单
3. 验证积分计算符合系数规则

## 5. 测试数据准备

### 5.1 测试用户数据
| 角色 | 用户名 | 密码 | 权限 |
|-----|--------|------|------|
| 驻店销售 | sales1@example.com | password123 | 线索创建、跟踪 |
| 销售负责人 | manager1@example.com | password123 | 线索分配、审批 |
| 测量人员 | measurer1@example.com | password123 | 测量任务 |
| 安装人员 | installer1@example.com | password123 | 安装任务 |
| 财务人员 | finance1@example.com | password123 | 回款确认 |
| 管理员 | admin@example.com | password123 | 所有权限 |

### 5.2 测试产品数据
| 产品名称 | 型号 | 价格 | 库存 |
|---------|------|------|------|
| 窗帘A | CUR-001 | 1999 | 100 |
| 窗帘B | CUR-002 | 2999 | 50 |
| 墙布A | WALL-001 | 999 | 200 |
| 墙纸A | WALLPAPER-001 | 499 | 300 |

## 6. 测试执行与报告

### 6.1 测试执行流程
1. **测试计划评审**: 团队评审测试计划
2. **测试环境准备**: 配置测试环境和数据
3. **自动化测试执行**: 运行自动化测试套件
4. **手动测试执行**: 按照测试清单执行手动测试
5. **缺陷管理**: 记录和跟踪缺陷
6. **测试报告生成**: 生成测试报告和覆盖率报告

### 6.2 测试报告模板
```markdown
# 功能验证测试报告

## 1. 测试概况
- **测试时间**: YYYY-MM-DD
- **测试环境**: 开发环境 / 测试环境
- **测试人员**: 测试团队

## 2. 测试结果

### 2.1 自动化测试结果
| 测试模块 | 测试用例数 | 通过数 | 失败数 | 通过率 |
|---------|-----------|-------|-------|--------|
| 线索管理 | 15 | 14 | 1 | 93.3% |
| 销售订单 | 30 | 28 | 2 | 93.3% |
| 积分系统 | 10 | 10 | 0 | 100% |
| 权限控制 | 8 | 8 | 0 | 100% |
| 产品管理 | 12 | 11 | 1 | 91.7% |
| **总计** | **75** | **71** | **4** | **94.7%** |

### 2.2 手动测试结果
| 测试模块 | 测试用例数 | 通过数 | 失败数 | 通过率 |
|---------|-----------|-------|-------|--------|
| 线索管理流程 | 5 | 5 | 0 | 100% |
| 销售单25状态流转 | 25 | 23 | 2 | 92% |
| 积分系统 | 5 | 5 | 0 | 100% |
| **总计** | **35** | **33** | **2** | **94.3%** |

## 3. 覆盖率报告
- **行覆盖率**: 85.2%
- **分支覆盖率**: 78.5%
- **函数覆盖率**: 90.1%
- **语句覆盖率**: 87.3%

## 4. 缺陷统计
| 缺陷级别 | 数量 | 状态 |
|---------|------|------|
| 严重 | 1 | 已修复 |
| 主要 | 3 | 修复中 |
| 次要 | 2 | 待修复 |
| 建议 | 5 | 待评审 |

## 5. 总结与建议

### 5.1 测试总结
- 核心业务流程测试通过
- 自动化测试覆盖率达到85%以上
- 手动测试验证了所有关键业务场景

### 5.2 改进建议
- 增加异常场景测试
- 提高边缘情况测试覆盖率
- 优化测试数据准备流程
- 加强性能测试
```

## 7. 风险与应对

| 风险项 | 影响程度 | 发生概率 | 应对措施 |
|-------|---------|---------|---------|
| 测试数据不一致 | 中 | 中 | 建立测试数据管理机制 |
| 环境配置问题 | 高 | 低 | 编写环境配置脚本 |
| 业务逻辑变更 | 高 | 中 | 建立测试用例维护机制 |
| 测试覆盖率不足 | 中 | 中 | 定期评审覆盖率报告 |

## 8. 后续优化计划

1. **测试自动化率提升**: 目标达到90%以上
2. **性能测试引入**: 增加性能测试用例
3. **安全测试集成**: 引入安全测试工具
4. **可视化测试报告**: 优化测试报告展示
5. **测试用例管理**: 建立测试用例管理系统

---

**测试计划版本**: v1.0
**制定日期**: $(date)
**制定人**: 测试团队
**审批人**: 技术负责人