# 安全合规修复计划

## 🔥 第一优先级：安全合规修复（本周完成）

### 1. 移除邮箱登录功能
**问题**：项目规则明确要求"不使用邮箱"，但代码库中存在大量邮箱相关功能
**修复范围**：
- 移除所有邮箱登录相关代码
- 删除用户信息中的邮箱字段
- 清理团队管理、分享功能中的邮箱依赖
- 移除邮箱验证工具函数
- 更新相关类型定义

**具体文件**：
- `src/components/ui/reassign-modal.tsx` - 移除邮箱搜索和展示
- `src/components/ui/share-modal.tsx` - 移除通过邮箱分享功能
- `src/utils/format.ts` - 删除邮箱验证函数
- `src/utils/validation.ts` - 删除邮箱验证函数
- `src/types/teams.ts` - 移除email字段
- `src/types/installation-team.ts` - 移除email字段
- 相关页面组件中的邮箱展示和编辑功能

### 2. 补充 CSP 与安全响应头
**问题**：当前项目未配置任何 CSP 或安全响应头
**修复方案**：
- 在 Next.js 中添加 CSP 配置
- 配置必要的安全响应头（X-Frame-Options, X-XSS-Protection, X-Content-Type-Options等）
- 实现安全响应头中间件

**具体文件**：
- `next.config.js` - 添加 CSP 配置
- `src/middleware.ts` - 实现安全响应头中间件

### 3. 验证 Cookie 安全属性
**问题**：需要确保 Cookie 配置了正确的安全属性
**修复方案**：
- 检查并配置 Cookie 的 Secure、HttpOnly、SameSite 属性
- 确保生产环境中 Cookie 使用安全配置

**具体文件**：
- `src/lib/supabase/client.ts` - 配置 Supabase Auth Cookie 选项
- `next.config.js` - 配置 Next.js Cookie 策略

### 4. 文件与分享治理
**问题**：需要验证分享令牌的权限控制和有效期管理
**修复方案**：
- 确保分享令牌验证时检查有效期和使用次数
- 实现令牌权限的严格控制
- 确保令牌使用后更新使用计数

**具体文件**：
- `src/app/api/sharing/tokens/route.ts` - 检查令牌验证逻辑
- 需要添加令牌验证的中间件或服务

## 📋 修复步骤

### 第1天：移除邮箱相关功能
- 清理所有邮箱相关的UI组件和功能
- 删除邮箱验证工具函数
- 更新类型定义

### 第2天：配置 CSP 和安全响应头
- 实现安全响应头中间件
- 配置 CSP 策略
- 测试安全头效果

### 第3天：优化 Cookie 安全配置
- 配置 Supabase Auth Cookie 安全属性
- 检查其他 Cookie 的安全配置

### 第4天：强化分享治理
- 验证分享令牌验证逻辑
- 完善权限控制
- 进行安全测试

## ✅ 验收标准
- 安全扫描无高危漏洞
- Lighthouse 安全项全部通过
- 敏感数据访问可控
- 无邮箱相关功能残留
- 所有安全响应头配置正确

## 🛠️ 技术实现要点

1. **CSP 策略**：使用严格的 CSP 策略，只允许必要的资源加载
2. **安全响应头**：实现完整的安全响应头集合
3. **Cookie 安全**：确保所有 Cookie 配置了 Secure、HttpOnly、SameSite=Strict
4. **分享治理**：实现令牌的完整生命周期管理
5. **代码清理**：彻底移除所有邮箱相关代码，确保项目符合"不使用邮箱"规则

## 📊 风险评估
- **低风险**：移除邮箱功能主要是代码清理工作
- **中风险**：CSP 配置可能影响现有功能，需要仔细测试
- **低风险**：Cookie 安全配置是标准实践
- **中风险**：分享治理需要确保不影响现有分享功能

## 🧪 测试策略
- 单元测试：验证安全配置的正确性
- 集成测试：测试完整的认证和分享流程
- 安全扫描：使用 Lighthouse 和安全扫描工具验证修复效果
- 手动测试：确保现有功能不受影响