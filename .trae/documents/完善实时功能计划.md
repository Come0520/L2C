# 完善实时功能计划

## 1. 配置 Supabase Realtime

### 1.1 检查 Supabase 项目配置
- 确保 Supabase 项目已启用 Realtime 功能
- 确保 `orders` 表已配置为允许实时更新
- 检查并确保 `order_items` 表也已配置为允许实时更新（如果需要）

### 1.2 更新 Realtime 服务配置
- 检查并优化现有的 `realtime.service.ts`
- 添加订单相关的实时订阅方法
- 确保实时服务能够正确处理连接状态

## 2. 实现订单列表自动刷新

### 2.1 创建订单实时钩子
- 创建 `useRealtimeOrders` 钩子，位于 `/src/hooks/useRealtimeOrders.ts`
- 监听 `orders` 表的所有事件（INSERT, UPDATE, DELETE）
- 实现类似于 `useRealtimeMeasurements` 的逻辑，处理订单列表的实时更新

### 2.2 集成到订单列表组件
- 找到订单列表组件（可能位于 `/src/app/orders/page.tsx` 或类似位置）
- 将现有的静态订单列表替换为使用 `useRealtimeOrders` 钩子的实时列表
- 确保列表能够正确处理新增、更新和删除的订单

## 3. 实现协作实时更新

### 3.1 优化销售单状态变化订阅
- 检查并更新 `realtime.service.ts` 中的 `subscribeToSalesOrderStatusChanges` 方法
- 确保订阅逻辑能够处理所有相关订单的变化，而不仅仅是基于 `sales_person_id` 过滤
- 添加对 `order_items` 表变化的订阅支持

### 3.2 创建订单详情实时钩子
- 创建 `useRealtimeOrder` 钩子，用于单个订单详情的实时更新
- 监听单个订单的所有变化，包括关联的订单项
- 确保订单详情页面能够实时反映协作变化

### 3.3 实现实时通知
- 确保当订单状态变化时，相关用户能够收到实时通知
- 集成现有的通知系统，确保实时性

## 4. 测试和优化

### 4.1 测试实时功能
- 测试订单列表的自动刷新
- 测试订单详情的实时更新
- 测试多用户协作场景

### 4.2 优化性能
- 确保实时订阅不会导致性能问题
- 优化事件处理逻辑，避免不必要的重新渲染
- 确保组件卸载时正确取消订阅

## 5. 文档更新

### 5.1 更新技术文档
- 记录实时功能的实现细节
- 提供使用示例和最佳实践
- 更新API文档，包括实时功能相关的部分

## 预期成果

- 订单列表能够自动刷新，实时反映新增、更新和删除的订单
- 多用户协作时，订单详情能够实时更新
- 相关用户能够收到订单状态变化的实时通知
- 实时功能性能良好，不会影响系统整体性能

## 技术要点

- 使用 Supabase Realtime 服务实现实时功能
- 基于现有的实时钩子模式扩展新的钩子
- 确保组件卸载时正确取消订阅，避免内存泄漏
- 优化实时事件处理逻辑，确保性能良好

## 依赖关系

- Supabase SDK（已存在）
- 现有的实时服务架构（已存在）
- 现有的订单服务（已存在）