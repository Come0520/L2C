# 实现权限控制组件

## 问题分析

1. 目前 ServiceDispatchOnly 等组件只是简单的占位组件，没有实际权限控制逻辑
2. 系统已定义完整的 UserRole 类型和 AuthContext
3. 需要实现基于用户角色的权限控制组件

## 实现方案

### 1. 创建权限控制工具函数

* 在 `utils/permissions.ts` 中实现角色检查逻辑

* 提供 `hasPermission` 等工具函数

### 2. 实现基础权限组件

* 创建 `RoleGuard` 组件，支持：

  * 单角色检查

  * 多角色检查（OR 关系）

  * 自定义未授权行为

### 3. 实现特定角色组件

* `ServiceDispatchOnly`: 仅允许 SERVICE\_DISPATCH 角色访问

* `FinanceOnly`: 仅允许财务相关角色访问

* `InstallerOnly`: 仅允许 SERVICE\_INSTALL 角色访问

* `MeasurerOnly`: 仅允许 SERVICE\_MEASURE 角色访问

* 其他常用角色的便捷组件

### 4. 实现权限检查 Hook

* 创建 `usePermissions` Hook

* 提供角色检查和权限验证功能

### 5. 更新现有使用示例

* 修改 `orders/status/[status]/page.tsx` 中的占位组件

* 确保使用新实现的权限组件

## 文件结构

```
src/
├── components/
│   └── client-components/
│       └── permissions/
│           ├── role-guard.tsx          # 基础权限组件
│           ├── service-dispatch-only.tsx  # 派单员权限组件
│           ├── finance-only.tsx        # 财务权限组件
│           ├── installer-only.tsx      # 安装师权限组件
│           ├── measurer-only.tsx       # 测量师权限组件
│           └── index.ts                # 组件导出
├── hooks/
│   └── use-permissions.ts              # 权限检查 Hook
└── utils/
    └── permissions.ts                  # 权限工具函数
```

## 实现细节

### 权限工具函数

* `hasPermission(user: User | null, roles: UserRole[]): boolean`

* 支持单角色和多角色检查

### RoleGuard 组件

```tsx
interface RoleGuardProps {
  roles: UserRole | UserRole[];
  children: React.ReactNode;
  fallback?: React.ReactNode;
}
```

### 特定角色组件

* 基于 RoleGuard 实现，如：

  ```tsx
  const ServiceDispatchOnly = ({ children, fallback }: PermissionComponentProps) => (
    <RoleGuard roles="SERVICE_DISPATCH" fallback={fallback}>
      {children}
    </RoleGuard>
  );
  ```

### usePermissions Hook

* 提供 `canAccess(roles: UserRole | UserRole[]): boolean` 方法

* 支持权限检查和条件渲染

## 预期效果

* 基于用户角色动态显示/隐藏内容

* 提供友好的未授权提示

* 组件化设计，易于使用和扩展

* 符合系统现有架构和命名规范

