# 待测量模块问题分析与改进方案

## 一、存在的问题

### 1. 状态流转问题
- **状态常量不一致**：前端代码中直接使用字符串 `measuring_pending_assignment`，而非定义的 `ORDER_STATUS.MEASURING_ASSIGNING` 常量
- **状态命名不统一**：前端状态与后端枚举可能存在命名差异，需要确认一致性

### 2. API调用问题
- **使用模拟数据**：没有实际调用API获取待测量订单列表
- **API路径不一致**：确认去测量时调用的是 `/api/orders/${currentOrder.id}/sync-lead`，而不是通过 `salesOrderService.updateSalesOrder` 方法
- **缺少错误处理**：API调用失败时仅使用 `.catch(() => {})` 忽略错误

### 3. 权限控制问题
- **权限检查逻辑简单**：仅检查角色是否在允许列表中，没有与后端权限系统集成
- **缺少细粒度权限**：没有针对不同操作的更细粒度权限控制

### 4. 时效控制问题
- **时效计算单一**：仅基于状态更新时间，没有考虑不同状态的不同时效要求
- **提醒机制简单**：仅显示警告图标，没有更主动的提醒方式

### 5. UI/UX问题
- **表格列数过多**：在小屏幕设备上显示不友好
- **缺少分页功能**：订单数量较多时页面加载慢
- **缺少搜索筛选**：不便于快速找到特定订单

### 6. 代码质量问题
- **注释掉的代码**：存在未使用的导入和注释代码
- **模拟数据与业务逻辑混合**：不便于维护
- **错误处理简单**：仅显示toast消息，缺少详细错误信息

### 7. 类型定义问题
- **status字段类型不匹配**：`PendingSurveyOrder`接口中`status`为字符串，未使用`OrderStatus`类型
- **UploadedFile缺少关键信息**：缺少文件类型、大小等字段

## 二、改进方案

### 1. 状态流转改进
- **使用常量代替硬编码**：统一使用 `ORDER_STATUS` 常量，确保前后端命名一致
- **添加状态流转验证**：在状态更新时验证流转是否合法

### 2. API调用改进
- **替换模拟数据**：使用 `useSalesOrders` hook 获取真实数据
- **统一API调用方式**：使用 `salesOrderService.updateSalesOrder` 方法更新订单状态
- **完善错误处理**：添加详细的错误信息和重试机制

### 3. 权限控制改进
- **与后端权限集成**：根据后端返回的权限信息控制操作
- **添加细粒度权限**：针对不同操作添加更细粒度的权限控制

### 4. 时效控制改进
- **添加多状态时效要求**：针对不同状态设置不同的时效要求
- **完善提醒机制**：添加邮件、短信等主动提醒方式

### 5. UI/UX改进
- **响应式设计**：优化表格在小屏幕设备上的显示
- **添加分页功能**：实现订单列表分页加载
- **添加搜索筛选**：支持按客户、地址、设计师等条件搜索

### 6. 代码质量改进
- **清理注释代码**：删除未使用的导入和注释代码
- **分离模拟数据**：将模拟数据移到单独的文件中
- **完善错误处理**：添加详细的错误信息和日志

### 7. 类型定义改进
- **统一状态类型**：将 `PendingSurveyOrder` 接口中的 `status` 字段类型改为 `OrderStatus`
- **完善文件类型定义**：为 `UploadedFile` 添加文件类型、大小等字段

## 三、实施计划

### 1. 立即修复的问题
- **使用常量代替硬编码**：修改 `pending-survey-view.tsx` 中的状态字符串为常量
- **清理注释代码**：删除未使用的导入和注释
- **完善类型定义**：更新 `PendingSurveyOrder` 和 `UploadedFile` 接口

### 2. 短期改进（1-2天）
- **替换模拟数据**：使用 `useSalesOrders` hook 获取真实数据
- **统一API调用方式**：使用 `salesOrderService.updateSalesOrder` 方法更新状态
- **添加分页功能**：实现订单列表分页加载

### 3. 中期改进（3-5天）
- **添加搜索筛选**：实现订单搜索和筛选功能
- **完善权限控制**：与后端权限系统集成
- **改进时效控制**：添加多状态时效要求和提醒机制

### 4. 长期改进（1-2周）
- **响应式设计优化**：优化表格在小屏幕设备上的显示
- **添加单元测试**：为关键功能添加单元测试
- **完善错误处理**：添加详细的错误信息和日志

通过以上改进，待测量模块将更加完善，符合26状态流程图的需求，同时提高代码质量和用户体验。