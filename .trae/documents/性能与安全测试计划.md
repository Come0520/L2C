# 性能与安全测试计划

## 1. Lighthouse性能评分测试

### 1.1 测试准备
- 确保项目依赖已安装：`npm install`
- 构建项目：`npm run build`

### 1.2 测试执行
- **自动化测试**：运行Lighthouse CI自动测试
  ```bash
  npm run lhci:autorun
  ```
- **手动测试**：针对特定页面进行测试
  ```bash
  npm run lhci:collect
  npm run lhci:assert
  ```

### 1.3 测试分析
- 检查`.lighthouseci`目录下的测试报告
- 分析性能指标：
  - 首次内容绘制(FCP)
  - 最大内容绘制(LCP)
  - 总阻塞时间(TBT)
  - 累积布局偏移(CLS)
  - 服务器响应时间(SRT)

### 1.4 性能优化（如有必要）
- 基于测试结果优化性能瓶颈
- 重点关注分数低于阈值的指标
- 重新运行测试验证优化效果

## 2. RLS安全策略全面测试

### 2.1 测试准备
- 启动本地Supabase服务：`npm run supabase:start`
- 重置数据库：`npm run supabase:reset`
- 生成类型：`npm run supabase:generate-types`

### 2.2 RLS策略检查
- 查看迁移文件中的RLS配置：
  ```bash
  cat supabase/migrations/*.sql | grep -i rls
  ```
- 检查主要表的RLS策略：
  - orders表
  - leads表  
  - users表
  - products表
  - quotes表

### 2.3 RLS功能测试
- **匿名访问测试**：验证未登录用户无法访问受保护资源
- **认证用户测试**：验证登录用户只能访问自己的数据
- **权限边界测试**：验证不同角色用户的访问权限差异
- **数据修改测试**：验证用户只能修改自己的数据

### 2.4 测试执行
- 使用Supabase Dashboard手动测试RLS策略
- 编写自动化测试脚本验证RLS功能
- 运行现有测试套件：`npm run test:ci`

## 3. 测试报告生成

### 3.1 性能测试报告
- 收集Lighthouse测试结果
- 分析性能评分和指标
- 生成性能优化建议

### 3.2 安全测试报告
- 记录RLS策略检查结果
- 汇总RLS功能测试结果
- 提出安全改进建议

## 4. 改进实施（如有必要）

### 4.1 性能改进
- 根据Lighthouse报告优化性能瓶颈
- 重点优化：
  - 图片加载
  - 代码分割
  - 缓存策略
  - 服务器响应时间

### 4.2 安全改进
- 修复RLS策略中的漏洞
- 完善角色权限配置
- 加强数据访问控制

## 5. 验证与交付

### 5.1 验证测试
- 重新运行Lighthouse测试验证性能改进
- 重新测试RLS策略验证安全改进
- 确保所有测试通过

### 5.2 交付成果
- 性能测试报告
- 安全测试报告
- 改进实施记录
- 最终测试结果

## 6. 持续监控建议

### 6.1 性能监控
- 集成Lighthouse CI到CI/CD流水线
- 定期运行性能测试
- 监控生产环境性能指标

### 6.2 安全监控
- 定期检查RLS策略
- 监控异常数据访问
- 及时更新安全策略

## 测试工具与依赖

- **Lighthouse CI**：用于性能测试
- **Supabase CLI**：用于本地开发和测试
- **Vitest**：用于单元和集成测试
- **TypeScript**：用于类型检查

## 测试标准

- 性能评分：≥85分
- 可访问性：≥90分
- 最佳实践：≥85分
- SEO：≥85分
- RLS策略：100%覆盖所有敏感数据

## 预期输出

- 完整的性能测试报告
- 详细的RLS安全测试报告
- 可执行的改进建议
- 验证通过的测试结果