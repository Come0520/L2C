# 报价单多版本设计方案实施计划

## 1. 文档修改范围

### 1.1 核心文档修改

| 文档路径 | 修改内容 |
|---------|---------|
| **报价管理模块设计.md** | 更新数据库设计、API接口、业务逻辑和前端设计，实现报价单与版本分离 |
| **数据库设计.md** | 添加报价单版本表设计，更新报价单表和销售单表关联关系 |
| **API接口设计.md** | 添加报价单版本相关的Server Actions和Route Handlers |

### 1.2 相关文档检查

- 检查状态流转规则设计.md，确保报价单版本状态流转符合规范
- 检查订单管理模块设计.md，确保从报价单版本生成销售单的流程正确

## 2. 具体修改内容

### 2.1 报价管理模块设计.md

#### 2.1.1 数据库设计更新
- 将原报价单表（quotes）拆分为报价单主表和报价单版本表
- 报价单主表（quotes）：包含客户、项目等基本信息
- 报价单版本表（quote_versions）：包含报价详情、金额、状态等
- 更新报价明细表（quote_items）关联到报价单版本表

#### 2.1.2 API接口设计更新
- 添加报价单版本管理接口：创建版本、获取版本列表、获取特定版本详情
- 添加版本状态流转接口：发布为初稿、客户确认、转换为销售单
- 更新报价单创建流程，支持同时创建报价单和初始版本

#### 2.1.3 核心业务逻辑更新
- 实现版本创建逻辑，支持从现有版本复制创建新版本
- 实现版本状态管理，确保只有最新版本可以编辑
- 实现从报价单版本生成销售单的逻辑
- 更新权限控制，确保版本操作符合权限要求

#### 2.1.4 前端设计更新
- 添加版本切换功能，支持查看不同版本的报价
- 添加版本对比功能，方便客户比较不同方案
- 更新报价详情页面，显示版本信息和状态
- 添加版本操作按钮，支持发布、确认等操作

### 2.2 数据库设计.md

#### 2.2.1 表结构更新
- 添加报价单版本表（quote_versions）设计
- 更新报价单表（quotes），移除版本相关字段，添加current_version字段
- 更新销售单表（sales_orders），添加quote_version_id外键
- 更新报价明细表（quote_items），关联到quote_versions表

#### 2.2.2 关系设计更新
- 客户（1）←→（N）报价单
- 报价单（1）←→（N）报价单版本
- 报价单版本（1）←→（1）销售单
- 报价单版本（1）←→（N）报价单明细

### 2.3 API接口设计.md

#### 2.3.1 Server Actions更新
- 添加`createQuoteVersion`：创建报价单版本
- 添加`publishQuoteVersion`：发布报价单版本为初稿
- 添加`confirmQuoteVersion`：客户确认报价单版本
- 添加`convertQuoteVersionToOrder`：将报价单版本转换为销售单

#### 2.3.2 Route Handlers更新
- 添加`GET /api/v1/quotes/:id/versions`：获取报价单所有版本
- 添加`GET /api/v1/quotes/:id/versions/:versionId`：获取特定版本详情
- 更新`POST /api/v1/orders`：支持从报价单版本创建订单

## 3. 实施步骤

1. **文档分析与规划**：完成当前文档分析，制定详细修改计划
2. **数据库设计更新**：修改数据库设计文档，定义新的表结构和关系
3. **模块设计更新**：修改报价管理模块设计，更新API和业务逻辑
4. **API设计更新**：修改API接口设计文档，添加版本管理相关接口
5. **相关文档检查**：检查并更新其他相关文档
6. **文档审查**：确保所有修改符合命名规范和架构要求

## 4. 关键设计要点

- **版本管理**：每个报价单可以有多个版本，版本号递增
- **状态流转**：草稿 → 初稿 → 已确认 → 已转换
- **数据一致性**：确保报价单版本与销售单的数据一致性
- **权限控制**：只有授权用户可以操作报价单版本
- **前端体验**：提供直观的版本切换和对比功能

## 5. 预期效果

- 实现报价单多版本管理，满足业务需求
- 保留所有报价版本的历史记录
- 支持客户从多个版本中选择一个成交
- 基于选中的版本生成销售单
- 提供良好的前端体验，支持版本切换和对比

## 6. 风险评估

- **数据迁移**：如果已有报价单数据，需要考虑数据迁移策略
- **API兼容性**：确保现有API的兼容性，避免影响现有功能
- **前端复杂度**：版本切换和对比功能可能增加前端复杂度
- **业务流程调整**：需要确保业务团队理解并接受新的流程

## 7. 验收标准

- 所有文档修改符合命名规范和架构要求
- 数据库设计支持报价单多版本管理
- API设计支持版本创建、发布、确认和转换
- 前端设计支持版本切换和对比
- 业务逻辑符合报价单多版本管理的需求

## 8. 后续工作

- 根据修改后的文档，进行代码实现
- 编写测试用例，确保功能正确性
- 进行用户培训，确保业务团队理解新流程
- 监控系统运行情况，及时调整优化

通过以上修改，我们将实现报价单多版本管理，满足业务需求，提高报价管理的灵活性和效率。