# 报价模块代码实现整改计划（基于 2026-01-16 审计）

## 整改目标
将报价模块完成度从 **45%** 提升至 **85%+**，修复 47 个差异点

## 整改周期
**总周期**: 6周 (2026-01-20 ~ 2026-03-02)

## 分阶段计划

### 第一阶段：P0核心功能修复 (Week 1-2)
**目标**: 修复阻塞核心业务的4个P0级差异

#### Week 1: 折扣风控体系 + Schema变更
- **Day 1-2**: 数据库Schema变更
  - 添加 `approvalRequired`, `approverId`, `approvedAt`, `rejectReason` 字段到 `quotes` 表
  - 创建折扣底线配置表
  - 编写migration脚本
- **Day 3-4**: 折扣风控业务逻辑
  - 实现折扣底线校验逻辑
  - 实现审批工作流（集成审批模块）
  - 实现审批API (`POST /api/v1/quotes/{id}/approve`, `/reject`)
- **Day 5**: 折扣风控UI
  - 创建审批Dialog组件
  - 在报价单详情页集成审批按钮

#### Week 2: 状态流转 + 测量导入 + 转订单
- **Day 1-2**: 状态流转API
  - 实现 `submitQuote` API
  - 实现 `acceptQuote` API  
  - 实现 `rejectQuote` API
  - 实现 `lockQuote` API
- **Day 3**: 测量数据导入
  - 设计Measure → Quote映射规则
  - 实现自动匹配逻辑
  - 实现手动关联UI
- **Day 4-5**: 报价单转订单
  - 设计快照机制
  - 实现 `convertToOrder` API
  - 实现转换后数据同步

### 第二阶段：P1重要功能完善 (Week 3-4)
**目标**: 修复影响用户体验的5个P1级差异

#### Week 3: 查询API + 房间管理
- **Day 1-2**: 查询API实现
  - 实现报价单列表查询（分页、筛选、搜索）
  - 实现报价单详情查询
  - 移除Mock代码，统一为真实实现
- **Day 3-4**: 房间管理API
  - 实现 `updateRoom` API
  - 实现 `deleteRoom` API
  - 修复TenantId硬编码问题
- **Day 5**: 版本历史查询
  - 实现 `GET /api/v1/quotes/{id}/versions` API
  - 创建版本历史时间轴组件

#### Week 4: 报价模式配置 + 前端实时计算
- **Day 1-2**: 报价模式配置系统
  - 实现租户级配置API
  - 实现用户级配置API
  - 实现三级优先级加载逻辑
- **Day 3**: 配置UI
  - 创建系统设置 > 报价设置页面
  - 实现字段勾选配置界面
  - 实现实时预览功能
- **Day 4-5**: 前端实时计算
  - 实现前端计算引擎（共享后端逻辑）
  - 实现实时价格反馈
  - 实现前后端一致性校验

### 第三阶段：P2优化 + 测试 (Week 5-6)
**目标**: 修复次要功能差异，完成测试覆盖

#### Week 5: UI/UX完善
- **Day 1-2**: UI组件完善
  - 实现嵌套附件UI（缩进展示）
  - 实现商品型号智能联想
  - 实现褶皱倍数步进器
- **Day 3**: 技术债务清理
  - 统一字段单位（width/height为cm）
  - 移除quotePlans表或补充需求文档
  - 清理重复代码
- **Day 4-5**: 测量集成增强
  - 实现从报价单创建测量任务
  - 实现拆单方案推荐
  - 实现三种测量场景支持

#### Week 6: 测试与上线准备
- **Day 1-2**: 单元测试
  - 补充Service层单元测试
  - 补充计算引擎测试
  - 目标覆盖率≥70%
- **Day 3-4**: E2E测试
  - 编写报价单完整流程测试
  - 编写审批流程测试
  - 编写转订单流程测试
- **Day 5**: 性能优化与文档
  - 性能优化（查询索引、缓存）
  - 编写使用手册
  - 准备上线检查清单

## 资源需求
- **后端开发**: 1人全职 (21天工作量)
- **前端开发**: 1人全职 (14天工作量)
- **QA测试**: 1人兼职 (5天工作量)
- **总计**: 40人日 (2人并行6周完成)

## 验收标准
**功能**:
- ✅ 折扣风控体系100%可用
- ✅ 状态流转API全部实现
- ✅ 测量数据导入端到端可执行
- ✅ 报价单转订单功能完整
- ✅ 报价模式配置系统可用

**性能**:
- ✅ 报价单列表加载 <2s (1000+记录)
- ✅ 前端实时计算 <100ms
- ✅ 转订单响应 <3s

**质量**:
- ✅ 单元测试覆盖率≥70%
- ✅ E2E测试覆盖核心Flow
- ✅ 无P0/P1 Bug

## 关键风险与应对
| 风险 | 等级 | 缓解措施 |
|---|---|---|
| 审批流程未完成 | 🔴 高 | 简化为店长直接审批 |
| 计算引擎前后端不一致 | 🔴 高 | 共享计算逻辑代码 |
| 测量模块未完成 | 🟡 中 | Mock测量数据导入 |
| 折扣风控规则复杂 | 🟡 中 | 先实现简单版本，后续迭代