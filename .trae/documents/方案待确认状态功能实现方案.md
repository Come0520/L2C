# 方案待确认状态功能实现方案

## 1. 功能需求与实现逻辑概述

### 1.1 功能定位

"方案待确认"状态是L2C流程中连接报价生成与订单推送的关键节点，主要用于管理客户确认前的报价单，支持版本管理、真实尺寸参考、客户确认凭证上传等核心功能。

### 1.2 技术架构

* **前端**：Next.js 14+ + TypeScript + React Hooks

* **后端**：NestJS + TypeORM + PostgreSQL

* **状态管理**：React Context + useState/useEffect

* **UI组件**：Paper UI组件库

## 2. 核心模块详细设计

### 2.1 报价单清单列表功能

#### 功能需求

* 展示所有处于"方案待确认"状态的报价单

* 每个报价单条目包含：报价单号、客户信息、创建日期、版本号、"真实报价"按钮、"上传"按钮和"确认"按钮

* 实现报价单版本管理系统，采用"日期+版本号"的编号规则

#### 实现逻辑

1. **页面组件**：创建`PlanPendingConfirmationView`组件，位于`src/components/orders/`目录下
2. **数据获取**：通过API获取所有`status: 'plan-pending-confirmation'`的报价单
3. **版本编号规则**：

   ```typescript
   // 生成报价单版本号
   const generateVersionNumber = (baseCode: string, date: Date, version: number) => {
     const formattedDate = date.toISOString().slice(0, 10).replace(/-/g, '');
     return `${baseCode}-${formattedDate}-V${version.toFixed(1)}`;
   };
   ```
4. **列表渲染**：使用`PaperTable`组件渲染报价单列表，每个条目包含所需字段和操作按钮

#### 界面原型

```
┌───────────────────────────────────────────────────────────────────────────────┐
│ 方案待确认 - 报价单清单                                                      │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────────────┤
│ 报价单号    │ 客户        │ 创建日期    │ 版本号      │ 操作                │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────────────────┤
│ BJ报价-20241126-V1.0 │ 张三        │ 2024-11-26  │ V1.0        │ 真实报价 | 上传 | 确认 │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────────────┘
```

### 2.2 真实报价弹窗功能

#### 功能需求

* 点击"真实报价"按钮打开弹窗，展示原始报价单内容

* 在每个可修改的尺寸文本框下方，以不可编辑方式展示师傅测量的真实车辆尺寸数据

* 真实尺寸数据仅用于参考，用户无法直接修改

#### 实现逻辑

1. **弹窗组件**：创建`RealQuoteDialog`组件，位于`src/components/orders/`目录下
2. **数据结构**：

   ```typescript
   interface QuoteItem {
     id: string;
     productName: string;
     size: string;
     realSize: string; // 师傅测量的真实尺寸
     // 其他属性...
   }
   ```
3. **交互逻辑**：

   * 点击"真实报价"按钮，传递当前报价单ID给弹窗

   * 弹窗加载报价单数据和对应的真实尺寸数据

   * 渲染报价单内容，在可修改尺寸的文本框下方展示真实尺寸

   * 使用`disabled`属性确保真实尺寸数据不可编辑

#### 界面原型

```
┌───────────────────────────────────────────────────────────────────────────────┐
│ 真实报价 - BJ报价-20241126-V1.0                                             │
├───────────────────────────────────────────────────────────────────────────────┤
│ 产品名称：窗帘                                                               │
│ 尺寸：[500cm]  // 可编辑文本框                                               │
│ 真实尺寸：520cm  // 不可编辑，仅参考                                         │
│                                                                               │
│ 产品名称：墙布                                                               │
│ 尺寸：[1000cm²]  // 可编辑文本框                                             │
│ 真实尺寸：1050cm²  // 不可编辑，仅参考                                       │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 报价单版本管理功能

#### 功能需求

* 支持"再生成一版"功能，创建新版本报价单

* 新版本默认继承上一版本的结构和数据

* 支持查看历史版本记录和版本对比

#### 实现逻辑

1. **数据模型扩展**：

   ```typescript
   // 扩展报价单实体，添加版本相关字段
   interface Quote {
     id: string;
     quoteNo: string;
     version: string;
     baseQuoteId: string | null; // 父版本ID
     // 其他属性...
   }
   ```
2. **版本生成机制**：

   ```typescript
   // 生成新版本报价单
   const generateNewVersion = async (quoteId: string) => {
     const currentQuote = await getQuoteById(quoteId);
     const newVersion = parseFloat(currentQuote.version) + 0.1;
     const newQuote = {
       ...currentQuote,
       id: generateId(),
       version: newVersion.toFixed(1),
       quoteNo: generateVersionNumber(baseCode, new Date(), newVersion),
       baseQuoteId: currentQuote.id,
       isDraft: true
     };
     return saveQuote(newQuote);
   };
   ```
3. **版本历史查看**：

   * 创建`QuoteVersionHistory`组件，展示所有版本记录

   * 支持版本对比功能，高亮显示差异

### 2.4 报价单操作功能

#### 功能需求

* 支持临时保存和正式保存两种模式

* 支持PDF和Excel格式的下载功能

* 确认前标记为"非正式报价单"

#### 实现逻辑

1. **保存功能**：

   * 临时保存：保存到本地存储或数据库草稿表

   * 正式保存：更新数据库中的报价单记录，标记为"正式版本"
2. **下载功能**：

   * 使用第三方库（如`react-pdf`、`xlsx`）生成PDF和Excel文件

   * 实现下载按钮，触发文件生成和下载
3. **非正式标记**：

   * 在报价单数据模型中添加`isFormal`字段

   * 确认前`isFormal`为`false`，确认后为`true`

   * 在UI中显示"非正式报价单"标记

### 2.5 客户确认凭证上传功能

#### 功能需求

* 支持上传客户确认凭证

* 支持多种文件类型

* 实现文件上传验证机制

#### 实现逻辑

1. **文件上传组件**：使用`PaperFileUpload`组件，支持多种文件类型
2. **验证机制**：

   ```typescript
   const validateFile = (file: File) => {
     const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf', 'text/plain'];
     const maxSize = 10 * 1024 * 1024; // 10MB
     
     if (!allowedTypes.includes(file.type)) {
       return '不支持的文件类型';
     }
     if (file.size > maxSize) {
       return '文件大小不能超过10MB';
     }
     return null;
   };
   ```
3. **文件存储**：

   * 上传到云存储服务（如AWS S3、阿里云OSS）

   * 将文件URL保存到数据库

### 2.6 确认按钮状态控制逻辑

#### 功能需求

* 未上传确认凭证时按钮禁用

* 禁用状态有明确视觉提示

* 鼠标悬停时显示提示信息

#### 实现逻辑

1. **状态控制**：

   ```typescript
   // 确认按钮状态
   const isConfirmDisabled = !uploadedFiles.length;
   ```
2. **视觉提示**：

   * 使用`disabled`属性禁用按钮

   * 添加`opacity: 0.6`样式

   * 添加悬停提示：

     ```typescript
     <PaperButton 
       disabled={isConfirmDisabled}
       tooltip={isConfirmDisabled ? "请先上传客户确认凭证" : undefined}
     >
       确认
     </PaperButton>
     ```

### 2.7 状态转换规则

#### 功能需求

* 点击"确认"按钮后，将状态从"方案待确认"转换为"待推单"

* 记录操作日志

#### 实现逻辑

1. **状态转换**：

   ```typescript
   // 确认报价单
   const confirmQuote = async (quoteId: string) => {
     // 更新报价单状态
     await updateQuoteStatus(quoteId, 'pending-push');
     
     // 记录操作日志
     await createOperationLog({
       quoteId,
       operation: 'confirm',
       operatorId: currentUser.id,
       timestamp: new Date(),
       version: currentQuote.version
     });
     
     // 刷新列表
     refreshQuoteList();
   };
   ```
2. **日志记录**：

   * 创建`OperationLog`实体，记录操作信息

   * 包含字段：操作类型、操作人、操作时间、版本信息等

### 2.8 界面交互与用户体验优化

#### 功能需求

* 明确的视觉反馈

* 表单验证

* 操作成功/失败提示

#### 实现逻辑

1. **视觉反馈**：

   * 按钮点击效果

   * 加载状态指示器

   * 操作结果提示
2. **表单验证**：

   * 使用`react-hook-form`和`zod`实现表单验证

   * 实时显示验证错误信息
3. **操作提示**：

   * 使用`PaperToast`组件显示操作结果

   * 成功提示：绿色背景，成功图标

   * 失败提示：红色背景，错误图标

## 2. 技术实现细节

### 2.1 前端实现

#### 页面结构

```
├── src/
│   ├── app/
│   │   └── orders/
│   │       └── status/
│   │           └── plan-pending-confirmation/
│   │               └── page.tsx          # 方案待确认页面
│   ├── components/
│   │   └── orders/
│   │       ├── plan-pending-confirmation-view.tsx  # 方案待确认视图
│   │       ├── real-quote-dialog.tsx     # 真实报价弹窗
│   │       ├── quote-version-history.tsx # 报价版本历史
│   │       └── quote-upload-component.ts # 报价上传组件
│   ├── types/
│   │   └── order.ts                      # 订单类型定义
│   └── services/
│       └── quote.service.ts              # 报价单服务
```

#### 核心API调用

```typescript
// 获取方案待确认的报价单列表
const getPendingConfirmationQuotes = async (filters?: QuoteFilters) => {
  const response = await fetch(`/api/quotes?status=plan-pending-confirmation&${stringify(filters)}`);
  return response.json();
};

// 生成新报价单版本
const generateNewQuoteVersion = async (quoteId: string) => {
  const response = await fetch(`/api/quotes/${quoteId}/versions`, { method: 'POST' });
  return response.json();
};

// 上传客户确认凭证
const uploadConfirmationDocument = async (quoteId: string, files: File[]) => {
  const formData = new FormData();
  files.forEach(file => formData.append('files', file));
  const response = await fetch(`/api/quotes/${quoteId}/documents`, { 
    method: 'POST',
    body: formData
  });
  return response.json();
};

// 确认报价单
const confirmQuote = async (quoteId: string) => {
  const response = await fetch(`/api/quotes/${quoteId}/confirm`, { method: 'POST' });
  return response.json();
};
```

### 2.2 后端实现

#### 数据模型扩展

```typescript
// 报价单实体扩展
@Entity('quotes')
export class Quote {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  quoteNo: string;

  @Column()
  version: string;

  @Column({ nullable: true })
  baseQuoteId: string;

  @Column()
  status: string;

  @Column()
  isFormal: boolean;

  @Column({ nullable: true })
  confirmationDocumentUrl: string;

  // 其他字段...
}

// 操作日志实体
@Entity('operation_logs')
export class OperationLog {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  quoteId: string;

  @Column()
  operation: string;

  @Column()
  operatorId: string;

  @Column()
  timestamp: Date;

  @Column()
  version: string;

  // 其他字段...
}
```

#### API端点设计

```
// 获取方案待确认的报价单列表
GET /api/quotes?status=plan-pending-confirmation

// 生成新报价单版本
POST /api/quotes/:id/versions

// 上传客户确认凭证
POST /api/quotes/:id/documents

// 确认报价单
POST /api/quotes/:id/confirm

// 获取报价单版本历史
GET /api/quotes/:id/versions

// 下载报价单
GET /api/quotes/:id/download?format=pdf|excel
```

## 3. 实现优先级与依赖关系

### 3.1 实现优先级

1. 报价单清单列表功能（核心功能）
2. 报价单操作功能（基础功能）
3. 真实报价弹窗功能（关键功能）
4. 报价单版本管理功能（重要功能）
5. 客户确认凭证上传功能（必要功能）
6. 确认按钮状态控制逻辑（交互功能）
7. 状态转换规则（流程功能）
8. 界面交互与用户体验优化（优化功能）

### 3.2 依赖关系

* 真实报价弹窗功能依赖于报价单清单列表功能

* 报价单版本管理功能依赖于报价单数据模型扩展

* 客户确认凭证上传功能依赖于文件存储服务

* 确认按钮状态控制逻辑依赖于客户确认凭证上传功能

* 状态转换规则依赖于报价单操作功能

## 4. 测试计划

### 4.1 单元测试

* 测试报价单版本生成逻辑

* 测试真实尺寸数据展示逻辑

* 测试状态转换规则

* 测试文件上传验证机制

### 4.2 集成测试

* 测试报价单清单列表与后端API的集成

* 测试真实报价弹窗与报价单数据的集成

* 测试版本管理功能与数据库的集成

### 4.3 端到端测试

* 测试完整的报价单确认流程

* 测试版本生成和管理流程

* 测试文件上传和确认流程

## 5. 预期效果与成功指标

### 5.1 预期效果

* 实现完整的"方案待确认"状态管理功能

* 支持报价单版本管理和真实尺寸参考

* 提供便捷的客户确认凭证上传功能

* 实现流畅的状态转换和操作日志记录

* 提供良好的用户体验和视觉反馈

### 5.2 成功指标

* 功能覆盖率：100%覆盖需求文档中的所有功能

* 代码质量：通过所有单元测试和集成测试

* 用户体验：操作流畅，反馈及时

* 性能：页面加载时间<2秒，操作响应时间<500ms

## 6. 风险评估与应对策略

### 6.1 风险评估

1. **技术风险**：第三方库兼容性问题
2. **数据风险**：版本数据不一致
3. **用户体验风险**：操作流程复杂

### 6.2 应对策略

1. **技术风险**：

   * 选择成熟稳定的第三方库

   * 进行充分的兼容性测试

   * 准备备选方案
2. **数据风险**：

   * 实现数据一致性检查机制

   * 定期备份数据

   * 实现数据恢复功能
3. **用户体验风险**：

   * 简化操作流程

   * 提供清晰的操作指引

   * 进行用户测试，收集反馈并优化

## 7. 后续优化方向

1. **AI辅助报价**：集成AI算法，根据历史数据和真实尺寸自动生成优化报价
2. **电子签名**：支持客户在线电子签名确认
3. **移动端适配**：优化移动端体验，支持移动端操作
4. **批量操作**：支持批量确认、批量下载等功能
5. **数据分析**：添加报价单数据分析功能，提供决策支持

# 总结

本方案详细规划了"方案待确认"状态的功能需求与实现逻辑，涵盖了8个核心模块。方案基于现有系统架构，扩展了报价单数据模型，实现了版本管理、真实尺寸参考、客户确认凭证上传等关键功能。通过清晰的界面设计和流畅的交互体验，提高了销售人员的工作效率，确保了报价单流程的规范性和可追溯性。

方案采用了模块化设计，便于后续扩展和维护。同时，考虑了风险评估和应对策略，确保系统的稳定性和可靠性。后续可以根据实际使用情况，进一步优化功能和用户体验。
