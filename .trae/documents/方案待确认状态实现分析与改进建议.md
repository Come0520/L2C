# 方案待确认状态实现分析与改进建议

## 一、当前实现情况分析

### 1. 文档定义
- ✅ 状态名称：方案待确认
- ✅ 状态标识：ORDER_STATUS.PLAN_PENDING_CONFIRMATION
- ✅ 状态描述：测量结果已确认，等待客户确认设计方案
- ✅ 触发条件：销售人员确认测量结果后
- ✅ 流转规则：
  - 正向：方案待确认 → 待推单
  - 反向：方案待确认 → 测量中-待确认
  - 异常：方案待确认 → 已取消
- ✅ 操作内容：查看/确认/驳回设计方案、修改设计方案、取消订单
- ✅ 时效要求：72小时内完成确认，48小时提醒
- ✅ 权限控制：客户、销售人员、销售负责人等角色的权限定义

### 2. 前端实现
- ✅ 订单状态常量中包含 PLAN_PENDING_CONFIRMATION
- ✅ 线索状态配置中完整定义了该状态的可见角色和操作权限
- ✅ 线索类型定义中包含 PLAN_PENDING_CONFIRMATION 状态
- ✅ 时效控制配置中设置了72小时的时效要求
- ✅ 操作权限配置了确认方案、驳回方案、更新方案等操作
- ✅ 可见角色包括销售人员、销售负责人、设计师、客户等

### 3. 待确认事项
- ❓ 数据库中是否明确包含该状态的字段定义
- ❓ 后端API是否支持该状态的完整流转
- ❓ 小程序端是否已实现客户确认功能

## 二、改进建议

### 1. 前端改进
- ✅ 确保所有相关组件都能正确处理 PLAN_PENDING_CONFIRMATION 状态
- ✅ 实现方案待确认状态的列表筛选和统计功能
- ✅ 完善时效提醒机制，确保超时自动预警
- ✅ 实现方案确认和驳回的完整流程

### 2. 后端改进
- ✅ 确保数据库表中包含 status 字段，支持 PLAN_PENDING_CONFIRMATION 值
- ✅ 实现状态流转的API接口，包括确认、驳回、更新等操作
- ✅ 实现时效控制的后端逻辑，支持自动提醒和超时处理
- ✅ 完善权限验证，确保不同角色只能执行允许的操作

### 3. 小程序端改进
- ✅ 实现客户查看设计方案的功能
- ✅ 实现客户确认设计方案并签字的功能
- ✅ 实现客户驳回设计方案并填写原因的功能
- ✅ 实现方案待确认状态的通知提醒

## 三、验证步骤

1. **状态流转验证**：
   - 从测量中-待确认状态流转到方案待确认
   - 从方案待确认流转到待推单
   - 从方案待确认流转回测量中-待确认
   - 从方案待确认流转到已取消

2. **权限验证**：
   - 客户只能执行确认/驳回操作
   - 销售人员可以执行确认/驳回/取消操作
   - 销售负责人只能查看状态

3. **时效验证**：
   - 48小时时触发提醒
   - 72小时超时后触发预警

4. **附件验证**：
   - 确认时必须上传设计方案
   - 驳回时必须填写驳回原因

## 四、结论

前端部分已经基本实现了"方案待确认"状态的定义、配置和权限控制，但需要进一步确认后端和数据库的实现情况，并完善小程序端的客户确认功能。建议按照上述改进建议进行完善，确保完整实现文档中定义的所有功能和规则。