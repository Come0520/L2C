# 方案待确认状态实现问题修复计划

## 一、当前实现存在的问题

### 1. 统计卡片准确性问题
- **问题**：使用服务端数据时，`filtered` 变量仅包含当前页数据，导致统计卡片显示的数量不准确
- **影响**：无法反映所有符合条件的线索数量，统计功能失去意义

### 2. 操作逻辑问题
- **问题**：方案确认和驳回操作直接调用 API，缺少确认对话框和错误处理
- **影响**：用户可能误操作，且操作失败时没有反馈

### 3. 权限控制问题
- **问题**：没有检查当前用户是否有执行方案确认、驳回等操作的权限
- **影响**：可能导致权限越权操作

### 4. 时效提醒机制问题
- **问题**：虽然配置了时效要求，但没有实际的提醒逻辑实现
- **影响**：无法及时提醒用户处理超时任务

### 5. 状态流转问题
- **问题**：方案确认后直接流转到待推单，可能缺少必要的验证或条件检查
- **影响**：可能导致状态流转不符合业务规则

### 6. 测试数据问题
- **问题**：模拟数据中缺少方案待确认状态的线索
- **影响**：功能测试不充分，无法验证实际效果

## 二、修复计划

### 1. 修复统计卡片准确性
- **修改文件**：`/src/app/leads/page.tsx`
- **修复方案**：
  - 添加专门的统计 API 调用，获取所有状态的数量统计
  - 或者在前端维护完整的线索数据用于统计

### 2. 完善操作逻辑
- **修改文件**：`/src/app/leads/page.tsx`
- **修复方案**：
  - 添加操作确认对话框
  - 添加操作结果反馈（成功/失败提示）
  - 实现乐观更新，提升用户体验

### 3. 添加权限控制
- **修改文件**：`/src/components/client-components/leads/lead-action-buttons.tsx`
- **修复方案**：
  - 确保权限检查逻辑正确执行
  - 只有拥有权限的用户才能看到对应的操作按钮

### 4. 实现时效提醒逻辑
- **修改文件**：
  - `/src/services/notifications.ts`
  - `/src/components/client-components/leads/lead-status-badge.tsx`
- **修复方案**：
  - 添加定时检查逻辑，检测超时任务
  - 在状态徽章上显示超时标记
  - 实现通知推送功能

### 5. 完善状态流转逻辑
- **修改文件**：`/src/app/leads/page.tsx`
- **修复方案**：
  - 添加状态流转前的验证逻辑
  - 确保符合业务规则后再执行状态更新

### 6. 添加测试数据
- **修改文件**：`/src/app/leads/page.tsx`
- **修复方案**：
  - 在模拟数据中添加方案待确认状态的线索
  - 确保测试数据覆盖所有状态

## 三、修复优先级

1. **高优先级**：操作逻辑问题、权限控制问题
2. **中优先级**：统计卡片准确性问题、状态流转问题
3. **低优先级**：时效提醒机制问题、测试数据问题

## 四、修复后的预期效果

- 统计卡片显示准确的各状态数量
- 操作前有确认提示，操作后有结果反馈
- 权限控制有效，避免越权操作
- 状态流转符合业务规则
- 测试数据完整，便于功能验证

通过以上修复，确保方案待确认状态的实现完整、准确、安全，符合业务需求和用户体验要求。