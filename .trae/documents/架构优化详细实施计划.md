# 架构优化详细实施计划

## 1. 中间件逻辑统一 - 责任链模式重构

### 目标
将当前简单的中间件重构为责任链模式，提高可扩展性和可维护性

### 实施步骤
1. **创建中间件基础架构**
   - 定义中间件接口 `Middleware`
   - 实现责任链管理器 `MiddlewareChain`
   - 创建基础中间件类 `BaseMiddleware`

2. **重构现有中间件逻辑**
   - 将安全头处理逻辑迁移到独立的 `SecurityHeadersMiddleware`
   - 添加 CORS 中间件 `CorsMiddleware`
   - 添加请求日志中间件 `RequestLoggingMiddleware`

3. **配置中间件链**
   - 在 `middleware.ts` 中使用责任链模式组合所有中间件
   - 支持条件执行和优先级配置

### 技术方案
```typescript
// 中间件接口
export interface Middleware {
  execute(request: NextRequest, response: NextResponse, next: () => void): Promise<void>;
}

// 责任链管理器
export class MiddlewareChain {
  private middlewares: Middleware[] = [];

  add(middleware: Middleware): this {
    this.middlewares.push(middleware);
    return this;
  }

  async execute(request: NextRequest, response: NextResponse): Promise<NextResponse> {
    let currentIndex = 0;

    const next = async () => {
      if (currentIndex < this.middlewares.length) {
        const middleware = this.middlewares[currentIndex++];
        await middleware.execute(request, response, next);
      }
    };

    await next();
    return response;
  }
}
```

## 2. Supabase 类型生成集成

### 目标
实现 Supabase 数据库类型自动生成，消除服务层 `any` 类型

### 实施步骤
1. **配置类型生成脚本**
   - 检查并更新 `package.json` 中的类型生成脚本
   - 确保脚本使用最新的 Supabase CLI 版本

2. **生成并导入类型**
   - 运行类型生成命令生成 `supabase.ts` 类型文件
   - 在所有 Supabase 查询中使用生成的类型
   - 替换 `from('*')` 为强类型返回值

3. **优化类型使用**
   - 在服务层函数中使用泛型约束
   - 为复杂查询创建自定义类型
   - 确保所有查询结果都有明确的类型定义

### 技术方案
```json
// package.json 脚本配置
"scripts": {
  "update-types": "npx supabase gen types typescript --project-id $SUPABASE_PROJECT_ID --schema public > src/types/supabase.ts"
}
```

```typescript
// 类型使用示例
import { Database } from '@/types/supabase';

type Lead = Database['public']['Tables']['leads']['Row'];

export async function getLeads(): Promise<Lead[]> {
  const supabase = createClient();
  const { data, error } = await supabase.from('leads').select('*');
  if (error) throw error;
  return data;
}
```

## 3. 统一错误处理

### 目标
实现 `withErrorHandler` 包装器，统一处理 Supabase 错误

### 实施步骤
1. **增强错误处理工具**
   - 扩展现有的 `error-handler.ts`
   - 实现 `withErrorHandler` 高阶函数
   - 支持不同类型的错误包装策略

2. **包装所有 Supabase 查询**
   - 在服务层函数中使用 `withErrorHandler` 包装 Supabase 调用
   - 确保所有错误都被正确捕获和格式化
   - 统一错误响应格式

3. **添加错误日志**
   - 集成日志系统记录所有错误
   - 支持不同环境的错误日志级别
   - 为生产环境添加错误监控

### 技术方案
```typescript
// withErrorHandler 实现
export function withErrorHandler<T>(
  fn: () => Promise<T>,
  options?: ErrorHandlerOptions
): Promise<T> {
  return fn().catch((error) => {
    if (error instanceof PostgrestError) {
      handleSupabaseError(error);
    }
    // 其他错误处理逻辑
    throw error;
  });
}

// 使用示例
export async function getLeadById(id: string): Promise<Lead> {
  return withErrorHandler(async () => {
    const supabase = createClient();
    const { data, error } = await supabase.from('leads').select('*').eq('id', id).single();
    if (error) throw error;
    return data;
  });
}
```

## 4. 通用字段映射层

### 目标
抽象 `toDbFields`/`fromDbFields` 工具，统一处理前后端字段映射

### 实施步骤
1. **创建字段映射工具**
   - 实现通用的 `toDbFields` 函数，将前端对象转换为数据库字段格式
   - 实现通用的 `fromDbFields` 函数，将数据库结果转换为前端对象格式
   - 支持嵌套对象和数组的映射

2. **配置字段映射规则**
   - 为每个实体创建映射配置
   - 支持自定义映射规则
   - 支持字段重命名、类型转换等

3. **在服务层使用映射工具**
   - 在查询结果处理中使用 `fromDbFields`
   - 在数据提交前使用 `toDbFields`
   - 确保所有数据转换都通过统一的映射层

### 技术方案
```typescript
// 字段映射工具
export interface FieldMapping {
  [frontendField: string]: string | FieldMapping;
}

export function toDbFields<T extends Record<string, any>>(data: T, mapping: FieldMapping): any {
  // 实现字段映射逻辑
  // 将 camelCase 转换为 snake_case
  // 处理嵌套对象
  // 应用自定义映射规则
}

export function fromDbFields<T extends Record<string, any>>(data: any, mapping: FieldMapping): T {
  // 实现反向映射逻辑
  // 将 snake_case 转换为 camelCase
  // 处理嵌套对象
  // 应用自定义映射规则
}

// 使用示例
const leadMapping = {
  createdAt: 'created_at',
  updatedAt: 'updated_at',
  customerId: 'customer_id',
  // 嵌套对象映射
  customer: {
    fullName: 'full_name'
  }
};

export async function createLead(leadData: LeadInput): Promise<Lead> {
  const dbData = toDbFields(leadData, leadMapping);
  const supabase = createClient();
  const { data, error } = await supabase.from('leads').insert([dbData]).select('*').single();
  if (error) throw error;
  return fromDbFields(data, leadMapping);
}
```

## 实施顺序与依赖关系

1. **第一步：Supabase 类型生成集成**（优先级最高）
   - 为其他优化提供类型基础
   - 减少服务层 `any` 类型

2. **第二步：统一错误处理**
   - 基于类型系统实现更精确的错误处理
   - 为服务层提供统一的错误包装

3. **第三步：通用字段映射层**
   - 基于类型系统实现类型安全的字段映射
   - 依赖于 Supabase 生成的类型

4. **第四步：中间件逻辑统一**
   - 相对独立的优化
   - 可以并行或最后实施

## 验收标准

1. **中间件逻辑清晰可测**
   - 中间件采用责任链模式组织
   - 每个中间件职责单一，可独立测试
   - 支持动态配置和扩展

2. **服务层零 `any`**
   - 所有 Supabase 查询结果都有明确的类型
   - 服务层函数参数和返回值都有类型定义
   - TypeScript 编译无 `any` 类型警告

3. **错误提示一致**
   - 所有错误都通过统一的错误处理机制
   - 错误响应格式统一
   - 包含明确的错误代码和消息

4. **字段映射自动化**
   - 前后端字段转换通过统一的映射工具
   - 支持复杂对象和嵌套结构
   - 减少手动字段转换代码

## 技术栈与工具

- **中间件**：Next.js Middleware + 责任链模式
- **类型生成**：Supabase CLI
- **错误处理**：自定义错误类 + 高阶函数
- **字段映射**：自定义工具函数
- **测试**：Vitest + React Testing Library
- **日志**：Pino 或其他日志库

## 代码结构调整

```
src/
├── middleware/           # 中间件目录
│   ├── base.ts           # 中间件基础类
│   ├── chain.ts          # 责任链管理器
│   ├── security.ts       # 安全头中间件
│   ├── cors.ts           # CORS中间件
│   └── logging.ts        # 日志中间件
├── lib/
│   ├── api/
│   │   ├── error-handler.ts    # 错误处理工具
│   │   └── field-mapper.ts     # 字段映射工具
│   └── supabase/
│       ├── server.ts           # 服务端客户端
│       └── client.ts           # 客户端客户端
├── types/
│   └── supabase.ts             # 自动生成的Supabase类型
└── middleware.ts               # 主中间件入口
```

## 风险与应对措施

1. **类型生成失败**
   - 风险：Supabase CLI 版本不兼容或网络问题
   - 应对：添加类型生成失败的错误处理和重试机制

2. **中间件性能影响**
   - 风险：责任链模式可能增加请求延迟
   - 应对：实现中间件的条件执行和异步处理，避免不必要的计算

3. **字段映射复杂性**
   - 风险：复杂对象映射可能引入新的错误
   - 应对：添加映射规则验证和测试，确保映射的正确性

4. **错误处理过度包装**
   - 风险：过度包装可能隐藏原始错误信息
   - 应对：在开发环境保留完整的错误堆栈，在生产环境只返回必要信息

## 测试计划

1. **中间件测试**
   - 单元测试：测试每个中间件的独立功能
   - 集成测试：测试中间件链的执行顺序和组合效果

2. **类型安全测试**
   - 编译时测试：确保 TypeScript 编译无错误
   - 运行时测试：验证类型转换的正确性

3. **错误处理测试**
   - 测试各种错误场景下的错误响应
   - 验证错误日志的完整性

4. **字段映射测试**
   - 测试简单对象的映射
   - 测试复杂嵌套对象的映射
   - 测试数组和特殊类型的映射

## 文档更新

1. **更新架构文档**
   - 记录中间件责任链模式
   - 描述 Supabase 类型生成流程
   - 说明错误处理机制
   - 文档字段映射工具的使用

2. **更新开发文档**
   - 添加类型生成命令的使用说明
   - 提供中间件开发指南
   - 说明错误处理最佳实践
   - 提供字段映射配置示例

3. **更新测试文档**
   - 添加中间件测试指南
   - 说明类型安全测试方法
   - 提供错误处理测试用例

## 预期收益

1. **提高代码质量**
   - 消除 `any` 类型，提高类型安全性
   - 统一的错误处理，提高代码可靠性
   - 自动化的字段映射，减少手动错误

2. **提高开发效率**
   - 类型生成减少手动类型定义
   - 中间件责任链模式提高可扩展性
   - 统一的工具函数减少重复代码

3. **提高可维护性**
   - 清晰的中间件结构，便于维护和扩展
   - 统一的错误处理，便于调试和监控
   - 自动化的字段映射，便于数据库 schema 变更

4. **提高系统可靠性**
   - 统一的错误处理，减少未捕获的错误
   - 类型安全，减少运行时错误
   - 中间件责任链，提高系统的可扩展性和容错性