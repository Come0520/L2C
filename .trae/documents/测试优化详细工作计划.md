# 测试优化详细工作计划

## 1. 修复服务测试失败

### 1.1 修复products-service.test.ts

**问题分析**：
- 测试文件内部有自己的mock实现
- mockQuery对象缺少部分方法
- 断言与实际返回数据结构不匹配

**解决方案**：
```typescript
// 优化测试文件内部的mock实现
i. 更新mockQuery对象，确保包含所有必要的方法
ii. 在每个测试用例前配置mock返回值
iii. 修复断言，确保与实际返回数据结构匹配
iv. 使用vitest.setup.ts中的全局mock配置，减少重复代码
```

### 1.2 修复quotes-client.test.ts

**问题分析**：
- mock导入路径与实际导入路径不匹配
- 服务文件导入的是`@/lib/supabase/client`
- 测试文件mock的是`../../lib/supabase/client`

**解决方案**：
```typescript
// 修复mock导入路径
i. 将mock导入路径改为`@/lib/supabase/client`
ii. 确保mock返回值结构与实际supabase客户端一致
iii. 确保同时导出`supabase`实例和`createClient`函数
```

### 1.3 修复salesOrders.server.test.ts

**问题分析**：
- mock查询链缺少必要的方法
- 实际服务中调用了`range(...).order(...)`
- mock中`range`方法直接返回结果，没有返回this

**解决方案**：
```typescript
// 修复mock查询链
i. 确保mock中的方法返回this以支持链式调用
ii. 配置`range`方法返回this，而不是直接返回结果
iii. 在`single`方法中返回预期的数据
iv. 确保所有方法的返回值结构正确
```

## 2. 优化测试执行效率

### 2.1 配置测试并行度

**解决方案**：
```typescript
// 更新vitest.config.ts
i. 调整parallelism设置，根据CI环境资源配置合适的线程数
ii. 配置测试超时时间，避免长时间运行的测试阻塞
iii. 配置测试文件的执行顺序，确保依赖关系正确
iv. 启用测试缓存，减少重复执行
```

### 2.2 优化慢测试

**解决方案**：
```typescript
// 优化测试设置
i. 使用`beforeAll`和`afterAll`减少重复设置
ii. 优化mock设置，避免不必要的函数调用
iii. 减少测试数据生成的复杂度
iv. 并行执行独立的测试套件
v. 优化测试断言，减少DOM查询
```

## 3. 完善测试文档

### 3.1 创建测试编写指南

**解决方案**：
```markdown
// 创建docs/testing-guide.md
i. 测试文件命名规范
ii. 测试结构模板
iii. Mock使用指南
iv. 服务测试编写规范
v. 组件测试编写规范
vi. E2E测试编写规范
vii. 测试数据工厂使用指南
viii. 测试运行命令说明
```

### 3.2 更新README文档

**解决方案**：
```markdown
// 更新README.md
i. 添加测试架构说明
ii. 添加测试运行命令
iii. 添加测试覆盖率说明
iv. 添加贡献测试的指南
v. 添加测试相关徽章
```

## 4. 配置CI/CD测试集成

### 4.1 配置定期运行测试

**解决方案**：
```yaml
// 更新.github/workflows/test.yml
i. 添加定时运行测试的cron任务
ii. 配置不同测试环境的测试运行
iii. 配置测试结果的保存和归档
iv. 配置测试覆盖率报告的上传
```

### 4.2 设置测试结果通知

**解决方案**：
```yaml
// 更新.github/workflows/test.yml
i. 配置测试失败时的邮件通知
ii. 配置测试覆盖率下降时的告警
iii. 集成Slack或Discord通知
iv. 配置GitHub Actions的测试结果展示
```

## 5. 实施顺序

1. **修复quotes-client.test.ts** - 解决mock导入路径问题
2. **修复salesOrders.server.test.ts** - 解决查询链问题
3. **优化products-service.test.ts** - 统一使用全局mock配置
4. **配置测试并行度** - 提高CI执行效率
5. **创建测试编写指南** - 完善测试文档
6. **更新README文档** - 添加测试相关内容
7. **配置CI/CD测试集成** - 配置定期运行和通知
8. **优化慢测试** - 减少测试执行时间

## 6. 预期成果

- ✅ 所有服务测试通过
- ✅ 测试执行效率提升30%
- ✅ 完善的测试文档
- ✅ 自动化的CI/CD测试流程
- ✅ 测试覆盖率保持在80%以上
- ✅ 测试结果可视化和通知

## 7. 关键改进点

- **一致性**：统一使用全局mock配置，减少重复代码
- **可靠性**：修复mock导入路径和查询链，确保测试稳定性
- **效率**：配置并行测试和优化慢测试，减少CI执行时间
- **可维护性**：完善测试文档，提高测试代码的可读性和可维护性
- **自动化**：配置定期运行和通知，确保代码质量持续监控