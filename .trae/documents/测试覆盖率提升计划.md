# 测试覆盖率提升计划

## 目标
- 整体测试覆盖率 > 70%
- 核心服务覆盖率 > 80%
- 新增 10+ 测试用例
- CI 测试全绿

## 测试范围

### 1. 分享服务测试 (`src/services/share.client.ts`)
**目标**：覆盖率 > 80%

**测试用例**：
- `generateToken` 方法测试（成功/失败场景）
- `getActiveToken` 方法测试（有/无 token 场景）
- `validateToken` 方法测试（有效/无效 token 场景）
- `revokeToken` 方法测试（成功/失败场景）
- `mapDbTokenToShareToken` 函数测试

**测试策略**：
- 使用 Vitest 的 `vi.mock` 模拟 `fetch` API
- 测试各种 HTTP 响应状态（200, 400, 500 等）
- 测试不同资源类型（quote/order）

### 2. 中间件链测试 (`src/middleware/base.ts`)
**目标**：覆盖率 > 80%

**现有测试**：已存在基础集成测试

**补充测试用例**：
- 单个中间件执行测试
- 多个中间件链式执行测试
- 中间件返回 NextResponse 时的处理测试
- 空中间件链测试
- 中间件异常处理测试

**测试策略**：
- 创建 mock 中间件类来验证执行顺序
- 测试中间件返回不同结果时的处理逻辑

### 3. 订单组件测试 (`src/features/orders/components/`)
**目标**：选择关键组件测试，新增 5+ 组件测试

**选择的组件**：
- `order-summary.tsx` - 订单摘要组件
- `order-tabs.tsx` - 订单标签组件
- `customer-info-section.tsx` - 客户信息组件
- `slide-card.tsx` - 幻灯片卡片组件
- `product-item-row.tsx` - 产品项行组件

**测试策略**：
- 使用 Testing Library 进行组件渲染和交互测试
- 测试组件的 props 处理
- 测试组件的条件渲染
- 测试组件的事件处理

### 4. A11y 测试（使用 jest-axe）
**目标**：为关键组件添加无障碍测试

**测试用例**：
- 订单摘要组件无障碍测试
- 订单标签组件无障碍测试
- 客户信息组件无障碍测试
- 幻灯片卡片组件无障碍测试

**测试策略**：
- 使用 `@testing-library/jest-dom` 和 `jest-axe` 进行无障碍测试
- 测试键盘导航
- 测试屏幕阅读器支持
- 测试 ARIA 属性

## 测试文件结构

```
src/
├── services/
│   └── __tests__/
│       └── share.client.test.ts    # 新增
├── middleware/
│   └── __tests__/
│       └── middleware-chain.test.ts # 补充
├── features/orders/components/
│   ├── __tests__/
│   │   ├── order-summary.test.tsx     # 新增
│   │   ├── order-tabs.test.tsx        # 新增
│   │   ├── customer-info-section.test.tsx # 新增
│   │   ├── slide-card.test.tsx        # 新增
│   │   └── product-item-row.test.tsx  # 新增
│   └── ...
```

## 执行步骤

1. **编写分享服务测试**：创建 `share.client.test.ts` 文件，覆盖所有方法
2. **补充中间件链测试**：扩展现有测试，覆盖更多场景
3. **编写订单组件测试**：为选定的 5 个组件创建测试文件
4. **添加 A11y 测试**：在组件测试中集成 jest-axe 测试
5. **运行测试覆盖率报告**：执行 `npm run test:coverage` 检查覆盖率
6. **修复测试问题**：确保所有测试通过
7. **提交测试代码**：确保 CI 测试全绿

## 预期结果

- 新增 12+ 测试用例
- 整体覆盖率提升至 > 70%
- 核心服务覆盖率 > 80%
- CI 测试全绿

## 技术栈

- **测试框架**：Vitest
- **组件测试**：React Testing Library
- **API 模拟**：Vitest Mock
- **无障碍测试**：jest-axe
- **断言库**：Vitest 内置断言

## 注意事项

- 遵循现有测试文件的命名和结构规范
- 确保测试用例的独立性和可维护性
- 测试覆盖各种边界情况
- 使用描述性的测试用例名称
- 为复杂测试添加适当的注释