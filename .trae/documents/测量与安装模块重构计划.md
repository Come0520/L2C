# 测量与安装模块重构计划

## 目标
将测量与安装模块迁移到 Next.js 16 + React 19 + Supabase 最佳实践，包括页面优先使用 Server Components，API 安全使用 Zod 进行严格的请求体验证，以及优化移动端体验。

## 重构步骤

### 1. 创建服务端服务
- **文件**：`src/services/measurement.server.ts`
- **功能**：实现测量任务的服务端数据获取逻辑
- **实现**：
  - 实现 `getMeasurementTasks` 方法，用于获取测量任务列表
  - 实现 `getMeasurementTaskById` 方法，用于获取测量任务详情
  - 使用服务端 Supabase 客户端

### 2. 创建安装服务端服务
- **文件**：`src/services/installation.server.ts`
- **功能**：实现安装任务的服务端数据获取逻辑
- **实现**：
  - 实现 `getInstallationTasks` 方法，用于获取安装任务列表
  - 实现 `getInstallationTaskById` 方法，用于获取安装任务详情
  - 使用服务端 Supabase 客户端

### 3. 重构测量页面
- **文件**：`src/app/measurements/page.tsx`
- **功能**：将页面改为完整的 Server Component
- **实现**：
  - 移除客户端组件依赖
  - 使用 `src/services/measurement.server.ts` 获取数据
  - 实现服务端渲染的测量任务列表
  - 保持现有的分配功能，但通过客户端组件实现交互

### 4. 重构安装页面
- **文件**：`src/app/installations/page.tsx`
- **功能**：将页面改为完整的 Server Component
- **实现**：
  - 移除客户端组件依赖
  - 使用 `src/services/installation.server.ts` 获取数据
  - 实现服务端渲染的安装任务列表
  - 保持现有的分配和完成功能，但通过客户端组件实现交互

### 5. 检查并优化 API 路由
- **文件**：`src/app/api/assignment/reassign/route.ts`
- **功能**：确保 API 路由使用 Zod 进行严格的请求体验证
- **实现**：
  - 检查现有 Zod 校验是否完整
  - 确保所有字段都有适当的校验规则
  - 优化错误处理和响应格式

### 6. 优化移动端体验
- **功能**：检查列表组件在移动端的表现，优化触摸交互
- **实现**：
  - 确保 `MeasurementTaskList` 组件在移动端响应式
  - 确保 `InstallationTaskList` 组件在移动端响应式
  - 优化触摸目标大小，确保易于点击
  - 确保模态框在移动端正常显示

### 7. 添加骨架屏
- **功能**：为测量和安装页面添加骨架屏
- **实现**：
  - 创建 `MeasurementTaskListSkeleton` 组件
  - 创建 `InstallationTaskListSkeleton` 组件
  - 在数据加载过程中显示骨架屏

## 技术要点

### Server Components 最佳实践
- 页面组件使用 Server Components，减少客户端 JS 体积
- 数据获取在服务端完成，提升首屏加载速度
- 客户端交互通过子组件的 `'use client'` 实现

### API 安全
- 确保所有写操作 API 使用 Zod 进行严格的请求体验证
- 优化错误处理和响应格式

### UI/UX 增强
- 添加骨架屏加载状态，提升用户体验
- 优化移动端体验，确保触摸交互流畅
- 保持现有的功能完整性

## 实施顺序
1. 创建服务端服务文件 `measurement.server.ts` 和 `installation.server.ts`
2. 重构测量页面为 Server Component
3. 重构安装页面为 Server Component
4. 检查并优化 API 路由
5. 优化移动端体验
6. 添加骨架屏
7. 测试并验证功能完整性