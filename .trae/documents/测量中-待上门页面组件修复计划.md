# 测量中-待上门页面组件修复计划

## 问题分析

通过对 `survey-pending-visit-view.tsx` 组件的分析，发现以下问题：

1. **数据结构不匹配**：
   - 组件使用 `PendingVisitOrder` 接口，与实际测量单类型定义不符
   - 缺少与后端API的集成，当前使用Mock数据

2. **状态流转问题**：
   - 组件中提到了"测量中-待上门"状态，但需要确保与前端状态常量保持一致
   - 缺少状态流转的后端调用

3. **功能未实现**：
   - 催单功能（`confirmRemindOrder`）仅为占位符
   - 重新分配功能（`confirmReassignOrder`）仅为占位符
   - 搜索功能未实现
   - 批量提醒和导出功能未实现

4. **代码质量问题**：
   - 缺少类型定义的统一管理
   - 重复的状态管理（`selectedOrder` 和 `selectedOrderForRemark`）
   - 缺少错误处理
   - 缺少加载状态

5. **UI一致性问题**：
   - 组件样式与设计系统不完全一致
   - 缺少响应式设计优化

## 修复方案

### 1. 统一数据结构与状态管理

**修改内容**：
- 使用统一的测量单类型定义（`Measurement`）替代 `PendingVisitOrder` 接口
- 集成测量服务 API，替换Mock数据
- 统一状态管理，减少重复状态

**实现步骤**：
```typescript
// 导入统一的测量单类型
import { Measurement } from '@/types/measurement'
import { measurementService } from '@/services/measurements.client'
import { MEASUREMENT_STATUS } from '@/constants/measurement-status'

// 使用统一的状态管理
const [measurements, setMeasurements] = useState<Measurement[]>([])
const [isLoading, setIsLoading] = useState(false)
```

### 2. 实现完整的状态流转

**修改内容**：
- 使用统一的状态常量（`MEASUREMENT_STATUS.MEASURING_PENDING_VISIT`）
- 实现状态流转的后端调用
- 添加状态流转的权限控制

**实现步骤**：
```typescript
// 实现催单功能
const confirmRemindOrder = async () => {
  if (!selectedOrder) return
  try {
    setIsLoading(true)
    await measurementService.updateMeasurementStatus(selectedOrder.id, MEASUREMENT_STATUS.MEASURING_PENDING_VISIT)
    // 刷新数据
    fetchMeasurements()
  } catch (error) {
    console.error('催单失败:', error)
  } finally {
    setIsLoading(false)
    setRemindDialogOpen(false)
  }
}
```

### 3. 完善功能实现

**修改内容**：
- 实现搜索和筛选功能
- 实现批量提醒和导出功能
- 添加错误处理和加载状态
- 实现完整的备注管理

**实现步骤**：
```typescript
// 实现搜索功能
const handleSearch = async () => {
  try {
    setIsLoading(true)
    const result = await measurementService.getMeasurements(1, 10, MEASUREMENT_STATUS.MEASURING_PENDING_VISIT, undefined, searchKeyword)
    setMeasurements(result.measurements)
  } catch (error) {
    console.error('搜索失败:', error)
  } finally {
    setIsLoading(false)
  }
}
```

### 4. 优化代码质量

**修改内容**：
- 移除重复的状态管理
- 添加类型安全检查
- 添加错误处理
- 添加加载状态
- 优化组件结构

**实现步骤**：
```typescript
// 优化状态管理
const [selectedOrder, setSelectedOrder] = useState<Measurement | null>(null)
// 用于所有模态框，不再使用单独的 selectedOrderForRemark

// 添加加载状态
<PaperTableBody>
  {isLoading ? (
    <PaperTableRow>
      <PaperTableCell colSpan={9} className="text-center py-8">
        加载中...
      </PaperTableCell>
    </PaperTableRow>
  ) : measurements.length === 0 ? (
    <PaperTableRow>
      <PaperTableCell colSpan={9} className="text-center py-8">
        暂无数据
      </PaperTableCell>
    </PaperTableRow>
  ) : (
    measurements.map(measurement => (
      // 渲染测量单
    ))
  )}
</PaperTableBody>
```

### 5. 优化UI设计

**修改内容**：
- 统一组件样式与设计系统
- 优化响应式设计
- 添加可访问性支持
- 优化交互体验

**实现步骤**：
```typescript
// 优化按钮样式
<PaperButton 
  variant="primary" 
  className="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-md shadow-sm transition-all duration-200"
  disabled={isLoading}
>
  {isLoading ? '加载中...' : '查询'}
</PaperButton>
```

## 预期效果

1. **数据一致性**：使用统一的测量单类型定义，确保与后端API的数据结构一致
2. **状态流转正确**：实现完整的状态流转，确保状态的一致性和准确性
3. **功能完整**：实现所有预期功能，包括搜索、筛选、催单、重新分配等
4. **代码质量优化**：减少重复代码，添加错误处理和加载状态，提高代码的可维护性
5. **UI一致性**：与设计系统保持一致，优化响应式设计和交互体验

## 实施步骤

1. 统一数据结构与状态管理
2. 实现与后端API的集成
3. 实现完整的状态流转
4. 完善功能实现
5. 优化代码质量
6. 优化UI设计
7. 添加测试用例
8. 进行性能优化
9. 确保可访问性
10. 进行集成测试

## 代码优化建议

1. 使用 `useQuery` 进行数据获取和缓存
2. 使用 `useMutation` 进行状态更新
3. 实现组件的懒加载
4. 优化列表渲染性能
5. 添加类型安全检查
6. 实现错误边界
7. 添加组件测试用例
8. 实现国际化支持

通过以上修复，测量中-待上门页面组件将实现与后端API的集成，确保状态流转的正确性，实现完整的功能，提高代码质量和UI一致性，为用户提供良好的体验。