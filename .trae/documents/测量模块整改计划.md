# 测量模块整改计划

## 一、数据库Schema修正（1天）

### 1.1 版本管理字段补充
- 为 `measure_tasks` 表添加缺失字段：
  - `version_display` (VARCHAR): 版本展示号（如 V1.A, V2.B）
  - `parent_id` (UUID): 关联上一版本ID，用于版本追溯
- 完善 `createNewMeasureVersion` 函数，自动生成版本号

### 1.2 API文档与Schema枚举对齐
- 修正API文档中的状态枚举：
  - 将 `PENDING_REVIEW` 统一改为 `PENDING_CONFIRM`
  - 删除 `REJECTED` 状态，使用 `rejectCount > 0` 判断驳回状态
- 更新 `enums.ts` 确保枚举一致性

## 二、核心业务逻辑补齐（5天，P0）

### 2.1 拆单机制（2天）
- 创建 `measure_task_splits` 表
- 实现品类分析函数 `analyzeSplitRequirement(quoteId)`
- 实现师傅推荐算法 `recommendWorkers(category)`
- 实现拆单执行函数 `splitMeasureTask(quoteId, splitPlan)`
- 添加拆单唯一性校验
- 创建 `SplitTaskDialog.tsx` UI组件

### 2.2 费用准入机制（1.5天）
- 实现 `checkEarnestMoney(leadId)` 定金检查
- 实现 `applyFeeWaiver(taskId, reason)` 豁免申请
- 新增API: `checkMeasureFeeStatus(taskId)`
- 新增API: `requestFeeWaiver(taskId, reason)`
- 创建 `FeeWaiverDialog.tsx` UI组件

### 2.3 现场考核增强（1天）
- 实现Haversine公式计算GPS距离
- 距离 > 500m 显示警告但允许签到
- 实现迟到判定逻辑（比较checkInAt和scheduledAt）
- 添加 `isLate` 和 `lateMinutes` 字段
- 签到UI显示距离和迟到信息

### 2.4 驳回预警机制（0.5天）
- 在 `reviewMeasureTask` 中添加驳回次数检查
- 驳回≥3次自动通知店长
- 任务详情页显示驳回次数徽章

## 三、UI/UX完善（3天，P1）

### 3.1 分页与筛选（1天）
- 替换列表页的 `{/* Pagination TODO */}` 注释
- 在 `MeasurementFilterBar` 添加日期范围选择器
- 添加测量师、销售人员高级筛选

### 3.2 版本管理UI（1.5天）
- 创建 `VersionSwitcher.tsx` 组件
- 显示当前版本（如 V1.A）
- 列出所有历史版本，支持切换
- 新建功能按钮："创建方案B"、"发起复测"

### 3.3 操作日志（0.5天）
- 从 `audit_logs` 表查询历史记录
- 创建 `OperationTimeline.tsx` 时间轴组件
- 驳回记录标红显示

### 3.4 转报价功能（0.5天）
- 列表页添加"转报价"按钮（仅COMPLETED状态）
- 跳转至报价创建页并自动带入测量数据

## 四、小程序端开发（4天，P0）

### 4.1 任务列表页（1.5天）
- 创建 `src/app/(mobile)/measure/page.tsx`
- 卡片式布局展示任务
- 实现筛选Tab（待接单/待上门/已完成）
- 一键导航功能（调用微信 `openLocation`）

### 4.2 测量数据录入（2天）
- 创建 `[id]/submit/page.tsx`
- 大按钮设计（高度56px，适配手套操作）
- 步骤式录入表单
- 实时保存草稿（localStorage）
- 照片上传：调用微信 `chooseImage`，前端压缩至500KB，上传到OSS

### 4.3 签到打卡增强（0.5天）
- 完善 `gps-check-in.tsx`
- 显示距离客户地址距离
- 超范围黄色警告

### 4.4 离线能力（2天）
- 使用IndexedDB存储任务离线缓存
- 离线录入数据暂存队列
- 网络恢复自动同步（监听 `onNetworkStatusChange`）
- 显示同步进度
- 冲突处理弹窗提示

## 五、缺失API补充（0.5天）

### 5.1 高优先级API（P0）
- `POST /tasks/{id}/cancel` - 取消测量任务
- `POST /tasks/{id}/fee-waiver` - 费用豁免申请
- `GET /tasks/{id}/fee-status` - 费用状态查询
- `POST /tasks/{id}/remeasure` - 创建复测任务

## 六、执行时间表（4周）

**第一周（Day 1-7）**: 核心业务逻辑 → 目标完成度55%
- 数据库Schema修正
- 拆单机制实现
- 费用准入功能
- 现场考核增强
- 驳回预警机制

**第二周（Day 8-14）**: UI/UX完善 → 目标完成度70%
- 分页与筛选增强
- 版本管理UI
- 操作日志展示
- 转报价功能

**第三周（Day 15-21）**: 小程序端开发 → 目标完成度85%
- 小程序任务列表
- 测量数据录入表单
- 签到打卡增强
- 离线能力基础版

**第四周（Day 22-28）**: 集成测试 → 目标完成度90%+
- E2E测试（完整流程、拆单、驳回、离线）
- 性能优化
- 文档与培训

## 七、资源需求

| 角色 | 人数 | 时间投入 | 主要职责 |
|:---|:---:|:---|:---|
| 后端工程师 | 1人 | 全职4周 | 业务逻辑、API、数据库 |
| 前端工程师 | 1人 | 全职4周 | Web端UI/UX |
| 小程序工程师 | 1人 | 2周（第3-4周） | 小程序开发、离线能力 |
| 测试工程师 | 1人 | 1周（第4周） | E2E测试、Bug修复 |

**总人天估算**: 约80人天

## 八、风险提示

1. 🔴 严重：拆单逻辑与实际业务不符 - 第一周完成后立即与业务方验证
2. 🔴 严重：小程序端缺失导致测量师无法实际使用
3. 🟡 高：离线同步冲突处理 - 需实现版本号机制
4. 🟡 高：GPS定位不准确 - 允许500m误差，记录但不阻塞