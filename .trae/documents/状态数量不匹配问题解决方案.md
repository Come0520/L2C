# 27状态流转方案调整

## 问题分析

根据文档和代码的对比分析，发现代码中缺少文档中定义的部分状态，导致状态数量不匹配。文档中定义了27个状态，但代码中只定义了26个状态。

## 文档中定义的27个状态

| 阶段 | 状态数量 | 具体状态 |
|------|----------|----------|
| 线索阶段 | 5 | 待分配、待跟踪、跟踪中、草签、已失效 |
| 测量阶段 | 6 | 待测量、测量中-待分配、测量中-分配中、测量中-待上门、测量中-待确认、方案待确认 |
| 订单处理阶段 | 5 | 待推单、待下单、生产中、备货完成、待发货 |
| 安装阶段 | 4 | 安装中-待分配、安装中-分配中、安装中-待上门、安装中-待确认 |
| 财务阶段 | 4 | 待对账、待开发票、待回款、已完成 |
| 异常状态 | 3 | 已取消、暂停、异常 |

## 代码中缺少的状态

1. 待分配（线索阶段）
2. 已失效（线索阶段）
3. 安装中-待分配（安装阶段）
4. 安装中-分配中（安装阶段）
5. 安装中-待上门（安装阶段）
6. 安装中-待确认（安装阶段）
7. 待对账（财务阶段）
8. 待开发票（财务阶段）
9. 待回款（财务阶段）
10. 暂停（异常状态）
11. 异常（异常状态）

## 代码中需要调整的状态名称

- 将 `PRODUCTION_COMPLETED` 改为 `STOCK_PREPARED`（备货完成）

## 解决方案

### 1. 修改 ORDER_STATUS 常量定义

在 `/Users/laichangcheng/Documents/文稿 - 来长城的MacBook Air/trae/L2C/slideboard-frontend/src/constants/order-status.ts` 文件中添加缺少的状态，并调整状态名称。

### 2. 更新状态流转规则

添加新状态的流转规则，确保状态之间的流转符合业务逻辑。

### 3. 添加状态配置

为新添加的状态添加配置信息，包括标签、颜色等。

## 具体实施步骤

### 步骤1：修改 ORDER_STATUS 常量

```typescript
export const ORDER_STATUS = {
  // 线索阶段
  PENDING_ASSIGNMENT: 'pending_assignment', // 待分配
  PENDING_TRACKING: 'pending_tracking', // 待跟踪
  TRACKING: 'tracking', // 跟踪中
  DRAFT_SIGNED: 'draft_signed', // 草签
  EXPIRED: 'expired', // 已失效
  
  // 测量阶段
  PENDING_MEASUREMENT: 'pending_measurement', // 待测量
  MEASURING_PENDING_ASSIGNMENT: 'measuring_pending_assignment', // 测量中-待分配
  MEASURING_ASSIGNING: 'measuring_assigning', // 测量中-分配中
  MEASURING_PENDING_VISIT: 'measuring_pending_visit', // 测量中-待上门
  MEASURING_PENDING_CONFIRMATION: 'measuring_pending_confirmation', // 测量中-待确认
  PLAN_PENDING_CONFIRMATION: 'plan_pending_confirmation', // 方案待确认
  
  // 订单处理阶段
  PENDING_PUSH: 'pending_push', // 待推单
  PENDING_ORDER: 'pending_order', // 待下单
  IN_PRODUCTION: 'in_production', // 生产中
  STOCK_PREPARED: 'stock_prepared', // 备货完成
  PENDING_SHIPMENT: 'pending_shipment', // 待发货
  
  // 安装阶段
  INSTALLING_PENDING_ASSIGNMENT: 'installing_pending_assignment', // 安装中-待分配
  INSTALLING_ASSIGNING: 'installing_assigning', // 安装中-分配中
  INSTALLING_PENDING_VISIT: 'installing_pending_visit', // 安装中-待上门
  INSTALLING_PENDING_CONFIRMATION: 'installing_pending_confirmation', // 安装中-待确认
  
  // 财务阶段
  PENDING_RECONCILIATION: 'pending_reconciliation', // 待对账
  PENDING_INVOICE: 'pending_invoice', // 待开发票
  PENDING_PAYMENT: 'pending_payment', // 待回款
  COMPLETED: 'completed', // 已完成
  
  // 异常状态
  CANCELLED: 'cancelled', // 已取消
  SUSPENDED: 'suspended', // 暂停
  EXCEPTION: 'exception' // 异常
} as const
```

### 步骤2：更新状态流转规则

添加新状态的流转规则，确保状态之间的流转符合业务逻辑：

```typescript
export const ORDER_STATUS_TRANSITIONS: Record<string, OrderStatus[]> = {
  // 线索阶段流转
  [ORDER_STATUS.PENDING_ASSIGNMENT]: [ORDER_STATUS.PENDING_TRACKING, ORDER_STATUS.CANCELLED, ORDER_STATUS.EXPIRED],
  [ORDER_STATUS.PENDING_TRACKING]: [ORDER_STATUS.TRACKING, ORDER_STATUS.CANCELLED, ORDER_STATUS.EXPIRED],
  [ORDER_STATUS.TRACKING]: [ORDER_STATUS.DRAFT_SIGNED, ORDER_STATUS.CANCELLED, ORDER_STATUS.EXPIRED],
  [ORDER_STATUS.DRAFT_SIGNED]: [ORDER_STATUS.PENDING_MEASUREMENT, ORDER_STATUS.CANCELLED, ORDER_STATUS.EXPIRED],
  [ORDER_STATUS.EXPIRED]: [],
  
  // 测量阶段流转
  [ORDER_STATUS.PENDING_MEASUREMENT]: [ORDER_STATUS.MEASURING_PENDING_ASSIGNMENT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.MEASURING_PENDING_ASSIGNMENT]: [ORDER_STATUS.MEASURING_ASSIGNING, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.MEASURING_ASSIGNING]: [ORDER_STATUS.MEASURING_PENDING_VISIT, ORDER_STATUS.MEASURING_PENDING_ASSIGNMENT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.MEASURING_PENDING_VISIT]: [ORDER_STATUS.MEASURING_PENDING_CONFIRMATION, ORDER_STATUS.MEASURING_ASSIGNING, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.MEASURING_PENDING_CONFIRMATION]: [ORDER_STATUS.PLAN_PENDING_CONFIRMATION, ORDER_STATUS.MEASURING_PENDING_VISIT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.PLAN_PENDING_CONFIRMATION]: [ORDER_STATUS.PENDING_PUSH, ORDER_STATUS.MEASURING_PENDING_CONFIRMATION, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  
  // 订单处理阶段流转
  [ORDER_STATUS.PENDING_PUSH]: [ORDER_STATUS.PENDING_ORDER, ORDER_STATUS.PLAN_PENDING_CONFIRMATION, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.PENDING_ORDER]: [ORDER_STATUS.IN_PRODUCTION, ORDER_STATUS.PENDING_PUSH, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.IN_PRODUCTION]: [ORDER_STATUS.STOCK_PREPARED, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED, ORDER_STATUS.EXCEPTION],
  [ORDER_STATUS.STOCK_PREPARED]: [ORDER_STATUS.PENDING_SHIPMENT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED, ORDER_STATUS.EXCEPTION],
  [ORDER_STATUS.PENDING_SHIPMENT]: [ORDER_STATUS.INSTALLING_PENDING_ASSIGNMENT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED, ORDER_STATUS.EXCEPTION],
  
  // 安装阶段流转
  [ORDER_STATUS.INSTALLING_PENDING_ASSIGNMENT]: [ORDER_STATUS.INSTALLING_ASSIGNING, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.INSTALLING_ASSIGNING]: [ORDER_STATUS.INSTALLING_PENDING_VISIT, ORDER_STATUS.INSTALLING_PENDING_ASSIGNMENT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.INSTALLING_PENDING_VISIT]: [ORDER_STATUS.INSTALLING_PENDING_CONFIRMATION, ORDER_STATUS.INSTALLING_ASSIGNING, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.INSTALLING_PENDING_CONFIRMATION]: [ORDER_STATUS.PENDING_RECONCILIATION, ORDER_STATUS.INSTALLING_PENDING_VISIT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  
  // 财务阶段流转
  [ORDER_STATUS.PENDING_RECONCILIATION]: [ORDER_STATUS.PENDING_INVOICE, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.PENDING_INVOICE]: [ORDER_STATUS.PENDING_PAYMENT, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.PENDING_PAYMENT]: [ORDER_STATUS.COMPLETED, ORDER_STATUS.CANCELLED, ORDER_STATUS.SUSPENDED],
  [ORDER_STATUS.COMPLETED]: [],
  
  // 异常状态流转
  [ORDER_STATUS.CANCELLED]: [],
  [ORDER_STATUS.SUSPENDED]: [ORDER_STATUS.EXCEPTION, ORDER_STATUS.CANCELLED],
  [ORDER_STATUS.EXCEPTION]: [ORDER_STATUS.CANCELLED]
}
```

### 步骤3：添加状态配置

为新添加的状态添加配置信息：

```typescript
export const ORDER_STATUS_CONFIG: Record<string, any> = {
  // 线索阶段配置
  [ORDER_STATUS.PENDING_ASSIGNMENT]: {
    label: '待分配',
    color: '#FF5722',
    bgColor: 'bg-red-100',
    borderColor: 'border-red-200'
  },
  [ORDER_STATUS.PENDING_TRACKING]: {
    label: '待跟踪',
    color: '#FFC107',
    bgColor: 'bg-yellow-100',
    borderColor: 'border-yellow-200'
  },
  [ORDER_STATUS.TRACKING]: {
    label: '跟踪中',
    color: '#2196F3',
    bgColor: 'bg-blue-100',
    borderColor: 'border-blue-200'
  },
  [ORDER_STATUS.DRAFT_SIGNED]: {
    label: '草签',
    color: '#4CAF50',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-200'
  },
  [ORDER_STATUS.EXPIRED]: {
    label: '已失效',
    color: '#9E9E9E',
    bgColor: 'bg-gray-100',
    borderColor: 'border-gray-200'
  },
  
  // 测量阶段配置
  [ORDER_STATUS.PENDING_MEASUREMENT]: {
    label: '待测量',
    color: '#FF9800',
    bgColor: 'bg-orange-100',
    borderColor: 'border-orange-200'
  },
  [ORDER_STATUS.MEASURING_PENDING_ASSIGNMENT]: {
    label: '测量中-待分配',
    color: '#FFC107',
    bgColor: 'bg-yellow-100',
    borderColor: 'border-yellow-200'
  },
  [ORDER_STATUS.MEASURING_ASSIGNING]: {
    label: '测量中-分配中',
    color: '#2196F3',
    bgColor: 'bg-blue-100',
    borderColor: 'border-blue-200'
  },
  [ORDER_STATUS.MEASURING_PENDING_VISIT]: {
    label: '测量中-待上门',
    color: '#4CAF50',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-200'
  },
  [ORDER_STATUS.MEASURING_PENDING_CONFIRMATION]: {
    label: '测量中-待确认',
    color: '#9C27B0',
    bgColor: 'bg-purple-100',
    borderColor: 'border-purple-200'
  },
  [ORDER_STATUS.PLAN_PENDING_CONFIRMATION]: {
    label: '方案待确认',
    color: '#3F51B5',
    bgColor: 'bg-indigo-100',
    borderColor: 'border-indigo-200'
  },
  
  // 订单处理阶段配置
  [ORDER_STATUS.PENDING_PUSH]: {
    label: '待推单',
    color: '#FF9800',
    bgColor: 'bg-orange-100',
    borderColor: 'border-orange-200'
  },
  [ORDER_STATUS.PENDING_ORDER]: {
    label: '待下单',
    color: '#FFC107',
    bgColor: 'bg-yellow-100',
    borderColor: 'border-yellow-200'
  },
  [ORDER_STATUS.IN_PRODUCTION]: {
    label: '生产中',
    color: '#FF5722',
    bgColor: 'bg-red-100',
    borderColor: 'border-red-200'
  },
  [ORDER_STATUS.STOCK_PREPARED]: {
    label: '备货完成',
    color: '#8BC34A',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-200'
  },
  [ORDER_STATUS.PENDING_SHIPMENT]: {
    label: '待发货',
    color: '#00BCD4',
    bgColor: 'bg-cyan-100',
    borderColor: 'border-cyan-200'
  },
  
  // 安装阶段配置
  [ORDER_STATUS.INSTALLING_PENDING_ASSIGNMENT]: {
    label: '安装中-待分配',
    color: '#FFC107',
    bgColor: 'bg-yellow-100',
    borderColor: 'border-yellow-200'
  },
  [ORDER_STATUS.INSTALLING_ASSIGNING]: {
    label: '安装中-分配中',
    color: '#2196F3',
    bgColor: 'bg-blue-100',
    borderColor: 'border-blue-200'
  },
  [ORDER_STATUS.INSTALLING_PENDING_VISIT]: {
    label: '安装中-待上门',
    color: '#4CAF50',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-200'
  },
  [ORDER_STATUS.INSTALLING_PENDING_CONFIRMATION]: {
    label: '安装中-待确认',
    color: '#9C27B0',
    bgColor: 'bg-purple-100',
    borderColor: 'border-purple-200'
  },
  
  // 财务阶段配置
  [ORDER_STATUS.PENDING_RECONCILIATION]: {
    label: '待对账',
    color: '#FF5722',
    bgColor: 'bg-red-100',
    borderColor: 'border-red-200'
  },
  [ORDER_STATUS.PENDING_INVOICE]: {
    label: '待开发票',
    color: '#FFC107',
    bgColor: 'bg-yellow-100',
    borderColor: 'border-yellow-200'
  },
  [ORDER_STATUS.PENDING_PAYMENT]: {
    label: '待回款',
    color: '#2196F3',
    bgColor: 'bg-blue-100',
    borderColor: 'border-blue-200'
  },
  [ORDER_STATUS.COMPLETED]: {
    label: '已完成',
    color: '#4CAF50',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-200'
  },
  
  // 异常状态配置
  [ORDER_STATUS.CANCELLED]: {
    label: '已取消',
    color: '#9E9E9E',
    bgColor: 'bg-gray-100',
    borderColor: 'border-gray-200'
  },
  [ORDER_STATUS.SUSPENDED]: {
    label: '暂停',
    color: '#FF9800',
    bgColor: 'bg-orange-100',
    borderColor: 'border-orange-200'
  },
  [ORDER_STATUS.EXCEPTION]: {
    label: '异常',
    color: '#F44336',
    bgColor: 'bg-red-100',
    borderColor: 'border-red-200'
  }
}
```

### 步骤4：调整现有代码中的状态引用

需要检查并调整代码中所有引用ORDER_STATUS的地方，确保使用正确的状态名称。例如：
- 将`ORDER_STATUS.PRODUCTION_COMPLETED`改为`ORDER_STATUS.STOCK_PREPARED`
- 添加新状态的引用

### 步骤5：更新状态流转图

确保文档中的状态流转图与代码中的状态流转规则保持一致，包括：
- 状态名称
- 状态流转方向
- 状态流转条件

## 预期效果

- 代码中定义的状态数量与文档一致，均为27个
- 状态名称与文档保持一致
- 状态流转规则符合业务逻辑
- 状态配置完整，包括标签、颜色等
- 文档与代码保持同步

## 实施时间

建议在下次代码更新时实施，确保所有相关代码都能正确处理新的状态定义。