# 线索单 100% 测试覆盖计划

## 📊 现有测试覆盖分析

### 已有单元测试（15个文件）
- ✅ `actions.test.ts` - 基础 Server Actions
- ✅ `status-workflow.test.ts` - 状态流转
- ✅ `lead-validation.test.tsx` - 验证逻辑
- ✅ `lead-business-rules.test.tsx` - 业务规则
- ✅ `lead-permissions.test.tsx` - 权限控制
- ✅ `lead-error-handling.test.tsx` - 错误处理
- ✅ `lead-boundary.test.tsx` - 边界条件
- ✅ `additional-actions.test.ts` - 额外操作
- ✅ `lead-detail.test.tsx` - 详情页
- ✅ `lead-activity-log.test.tsx` - 跟进记录
- ✅ `lead-quote-versions.test.tsx` - 报价版本
- ✅ `create-lead.test.tsx` - 创建线索
- ✅ `leads-page-client.test.tsx` - 列表页
- ✅ `lead-status-flow.test.tsx` - 状态流转
- ✅ `simple-test.test.tsx` - 简单测试

### 已有 E2E 测试（3个文件）
- ✅ `lead-creation.spec.ts` - 创建流程
- ✅ `lead-status-workflow.spec.ts` - 状态工作流
- ✅ `lead-measurement.spec.ts` - 测量服务

### 未测试的组件（8个）
- ❌ `assign-lead-dialog.tsx` - 分配弹窗
- ❌ `void-lead-dialog.tsx` - 作废弹窗
- ❌ `add-followup-dialog.tsx` - 添加跟进弹窗
- ❌ `edit-lead-dialog.tsx` - 编辑弹窗
- ❌ `return-lead-dialog.tsx` - 退回弹窗
- ❌ `lead-table.tsx` - 线索表格
- ❌ `leads-filter-bar.tsx` - 筛选栏
- ❌ `leads-advanced-filter.tsx` - 高级筛选
- ❌ `lead-filters.tsx` - 筛选器
- ❌ `lead-timeline.tsx` - 时间轴

## 🎯 测试覆盖目标

### 一、单元测试补充（新增 12 个测试文件）

#### 1. 组件测试（8个文件）
- `assign-lead-dialog.test.tsx` - 分配弹窗组件测试
- `void-lead-dialog.test.tsx` - 作废弹窗组件测试
- `add-followup-dialog.test.tsx` - 添加跟进弹窗组件测试
- `edit-lead-dialog.test.tsx` - 编辑弹窗组件测试
- `return-lead-dialog.test.tsx` - 退回弹窗组件测试
- `lead-table.test.tsx` - 线索表格组件测试
- `leads-filter-bar.test.tsx` - 筛选栏组件测试
- `leads-advanced-filter.test.tsx` - 高级筛选组件测试

#### 2. 业务逻辑深度测试（4个文件）
- `lead-data-consistency.test.ts` - 数据一致性测试
- `lead-audit-logs.test.ts` - 审计日志测试
- `lead-tag-management.test.ts` - 标签管理测试
- `lead-integration.test.ts` - 集成测试（与客户、报价、测量等模块的交互）

### 二、E2E 测试补充（新增 8 个测试文件）

#### 1. 完整业务流程测试（5个文件）
- `lead-lifecycle.spec.ts` - 完整生命周期测试
  - 创建 → 分配 → 跟进 → 报价 → 成交
- `lead-pool-management.spec.ts` - 公海池管理测试
  - 释放、领取、自动回收
- `lead-bulk-operations.spec.ts` - 批量操作测试
  - 批量分配、批量删除、批量导出
- `lead-advanced-filtering.spec.ts` - 高级筛选测试
  - 多维度组合筛选、日期范围、标签搜索
- `lead-followup-reminders.spec.ts` - 跟进提醒测试
  - 下次跟进时间、提醒通知

#### 2. 边缘场景测试（3个文件）
- `lead-concurrency.spec.ts` - 并发操作测试
  - 同时编辑、同时分配、状态冲突
- `lead-error-recovery.spec.ts` - 错误恢复测试
  - 网络中断、超时、重试机制
- `lead-data-integrity.spec.ts` - 数据完整性测试
  - 软删除、级联更新、外键约束

## 📝 测试用例详细规划

### 单元测试用例（约 200+ 个）

#### 组件测试用例
每个组件测试包括：
- ✅ 渲染测试
- ✅ 用户交互测试
- ✅ 表单验证测试
- ✅ 状态管理测试
- ✅ 错误处理测试
- ✅ 加载状态测试
- ✅ 空状态测试
- ✅ 边界条件测试

#### 业务逻辑测试用例
1. **数据一致性测试**
   - 手机号唯一性
   - 状态机完整性
   - 金额计算准确性
   - 时间戳正确性
   - 租户隔离

2. **审计日志测试**
   - 所有操作的日志记录
   - 日志内容完整性
   - 操作人追踪
   - 时间戳准确性

3. **标签管理测试**
   - 标签添加/删除
   - 自动标签逻辑（如"已上门"）
   - 标签搜索
   - 标签去重

4. **集成测试**
   - 线索 → 客户转化
   - 线索 → 报价关联
   - 线索 → 测量任务
   - 线索 → 系统日志

### E2E 测试用例（约 80+ 个）

#### 完整业务流程测试
1. **生命周期测试**
   - 创建线索 → 分配销售 → 开始跟进 → 添加跟进 → 创建报价 → 成交转化
   - 各状态间的转换验证
   - 数据一致性验证

2. **公海池管理**
   - 释放线索到公海
   - 从公海领取线索
   - 自动回收超时线索（3天）
   - 公海线索列表展示

3. **批量操作**
   - 批量分配给同一销售
   - 批量删除
   - 批量导出
   - 批量退回公海

4. **高级筛选**
   - 状态 + 销售 + 渠道组合筛选
   - 日期范围筛选
   - 标签关键词搜索
   - 意向等级筛选
   - URL 参数同步

5. **跟进提醒**
   - 设置下次跟进时间
   - 提醒备注
   - 过期提醒显示
   - 提醒完成状态

#### 边缘场景测试
1. **并发操作**
   - 两个用户同时编辑同一线索
   - 同时分配和领取
   - 状态冲突处理

2. **错误恢复**
   - 网络中断后的重试
   - 服务器超时处理
   - 数据库连接失败恢复

3. **数据完整性**
   - 软删除后的数据访问
   - 级联删除验证
   - 外键约束测试

## 🔧 测试工具和辅助函数

### Mock 工具增强
- 统一的 Mock 工厂函数
- 数据生成器（随机手机号、姓名等）
- 场景构建器（构建完整的测试场景）

### 测试辅助函数
- 等待元素出现
- Toast 消息验证
- 表单填充辅助
- 网络请求拦截

## 📈 测试覆盖率目标

| 测试类型 | 当前覆盖 | 目标覆盖 | 新增用例 |
|---------|---------|---------|---------|
| 单元测试 | ~80% | 100% | +150 |
| 组件测试 | ~60% | 100% | +80 |
| E2E 测试 | ~50% | 100% | +60 |
| 边缘场景 | ~30% | 100% | +40 |
| 集成测试 | ~40% | 100% | +30 |

## 🎯 实施步骤

### 阶段一：单元测试补充（优先级：高）
1. 创建组件测试文件（8个）
2. 创建业务逻辑测试文件（4个）
3. 增强现有测试用例
4. 运行测试并修复问题

### 阶段二：E2E 测试补充（优先级：高）
1. 创建完整业务流程测试（5个）
2. 创建边缘场景测试（3个）
3. 增强现有 E2E 测试
4. 运行测试并修复问题

### 阶段三：测试验证和优化（优先级：中）
1. 运行完整测试套件
2. 生成覆盖率报告
3. 识别未覆盖的代码路径
4. 补充遗漏的测试用例
5. 性能测试和优化

## 📊 成功标准

- ✅ 所有 Server Actions 有完整的单元测试
- ✅ 所有组件有完整的渲染和交互测试
- ✅ 所有业务逻辑有完整的测试覆盖
- ✅ 所有边缘场景有专门的测试用例
- ✅ 代码覆盖率 ≥ 95%
- ✅ 所有测试通过且稳定
- ✅ 测试执行时间 < 5 分钟

## ⚠️ 注意事项

1. **Mock 策略**：使用统一的 Mock 工厂，避免重复代码
2. **测试隔离**：每个测试用例独立运行，不依赖其他测试
3. **数据清理**：测试后清理测试数据，避免污染
4. **异步处理**：正确处理 Promise 和异步操作
5. **错误断言**：验证错误消息的准确性和用户友好性