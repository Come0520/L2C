# 线索单测试问题修复计划

## 📋 问题分析

### 问题 1：数据库 Schema 不匹配
**错误信息**：`column "address_geo" does not exist`

**根本原因**：
- 代码中查询 `users` 表时包含了 `address_geo` 字段
- 但数据库 schema 中没有这个字段
- 可能是数据库迁移未运行或 schema 定义过时

**影响范围**：
- E2E 测试无法通过
- 可能影响用户地址地理信息功能

### 问题 2：E2E 测试认证失败
**错误信息**：登录后没有跳转到工作台，停留在登录页

**根本原因**：
- 登录成功后路由跳转逻辑可能有问题
- 或者认证状态保存失败
- 或者工作台路由配置不正确

**影响范围**：
- 所有 E2E 测试无法执行
- 无法验证完整的业务流程

### 问题 3：部分单元测试异步问题
**错误信息**：
- `expect(element).toBeDisabled()` - 元素未禁用
- `expect(element).not.toBeInTheDocument()` - 元素仍然存在

**根本原因**：
- React 状态更新是异步的，测试断言时机不对
- `waitFor` 使用方式不正确
- 组件卸载后 DOM 清理时机问题

**影响范围**：
- return-lead-dialog.test.tsx 中 10/25 测试失败
- 影响测试覆盖率的准确性

## 🔧 修复方案

### 修复 1：数据库 Schema 问题

#### 步骤 1.1：检查数据库 Schema 定义
- 查看 `src/shared/api/db/schema.ts` 中 `users` 表的定义
- 确认是否包含 `address_geo` 字段
- 如果不存在，需要添加该字段

#### 步骤 1.2：创建数据库迁移文件
- 在 `drizzle` 目录下创建新的迁移文件
- 添加 `address_geo` 字段到 `users` 表
- 字段类型：`json` 或 `text`

#### 步骤 1.3：运行数据库迁移
- 执行 `pnpm db:push` 或 `pnpm db:migrate`
- 验证字段是否成功添加

#### 步骤 1.4：验证修复
- 重新运行 E2E 测试
- 确认数据库错误已解决

### 修复 2：E2E 测试认证问题

#### 步骤 2.1：检查登录流程
- 查看 `src/app/login/page.tsx` 中的登录逻辑
- 确认登录成功后的跳转逻辑
- 检查是否正确跳转到 `/workbench`

#### 步骤 2.2：检查认证状态保存
- 查看 `src/shared/lib/auth.ts` 中的认证逻辑
- 确认 session 和 token 是否正确保存
- 检查 storageState 配置

#### 步骤 2.3：检查路由配置
- 确认工作台路由是否存在
- 检查路由守卫是否正确配置
- 验证 E2E 测试的预期路径

#### 步骤 2.4：调整 E2E 测试
- 更新 `e2e/auth.setup.ts` 中的登录断言
- 增加更详细的错误日志
- 调整超时时间

### 修复 3：单元测试异步问题

#### 步骤 3.1：调整 return-lead-dialog.test.tsx
- 修复 `should show loading state during submission` 测试
  - 使用 `waitFor` 等待按钮状态更新
  - 增加等待时间
- 修复 `should reset reason after successful return` 测试
  - 调整断言时机，等待对话框关闭
- 修复 `should disable buttons during submission` 测试
  - 确保等待异步状态更新完成

#### 步骤 3.2：优化异步测试模式
- 使用 `act` 或 `waitFor` 包装异步操作
- 增加适当的等待时间
- 确保所有异步状态更新都被捕获

#### 步骤 3.3：验证测试修复
- 重新运行 `return-lead-dialog.test.tsx`
- 确认所有测试通过
- 检查测试覆盖率

## 📝 实施步骤

### 阶段 1：数据库修复（优先级：高）
1. 检查 `users` 表 schema 定义
2. 创建或更新数据库迁移文件
3. 运行数据库迁移
4. 验证数据库 schema 正确性

### 阶段 2：认证流程修复（优先级：高）
1. 检查登录页面代码
2. 检查认证库代码
3. 检查路由配置
4. 修复登录跳转问题
5. 验证 E2E 测试通过

### 阶段 3：单元测试修复（优先级：中）
1. 修复 return-lead-dialog.test.tsx 中的异步问题
2. 优化测试断言时机
3. 验证所有单元测试通过
4. 生成测试覆盖率报告

### 阶段 4：最终验证（优先级：中）
1. 运行所有单元测试
2. 运行所有 E2E 测试
3. 生成完整测试报告
4. 确认测试覆盖率 ≥ 95%

## 🎯 成功标准

- ✅ 数据库 schema 错误已解决
- ✅ E2E 测试能够成功登录并跳转
- ✅ 所有单元测试通过
- ✅ 测试覆盖率 ≥ 95%
- ✅ 所有 E2E 测试通过
- ✅ 无新的测试失败

## ⏱️ 预计时间

- 数据库修复：15 分钟
- 认证流程修复：20 分钟
- 单元测试修复：10 分钟
- 最终验证：15 分钟
- **总计：约 60 分钟**

## ⚠️ 注意事项

1. 在运行数据库迁移前，建议备份数据库
2. 修复认证问题时，注意不要破坏现有功能
3. 单元测试修复时，保持测试的独立性
4. E2E 测试可能需要多次迭代才能完全通过
5. 修复过程中，及时提交代码以便回滚