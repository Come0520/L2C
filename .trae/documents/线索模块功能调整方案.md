# 线索模块功能调整方案

## 1. 需求分析

根据26状态流程图需求，线索模块需要支持完整的26个状态流转，包括：
- 线索阶段（5个状态）：待分配、待跟踪、跟踪中、草签、已失效
- 测量阶段（6个状态）：待测量、测量中-待分配、测量中-分配中、测量中-待上门、测量中-待确认、方案待确认
- 订单处理阶段（5个状态）：待推单、待下单、生产中、备货完成、待发货
- 安装阶段（4个状态）：安装中-待分配、安装中-分配中、安装中-待上门、安装中-待确认
- 财务阶段（4个状态）：待对账、待开发票、待回款、已完成
- 异常状态（3个状态）：已取消、暂停、异常

## 2. 现状分析

### 2.1 前端实现
- 已实现基本的线索管理功能
- 现有9个状态：新建、已分配、跟进中、已Qualify、已报价、已转化、已流失、无效、已关闭
- 有基本的角色权限控制
- 有线索详情、跟踪记录、报价管理等组件

### 2.2 数据库设计
- 现有leads表字段简单，仅包含基本信息
- 缺少跟踪记录、测量信息、安装信息等关联表
- 状态字段设计简单，无法支持26个状态

## 3. 调整方案

### 3.1 前端调整

#### 3.1.1 状态管理调整
- 扩展LEAD_STATUS_CONFIG，添加26个状态的配置
- 调整状态流转逻辑，支持完整的状态转换
- 添加状态变更的触发条件验证

#### 3.1.2 组件调整
- 增强线索详情页面，支持查看完整的状态流转历史
- 添加测量、安装、财务等阶段的操作组件
- 实现附件上传组件，支持不同类型附件的上传和验证
- 添加时效提醒组件，显示各阶段的时效要求和提醒

#### 3.1.3 权限调整
- 扩展角色权限矩阵，支持26个状态下的不同角色操作
- 添加操作权限验证，确保只有授权角色可以执行特定操作
- 实现附件必需性验证，确保特定操作必须上传相应附件

### 3.2 数据库调整

#### 3.2.1 核心表扩展
- 扩展leads表，添加更多字段：
  - customer_info: JSONB类型，存储客户详细信息
  - area_size: 面积
  - budget: 预算范围
  - construction_progress: 施工进度
  - expected_purchase_date: 预计购买日期
  - expected_check_in_date: 预计入住日期

#### 3.2.2 状态字段调整
- 将leads表的status字段从SMALLINT改为VARCHAR(50)，支持完整的状态字符串
- 添加status_history表，记录状态变更历史

#### 3.2.3 关联表创建
- 创建lead_follow_up_records表，存储跟踪记录
- 创建lead_measurement_records表，存储测量信息
- 创建lead_quote_records表，存储报价单信息
- 创建lead_installation_records表，存储安装信息
- 创建lead_attachment_records表，存储附件信息
- 创建lead_approval_records表，存储审批记录

### 3.3 业务逻辑调整

#### 3.3.1 状态流转逻辑
- 实现26个状态的流转逻辑
- 添加状态变更的触发条件验证
- 实现异常状态的处理逻辑

#### 3.3.2 时效控制逻辑
- 实现各阶段的时效控制
- 添加超时提醒和预警机制
- 实现超时处理逻辑

#### 3.3.3 附件管理逻辑
- 实现附件类型和大小验证
- 添加附件上传进度显示
- 实现附件预览和下载功能

## 4. 实施步骤

### 4.1 数据库调整
1. 扩展leads表字段
2. 创建关联表
3. 迁移现有数据

### 4.2 前端调整
1. 扩展状态配置
2. 调整组件实现
3. 实现新的业务逻辑
4. 测试状态流转

### 4.3 测试验证
1. 单元测试
2. 集成测试
3. 端到端测试
4. 性能测试

## 5. 预期效果

- 支持完整的26个状态流转
- 实现详细的角色权限控制
- 支持附件上传和验证
- 实现时效控制和提醒
- 支持异常处理流程
- 提供完整的状态流转历史

## 6. 风险评估

- 数据迁移风险：需要确保现有数据正确迁移到新的表结构
- 状态流转复杂性：26个状态的流转逻辑需要仔细设计和测试
- 性能风险：大量关联表可能影响查询性能，需要优化查询
- 权限管理复杂性：需要确保权限控制的正确性和安全性

## 7. 优化建议

- 使用缓存优化查询性能
- 实现异步处理附件上传
- 添加状态流转的可视化图表
- 实现数据统计和分析功能
- 提供API接口，支持与其他系统集成