# 线索模块测试计划

## 1. 测试现状分析
- 当前测试通过率约为31%（30通过，66失败）
- 主要失败集中在UI交互测试，特别是分页、搜索等功能
- 核心业务逻辑测试可能存在覆盖不足的情况

## 2. 测试目标
- 提高测试通过率至80%以上
- 确保核心业务逻辑的全面覆盖
- 优化测试用例，提高测试的可靠性和稳定性

## 3. 测试范围

### 3.1 核心功能测试
- **线索管理**：创建、更新、删除线索
- **线索分配**：单个分配、批量分配、拒绝分配
- **状态流转**：待分配→待跟进→跟进中→成交/无效
- **跟进记录**：添加、查看跟进记录
- **公海池机制**：释放线索到公海、从公海领取线索
- **线索转化**：将线索转化为客户
- **时间轴**：查看线索综合时间轴

### 3.2 UI组件测试
- 线索列表页：筛选、搜索、分页
- 线索详情页：信息展示、跟进记录添加
- 线索表单：创建、编辑、验证

### 3.3 边界情况测试
- 无效数据输入
- 权限控制
- 并发操作
- 异常情况处理

## 4. 测试策略

### 4.1 修复现有测试
- 针对leads-page-client.test.tsx中的失败测试进行修复
  - 分页功能测试
  - 搜索功能测试
  - 筛选功能测试
- 确保测试用例与实际UI组件匹配
- 优化测试断言，提高测试的可靠性

### 4.2 补充核心功能测试
- 确保每个Server Action都有对应的测试用例
- 测试状态流转的正确性
- 测试权限控制逻辑
- 测试事务处理的正确性

### 4.3 优化测试结构
- 遵循测试金字塔原则：单元测试 > 集成测试 > UI测试
- 分离业务逻辑测试和UI交互测试
- 使用mock数据和模拟服务，减少测试的外部依赖
- 优化测试执行顺序，提高测试效率

## 5. 测试执行步骤

### 5.1 第一阶段：修复现有测试
1. 修复leads-page-client.test.tsx中的分页测试
2. 修复leads-page-client.test.tsx中的搜索测试
3. 修复leads-page-client.test.tsx中的筛选测试
4. 运行测试，验证修复效果

### 5.2 第二阶段：补充核心功能测试
1. 测试线索创建、更新、删除功能
2. 测试线索分配和批量分配功能
3. 测试线索状态流转功能
4. 测试跟进记录管理功能
5. 测试公海池机制
6. 测试线索转化功能
7. 测试时间轴功能

### 5.3 第三阶段：优化测试结构
1. 重构测试用例，提高代码复用性
2. 添加测试辅助函数和工具
3. 优化测试配置，提高测试执行效率
4. 运行完整测试套件，验证测试覆盖率

## 6. 测试验证指标
- 测试通过率 ≥ 80%
- 核心功能测试覆盖率 ≥ 90%
- 测试执行时间 < 5分钟
- 测试失败率 < 20%

## 7. 风险与应对措施
- **UI组件变更**：定期更新UI测试用例，确保与实际组件匹配
- **外部依赖**：使用mock数据和模拟服务，减少外部依赖
- **测试执行时间**：优化测试结构，并行执行测试
- **测试稳定性**：添加重试机制，提高测试的稳定性

## 8. 预期成果
- 提高测试通过率至80%以上
- 确保核心业务逻辑的全面覆盖
- 提供可靠的测试用例，支持持续集成和持续部署
- 为后续功能开发提供测试保障