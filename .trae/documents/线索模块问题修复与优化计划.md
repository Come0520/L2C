## 线索模块问题修复与优化计划

### 1. 类型定义与数据库字段匹配问题

**问题**：
- `LeadItem` 接口中的 `lastStatusChangeBy` 字段与数据库 `last_status_change_by_id` 字段不匹配
- `leadNumber` 字段在前端类型中是必填，但在 `mapDbToLead` 函数中是可选的
- `quoteDetails` 字段在前端类型中有定义，但在 `mapDbToLead` 函数中没有映射

**解决方案**：
- 更新 `mapDbToLead` 函数，添加 `quoteDetails` 字段的映射
- 修复 `lastStatusChangeBy` 字段的映射逻辑，从 `last_status_change_by_id` 关联到用户信息
- 确保 `leadNumber` 字段的正确映射

### 2. 服务层代码不完整

**问题**：
- `getLeadStatusHistory` 方法未实现，但在 `LeadTimeline` 组件中被调用
- `getLeadFollowUps` 方法未实现
- 状态更新逻辑没有验证状态流转是否合法
- 缺少对新增关联表的操作方法

**解决方案**：
- 实现 `getLeadStatusHistory` 方法，调用数据库函数 `get_lead_status_history`
- 实现 `getLeadFollowUps` 方法，查询 `lead_follow_up_records` 表
- 在 `updateLeadStatus` 方法中添加状态流转验证，调用数据库函数 `validate_lead_status_transition`
- 实现对 `lead_measurement_records`、`lead_quote_records`、`lead_installation_records` 等关联表的 CRUD 方法

### 3. 数据库迁移问题

**问题**：
- 触发器 `update_lead_status_metadata` 中，`NEW.assigned_to_id` 可能为 NULL，导致 `status_history` 表插入失败
- 存储过程 `validate_lead_status_transition` 只有基本验证逻辑，没有实现完整的 26 状态流转规则
- 缺少 `lead_follow_up_records` 表的创建

**解决方案**：
- 修改触发器 `update_lead_status_metadata`，使用当前登录用户 ID 作为 `changed_by_id`
- 完善存储过程 `validate_lead_status_transition`，实现完整的 26 状态流转规则
- 添加 `lead_follow_up_records` 表的创建语句

### 4. 前端组件问题

**问题**：
- `LeadTimeline` 组件中，`getLeadFollowUps` 方法被注释掉，只能显示状态变更记录
- 状态名称显示的是英文，而不是中文标签

**解决方案**：
- 取消注释 `getLeadFollowUps` 方法调用，实现完整的时间线功能
- 使用 `LEAD_STATUS_CONFIG` 中的中文标签替换英文状态名称
- 添加对跟进记录、测量记录、安装记录等的显示支持

### 5. 权限控制问题

**问题**：
- 虽然 `LEAD_STATUS_CONFIG` 中定义了角色权限，但在服务层没有实现权限验证
- 缺少对用户角色的检查

**解决方案**：
- 在服务层添加权限验证逻辑，检查当前用户是否具有执行状态变更的权限
- 实现 `checkPermission` 方法，根据用户角色和当前状态验证操作权限

### 6. 时效控制问题

**问题**：
- 虽然定义了 `LEAD_STATUS_TIMELIMIT_CONFIG`，但没有实现相应的时效提醒和超时处理逻辑
- 缺少定时任务来检查超时情况

**解决方案**：
- 实现时效检查逻辑，定期检查线索状态是否超时
- 添加超时提醒功能，通过系统通知或邮件提醒相关人员
- 实现超时处理逻辑，根据配置执行相应的处罚或自动操作

### 7. 附件上传问题

**问题**：
- 服务层缺少对附件的管理方法
- 状态变更时，没有验证必需的附件是否已上传

**解决方案**：
- 实现附件管理方法，包括上传、下载、删除等
- 在状态变更前，验证必需的附件是否已上传
- 实现附件与状态变更的关联逻辑

### 8. 数据一致性问题

**问题**：
- 缺少对关联表数据的同步更新机制

**解决方案**：
- 实现数据同步逻辑，确保线索主表与关联表的数据一致性
- 例如，当线索状态变更为 "测量完成" 时，自动更新 `lead_measurement_records` 表中的状态

## 实现步骤

1. 修复数据库迁移问题，添加缺失的表和完善存储过程
2. 更新类型定义，确保与数据库字段匹配
3. 实现完整的服务层方法，包括状态流转验证和权限检查
4. 完善前端组件，实现完整的时间线和状态显示功能
5. 实现时效控制和提醒功能
6. 实现附件管理和验证逻辑
7. 测试所有功能，确保数据一致性和流程完整性

通过以上修复和优化，线索模块将能够完整支持26状态流程图的所有需求，包括状态流转、权限控制、时效管理、附件管理等功能。