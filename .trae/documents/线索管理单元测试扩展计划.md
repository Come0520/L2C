# 线索管理单元测试扩展计划

## 现有测试覆盖情况
目前线索管理测试覆盖了基本功能：
- 线索列表渲染
- 状态标签筛选
- 创建线索对话框
- 分页大小变更
- 分页导航
- 搜索功能

## 边缘场景测试设计

### 1. 数据验证相关测试

#### 1.1 手机号重复创建线索
- **测试目标**：验证系统能正确处理重复手机号的线索创建
- **测试步骤**：
  1. 模拟已存在的线索数据
  2. 尝试使用相同手机号创建新线索
  3. 验证返回错误信息
- **预期结果**：返回 "该手机号已存在线索，请勿重复录入" 错误

#### 1.2 手机号格式验证
- **测试目标**：验证系统对无效手机号的处理
- **测试步骤**：
  1. 尝试使用不同格式的无效手机号创建线索
  2. 包括：少于11位、多于11位、包含字母、特殊字符等
- **预期结果**：返回手机号格式错误信息

#### 1.3 必填字段缺失
- **测试目标**：验证必填字段缺失时的错误处理
- **测试步骤**：
  1. 尝试创建缺少必填字段的线索（如客户姓名、手机号）
  2. 验证返回的错误信息
- **预期结果**：返回相应字段的必填错误

### 2. 状态流转相关测试

#### 2.1 无效状态流转
- **测试目标**：验证系统阻止无效的状态流转
- **测试步骤**：
  1. 模拟处于待分配状态的线索
  2. 尝试直接将其转换为成交状态
- **预期结果**：返回错误信息，阻止无效流转

#### 2.2 重复操作处理
- **测试目标**：验证系统对重复操作的处理
- **测试步骤**：
  1. 模拟已处于跟进中状态的线索
  2. 再次尝试开始跟进
- **预期结果**：返回提示信息 "该线索已在跟进中"

#### 2.3 只有待跟进状态可开始跟进
- **测试目标**：验证只有待跟进状态的线索可以开始跟进
- **测试步骤**：
  1. 模拟不同状态的线索（待分配、跟进中、已成交）
  2. 尝试对其调用开始跟进操作
- **预期结果**：只有待跟进状态的线索可以成功开始跟进

### 3. 权限相关测试

#### 3.1 无权限访问
- **测试目标**：验证无权限用户无法访问线索列表
- **测试步骤**：
  1. 模拟无权限用户会话
  2. 尝试调用getLeads操作
- **预期结果**：返回权限不足错误

#### 3.2 权限不足时的操作
- **测试目标**：验证权限不足时无法执行相关操作
- **测试步骤**：
  1. 模拟只有查看权限的用户
  2. 尝试执行创建、分配等操作
- **预期结果**：返回权限不足错误

### 4. 数据边界相关测试

#### 4.1 空数据列表
- **测试目标**：验证系统对空数据列表的处理
- **测试步骤**：
  1. 模拟空的线索列表数据
  2. 渲染线索页面
  3. 验证页面显示正常，无错误
- **预期结果**：显示 "共找到 0 条线索"，无崩溃

#### 4.2 大量数据分页
- **测试目标**：验证大量数据下的分页功能
- **测试步骤**：
  1. 模拟包含50条数据的线索列表
  2. 测试不同分页大小下的显示
- **预期结果**：分页正确，数据显示正常

#### 4.3 特殊字符搜索
- **测试目标**：验证特殊字符搜索的处理
- **测试步骤**：
  1. 输入包含特殊字符的搜索关键词
  2. 验证搜索功能正常，无崩溃
- **预期结果**：搜索功能正常执行，返回匹配结果或空结果

### 5. 业务规则相关测试

#### 5.1 线索释放到公海池
- **测试目标**：验证线索释放到公海池功能
- **测试步骤**：
  1. 模拟已分配的线索
  2. 执行释放到公海操作
  3. 验证线索状态和分配情况
- **预期结果**：线索状态变为待分配，分配销售为空

#### 5.2 从公海池领取线索
- **测试目标**：验证从公海池领取线索功能
- **测试步骤**：
  1. 模拟公海池中的线索
  2. 执行领取操作
  3. 验证线索分配情况
- **预期结果**：线索成功分配给当前用户，状态变为待跟进

#### 5.3 线索分配给非销售角色
- **测试目标**：验证线索只能分配给销售角色
- **测试步骤**：
  1. 模拟非销售角色用户
  2. 尝试将线索分配给该用户
- **预期结果**：返回 "只能分配给销售顾问" 错误

#### 5.4 批量分配边界情况
- **测试目标**：验证批量分配的边界情况
- **测试步骤**：
  1. 尝试批量分配0条线索
  2. 尝试批量分配大量线索
- **预期结果**：系统能正确处理，返回相应提示

### 6. 错误处理相关测试

#### 6.1 无效的线索ID
- **测试目标**：验证无效线索ID的处理
- **测试步骤**：
  1. 使用无效的线索ID调用获取详情、更新等操作
- **预期结果**：返回 "线索不存在" 错误

#### 6.2 数据库查询失败模拟
- **测试目标**：验证数据库查询失败时的错误处理
- **测试步骤**：
  1. 模拟数据库查询失败
  2. 调用相关操作
- **预期结果**：返回适当的错误信息，系统不崩溃

## 测试文件结构

```
src/features/leads/__tests__/
├── leads-page-client.test.tsx       # 现有测试文件
├── lead-validation.test.tsx          # 新增：数据验证测试
├── lead-status-flow.test.tsx         # 新增：状态流转测试
├── lead-permissions.test.tsx         # 新增：权限测试
├── lead-boundary.test.tsx            # 新增：数据边界测试
├── lead-business-rules.test.tsx      # 新增：业务规则测试
└── lead-error-handling.test.tsx      # 新增：错误处理测试
```

## 实现策略

1. **使用现有测试框架**：基于Vitest和React Testing Library
2. **Mock策略**：
   - 使用vi.mock模拟数据库操作
   - 模拟session权限
   - 模拟API返回值
3. **测试数据**：
   - 使用工厂函数生成测试数据
   - 覆盖不同状态和场景
4. **断言策略**：
   - 验证返回值正确性
   - 验证状态变更正确性
   - 验证错误信息准确性
   - 验证函数调用次数

## 预期收益

1. **提高测试覆盖率**：从基本功能覆盖扩展到边缘场景
2. **增强系统稳定性**：提前发现潜在的边界问题
3. **提升代码质量**：通过测试驱动开发，优化代码结构
4. **降低维护成本**：减少上线后的bug修复
5. **增强团队信心**：确保系统在各种场景下都能正常工作

## 实施计划

1. 先实现数据验证和状态流转相关测试
2. 然后实现权限和数据边界相关测试
3. 最后实现业务规则和错误处理相关测试
4. 每个测试文件独立实现，便于维护和扩展

通过以上扩展测试，我们将全面覆盖线索管理的各种边缘场景，确保系统在各种情况下都能稳定运行。