# 统一中间件逻辑实现计划

## 问题分析

目前项目存在两个中间件入口，导致逻辑分散、维护困难：
1. `src/middleware.ts` - 负责路由守卫和权限验证
2. `src/lib/supabase/middleware.ts` - 负责会话刷新和基础路由保护

两个中间件都有公共路由定义，但不一致，且都包含路由保护逻辑，实现方式不同。

## 解决方案

采用责任链模式统一中间件逻辑，保持职责单一但入口统一。

## 实施步骤

### 1. 合并公共路由配置
- 创建统一的公共路由配置源
- 合并两个中间件的公共路由定义
- 确保所有公共路由在一个地方维护

### 2. 实现责任链模式
- 创建中间件责任链接口
- 实现不同职责的中间件处理程序：
  - 会话刷新中间件
  - 认证中间件
  - 权限验证中间件
- 确保中间件执行顺序明确

### 3. 统一中间件入口
- 修改 `src/middleware.ts` 作为唯一入口
- 集成会话刷新逻辑
- 集成权限矩阵验证
- 移除重复的路由保护逻辑

### 4. 清理冗余代码
- 确保只有一个中间件入口
- 移除重复的路由检查逻辑
- 确保代码符合 VibeCoding 敏捷 5S 规则

## 代码实现要点

1. **统一公共路由配置**
   - 将公共路由定义移至单独的配置文件
   - 确保所有中间件使用同一公共路由源

2. **责任链设计**
   ```typescript
   // 中间件处理程序接口
   interface MiddlewareHandler {
     handle(request: NextRequest, response: NextResponse, next: () => Promise<NextResponse>): Promise<NextResponse>;
   }
   
   // 会话刷新中间件
   class SessionRefreshMiddleware implements MiddlewareHandler {
     // 实现会话刷新逻辑
   }
   
   // 认证中间件
   class AuthMiddleware implements MiddlewareHandler {
     // 实现认证逻辑
   }
   
   // 权限验证中间件
   class PermissionMiddleware implements MiddlewareHandler {
     // 实现权限验证逻辑
   }
   ```

3. **中间件执行链**
   ```typescript
   // 在主中间件中执行责任链
   const handlers = [
     new SessionRefreshMiddleware(),
     new AuthMiddleware(),
     new PermissionMiddleware()
   ];
   
   // 执行责任链
   async function executeMiddlewareChain(request: NextRequest): Promise<NextResponse> {
     let response = NextResponse.next();
     
     for (const handler of handlers) {
       response = await handler.handle(request, response, async () => response);
       if (response.status !== 200 && response.status !== 304) {
         return response; // 如果中间件返回非成功响应，中断链
       }
     }
     
     return response;
   }
   ```

## 验收标准

1. 只保留一个中间件入口 `src/middleware.ts`
2. 会话刷新逻辑与权限矩阵合并到统一入口
3. 公开路径名单合并为单一配置源
4. 使用责任链模式分离认证、权限、会话刷新等职责模块
5. 中间件执行顺序明确且可测试
6. 权限判断无遗漏
7. 性能无明显下降

## 依赖关系

- 需要确保 `@supabase/ssr` 和相关依赖正确配置
- 需要确保权限矩阵配置 `src/config/route-access.ts` 被正确引用
- 需要确保用户角色和权限工具函数 `@/utils/permissions` 被正确使用

## 风险评估

1. **性能风险**：中间件链执行可能会增加轻微的延迟，但通过合理的设计可以将影响降到最低
2. **兼容性风险**：需要确保新的中间件逻辑与现有功能兼容
3. **测试风险**：需要确保所有路由都经过充分测试，特别是权限验证部分

## 测试计划

1. 测试公共路由访问 - 确保无需登录即可访问
2. 测试认证路由访问 - 确保未登录用户被重定向到登录页
3. 测试权限验证 - 确保不同角色的用户只能访问其权限范围内的路由
4. 测试会话刷新 - 确保用户会话在访问受保护路由时被正确刷新
5. 测试中间件执行顺序 - 确保中间件按照预期顺序执行

## 代码参考

- `slideboard-frontend/src/middleware.ts` - 现有路由守卫
- `slideboard-frontend/src/lib/supabase/middleware.ts` - 现有会话刷新
- `slideboard-frontend/src/config/route-access.ts` - 权限矩阵配置