# 解决代办问题清单的实施计划

## 1. 分享令牌安全增强

### 问题描述
令牌生成需要改为高强度随机并在库中存储哈希，增加作用域与使用次数限制

### 实施步骤
1. **增强令牌生成算法**：使用更安全的随机生成方法
2. **添加令牌作用域**：在share_tokens表中添加scope字段
3. **添加使用次数限制**：添加usage_count和max_usage字段
4. **修改令牌验证逻辑**：检查使用次数和作用域
5. **更新令牌管理API**：支持更新令牌属性

### 涉及文件
- `src/app/api/sharing/tokens/route.ts`
- `src/app/api/sharing/validate/route.ts`
- `src/app/api/sharing/tokens/[id]/route.ts`

## 2. 合并重复SlideCard组件

### 问题描述
合并重复的SlideCard组件，统一使用Toast与日志记录，移除alert

### 实施步骤
1. **确认组件状态**：检查是否只有一个SlideCard组件
2. **统一日志记录**：确保所有组件都使用logsService记录日志
3. **移除alert使用**：使用PaperToast替代alert
4. **更新引用**：确保所有使用SlideCard的地方都引用正确的组件

### 涉及文件
- `src/components/shared/slide-card.tsx`
- 检查其他可能使用SlideCard的文件

## 3. 统一错误与提示通道

### 问题描述
去除散落的alert、console.warn，统一使用Toast/通知组件

### 实施步骤
1. **查找所有alert使用**：使用grep查找所有alert调用
2. **替换为Toast**：将alert替换为PaperToast组件
3. **统一console.warn**：添加自定义警告处理函数
4. **添加全局错误处理**：在app/layout.tsx中添加全局错误边界

### 涉及文件
- 全局搜索alert和console.warn
- `src/app/layout.tsx`

## 4. TypeScript错误集中修复

### 问题描述
修正Blob构造参数、Record<UserRole, …>键覆盖完整、debounce泛型签名

### 实施步骤
1. **修复Blob构造参数**：检查orders/status/[status]/page.tsx
2. **修复Record<UserRole, …>键**：确保user、pro、admin等角色都有定义
3. **修复debounce泛型签名**：调整lead-filters.tsx中的debounce函数调用

### 涉及文件
- `src/app/orders/status/[status]/page.tsx`
- `src/app/page.tsx`
- `src/features/leads/components/list/lead-filters.tsx`

## 5. ESLint警告清理

### 问题描述
消除react-hooks/exhaustive-deps等警告，保持eslint --max-warnings=0通过

### 实施步骤
1. **修复react-hooks/exhaustive-deps警告**：在useCallback和useEffect中添加正确的依赖项
2. **修复其他ESLint警告**：根据ESLint输出逐一修复
3. **运行lint检查**：确保所有警告都已消除

### 涉及文件
- `src/features/leads/components/list/lead-filters.tsx`
- 其他ESLint警告涉及的文件

## 6. 统一角色与权限的单一真相源

### 问题描述
合并并统一UserRole/ROLE_PERMISSIONS定义，避免在上下文与类型中重复

### 实施步骤
1. **移除重复定义**：删除auth-context中重复的UserRole定义
2. **统一导入**：确保所有文件都从user.ts导入UserRole
3. **更新权限映射**：确保ROLE_PERMISSIONS覆盖所有角色

### 涉及文件
- `src/contexts/auth-context.tsx`
- `src/types/user.ts`
- 所有使用UserRole的文件

## 7. 建立通用数据库字段映射层

### 问题描述
统一前端驼峰到数据库蛇形的转换，减少各服务手动映射分散

### 实施步骤
1. **创建映射工具**：实现通用的驼峰到蛇形转换函数
2. **应用到现有服务**：更新logs.client.ts等服务使用映射工具
3. **添加类型支持**：为映射函数添加泛型支持

### 涉及文件
- `src/services/logs.client.ts`
- `src/types/logs.ts`
- 创建新的映射工具文件

## 8. 优化实时订阅

### 问题描述
将变更处理提取为纯函数并用useRef持有，必要时做节流/批处理，降低重渲染

### 实施步骤
1. **重构useRealtimeMeasurement**：提取变更处理为纯函数
2. **使用useRef持有函数**：避免依赖变化导致的重订阅
3. **添加节流/批处理**：减少频繁更新导致的重渲染
4. **测试性能改进**：确保实时订阅性能提升

### 涉及文件
- `src/hooks/useRealtimeMeasurement.ts`

## 9. React Query缓存策略优化

### 问题描述
为高频列表设置合理的staleTime/gcTime并复用缓存，统一不同视图的体验

### 实施步骤
1. **分析查询模式**：识别高频查询和共享查询
2. **设置缓存策略**：为不同类型的查询设置合理的staleTime和gcTime
3. **实现缓存键共享**：确保相同资源在不同视图中共享缓存
4. **添加预取逻辑**：对常用资源进行预取

### 涉及文件
- 所有使用React Query的hooks文件
- `src/providers/query-provider.tsx`

## 10. 统一主题色与基础组件风格

### 问题描述
将PaperCard、PaperBadge、PaperTable默认色统一到paper/ink语义体系，完善交互状态

### 实施步骤
1. **统一组件颜色**：更新UI组件使用paper/ink语义色
2. **完善交互状态**：添加focus/hover/disabled状态样式
3. **更新主题配置**：在globals.css中添加统一的主题变量
4. **测试视觉一致性**：确保所有组件风格统一

### 涉及文件
- `src/components/ui/paper-card.tsx`
- `src/components/ui/paper-badge.tsx`
- `src/components/ui/paper-table.tsx`
- `src/app/globals.css`

## 11. 登录页风格统一

### 问题描述
替换默认灰/渐变色为paper/ink语义色，统一视觉基调

### 实施步骤
1. **更新登录页样式**：使用paper/ink语义色替代默认颜色
2. **添加暖宣纸主题**：实现暖宣纸视觉效果
3. **统一表单样式**：确保登录表单符合设计规范
4. **测试响应式设计**：确保在不同设备上显示正常

### 涉及文件
- `src/app/(auth)/login/page.tsx`

## 12. SEO与PWA基线

### 问题描述
补充<meta name="description">与<meta name="theme-color">，新增public/manifest.json与maskable图标

### 实施步骤
1. **添加SEO元标签**：在layout.tsx中添加description和theme-color
2. **创建manifest.json**：配置PWA相关信息
3. **添加maskable图标**：生成并添加适合不同设备的图标
4. **测试PWA功能**：确保可以正常安装和运行

### 涉及文件
- `src/app/layout.tsx`
- 创建public/manifest.json
- 添加图标文件到public目录

## 13. 安全与最佳实践

### 问题描述
配置CSP以防XSS，结合Lighthouse CI断言修复对应项

### 实施步骤
1. **配置CSP**：在next.config.js中添加内容安全策略
2. **运行Lighthouse检查**：使用Lighthouse CI进行性能和安全检查
3. **修复Lighthouse问题**：根据报告修复对应项
4. **定期检查**：添加Lighthouse检查到CI/CD流水线

### 涉及文件
- `next.config.js`
- `lighthouserc.json`
- `.github/workflows/ci-cd.yml`

## 14. 其他问题

### 剩余问题处理
- **启用Husky pre-commit钩子**：配置lint-staged和pre-commit钩子
- **抽离路由权限映射**：将路由-角色/权限映射抽到独立配置
- **统一API路由Supabase客户端**：确保所有API路由使用服务端createClient
- **管理员判定一致性**：统一LEAD_ADMIN作为管理员的判定逻辑
- **Supabase类型与错误处理落地**：生成完整数据库类型并应用
- **CI/CD清理与对齐**：移除或隔离slideboard-backend相关步骤
- **移除邮箱渠道与mailto**：删除mailto链接，替换为站内帮助
- **页面可访问性增强**：添加main landmark和aria属性
- **长列表性能优化**：添加虚拟滚动和骨架态
- **流式首屏优化**：使用Suspense和Streaming SSR
- **品牌与文案统一**：统一产品称谓和系统命名

### 实施顺序
根据项目优先级和依赖关系，分阶段实施上述剩余问题

## 15. 测试与验证

### 验证步骤
1. **运行类型检查**：确保tsc --noEmit通过
2. **运行lint检查**：确保eslint --max-warnings=0通过
3. **运行测试**：确保所有测试通过
4. **手动测试**：验证关键功能正常工作
5. **性能测试**：使用Lighthouse验证性能提升
6. **安全测试**：检查CSP和其他安全措施

### 涉及命令
```bash
npm run typecheck
npm run lint
npm run test
npm run build
```

## 16. 部署与监控

### 部署步骤
1. **更新CI/CD配置**：确保流水线正确处理新的构建需求
2. **部署到测试环境**：进行集成测试
3. **部署到生产环境**：监控部署过程
4. **设置监控**：配置日志和性能监控

### 监控指标
- 构建成功率
- 页面加载时间
- API响应时间
- 错误率
- 用户满意度

# 预期效果

通过实施上述计划，预计将：
1. 提高系统安全性和可靠性
2. 改善代码质量和可维护性
3. 提升用户体验和视觉一致性
4. 增强性能和可访问性
5. 统一开发规范和最佳实践

# 后续维护

1. **定期代码审查**：确保新代码符合规范
2. **持续集成**：保持CI/CD流水线畅通
3. **性能监控**：定期检查系统性能
4. **安全审计**：定期进行安全检查和更新
5. **用户反馈**：收集并响应用户反馈

该计划将帮助我们系统地解决代办问题清单中的所有问题，提高项目的整体质量和可维护性。