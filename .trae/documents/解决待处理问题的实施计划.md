# 分享令牌安全性改进计划

## 问题分析

当前分享令牌实现存在安全风险：

* 令牌以明文形式存储在数据库中（`slideboard-frontend/src/app/api/sharing/tokens/route.ts:37`）

* 令牌生成使用 UUID + 时间戳组合（`slideboard-frontend/src/app/api/sharing/tokens/route.ts:27`）

* 验证时直接比较明文令牌（`slideboard-frontend/src/app/api/sharing/validate/route.ts:25`）

* 若数据库或日志泄露，攻击者可直接使用令牌访问资源

## 解决方案

1. **安装密码学哈希库**：使用 `bcrypt` 或 `argon2` 对令牌进行安全哈希
2. **修改令牌生成逻辑**：

   * 保持现有令牌生成算法不变（UUID + 时间戳）

   * 生成明文令牌后，计算其哈希值

   * 将哈希值存储到数据库，明文令牌仅返回给用户
3. **修改验证逻辑**：

   * 接收用户提供的明文令牌

   * 从数据库获取哈希值

   * 使用哈希库的比较函数验证令牌

## 实施步骤

### 1. 安装依赖

```bash
npm install bcrypt @types/bcrypt
```

### 2. 修改令牌生成 API

**文件**：`slideboard-frontend/src/app/api/sharing/tokens/route.ts`

* 导入 bcrypt 库

* 在生成令牌后添加哈希步骤

* 存储哈希值到数据库

### 3. 修改令牌验证 API

**文件**：`slideboard-frontend/src/app/api/sharing/validate/route.ts`

* 导入 bcrypt 库

* 修改验证逻辑，使用 `bcrypt.compare()` 比较令牌

### 4. 修改令牌管理 API（如适用）

**文件**：`slideboard-frontend/src/app/api/sharing/tokens/[id]/route.ts`

* 确保任何涉及令牌比较的逻辑都使用哈希比较

## 安全考虑

* 使用 bcrypt 默认工作因子（12），平衡安全性和性能

* 保持令牌生成的随机性（UUID + 时间戳）

* 仅在必要时返回明文令牌（仅在生成时返回给创建者）

* 数据库中始终存储哈希值，不记录明文令牌

## 测试要点

1. 令牌生成功能正常
2. 令牌验证功能正常
3. 数据库中存储的是哈希值而非明文
4. 无效令牌被正确拒绝
5. 过期令牌被正确拒绝
6. 禁用令牌被正确拒绝

## 预期效果

* 提高令牌安全性，即使数据库泄露，攻击者也无法直接使用哈希值

* 符合安全最佳实践

* 保持现有 API 兼容性

* 对用户体验无影响

