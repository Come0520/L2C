# 采购单模块整改执行计划

## 📋 整改范围

根据[整改计划.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/整改计划.md#L1757-2232)的要求，本次整改将完成以下工作：

### 阶段一：数据库Schema修正（P0 - 阻塞项）

#### 1.1 补充 `purchase_orders` 表（13个缺失字段）
- 售后溯源字段：`after_sales_id`
- 供应商对接字段：`external_po_no`, `supplier_quote_img`, `sent_method`, `sent_at`
- 生产跟踪字段：`produced_at`
- 物流字段：`logistics_company`, `logistics_no`, `shipped_at`, `delivered_at`
- 付款状态：`payment_status`

#### 1.2 补充 `purchase_order_items` 表（6个缺失字段）
- 关联字段：`order_item_id`, `product_id`, `product_sku`, `category`
- 尺寸与成本：`width`, `height`, `subtotal`

#### 1.3 状态枚举标准化
- 定义成品采购单状态枚举：`DRAFT`, `IN_PRODUCTION`, `READY`, `SHIPPED`, `DELIVERED`, `CANCELLED`
- 定义面料采购单状态枚举：`DRAFT`, `IN_PRODUCTION`, `DELIVERED`, `STOCKED`, `CANCELLED`
- 更新 `status` 字段使用对应枚举

### 阶段二：核心业务逻辑实现（P0 - Critical）

#### 2.1 订单拆单逻辑完善
- 创建 `POSplitService` 服务类
- 实现按供应商和商品类型拆分逻辑
- 自动判断采购单类型（FINISHED/FABRIC/STOCK）
- 在订单状态变更时自动触发拆单

#### 2.2 状态联动逻辑实现
- 创建 `POStatusAggregator` 服务类
- 实现采购单状态变更驱动订单状态的逻辑
- 定义状态判定规则（成品PO、面料PO、所有PO）

#### 2.3 物流管理功能
- 创建物流信息填写 Server Action：`addPOLogistics`
- 创建物流填写弹窗组件：`AddLogisticsDialog`
- 实现物流信息填写后自动变更为"已发货"状态

#### 2.4 售后补件创建
- 在 `AfterSalesService` 中添加补件采购单创建逻辑
- 实现售后工单定责为"补件"时自动生成采购单

### 阶段三：UI/UX组件完善（P1）

#### 3.1 列表页增强
- 添加筛选条件（时间范围、供应商、付款状态）
- 添加批量操作（批量确认下单）
- 优化分页组件

#### 3.2 详情页完善
- 添加状态进度条可视化展示
- 集成供应商确认截图上传组件
- 添加物流信息卡片
- 显示操作日志

## 🎯 验收标准

### 功能验收
- ✅ 订单确认后自动生成采购单（按供应商拆分）
- ✅ 采购单状态变更正确驱动订单状态
- ✅ 物流信息填写后状态自动变为"已发货"
- ✅ 售后补件工单自动生成补件采购单
- ✅ 采购单详情页完整展示所有信息

### 数据完整性验收
- ✅ 所有采购单都有 `order_item_id` 关联
- ✅ 物流信息字段不为空（已发货状态下）
- ✅ 付款状态与财务模块一致

### 性能验收
- ✅ 订单拆单响应时间 <2秒（10+商品）
- ✅ 列表页加载时间 <1秒（100条记录）

## 📁 涉及文件

### 数据库Schema
- `src/shared/api/schema/supply-chain.ts` - 添加缺失字段和枚举

### 服务层
- `src/services/po-split.service.ts` - 新建订单拆单服务
- `src/services/po-status-aggregator.service.ts` - 新建状态联动服务
- `src/services/supply-chain.service.ts` - 完善现有服务
- `src/services/order.service.ts` - 添加拆单触发逻辑
- `src/services/after-sales.service.ts` - 添加售后补件逻辑

### Server Actions
- `src/features/supply-chain/actions/po-actions.ts` - 添加物流管理API

### UI组件
- `src/features/supply-chain/components/add-logistics-dialog.tsx` - 新建物流填写弹窗
- 列表页和详情页组件增强

### 枚举定义
- `src/shared/api/schema/enums.ts` - 添加采购单状态枚举

## ⚠️ 风险提示

1. **严重**：订单拆单逻辑错误导致采购单数据不准 - 需与订单模块深度协调
2. **严重**：状态联动规则理解偏差 - 第一周完成后必须业务方验证
3. **高**：售后补件场景复杂 - 可能需要多轮迭代
4. **高**：物流API集成成本 - 初期可仅支持手工填写

## 📅 执行时间表

**第一周**：Schema + 拆单 + 状态联动 → 目标完成度 70%
- Day 1：数据库Schema修正（添加19个字段）
- Day 2：定义状态枚举，生成migration
- Day 3-4：实现订单拆单逻辑
- Day 5-6：实现状态联动逻辑
- Day 7：单元测试（拆单 + 联动）

**第二周**：物流 + 售后 + UI → 目标完成度 85%+
- Day 8：物流管理功能（API + 组件）
- Day 9：售后补件创建
- Day 10-11：UI组件完善（列表页 + 详情页）
- Day 12：E2E测试（完整流程）
- Day 13：性能优化与Bug修复
- Day 14：文档与交付