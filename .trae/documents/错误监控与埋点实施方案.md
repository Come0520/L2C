# 错误监控与埋点实施方案

## 1. Sentry 配置完善

### 1.1 检查现有配置
- 当前 Sentry 配置已存在于 `sentry.client.config.ts`
- 已配置基本 DSN、采样率和会话重放

### 1.2 优化配置项
- **环境区分**：根据 NODE_ENV 自动设置环境
- **采样率优化**：生产环境降低采样率，开发环境保持 100%
- **用户关联**：关联用户信息到错误报告
- **自定义上下文**：添加业务相关的上下文信息

## 2. 埋点工具实现

### 2.1 新建埋点工具文件
- 在 `src/utils` 目录下创建 `analytics.ts` 文件
- 封装埋点相关功能，支持事件追踪和耗时统计

### 2.2 埋点功能设计
- **事件追踪**：`trackEvent(category, action, label, data)`
- **页面访问**：`trackPageView(pageName, data)`
- **耗时统计**：`startTimer(key)` 和 `stopTimer(key, data)`
- **错误追踪**：集成 Sentry 错误报告

### 2.3 埋点工具特点
- 支持批量发送，减少网络请求
- 支持环境区分，开发环境可选择不发送
- 支持自定义数据扩展
- 提供类型安全的 API

## 3. 关键页面埋点实施

### 3.1 埋点范围
- 仪表盘页面访问和交互
- 订单创建和状态变更
- 线索管理和转化
- 财务相关操作
- 系统设置和权限变更

### 3.2 埋点集成方式
- 使用 React 组件生命周期或 hooks 集成
- 对于 App Router，使用 `useEffect` 在页面组件中埋点
- 对于关键交互，直接调用埋点函数

## 4. 验证和测试

### 4.1 本地测试
- 开发环境下，控制台输出埋点信息
- 使用 Sentry 开发工具验证错误报告

### 4.2 生产验证
- 检查 Sentry 控制台是否收到错误和事件
- 验证用户行为路径是否完整
- 确认错误堆栈信息是否详细

## 5. 实施步骤

1. **完善 Sentry 配置**：修改 `sentry.client.config.ts`，添加环境区分和用户关联
2. **创建埋点工具**：实现 `analytics.ts` 埋点工具
3. **集成埋点工具**：在关键页面和组件中添加埋点
4. **测试验证**：本地测试和生产验证
5. **文档更新**：更新项目文档，说明埋点使用方法

## 6. 预期效果

- 完整的错误监控，包括错误堆栈、用户上下文和行为路径
- 关键业务操作的埋点数据，用于分析用户行为
- 性能指标的收集，用于优化系统性能
- 可在 Sentry 控制台查看详细的错误和事件数据

## 7. 代码结构

```
src/
├── utils/
│   ├── analytics.ts      # 埋点工具
│   └── index.ts          # 工具导出
├── sentry.client.config.ts  # Sentry 客户端配置
└── sentry.server.config.ts  # Sentry 服务端配置
```