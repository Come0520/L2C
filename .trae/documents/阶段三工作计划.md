# 阶段三工作计划

## 目标
补充关键业务流程E2E测试，优化测试工具配置，实现测试覆盖率≥80%的目标。

## 任务分解与执行顺序

### 1. 测试工具优化 (1天)

#### 1.1 优化 vitest.config.ts
- 添加更精细的覆盖率配置
- 配置测试超时时间
- 添加测试并行度设置

#### 1.2 创建测试工具辅助函数
- **src/test-utils/testHelpers.ts** - 通用测试辅助函数
  - 封装常用的测试断言和操作
  - 提供统一的错误处理机制
  - 实现测试数据的清理和初始化

- **src/test-utils/testFixtures.ts** - 测试数据fixtures
  - 定义通用的测试数据结构
  - 提供可复用的测试数据模板
  - 支持不同环境下的测试数据配置

#### 1.3 创建测试数据生成器
- **src/test-utils/factories/leadFactory.ts** - 线索数据工厂
  - 生成符合业务规则的线索数据
  - 支持自定义属性和关联关系
  - 实现批量数据生成

- **src/test-utils/factories/orderFactory.ts** - 订单数据工厂
  - 生成完整的订单数据结构
  - 支持不同状态的订单生成
  - 实现订单与其他实体的关联

- **src/test-utils/factories/userFactory.ts** - 用户数据工厂
  - 生成不同角色的用户数据
  - 支持权限和团队关联
  - 实现用户认证信息生成

### 2. 核心业务流程E2E测试 (2天)

#### 2.1 业务流程测试（顺序执行）

- **e2e/lead-to-quote.spec.ts**
  - 测试线索创建 → 分配 → 报价完整流程
  - 验证数据流转正确性
  - 测试不同角色的操作权限

- **e2e/quote-to-order.spec.ts**
  - 测试报价 → 审核 → 订单创建流程
  - 验证状态流转逻辑
  - 测试审批规则和通知机制

- **e2e/order-to-measurement.spec.ts**
  - 测试订单 → 派单 → 测量流程
  - 验证技师分配逻辑
  - 测试测量数据的完整性

- **e2e/measurement-to-installation.spec.ts**
  - 测试测量 → 生产 → 安装流程
  - 验证完整服务链的数据一致性
  - 测试安装排程和状态更新

- **e2e/installation-to-reconciliation.spec.ts**
  - 测试安装 → 验收 → 对账流程
  - 验证财务闭环逻辑
  - 测试对账数据的准确性

#### 2.2 其他核心功能E2E测试

- **e2e/user-permissions.spec.ts**
  - 测试7种角色的权限控制
  - 验证不同角色的访问权限
  - 测试权限变更后的实时生效

- **e2e/points-system.spec.ts**
  - 测试积分获取机制
  - 验证积分兑换流程
  - 测试积分计算规则

- **e2e/share-workflow.spec.ts**
  - 测试分享链接生成逻辑
  - 验证分享访问验证机制
  - 测试分享权限控制

### 3. CI/CD测试集成 (0.5天)

#### 3.1 配置GitHub Actions测试工作流
- **.github/workflows/test.yml**
  - 添加单元测试步骤
  - 添加E2E测试步骤
  - 配置测试环境和依赖
  - 添加覆盖率上传到Codecov

#### 3.2 添加测试徽章到README
- 覆盖率徽章
- 测试通过徽章

### 4. 测试文档编写 (0.5天)

#### 4.1 创建测试指南文档
- **docs/testing-guide.md**
  - 测试编写规范
  - Mock数据使用指南
  - E2E测试编写指南
  - 测试运行命令说明
  - 常见问题排查

## 依赖关系

1. **测试工具优化** → **E2E测试**：E2E测试依赖于优化后的测试工具和数据生成器
2. **E2E测试** → **CI/CD集成**：CI/CD集成需要在所有测试完成后进行验证
3. **测试文档编写**：可以与其他任务并行进行，但最好在测试完成后编写

## 质量保障措施

1. 每完成一个E2E测试，立即运行验证
2. 定期运行完整的测试套件，确保测试的稳定性
3. 测试数据使用工厂模式生成，确保数据的一致性和可维护性
4. CI/CD集成后，在本地模拟CI环境运行测试
5. 测试文档与实际测试保持同步，确保文档的准确性

## 预期成果

1. 完成8个核心业务流程的E2E测试
2. 优化测试工具配置，提高测试的可维护性和执行效率
3. 实现CI/CD测试集成，确保代码变更后自动运行测试
4. 编写完整的测试文档，规范测试编写流程
5. 测试覆盖率达到≥80%的目标

## 风险与应对措施

1. **E2E测试不稳定**：
   - 采用更可靠的测试断言
   - 增加适当的等待时间
   - 实现测试数据的隔离和清理

2. **测试环境配置复杂**：
   - 使用Docker容器化测试环境
   - 编写自动化的环境配置脚本
   - 保持测试环境与生产环境的一致性

3. **测试数据生成困难**：
   - 采用工厂模式和fixtures
   - 实现数据之间的关联关系
   - 支持不同场景的测试数据生成

4. **CI/CD集成问题**：
   - 逐步添加CI/CD步骤
   - 在本地模拟CI环境进行测试
   - 配置详细的日志输出，便于问题排查