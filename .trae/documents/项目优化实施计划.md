# 项目优化实施计划

## 1. 测试配置优化

### 1.1 修复Supabase Mock配置问题

* **问题描述**：测试中Supabase Mock没有正确导出supabase对象，导致测试失败

* **具体任务**：

  * [ ] 检查所有测试文件中的Supabase Mock配置

  * [ ] 确保`@/lib/supabase/client`的mock正确返回supabase对象

  * [ ] 验证mock对象包含所有必要的方法和属性

  * [ ] 运行相关测试验证修复效果

* **优先级**：高

* **状态**：待实施

### 1.2 将Jest语法替换为Vitest语法

* **问题描述**：测试中使用了jest.mock等Jest特定语法，与Vitest不兼容

* **具体任务**：

  * [ ] 搜索所有测试文件中的`jest.mock`，替换为`vi.mock`

  * [ ] 搜索所有测试文件中的`jest.fn`，替换为`vi.fn`

  * [ ] 搜索所有测试文件中的`jest.spyOn`，替换为`vi.spyOn`

  * [ ] 检查并替换Jest断言语法为Vitest断言语法

  * [ ] 运行所有测试验证替换效果

* **优先级**：高

* **状态**：待实施

### 1.3 修复Window对象未定义问题

* **问题描述**：测试环境中window对象未定义，导致依赖window的测试失败

* **具体任务**：

  * [ ] 识别依赖window对象的测试文件

  * [ ] 在测试文件顶部添加window对象模拟

  * [ ] 使用`vi.stubGlobal('window', { ... })`设置必要的window属性

  * [ ] 运行相关测试验证修复效果

* **优先级**：中

* **状态**：待实施

## 2. 组件简化与优化

### 2.1 优化MarkdownRenderer组件

* **问题描述**：当前组件简化后功能受限，缺乏Markdown渲染能力

* **具体任务**：

  * [ ] 安装轻量级Markdown渲染库（如`marked`或`remark`）

  * [ ] 实现Markdown内容渲染功能

  * [ ] 添加基本的Markdown样式

  * [ ] 保留现有的复制功能

  * [ ] 测试各种Markdown语法的渲染效果

* **优先级**：中

* **状态**：待实施

### 2.2 优化InstallationCalendar组件

* **问题描述**：当前组件可能存在性能问题，代码复杂度较高

* **具体任务**：

  * [ ] 分析InstallationCalendar组件的代码结构

  * [ ] 识别性能瓶颈和复杂逻辑

  * [ ] 简化组件状态管理

  * [ ] 优化渲染性能（如使用React.memo或useMemo）

  * [ ] 移除不必要的依赖和功能

  * [ ] 测试组件性能和功能完整性

* **优先级**：中

* **状态**：待实施

### 2.3 优化LeadCard组件

* **问题描述**：当前组件可能存在代码冗余，功能过于复杂

* **具体任务**：

  * [ ] 分析LeadCard组件的功能和结构

  * [ ] 拆分为更小的子组件（如LeadHeader、LeadDetails、LeadActions等）

  * [ ] 优化Props传递和状态管理

  * [ ] 移除不必要的功能和样式

  * [ ] 测试组件功能和性能

* **优先级**：低

* **状态**：待实施

## 3. API路由完善

### 3.1 添加错误处理和验证

* **问题描述**：当前API路由缺乏完善的错误处理和验证

* **具体任务**：

  * [ ] 分析所有API路由的错误处理情况

  * [ ] 为每个API路由添加try-catch块

  * [ ] 实现统一的错误响应格式

  * [ ] 为错误添加适当的HTTP状态码

  * [ ] 测试错误处理效果

* **优先级**：高

* **状态**：待实施

### 3.2 添加权限检查

* **问题描述**：当前API路由缺乏完善的权限检查

* **具体任务**：

  * [ ] 分析每个API路由的权限需求

  * [ ] 实现权限检查中间件

  * [ ] 为API路由添加角色和权限验证

  * [ ] 测试不同角色的访问权限

* **优先级**：高

* **状态**：待实施

### 3.3 优化批量操作路由

* **问题描述**：当前批量操作路由可能存在性能问题，缺乏适当的限制

* **具体任务**：

  * [ ] 分析批量操作路由的性能瓶颈

  * [ ] 添加批量操作的大小限制

  * [ ] 优化数据库查询（如使用批量插入/更新）

  * [ ] 考虑使用异步处理长任务

  * [ ] 测试批量操作的性能和可靠性

* **优先级**：中

* **状态**：待实施

### 3.4 添加输入验证

* **问题描述**：当前API路由缺乏完善的输入验证

* **具体任务**：

  * [ ] 使用Zod定义API输入模式

  * [ ] 为每个API路由添加输入验证

  * [ ] 确保所有必需字段都存在且类型正确

  * [ ] 添加适当的错误信息

  * [ ] 测试各种输入情况的验证效果

* **优先级**：中

* **状态**：待实施

## 4. 实施顺序

### 阶段一：测试配置优化

1. 修复Supabase Mock配置问题
2. 将Jest语法替换为Vitest语法
3. 修复Window对象未定义问题
4. 运行所有测试验证修复效果

### 阶段二：组件简化与优化

1. 优化MarkdownRenderer组件
2. 优化InstallationCalendar组件
3. 优化LeadCard组件
4. 测试组件功能和性能

### 阶段三：API路由完善

1. 添加错误处理和验证
2. 添加权限检查
3. 添加输入验证
4. 优化批量操作路由
5. 测试API路由功能和安全性

## 5. 预期效果

* **测试方面**：测试通过率提高，测试执行速度加快，测试维护成本降低

* **组件方面**：组件性能提升，代码更简洁，可维护性提高

* **API路由方面**：API路由更安全，更可靠，错误处理更完善

* **整体**：项目质量提升，开发效率提高，部署风险降低

