# 快速清理执行指南

> **目标**: 在1周内完成三项核心清理任务
> **创建日期**: 2026-02-12

---

## 任务一: 移除 console.log → logger

### 1.1 现有 Logger 工具

项目已有 [logger.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/shared/lib/logger.ts)，支持:

```typescript
import { logger } from '@/shared/lib/logger';

logger.info('信息日志');
logger.warn('警告日志');
logger.error('错误日志');
```

### 1.2 清理分类

#### A. 调试日志 - 直接移除

| 文件                     | 行号 | 原代码                                                    | 操作 |
| ------------------------ | ---- | --------------------------------------------------------- | ---- |
| quote-items-table.tsx    | 879  | `console.log('[handleClientCalc] 尺寸数据无效...')`       | 移除 |
| quote-items-table.tsx    | 884  | `console.log('[handleClientCalc] 单价无效...')`           | 移除 |
| quote-items-table.tsx    | 888  | `console.log('[handleClientCalc] 触发计算...')`           | 移除 |
| quote-items-table.tsx    | 923  | `console.log('[handleClientCalc] 窗帘计算结果...')`       | 移除 |
| quote-items-table.tsx    | 934  | `console.log('[handleClientCalc] 计算结果无效...')`       | 移除 |
| quote-items-table.tsx    | 945  | `console.log('[handleClientCalc] 墙纸/墙布...')`          | 移除 |
| quote-items-table.tsx    | 949  | `console.log('[handleClientCalc] 墙纸计算结果...')`       | 移除 |
| quote-items-table.tsx    | 954  | `console.log('[handleClientCalc] 品类不匹配...')`         | 移除 |
| curtain-strategy.ts      | 85   | `console.log('[CurtainStrategy] measuredWidth 无效...')`  | 移除 |
| curtain-strategy.ts      | 89   | `console.log('[CurtainStrategy] measuredHeight 无效...')` | 移除 |
| curtain-strategy.ts      | 93   | `console.log('[CurtainStrategy] fabricWidth 无效...')`    | 移除 |
| curtain-strategy.ts      | 97   | `console.log('[CurtainStrategy] unitPrice 无效...')`      | 移除 |
| product-autocomplete.tsx | 129  | `console.log('[ProductAutocomplete] handleSelect...')`    | 移除 |
| product-autocomplete.tsx | 141  | `console.log('[ProductAutocomplete] 调用 onSelect...')`   | 移除 |
| roles.ts                 | 31   | `console.log('Initializing default roles...')`            | 移除 |
| signup-form-demo.tsx     | 11   | `console.log('Form submitted')`                           | 移除 |

#### B. 错误日志 - 替换为 logger.error

| 文件                     | 行号 | 原代码                                            | 替换为                                           |
| ------------------------ | ---- | ------------------------------------------------- | ------------------------------------------------ |
| quote-items-table.tsx    | 793  | `console.error('Failed to update item')`          | `logger.error('Failed to update item')`          |
| quote-items-table.tsx    | 841  | `console.error(_error)`                           | `logger.error('Calculation error:', _error)`     |
| product-autocomplete.tsx | 116  | `console.error('搜索商品失败:', error)`           | `logger.error('搜索商品失败:', error)`           |
| invite/list/route.ts     | 93   | `console.error('获取邀请列表失败:', error)`       | `logger.error('获取邀请列表失败:', error)`       |
| invite-user-dialog.tsx   | 55   | `console.error('Failed to load roles:', err)`     | `logger.error('Failed to load roles:', err)`     |
| invite-user-dialog.tsx   | 81   | `console.error(e)`                                | `logger.error('Invite error:', e)`               |
| invite/generate/route.ts | 107  | `console.error('生成邀请码错误:', error)`         | `logger.error('生成邀请码错误:', error)`         |
| user-actions.ts          | 44   | `console.error('Update user failed:', error)`     | `logger.error('Update user failed:', error)`     |
| layout.tsx               | 24   | `console.error('Failed to initialize...')`        | `logger.error('Failed to initialize...')`        |
| roles.ts                 | 65   | `console.error('Failed to fetch roles:', error)`  | `logger.error('Failed to fetch roles:', error)`  |
| roles-management.ts      | 79   | `console.error('同步系统角色失败:', error)`       | `logger.error('同步系统角色失败:', error)`       |
| roles-management.ts      | 124  | `console.error('创建角色失败:', error)`           | `logger.error('创建角色失败:', error)`           |
| roles-management.ts      | 174  | `console.error('更新角色失败:', error)`           | `logger.error('更新角色失败:', error)`           |
| roles-management.ts      | 209  | `console.error('删除角色失败:', error)`           | `logger.error('删除角色失败:', error)`           |
| role-override-actions.ts | 248  | `console.error('保存角色覆盖失败:', error)`       | `logger.error('保存角色覆盖失败:', error)`       |
| role-override-actions.ts | 286  | `console.error('重置角色覆盖失败:', error)`       | `logger.error('重置角色覆盖失败:', error)`       |
| role-override-actions.ts | 327  | `console.error('批量保存角色覆盖失败:', error)`   | `logger.error('批量保存角色覆盖失败:', error)`   |
| invite.ts                | 48   | `console.error('生成员工邀请链接失败:', error)`   | `logger.error('生成员工邀请链接失败:', error)`   |
| invite.ts                | 74   | `console.error('生成客户邀请链接失败:', error)`   | `logger.error('生成客户邀请链接失败:', error)`   |
| users/page.tsx           | 34   | `console.error('获取用户列表失败:', error)`       | `logger.error('获取用户列表失败:', error)`       |
| users/page.tsx           | 43   | `console.error('获取角色列表失败:', error)`       | `logger.error('获取角色列表失败:', error)`       |
| roles/page.tsx           | 45   | `console.error('获取权限矩阵失败:', e)`           | `logger.error('获取权限矩阵失败:', e)`           |
| tenant-provider.tsx      | 54   | `console.error('Failed to fetch tenant:', error)` | `logger.error('Failed to fetch tenant:', error)` |
| auth.ts                  | 168  | `console.error('Audit log for permission...')`    | `logger.error('Audit log for permission...')`    |
| auth.ts                  | 209  | `console.error('Permission check failed', e)`     | `logger.error('Permission check failed', e)`     |
| email.ts                 | 58   | `console.error('发送邮件失败:', error)`           | `logger.error('发送邮件失败:', error)`           |

#### C. 模拟/开发日志 - 保留或替换为 logger.info

| 文件               | 行号  | 说明         | 建议                 |
| ------------------ | ----- | ------------ | -------------------- |
| version-logger.tsx | 8     | 版本信息输出 | 保留（开发环境有用） |
| email.ts           | 39-44 | 邮件模拟输出 | 替换为 `logger.info` |

### 1.3 执行脚本

```bash
# 统计当前 console.log 数量
grep -r "console\.\(log\|debug\|warn\|error\)" src/ --include="*.ts" --include="*.tsx" | wc -l

# 查找所有需要修改的文件
grep -rl "console\.\(log\|debug\|warn\|error\)" src/ --include="*.ts" --include="*.tsx"
```

---

## 任务二: 处理高频 any 类型

### 2.1 any 类型分布

| 文件类型 | 数量 | 占比 |
| -------- | ---- | ---- |
| API 路由 | 120+ | 37%  |
| 组件     | 80+  | 25%  |
| Actions  | 60+  | 18%  |
| 服务层   | 40+  | 12%  |
| 其他     | 24+  | 8%   |

### 2.2 高频 any 类型文件

| 文件                                          | any 数量 | 优先级 |
| --------------------------------------------- | -------- | ------ |
| shared/api/schema/relations.ts                | 84       | P0     |
| features/orders/actions/orders.ts             | 8        | P1     |
| features/approval/actions/processing.ts       | 12       | P1     |
| features/quotes/actions/mutations.ts          | 4        | P1     |
| features/products/components/product-form.tsx | 6        | P1     |
| features/customers/actions/activities.ts      | 5        | P1     |

### 2.3 替换策略

#### A. API 响应类型

```typescript
// Before
const data: any = await response.json();

// After
interface ApiResponse<T> {
  success: boolean;
  data: T;
  error?: string;
}
const data: ApiResponse<ExpectedType> = await response.json();
```

#### B. 事件处理器

```typescript
// Before
const handleChange = (e: any) => { ... }

// After
import { ChangeEvent } from 'react';
const handleChange = (e: ChangeEvent<HTMLInputElement>) => { ... }
```

#### C. 数据库查询结果

```typescript
// Before
const result: any = await db.select()...

// After
import { InferSelectModel } from 'drizzle-orm';
type Quote = InferSelectModel<typeof quotes>;
const result: Quote[] = await db.select()...
```

### 2.4 常用类型导入

```typescript
// React 事件类型
import { ChangeEvent, FormEvent, MouseEvent, KeyboardEvent } from 'react';

// Drizzle 类型
import { InferSelectModel, InferInsertModel } from 'drizzle-orm';

// Zod 类型
import { z } from 'zod';
type FormData = z.infer<typeof formSchema>;
```

---

## 任务三: 补充模块 index.ts

### 3.1 缺失 index.ts 的模块

| 模块                   | 状态 | 需导出内容                                 |
| ---------------------- | ---- | ------------------------------------------ |
| features/admin         | ❌   | actions                                    |
| features/after-sales   | ❌   | components, actions, types                 |
| features/analytics     | ❌   | components, actions                        |
| features/approval      | ❌   | components, actions, schema, constants     |
| features/auth          | ❌   | components                                 |
| features/channels      | ❌   | components, actions, logic                 |
| features/customers     | ❌   | components, actions, schemas               |
| features/dashboard     | ❌   | components, widgets, actions, types, utils |
| features/dispatch      | ❌   | lib                                        |
| features/finance       | ❌   | components, actions, schemas, services     |
| features/monitoring    | ❌   | components, actions                        |
| features/notifications | ❌   | components, actions, types, service        |
| features/orders        | ❌   | components, actions                        |
| features/platform      | ❌   | actions                                    |
| features/sales         | ❌   | actions                                    |
| features/service       | ❌   | components, actions                        |
| features/settings      | ❌   | components, actions                        |
| features/upload        | ❌   | actions                                    |
| features/supply-chain  | ✅   | 已有                                       |

### 3.2 index.ts 模板

```typescript
// features/[module]/index.ts

// 组件导出
export * from './components';

// Actions 导出
export * from './actions';

// 类型导出 (如有)
export * from './types';

// Schema 导出 (如有)
export * from './schema';

// 常量导出 (如有)
export * from './constants';
```

### 3.3 组件 index.ts 模板

```typescript
// features/[module]/components/index.ts

export { default: ComponentName } from './component-name';
export { AnotherComponent } from './another-component';
export type { ComponentProps } from './component-name';
```

---

## 执行计划

### Day 1-2: console.log 清理

```
上午: 处理调试日志 (直接移除)
下午: 替换错误日志为 logger.error
```

### Day 3-4: any 类型处理

```
上午: 处理 relations.ts (84处)
下午: 处理 actions 和 components
```

### Day 5: 补充 index.ts

```
上午: 创建 features 模块 index.ts
下午: 创建 components 子目录 index.ts
```

---

## 验证清单

- [ ] console.log 数量 < 10
- [ ] any 类型数量 < 50
- [ ] 所有 features 模块有 index.ts
- [ ] TypeScript 编译无错误
- [ ] ESLint 无新增警告
- [ ] 测试通过

---

_创建时间: 2026-02-12_
