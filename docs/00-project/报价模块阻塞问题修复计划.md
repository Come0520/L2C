# 报价模块阻塞问题修复计划

> **计划日期**: 2026-02-12
> **修复策略**: 逐个修复，分三次迭代
> **修复顺序**: Q-002 → Q-001 → Q-003
> **完成日期**: 2026-02-12

---

## 总览

| 迭代   | 问题                 | 预计工时 | 状态      |
| ------ | -------------------- | -------- | --------- |
| 第一轮 | Q-002 商品选择无响应 | 2h       | ✅ 已完成 |
| 第二轮 | Q-001 价格计算 NaN   | 2h       | ✅ 已完成 |
| 第三轮 | Q-003 视图切换未实现 | 4h       | ✅ 已完成 |

---

## 第一轮修复：Q-002 商品选择无响应

### 问题描述

商品下拉菜单可以显示商品列表，但点击商品后：

- 下拉菜单关闭
- 商品名称未更新到输入框
- 控制台无报错

### 问题定位

**涉及文件**:

- [product-autocomplete.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/product-autocomplete.tsx)
- [command.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/shared/ui/command.tsx)
- [quote-items-table.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx)

**代码分析**:

```typescript
// product-autocomplete.tsx L158-175
<CommandItem
  key={product.id}
  value={product.id}           // ⚠️ 问题点1: value 使用 id
  onSelect={() => {
    handleSelect(product);     // 调用选择处理
  }}
  className="cursor-pointer"
>
  // ...
  <Check
    className={cn(
      'ml-auto h-4 w-4 shrink-0',
      value === product.name ? 'opacity-100' : 'opacity-0'  // ⚠️ 问题点2: 对比的是 name
    )}
  />
</CommandItem>
```

### 根因分析

| 问题点           | 说明                                                                           |
| ---------------- | ------------------------------------------------------------------------------ |
| value 属性不一致 | `CommandItem` 的 `value={product.id}`，但选中状态检查 `value === product.name` |
| cmdk 库行为      | cmdk 的 `CommandItem` 使用 `value` 属性进行键盘导航和搜索过滤，而非选中状态    |
| 双击检测干扰     | `handleTriggerClick` 中的双击检测逻辑可能影响单击行为                          |

### 修复方案

#### 方案 A：修复 value 属性一致性（推荐）

**修改文件**: `product-autocomplete.tsx`

**修改内容**:

```typescript
// 修改前 (L158-162)
<CommandItem
  key={product.id}
  value={product.id}
  onSelect={() => {
    handleSelect(product);
  }}
  className="cursor-pointer"
>

// 修改后
<CommandItem
  key={product.id}
  value={product.name}  // 改为 name，与显示内容和选中检查一致
  onSelect={() => {
    handleSelect(product);
  }}
  className="cursor-pointer"
>
```

**同时修改选中状态检查**:

```typescript
// 修改前 (L172-177)
<Check
  className={cn(
    'ml-auto h-4 w-4 shrink-0',
    value === product.name ? 'opacity-100' : 'opacity-0'
  )}
/>

// 修改后
<Check
  className={cn(
    'ml-auto h-4 w-4 shrink-0',
    value === product.name ? 'opacity-100' : 'opacity-0'
  )}
/>
// 此处无需修改，已经正确对比 name
```

#### 方案 B：添加调试日志验证

**修改文件**: `product-autocomplete.tsx`

**修改内容**:

```typescript
// 在 handleSelect 函数中添加调试日志 (L127-140)
const handleSelect = React.useCallback(
  (product: ProductSearchResult) => {
    console.log('[ProductAutocomplete] handleSelect 被调用', product);

    // 记录到最近使用
    addRecentProduct({
      id: product.id,
      name: product.name,
      sku: product.sku,
      category: product.category,
      unitPrice: product.unitPrice,
    });

    // 调用原始回调
    console.log('[ProductAutocomplete] 调用 onSelect 回调');
    onSelect(product);
    setOpen(false);

    // 清除缓存
    cacheRef.current = {};
  },
  [onSelect, addRecentProduct]
);
```

### 验证步骤

1. **启动开发服务器**:

   ```bash
   pnpm dev
   ```

2. **打开报价页面**:
   - 访问 `/quotes/[id]`
   - 点击商品下拉框

3. **验证商品选择**:
   - [ ] 下拉列表正常显示商品
   - [ ] 点击商品后下拉关闭
   - [ ] 商品名称正确更新到输入框
   - [ ] 控制台无错误日志

4. **验证最近使用功能**:
   - [ ] 再次打开下拉，之前选择的商品显示时钟图标
   - [ ] 最近使用的商品排在列表前面

### 回滚方案

如果修复导致新问题，执行以下回滚：

```bash
git checkout -- src/features/quotes/components/product-autocomplete.tsx
```

---

## 第二轮修复：Q-001 价格计算返回 NaN

### 问题描述

添加商品后：

- 单价显示为 ¥0.00
- 小计显示为 ¥0.00
- 控制台日志：`[handleClientCalc] 计算结果无效，返回 null NaN`

### 问题定位

**涉及文件**:

- [quote-items-table.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx) - 前端计算
- [mutations.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/actions/mutations.ts) - 后端计算
- [curtain-strategy.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/calc-strategies/curtain-strategy.ts) - 计算策略
- [calculator.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/logic/calculator.ts) - 计算引擎

**代码分析**:

```typescript
// quote-items-table.tsx L842-852 - 商品选择回调
const handleProductSelect = async (id: string, product: ProductSearchResult) => {
  await handleUpdate(id, {
    productId: product.id,
    productName: product.name,
    unitPrice: product.unitPrice ? parseFloat(String(product.unitPrice)) : undefined, // ⚠️ 问题点
    attributes: {
      ...product.specs,
      productImage: product.images?.[0],
    },
  });
};

// quote-items-table.tsx L889-891 - 计算参数
const params: CurtainCalcParams = {
  // ...
  unitPrice: Number(item.unitPrice) || 0, // ⚠️ 当 unitPrice 为空时返回 0
  // ...
};
```

### 根因分析

| 问题点       | 说明                                                                   |
| ------------ | ---------------------------------------------------------------------- |
| 商品价格缺失 | 商品未设置 `unitPrice` 时，传递 `undefined`                            |
| 计算无防御   | `Number(undefined)` 返回 `NaN`，但 `Number(undefined) \|\| 0` 返回 `0` |
| 数量计算异常 | 当尺寸数据不完整时，计算结果可能为 `NaN`                               |
| 小计计算     | `subtotal = unitPrice * quantity`，当任一为 NaN 时结果为 NaN           |

### 修复方案

#### 修复点 1：商品选择时校验价格

**修改文件**: `quote-items-table.tsx`

**修改内容**:

```typescript
// 修改前 (L842-852)
const handleProductSelect = async (id: string, product: ProductSearchResult) => {
  if (readOnly) return;
  await handleUpdate(id, {
    productId: product.id,
    productName: product.name,
    unitPrice: product.unitPrice ? parseFloat(String(product.unitPrice)) : undefined,
    attributes: {
      ...product.specs,
      productImage: product.images?.[0],
    },
  });
};

// 修改后
const handleProductSelect = async (id: string, product: ProductSearchResult) => {
  if (readOnly) return;

  const parsedPrice = product.unitPrice ? parseFloat(String(product.unitPrice)) : 0;

  if (parsedPrice <= 0) {
    toast.warning('该商品未设置价格，请手动输入单价');
  }

  await handleUpdate(id, {
    productId: product.id,
    productName: product.name,
    unitPrice: parsedPrice > 0 ? parsedPrice : undefined,
    attributes: {
      ...product.specs,
      productImage: product.images?.[0],
    },
  });
};
```

#### 修复点 2：前端计算防御性编程

**修改文件**: `quote-items-table.tsx`

**修改内容**:

```typescript
// 修改前 (L855-935)
const handleClientCalc = (
  item: QuoteItem,
  field: string,
  value: number
): { quantity: number; calcResult?: CalcResult } | number | null => {
  const newItem = { ...item, [field]: value };
  const category = newItem.category;
  // ... 计算逻辑
};

// 修改后
const handleClientCalc = (
  item: QuoteItem,
  field: string,
  value: number
): { quantity: number; calcResult?: CalcResult } | number | null => {
  const newItem = { ...item, [field]: value };
  const category = newItem.category;

  // 输入参数校验
  const width = Number(newItem.width);
  const height = Number(newItem.height);
  const unitPrice = Number(item.unitPrice);

  if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
    console.log('[handleClientCalc] 尺寸数据无效，跳过计算', { width, height });
    return null;
  }

  if (isNaN(unitPrice) || unitPrice <= 0) {
    console.log('[handleClientCalc] 单价无效，跳过计算', { unitPrice });
    return null;
  }

  // ... 后续计算逻辑保持不变
};
```

#### 修复点 3：计算策略增加防御

**修改文件**: `curtain-strategy.ts`

**修改内容**:

```typescript
// 在 calculate 方法开头添加参数校验
calculate(params: CurtainCalcParams): CurtainCalcResult {
  const {
    measuredWidth,
    measuredHeight,
    foldRatio = 2.0,
    fabricWidth,
    fabricType,
    unitPrice,
    // ...
  } = params;

  // 参数校验
  if (isNaN(measuredWidth) || measuredWidth <= 0) {
    return { usage: 0, subtotal: 0, details: { finishedWidth: 0, finishedHeight: 0, cutWidth: 0, cutHeight: 0, fabricWidthCm: 0 } };
  }
  if (isNaN(measuredHeight) || measuredHeight <= 0) {
    return { usage: 0, subtotal: 0, details: { finishedWidth: 0, finishedHeight: 0, cutWidth: 0, cutHeight: 0, fabricWidthCm: 0 } };
  }

  // ... 后续计算逻辑
}
```

#### 修复点 4：后端计算兜底

**修改文件**: `mutations.ts`

**修改内容**:

```typescript
// 在 updateQuoteItem 中确保 unitPrice 有默认值 (L534 附近)
let unitPrice = Number(existing.unitPrice) || 0; // 默认为 0

// 在计算小计前校验 (L600 附近)
const finalUnitPrice =
  updateData.unitPrice !== undefined ? Number(updateData.unitPrice) : unitPrice;

if (isNaN(finalUnitPrice) || finalUnitPrice < 0) {
  throw new Error('单价无效');
}

const subtotal = calculateSubtotal(finalUnitPrice, quantity, fee);

if (isNaN(subtotal)) {
  throw new Error('小计计算失败');
}
```

### 验证步骤

1. **测试有价格商品**:
   - [ ] 选择有 `unitPrice` 的商品
   - [ ] 验证单价正确显示
   - [ ] 输入尺寸后验证数量自动计算
   - [ ] 验证小计正确计算

2. **测试无价格商品**:
   - [ ] 选择无 `unitPrice` 的商品
   - [ ] 验证显示警告提示
   - [ ] 手动输入单价后验证计算正常

3. **测试边界情况**:
   - [ ] 输入 0 作为尺寸
   - [ ] 输入负数作为尺寸
   - [ ] 清空单价输入框
   - [ ] 验证不会出现 NaN

### 回滚方案

```bash
git checkout -- src/features/quotes/components/quote-items-table.tsx
git checkout -- src/features/quotes/calc-strategies/curtain-strategy.ts
git checkout -- src/features/quotes/actions/mutations.ts
```

---

## 第三轮修复：Q-003 空间视图切换未实现

### 问题描述

报价页面有"品类优先"和"空间优先"视图切换按钮，但切换后：

- 两个视图显示内容完全相同
- 未按不同模式组织数据

### 问题定位

**涉及文件**:

- [quote-detail.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-detail.tsx) - 视图切换逻辑
- [quote-items-table.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx) - 表格组件
- [quote-category-tabs.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-category-tabs.tsx) - Tab 组件

**代码分析**:

```typescript
// quote-detail.tsx L413-456
) : viewMode === 'category' ? (
  // 品类优先视图
  <QuoteItemsTable
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...].filter(item => {
      const allowedCategories = CATEGORY_TO_PRODUCT_CATEGORIES[cat];
      return allowedCategories.includes(item.category);
    })}
    // ⚠️ 缺少 viewMode prop
  />
) : (
  // 空间优先视图
  <QuoteItemsTable
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...]}
    // ⚠️ props 与品类视图完全相同，缺少 viewMode prop
  />
)}
```

### 根因分析

| 问题点             | 说明                                 |
| ------------------ | ------------------------------------ |
| 缺少 viewMode prop | `QuoteItemsTable` 未接收视图模式参数 |
| 无渲染分支         | 组件内部没有根据模式切换布局的逻辑   |
| 数据组织相同       | 两种模式传递的数据结构完全一致       |

### 修复方案

#### 修复点 1：传递 viewMode prop

**修改文件**: `quote-detail.tsx`

**修改内容**:

```typescript
// 修改前 (L413-456)
) : viewMode === 'category' ? (
  <QuoteItemsTable
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...]}
  />
) : (
  <QuoteItemsTable
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...]}
  />
)}

// 修改后
) : viewMode === 'category' ? (
  <QuoteItemsTable
    viewMode="category"
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...].filter(item => {
      const cat = activeCategory as Exclude<QuoteCategory, 'SUMMARY'>;
      const allowedCategories = CATEGORY_TO_PRODUCT_CATEGORIES[cat];
      return allowedCategories.includes(item.category);
    })}
    activeCategory={activeCategory}
  />
) : (
  <QuoteItemsTable
    viewMode="room"
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...]}
  />
)}
```

#### 修复点 2：更新 QuoteItemsTable 接口

**修改文件**: `quote-items-table.tsx`

**修改内容**:

```typescript
// 修改前 (L60-80)
interface QuoteItemsTableProps {
  quoteId: string;
  rooms: QuoteRoom[];
  items: QuoteItem[];
  mode?: 'simple' | 'advanced';
  visibleFields?: VisibleFields;
  readOnly?: boolean;
  dimensionLimits?: DimensionLimits;
  allowedCategories?: string[];
  onAddRoom?: (name: string) => void;
  onItemUpdate?: () => void;
}

// 修改后
interface QuoteItemsTableProps {
  quoteId: string;
  rooms: QuoteRoom[];
  items: QuoteItem[];
  mode?: 'simple' | 'advanced';
  visibleFields?: VisibleFields;
  readOnly?: boolean;
  dimensionLimits?: DimensionLimits;
  allowedCategories?: string[];
  onAddRoom?: (name: string) => void;
  onItemUpdate?: () => void;
  viewMode?: 'category' | 'room';
  activeCategory?: QuoteCategory;
}
```

#### 修复点 3：实现视图切换渲染逻辑

**修改文件**: `quote-items-table.tsx`

**修改内容**:

```typescript
// 在组件内部添加视图模式判断
export function QuoteItemsTable({
  quoteId,
  rooms,
  items,
  mode = 'simple',
  visibleFields,
  readOnly = false,
  dimensionLimits,
  allowedCategories,
  onAddRoom,
  onItemUpdate,
  viewMode = 'room',
  activeCategory,
}: QuoteItemsTableProps) {
  // ... 现有逻辑

  // 品类优先视图：按品类分组
  if (viewMode === 'category') {
    const itemsByCategory = useMemo(() => {
      const grouped: Record<string, QuoteItem[]> = {};
      items.forEach(item => {
        const cat = item.category || 'OTHER';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
      });
      return grouped;
    }, [items]);

    return (
      <div className="space-y-6">
        {Object.entries(itemsByCategory).map(([category, categoryItems]) => (
          <div key={category} className="space-y-2">
            <h3 className="text-lg font-semibold">
              {CATEGORY_LABELS[category as ProductCategory] || category}
            </h3>
            <Table>
              {/* 表格内容 */}
              <TableBody>
                {renderRows(categoryItems)}
              </TableBody>
            </Table>
          </div>
        ))}
      </div>
    );
  }

  // 空间优先视图：按空间分组（现有逻辑）
  return (
    <div className="space-y-8">
      {/* 现有渲染逻辑 */}
    </div>
  );
}
```

### 验证步骤

1. **测试品类优先视图**:
   - [ ] 切换到"品类优先"视图
   - [ ] 验证商品按品类分组显示
   - [ ] 验证品类 Tab 切换正常
   - [ ] 验证每个品类分组有标题

2. **测试空间优先视图**:
   - [ ] 切换到"空间优先"视图
   - [ ] 验证商品按空间分组显示
   - [ ] 验证空间折叠/展开正常
   - [ ] 验证空间小计正确

3. **测试切换保持状态**:
   - [ ] 在品类视图编辑商品
   - [ ] 切换到空间视图，验证数据同步
   - [ ] 切换回品类视图，验证状态保持

### 回滚方案

```bash
git checkout -- src/features/quotes/components/quote-detail.tsx
git checkout -- src/features/quotes/components/quote-items-table.tsx
```

---

## 测试清单汇总

### 第一轮测试 (Q-002)

| 测试项       | 预期结果             | 通过 |
| ------------ | -------------------- | ---- |
| 打开商品下拉 | 显示商品列表         | ☐    |
| 点击商品     | 下拉关闭，名称更新   | ☐    |
| 选中状态     | Check 图标显示正确   | ☐    |
| 最近使用     | 再次打开显示时钟图标 | ☐    |
| 拼音搜索     | 输入拼音可搜索       | ☐    |

### 第二轮测试 (Q-001)

| 测试项         | 预期结果     | 通过 |
| -------------- | ------------ | ---- |
| 选择有价格商品 | 单价正确显示 | ☐    |
| 选择无价格商品 | 显示警告提示 | ☐    |
| 输入尺寸       | 数量自动计算 | ☐    |
| 小计计算       | 金额正确显示 | ☐    |
| 边界情况       | 不出现 NaN   | ☐    |

### 第三轮测试 (Q-003)

| 测试项   | 预期结果     | 通过 |
| -------- | ------------ | ---- |
| 品类视图 | 按品类分组   | ☐    |
| 空间视图 | 按空间分组   | ☐    |
| 视图切换 | 数据保持同步 | ☐    |
| Tab 切换 | 品类筛选正常 | ☐    |

---

## 风险评估

| 风险           | 影响 | 缓解措施                   |
| -------------- | ---- | -------------------------- |
| 修复引入新 bug | 中   | 每轮修复后完整测试         |
| 性能影响       | 低   | 计算逻辑优化，避免重复计算 |
| 兼容性问题     | 低   | 保持接口向后兼容           |

---

## 附录：相关文件清单

| 文件                     | 路径                                 | 修改轮次       |
| ------------------------ | ------------------------------------ | -------------- |
| product-autocomplete.tsx | src/features/quotes/components/      | 第一轮         |
| quote-items-table.tsx    | src/features/quotes/components/      | 第一、二、三轮 |
| curtain-strategy.ts      | src/features/quotes/calc-strategies/ | 第二轮         |
| mutations.ts             | src/features/quotes/actions/         | 第二轮         |
| quote-detail.tsx         | src/features/quotes/components/      | 第三轮         |

---

_计划生成: L2C 产品诊断系统_
