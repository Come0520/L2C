# æŠ¥ä»·æ¨¡å—é˜»å¡é—®é¢˜è¯Šæ–­æŠ¥å‘Š

> **æŠ¥å‘Šæ—¥æœŸ**: 2026-02-12
> **ä¸¥é‡ç­‰çº§**: ğŸ”´ P0 - é˜»å¡æ€§é—®é¢˜
> **å½±å“èŒƒå›´**: æŠ¥ä»·å•åˆ›å»ºã€å•†å“æ·»åŠ ã€ä»·æ ¼è®¡ç®—æ ¸å¿ƒæµç¨‹

---

## ä¸€ã€é—®é¢˜æ¦‚è¿°

æŠ¥ä»·æ¨¡å—æ˜¯ L2C ç³»ç»Ÿçš„æ ¸å¿ƒæ¢çº½ï¼Œè¿æ¥çº¿ç´¢ç®¡ç†ä¸è®¢å•è½¬åŒ–ã€‚å½“å‰å­˜åœ¨ä¸‰ä¸ªå…³é”®é˜»å¡é—®é¢˜ï¼Œå¯¼è‡´ç”¨æˆ·æ— æ³•æ­£å¸¸åˆ›å»ºæŠ¥ä»·å•ï¼š

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿°           | ä¸¥é‡ç¨‹åº¦    | å½±å“èŒƒå›´     |
| -------- | ------------------ | ----------- | ------------ |
| Q-001    | ä»·æ ¼è®¡ç®—è¿”å› NaN/0 | ğŸ”´ é˜»å¡     | æ‰€æœ‰å“ç±»æŠ¥ä»· |
| Q-002    | å•†å“ä¸‹æ‹‰é€‰æ‹©æ— å“åº” | ğŸ”´ é˜»å¡     | å•†å“æ·»åŠ æµç¨‹ |
| Q-003    | ç©ºé—´è§†å›¾åˆ‡æ¢æœªå®ç° | ğŸŸ¡ åŠŸèƒ½ç¼ºå¤± | ç”¨æˆ·ä½“éªŒ     |

---

## äºŒã€é—®é¢˜è¯¦ç»†åˆ†æ

### 2.1 Q-001: ä»·æ ¼è®¡ç®—è¿”å› NaN/0

#### é—®é¢˜ç°è±¡

ç”¨æˆ·åœ¨æŠ¥ä»·é¡µé¢æ·»åŠ å•†å“åï¼š

- å•ä»·æ˜¾ç¤ºä¸º Â¥0.00
- å°è®¡æ˜¾ç¤ºä¸º Â¥0.00
- æ§åˆ¶å°æ—¥å¿—ï¼š`[handleClientCalc] è®¡ç®—ç»“æœæ— æ•ˆï¼Œè¿”å› null NaN`

#### ä»£ç è¿½è¸ª

**å‰ç«¯è®¡ç®—å…¥å£** ([quote-items-table.tsx:855-935](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx#L855-L935))

```typescript
const handleClientCalc = (item: QuoteItem, field: string, value: number) => {
  const newItem = { ...item, [field]: value };
  // ...
  const params: CurtainCalcParams = {
    measuredWidth: Number(newItem.width) || 0,
    measuredHeight: Number(newItem.height) || 0,
    foldRatio: Number(newItem.foldRatio) || 2,
    fabricWidth: Number(attributes.fabricWidth) || 280,
    fabricType: (attributes.fabricType as 'FIXED_HEIGHT' | 'FIXED_WIDTH') || 'FIXED_HEIGHT',
    unitPrice: Number(item.unitPrice) || 0, // âš ï¸ é—®é¢˜ç‚¹1
    // ...
  };
  const result = strategy.calculate(params);
  // ...
};
```

**å•†å“é€‰æ‹©å›è°ƒ** ([quote-items-table.tsx:842-852](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx#L842-L852))

```typescript
const handleProductSelect = async (id: string, product: ProductSearchResult) => {
  await handleUpdate(id, {
    productId: product.id,
    productName: product.name,
    unitPrice: product.unitPrice ? parseFloat(String(product.unitPrice)) : undefined, // âš ï¸ é—®é¢˜ç‚¹2
    attributes: {
      ...product.specs,
      productImage: product.images?.[0],
    },
  });
};
```

#### æ ¹å› åˆ†æ

| é—®é¢˜ç‚¹  | ä»£ç ä½ç½®                    | é—®é¢˜æè¿°                                                                         |
| ------- | --------------------------- | -------------------------------------------------------------------------------- |
| é—®é¢˜ç‚¹1 | `handleClientCalc` L891     | `Number(item.unitPrice)` å½“ unitPrice ä¸ºç©ºå­—ç¬¦ä¸²æ—¶è¿”å› 0ï¼Œä½†è®¡ç®—ç»“æœå¯èƒ½ä»ä¸º NaN |
| é—®é¢˜ç‚¹2 | `handleProductSelect` L846  | å½“å•†å“æ²¡æœ‰è®¾ç½® `unitPrice` æ—¶ï¼Œä¼ é€’ `undefined`ï¼Œå¯¼è‡´åç»­è®¡ç®—å¼‚å¸¸                |
| é—®é¢˜ç‚¹3 | `CurtainStrategy.calculate` | æœªå¯¹ `unitPrice` ä¸º 0 æˆ– NaN çš„æƒ…å†µåšé˜²å¾¡å¤„ç†                                    |

#### æ•°æ®æµé—®é¢˜

```
å•†å“é€‰æ‹© â†’ handleProductSelect
    â†“
unitPrice: undefined (å•†å“æœªè®¾ç½®ä»·æ ¼)
    â†“
handleUpdate â†’ updateQuoteItem (æœåŠ¡ç«¯)
    â†“
æ•°æ®åº“å­˜å‚¨: unitPrice = "" æˆ– null
    â†“
å‰ç«¯é‡æ–°æ¸²æŸ“ â†’ handleClientCalc
    â†“
Number("") = 0, ä½† quantity è®¡ç®—å¯èƒ½è¿”å› NaN
    â†“
subtotal = 0 * NaN = NaN
```

#### ä¿®å¤å»ºè®®

1. **å‰ç«¯é˜²å¾¡æ€§ç¼–ç¨‹** - `handleClientCalc` ä¸­å¢åŠ  NaN æ£€æµ‹ï¼š

```typescript
const unitPrice = Number(item.unitPrice);
if (isNaN(unitPrice) || unitPrice <= 0) {
  console.warn('[handleClientCalc] å•ä»·æ— æ•ˆï¼Œè·³è¿‡è®¡ç®—');
  return null;
}
```

2. **å•†å“é€‰æ‹©æ—¶å¼ºåˆ¶æ ¡éªŒ** - `handleProductSelect` ä¸­å¢åŠ ä»·æ ¼æ ¡éªŒï¼š

```typescript
if (!product.unitPrice || parseFloat(String(product.unitPrice)) <= 0) {
  toast.warning('è¯¥å•†å“æœªè®¾ç½®ä»·æ ¼ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥å•ä»·');
}
```

3. **åç«¯è®¡ç®—å…œåº•** - `mutations.ts` ä¸­ `updateQuoteItem` å·²æœ‰è®¡ç®—é€»è¾‘ï¼Œä½†éœ€ç¡®ä¿ `unitPrice` æœ‰é»˜è®¤å€¼ã€‚

---

### 2.2 Q-002: å•†å“ä¸‹æ‹‰é€‰æ‹©æ— å“åº”

#### é—®é¢˜ç°è±¡

- å•†å“ä¸‹æ‹‰èœå•å¯ä»¥æ­£å¸¸æ˜¾ç¤ºå•†å“åˆ—è¡¨
- ç‚¹å‡»å•†å“åä¸‹æ‹‰èœå•å…³é—­ï¼Œä½†å•†å“åç§°æœªæ›´æ–°åˆ°è¾“å…¥æ¡†
- æ§åˆ¶å°æ— æŠ¥é”™ä¿¡æ¯

#### ä»£ç è¿½è¸ª

**å•†å“é€‰æ‹©ç»„ä»¶** ([product-autocomplete.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/product-autocomplete.tsx))

```typescript
// ç¬¬ 158-162 è¡Œ
<CommandItem
  key={product.id}
  value={product.id}
  onSelect={() => {
    handleSelect(product);  // è°ƒç”¨é€‰æ‹©å¤„ç†å‡½æ•°
  }}
  className="cursor-pointer"
>
```

**é€‰æ‹©å¤„ç†å‡½æ•°** (ç¬¬ 127-140 è¡Œ)

```typescript
const handleSelect = React.useCallback(
  (product: ProductSearchResult) => {
    addRecentProduct({...});  // è®°å½•æœ€è¿‘ä½¿ç”¨
    onSelect(product);        // è°ƒç”¨çˆ¶ç»„ä»¶å›è°ƒ
    setOpen(false);           // å…³é—­ä¸‹æ‹‰
    cacheRef.current = {};    // æ¸…é™¤ç¼“å­˜
  },
  [onSelect, addRecentProduct]
);
```

**çˆ¶ç»„ä»¶å›è°ƒ** ([quote-items-table.tsx:190](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx#L190))

```typescript
<ProductAutocomplete
  value={item.productName}
  onSelect={(p) => handleProductSelect(item.id, p)}  // è°ƒç”¨ handleProductSelect
  // ...
/>
```

#### æ ¹å› åˆ†æ

| å¯èƒ½åŸå›                  | åˆ†æ                                                                     |
| ------------------------ | ------------------------------------------------------------------------ |
| CommandItem äº‹ä»¶å†’æ³¡é—®é¢˜ | `CommandItem` ç»„ä»¶å¯èƒ½é˜»æ­¢äº†äº‹ä»¶å†’æ³¡æˆ– `onSelect` æœªæ­£ç¡®è§¦å‘             |
| value å±æ€§é—®é¢˜           | `value={product.id}` ä½†æ˜¾ç¤ºçš„æ˜¯ `product.name`ï¼Œå¯èƒ½å¯¼è‡´é€‰ä¸­çŠ¶æ€åˆ¤æ–­é”™è¯¯ |
| Popover çŠ¶æ€é—®é¢˜         | `setOpen(false)` å¯èƒ½è¿‡æ—©æ‰§è¡Œï¼Œå¯¼è‡´é€‰æ‹©äº‹ä»¶è¢«ä¸­æ–­                        |

#### è°ƒè¯•éªŒè¯

éœ€è¦éªŒè¯ä»¥ä¸‹å‡ ç‚¹ï¼š

1. `handleSelect` æ˜¯å¦è¢«è°ƒç”¨ï¼ˆæ·»åŠ  console.logï¼‰
2. `onSelect(product)` æ˜¯å¦æ­£ç¡®ä¼ é€’äº† product å¯¹è±¡
3. `handleProductSelect` æ˜¯å¦è¢«è°ƒç”¨å¹¶æ­£ç¡®æ‰§è¡Œ

#### ä¿®å¤å»ºè®®

1. **æ£€æŸ¥ Command ç»„ä»¶ç‰ˆæœ¬å…¼å®¹æ€§**ï¼š

```typescript
// å°è¯•ä½¿ç”¨ onSelect è€Œé onClick
<CommandItem
  key={product.id}
  value={product.name}  // æ”¹ä¸º name ä»¥åŒ¹é…æ˜¾ç¤ºå†…å®¹
  onSelect={() => handleSelect(product)}
>
```

2. **æ·»åŠ è°ƒè¯•æ—¥å¿—**ï¼š

```typescript
const handleSelect = React.useCallback((product: ProductSearchResult) => {
  console.log('[ProductAutocomplete] é€‰ä¸­å•†å“:', product);
  // ...
}, []);
```

3. **æ£€æŸ¥å¼‚æ­¥æ›´æ–°é—®é¢˜**ï¼š

```typescript
// handleProductSelect æ˜¯ async å‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†
onSelect={async (p) => {
  console.log('[QuoteItemRow] è°ƒç”¨ handleProductSelect');
  await handleProductSelect(item.id, p);
}}
```

---

### 2.3 Q-003: ç©ºé—´è§†å›¾åˆ‡æ¢æœªå®ç°

#### é—®é¢˜ç°è±¡

- æŠ¥ä»·é¡µé¢æœ‰"å“ç±»ä¼˜å…ˆ"å’Œ"ç©ºé—´ä¼˜å…ˆ"è§†å›¾åˆ‡æ¢æŒ‰é’®
- åˆ‡æ¢å UI æ— å˜åŒ–ï¼Œä¸¤ä¸ªè§†å›¾æ˜¾ç¤ºå†…å®¹å®Œå…¨ç›¸åŒ

#### ä»£ç è¿½è¸ª

**è§†å›¾åˆ‡æ¢é€»è¾‘** ([quote-detail.tsx:401-446](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-detail.tsx#L401-L446))

```typescript
{viewMode === 'summary' ? (
  <QuoteSummaryTab items={[...]} rooms={[...]} />
) : viewMode === 'category' ? (
  // å“ç±»ä¼˜å…ˆè§†å›¾
  <QuoteItemsTable
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...].filter(item => {
      // æŒ‰å“ç±»ç­›é€‰å•†å“
      const allowedCategories = CATEGORY_TO_PRODUCT_CATEGORIES[cat];
      return allowedCategories.includes(item.category);
    })}
    // âš ï¸ ç¼ºå°‘ viewMode prop
  />
) : (
  // ç©ºé—´ä¼˜å…ˆè§†å›¾
  <QuoteItemsTable
    quoteId={quote.id}
    rooms={quote.rooms || []}
    items={[...]}
    // âš ï¸ ç¼ºå°‘ viewMode propï¼Œprops ä¸å“ç±»è§†å›¾å®Œå…¨ç›¸åŒ
  />
)}
```

#### æ ¹å› åˆ†æ

| é—®é¢˜               | è¯´æ˜                                                                   |
| ------------------ | ---------------------------------------------------------------------- |
| ç¼ºå°‘ viewMode prop | `QuoteItemsTable` ç»„ä»¶æœªæ¥æ”¶ `viewMode` å‚æ•°ï¼Œæ— æ³•æ ¹æ®æ¨¡å¼åˆ‡æ¢æ¸²æŸ“é€»è¾‘ |
| ç­›é€‰é€»è¾‘é—®é¢˜       | å“ç±»è§†å›¾çš„ `filter` é€»è¾‘æ­£ç¡®ï¼Œä½†ç©ºé—´è§†å›¾ç¼ºå°‘æŒ‰ç©ºé—´åˆ†ç»„çš„æ¸²æŸ“é€»è¾‘       |
| ç»„ä»¶å†…éƒ¨æ— åˆ†æ”¯     | `QuoteItemsTable` å†…éƒ¨æ²¡æœ‰æ ¹æ® `viewMode` åˆ‡æ¢å¸ƒå±€çš„ä»£ç                |

#### ä¿®å¤å»ºè®®

1. **ä¼ é€’ viewMode prop**ï¼š

```typescript
<QuoteItemsTable
  viewMode={viewMode}  // æ–°å¢
  quoteId={quote.id}
  // ...
/>
```

2. **QuoteItemsTable å†…éƒ¨å¢åŠ åˆ†æ”¯æ¸²æŸ“**ï¼š

```typescript
// quote-items-table.tsx
interface QuoteItemsTableProps {
  viewMode?: 'category' | 'room';
  // ...
}

// æ¸²æŸ“é€»è¾‘
if (viewMode === 'category') {
  // æŒ‰å“ç±»åˆ†ç»„æ¸²æŸ“
  return <CategoryGroupedTable items={items} />;
} else {
  // æŒ‰ç©ºé—´åˆ†ç»„æ¸²æŸ“ï¼ˆå½“å‰é»˜è®¤è¡Œä¸ºï¼‰
  return <RoomGroupedTable rooms={rooms} items={items} />;
}
```

---

## ä¸‰ã€å½±å“è¯„ä¼°

### ä¸šåŠ¡å½±å“

| å½±å“é¡¹     | è¯´æ˜                                         |
| ---------- | -------------------------------------------- |
| æŠ¥ä»·å•åˆ›å»º | ğŸ”´ å®Œå…¨é˜»å¡ - ç”¨æˆ·æ— æ³•åˆ›å»ºæœ‰æ•ˆæŠ¥ä»·å•         |
| é”€å”®æµç¨‹   | ğŸ”´ ä¸¥é‡ - çº¿ç´¢æ— æ³•è½¬åŒ–ä¸ºæŠ¥ä»·ï¼Œå½±å“é”€å”®è½¬åŒ–ç‡ |
| è®¢å•è½¬åŒ–   | ğŸ”´ é˜»å¡ - æ— æŠ¥ä»·å•åˆ™æ— æ³•ç”Ÿæˆè®¢å•             |
| è´¢åŠ¡æµç¨‹   | ğŸŸ¡ é—´æ¥å½±å“ - æ— è®¢å•åˆ™æ— è´¢åŠ¡æ•°æ®             |

### æŠ€æœ¯å€ºåŠ¡

| å€ºåŠ¡é¡¹         | è¯´æ˜                             |
| -------------- | -------------------------------- |
| è®¡ç®—å¼•æ“å¥å£®æ€§ | ç¼ºå°‘è¾“å…¥å‚æ•°æ ¡éªŒå’Œ NaN é˜²å¾¡      |
| ç»„ä»¶äº‹ä»¶å¤„ç†   | Command ç»„ä»¶äº‹ä»¶ç»‘å®šå¯èƒ½å­˜åœ¨é—®é¢˜ |
| åŠŸèƒ½å®Œæ•´æ€§     | è§†å›¾åˆ‡æ¢åŠŸèƒ½æœªå®Œæˆå®ç°           |

---

## å››ã€ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§  | é—®é¢˜                 | é¢„è®¡å·¥æ—¶ | ä¾èµ–å…³ç³» |
| ------- | -------------------- | -------- | -------- |
| P0-ç«‹å³ | Q-001 ä»·æ ¼è®¡ç®— NaN   | 2h       | æ—        |
| P0-ç«‹å³ | Q-002 å•†å“é€‰æ‹©æ— å“åº” | 2h       | æ—        |
| P1-æœ¬å‘¨ | Q-003 è§†å›¾åˆ‡æ¢æœªå®ç° | 4h       | æ—        |

---

## äº”ã€æµ‹è¯•éªŒè¯æ¸…å•

### Q-001 éªŒè¯

- [ ] é€‰æ‹©æœ‰ä»·æ ¼çš„å•†å“ï¼ŒéªŒè¯å•ä»·æ­£ç¡®æ˜¾ç¤º
- [ ] é€‰æ‹©æ— ä»·æ ¼çš„å•†å“ï¼ŒéªŒè¯æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
- [ ] ä¿®æ”¹å°ºå¯¸åï¼ŒéªŒè¯æ•°é‡è‡ªåŠ¨è®¡ç®—
- [ ] éªŒè¯çª—å¸˜/å¢™çº¸/å¢™å¸ƒä¸‰ç§å“ç±»çš„è®¡ç®—é€»è¾‘

### Q-002 éªŒè¯

- [ ] ç‚¹å‡»å•†å“ä¸‹æ‹‰ï¼ŒéªŒè¯åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] é€‰æ‹©å•†å“åï¼ŒéªŒè¯å•†å“åç§°æ­£ç¡®æ›´æ–°
- [ ] éªŒè¯æœ€è¿‘ä½¿ç”¨å•†å“æ­£ç¡®è®°å½•
- [ ] éªŒè¯æ‹¼éŸ³æœç´¢åŠŸèƒ½æ­£å¸¸

### Q-003 éªŒè¯

- [ ] åˆ‡æ¢åˆ°"å“ç±»ä¼˜å…ˆ"è§†å›¾ï¼ŒéªŒè¯æŒ‰å“ç±»åˆ†ç»„æ˜¾ç¤º
- [ ] åˆ‡æ¢åˆ°"ç©ºé—´ä¼˜å…ˆ"è§†å›¾ï¼ŒéªŒè¯æŒ‰ç©ºé—´åˆ†ç»„æ˜¾ç¤º
- [ ] éªŒè¯å“ç±» Tab åˆ‡æ¢åŠŸèƒ½

---

## å…­ã€ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶                                                                                                                                 | è¯´æ˜             |
| ------------------------------------------------------------------------------------------------------------------------------------ | ---------------- |
| [quote-items-table.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx)       | æŠ¥ä»·æ˜ç»†è¡¨æ ¼ç»„ä»¶ |
| [product-autocomplete.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/product-autocomplete.tsx) | å•†å“é€‰æ‹©ç»„ä»¶     |
| [quote-detail.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-detail.tsx)                 | æŠ¥ä»·è¯¦æƒ…é¡µé¢     |
| [curtain-strategy.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/calc-strategies/curtain-strategy.ts)      | çª—å¸˜è®¡ç®—ç­–ç•¥     |
| [calculator.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/logic/calculator.ts)                            | è®¡ç®—å¼•æ“         |
| [mutations.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/actions/mutations.ts)                            | æœåŠ¡ç«¯ Actions   |

---

_æŠ¥å‘Šç”Ÿæˆ: L2C äº§å“è¯Šæ–­ç³»ç»Ÿ_
