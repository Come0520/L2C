
# 线索模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/线索/线索.md`
> **涉及模块**：线索管理 (Leads)
> **优先级**：P1 (营销漏斗入口)

---

## 1. 数据接入与交互 (Integration)



### 1.2 外部线索捕获 API
**问题描述**：2.1 提及 "线上获客"，但未定义系统如何接收这些数据。
**整改动作**：
- [ ] **新增 12. 开放接口 (Webhook)**：
  - 定义 `POST /api/v1/leads/webhook` 接口标准。
  - 字段映射：定义外部字段 (如 `douyin_id`, `ad_source`) 如何映射到内部字段。
  - 签名验证：简单的 `Access-Token` 或签名校验机制。

---

## 2. 业务规则明确 (Business Rules)

### 2.1 分配规则 Scope 界定 (Phase 1)
**问题描述**：3.2 节列出的 "负载均衡"、"渠道指定"、"优秀奖励" 算法过于复杂，Phase 1 难以全部实现。
**整改动作**：
- [ ] **标记 Phase 1 范围**：
  - **分配策略**：
    - [x] 手动分配：店长手动分配线索给销售
    - 简单轮转：默认按销售顺序分配
    - 负载均衡：可选，可以点选启用
  - **高级策略（Phase 2）**：负载均衡（自动）、渠道指定、优秀奖励
- [x] **补充手动分配规则**：
  - 分配权限：店长可以手动分配线索
  - 分配流程：店长选择线索 → 选择销售 → 填写分配备注（选填）→ 确认分配 → 线索状态变更为"待跟踪" → 通知被分配的销售
  - 分配后处理：线索状态变更为"待跟踪"、通知被分配的销售（系统通知、微信小程序）、销售的待办列表中显示该线索
- [ ] **补充简单轮转规则**：
  - 默认规则：按销售顺序分配，循环分配，确保公平
  - 可选规则：负载均衡，可以点选启用，按销售当前线索数量分配，优先分配给线索数量少的销售
  - 轮转配置：系统设置中可以配置轮转规则，默认按销售顺序，可选负载均衡
- [ ] **补充分配限制**：
  - 暂时不限制：不限制销售的最大线索数量、不限制销售的最大未处理线索数量
  - 未来扩展（Phase 2）：可以设置销售的最大线索数量、可以设置销售的最大未处理线索数量
- [ ] **补充重新分配规则**：
  - 重新分配场景：销售离职、销售请假、销售调整岗位
  - 重新分配权限：店长可以重新分配线索
  - 重新分配流程：店长选择需要重新分配的线索 → 选择新的销售 → 填写重新分配原因（选填）→ 确认重新分配 → 线索状态变更为"待跟踪" → 通知原销售和新销售
  - 离职交接：一旦销售离职，店长必须将该销售的所有线索重新分配，系统提醒店长："销售 XXX 已离职，请重新分配其线索"，重新分配后，原销售无法查看这些线索
- [ ] **补充分配权限表**：
  | 角色 | 手动分配权限 | 重新分配权限 | 说明 |
  |:---|:---|:---|:---|
  | 店长（STORE_MANAGER） | ✅ 可以分配 | ✅ 可以重新分配 | 全部权限 |
  | 销售 | ❌ 不可分配 | ❌ 不可重新分配 | 无权限 |
- [ ] **补充线索状态流转**：
  - 分配后状态：`PENDING_DISPATCH`（待分配）→ `PENDING_FOLLOWUP`（待跟踪）
  - 重新分配后状态：`PENDING_FOLLOWUP`（待跟踪）→ `PENDING_FOLLOWUP`（待跟踪），重新分配不改变状态，只改变归属销售
- [ ] **补充前端界面设计**：
  - 线索列表页面：显示线索状态（待分配/待跟踪），提供"分配"/"重新分配"操作按钮
  - 分配弹窗：显示线索信息、选择销售、分配备注输入框（选填），确认后执行分配操作
  - 重新分配弹窗：显示线索信息、当前归属销售、选择新销售、重新分配原因输入框（选填），确认后执行重新分配操作

### 2.2 重复线索判定细节
**问题描述**：6.1 的 "活跃校验" 比较模糊，什么才算 "活跃"？
**整改动作**：
- [x] **精确定义 "活跃线索"**：
  - 定义确认：状态 **不等于** `WON` (已成交) 且 **不等于** `VOID` (已作废)
  - 即：`PENDING_DISPATCH`, `PENDING_FOLLOWUP`, `FOLLOWING` 状态的线索均视为活跃
  - **线索状态枚举**：
    | 枚举值 | 名称 | 是否活跃 |
    |:---|:---|:---|
    | `PENDING_DISPATCH` | 待分配 | ✅ 活跃 |
    | `PENDING_FOLLOWUP` | 待跟踪 | ✅ 活跃 |
    | `FOLLOWING` | 跟进中 | ✅ 活跃 |
    | `WON` | 已成交 | ❌ 不活跃 |
    | `VOID` | 已作废 | ❌ 不活跃 |
- [ ] **补充重复线索检测规则**：
  - 检测规则：按手机号查重，若同一手机号存在活跃线索，视为重复线索
  - 检测时机：创建线索时、导入线索时、Webhook 接收线索时
- [ ] **补充重复线索处理流程**：
  - 检测到重复线索 → 显示重复线索信息 → 提供处理选项（合并线索/取消创建/强制创建）→ 用户选择处理方式 → 记录操作到线索历史
  - 建议合并处理：系统建议合并线索，最后交给人工判断
- [ ] **补充强制创建规则**：
  - 使用场景：同一客户的不同需求、同一客户的多个联系人、特殊业务场景
  - 权限要求：老板（ADMIN）、店长（STORE_MANAGER）可以使用 `force_create=true` 参数，其他角色不能使用
  - API 示例：POST /api/v1/leads，参数包含 `force_create: true`（仅老板/店长可以使用）
- [ ] **补充重复线索通知**：
  - 通知时机：检测到重复线索时
  - 通知对象：归属销售（如果存在活跃线索）
  - 通知内容："检测到重复线索：手机号 138****1234，已存在活跃线索 L-001"
  - 通知渠道：系统通知、微信小程序
- [ ] **补充合并线索流程**：
  - 合并权限：老板、店长可以合并线索
  - 合并流程：选择主线索（保留的线索）→ 选择从线索（合并的线索）→ 选择合并字段优先级（非空字段优先/最新更新优先/主线索优先）→ 填写合并原因（选填）→ 确认合并 → 从线索状态变更为 VOID（已作废）→ 主线索保留，从线索数据合并到主线索 → 记录合并操作到线索历史
- [ ] **补充前端界面设计**：
  - 重复线索提示弹窗：显示重复线索信息（线索ID、客户姓名、状态、归属销售），提供处理选项（合并线索/取消创建/强制创建）
  - 合并线索弹窗：选择主线索、选择从线索、选择合并字段优先级、合并原因输入框（选填），确认后执行合并操作

---

## 执行计划清单 (Action Checklist)

- [x] **第一步：数据接入**

- [ ] **第二步：规则界定**
  - [ ] 明确 Phase 1 分配策略仅限手动和轮转 (Scope)
  - [x] 精确定义活跃线索状态集合 (Logic)

<br/>

---
---

---

---

---

# 📦 报价模块 (Quote Module) 综合整改计划

> **目标文档**: `docs/02-requirements/modules/报价单/报价单.md`
> **审计报告**: `docs/02-requirements/modules/报价单/quote-module-audit-20260116.md`
> **优先级**: P0 (核心交易转化入口)
> **⚠️ 状态**: P0/P1 核心项已完成 ~80%，详见 `docs/（已完成）.md`
> **当前完成度**: ~80%
> **复杂度**: ⭐⭐⭐⭐⭐

---

## 1. 核心问题与待完成项 (Core Issues & Pending)

### 1.1 业务校验与自动化
- [x] **尺寸合理性校验 (4.3.1)** ✅ 完成于 2026-01-20：
    - 高度限制：若 `Height > 400cm`，提示确认 "是否为复式/挑高"。
    - 宽度限制：若 `Width > 1000cm`，提示确认 "是否需分段"。
    - 系统硬限制：高度 1000cm，宽度 2000cm（租户可自定义更低的警告阈值）
- [x] **测量数据导入** ✅ 已实现完成：支持数据预览与解析
    - `MeasureDataImportDialog` 组件：两步式导入 UI
    - `QuoteService.previewMeasurementImport/executeMeasurementImport`：服务层实现
- [x] **过期处理自动化** ✅ 已完成：
    - `QuoteExpirationBanner` 组件：过期警告与一键刷新价格
    - `api/cron/quotes/expire`：批量处理接口
    - 访问详情页自动检查过期逻辑

### 1.2 数据库 Schema 修正与增强
- [x] **版本管理约束 (P0)** ✅ 已确认：通过 `idx_quotes_active_version` 唯一索引实现。
- [x] **引用完整性** ✅ 已确认：`quote_items` 表已有 `room_id` 级联删除。
- [x] **软删除/归档** ✅ 已完成：在 `quotes` 表添加 `archived_at` 字段，并增强 `productId` 外键约束。
- [x] **JSONB 字段接口标准化 (P1)** ✅ 已完成：为 `attributes` 和 `calculationParams` 定义了 Zod Schema 和 TS 类型并应用。
- [x] **快照机制实现 (P0)** ✅ 已完成：在 `orders` 表中添加了 `quote_snapshot` 字段，并在生成订单时深度克隆报价及产品数据。

---

## 2. 核心业务逻辑补齐 (P0 - Critical)

### 2.1 报价模式配置系统
- [ ] **租户级动态表单**：支持“快速模式”与“高级模式”，基于租户配置动态渲染字段。
- [ ] **三级优先级配置**：System > Tenant > User 个人配置。

### 2.2 计算引擎完整性审查
- [ ] **窗帘计算引擎**：验证成品高/宽、裁剪损耗、定高/定宽分支逻辑；实现超高预警。
- [ ] **墙纸计算引擎**：实现对花/无对花计算、多墙段聚合、总卷数计算。
- [ ] **墙布计算引擎**：验证幅宽与损耗逻辑，实现高度约束校验。
- [ ] **嵌套附件联动**：实现绑带、抱枕、胶水/基膜的自动数量推荐与小计。

### 2.3 版本管理与流转
- [ ] **状态机完善**：确保激活新版本时自动降级旧版本。
- [ ] **订单流转路由**：基于 `category_tag` 自动分流至采购单或内部工单。

---

## 3. UI/UX 与类型修复

### 3.1 性能与交互优化
- [ ] **智能联想 (Autocomplete)**：防抖处理 + 客户端缓存 + 拼音搜索。
- [ ] **嵌套附件 UI**：支持树形表格编辑，行内小计动态更新。
- [ ] **版本对比视图 (P2)**：实现“苹果风”并侧对比，高亮展示差异（红/绿/黄）。

### 3.2 TypeScript 类型错误修复 (P0)
- [ ] 运行 `pnpm type-check` 并修复报价相关组件（Dialog, VersionCompare, SummaryPanel）中的所有 `any` 和接口缺失。

---

## 4. 执行计划清单 (6周时间表)

| 周次 | 核心任务 | 目标完成度 |
|:---:|:---|:---:|
| Week 1 | 类型错误修复 + Schema 约束 + 快照机制 | 45% |
| Week 2 | 三大计算引擎验证与单元测试 (覆盖率>80%) | 60% |
| Week 3 | 模式配置系统 + 动态表单实现 | 70% |
| Week 4 | 版本管理逻辑 + 订单流转路由 | 80% |
| Week 5 | 智能联想优化 + 嵌套附件 UI 完善 | 90% |
| Week 6 | 集成测试 (E2E) + 性能优化 + 文档交付 | 95%+ |

---

---
---

# 售后模块需求整改计划 (已完成 ✅)

> **状态**：已于 2026-01-20 完成并迁移至 `（已完成）.md`
> 
> **完成内容**：
> - 仲裁/定责工作台 (`ArbitrationWorkbench`)
> - 客户评价闭环 (`CustomerFeedbackPage`)  
> - 扣款安全水位 (`deduction-safety.ts`)
> - 虚拟成本核算 (`virtual-cost-accounting.ts`)

---
---

# 财务模块需求整改计划 (P1 已完成 ✅)

> **状态**：P1 核心功能于 2026-01-20 完成并迁移至 `（已完成）.md`
> 
> **完成内容**：
> - 资金调拨 (`internal_transfers` 表 + `createInternalTransfer`)
> - 客户退款 (`processCustomerRefund` 关联红字 AR)
> - 供应商退款 (`createSupplierRefundStatement` 负向 AP)
> - 对账分层 (L1 业务核销 vs L2 账单确认)
> - 佣金结算被动触发 (AR PAID 时自动计算)
>
> **待完成(P2)**：文档迁移整理

---
---

# 数据报表需求整改计划 (已完成 ✅)

> **状态**：已于 2026-01-20 完成并迁移至 `（已完成）.md`
> 
> **完成内容**：
> - 利润率计算 (`getProfitMarginAnalysis` 毛利/毛利率/月度趋势)
> - 售后健康度 (`getAfterSalesHealth` 退款率/客诉率/责任分布)
> - 图表钻取 (`ChartDrilldown` 多级下钻 + 面包屑导航)
> - 移动端适配 (`analytics-mobile.css` 响应式布局)

---
---

# 通知模块需求整改计划 (已完成 ✅)

> **状态**：已于 2026-01-20 完成并迁移至 `（已完成）.md`
> 
> **完成内容**：
> - 模板配置化 (`notificationTemplates` 表)
> - 变量映射标准化 (`paramMapping` JSONB 字段)
> - 异步队列 (`notificationQueue` 表 + 重试策略)
> - 系统广播优化 (`systemAnnouncements` 表)

---
---

# 系统设置需求整改计划 (已完成 ✅)

> **状态**：已于 2026-01-20 完成并迁移至 `（已完成）.md`
> 
> **完成内容**：
> - 劳务工费定价 (`LaborPricingConfig` 窗帘/墙纸安装费配置)
> - 财务基础配置 (`FinanceBaseConfig` 税率/付款条款)
> - 租户功能控制 (`TenantFeatureControl` 模块开关/安全设置)

---
---

# 全链路溯源需求整改计划 (已完成 ✅)

> **状态**：已于 2026-01-20 完成并迁移至 `（已完成）.md`
> 
> **完成内容**：
> - 批次追踪 (`batchTraces` + `orderBatchLinks` 表)
> - 风险控制 (`riskAlerts` 风险预警表)
> - 证据链 Schema (`evidenceChains` GPS/哈希验证)

---
---

# 测量模块需求整改计划

> **目标文档**: `docs/02-requirements/modules/测量/测量单.md`
> **分析报告**: `docs/02-requirements/modules/测量/测量模块差异分析报告_20260118.md`
> **详细计划**: `docs/02-requirements/modules/测量/测量模块整改计划_20260116.md`
> **涉及模块**: 测量管理 (Measurement)
> **优先级**: P0 (核心业务流程入口)
> **当前完成度**: 50-55%
> **目标完成度**: 85%+

---

## 1. 数据库Schema修正 (Database Schema)

### 1.1 版本管理字段缺失
**问题描述**: 需求文档中定义的 Round + Variant 双层版本体系，在 `measure_tasks` 表中缺少关键字段。
**整改动作**:
- [x] **新增字段**:
  - `version_display` (VARCHAR): 版本展示号，如 V1.A, V2.B
  - `parent_id` (UUID): 关联上一版本ID，用于版本追溯
- [ ] **更新业务逻辑**: 完善 `createNewMeasureVersion` 函数，自动生成版本号

### 1.2 API文档与Schema枚举不一致
**问题描述**: API文档使用了 `PENDING_REVIEW` 和 `REJECTED` 状态，但 `enums.ts` 未定义。
**整改动作**:
- [ ] **修正API文档**: 将 `PENDING_REVIEW` 统一改为 `PENDING_CONFIRM`
- [ ] **删除REJECTED状态**: 使用 `rejectCount > 0` 判断驳回状态

---

## 2. 核心业务逻辑补齐 (P0 - Critical)

### 2.1 拆单机制 (2天)
**问题描述**: 完全缺失按品类拆分测量任务的功能，影响多品类业务。
**整改动作**:
- [x] **数据库**: 创建 `measure_task_splits` 表
- [ ] **业务逻辑**:
  - [ ] 实现 `analyzeSplitRequirement(quoteId)` - 品类分析
  - [ ] 实现 `recommendWorkers(category)` - 师傅推荐
  - [ ] 实现 `splitMeasureTask(quoteId, splitPlan)` - 执行拆单
  - [ ] 添加拆单唯一性校验
- [ ] **UI组件**: 创建 `SplitTaskDialog.tsx`

### 2.2 费用准入机制 (1.5天)
**问题描述**: 定金检查、审批豁免功能完全缺失，可能导致免费测量滥用。
**整改动作**:
- [ ] **业务逻辑**:
  - [ ] 实现 `checkEarnestMoney(leadId)` - 定金查询
  - [ ] 实现 `applyFeeWaiver(taskId, reason)` - 申请豁免
- [ ] **API Actions**:
  - [ ] 新增 `checkMeasureFeeStatus(taskId)`
  - [ ] 新增 `requestFeeWaiver(taskId, reason)`
- [ ] **UI组件**: 创建 `FeeWaiverDialog.tsx`

### 2.3 现场考核增强 (1天)
**问题描述**: 签到仅保存GPS，未实现距离校验、迟到判定。
**整改动作**:
- [ ] **GPS距离校验**:
  - [ ] 实现 Haversine 公式计算距离
  - [ ] 距离 > 500m 显示警告但允许签到
- [ ] **迟到判定**:
  - [ ] 比较 `checkInAt` 和 `scheduledAt`
  - [ ] 添加 `isLate` 和 `lateMinutes` 字段
- [ ] **UI反馈**: 签到时显示距离和迟到信息

### 2.4 驳回预警机制 (0.5天)
**问题描述**: 累计驳回3次预警逻辑缺失。
**整改动作**:
- [ ] 在 `reviewMeasureTask` 中添加驳回次数检查
- [ ] **驳回≥3次**: 自动通知店长
- [ ] **UI展示**: 任务详情页显示驳回次数徽章

---

## 3. UI/UX完善 (P1 - High Priority)

### 3.1 分页与筛选 (1天)
**整改动作**:
- [ ] **分页组件**: 替换 `{/* Pagination TODO */}` 注释
- [ ] **日期筛选**: 在 `MeasurementFilterBar` 添加日期范围选择
- [ ] **高级筛选**: 添加测量师、销售人员筛选

### 3.2 版本管理UI (1.5天)
**整改动作**:
- [ ] **创建组件**: `VersionSwitcher.tsx`
- [ ] **显示当前版本**: 如 V1.A
- [ ] **版本切换**: 列出所有历史版本
- [ ] **新建功能**: "创建方案B"、"发起复测" 按钮

### 3.3 操作日志 (1天)
**整改动作**:
- [ ] **查询审计日志**: 从 `audit_logs` 表获取历史
- [ ] **创建组件**: `OperationTimeline.tsx`
- [ ] **时间轴展示**: 驳回记录标红显示

### 3.4 转报价功能 (0.5天)
**整改动作**:
- [ ] 列表页添加"转报价"按钮 (仅COMPLETED状态)
- [ ] 跳转至报价创建页并自动带入测量数据

---

## 4. 小程序端开发 (P0 - Critical)

### 4.1 任务列表页 (1.5天)
**整改动作**:
- [ ] 创建 `src/app/(mobile)/measure/page.tsx`
- [ ] 卡片式布局展示任务
- [ ] 实现筛选Tab (待接单/待上门/已完成)
- [ ] 一键导航功能 (调用微信 `openLocation`)

### 4.2 测量数据录入 (2天)
**整改动作**:
- [ ] 创建 `[id]/submit/page.tsx`
- [ ] 大按钮设计 (高度 56px)
- [ ] 步骤式录入表单
- [ ] **实时保存草稿** (localStorage)
- [ ] **照片上传**:
  - [ ] 调用微信 `chooseImage`
  - [ ] 前端压缩至 500KB
  - [ ] 上传到OSS

### 4.3 签到打卡增强 (0.5天)
**整改动作**:
- [ ] 完善 `gps-check-in.tsx`
- [ ] 显示距离客户地址距离
- [ ] 超范围黄色警告

### 4.4 离线能力 (2天)
**整改动作**:
- [ ] **离线缓存**: 使用 IndexedDB 存储任务
- [ ] **离线录入**: 数据暂存队列
- [ ] **网络恢复同步**:
  - [ ] 监听 `onNetworkStatusChange`
  - [ ] 自动上传队列
  - [ ] 显示同步进度
- [ ] **冲突处理**: 弹窗提示用户选择

---

## 5. 缺失API补充

### 5.1 高优先级API (P0)
- [ ] `POST /tasks/{id}/cancel` - 取消测量任务
- [ ] `POST /tasks/{id}/fee-waiver` - 费用豁免申请
- [ ] `GET /tasks/{id}/fee-status` - 费用状态查询
- [ ] `POST /tasks/{id}/remeasure` - 创建复测任务

---

## 6. 执行计划清单 (4周时间表)

### **第一周 (Day 1-7)**: 核心业务逻辑 → 目标完成度 55%
- [ ] 拆单机制实现
- [ ] 费用准入功能
- [ ] 现场考核增强
- [ ] 驳回预警机制

### **第二周 (Day 8-14)**: UI/UX完善 → 目标完成度 70%
- [ ] 分页与筛选增强
- [ ] 版本管理UI
- [ ] 操作日志展示
- [ ] 状态进度条
- [ ] 转报价功能

### **第三周 (Day 15-21)**: 小程序端开发 → 目标完成度 85%
- [ ] 小程序任务列表
- [ ] 测量数据录入表单
- [ ] 签到打卡增强
- [ ] 离线能力基础版

### **第四周 (Day 22-28)**: 集成测试 → 目标完成度 90%+
- [ ] E2E测试 (完整流程、拆单、驳回、离线)
- [ ] 性能优化
- [ ] 文档与培训

---

## 7. 资源需求

| 角色 | 人数 | 时间投入 | 主要职责 |
|:---|:---:|:---|:---|
| **后端工程师** | 1人 | 全职4周 | 业务逻辑、API、数据库 |
| **前端工程师** | 1人 | 全职4周 | Web端UI/UX |
| **小程序工程师** | 1人 | 2周 (第3-4周) | 小程序开发、离线能力 |
| **测试工程师** | 1人 | 1周 (第4周) | E2E测试、Bug修复 |

**总人天估算**: 约 **80人天**

---

## 8. 风险提示

1. **🔴 严重**: 拆单逻辑与实际业务不符 - 第一周完成后立即与业务方验证
2. **🔴 严重**: 小程序端缺失导致测量师无法实际使用
3. **🟡 高**: 离线同步冲突处理 - 需实现版本号机制
4. **🟡 高**: GPS定位不准确 - 允许500m误差，记录但不阻塞

---

## 9. 参考文档

- [测量模块差异分析报告](./02-requirements/modules/测量/测量模块差异分析报告_20260116.md)
- [测量模块整改计划详细版](./02-requirements/modules/测量/测量模块整改计划_20260116.md)
- [测量模块整改任务清单](./02-requirements/modules/测量/测量模块整改任务清单_20260116.md)

---

<br/>

---
---


---
---


# 采购单模块需求整改计划 (已迁移至 `docs/（已完成）.md`)

> **说明**: 此章节所有内容已于 2026-01-18 完成并迁移至归档文档。

---



## 📦 订单模块 (Order Module) - 已完成 ✅

> **状态**：已于 2026-01-20 完成并迁移至 `（已完成）.md`
> 
> **完成内容**：
> - `HALTED` 状态机 (`orderStatusEnum` 新增状态)
> - 叫停/恢复机制 (`haltOrder` / `resumeOrder`)
> - 长期叫停预警 (`checkAndWarnLongHaltedOrders` 24h/48h/72h 分级)
> - 性能优化 (`unstable_cache` + React Query 分页)

---

**整改计划持续更新中...**

