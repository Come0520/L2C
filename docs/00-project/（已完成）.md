# 已完成整改项

> **最后更新**: 2026-01-20

本文档记录项目中已完成的所有需求整改、功能实现和优化任务。按模块分类组织，便于追溯和查阅。

---

## 目录

- [报价模块 (Quotes)](#报价模块-quotes)
- [订单模块 (Orders)](#订单模块-orders)
- [财务模块 (Finance)](#财务模块-finance)
- [审批流程 (Approval)](#审批流程-approval)
- [商品管理 (Products)](#商品管理-products)
- [客户管理 (Customers)](#客户管理-customers)
- [渠道管理 (Channel)](#渠道管理-channel)
- [线索管理 (Leads)](#线索管理-leads)
- [通知模块 (Notifications)](#通知模块-notifications)
- [供应链 (Supply Chain)](#供应链-supply-chain)
- [售后服务 (After Sales)](#售后服务-after-sales)
- [服务模块 (Service)](#服务模块-service)
- [数据报表 (Analytics)](#数据报表-analytics)
- [系统设置 (Settings)](#系统设置-settings)
- [全链路溯源 (Traceability)](#全链路溯源-traceability)
- [API 文档](#api-文档)
- [代码质量 (Quality)](#代码质量-quality)

---

## 报价模块 (Quotes)

**完成日期**: 2026-01-16 ~ 2026-01-19  
**完成度**: ~85%

### 核心问题修复

- [x] **折扣风控体系** - 实现 `validateRiskControl` 逻辑 + 审批联动
- [x] **状态流转 API** - 实现 `submitQuote`, `acceptQuote`, `rejectQuote`
- [x] **报价模式配置系统** - 实现三级配置合并 (System > Tenant > User)
- [x] **前端实时计算逻辑** - Calculator 支持动态损耗参数

### 功能实现

- [x] **PDF 报价单生成** - `QuotePdfDocument` 组件 (支持客户版/内部版)
- [x] **Excel 批量导入** - `QuoteExcelImportDialog` + `batchImportQuoteItems`
- [x] **版本对比视图** - `QuoteVersionCompare` (侧并侧 + 差异高亮)
- [x] **商品图片展示** - `QuoteItemsTable` 缩略图列
- [x] **嵌套附件 UI** - 树形结构渲染 (缩进/连接线)
- [x] **E2E 测试** - 标准流程 + 风控流程测试用例

### 配置体系

- [x] **QuoteConfig Schema** - 支持 ECONOMIC/COMFORT/LUXURY 三级模式
- [x] **QuoteConfigService** - 配置深度合并逻辑
- [x] **QuoteConfigDialog UI** - 模式切换 + 方案配置编辑

### 版本管理与快照

- [x] **版本管理策略**: 实现 `createNewVersion` / `setActiveVersion`
- [x] **版本号规则**: `V1`, `V2`, `V3` 自增
- [x] **状态隔离**: 仅 ACTIVE 版本可被编辑
- [x] **快照存储结构**: `orders.snapshot_data` JSONB 字段存储完整报价快照

### 验证规则

- [x] **最低价校验**: 折扣低于阈值触发审批流程
- [x] **负毛利拦截**: 风控规则集成在 `quoteLifecycleService`
- [x] **报价单有效期**: `quotes.expires_at` 字段已存在

### 报价模板库

- [x] `saveQuoteAsTemplate` - 保存报价配置为模板
- [x] `getQuoteTemplates` - 获取模板列表 (支持按分类筛选)
- [x] `applyQuoteTemplate` - 一键应用模板
- [x] `deleteQuoteTemplate` - 删除模板

### AI 报价助手

- [x] `getQuoteRecommendations` - 根据预算/房间类型推荐产品组合

### 计算策略文档

- [x] 创建 `calc-strategies/README.md` - 架构设计、核心接口、策略详解、扩展指南

### 待完成项 (P2/P3)

- [ ] **测量数据导入** - 需测量模块先完成
- [ ] **拼音搜索** - 商品库添加 pinyin 字段
- [ ] **性能优化** - 计算引擎缓存
- [ ] **单元测试 >80%** - 计算引擎测试覆盖

---

## 订单模块 (Orders)

**完成日期**: 2026-01-18 ~ 2026-01-20  
**完成度**: ~95%

### 核心功能

- [x] **订单快照机制** - Schema 已添加 `snapshotData` 字段
- [x] **状态机定义** - 状态流转逻辑已实现
- [x] **订单快照控制** - 100% 可用
- [x] **变更单端到端流程** - 可执行
- [x] **智能拆单逻辑** - 准确率≥95%
- [x] **18个核心 API** - 全部实现

### 订单快照

- [x] **快照内容**: 报价完整数据、客户基础信息、商品信息、价格信息
- [x] **快照时机**: 订单创建时
- [x] **更新规则**: 订单创建后快照不再更新
- [x] **快照展示**: 同时展示快照和最新数据 (对比显示)

### 客户验收状态

- [x] **状态定义**: `PENDING_CONFIRMATION` 待客户验收
- [x] **触发条件**: 安装完成后需要客户验收
- [x] **确认操作**: 客户/销售可确认验收
- [x] **驳回操作**: 支持驳回 + 选择处理方式
- [x] **超时处理**: 24小时超时通知销售跟进
- [x] **通知机制**: 微信小程序、短信通知

### 变更单机制

- [x] **变更场景**: 现场变化、客户变化、商品缺货、其他变更
- [x] **变更权限**: 仅 `PENDING_PO` 和 `PENDING_CONFIRMATION` 状态可变更
- [x] **审批流程**: 店长 → 老板 → 采购
- [x] **差价处理**: 补差价/退差价自动计算
- [x] **`calculateDiff()` 自动计算差价**
- [x] **审批通过后自动更新订单金额**
- [x] **order_changes 表结构定义**

### 物流查询

- [x] **物流服务商**: 快递100 集成
- [x] **物流信息**: tracking_number, company, status, shipped_at, delivered_at
- [x] **轨迹展示**: 时间轴展示
- [x] **异常处理**: 获取失败重试、物流超时提醒

### 叫停机制

- [x] **HALTED 状态**: `orderStatusEnum` 添加 `HALTED` 状态
- [x] **`haltOrder()` 叫停订单**
- [x] **`resumeOrder()` 恢复订单**
- [x] **`checkAndWarnLongHaltedOrders()` 长期叫停预警**
- [x] **预警策略**: 24h/48h/72h 分级提醒
- [x] **`pauseCumulativeDays` 记录累计天数**

### 性能优化

- [x] **服务端缓存**: `unstable_cache` 包装查询
- [x] **服务端分页**: 每页 20 条
- [x] **React Query 集成**: 平滑分页体验

---

## 财务模块 (Finance)

**完成日期**: 2026-01-19 ~ 2026-01-20

### 对账单生成

- [x] **`generateAggregatedStatement`** - 按客户和时间范围查询应收账单
- [x] **`generatePeriodStatements`** - 支持周/双周/月三种周期

### 收款计划管理

- [x] **`createPaymentPlan`** - 多节点收款计划创建 (百分比验证)
- [x] **`getPaymentDueReminders`** - 到期提醒查询

### 坏账核销流程

- [x] **`submitBadDebtWriteOff`** - 坏账核销申请提交
- [x] **`processBadDebtApproval`** - 审批通过后更新账单状态为 BAD_DEBT

### 复杂对账逻辑

- [x] **`batchWriteOff()`** - 多单据核销
- [x] **`crossPeriodReconciliation()`** - 跨期对账
- [x] **L1 业务核销 vs L2 账单确认分层定义**

### 资金管理

- [x] **`createInternalTransfer()`** - 内部账户互转 + 双向流水记录
- [x] **`processCustomerRefund()`** - 客户退款处理 + 红字 AR 对账单
- [x] **`createSupplierRefundStatement()`** - 供应商退款负向 AP 处理

### 佣金结算

- [x] **佣金被动触发** - AR 状态变更为 PAID 时自动计算佣金

### E2E 测试覆盖

- [x] `finance-ar.spec.ts` - 应收账款流程
- [x] `finance-ap.spec.ts` - 应付账款流程
- [x] `finance-ar-advanced.spec.ts` - 高级 AR 场景
- [x] `finance-debt-ledger.spec.ts` - 账龄分析
- [x] `finance-settings.spec.ts` - 财务设置
- [x] `payment-order-audit.spec.ts` - 收款单审核

---

## 审批流程 (Approval)

**完成日期**: 2026-01-20

### 业务逻辑修正

- [x] **特殊工费阈值**: 全文统一为 120%
- [x] **坏账核销账龄**: 全文统一为 90 天
- [x] **通知渠道枚举统一**: SYSTEM / WECHAT_MINI / SMS / WECHAT_OFFICIAL

### 核心审批场景

- [x] **付款审批 (4.11)**: 供应商付款、劳务费结算
- [x] **退款审批 (4.12)**: 订单撤销、多收退款、售后赔付
- [x] **审批人角色枚举 (5.5)**: STORE_MANAGER / ADMIN / FINANCE / PURCHASING / DISPATCHER

### 叫停恢复逻辑

- [x] **叫停申请**: 销售发起 → 店长/采购审批
- [x] **分级提醒**: 0-24h 弱提醒、24-48h 中提醒、48h 强提醒
- [x] **延期机制**: 无需审批，7天延期，无限次
- [x] **自动恢复**: 48小时后未延期则自动恢复生产

### 并行会签支持

- [x] **会签模式**: ANY (任意通过) / ALL (全部通过) / MAJORITY (多数通过)
- [x] **超时处理**: 每个节点可设置超时时间，超时后继续提醒
- [x] **驳回处理**: 任意一人驳回则申请被驳回

### 审批撤回与修正

- [x] **发起人撤回**: 状态为 PENDING 且 24 小时内
- [x] **审批人撤回**: 已通过 30 分钟内且下一节点未处理

### 审批委托

- [x] **委托类型**: 临时委托、长期委托、单次转交
- [x] **委托权限**: 被委托人需具备同等或更高权限
- [x] **委托表结构**: `approval_delegations`, `approval_transfers`

### 移动端体验

- [x] **审批卡片**: 关键信息摘要
- [x] **快捷操作**: 列表页左滑通过/驳回
- [x] **附件预览**: 支持 JPG/PNG/PDF/Word/Excel 等

### 报表可视化

- [x] **报表指标**: 审批类型、数量、审批时长
- [x] **图表类型**: 饼图、柱状图、趋势图
- [x] **时间维度**: 月/年切换、自定义时间范围
- [x] **钻取功能**: 多层级下钻到审批单列表
- [x] **导出功能**: Excel/PDF 格式

### 风控集成

- [x] **[Approval-01] 报价折扣审批** - 低折扣触发审批流程
- [x] **[Approval-02] 订单变更审批** - 变更单差价自动计算
- [x] **[Approval-03] 财务付款审批** - 大额付款触发老板审批
- [x] **[Approval-04] 风控极端测试** - 负毛利拦截、审批超时测试

---

## 商品管理 (Products)

**完成日期**: 2026-01-19

### 业务逻辑

- [x] **套餐超出处理模式**: FIXED_PRICE / IGNORE / ORIGINAL / DISCOUNT
- [x] **单位换算逻辑 (4.7)**: stock_unit / sales_unit / conversion_rate
- [x] **商品状态枚举**: ACTIVE (正常) / OFF_SHELF (下架)
- [x] **下架上架流程**: 完整权限控制和流程定义
- [x] **SKU 重用规则**: 下架后 SKU 可继续使用

### 核心功能

- [x] **图片管理**: `images` 字段 (JSONB array of URLs)
- [x] **SKU 生成规则 (4.8)**: `{CategoryCode}-{YYYY}{Increment}`
- [x] **价格变动记录 (15.3)**: `product_price_history` 表

### 导入导出

- [x] **导入模板**: 按品类生成不同模板
- [x] **属性解析**: `attr:字段名` 格式映射到 JSONB
- [x] **校验机制**: 必填字段、数据类型、枚举值、唯一性
- [x] **导出功能**: 按品类/状态/时间范围筛选

### 动态属性模板

- [x] **新增属性类型**: DATE / TEXTAREA / COLOR / IMAGE / RANGE
- [x] **校验配置**: min / max / step / maxLength
- [x] **帮助说明**: description 字段

### 批量导入优化

- [x] **`batchCreateProducts`** - 批量处理 + 逐条校验 SKU 唯一性
- [x] **导入结果展示**: 成功/失败数量、错误详情

### 供应商关联

- [x] **`compareSupplierPrices`** - 价格对比 + 智能推荐
- [x] **`autoSwitchDefaultSupplier`** - 支持 LOWEST_PRICE / SHORTEST_LEAD_TIME / BALANCED 策略

### E2E 测试

- [x] 产品列表/搜索/筛选/新建/详情/批量导入测试

---

## 客户管理 (Customers)

**完成日期**: 2026-01-19

### 数据安全与隐私

- [x] **手机号脱敏**: 默认展示 `138****1234`
- [x] **查看权限**: 归属销售 + 店长可查看完整号码 + 操作日志
- [x] **导出控制**: 二次密码确认或仅导出脱敏数据

### 合并逻辑细化

- [x] **字段优先**: 非空字段优先，冲突保留最新更新
- [x] **关联数据迁移**: Orders, Quotes, Leads, AfterSales 全部更新外键
- [x] **不可逆警告**: 合并操作不可撤销

### CRM 状态流转

- [x] **订单取消/全额退款事件**: 状态回退至 SIGNED 或 OPPORTUNITY

### 客户画像

- [x] **`getCustomerProfile`** - 累计交易金额、最近购买、购买频次、平均订单金额

### 客户价值分层

- [x] **RFM 模型**: Recency / Frequency / Monetary 评分 1-5
- [x] **价值标签**: HIGH_VALUE / POTENTIAL / NORMAL / SLEEPING / LOST

### 转介绍追踪

- [x] **`getReferralChain`** - 推荐人信息、被推荐人列表、二级推荐统计

---

## 渠道管理 (Channel)

**完成日期**: 2026-01-18

### 佣金回退机制

- [x] **全额退款**: 待结算佣金标记为 Void，已结算则生成负向扣减
- [x] **部分退款**: 按比例重新计算佣金，差额调整

### 外部访问性澄清

- [x] **Phase 1 阶段**: 仅供内部使用，渠道方通过微信/短信接收业绩通报

### 渠道与财务交互

- [x] **结算单据链路**: 渠道佣金结算 → PaymentRequest → 财务审批 → 出纳打款
- [x] **款项类型**: `COMMISSION_PAYOUT` (佣金支付)

---

## 线索管理 (Leads)

**完成日期**: 2026-01-18 ~ 2026-01-19

### 数据导入

- [x] **基础导入功能**: `ExcelImportDialog` 已实现
- [x] **查重策略**: 手机号/地址查重 (重复时跳过并报错)
- [x] **渠道匹配**: 支持渠道名称模糊匹配

### 开放接口 (Webhook)

- [x] **接口定义**: `POST /api/v1/leads/webhook`
- [x] **字段映射**: `douyin_id`, `ad_source` 等
- [x] **签名验证**: Access-Token 校验

### 分配规则 (Phase 1)

- [x] **手动分配**: 店长手动分配线索给销售
- [x] **简单轮转**: 默认按销售顺序分配
- [x] **负载均衡**: 可选启用

### 线索评分

- [x] **`calculateLeadScore`** - 来源权重 + 意向度权重 + 预算权重
- [x] **总分 0-100**: 星级 1-5
- [x] **优先级标签**: 热门/优质/普通/待培育

### 批量去重

- [x] **`checkLeadDuplicate`** - 手机号精确 + 地址模糊 + 姓名辅助
- [x] **`batchCheckLeadDuplicates`** - 批量去重检查

---

## 通知模块 (Notifications)

**完成日期**: 2026-01-19 ~ 2026-01-20

### 微信服务号推送

- [x] **`wechat-adapter.ts`** - 微信服务号/小程序适配器
- [x] **Access Token 缓存**: 避免频繁请求
- [x] **用户 OpenID 绑定**: 从数据库读取
- [x] **Mock 模式**: 无配置时自动降级
- [x] **Token 过期自动刷新**

### 用户偏好设置

- [x] **后端 Actions**: get/update/batchUpdate NotificationPreferences
- [x] **前端组件**: 9 种通知类型 × 6 种渠道
- [x] **实时保存**: 乐观更新 + 回滚机制

### 模板配置化

- [x] **`notificationTemplates` 表**: code / titleTemplate / contentTemplate / paramMapping
- [x] **变量映射标准化**: key / label / source / defaultValue

### 异步队列

- [x] **`notificationQueue` 表**: 优先级 + 重试策略 + 延迟发送
- [x] **`processNotificationQueue()`** - 批量处理

### 系统广播

- [x] **`systemAnnouncements` 表**: 置顶 + 角色筛选 + 有效期

---

## 供应链 (Supply Chain)

**完成日期**: 2026-01-19 ~ 2026-01-20

### 待采购池

- [x] **`getPendingPurchasePool`** - 汇总订单中需采购商品
- [x] **`createMergedPurchaseOrder`** - 跨订单合并采购
- [x] **`batchUpdatePoStatus`** - 批量更新采购单状态
- [x] **`batchDeleteDraftPOs`** - 批量删除草稿采购单

### 供应商评价

- [x] **`getSupplierRating`** - 交期准时率 + 质量合格率 + 综合评分
- [x] **`getSupplierRankings`** - 所有供应商评价排名

### 库存管理

- [x] **`adjustInventory()` / `transferInventory()`** - 库存调整
- [x] **`checkInventoryAlerts()` / `setMinStock()`** - 预警机制

### E2E 测试

- [x] 待采购池/批量选择/合并采购/供应商评价测试

---

## 售后服务 (After Sales)

**完成日期**: 2026-01-19 ~ 2026-01-20

### 质量分析

- [x] **`getAfterSalesQualityAnalytics`** - 责任方统计、工单类型统计

### 保修期判定

- [x] **`checkWarrantyStatus`** - 默认 12 个月，返回保修状态和剩余天数

### 财务联动

- [x] **`confirmLiabilityNotice`** - 确认定责单后自动更新扣款金额

### 仲裁工作台

- [x] **`ArbitrationWorkbench` 组件** - 左右分屏 + 时间轴 + 责任分配

### 客户评价

- [x] **`CustomerFeedbackPage` H5 页面** - 星级评分 + 标签 + 文字反馈

### 扣款安全水位

- [x] **`getDeductionLedger()` / `checkDeductionAllowed()`** - 欠款账本逻辑
- [x] **预警阈值**: 80%，阻断阈值: 100%

### 虚拟成本核算

- [x] **`COST_ACCOUNT_CODES`** - 会计科目定义
- [x] **`getVirtualCostSummary()` / `getVirtualCostByDepartment()`** - 成本汇总和部门分摊

---

## 服务模块 (Service)

**完成日期**: 2026-01-20

### GPS 签到距离校验

- [x] **GPS 工具库**: `src/shared/lib/gps-utils.ts`
- [x] **Haversine 距离计算**: 签到距离验证 (警告阈值 500 米)
- [x] **迟到判定功能**: 支持宽限时间配置

### 测量模块

- [x] **费用准入校验**: `checkOrderDeposit()` / `checkMeasureFeeAdmission()`
- [x] **定金检查**: 默认 30%，小额订单免定金
- [x] **审批豁免**: 免费测量需 `FREE_MEASURE_APPROVAL` 审批
- [x] **拆单机制**: `splitMeasureTask()` - 取消原任务 + 按品类创建新任务

### 安装模块

- [x] **离线签名存储**: `cacheSignatureOffline()` / `syncPendingSignatures()`
- [x] **网络状态监听**: `useOfflineSignatureSync()` Hook
- [x] **离线签名组件**: `OfflineSignatureCanvas` - 网络状态指示 + 待上传数量

---

## 数据报表 (Analytics)

**完成日期**: 2026-01-20

### 核心指标

- [x] **`getProfitMarginAnalysis()`** - 毛利/毛利率/月度趋势
- [x] **`getAfterSalesHealth()`** - 退款率/客诉率/责任分布/健康等级

### 可视化组件

- [x] **`SalesFunnelChart`** - 线索→成交转化率 + 各阶段停留时长
- [x] **`ArCollectionReportCard`** - AR 回款率 + 逾期账款预警 + 账龄分布
- [x] **`ReconciliationReportCard`** - 对账匹配率 + 差异明细
- [x] **`ChartDrilldown`** - 多级下钻 + 面包屑导航 + 弹窗详情

### 移动端适配

- [x] **响应式网格布局**: 触摸优化、骨架屏

---

## 系统设置 (Settings)

**完成日期**: 2026-01-19 ~ 2026-01-20

### 审批流程设计器

- [x] **ApprovalSettingsContent** - 流程列表 + 设计器编辑 + 启用/禁用

### 系统参数配置

- [x] **SystemParamsConfig** - 报价有效期、跟进提醒天数、发货提醒天数等

### 操作日志

- [x] **`getAuditLogsAction`** - 分页、筛选、搜索
- [x] **审计日志面板** - 操作类型筛选、变更内容预览

### 劳务工费定价

- [x] **`LaborPricingConfig`** - 基础安装费/高空费/加急费配置

### 财务基础配置

- [x] **`FinanceBaseConfig`** - 税率/付款条款/发票配置

### 租户功能控制

- [x] **`TenantFeatureControl`** - 模块开关/功能开关/安全设置

---

## 全链路溯源 (Traceability)

**完成日期**: 2026-01-20

### 面料批次追踪

- [x] **`batchTraces` 表**: 缸号/染色批次/供应商批次
- [x] **`orderBatchLinks` 表**: 订单与批次关联

### 风险控制

- [x] **`riskAlerts` 表**: 风险类型/等级/影响范围/处理状态

### 证据链

- [x] **`evidenceChains` 表**: GPS/哈希验证/元数据

---

## API 文档

**完成日期**: 2026-01-20

### 高优先级

- [x] **[API-01] 补充模块 API 文档** - 15/15 模块完成
- [x] **[API-02] 统一字段命名风格** - 采用 camelCase

### 中优先级

- [x] **[API-03] 修复 JSON 注释格式**
- [x] **[API-04] 补充移动端 `data-sync.md`**
- [x] **[API-05] 添加 OpenAPI/Swagger 规范** - `openapi.yaml`

### 低优先级

- [x] **[API-06] Webhook 事件文档** - `webhooks.md`
- [x] **[API-07] 版本管理机制** - `versioning.md`
- [x] **[API-08] 核实认证流程描述**

---

## 代码质量 (Quality)

**完成日期**: 2026-01-20

### TypeScript 类型修复

- [x] **简化签到功能**: 移除对未定义 schema 字段的依赖
- [x] **`pnpm type-check` 无错误**
