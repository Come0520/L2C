# L2C系统架构决策总览

> **文档版本**: v1.0  
> **更新日期**: 2026-01-15  
> **说明**: 本文档汇总了L2C系统所有已确认模块的核心架构决策

## 目录

1. [线索模块 (Lead)](#1-线索模块-lead)
2. [测量模块 (Measure)](#2-测量模块-measure)
3. [报价单模块 (Quote)](#3-报价单模块-quote)
4. [订单模块 (Order)](#4-订单模块-order)
5. [客户&渠道模块 (Customer & Channel)](#5-客户渠道模块-customer--channel)
6. [采购模块 (Purchase)](#6-采购模块-purchase)
7. [财务模块 (Finance)](#7-财务模块-finance)

---

## 1. 线索模块 (Lead)

### 架构决策

| 决策项 | 选择方案 | 说明 |
|:---|:---|:---|
| **数据存储策略** | 混合模式 | 固定字段 + JSONB扩展字段，平衡性能和灵活性 |
| **数据历史跟踪** | 记录关键操作 | 记录分配、转化等关键操作，不记录所有变更 |
| **并发认领处理** | 乐观锁 | 使用version字段处理并发认领，避免数据冲突 |
| **搜索功能** | 模糊搜索 | 支持姓名、电话、地址等字段的模糊搜索 |

### 核心特点

- **混合数据模型**：固定字段存储核心数据，JSONB字段存储扩展信息
- **乐观锁机制**：通过version字段防止并发认领冲突
- **关键操作记录**：只记录分配、转化等关键操作，避免日志膨胀
- **模糊搜索支持**：支持多字段模糊搜索，提高用户体验

### 文档链接

[线索模块架构设计](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/plans/2026-01-14-lead-module-architecture-design.md)

---

## 2. 测量模块 (Measure)

### 架构决策

| 决策项 | 选择方案 | 说明 |
|:---|:---|:---|
| **数据结构** | 混合模式 | 固定字段 + JSONB扩展字段，平衡性能和灵活性 |
| **离线数据同步** | 混合同步 | 在线时自动同步，离线时本地存储，上线后手动同步 |
| **版本管理** | 快照归档 | 每次修改保存完整快照，历史快照归档到单独表 |
| **照片处理** | 智能双图 | 上传原图和压缩图，列表页显示压缩图，详情页显示原图 |
| **数据验证** | 分级验证 | 必填字段实时验证，业务规则提交时验证 |

### 核心特点

- **混合数据模型**：固定字段存储核心测量数据，JSONB字段存储扩展信息
- **混合同步机制**：在线自动同步，离线本地存储，上线后手动同步
- **快照归档**：每次修改保存完整快照，历史快照归档到单独表
- **智能双图**：自动生成压缩图，优化加载性能
- **分级验证**：必填字段实时验证，业务规则提交时验证

### 文档链接

[测量模块架构设计](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/plans/2026-01-14-measure-module-architecture-design.md)

---

## 3. 报价单模块 (Quote)

### 架构决策

| 决策项 | 选择方案 | 说明 |
|:---|:---|:---|
| **计算引擎** | 双重计算 | 客户端实时计算 + 服务端二次验证，保证准确性和安全性 |
| **公式管理** | 脚本引擎 | 使用脚本引擎管理计算公式，支持动态配置 |
| **版本对比** | 并排对比 | 支持报价单版本的并排对比，直观展示差异 |
| **折扣管理** | 自动风控 | 根据折扣率自动触发审批流程 |

### 核心特点

- **双重计算引擎**：客户端实时计算提升用户体验，服务端二次验证保证数据安全
- **脚本引擎**：使用脚本引擎管理计算公式，支持动态配置和快速调整
- **并排对比**：支持报价单版本的并排对比，直观展示差异
- **自动风控**：根据折扣率自动触发审批流程，控制风险

### 文档链接

[报价单模块架构设计](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/requirements/modules/报价单/2026-01-14-quote-module-architecture-design.md)

---

## 4. 订单模块 (Order)

### 架构决策

| 决策项 | 选择方案 | 说明 |
|:---|:---|:---|
| **状态管理** | 数据驱动状态机 | 使用状态机管理订单状态，状态流转规则可配置 |
| **订单拆分** | 预拆分 + 手动调整 | 系统预拆分，支持手动调整 |
| **订单取消** | 协商取消 | 订单取消需要双方协商，记录取消原因 |

### 核心特点

- **数据驱动状态机**：使用状态机管理订单状态，状态流转规则可配置
- **预拆分 + 手动调整**：系统预拆分，支持手动调整，提高灵活性
- **协商取消**：订单取消需要双方协商，记录取消原因

### 文档链接

[订单模块架构设计](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/requirements/modules/订单/2026-01-14-order-module-architecture-design.md)

---

## 5. 客户&渠道模块 (Customer & Channel)

### 架构决策

| 决策项 | 选择方案 | 说明 |
|:---|:---|:---|
| **客户档案更新** | 增量更新 | 客户档案更新时，只更新变化的字段，保留历史记录 |
| **客户合并** | 数据迁移 | 客户合并时，将一个客户的数据迁移到另一个客户，标记原客户为已合并 |
| **渠道等级更新** | 定时任务 | 使用定时任务定期更新渠道等级 |

### 核心特点

- **增量更新**：客户档案更新时，只更新变化的字段，保留历史记录
- **数据迁移**：客户合并时，将一个客户的数据迁移到另一个客户，标记原客户为已合并
- **定时任务**：使用定时任务定期更新渠道等级

### 文档链接

[客户&渠道模块架构设计](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/requirements/modules/客户&渠道/2026-01-14-customer-channel-architecture-design.md)

---

## 6. 采购模块 (Purchase)

### 架构决策

| 决策项 | 选择方案 | 说明 |
|:---|:---|:---|
| **物流跟踪自动化** | API集成 | 通过集成主流物流公司的API，自动查询物流状态 |
| **成本价可见性** | 基于角色的可见性控制 | 财务人员、采购员、店长可以看到成本价，其他角色不能看到 |

### 核心特点

- **物流跟踪自动化**：通过API集成主流物流公司，自动查询物流状态，减少人工工作量
- **成本价可见性控制**：基于角色的权限控制，保护商业机密，确保相关人员能够看到必要的成本信息
- **完整的状态流转**：支持草稿、生产中、备货完成、已发货、已到货、已入库等状态
- **订单状态联动**：采购单状态变化自动触发订单状态更新
- **操作日志记录**：完整记录所有操作，便于审计和追溯

### 文档链接

[采购模块架构设计](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/requirements/modules/采购单/2026-01-15-purchase-module-architecture-design.md)

---

## 7. 财务模块 (Finance)

### 架构决策

| 决策项 | 选择方案 | 说明 |
|:---|:---|:---|
| **对账单生成** | 自动创建 | 订单/采购单创建时自动生成对账单 |
| **对账单拆分/合并** | 多对多 | 支持一个订单拆分成多张对账单，多个订单合并成一张对账单 |
| **差额处理** | 混合模式 | 小额差额自动抹零，大额差额需要手动调整 |
| **订单关闭** | 交付完成 + 收款完成 | 订单状态为"已交付"且应收应付全部结清时，订单自动关闭 |
| **收款/付款审批** | 分级审批 | 小额不需要审批，中额需要主管审批，大额需要总监审批 |
| **收款核销** | 智能推荐 + 手动确认 | 系统智能推荐匹配的订单，财务人员确认后核销 |

### 核心特点

- **自动对账单生成**：通过事件驱动机制，确保对账单不遗漏
- **多对多对账单**：支持复杂的财务场景，提高灵活性
- **混合差额处理**：小额自动处理，大额人工审核，平衡效率和安全性
- **分级审批**：小额快速处理，大额严格审核，灵活可配置
- **智能核销推荐**：系统推荐，人工确认，提高效率和准确性
- **完整财务闭环**：订单关闭需要同时满足业务完成和资金结清

### 文档链接

[财务模块架构设计](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/requirements/modules/财务模块/2026-01-15-finance-module-architecture-design.md)

---

## 8. 通用架构模式

### 8.1 数据存储模式

| 模式 | 应用模块 | 说明 |
|:---|:---|:---|
| **混合模式** | 线索、测量 | 固定字段 + JSONB扩展字段，平衡性能和灵活性 |
| **关系模式** | 订单、报价单、采购、财务 | 标准关系型数据库设计，保证数据一致性 |

### 8.2 状态管理模式

| 模式 | 应用模块 | 说明 |
|:---|:---|:---|
| **状态机** | 订单、采购单 | 使用状态机管理状态，状态流转规则可配置 |
| **简单状态** | 线索、测量、报价单 | 简单状态管理，状态流转规则固定 |

### 8.3 权限控制模式

| 模式 | 应用模块 | 说明 |
|:---|:---|:---|
| **基于角色** | 采购、财务 | 基于角色的权限控制，不同角色有不同的权限 |
| **基于数据范围** | 客户、渠道 | 基于数据范围的权限控制，不同角色只能看到自己权限范围内的数据 |

### 8.4 事件驱动模式

| 模式 | 应用模块 | 说明 |
|:---|:---|:---|
| **事件驱动** | 订单、采购、财务 | 使用事件驱动架构，模块之间通过事件解耦 |
| **直接调用** | 线索、测量、报价单 | 模块之间直接调用，简单直接 |

---

## 9. 技术栈

### 9.1 后端技术栈

| 技术 | 用途 | 说明 |
|:---|:---|:---|
| **Node.js** | 运行时 | 后端服务运行时 |
| **TypeScript** | 编程语言 | 类型安全的JavaScript超集 |
| **Drizzle ORM** | ORM | 类型安全的数据库ORM |
| **PostgreSQL** | 数据库 | 关系型数据库，支持JSONB |
| **Redis** | 缓存 | 缓存和会话管理 |

### 9.2 前端技术栈

| 技术 | 用途 | 说明 |
|:---|:---|:---|
| **React** | 框架 | 前端UI框架 |
| **TypeScript** | 编程语言 | 类型安全的JavaScript超集 |
| **Tailwind CSS** | 样式 | 实用优先的CSS框架 |
| **shadcn/ui** | 组件库 | React组件库 |

### 9.3 其他技术

| 技术 | 用途 | 说明 |
|:---|:---|:---|
| **Cron** | 定时任务 | 定时任务调度 |
| **EventEmitter** | 事件驱动 | 事件驱动架构 |
| **物流API** | 物流跟踪 | 集成主流物流公司API |

---

## 10. 开发优先级

### 10.1 第一阶段（核心功能）

- 线索模块
- 测量模块
- 报价单模块
- 订单模块

### 10.2 第二阶段（扩展功能）

- 客户&渠道模块
- 采购模块

### 10.3 第三阶段（完善功能）

- 财务模块

---

## 11. 总结

本架构决策总览文档汇总了L2C系统所有已确认模块的核心架构决策。主要特点包括：

1. **混合数据模型**：固定字段 + JSONB扩展字段，平衡性能和灵活性
2. **状态机管理**：使用状态机管理复杂状态流转
3. **事件驱动架构**：模块之间通过事件解耦，提高系统可维护性
4. **基于角色的权限控制**：灵活的权限控制，适应不同组织结构
5. **智能推荐**：系统智能推荐，人工确认，提高效率和准确性
6. **自动化**：通过API集成、定时任务等方式，减少人工工作量

该架构设计能够满足门窗行业的业务需求，具有良好的扩展性和可维护性。
