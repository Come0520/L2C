# 核心模块联动设计 (Module Interactions & Design Decisions)

**最后更新日期**: 2026-01-14
**状态**: Approved (已确认)
**文档类型**: Design Resolution (决策记录)

本文档记录了 "Brainstorming Session (2026-01-14)" 中针对系统核心联动逻辑的最终决策。这些决策已作为“宪法”指导后续开发，任何变更需经架构评审。

---

## 0. 关联文档 (Related Documents)
*   [面料供应链架构设计 (Fabric Supply Chain Design)](./fabric-supply-chain-design.md) - **重要**: 涉及面料采购与加工路线的特定设计。

## 1. 渠道与线索联动 (Channel -> Lead)

### 1.1 动态参数归因 (Dynamic Attribution)
*   **决策**: **全量参数捕获 (Full Capture)**
*   **逻辑**:
    *   系统需无差别记录 Landing Page URL 中的所有 Query Parameters (e.g., `utm_source`, `utm_campaign`, `click_id`)。
    *   **存储**: 存入 `leads.url_params` (JSONB) 字段，而非为每个参数建列。
    *   **价值**: 为后续 Marketing Analytics (ROI 分析) 保留原始数据，即使当前报表暂不支持所有字段的分析。

### 1.2 自动分配策略 (Auto-Distribution)
*   **决策**: **策略解耦 (Decoupled Strategy)**
*   **逻辑**:
    *   放弃在 "渠道管理" 中直接硬编码 "归属销售"。
    *   引入 **"分配策略 (Distribution Strategy)"** 概念，作为独立配置项。
    *   **实现**: 系统预置几种典型策略（如：轮转 Round Robin、权重 Random Weighted、固定归属 Fixed），租户在渠道配置时选择绑定一种策略。

---

## 2. 线索与客户联动 (Lead -> Customer)

### 2.1 智能查重与归集 (Smart Deduplication)
*   **场景**: 新线索电话号码 = 已存在客户电话号码。
*   **决策**: **自动归集 (Auto-Link) + 弱提示**
*   **逻辑**:
    *   **禁止** 简单粗暴地拦截（"该客户已存在，请勿重复录入"），这会打击销售录入积极性。
    *   **执行**: 允许创建线索，但在后台自动将 `leads.customer_id` 指向老客户。
    *   **UI表现**: 在线索列表显式标记为 **"老客新线索" (Re-entry)**，并提供一键跳转至 Customer Dashboard 的入口。

### 2.2 数据冲突处理 (Data Conflict Resolution)
*   **场景**: 老客新线索填写的地址/画像信息与老客户档案不一致。
*   **决策**: **智能覆盖 (Smart Overwrite)**
*   **逻辑**:
    *   转客户/成交时刻，弹出差异对比窗口。
    *   **默认行为**: 勾选 "使用新信息更新档案"（假设最新录入的最准确）。
    *   **人工干预**: 允许销售取消勾选，保留旧数据。
    *   **审计**: 旧数据覆盖前自动备份至 `customer_audit_logs`。

---

## 3. 客户转介绍联动 (Referral System)

### 3.1 关联机制 (Linkage)
*   **决策**: **混合模式 (Hybrid: QR Code + Manual)**
*   **逻辑**:
    *   **主路径**: 老客户 (A) 在小程序拥有专属二维码。新客户 (B) 扫码填单，系统自动锁定 `referrer_customer_id = A`。
    *   **兜底路径**: 销售在后台录入 B 的线索时，可手动搜索并选择 A 作为介绍人。

### 3.2 激励机制 (Incentive)
*   **决策**: **积分体系 (Loyalty Points V1)**
*   **逻辑**:
    *   当 B **确认成交** (支付首款/合同签约) 时，触发激励动作。
    *   **奖励**: 系统自动向 A 的账户发放积分 (Loyalty Points)。
    *   **用途**: 积分可用于抵扣 A 自己的未结尾款，或在后续的积分商城兑换（二期规划）。
    *   **架构影响**: 需在 `customers` 表增加 `loyalty_points` 字段，并建立 `loyalty_transactions` 流水表。

---

## 5. 线索与报价联动 (Lead -> Quote)

### 5.1 自动预报价 (Auto-Pre-Quote)
*   **决策**: **一键生成草稿 (One-click Draft)**
*   **逻辑**:
    *   **触发**: 在线索详情页点击 "生成报价"。
    *   **行为**: 系统创建一个状态为 `DRAFT` 的新报价单。
    *   **数据映射**: 自动带入线索的客户信息 (姓名/电话/地址) 至报价单头部，商品明细留空待填。
    *   **避免过度智能**: 不尝试根据模糊意向自动填充商品套餐，避免准确率低导致的修改成本。

### 5.2 多版本管理 (Versioning)
*   **决策**: **版本式管理 (Strict Versioning)**
*   **逻辑**:
    *   **结构**: 报价单包含 `version` 字段 (v1, v2, v3)。
    *   **变更**: 当报价单已发送给客户或状态非 Draft 时，修改必须生成新版本。
    *   **比价**: 线索详情页需展示该线索下的所有报价单版本，并在列表中标识 `Active` (当前生效) 版本。

### 5.3 状态同步 (Status Synchronization)
*   **决策**: **独立状态 (Independent Status)**
*   **逻辑**:
    *   **Quote Lost != Lead Lost**: 报价单被标记为 "Lost" (丢单/客户拒绝) 时，**不**自动关闭线索。
    *   **价值**: 销售可以发起第二次报价 (V2)，或转换销售策略继续跟进，保留线索的生命周期直至明确宣告失败。
    *   **例外**: 仅当报价单状态变为 `WON` (成交) 时，线索状态才自动流转为 `WON`。

### 5.4 数据回写 (Data Write-back)
*   **决策**: **自动回写 (Auto-Sync)**
*   **逻辑**:
    *   **触发**: 在报价单编辑页面修改客户基础信息 (电话/地址/姓名) 并保存时。
    *   **行为**: 系统自动同步更新关联的 **线索 (Lead)** 和 **客户 (Customer)** 档案。
    *   **前提**: 报价单必须处于 Draft 状态。已锁定的报价单不可修改客户信息，自然不会触发回写。

---

## 6. 线索与测量联动 (Lead -> Measurement)

### 6.1 派单模式 (Dispatching)
*   **决策**: **店长/派单员统一指派 (Centralized Dispatch)**
*   **逻辑**:
    *   销售只拥有 "申请测量" 的权限。
    *   测量单生成后默认进入 `PENDING` (待分配) 状态。
    *   **店长/派单员** 负责在后台选择测量师并指派。
    *   **理由**: 强化对测量资源的管控，避免销售与测量师私下交易或资源分配不均。

### 6.2 费用与准入 (Fees & Gatekeeping)
*   **决策**: **定金测量 + 审批豁免 (Deposit + Approval Bypass)**
*   **逻辑**:
    *   **默认规则**: 系统校验该线索下是否已有 "已支付" 的定金订单 (如 200元)。若无，禁止创建测量申请。
    *   **豁免通道**: 允许销售发起 "免费测量申请" 流程，需经过店长审批。审批通过后可跳过定金校验直接派单。
    *   **配置**: 租户可在系统设置中一键关闭此限制 (即切换回完全免费测量模式)。

### 6.3 数据流向 (Data Flow)
*   **决策**: **灵活引用 (Flexible Reference)**
*   **逻辑**:
    *   **非强依赖**: 报价单 **不需要** 强制关联已完成的测量单。
    *   **场景**: 销售可以在测量前先给一个 "预估报价"。
    *   **导入能力**: 若已关联测量单，报价单提供 "导入测量数据" 功能，一键覆盖报价单的尺寸信息。

---

## 4. 移动端与系统基础 (Mobile & Foundation)

### 4.1 移动端架构
*   **决策**: **微信小程序 (WeChat Mini Program)**
    *   放弃飞书生态，构建独立私域工具。
    *   **API**: 采用 Hybrid 模式，移动端走 RESTful API (`/api/v1/*`)，复用 Service 层逻辑。

### 4.2 身份与登录
*   **策略**: **账密绑定 + 静默登录**
    *   员工首次使用小程序需输入 PC 端账号密码进行绑定（Security Handshake）。
    *   绑定后建立 OpenID 映射，后续享受无感登录体验。

### 4.3 强弱通知分级
*   **红色预警 (SLA Breach)**:发送 **短信 (SMS)** 给直属上级。
*   **常规待办**: 仅 **站内信 (App/Web Notification)**。

---

> **设计原则总结**: 
> 1. **数据为王**: 尽可能保留全量数据 (URL Params)。
> 2. **体验优先**: 避免生硬拦截，偏向智能归集与默认覆盖。
> 3. **闭环激励**: 转介绍必须要有实质性的系统内闭环 (积分)，而非仅做口头记录。
> 4. **留痕追溯**: 报价修改强制留痕，费用豁免强制审批。

---

## 7. 测量与报价联动 (Measurement -> Quote)

### 7.1 数据导入 (Data Import)
*   **决策**: **智能映射 (Smart Mapping)**
*   **逻辑**:
    *   **一键导入**: 报价单提供 "引用测量数据" 按钮。
    *   **匹配规则**:
        *   **按空间名匹配**: 若报价单已存在 "客厅"，则只更新该行的宽/高数据，保留已选的面料/工艺。
        *   **新增**: 若报价单没有 "主卧"，则自动追加新行。
    *   **价值**: 保护销售已选好的品类数据，避免因重新导入而清空所有选品。

### 7.2 重测联动 (Re-measure Impact)
*   **决策**: **强提示 (Strong Alert)**
*   **逻辑**:
    *   **触发**: 当关联的测量单发布了新版本 (e.g., V2) 且报价单引用的是旧版本 (V1)。
    *   **表现**: 报价单详情页顶部显示 **红色警告条**: "测量数据已更新 (V2)，现有尺寸可能失效，请重新导入！"。
    *   **非阻断**: 不强制失效报价单（避免尴尬时刻无法打印），但给予最强烈的视觉警示。

### 7.3 引用粒度 (Granularity)
*   **决策**: **1:1 实体引用 (Entity Import)**
*   **逻辑**:
    *   测量单的 **一个窗户 (Window)** 自动转化为报价单的 **一个窗帘 (Curtain)**。
    *   **默认数据**: 导入时，窗帘的 "成品宽/高" 自动根据测量的 "内径宽/高" + 默认公式 (如 2倍褶皱) 进行预计算。销售只需确认和微调。

---

## 8. 报价与订单联动 (Quote -> Order)

### 8.1 转化规则 (Conversion Rules)
*   **决策**: **严格模式 (Strict Mode)**
*   **逻辑**:
    *   **状态依赖**: 只有状态为 `WON` (已确认/已签约) 的报价单才能转为订单。
    *   **锁死机制**: 订单生成后，其关联的商品明细、单价、总价 **默认锁定**，不可随意修改。
    *   **变更流程**: 若需修改订单金额，必须发起 "变更申请 (Change Order)" 或 "补充协议"，严谨记录金额变动原因（增项/减项）。
    *   **价值**: 确保财务数据的严肃性，避免销售随意改价导致对账不清。

### 8.2 拆单逻辑 (Split Logic)
*   **决策**: **1:1 转化 (One-to-One)**
*   **逻辑**:
    *   **单据关系**: 一个报价单生成 **一个** 总订单。
    *   **后续拆分**: 采购和发货阶段再根据品类（如：窗帘工厂、墙布工厂）生成不同的 "采购单" 和 "发货单"。
    *   **客户视角**: 对客户而言，始终只有一个 "总合同/总订单"，体验统一。

---

## 9. 订单与财务联动 (Order -> Finance)

### 9.1 收款计划自动化 (Payment Terms Automation)
*   **决策**: **模板化生成 + 最低比例控制 (Template + Min Ratio)**
*   **逻辑**:
    *   **默认**: 订单确认时，根据系统预设模板（e.g., 标准 3-3-3-1）自动生成 4 笔 "待收付记录"。
    *   **自由度**: 允许销售在生成前调整比例（如：改为 5-5-0-0）。
    *   **风控**: 系统设置 "最低首付比例" (如 30%)。若销售调整后的首付 < 30%，必须走特批流程，否则禁止生成。

### 9.2 账单生成时机 (Billing Trigger)
*   **决策**: **签约即生成 (Immediate Generation)**
*   **逻辑**:
    *   **触发**: 订单状态变更为 `CONFIRMED` 或 `SIGNED` 的瞬间。
    *   **行为**: 无论是定金、进度款还是尾款，所有期数的应收单 (Receivables) **一次性生成**。
    *   **状态**: 只有第一期（定金）状态为 `PENDING`，后续期数可标记为 `FUTURE` 或 `PENDING`，但均已入账。
    *   **价值**: 确保财务能看到该订单的全生命周期预期回款，便于做 Cash Flow 预测。
