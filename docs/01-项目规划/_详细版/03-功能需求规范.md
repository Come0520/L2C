# 罗莱L2C销售管理系统 - 功能需求规范

## 📋 项目概述

**项目名称：** 罗莱L2C销售管理系统  
**技术栈：** Next.js 15+ (Web端) + Taro 3.x (小程序端) + Supabase BaaS + PostgreSQL  
**项目类型：** 多品类销售服务管理平台  
**架构模式：** Next.js + Supabase BaaS架构，Serverless优先  
**核心业务：** 从线索到现金（L2C）的完整销售服务流程管理  
**开发阶段：** 第一阶段MVP（8周），优先开发线索到回款完整流程，简化测量安装环节  
**文档版本：** v3.1（第一阶段MVP版本 - 优先积分商城）

## 🏗️ 技术架构演进规划

### MVP阶段：Next.js + Supabase BaaS架构
- **前端架构**：Next.js 15+（App Router, Server Components, Server Actions）
- **后端架构**：Supabase BaaS（Auth, Database, Realtime, Storage, Edge Functions）
- **数据存储**：PostgreSQL（Supabase托管）
- **部署方式**：Vercel + Supabase Cloud，简化运维管理
- **API设计**：直接使用Supabase PostgREST API，无需自建API层

### 扩展阶段：Serverless优化
- **Edge Functions**：处理复杂业务逻辑和第三方API集成
- **实时数据同步**：利用Supabase Realtime实现数据实时更新
- **细粒度RLS策略**：优化Row Level Security策略，提升性能和安全性
- **监控体系**：完善监控、日志、链路追踪系统

### 成熟期：全Serverless架构
- **事件驱动**：基于事件溯源的最终一致性架构
- **边缘计算**：利用Edge Functions实现低延迟处理
- **全球CDN加速**：提升全球用户访问速度
- **自动扩缩容**：根据业务负载自动调整资源

---

## 🎯 核心业务目标

### 1. L2C全流程数字化管理
- **线索管理**：从线索获取到转化的全生命周期管理
- **销售单体系**：销售单的完整业务链条（第一阶段重点）
- **简化服务流程**：测量安装环节采用简易流程（人工填写/表格上传）
- **数据洞察**：实时掌握销售机会分布和转化效率

### 2. 多品类销售服务支持
- **商品品类**：窗帘、墙布、墙咔三大核心品类
- **简化服务链条**：测量安装环节采用简易流程（第一阶段）
- **价格策略**：支持多品类组合优惠和个性化定价
- **库存管理**：商品库存与供应商实时同步

### 3. 销售单状态机管理
- **销售单状态**：27个状态的完整流转控制（第一阶段重点）
- **简化测量安装状态**：采用简易流程，减少状态节点（第一阶段）
- **状态同步**：单据间的状态协调与异常处理

### 4. 积分激励体系（第一阶段优先）
- **积分奖励**：基于销售单成交的多节点积分发放
- **商城兑换**：积分商城完成礼品兑换（第一阶段优先开发）
- **激励机制**：通过积分体系激励销售团队和圣都设计师/导购
- **积分规则**：支持多维度积分计算和特殊奖励

### 5. 服务提供商管理（第二阶段）
- **人员管理**：测量师、安装工的技能认证与排班
- **任务分配**：基于技能和地理位置的智能派单
- **绩效管理**：准时率、质量评分、客诉率统计
- **结算体系**：按服务节点的工作量实时结算

---

## 📅 开发阶段规划

### 阶段一：基础平台（MVP）- 8周
**优先开发功能：**
- 线索管理与分配
- 销售单27状态流转（详细测量安装环节）
- 积分发放与计算体系
- 积分商城与兑换系统（优先开发）
- 基础报表分析
- 外部测量安装环节采用简易流程（人工填写/表格上传）

**暂缓开发功能（第二阶段）：**
- 完整的测量单管理系统
- 完整的安装单管理系统
- 智能派单系统
- 服务商绩效管理

---

## 🔧 功能模块详细规范

## 模块一：线索管理模块

### 1.1 线索信息字段定义

#### 客户信息模块（必填）
- **客户名称**：文本字段，1-50字符
- **客户地址**：详细地址信息，1-200字符

#### 罗莱好伙伴信息模块（必填）
- **圣都设计师**：关联的设计师姓名
- **圣都导购**：关联的导购姓名
- **经营城市店**：所在城市门店名称
- **城市**：所在城市名称

#### 项目信息模块（选填）
- **硬装正签时间**：硬装合同签订时间（YYYY-MM-DD格式）
- **面积**：项目面积（1-1000平方米）
- **套餐名称**：选择的装修套餐名称

#### 系统信息字段（自动生成）
- **创建时间**：自动记录
- **创建人**：录入人员
- **最后跟进时间**：自动更新
- **跟进次数**：自动统计

#### 1.1.1 线索创建权限
- **驻店销售**：可手动录入或Excel批量导入线索，创建后默认归属自己，可分配
- **远程销售**：可手动录入或Excel批量导入线索，创建后默认归属自己，可分配
- **业务**：可手动录入或Excel批量导入线索，创建后默认归属自己，可分配
- **销售负责人**：可手动录入或Excel批量导入线索，创建后可分配给其他人员

### 1.2 Excel批量导入功能

#### 导入模板要求
- **文件格式**：支持.xlsx和.xls格式
- **固定列顺序**：客户名称、客户地址、设计师、导购、经营城市店、城市、硬装正签时间、面积、套餐名称
- **数据校验**：实时校验数据格式和完整性
- **错误处理**：生成详细错误报告，支持部分导入和重试

#### 重复检查机制
- **主要检查维度**：客户名称+地址（精确匹配）
- **辅助检查维度**：客户名称+设计师/导购（相似度匹配）
- **预警级别**：
  - 高预警：客户名称+地址完全相同
  - 中预警：客户名称相同，地址相似度>80%
  - 低预警：客户名称+设计师/导购组合相似
- **处理选项**：跳过重复、覆盖记录、合并信息、预警确认

### 1.3 线索分配规则

#### 分配权限层级
1. **销售负责人**：拥有最高层级分配权限，可分配给城市授权人员，可跨部门分配
2. **业务**：拥有中级分配权限，可分配已归属自己的线索，仅限同部门内分配
3. **驻店销售**：无分配权限，仅可接收上级分配的线索

#### 分配优先级
1. **指定跟踪服务人员**：线索中已指定设计师或导购时优先分配
2. **按城市分配**：自动分配给对应城市的销售门店
3. **负载均衡分配**：采用轮询算法避免分配不均

#### 分配限制
- **最大线索数**：每个导购最大同时跟进20条线索
- **城市限制**：只能分配给同城市的销售人员
- **状态检查**：只能分配给在职状态的销售人员
- **权限检查**：根据角色权限层级进行分配控制

#### 重新分配规则
- **跟进超时**：3天未跟进自动重新分配
- **主动放弃**：销售主动放弃线索时重新分配
- **人员变动**：销售离职或调岗时批量重新分配

### 1.4 线索跟踪人变更

#### 1.4.1 远程销售推单职责
- **推单处理**：远程销售负责上传圣都Home系统采购申请截图
- **权限限制**：仅远程销售拥有推单上传权限
- **同一人处理**：若驻店销售与远程销售为同一人，则由该人员负责推单处理
- **流程要求**：推单需在草签阶段完成后，由订单客服确认采购需求后进行

#### 变更权限层级
- **销售负责人**：可变更管辖范围内所有线索的跟踪人，可跨部门变更
- **业务**：可变更已归属自己的线索的跟踪人，仅限同部门内变更
- **驻店销售**：无变更权限，仅可接收分配的线索

#### 变更规则
- **权限检查**：系统根据角色权限层级自动判断变更权限
- **归属验证**：只能变更已归属自己或有权限管理的线索
- **部门限制**：除销售负责人外，其他角色不可跨部门变更，只能查看自己负责的线索

#### 变更流程
1. 选择需要变更跟踪人的线索
2. 从员工列表中选择新的跟踪人
3. 填写变更原因（必填）
4. 确认变更操作
5. 系统自动记录并通知相关人员

### 1.5 预警系统
- **跟进提醒**：7天未跟进触发黄色预警
- **预警级别**：黄色（7天）、橙色（15天）、红色（30天）
- **通知方式**：系统消息、邮件、短信、微信
- **接收人**：销售本人、直属领导、管理员

### 1.6 线索状态管理
- **状态流转**：待分配 → 待跟踪 → 跟踪中 → 草签 → 已关闭
- **标签属性**：有意向（可随时添加/移除）、已到店（可随时添加/移除）、已报价（预报价标签）、需维护（自动标签）
- **状态变更记录**：完整的线索状态变更历史
- **状态统计**：各状态线索数量统计和分析
- **分配机制**：支持管理员分配、领导分配、手动分配、随机分配
- **预警机制**：7天未跟进黄色预警、15天橙色预警、30天红色预警

### 1.7 预报价功能

#### 预报价操作流程
1. **触发条件**：在线索管理页面点击"预报价"按钮
2. **文件上传**：上传Excel格式的预报价文件
3. **数据验证**：系统自动验证文件格式和数据完整性
4. **标签添加**：验证通过后自动为线索添加"quoted"标签
5. **信息存储**：预报价信息存储到独立表中，关联线索ID

#### 预报价Excel模板要求
- **文件格式**：支持.xlsx和.xls格式
- **必填字段**：产品类别、规格型号、数量、单价、总价
- **客户信息**：从线索信息中自动继承，无需重复录入
- **可选字段**：备注说明、特殊要求、优惠信息
- **数据校验**：价格合理性检查、数量范围验证、格式规范检查

#### quoted标签管理
- **标签性质**：系统自动标签，不可手动删除
- **有效期**：90天有效期，系统每日凌晨2点刷新
- **状态显示**：在线索列表中显示"quoted"标签和剩余有效天数
- **过期处理**：超过90天保持标签，但添加"需维护"标签

### 1.8 线索跟踪提醒系统

#### 自动提醒规则
- **第7天**：首次跟踪提醒（系统消息+微信通知）
- **第30天**：重点跟踪提醒（系统消息+微信通知）
- **第60天**：紧急跟踪提醒（系统消息+微信通知）
- **第90天**：即将过期提醒（系统消息+微信通知）
- **说明**：由于所有客户都通过微信注册，邮箱和电话为可选项，统一使用微信作为主要通知渠道

#### 需维护标签自动化
- **触发条件**：线索获得"quoted"标签后超过10天未转化
- **标签添加**：系统自动添加"需维护"标签
- **提醒机制**：每周提醒销售人员跟进需维护的线索
- **标签移除**：线索转化为订单后自动移除"需维护"标签

#### 定时任务配置
- **执行时间**：每日凌晨2点执行
- **任务内容**：
  - 刷新所有线索状态（包括"quoted"标签状态）
  - 检查并添加"需维护"标签
  - 更新所有线索的跟踪状态
  - 生成跟踪提醒通知
  - 更新线索状态统计数据
  - 生成状态变更日志
- **说明**：所有线索状态的自动化更新都统一在每日凌晨2点执行，确保数据一致性

### 1.9 线索转化功能

#### 转化条件验证
- **必要信息检查**：客户信息完整性验证
- **状态检查**：线索可以从任何状态转化（包括已取消状态）
- **权限验证**：操作人员必须有转化权限
- **说明**：已取消状态的线索也允许转化，支持客户重新激活的业务场景

#### 信息继承机制
- **基础信息继承**：客户名称、地址、联系方式自动继承
- **预报价信息继承**：如果线索有"quoted"标签，预报价信息自动继承到订单
- **跟踪记录继承**：线索的跟踪记录关联到新订单
- **标签状态更新**：线索状态更新为"已转化"

#### 草签动作与订单创建流程
- **草签动作**：线索转化需要执行"草签"动作，这是一个业务操作而非状态
- **初始状态**：草签动作完成后，订单状态进入"预算中"
- **预算阶段**：进行成本预算和方案设计，准备《预算报价单》
- **文档上传**：上传《预算报价单》后，订单状态自动转为"等待推单"（等待远程销售上传圣都Home系统采购申请截图进行推单确认）
- **编号生成**：自动生成订单编号，格式：XS-YYYYMMDD-序号
- **关联关系**：建立线索与订单的关联关系
- **数据同步**：订单信息实时同步到相关系统

#### 预算报价单管理功能
- **上传界面**：在订单详情页提供文档上传功能
- **格式支持**：PDF、Word、Excel等常用格式
- **文件限制**：单个文件不超过10MB
- **版本控制**：支持多次上传，保留历史版本
- **状态触发**：上传成功后自动触发状态流转
- **下载查看**：支持在线预览和下载功能

### 1.10 预算报价单格式规范

#### 文档基本要求
- **文档标题**：《[客户姓名]-[项目地址]-预算报价单》
- **文档编号**：YS-YYYYMMDD-订单号后4位
- **制作日期**：当前日期
- **有效期限**：30天（可在文档中明确标注）
- **制作人员**：销售人员姓名和联系方式

#### 必含内容模块
1. **客户信息模块**
   - 客户姓名、联系电话、项目地址
   - 房屋面积、装修风格、特殊要求

2. **商品清单模块**
   - 产品类别（窗帘/墙布/墙咔）
   - 产品型号、规格、材质
   - 数量、单位、单价、小计
   - 优惠信息、折扣说明

3. **费用明细模块**
   - 商品总价、安装费用、运输费用
   - 税费、其他杂费
   - 优惠减免、最终总价

4. **施工方案模块**
   - 测量安排、施工周期
   - 安装流程、注意事项
   - 售后服务承诺

5. **付款方式模块**
   - 付款比例（定金/进度款/尾款）
   - 付款时间节点
   - 付款方式说明

#### 格式标准化要求
- **字体规范**：标题使用黑体16号，正文使用宋体12号
- **表格格式**：统一使用标准表格样式，边框1磅
- **页面设置**：A4纸张，页边距2.5cm
- **页眉页脚**：包含公司Logo、页码、联系方式
- **印章位置**：文档末尾预留公司印章位置

---

## 模块二：销售单管理模块

### 2.1 销售单创建规则

#### 销售单基础信息
- **销售单编号**：XS-YYYYMMDD-序号（自动生成）
- **客户信息**：从线索继承，支持手动修改
- **项目信息**：继承线索的所有项目信息
- **销售内容表**：独立实体承载商品配置与价格计算

#### 销售内容表设计
- **分离式设计**：销售内容表作为独立实体
- **版本管理**：销售单生成前可无限修改，生成后锁定
- **商品配置**：支持窗帘、墙布、墙咔多品类选择
- **价格计算**：实时计算，支持多品类组合优惠
- **继承机制**：从线索一键生成销售内容表

#### 金额信息填写流程
1. **协议总金额**：由销售填写（销售单创建时）
2. **成交金额**：由销售填写（销售单执行中）
3. **回款金额**：由销售填写（销售单执行中）
4. **服务费核算**：由审批人员填写（销售单完成后）

### 2.2 销售单状态流转（27个状态）

#### 线索阶段状态（5个）
1. **待分配**：线索创建后等待分配给销售人员
2. **待跟踪**：已分配但尚未开始跟踪
3. **跟踪中**：正在跟踪客户
4. **草签**：客户初步同意，准备进入测量阶段
5. **已失效**：手动关闭的线索

#### 订单阶段状态（15个）
6. **待测量**：等待安排测量师上门测量
7. **测量中-待分配**：测量需求单已生成，等待派单员分配
8. **测量中-分配中**：派单员正在分配测量师
9. **测量中-待上门**：测量师已接单，等待上门测量
10. **测量中-待确认**：测量完成，等待销售确认测量单
11. **方案待确认**：测量单已确认，等待客户确认方案
12. **待推单**：方案已确认，等待推单处理（远程销售上传圣都Home系统采购申请截图）
13. **待下单**：订单客服确认采购需求后，订单进入待下单状态（采购申请已确认，进入生产环节）
14. **生产中**：订单已下单，正在生产
15. **备货完成**：所有生产单号备货完成
16. **安装中-待分配**：安排安装，等待派单员分配安装师
17. **安装中-分配中**：派单员正在分配安装师
18. **安装中-待上门**：安装师已接单，等待上门安装
19. **安装中-待确认**：安装完成，等待销售确认
20. **待对账**：安装确认完成，等待财务对账

#### 财务阶段状态（2个）
21. **待回款**：财务已开具销售发票并填写发票单号，等待客户回款（注：根据业务流程，需要先开具发票才能进入回款环节）
22. **已完成**：回款确认完成，订单结束

#### 异常状态（5个）
23. **已取消**：订单被取消
24. **暂停**：订单暂停处理
25. **异常**：订单出现异常情况

### 2.3 测量单管理（第二阶段开发）

#### 测量单创建
- **自动创建**：销售单状态进入"待推测量"时自动创建（第二阶段）
- **测量单编号**：CL-YYYYMMDD-序号（自动生成）
- **关联销售单**：与销售单编号保持一致
- **测量师分配**：支持手动分配、自动分配、技能匹配分配（第二阶段）

#### 测量单状态流转（第二阶段）
- **待分配** → **已分配** → **测量中** → **待确认** → **已确认**
- **进度款管理**：测量完成后收取进度款（可设置比例）
- **测量内容**：上传测量数据、现场图片、客户签字确认
- **异常处理**：支持测量异常状态，可重新分配

#### 第一阶段简易流程
- **数据收集方式**：人工填写或表格上传
- **简化状态**：销售单状态直接跳过详细测量环节
- **数据记录**：在销售单中记录基本测量信息
- **后续开发**：第二阶段开发完整的测量单管理系统

#### 测量师管理（第二阶段）
- **技能标签**：窗帘、墙布、墙咔等品类技能认证
- **工作负荷**：实时显示当前任务数量和完成率
- **派单规则**：按技能匹配 > 地理位置 > 工作负荷 > 历史评价
- **评价体系**：客户评价、内部评价、完成质量评分

### 2.4 安装单管理（第二阶段开发）

#### 安装单创建
- **自动创建**：销售单状态进入"待装"时自动创建（第二阶段）
- **安装单编号**：AZ-YYYYMMDD-序号（自动生成）
- **关联销售单**：与销售单编号保持一致
- **安装师分配**：支持手动分配、自动分配、技能匹配分配（第二阶段）

#### 安装单状态流转（第二阶段）
- **待分配** → **已分配** → **待安装** → **安装中** → **安装完成**
- **尾款管理**：安装完成后收取尾款（可设置比例）
- **安装内容**：上传安装图片、客户签字确认、现场验收单
- **异常处理**：支持安装异常状态，可重新分配或暂停

#### 第一阶段简易流程
- **数据收集方式**：人工填写或表格上传
- **简化状态**：销售单状态直接跳过详细安装环节
- **数据记录**：在销售单中记录基本安装信息
- **后续开发**：第二阶段开发完整的安装单管理系统

#### 安装师管理（第二阶段）
- **技能标签**：安装技能认证（窗帘、墙布、墙咔）
- **工作负荷**：实时显示当前任务数量和完成率
- **派单规则**：按技能匹配 > 地理位置 > 工作负荷 > 历史评价
- **评价体系**：客户评价、内部评价、安装质量评分

---

## 模块三：积分激励体系

### 3.1 积分获取规则（多节点激励）

#### 线索相关积分
- **线索创建**：+5分（有效线索，通过审核）
- **线索跟进**：+2分（每次有效跟进，每日上限10分）
- **线索转化**：+10分（线索转化为销售单）
- **客户到店**：+5分（客户首次到店体验）

#### 销售单相关积分
- **销售单创建**：+5分（销售内容表确认）
- **草签完成**：+10分（客户签字确认）
- **测量完成**：+15分（测量单状态确认）
- **安装完成**：+20分（安装单状态确认）
- **销售单完成**：+30分（销售单全部流程完成）

#### 2B外部合作方积分（新增）
- **外部订单推送**：订单金额×品类系数（窗帘0.8%、墙布0.6%、墙咔1.0%）
- **导购积分**：基础比例（如上），最低50分，最高500分
- **设计师积分**：导购积分的50%，最低25分，最高250分
- **首单奖励**：新合作方员工首单额外+100分
- **大单奖励**：订单金额≥3万元，额外奖励订单金额×0.2%
- **质量奖励**：客户评价≥4.5星，额外奖励订单金额×0.1%

#### 回款相关积分（关键激励）
- **进度款到账**：+20分（测量完成后进度款到账）
- **尾款到账**：+30分（安装完成后尾款到账）
- **全额回款**：额外+15分奖励
- **提前回款**：额外+10分奖励（约定时间前回款）

#### 服务评价积分
- **客户好评**：+5分（客户主动好评）
- **服务标兵**：+10分（月度服务评价优秀）
- **零投诉奖励**：+15分（季度零投诉记录）

### 3.2 角色定义（8种角色）

#### 1. 管理员（ADMIN）
- **权限范围**：全部权限，系统管理、用户管理、数据管理
- **主界面**：系统管理、用户管理、数据统计
- **登录方式**：账号密码登录
- **数据权限**：查看所有数据

#### 2. 领导（LEADER）
- **权限范围**：全局只读 + 导出，审批权限，报表分析
- **主界面**：团队数据、审批待办、分析报表
- **登录方式**：账号密码登录
- **数据权限**：查看团队所有数据

#### 3. 销售（SALES）
- **权限范围**：线索管理、客户跟进、业绩查看
- **主界面**：线索列表、跟进提醒、业绩看板
- **登录方式**：账号密码登录
- **数据权限**：只能查看自己的客户数据
- **地域信息**：有城市和门店信息

#### 4. 订单销售（ORDER_SALES）
- **权限范围**：订单管理、生产协调、客户服务
- **主界面**：订单列表、生产进度、客户服务
- **登录方式**：账号密码登录
- **数据权限**：查看分配的订单数据

#### 5. 派单员（DISPATCHER）
- **权限范围**：任务分配、进度跟踪、质量检查
- **主界面**：任务分配、进度监控、质量管理
- **登录方式**：账号密码登录
- **数据权限**：查看分配范围内的任务数据

#### 6. 罗莱施工员（TECHNICIAN）
- **权限范围**：
  - 外派订单查看：查看分配给自己的外派管理订单
  - 外派订单日程表：查看未来7-15天的工作日程安排
  - 任务管理：接收、执行、上报测量/安装任务
  - 个人账户：查看余额、收入明细、申请提现
  - 工作量统计：查看个人绩效数据
- **主界面**：外派订单日程表、任务列表、账户余额、收入明细、工作量统计
- **登录方式**：手机号验证码登录
- **数据权限**：仅可见自己的任务与账户
- **地域信息**：有城市信息

#### 7. 罗莱好伙伴（PARTNER）
- **权限范围**：积分查询、礼品兑换、订单查看
- **主界面**：积分余额、礼品商城、订单进度
- **登录方式**：微信扫码登录
- **数据权限**：查看个人积分和关联订单

#### 8. 审批人员（APPROVER）
- **权限范围**：审批操作、审批记录查看
- **主界面**：审批待办、审批历史
- **登录方式**：账号密码登录
- **数据权限**：查看审批相关数据

### 3.3 权限矩阵（三单体系）

| 功能模块 | 管理员 | 销售主管 | 销售 | 订单销售 | 派单员 | 施工员 | 财务 | 客服 |
|---------|--------|----------|------|----------|--------|--------|------|------|
| **线索管理** | 全部 | 团队+个人 | 个人 | 个人 | 查看 | 查看 | 查看 | 查看 |
| **销售单管理** | 全部 | 团队+个人 | 查看 | 个人 | 查看 | 查看 | 财务 | 查看 |
| **测量单管理** | 全部 | 团队+个人 | 查看 | 查看 | 分配+确认 | 执行 | 查看 | 查看 |
| **安装单管理** | 全部 | 团队+个人 | 查看 | 查看 | 分配+确认 | 执行 | 查看 | 查看 |
| **商品库管理** | 全部 | 查看 | 查看 | 查看 | 查看 | 查看 | 查看 | 查看 |
| **积分管理** | 全部 | 团队+个人 | 个人 | 个人 | 查看 | 查看 | 查看 | 查看 |
| **报表分析** | 全部 | 团队+个人 | 个人 | 个人 | 查看 | 查看 | 财务 | 查看 |
| **系统设置** | 全部 | 部分 | 个人 | 个人 | 查看 | 查看 | 查看 | 查看 |

### 3.4 数据权限规则
- **销售数据**：销售只能看到自己的客户数据
- **团队数据**：领导可以看到团队所有数据
- **全局数据**：管理员可以看到所有数据
- **跨部门数据**：部门间数据隔离规则

### 3.5 审批流程设置
- **一级审批**：普通操作，直属领导审批
- **二级审批**：重要操作，部门负责人审批
- **三级审批**：重大操作，最高领导审批
- **紧急审批**：紧急情况的特殊审批流程

---

## 模块四：积分系统模块

### 4.1 积分发放机制
- **发放时机**：订单创建生产单（生产单号上传后）触发
- **发放对象**：罗莱好伙伴（圣都设计师、圣都导购）
- **发放方式**：分阶段发放（在途积分→可用积分）
- **在途积分**：订单确认后积分先进入在途状态，保护公司权益，激励设计师持续跟进
- **积分确认**：订单完成验收后，在途积分转为可用积分
- **发放通知**：小程序推送通知

#### 2B外部合作方积分发放（新增）
- **发放时机**：外部订单推送成功且状态进入"草签"阶段
- **发放对象**：合作方导购和设计师（圣都系统员工）
- **发放方式**：在途积分机制，延迟确认（7天后转为可用积分）
- **在途积分保护**：草签后积分进入在途状态，防止订单取消造成损失
- **积分确认条件**：订单进入生产阶段且7天内无异议，在途积分转为可用积分
- **发放通知**：Webhook回调 + 邮件通知 + 合作方系统推送
- **身份验证**：API Key认证 + 数字签名验证
- **积分标记**：积分明细中标记订单来源为"EXTERNAL_PUSH"

#### 罗莱好伙伴积分发放规则
- **圣都设计师积分**：订单成交金额 × 0.5% × 产品品类系数
- **圣都导购积分**：订单成交金额 × 0.3% × 产品品类系数
- **积分上限**：单笔订单积分不超过5000分
- **发放条件**：订单状态进入"已对账"后发放

### 4.2 积分计算公式

#### 基础公式
```
积分 = 成交金额 × 产品品类系数 × 时间段系数 × 门店系数
```

#### 可配置系数（管理员可调节）
**产品品类系数：**
- 主推产品：1.3倍（可调节1.2-1.5）
- 常规产品：1.0倍（可调节0.9-1.1）
- 滞销产品：0.9倍（可调节0.8-1.0）

**时间段系数：**
- 促销期：1.5倍（可调节1.2-1.8）
- 淡季：1.1倍（可调节1.0-1.2）
- 常规期：1.0倍（可调节0.9-1.1）

**门店系数：**
- 重点门店：1.2倍（可调节1.1-1.3）
- 普通门店：1.0倍（可调节0.9-1.1）
- 新开门店：1.3倍（可调节1.2-1.5）

### 4.3 积分商城功能（第一阶段优先开发）
- **礼品分类**：电子产品、家居用品、礼品卡、其他
- **库存管理**：库存预警和补货提醒
- **兑换限制**：每人每月兑换上限设置
- **物流跟踪**：实物礼品的物流信息集成
- **兑换流程**：完整的积分兑换流程，包括下单、审核、发货、签收
- **积分查询**：实时查询积分余额和积分明细
- **兑换历史**：查看历史兑换记录和当前兑换状态

#### 罗莱好伙伴专属礼品
- **专业工具**：设计软件、测量工具、专业书籍
- **培训课程**：设计培训、销售技巧培训、管理课程
- **品牌产品**：罗莱产品样品、新品体验资格
- **荣誉奖励**：年度好伙伴证书、专属标识
- **特权服务**：优先体验新品、专属客服通道

#### 第一阶段开发重点
- **基础商城功能**：商品展示、积分兑换、订单管理
- **简化物流**：初期采用简化物流流程，减少复杂度
- **核心兑换**：确保核心兑换流程稳定可用
- **积分对接**：与积分发放系统无缝对接
- **移动端适配**：小程序端优先适配，确保用户体验

### 4.4 积分调整审批
- **调整类型**：奖励积分、扣除积分、过期清零
- **审批层级**：根据调整金额设置不同审批层级
- **调整原因**：必须填写详细原因
- **操作记录**：完整的调整历史记录

---

## 模块五：外派订单日程表模块

### 5.1 日程表界面设计
- **日历视图**：以日历形式展示未来7-15天的工作安排
- **视图切换**：支持日视图、周视图、月视图
- **任务标识**：不同颜色区分测量/安装/其他任务
- **时间显示**：清晰显示任务的具体时间段

### 5.2 日程信息内容
每日任务包含：
- **任务时间**：开始时间和预计结束时间
- **任务类型**：测量/安装/维修等类型标识
- **客户信息**：姓名、电话、详细地址
- **订单编号**：可点击查看订单详情
- **任务状态**：待执行/进行中/已完成
- **预计收入**：该任务的预计收入金额
- **特殊要求**：客户特殊要求或注意事项

### 5.3 日程表交互功能
- **任务详情**：点击查看完整任务信息
- **导航集成**：一键调用地图导航到客户位置
- **状态更新**：直接在日程表中快速更新状态
- **时间提醒**：任务前30分钟/1小时推送提醒
- **冲突检测**：自动检测时间冲突并预警

### 5.4 移动端优化
- **小屏适配**：适配手机屏幕，支持滑动和缩放
- **离线缓存**：支持离线查看日程，网络恢复后同步
- **快速操作**：一键导航、快速状态更新
- **推送通知**：任务提醒、状态变更通知

---

## 模块六：施工员工作量核算与结算模块

### 6.1 施工员认证与账户管理

#### 认证要求
- **第三方签约认证**：完成第三方劳务合同签约
- **零工合同管理**：确保所有合同均为零工形式
- **保险购买认证**：第三方购买保险的认证管理
- **认证状态管理**：认证通过后方可接单工作

#### 账户功能
**施工员端功能：**
- **外派订单查看**：查看分配的订单基本信息、客户信息、任务要求
- **外派订单日程表**：日历视图显示工作安排，包含时间、地点、客户、收入
- **日程提醒功能**：任务开始前30分钟/1小时推送提醒
- **导航集成**：点击地址直接调用地图导航
- **任务管理**：查看待接收、进行中、已完成的任务列表
- **任务详情**：查看任务详细信息、报价、要求和时间
- **任务状态更新**：更新状态、上传照片、填写报告
- **余额查询**：实时查看账户余额
- **收入明细**：查看每笔任务收入详情和系数调整
- **提现申请**：在线申请提现到银行卡
- **账单下载**：下载月度/季度收入账单
- **工作量统计**：查看工作量、完成率、质量评分
- **绩效分析**：查看准时率、客诉率、服务评分

**管理端功能：**
- **账户监控**：监控所有施工员账户状态
- **资金审核**：审核施工员提现申请
- **异常处理**：处理账户异常情况
- **报表生成**：生成施工员收入统计报表

### 6.2 计件报价管理

#### 报价规则
- **基础报价**：按任务类型设定基础报价
- **难度系数**：根据任务复杂度调整（0.8-1.5）
- **距离系数**：根据服务距离调整（0.9-1.3）
- **紧急系数**：紧急任务额外报价（1.0-1.5）
- **质量系数**：根据验收质量调整（0.8-1.2）

#### 报价单内容
- **任务信息**：客户信息、任务类型、要求
- **报价明细**：各项费用详细说明
- **预计收入**：施工员可获得的预计收入
- **验收标准**：任务完成的质量标准

### 6.3 工作量核算系统

#### 核算公式
```
实际收入 = 基础报价 × 难度系数 × 距离系数 × 紧急系数 × 质量系数 × 准时率系数 × 客诉率系数 × 服务评分系数
```

#### 考核指标
- **计件核算**：按完成任务数量核算工作量
- **质量考核**：结合验收质量核算最终收入
- **准时率考核**：统计按时完成任务的比率
- **客诉率考核**：统计服务过程中的客户投诉比率
- **服务评分考核**：基于客户评价的服务质量评分

### 6.4 实时结算系统

#### 收入结算流程
1. **验收通过**：任务验收合格
2. **收入计算**：系统自动计算应得收入
3. **实时入账**：收入立即转入施工员账户
4. **通知提醒**：施工员收到收入入账通知

#### 提现结算流程
1. **提现申请**：施工员提交提现申请
2. **审核审批**：管理员审核提现申请
3. **财务处理**：财务部门处理转账
4. **到账通知**：施工员收到提现到账通知

---

## 模块七：报表分析模块

### 7.1 L2C销售漏斗指标
- **线索转化率**：线索→商机转化率
- **商机转化率**：商机→报价转化率
- **报价转化率**：报价→成交转化率
- **总体转化率**：线索→成交总体转化率

### 7.2 销售单统计分析（第一阶段重点）

#### 销售单分析
- **销售单状态分布**：各状态销售单数量统计
- **销售单转化周期**：平均转化时间分析
- **销售单金额分析**：金额分布和趋势分析

#### 测量单分析（第二阶段）
- **测量单完成率**：测量任务完成率统计
- **测量师工作量**：测量师任务量和效率分析
- **测量异常率**：测量异常情况和处理分析

#### 安装单分析（第二阶段）
- **安装单完成率**：安装任务完成率统计
- **安装师工作量**：安装师任务量和效率分析
- **安装质量评分**：安装质量评价和趋势分析

#### 第一阶段简化分析
- **基础数据收集**：通过人工填写或表格上传方式收集测量安装数据
- **简化报表**：提供基础的测量安装数据统计报表
- **后续扩展**：第二阶段开发完整的测量安装分析功能

### 7.3 业绩考核指标

#### 销售考核指标
- **跟踪节奏考核**：平均跟踪间隔天数
- **线索转化考核**：线索总数、成交比例
- **个人业绩考核**：按设计师/导购维度统计
- **成交质量考核**：平均成交价格、成交周期

#### 服务提供商考核指标（第二阶段）
- **工作量排名**：服务提供商工作量排名统计
- **收入分析**：收入构成和趋势分析
- **效率分析**：任务完成效率分析
- **质量分析**：服务质量统计分析
- **准时率分析**：准时完成率统计和趋势
- **客诉率分析**：客诉率统计和问题类型分析
- **服务评分分析**：服务评分统计和客户反馈

#### 第一阶段简化考核
- **基础数据收集**：通过人工填写或表格上传方式收集服务数据
- **简化报表**：提供基础的服务数据统计报表
- **后续扩展**：第二阶段开发完整的服务提供商考核功能

### 7.4 积分分析报表
- **积分发放**：按时间、产品、门店维度统计
- **积分使用**：兑换率、热门礼品分析
- **积分余额**：用户积分余额分布分析
- **激励效果**：积分对销售业绩的影响分析

### 7.5 报表导出功能
- **文件格式**：Excel/PDF/CSV
- **数据范围**：按时间范围/按部门/按个人
- **图表类型**：柱状图/折线图/饼图/雷达图
- **自动发送**：定期自动发送报表功能

---

## 模块八：系统集成模块

### 8.1 VSS系统对接
- **数据同步**：实时同步订单和生产信息
- **字段映射**：系统间字段对应关系
- **错误处理**：同步失败的重试机制
- **日志记录**：完整的接口调用日志

### 8.2 微信登录集成
- **扫码登录**：微信扫码自动登录
- **绑定账号**：首次登录的账号绑定流程
- **权限验证**：微信用户对应的系统权限
- **会话管理**：登录状态保持时间

### 8.3 2B外部合作方积分接口（新增）
- **订单推送接口**：接收外部合作方订单推送
- **积分计算服务**：基于订单金额和品类计算积分
- **身份验证机制**：API Key + 数字签名认证
- **积分确认机制**：7天延迟确认，支持调整和取消
- **通知回调**：Webhook方式推送积分发放结果
- **接口规范**：详见《2B积分激励接口规范》文档

### 8.4 罗莱好伙伴小程序接口（新增）
- **用户认证接口**：微信登录、身份验证
- **积分查询接口**：积分余额、积分明细查询
- **礼品兑换接口**：礼品列表、兑换操作、兑换记录
- **订单查询接口**：关联订单状态、进度查询
- **消息通知接口**：积分变动、兑换状态、订单更新通知
- **数据统计接口**：个人业绩、积分趋势、排名信息

### 8.5 地图导航集成
- **地图API**：集成高德地图或百度地图API
- **导航功能**：一键导航到客户地址
- **路线规划**：最优路线推荐和时间预估
- **位置服务**：基于位置的任务分配和优化

### 8.6 短信验证集成
- **登录验证**：手机号+验证码登录
- **密码重置**：忘记密码时的身份验证
- **重要通知**：关键业务操作的通知
- **预警提醒**：系统预警的短信通知

---

## 🏗️ 技术架构要求

### 前端技术栈
- **Web端**：Next.js 15+ (App Router) + TypeScript + Tailwind CSS
- **微信小程序**：Taro 3.x + React + TypeScript
- **多应用架构**：按用户角色划分应用，支持独立部署和扩展

### 后端技术栈
- **服务端**：NestJS (模块化架构，TypeScript原生支持)
- **数据库**：PostgreSQL 15+ (主数据库)
- **缓存**：Redis 7+ (会话存储和热点数据)
- **ORM**：Prisma (类型安全，数据库迁移)
- **认证**：JWT + OAuth 2.0

### 部署环境
- **容器化**：Docker + Docker Compose (开发环境)
- **容器编排**：Kubernetes (生产环境)
- **API网关**：Kong / Traefik (路由、认证、限流)
- **监控告警**：Prometheus + Grafana + AlertManager

### 微服务演进路径
- **MVP阶段**：模块化单体架构，通过清晰的模块边界为未来微服务拆分做准备
- **扩展阶段**：根据业务负载和团队规模，逐步拆分高负载服务
- **成熟期**：形成完整的微服务架构，支持独立扩展和部署

### API设计规范
- **RESTful API**：遵循REST设计原则，为未来微服务拆分预留接口边界
- **版本管理**：API版本控制，支持向后兼容
- **文档规范**：Swagger/OpenAPI 3.0文档，自动生成和维护
- **认证授权**：统一的认证和授权机制，支持微服务间调用

---

## 📊 功能模块优先级

### 第一优先级（MVP版本 - 核心功能）
- **用户认证系统**：登录、注册、权限验证
- **销售机会管理**：线索录入（单条+Excel）、分配、转交、预警
- **销售单全流程跟踪**：27个状态流转，VSS系统对接（详细测量安装环节）
- **积分激励体系**：多节点积分计算，回款激励，多维度系数调节
- **积分商城与兑换系统**：礼品管理、兑换流程、积分扣减（优先开发）

### 第二优先级（V1.1版本 - 重要功能）
- **报表分析模块**：L2C销售漏斗分析、销售单统计分析、积分使用分析
- **角色权限管理**：8种角色权限细化，操作日志
- **测量安装环节完整功能**：测量单和安装单管理系统（第二阶段开发）
- **服务提供商管理**：日程表、工作量核算、实时结算（第二阶段开发）

### 第三优先级（V1.2版本 - 扩展功能）
- **微信小程序端**：移动端访问，核心功能适配
- **高级数据分析**：预测分析、趋势洞察
- **移动审批流程**：移动端审批，消息推送

### 分阶段交付计划
- **MVP版本**：核心业务流程闭环（4-6周）- 优先开发积分商城
- **V1.1版本**：完善业务功能（2-3周）
- **V1.2版本**：移动端和高级功能（3-4周）

---

## 🎨 用户体验要求

### 语言使用规范
- **用户界面**：所有用户可见的界面元素（按钮、标签、菜单、提示信息等）必须使用中文
- **表单字段**：表单标签、占位符文本、验证提示使用中文
- **数据展示**：表格标题、图表标签、统计指标名称使用中文
- **操作反馈**：成功、警告、错误等操作反馈信息使用中文
- **帮助文档**：用户手册、操作指南等文档使用中文

### 界面布局要求
**各角色主界面：**
- **管理员界面**：系统管理、用户管理、数据统计
- **领导界面**：团队数据、审批待办、分析报表
- **销售界面**：线索列表、跟进提醒、业绩看板
- **订单销售界面**：订单列表、生产进度、客户服务
- **派单员界面**：任务分配、进度监控、质量管理
- **施工员界面**：外派订单日程表、任务列表、账户余额、收入明细、工作量统计
- **好伙伴界面**：积分余额、礼品商城、订单进度

### 操作流程优化
- **线索录入**：简化录入流程，减少操作步骤
- **订单创建**：智能填充，减少重复输入
- **积分兑换**：一键兑换，简化操作流程
- **报表查看**：可视化展示，快速理解数据

### 移动端适配
- **核心功能**：施工员日程表、任务管理、账户查看、状态更新
- **日程表适配**：小屏幕适配，支持滑动查看、缩放操作
- **操作简化**：一键导航、快速状态更新
- **离线支持**：日程表数据离线缓存，网络恢复后同步
- **推送通知**：任务提醒、状态变更、收入到账通知
- **地图集成**：集成微信地图或第三方地图API

---

## 🗄️ 数据库设计要求

### 核心数据表（18张表）
- **用户表（users）**：包含城市、门店字段，支持8种角色
- **线索表（leads）**：完整的线索信息和跟踪记录
- **销售单表（sales_orders）**：27个状态的销售单流转管理
- **销售内容表（sales_contents）**：商品配置和价格计算
- **测量单表（measurement_orders）**：测量任务管理（第二阶段完整开发）
- **安装单表（installation_orders）**：安装任务管理（第二阶段完整开发）
- **商品库表（product_lib）**：商品库存和价格管理
- **服务提供商表（service_providers）**：测量师和安装工管理（第二阶段完整开发）
- **积分流水表（point_logs）**：积分发放和使用记录
- **礼品表（gifts）**：积分商城礼品管理（第一阶段优先开发）
- **兑换记录表（gift_exchanges）**：礼品兑换历史（第一阶段优先开发）
- **角色权限表（roles_permissions）**：角色权限配置
- **系统配置表（system_configs）**：系统参数配置
- **操作日志表（operation_logs）**：用户操作记录
- **消息通知表（notifications）**：系统消息和通知
- **附件表（attachments）**：文件上传和管理
- **地址库表（address_lib）**：地址信息库
- **字典表（dictionaries）**：系统字典数据

### 第一阶段简化数据表设计
- **测量安装数据表**：第一阶段用于记录人工填写或表格上传的测量安装数据
- **简化流程字段**：在销售单表中增加测量安装相关字段，支持第一阶段简易流程
- **后续扩展**：第二阶段开发完整的测量单和安装单管理系统

### 数据权限控制
- **行级安全**：基于用户角色的数据访问控制
- **字段级权限**：敏感字段的访问权限控制
- **审计日志**：完整的数据操作日志记录

### 数据库架构演进
- **MVP阶段**：单一PostgreSQL实例，支持事务一致性
- **扩展阶段**：读写分离，引入Redis缓存热点数据
- **成熟期**：分库分表，根据业务领域拆分数据库，支持微服务独立数据存储

### 数据一致性策略
- **强一致性**：核心业务数据使用数据库事务保证一致性
- **最终一致性**：非核心业务数据使用事件驱动保证最终一致性
- **分布式事务**：微服务架构下采用Saga模式处理分布式事务

---

## ✅ 验收标准

### 功能验收标准
- **线索管理**：支持Excel批量导入，自动分配，预警提醒
- **销售单流程**：27个状态正常流转，VSS系统对接成功（详细测量安装环节）
- **积分激励体系**：多节点积分正确计算发放，回款激励生效，商城兑换正常（优先开发）
- **权限系统**：8种角色权限正确控制，数据隔离有效
- **积分商城与兑换系统**：礼品展示、积分兑换、订单管理功能正常（第一阶段重点）
- **测量安装环节**：采用简易流程，支持人工填写或表格上传数据收集（第一阶段）

### 性能验收标准
- **响应时间**：页面加载时间<3秒，API响应时间<1秒
- **并发处理**：支持100个用户同时在线操作
- **数据处理**：Excel导入支持1000条记录批量处理
- **移动端性能**：小程序页面切换流畅，操作响应及时

### 安全验收标准
- **身份认证**：JWT令牌安全，会话管理完善
- **数据权限**：角色权限严格控制，数据隔离有效
- **敏感信息**：密码加密存储，敏感数据传输加密
- **操作审计**：关键操作完整日志记录

---

## 🚀 项目里程碑

### 里程碑1：基础架构搭建（1周）
- 项目初始化和环境搭建
- 数据库设计和初始化
- 用户认证系统实现
- 基础权限框架搭建

### 里程碑2：核心业务模块（3周）
- 线索管理模块完整实现
- 销售单管理模块和27状态流转（详细测量安装环节）
- 积分激励体系基础功能
- L2C销售漏斗基础报表功能
- 积分商城与兑换系统基础功能（优先开发）

### 里程碑3：积分商城与兑换系统完善（2周）
- 积分商城完整功能实现
- 礼品管理与库存管理
- 兑换流程与物流跟踪
- 移动端小程序基础功能

### 里程碑4：完善和优化（2周）
- 高级报表分析和数据洞察
- 系统集成和第三方对接
- 性能优化和安全加固
- 测量安装环节简易流程实现

---

**文档维护：** 项目团队  
**最后更新：** 2025年9月30日  
**版本：** v3.1（第一阶段MVP版本 - 优先积分商城）