# 项目计划 (To-Do List)

> **最新更新**: 2026-01-12 - 清理已完成任务，聚焦上线目标

---

## 📋 长期待办 (Backlog)

### 时序图文档计划

- [ ] 线索管理 (Lead)
- [ ] 报价单 (Quote)
- [ ] 订单 (Order)
- [ ] 测量服务 (Measure)
- [ ] 安装服务 (Install)
- [ ] 采购 (PO)
- [ ] 应收账款 (AR)
- [ ] 应付账款 (AP)
- [ ] 售后服务 (After-Sales)

---

## 开发路线图总览

```
Phase 1: 本地加固 (Current)   Phase 2: 生产准备          Phase 3: 移动端与扩展
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 🛠️ 深度测试 (E2E/Unit)       🐳 容器化编排            📱 移动端适配 (PWA)
 🐞 Bug 修复与体验打磨        🔒 安全审计              🧩 微信小程序集成
 ⚡ 性能基准测试              ☁️ 云资源配置            📊 BI 数据大屏
                              🚀 灰度发布              🤖 AI 智能助手
```

---

## Phase 1: 本地加固与测试 🛡️

> **目标**: E2E 测试通过率 100%，消除 Type Errors 和 Lint 警告

### 1.1 报价单测试覆盖 (3-4 天)

- [ ] **窗帘计算引擎测试** (`curtain-calc-engine.test.ts`)
  - [ ] 单开/多开窗帘计算用例
  - [ ] 0/负数输入防护测试
  - [ ] 极值边界测试 (褶皱 1.5-3.5)
- [ ] **墙纸/墙布测试** (`wallpaper-strategy.test.ts`)
  - [ ] 空/异常墙段数组
  - [ ] 幅宽边界测试
- [ ] **E2E 流程测试** (`quote-flow.e2e.spec.ts`)
  - [ ] 完整报价创建流程
  - [ ] 附件添加与计算
  - [ ] 报价转订单流程

### 1.2 自动化测试体系

- [ ] **E2E 核心链路 (Playwright)**
  - [ ] Flow 1: 销售闭环 (Lead -> Quote -> Order)
  - [ ] Flow 2: 财务闭环 (AR/AP/Labor)
  - [ ] Flow 3: 交付闭环 (Measure -> Install -> PO)
  - [ ] Flow 4: 权限边界 (Admin vs Sales vs Worker)
- [ ] **单元测试 (Vitest)**
  - [ ] 状态机: 订单/工单状态流转校验
  - [ ] 工具类: `cn`, `formatMoney`, `date` 等

### 1.3 安装模块流程测试

- [ ] 验证 "订单发货 -> 安装任务 -> 派单 -> 完工 -> 验收 -> 订单完成" 全流程

### 1.4 代码质量

- [ ] **Linting**: 清理剩余 ESLint 警告

---

## Phase 2: 部署准备 🚀

> **启动条件**: Phase 1 所有测试通过

- [ ] **容器化方案**
  - [ ] docker-compose.prod.yml (生产环境优化)
- [ ] **环境配置**
  - [ ] 环境变量审计 (.env.production)
  - [ ] 敏感密钥轮换 (Aliyun OSS/RDS Secrets)
- [ ] **数据迁移**
  - [ ] 生产环境 Schema Push
  - [ ] 种子数据初始化 (Admin/Dictionaries)

---

## Phase 3: 移动端与智能化 📱

> **启动条件**: 系统主流程上线稳定运行

- [ ] **测量/安装端 (Mobile Web/PWA)**
  - [ ] 移动端专属 Layout
  - [ ] 离线存储能力 (IndexedDB)
  - [ ] 拍照上传体验优化
- [ ] **智能化扩展**
  - [ ] 智能派单算法优化
  - [ ] AI 报价助手
  - [ ] 客户自助小程序

---

## Phase 4: 持续迭代 ♾️

- [ ] **高级监控**: Sentry 集成
- [ ] **性能优化**: Turbopack 迁移
- [ ] **数据分析**: 销售/交付/财务多维报表

---

## 🚀 上线工作计划 (Go-Live Checklist)

> **评估**: 项目完成度约 75%，预计 5-8 周可达上线标准

### 项目现状

| 维度       | 状态   | 说明                                      |
| :--------- | :----- | :---------------------------------------- |
| 核心功能   | ✅ 85% | 线索/报价/订单/采购/财务/服务模块基本完成 |
| 测试覆盖   | 🟡 60% | 单元测试较完善，E2E 测试需修复            |
| 代码质量   | 🟡 70% | 存在 TypeScript 类型错误和 Lint 警告      |
| 部署配置   | 🟠 40% | Docker 配置存在，生产环境配置待完善       |
| 文档完整度 | 🟡 65% | 核心文档已有，部分模块文档待补充          |

---

### P0: 关键问题修复 (1-2 周) 🔴

- [x] **E2E 测试修复**
  - [x] 修复 `auth.setup.ts` 认证流程
  - [x] 修复 `lead-status-workflow.spec.ts`
  - [x] 修复 `lead-measurement.spec.ts`
  - [ ] 确保所有 E2E 测试通过率 100%
- [x] **TypeScript 类型错误清理**
  - [x] 修复 `src/features/` 目录下的类型错误
  - [x] 修复 `src/app/` 目录下的类型错误
  - [x] 确保 `pnpm tsc --noEmit` 零错误
- [ ] **Lint 警告清理**
  - [ ] 修复 ESLint 警告 (unused vars, any types)
  - [ ] 确保 `pnpm lint` 零警告

---

### P1: 功能完善 (2-3 周) 🟡

- [ ] **报价单模块**: 完成测试覆盖
- [ ] **订单模块**: 验证状态机完整性，测试订单-采购-财务联动
- [ ] **供应链模块**: 验证库存预警，测试采购单生命周期
- [ ] **安装模块**: 完成流程串联测试

---

### P2: 上线准备 (1-2 周) 🟢

- [ ] **性能优化**
  - [ ] 数据库查询优化 (添加必要索引)
  - [ ] 前端 Bundle 分析与优化
  - [ ] API 响应时间基准测试
- [ ] **安全审计**
  - [ ] 敏感信息检查 (确保无硬编码密钥)
  - [ ] API 权限验证审计
  - [ ] SQL 注入/XSS 防护验证
- [ ] **部署配置**
  - [ ] 完善 `docker-compose.prod.yml`
  - [ ] 配置 `.env.production` 模板
  - [ ] 准备数据库迁移脚本
  - [ ] 配置 Nginx 反向代理
- [ ] **文档完善**
  - [ ] 部署运维手册
  - [ ] 用户操作手册
  - [ ] API 接口文档更新

---

### P3: 上线发布 (1 周) 🔵

- [ ] **UAT 测试**: 业务方验收、回归测试、压力测试
- [ ] **数据迁移**: Schema 初始化、基础数据导入、历史数据迁移
- [ ] **正式发布**: 灰度发布、监控告警配置、回滚方案准备

---

## 关键里程碑

| 阶段               | 预计完成 | 交付准则                   | 状态      |
| :----------------- | :------- | :------------------------- | :-------- |
| **M1: 本地加固**   | TBD      | 所有测试通过, 无 P0/P1 Bug | 🟡 进行中 |
| **M2: 预发部署**   | TBD      | Staging 环境部署成功       | ⏳ 待开始 |
| **M3: 生产上线**   | TBD      | 生产环境数据跑通           | ⏳ 待开始 |
| **M4: 移动端发布** | TBD      | 现场人员可脱离 PC 操作     | ⏳ 待开始 |

---

## ✅ 已完成归档

<details>
<summary>点击展开已完成的功能模块</summary>

### 报价单模块优化

- 超高预警 UI 显示
- 配置管理界面完善
- 版本对比视图
- Excel 商品导入功能
- 代码重构 (actions.ts, quote-bundle-editor.tsx)

### 消息与触达

- 通知 Schema 与多渠道分发引擎
- NotificationBell 组件与 Toast 规范化

### 安装模块

- 独立创建入口 (CreateInstallTaskDialog)
- 调度视图优化 (ScheduleCalendarView)

### 订单拆单与采购优化

- 拆单逻辑配置化
- 采购预览与人工干预
- 合并采购 (拼单)

### 测量服务增强

- 复测支持
- 测量历史追踪
- 复测结果同步

### 体验与性能

- 错误边界处理 (Sonner Toast)
- 表单验证反馈文案 (Zod 中文)
- 保存草稿功能
- 玻璃拟态 UI 效果
- 附件自动配比计算

### 代码质量

- Type Safety 改进
- README.md 与 API.md 文档
- 报价计算逻辑架构收敛

</details>

---

## 相关文档

- [测试策略](./requirements/test-strategy.md)
- [用户旅程图](./user-journeys/README.md)
- [报价单需求](./报价单需求.md)
- [订单模块需求](./订单模块需求.md)
