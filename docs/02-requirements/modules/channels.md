# 渠道管理 (Channels) 模块需求规格说明

## 1. 模块边界与核心定位
渠道管理模块主要负责 L2C 系统中所有外部合作方（经销商、分销商、推广渠道等）的入驻、信息维护、以及与之相关的佣金计算和结算流程。该模块与用户认证(Auth)、订单管理(Orders)紧密关联，并在财务上与资金流(Finance)衔接。

## 2. 核心业务实体 (Entities)

### 2.1 渠道档案 (Channel)
- 渠道基础信息（名称、统一社会信用代码、法人等）
- 层级关系（父子渠道，**需做防循环引用检测**）
- 佣金模式配置（返佣模式 / 底价供货模式）
- 状态控制（活跃/禁用）

### 2.2 渠道联系人 (Channel Contact)
- 区分主要联系人和其他联系人。
- 提供创建渠道时同步创建主联系人的能力。

### 2.3 渠道佣金记录 (Channel Commission)
- 基于关联订单的金额、产品成本和模式配置自动计算产生的佣金。
- 具有四种状态：`PENDING` (待入账)、`SETTLED` (已出账待结算)、`PAID` (已支付)、`VOID` (已作废或退回)。

### 2.4 调整记录 (Channel Adjustment)
- 记录因售后退款、价格调整导致的佣金追回。

## 3. 核心业务流程与功能

### 3.1 佣金计算逻辑 (Commission Service)
支持以下两大类合作模式：

1. **返佣模式 (Commission Mode)**
   - **固定费率**：对所有订单直接抽取固定比例。
   - **阶梯费率**：按订单金额或区间进行匹配，满足某梯度后使用对应比率。

2. **底价供货模式 (Base Price Mode)**
   - 渠道存在结算底价。
   - 按照实际订单销售额减去产品底价和附加成本，来核算渠道的最终利润留存。

### 3.2 订单退款时的佣金扣回 (Clawback)
- 当订单发生整单退款或部分退款时，系统会自动重算。
- 若原本佣金为 `PENDING`，则直接被作废拦截；若已 `SETTLED` 或 `PAID`，则通过 `adjustments` 表生成负数流水实现抵扣。

## 4. 安全与权限 (RBAC)
- 必须具备权限项：`CHANNEL.CREATE`, `CHANNEL.EDIT`, `CHANNEL.DELETE`, `CHANNEL.MANAGE_COMMISSION` 才能执行对应操作。
- 管理员进行佣金结算时，需通过审批工作流，具备职责分离机制，不能既审核又结算。

## 5. 性能与并发要求
- 计算金额、费率和底价时，必须使用 `Decimal.js` 以规避 JS 浮点数的精度误差。
- 在发生并发写入（比如高并发成交时的佣金累加）时，表级别应引入乐观锁验证 (`version` 字段) 或者事务强制串行化操作，确保数据一致性。
