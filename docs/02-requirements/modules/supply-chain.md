# L2C SaaS 核心模块需求文档：供应链管理 (V1.0)

## 1. 模块概述

本模块负责 L2C 全链路中的**基础资源管理与自动化决策**。它管理着系统中最核心的静态数据（供应商、产品套件）以及驱动业务自动化流转的拆单规则。

### 1.1 核心目标

1. **资源标准化**：建立统一的供应商库与产品套件体系。
2. **决策自动化**：利用拆单引擎（Split Engine）将订单需求自动路由至最优供应节点。
3. **可追溯性**：通过审计日志记录所有配置变更，确保供应链决策的可审计性。

### 1.2 相关模块

| 模块 | 关系 | 数据流向 |
| :--- | :--- | :--- |
| **基础设置** | 依赖 | 租户、用户权限 → 供应链访问控制 |
| **报价单** | 数据源 | 报价单项 (Quote Items) → 拆单引擎输入 |
| **订单** | 数据源 | 订单项 (Order Items) → 拆单引擎输入 |
| **采购单** | 下游 | 拆单引擎输出 → 自动生成采购单 (Purchase Orders) |
| **加工单** | 下游 | 拆单引擎输出 → 自动生成加工单 (Work Orders) |

---

## 2. 核心业务领域 (Core Domains)

### 2.1 供应商管理 (Suppliers)

供应商是供应链的源头，根据业务职能分为三类：

- **面料供应商 (FABRIC_SUPPLIER)**：提供布料、辅料等原材料。
- **成品供应商 (FINISHED_SUPPLIER)**：提供现成的商品（如轨道、电机等）。
- **加工厂 (PROCESSOR)**：负责将面料加工为成品的第三方机构。

### 2.2 产品套件 (Product Bundles)

套件是将多个原子产品组合为一个 SKU 的逻辑实体，用于简化报价和销售。
- **级联删除**：删除套件时需同步清理子项关联。
- **SKU 唯一性**：套件 SKU 在租户内必须唯一。

### 2.3 拆单规则 (Split Rules)

拆单规则定义了特定条件下，商品应流向哪个供应商或生成哪种单据。
- **优先级管理**：规则按 `priority` 升序匹配，先命中先执行。
- **条件过滤**：支持基于品类、属性、供应商 ID 等维度的灵活匹配。

---

## 3. 拆单引擎工作流 (Split Engine Workflow)

拆单引擎是供应链的核心大脑，其执行过程分为两个阶段：

### 阶段 1：分类 (Classification)
根据商品类型（成品/材质）进行初步分流：
- **成品 (FINISHED)**：流向成品采购单流程。
- **材质 (MATERIAL)**：流向面料采购 + 加工单流程。

### 阶段 2：路由匹配 (Rule Matching)
遍历并匹配已启用的规则：
1. 检查商品属性是否符合规则条件。
2. 根据规则设定的 `targetType` 确定产出：
   - `PURCHASE_ORDER`：生成采购单建议。
   - `WORK_ORDER`：生成加工单建议（针对面料加工）。
3. 聚合结果并生成 PO/WO 草稿。

---

## 4. 关键接口设计 (API Actions)

### 4.1 拆单逻辑
- `splitOrder(items, options)`: 核心计算接口，返回分组后的建议单据。

### 4.2 供应商与物流
- `createSupplier` / `updateSupplier`: 维护供应商档案。
- `createShipment`: 记录采购单发货信息，触发 PO 状态变更。

### 4.3 套件与规则管理
- `createProductBundle`: 创建组合商品及其明细。
- `getSplitRules`: 获取排序后的路由策略列表。

---

## 5. 权限与审计

### 5.1 权限代码
- `PO_MANAGE`: 管理采购单及物流信息。
- `SUPPLIER_MANAGE`: 维护供应商及路由规则。
- `VIEW`: 查看供应链基础数据。

### 5.2 审计要求
所有写操作必须记录：
- 操作人 ID
- 具体操作动作 (如 `CREATE_SHIPMENT`, `UPDATE_RULE`)
- 数据快照 (ID 或 关键属性)

---

## 6. 待优化事项 (L5 路线图)

- [ ] **性能优化**：在拆单引擎中使用 Redis 缓存频繁使用的规则列表。
- [ ] **数据洞察**：建立供应商交期准确性评分体系。
- [ ] **弹性规则**：支持按库存水位自动切换备选供应商。
