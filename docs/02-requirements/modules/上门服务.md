# 上门服务（Service）模块需求与设计规范

本模块负责整个 L2C 链条中至关重要的履单环节的闭环，涵盖基础的上门量尺（售前测量）、安装调度执行以及售后问题处理的生命周期管理。

## 1. 核心流程与生命周期

### 1.1 安装任务全生命周期
- **触发生成**：在一笔含实体商品的 `Order` 被提交且完成尾款或预付要求时，系统将基于其中的 `OrderItems` 按照品类和房间标签转化为多个独立并行的子 `Install Task` 子任务单据。
- **调度阶段 (Dispatching)**：管理员或派单员依据任务需要匹配的技能 (`workerSkills`) 及距离、师傅排班空挡执行工单下发。工单流转为 `PENDING_ACCEPT` 状态。
- **上门与处理阶段**：
  - **到达签到/检出 (Check-in/out)**：师傅需要在客户授权区域规定的经纬度几何辐射范围内，利用移动端触发到达与离开动作打卡，生成迟到考核时长以及位置存证。
  - **安装执行**：师傅分项对安装物资进行安装并且回传相片与工单完成日志，最终工单流转为 `CLOSED / DONE`。
- **异常拦截约束**：严禁向尚未认证且可用状态不通过的工人强制下发单据。
  
### 1.2 售后工单处理流程
售后工单作为维系品牌生命力的核心反馈机制：
1. **受理诉求 (Pending Initiation)**：客户由各端点进线或是后台建立 `AfterSalesTicket`。
2. **定责流转 (Processing)**：由专员分配至指定网点或是具体师傅名下，执行上门或远程处理判定，更新 `resolution` 处理意见与沟通存证。
3. **闭环核销 (Closed)**：完结工单转入历史数据库，并**受到严格的状态保护，已 `CLOSED` 的工单在无超管审批下禁止私自回溯改变其生命进程以免掩饰投诉（防篡改保护）**。
4. **日志追踪**：工单任何阶段扭转以及分发均由系统统一的审计服务 (`AuditService`) 无死角捕获。

## 2. 调度智能算法说明

### 2.1 任务智能拆分降噪 (Smart Split)
在原多类型的合并大单中防止一人无法完工（比如窗帘师傅无法独立安装复杂的电动轨道+墙咔），系统的 `task-split-actions` 负责：
- 识别报价与订单中存在的基础 `Items`，遇到有效 `quantity > 0` 的项时即激发分析。
- 内置 `CATEGORY_SKILL_MAP` (品类-安装技能矩阵)：把商品的属性动态映射到人力资本技能库的 `INSTALL_CURTAIN` / `INSTALL_WALLCLOTH` 等维面。
- 将复杂物料组转化为可指派具体师傅维度的 `SplitSuggestion`，并动态呈现对应满足资格的候选工人数目备选。

### 2.2 师傅评分与动态派发
针对 `dispatch` 操作，后端具备以下判定：
- 系统拒绝无效请求：指定 ID 不存在、ID 为无效角色。
- 未来方向（Smart Score）：综合打卡准点率 (`lateMinutes` 存证累积负分)、安装退回反馈评价、品类能力矩阵这三个权重动态分配工单排序权重，提供 "最优解师傅"。
