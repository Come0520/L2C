# 供应链模块需求 (Supply Chain)

## 1. 模块概述 (Module Overview)

| 属性 | 说明 |
|:---|:---|
| **模块名称** | 供应链 (Supply Chain) |
| **核心价值** | 管理商品和供应商基础数据，支撑订单自动拆单 |
| **目标用户** | 采购员、管理员、店长 |
| **上游模块** | 无 (基础数据) |
| **下游模块** | 报价单、采购单 |

## 2. 供应商管理 (Supplier)
*   **基础信息**: 供应商名称、联系人、结算方式（月结/现结）。
*   **关联能力**: 能够查询该供应商历史供货的采购单及对账单。
*   **供应商类型**: 支持三种供应商类型：
    *   **面料供应商** (FABRIC_SUPPLIER): 提供窗帘布料、窗帘纱、墙布等原材料
    *   **成品供应商** (FINISHED_SUPPLIER): 提供成品窗帘、轨道、电机等成品
    *   **加工厂** (PROCESSOR): 负责将面料加工成成品

### 2.1 供应商类型说明

| 供应商类型 | 英文代码 | 说明 | 关联单据 |
|:---|:---|:---|---|
| 面料供应商 | `FABRIC_SUPPLIER` | 提供面料原材料 | 面料采购单 |
| 成品供应商 | `FINISHED_SUPPLIER` | 提供成品商品 | 成品采购单 |
| 加工厂 | `PROCESSOR` | 负责面料加工 | 加工单 |

### 2.2 供应商表字段扩展

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| id | UUID | ✓ | 主键 |
| supplier_no | String | ✓ | 供应商编号 |
| name | String | ✓ | 供应商名称 |
| supplier_type | Enum | ✓ | 供应商类型 (FABRIC_SUPPLIER/FINISHED_SUPPLIER/PROCESSOR) |
| contact_person | String | - | 联系人 |
| phone | String | - | 电话 |
| address | String | - | 地址 |
| payment_period | Enum | - | 结算方式 (CASH/MONTHLY) |
| is_active | Boolean | - | 是否启用 |
| remark | Text | - | 备注 |
| created_at | DateTime | ✓ | 创建时间 |

### 2.3 供应商资质管理

供应商资质文件管理,包括合同、营业执照等关键文件。

#### 2.3.1 供应商资质字段扩展

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| documents | JSONB | - | 资质文件集合 |
| credit_code | String | - | 统一社会信用代码 |
| tax_id | String | - | 税号 |
| bank_account | String | - | 银行账号 |
| bank_name | String | - | 开户银行 |

#### 2.3.2 资质文件结构 (documents JSONB)

```typescript
interface SupplierDocuments {
  contract: {
    url: string;           // 合同文件 URL
    expiry_date: string;   // 合同到期日期 (YYYY-MM-DD)
    signed_at: string;     // 签署日期 (YYYY-MM-DD)
    status: 'ACTIVE' | 'EXPIRED' | 'PENDING_RENEWAL';
  };
  business_license: {
    url: string;           // 营业执照 URL
    expiry_date: string;   // 营业执照到期日期
    status: 'VALID' | 'EXPIRED';
  };
  quality_cert: {
    url: string;           // 质量认证证书 URL
    expiry_date: string;   // 证书到期日期
    status: 'VALID' | 'EXPIRED';
  };
  other_documents?: Array<{
    name: string;          // 文件名称
    url: string;           // 文件 URL
    expiry_date?: string;  // 到期日期 (如有)
  }>;
}
```

#### 2.3.3 合同到期提醒

**提醒规则**:
*   **提前 30 天提醒**: 合同到期前 30 天,系统自动发送提醒通知给采购员
*   **提醒渠道**: 微信服务号、系统内消息
*   **提醒内容**: "供应商 [供应商名称] 的合同将于 [到期日期] 到期,请及时续签"
*   **续签操作**: 采购员可上传新的合同文件,更新 `documents.contract` 字段
*   **状态自动更新**: 系统每日检查合同到期状态,自动更新 `status` 字段

**提醒频率**:
*   到期前 30 天: 首次提醒
*   到期前 15 天: 二次提醒
*   到期前 7 天: 紧急提醒
*   到期当天: 最后提醒

## 3. 商品管理 (Product)
*   **多维度属性**: 对应报价单的多品类（窗帘、墙布等）。
*   **多供应商支持**: 同一个商品可以关联多个供应商，每个供应商可以设置不同的采购价和供货周期。
*   **默认供应商**: 每个商品可绑定一个 `default_supplier_id`。
    *   **作用**: 在订单转采购单时，系统根据此字段自动将 Items 分组。
    *   **示例**:
        *   Item A (布料) -> Default Supplier: 面料供应商 A
        *   Item B (电机) -> Default Supplier: 成品供应商 B
        *   -> 自动生成 PO-001 (面料采购单) 和 PO-002 (成品采购单)
    *   **人工干预 (Manual Override)**:
        *   系统预生成的采购单仅为 **建议方案 (Draft)**。
        *   客服在确认下单前，**可以手动调整**商品的供应商（例如：面料供应商A缺货，临时改为面料供应商C），系统需支持将 Order Item 移动至另一张采购单。

*   **自动路由规则**: 定义每个商品的默认供应商，支持订单自动拆单。
*   **商品类型**: 根据采购路线分为两种类型：
    *   **成品商品** (FINISHED): 直接从成品供应商采购，无需加工
    *   **面料商品** (FABRIC): 从面料供应商采购面料，需要送加工厂加工

### 3.0 商品类型说明

| 商品类型 | 英文代码 | 说明 | 采购流程 |
|:---|:---|:---|---|
| 成品商品 | `FINISHED` | 成品窗帘、轨道、电机等 | 订单 → 成品采购单 → 成品供应商 → 发货 |
| 面料商品 | `FABRIC` | 窗帘布料、窗帘纱、墙布等 | 订单 → 面料采购单 → 面料入库 → 加工单 → 加工厂 → 发货 |

### 3.1 商品属性模板 (Product Attribute Templates)

商品使用 **JSONB** 存储动态属性，不同品类有不同的属性结构。系统需提供**可配置的属性模板**，管理员可在后台定义每个品类的属性字段。

#### 基础字段 (所有商品通用)

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| id | UUID | 主键 |
| sku | String | 商品编码 |
| name | String | 商品名称 |
| category | Enum | 品类 (见 3.2) |
| product_type | Enum | 商品类型 (FINISHED/FABRIC) |
| main_unit | String | 主计量单位 (如 "米")，库存以此为准 |
| aux_unit | String | 辅助单位 (如 "卷") |
| unit_relation | String | 单位转换关系 (如 "1卷=50米") |
| conversion_rate | Decimal | 转换率 (如 50，表示 1 aux_unit = 50 main_unit) |
| default_supplier_id | UUID | 默认供应商（从商品供应商关联表中选择） |
| is_stockable | Boolean | 是否为库存品 |
| is_active | Boolean | 是否上架 |
| is_tob_enabled | Boolean | 是否在 ToB 渠道上架 |
| is_toc_enabled | Boolean | 是否在 ToC 零售上架 |
| attributes | JSONB | 品类特有属性 (见下) |
| created_at | DateTime | 创建时间 |

#### 3.1.1 单位字段说明

**主计量单位 (main_unit)**:
*   **定义**: 库存管理和成本计算的基础单位
*   **示例**: 米、平米、个、套
*   **用途**: 所有库存数量、成本计算均以此单位为准

**辅助单位 (aux_unit)**:
*   **定义**: 采购或销售时常用的辅助计量单位
*   **示例**: 卷、箱、包
*   **用途**: 采购入库、销售出库时可选择使用辅助单位

**单位转换关系 (unit_relation)**:
*   **定义**: 描述主单位和辅助单位之间的转换关系
*   **格式**: "{数量}{aux_unit}={数量}{main_unit}"
*   **示例**: "1卷=50米"、"1箱=100个"

**转换率 (conversion_rate)**:
*   **定义**: 辅助单位到主单位的数值转换比例
*   **计算**: `主单位数量 = 辅助单位数量 × conversion_rate`
*   **示例**: 
    *   1卷 = 50米 → conversion_rate = 50
    *   1箱 = 100个 → conversion_rate = 100

#### 3.1.2 单位转换示例

**场景 1: 面料采购入库**
*   采购单: 10 卷面料
*   商品配置: main_unit="米", aux_unit="卷", conversion_rate=50
*   入库计算: 10 卷 × 50 = 500 米
*   库存记录: 500 米

**场景 2: 面料销售出库**
*   销售订单: 需要 120 米面料
*   商品配置: main_unit="米", aux_unit="卷", conversion_rate=50
*   出库计算: 120 米 ÷ 50 = 2.4 卷
*   出库记录: 2.4 卷 (或 120 米)

**场景 3: 标品管理**
*   商品: 窗帘配件
*   配置: main_unit="个", aux_unit="箱", conversion_rate=100
*   采购: 5 箱 → 入库 500 个
*   销售: 150 个 → 出库 1.5 箱

#### 3.1.3 单位转换规则

**入库规则**:
*   采购单入库时,如果使用辅助单位,自动转换为主单位记录库存
*   公式: `入库数量(主单位) = 入库数量(辅助单位) × conversion_rate`

**出库规则**:
*   销售出库时,系统支持按主单位或辅助单位出库
*   如果按辅助单位出库,自动转换为主单位扣减库存
*   公式: `出库数量(主单位) = 出库数量(辅助单位) × conversion_rate`

**库存查询规则**:
*   库存列表默认显示主单位数量
*   支持切换显示辅助单位数量
*   公式: `辅助单位数量 = 主单位数量 ÷ conversion_rate`

#### 成本维度（内部可见，核心利润计算依据）

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| purchase_price | Decimal | 标准采购价：与供应商约定的原始单价 |
| logistics_cost | Decimal | 物流成本：从工厂到仓库或加工厂的平摊运费 |
| processing_cost | Decimal | 加工成本：每米或每扇窗帘的缝制、制作费用 |
| loss_rate | Decimal | 损耗系数：默认 0.05 (5%) |
| internal_cost | Decimal | 真实成本：purchase_price + logistics_cost + processing_cost × (1 + loss_rate) |

#### 销售维度（针对不同客户类型）

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| retail_price | Decimal | 零售价：面向 ToC 散客的标价，也是计算折扣的基准 |
| channel_price | Decimal | 标准渠道结算价：面向装企、设计师等合作伙伴的标准渠道结算价（底价供货模式） |
| channel_price_mode | Enum | 渠道价策略：FIXED（固定单价）或 DISCOUNT（零售价打折） |
| channel_discount_rate | Decimal | 渠道价折扣率：如 0.6 表示零售价的 6 折（仅当 mode=DISCOUNT 时有效） |
| floor_price | Decimal | 最低售价：给销售人员的权限底线，防止低价乱单 |

**渠道定价说明**：
* **底价供货模式**：同一商品同时存在对客价（retail_price）和渠道结算价（channel_price）
* **渠道等级折扣**：根据渠道等级（S/A/B/C）应用不同的折扣率，折扣率在租户级别配置
* **最终结算价计算**：`最终结算价 = 标准渠道结算价 × 渠道等级折扣率`
* **示例**：
  * 商品A对客价：100元
  * 标准渠道结算价：80元
  * 某租户配置：S级95折，B级无折扣
  * S级渠道结算价：80 × 0.95 = 76元
  * B级渠道结算价：80 × 1.00 = 80元

#### 商品供应商关联表 (product_suppliers)

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| id | UUID | 主键 |
| product_id | UUID | 关联商品 |
| supplier_id | UUID | 关联供应商 |
| is_default | Boolean | 是否为默认供应商 |
| purchase_price | Decimal | 该供应商的采购价（可覆盖商品标准采购价） |
| logistics_cost | Decimal | 该供应商的物流成本（可覆盖商品标准物流成本） |
| processing_cost | Decimal | 该供应商的加工成本（可覆盖商品标准加工成本） |
| lead_time_days | Integer | 供货周期（天） |
| min_order_quantity | Decimal | 最小起订量 |
| is_active | Boolean | 是否启用 |
| created_at | DateTime | 创建时间 |

**业务规则**：
* 同一个商品可以关联多个供应商，每个供应商可以设置不同的采购价和供货周期。
* 系统自动计算每个供应商的真实成本：`purchase_price + logistics_cost + processing_cost × (1 + loss_rate)`
* 在创建采购单时，优先使用默认供应商，但可以选择其他供应商。
* 如果某个供应商的采购价更低，系统可以提示采购员考虑更换供应商。

### 3.2 品类枚举 (Category Enum)

| 品类 | 代码 | 计价方式 |
|:---|:---|:---|
| 窗帘布料 | `CURTAIN_FABRIC` | 按米/按平米 |
| 窗帘纱 | `CURTAIN_SHEER` | 按米/按平米 |
| 窗帘轨道 | `CURTAIN_TRACK` | 按米 |
| 窗帘配件 | `CURTAIN_ACCESSORY` | 按个/按套 |
| 墙布 | `WALLCLOTH` | 按卷/按平米 |
| 墙咔 | `WALLPANEL` | 按平米/按块 |
| 飘窗垫 | `WINDOWPAD` | 按件 (定制尺寸) |
| 标品 | `STANDARD` | 按个 |
| 电机 | `MOTOR` | 按台 |

### 3.3 品类属性模板 (Category Attribute Schema)

#### A. 窗帘布料 (CURTAIN_FABRIC)

```typescript
interface CurtainFabricAttributes {
  // 基础属性
  fabric_type: '布帘' | '绒布' | '棉麻' | '涤纶';
  pattern: '纯色' | '印花' | '提花' | '刺绣';
  width_standard: number;        // 门幅宽度 (cm)，如 280/310
  
  // 工艺属性
  pleat_styles: ('打褶' | '穿杆' | '波浪帘' | 'S帘')[];  // 支持的褶皱工艺
  shrinkage_rate: number;        // 缩水率 (%)
  
  // 计价参数
  price_mode: 'by_meter' | 'by_sqm';  // 按米/按平米
  fold_ratio_default: number;    // 默认倍率 (如 2.0)
  process_fee: number;           // 加工费 (元/米)
  
  // 安装约束
  min_width: number;             // 最小宽度 (cm)
  max_width: number;             // 最大宽度 (cm)
  is_washable: boolean;          // 是否可水洗
}
```

#### B. 窗帘轨道 (CURTAIN_TRACK)

```typescript
interface CurtainTrackAttributes {
  track_type: '铝合金' | '罗马杆' | '电动轨道';
  material: '铝' | '木' | '不锈钢';
  color_options: string[];       // 可选颜色
  max_length: number;            // 单根最大长度 (cm)
  load_capacity: number;         // 承重 (kg/米)
  
  // 电动轨道专属
  motor_required?: boolean;
  compatible_motors?: string[];  // 兼容电机型号
  
  // 安装约束
  bracket_spacing: number;       // 建议支架间距 (cm)
  min_box_depth?: number;        // 最小窗帘盒深度 (cm)
}
```

#### C. 墙布 (WALLCLOTH)

```typescript
interface WallclothAttributes {
  material: '无纺布' | '丝绸' | 'PVC';
  roll_width: number;            // 卷宽 (cm)，如 53/70/106
  roll_length: number;           // 卷长 (米)，如 10/15
  pattern_repeat: number;        // 花纹循环 (cm)
  
  // 计价参数
  price_mode: 'by_roll' | 'by_sqm';
  loss_rate: number;             // 损耗率 (%)
  
  // 施工属性
  glue_type: '湿胶' | '热熔胶' | '自粘';
  is_moisture_proof: boolean;    // 防潮
}
```

#### D. 标品 (STANDARD)

```typescript
interface StandardProductAttributes {
  product_type: '抱枕' | '挂画' | '窗帘扣' | '流苏';
  size: string;                  // 规格描述
  color_options: string[];
  
  // 库存相关
  safety_stock: number;          // 安全库存
  lead_time_days: number;        // 采购周期 (天)
}
```

### 3.4 属性模板配置 (Admin Configuration)

管理员可在后台自定义品类属性：
*   **新增字段**: 定义字段名、类型 (String/Number/Boolean/Enum/Array)、是否必填
*   **编辑约束**: 设置数值范围、下拉选项列表
*   **字段排序**: 调整在录入界面的显示顺序
*   **关联报价公式**: 将属性字段绑定到报价计算规则中

### 3.5 报价公式关联 (Pricing Formula)

商品属性直接影响报价计算，系统需支持**可配置的计价公式**：

| 品类 | 公式示例 |
|:---|:---|
| 窗帘布料 | `单价 × 宽度(米) × 高度(米) × 褶皱倍率 + 加工费` |
| 窗帘轨道 | `单价 × 长度(米) + 切割费` |
| 墙布 | `单价 × (面积 × (1 + 损耗率))` |
| 电机 | `固定单价 × 数量` |

**可视化配置**: 管理员可通过公式编辑器组合字段，生成计价规则，无需修改代码。

## 4. 库存管理 (Inventory)
针对 **标品 (Standard Products)**（如：罗马杆、成品轨道、抱枕），系统需支持库存管理。

*   **商品属性**:
    *   `is_stockable`: 是否为库存商品。
    *   `stock_quantity`: 当前库存数量。
*   **出库逻辑**:
    *   当订单包含标品时，拆单逻辑会将这些商品指向 **"本地仓库"** (Internal Warehouse)。
    *   生成 **"领料单/备货单"** (Stock Pick List)，而非外部采购单。
*   **库存扣减**:
    *   **预占**: 订单生成/拆单时，预占库存。
    *   **扣减**: 确认发货时，实扣库存。

## 4.5 面料库存管理 (Fabric Inventory)

针对 **面料商品**（如窗帘布料、窗帘纱、墙布），系统需支持面料库存管理。

### 4.5.1 业务场景

1. **面料采购入库**: 面料采购单到货后，面料入库，增加库存
2. **面料预占**: 生成加工单时，预占面料库存
3. **面料出库**: 加工厂领取面料时，扣减库存
4. **面料盘点**: 定期盘点面料库存，调整账面数量
5. **面料退库**: 加工剩余面料退回仓库

### 4.5.2 面料库存表 (fabric_inventory)

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| id | UUID | ✓ | 主键 |
| tenant_id | UUID | ✓ | 租户ID |
| fabric_product_id | UUID | ✓ | 关联面料商品 |
| fabric_sku | String | ✓ | 面料SKU |
| fabric_name | String | ✓ | 面料名称（冗余） |
| fabric_color | String | - | 颜色/花色 |
| fabric_width | Decimal | - | 幅宽（米） |
| fabric_roll_length | Decimal | - | 卷长（米） |
| batch_no | String | ✓ | 批次号 |
| purchase_order_id | UUID | - | 来源采购单 |
| supplier_id | UUID | - | 供应商ID |
| available_quantity | Decimal | ✓ | 可用数量（米/卷） |
| reserved_quantity | Decimal | ✓ | 已预占数量（米/卷） |
| total_quantity | Decimal | ✓ | 总库存（米/卷） |
| safety_stock | Decimal | - | 安全库存（米/卷） |
| max_stock | Decimal | - | 最大库存水位（米/卷） |
| purchase_date | Date | - | 采购日期 |
| expiry_date | Date | - | 有效期（如有） |
| warehouse_location | String | - | 仓库位置 |
| is_active | Boolean | - | 是否启用 |
| created_at | DateTime | ✓ | 创建时间 |
| updated_at | DateTime | ✓ | 更新时间 |

#### 4.5.2.1 唯一键约束

**唯一库存键 (Unique Key)**:
*   **定义**: `fabric_sku + batch_no` 为唯一库存键
*   **含义**: 同一 SKU 不同批次号在逻辑上视为不同库存行
*   **数据库约束**: `UNIQUE (fabric_sku, batch_no)`

**业务场景**:
*   **色差问题**: 不同批次的布料存在色差,不能混用
*   **补单场景**: 客户补单时需要使用同一批次的面料,保证颜色一致
*   **批次隔离**: 系统必须严格区分不同批次的库存,不能混在一起计算

**示例**:
```
SKU: CF-001 (米白色窗帘布)
批次1: BATCH-20250101-001, 可用数量: 200米
批次2: BATCH-20250115-003, 可用数量: 150米

系统显示为两行独立的库存记录,不能合并显示为 "350米"
```

### 4.5.3 面料库存流水表 (fabric_inventory_logs)

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|
| id | UUID | ✓ | 主键 |
| tenant_id | UUID | ✓ | 租户ID |
| fabric_inventory_id | UUID | ✓ | 关联面料库存 |
| log_type | Enum | ✓ | 流水类型 (PURCHASE_IN/PROCESSING_OUT/ADJUSTMENT/RETURN) |
| quantity | Decimal | ✓ | 数量变化 |
| before_quantity | Decimal | ✓ | 变化前数量 |
| after_quantity | Decimal | ✓ | 变化后数量 |
| reference_id | UUID | - | 关联单据ID（采购单/加工单） |
| reference_type | String | - | 单据类型 |
| remark | Text | - | 备注 |
| created_at | DateTime | ✓ | 创建时间 |
| created_by | UUID | - | 创建人 |

### 4.5.4 流水类型说明

| 流水类型 | 代码 | 说明 | 触发场景 |
|:---|:---|:---|---|
| 面料入库 | `PURCHASE_IN` | 面料采购入库 | 面料采购单到货 |
| 面料出库 | `PROCESSING_OUT` | 面料加工出库 | 生成加工单 |
| 库存调整 | `ADJUSTMENT` | 手动调整库存 | 盘点调整 |
| 面料退库 | `RETURN` | 面料退回仓库 | 加工剩余面料退库 |

### 4.5.5 面料库存业务规则

**入库规则**:
*   面料采购单到货后，采购员确认入库
*   系统自动生成批次号（格式：BATCH+YYYYMMDD+序号）
*   入库时记录面料批次、幅宽、卷长等信息
*   库存流水记录入库操作

**预占规则**:
*   生成加工单时，系统自动预占面料库存
*   预占数量从 `available_quantity` 中扣除，增加到 `reserved_quantity`
*   预占时检查库存是否充足，不足则提示库存不足

**出库规则**:
*   加工厂领取面料时，确认出库
*   出库数量从 `reserved_quantity` 中扣除
*   库存流水记录出库操作

**盘点规则**:
*   支持定期盘点面料库存
*   盘点差异自动生成调整流水
*   盘点需店长审批

**库存预警**:
*   当面料库存低于安全库存时，自动预警
*   预警通知采购员和店长
*   支持设置每个面料的安全库存

### 4.5.6 面料库存界面设计

#### 面料库存列表页

**展示字段**:
| 字段 | 宽度 | 说明 |
|:---|:---|:---|
| 面料SKU | 100px | - |
| 面料名称 | 150px | - |
| 颜色/花色 | 80px | - |
| 幅宽 | 60px | 米 |
| 批次号 | 100px | - |
| 可用数量 | 80px | 米/卷 |
| 已预占 | 80px | 米/卷 |
| 总库存 | 80px | 米/卷 |
| 供应商 | 100px | - |
| 采购日期 | 100px | - |
| 仓库位置 | 80px | - |
| 操作 | 150px | - |

**筛选条件**:
| 筛选项 | 组件 | 说明 |
|:---|:---|:---|
| 面料SKU/名称 | `Input.Search` | 模糊搜索 |
| 供应商 | `Select` | - |
| 批次号 | `Input.Search` | - |
| 库存状态 | `Select` | 全部/库存充足/库存不足/已预占 |
| 采购日期 | `DateRangePicker` | - |

**操作按钮**:
| 按钮 | 说明 |
|:---|:---|
| **查看流水** | 查看该面料库存的流水记录 |
| **调整库存** | 手动调整库存（需审批） |
| **退库** | 加工剩余面料退回仓库 |

#### 面料库存流水页

**展示字段**:
| 字段 | 宽度 | 说明 |
|:---|:---|:---|
| 流水时间 | 130px | - |
| 流水类型 | 80px | 入库/出库/调整/退库 |
| 数量变化 | 80px | +100 / -50 |
| 变化前 | 80px | - |
| 变化后 | 80px | - |
| 关联单据 | 150px | 采购单号/加工单号 |
| 备注 | 200px | - |
| 操作人 | 80px | - |

**筛选条件**:
| 筛选项 | 组件 | 说明 |
|:---|:---|:---|
| 流水类型 | `Select` | 全部/入库/出库/调整/退库 |
| 时间范围 | `DateRangePicker` | - |
| 关联单据 | `Input.Search` | - |

### 4.5.7 批次优选规则 (Batch Selection Rules)

系统在生成加工单时,需要根据业务规则选择合适的面料批次。

#### 4.5.7.1 FIFO (先进先出)

**默认逻辑**:
*   **规则**: 按批次号的时间顺序,优先选择最早入库的批次
*   **排序**: 按 `purchase_date` ASC 排序
*   **适用场景**: 常规加工单,无特殊批次要求

**算法**:
```
1. 查询该面料SKU的所有批次,按 purchase_date ASC 排序
2. 从最早的批次开始,检查 available_quantity 是否足够
3. 如果足够,预占该批次
4. 如果不足,继续检查下一个批次,直到满足需求
5. 如果所有批次都不足,提示库存不足
```

**示例**:
```
SKU: CF-001 (米白色窗帘布)
需求: 150米

批次1: BATCH-20250101-001, 可用: 200米, 采购日期: 2025-01-01
批次2: BATCH-20250115-003, 可用: 150米, 采购日期: 2025-01-15

FIFO选择: 批次1 (200米), 预占150米, 剩余50米
```

#### 4.5.7.2 指定批次 (Specific Batch)

**业务场景**:
*   **补单场景**: 客户补单时,必须使用同一批次的面料,保证颜色一致
*   **色差控制**: 某些高端面料,不同批次色差明显,需要指定批次

**操作方式**:
*   在创建加工单时,允许人工指定 `batch_no`
*   系统验证指定批次的 `available_quantity` 是否足够
*   如果不足,提示库存不足,不允许自动切换批次

**示例**:
```
原订单: 使用批次 BATCH-20250101-001, 数量: 100米
补单需求: 20米

加工单创建时,指定 batch_no = "BATCH-20250101-001"
系统检查: 该批次可用数量 = 100米 (假设未被其他订单占用)
结果: 预占批次 BATCH-20250101-001, 数量: 20米
```

#### 4.5.7.3 批次选择策略配置

**配置项**:
| 配置项 | 说明 | 默认值 |
|:---|:---|:---|
| default_selection_mode | 默认批次选择模式 | FIFO |
| allow_manual_override | 是否允许人工指定批次 | true |
| batch_mixing_allowed | 是否允许跨批次混用 | false |

**批次混用规则**:
*   **默认**: 不允许跨批次混用 (batch_mixing_allowed = false)
*   **原因**: 不同批次面料存在色差,混用会导致成品颜色不一致
*   **例外**: 如果管理员明确允许,可以跨批次混用 (需特殊审批)

**混用示例**:
```
SKU: CF-001 (米白色窗帘布)
需求: 250米

批次1: BATCH-20250101-001, 可用: 200米
批次2: BATCH-20250115-003, 可用: 150米

不混用: 提示库存不足 (批次1只有200米)
混用: 预占批次1 200米 + 批次2 50米 = 250米
```

## 4.6 补货建议 (Replenishment Suggestions)

系统根据库存水位自动生成补货建议,帮助采购员及时补充面料库存。

### 4.6.1 补货触发条件

**触发点**:
*   **条件**: `available_quantity < safety_stock`
*   **含义**: 当可用库存低于安全库存时,触发补货建议
*   **检查频率**: 每日定时检查 (如: 每天早上 8:00)

**示例**:
```
SKU: CF-001 (米白色窗帘布)
安全库存 (safety_stock): 100米
最大库存水位 (max_stock): 500米

场景1: 可用库存 = 80米
触发: 80 < 100 ✓
动作: 生成补货建议

场景2: 可用库存 = 120米
触发: 120 < 100 ✗
动作: 不生成补货建议
```

### 4.6.2 补货数量计算

**计算公式**:
```
补货量 = 最大库存水位 - 当前可用库存
```

**示例**:
```
SKU: CF-001 (米白色窗帘布)
最大库存水位 (max_stock): 500米
当前可用库存: 80米

补货量 = 500 - 80 = 420米
```

**调整规则**:
*   **最小采购量**: 如果补货量小于供应商的最小起订量,自动调整为最小起订量
*   **采购单位**: 补货量自动转换为采购单位 (如: 卷)
*   **向上取整**: 如果转换为卷后有小数,向上取整

**示例**:
```
SKU: CF-001 (米白色窗帘布)
补货量: 420米
转换率: 1卷 = 50米

转换为卷: 420 ÷ 50 = 8.4卷
向上取整: 9卷
实际补货量: 9 × 50 = 450米
```

### 4.6.3 补货建议生成

**生成动作**:
*   **自动生成**: 系统自动生成 "待确认采购单" (Draft PO)
*   **推送通知**: 推送给采购员,通过微信服务号和系统内消息
*   **采购单状态**: `DRAFT` (待确认)

**采购单内容**:
| 字段 | 说明 |
|:---|:---|
| 采购单号 | 自动生成 (如: PO-20250115-001) |
| 供应商 | 使用默认供应商 |
| 采购商品 | 触发补货的面料SKU |
| 采购数量 | 计算后的补货量 |
| 采购单状态 | DRAFT (待确认) |
| 备注 | "系统自动生成的补货建议" |

**通知内容**:
```
【库存预警】面料 [CF-001 米白色窗帘布] 库存不足
当前可用: 80米, 安全库存: 100米
建议补货: 9卷 (450米)
请及时确认采购单: PO-20250115-001
```

### 4.6.4 采购员确认流程

**确认操作**:
1. 采购员收到补货建议通知
2. 进入采购单列表,查看 Draft 状态的采购单
3. 检查补货数量是否合理,可以手动调整
4. 确认采购单,状态变更为 `CONFIRMED`
5. 发送给供应商

**拒绝操作**:
*   如果采购员认为不需要补货,可以拒绝补货建议
*   拒绝后,采购单状态变更为 `CANCELLED`
*   系统记录拒绝原因

**调整操作**:
*   采购员可以手动调整补货数量
*   调整后,系统重新计算补货量
*   确认后,按调整后的数量生成采购单

### 4.6.5 补货建议配置

**配置项**:
| 配置项 | 说明 | 默认值 |
|:---|:---|:---|
| auto_replenishment_enabled | 是否启用自动补货 | true |
| check_frequency | 检查频率 (小时) | 24 |
| notification_channels | 通知渠道 | ["WECHAT_OFFICIAL", "SYSTEM"] |
| default_max_stock_multiplier | 最大库存水位倍数 | 5 |

**最大库存水位计算**:
*   **默认**: `max_stock = safety_stock × 5`
*   **自定义**: 管理员可以为每个面料单独设置 `max_stock`

**示例**:
```
SKU: CF-001 (米白色窗帘布)
安全库存: 100米
默认最大库存水位: 100 × 5 = 500米

管理员自定义: max_stock = 800米
实际最大库存水位: 800米
```

## 4.1 特定渠道定价 (Specific Pricing)

由于存在渠道管理模块（圣都、设计师等），简单的"一个渠道价"可能不够。有些大渠道（如圣都武汉大区）可能有特殊的协议价。

### 4.1.1 渠道专属价表 (channel_specific_prices)

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| id | UUID | 主键 |
| product_id | UUID | 关联商品 |
| channel_id | UUID | 关联特定渠道（如：圣都组） |
| special_price | Decimal | 该渠道的专属结算价（覆盖标准渠道结算价） |
| is_active | Boolean | 是否启用 |
| created_at | DateTime | 创建时间 |

### 4.1.2 价格查询逻辑

当销售在录入线索/订单时，系统自动识别客户来源：

1. **若是特定渠道客户**（如圣都客户）：
   * 优先查找 `channel_specific_prices` 表
   * 如果存在专属价，使用专属价
   * 如果不存在专属价，使用标准 `channel_price`（标准渠道结算价）

2. **若是设计师推荐**：
   * 使用标准 `channel_price`（标准渠道结算价）

3. **若是直接客户**：
   * 默认使用 `retail_price`（对客价）

### 4.1.3 渠道等级折扣应用

对于采用底价供货模式的渠道，最终结算价需要根据渠道等级应用折扣：

**最终结算价计算公式**：
```
最终结算价 = 标准渠道结算价 × 渠道等级折扣率
```

**折扣率配置**：
- 折扣率在租户级别配置，不同租户可设置不同的折扣策略
- 示例配置：
  * S级渠道：折扣率 0.95（95折）
  * A级渠道：折扣率 0.98（98折）
  * B级渠道：折扣率 1.00（无折扣）
  * C级渠道：折扣率 1.02（上浮2%）

### 4.1.4 价格计算函数

```typescript
function calculateProductPrice(productId: UUID, channelId?: UUID): Decimal {
  const product = getProduct(productId);
  const channel = channelId ? getChannel(channelId) : null;
  
  // 1. 如果传入了 channelId，优先查找渠道协议价
  if (channelId && channel) {
    // 1.1 优先查找专属价
    const specificPrice = getChannelSpecificPrice(productId, channelId);
    if (specificPrice) {
      return specificPrice.special_price;
    }
    
    // 1.2 如果没有专属价，使用标准渠道结算价
    let baseChannelPrice: Decimal;
    if (product.channel_price_mode === 'FIXED') {
      baseChannelPrice = product.channel_price;
    } else {
      baseChannelPrice = product.retail_price * product.channel_discount_rate;
    }
    
    // 1.3 应用渠道等级折扣（仅底价供货模式）
    if (channel.cooperation_mode === 'BASE_PRICE') {
      const discountRate = getChannelLevelDiscountRate(channel.level);
      return baseChannelPrice * discountRate;
    }
    
    return baseChannelPrice;
  }
  
  // 2. 否则使用零售价（对客价）
  return product.retail_price;
}

function getChannelLevelDiscountRate(level: string): Decimal {
  // 从租户级别配置获取渠道等级折扣率
  const config = getTenantConfig('channel_level_discounts');
  return config[level] || 1.0;
}
```

## 4.2 组合商品 (BOM/Bundle)

由于窗帘是组合品，系统支持"组合 SKU"。

### 4.2.1 组合商品表 (product_bundles)

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| id | UUID | 主键 |
| bundle_sku | String | 组合商品 SKU |
| bundle_name | String | 组合商品名称 |
| category | Enum | 品类 |
| retail_price | Decimal | 组合零售价（对客价，可手动设置或自动计算） |
| channel_price | Decimal | 组合渠道结算价（可手动设置或自动计算） |
| is_active | Boolean | 是否启用 |
| created_at | DateTime | 创建时间 |

### 4.2.2 组合商品明细表 (product_bundle_items)

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| id | UUID | 主键 |
| bundle_id | UUID | 关联组合商品 |
| product_id | UUID | 关联子商品 |
| quantity | Decimal | 子商品数量 |
| unit | String | 单位 |

### 4.2.3 组合商品定价策略

| 策略 | 说明 |
|:---|:---|
| **自动计算** | 系统自动汇总各子项的成本，得出该组合商品的真实成本，然后根据毛利率计算 ToB/ToC 总价 |
| **手动设置** | 管理员手动设置组合商品的零售价（对客价）和渠道结算价 |

**自动计算示例**：
* 子商品 A（面料）：成本 50 元，数量 5 米 → 小计 250 元
* 子商品 B（轨道）：成本 30 元，数量 3 米 → 小计 90 元
* 子商品 C（加工费）：成本 20 元，数量 1 项 → 小计 20 元
* 组合商品真实成本：250 + 90 + 20 = 360 元
* ToC 零售价（毛利率 50%）：360 / (1 - 0.5) = 720 元
* ToB 渠道结算价（毛利率 30%）：360 / (1 - 0.3) = 514 元

## 4.3 价格计算逻辑 (Pricing Logic)

### 4.3.1 利润自动实时计算

在商品管理后台，当用户输入对客价时，系统自动对比"真实成本"，实时显示：

* **ToC 毛利率**：`(对客价 - 真实成本) / 对客价 × 100%`
* **ToB 毛利率**：`(渠道结算价 - 真实成本) / 渠道结算价 × 100%`

这能确保在制定价格策略时，一眼看到是否亏本。

### 4.3.2 真实成本计算

```typescript
function calculateInternalCost(product: Product): Decimal {
  return product.purchase_price 
    + product.logistics_cost 
    + product.processing_cost * (1 + product.loss_rate);
}
```

### 4.3.3 渠道结算价计算

```typescript
function calculateChannelPrice(product: Product): Decimal {
  if (product.channel_price_mode === 'FIXED') {
    return product.channel_price;
  } else {
    return product.retail_price * product.channel_discount_rate;
  }
}
```

## 5. 界面设计 (UI Design)

### 5.1 供应商列表页

#### 展示字段
| 字段 | 宽度 | 说明 |
|:---|:---|:---|
| 供应商编号 | 130px | 可点击 |
| 供应商名称 | 150px | - |
| 联系人 | 100px | - |
| 电话 | 120px | - |
| 结算方式 | 80px | 月结/现结 |
| 状态 | 60px | 启用/停用 |
| 操作 | 150px | 编辑/停用 |

#### 操作按钮
| 按钮 | 说明 |
|:---|:---|
| **新建供应商** | 顶部主按钮 |
| **编辑** | 行操作 |
| **查看采购单** | 跳转该供应商的采购单列表 |
| **查看对账** | 跳转该供应商的对账单 |

### 5.2 商品列表页

#### 展示字段
| 字段 | 宽度 | 说明 |
|:---|:---|:---|
| SKU | 100px | - |
| 商品名称 | 200px | - |
| 图片 | 60px | 缩略图 |
| 品类 | 100px | 标签 |
| 真实成本 | 80px | 内部可见 |
| 对客价 | 80px | ToC 价格 |
| 渠道结算价 | 80px | ToB 价格 |
| ToC 毛利率 | 70px | (对客价-成本)/对客价 |
| ToB 毛利率 | 70px | (渠道结算价-成本)/渠道结算价 |
| ToB/ToC | 60px | 渠道/零售上架状态 |
| 默认供应商 | 100px | - |
| 操作 | 150px | 编辑/下架 |

#### 展示规则
* **毛利率颜色标注**：
  * 毛利率 < 20%：红色背景，提示"毛利过低"
  * 毛利率 20%-40%：橙色背景，提示"毛利一般"
  * 毛利率 > 40%：绿色背景，提示"毛利良好"
* **ToB/ToC 状态**：
  * 仅 ToB：显示"ToB"
  * 仅 ToC：显示"ToC"
  * 同时上架：显示"ToB+ToC"

#### 筛选条件
| 筛选项 | 组件 | 说明 |
|:---|:---|:---|
| 品类 | `Select` | 窗帘布料/墙布等 |
| 供应商 | `Select` | - |
| 上架状态 | `Select` | 全部/ToB/ToC/ToB+ToC |
| 毛利率区间 | `Select` | 全部/低毛利/一般/高毛利 |
| 名称/SKU | `Input.Search` | 模糊搜索 |

### 5.3 商品编辑页

#### 页面布局
```
┌─────────────────────────────────────────────────────┐
│ 商品编辑                             [保存] [取消]  │
├─────────────────────────────────────────────────────┤
│ 基础信息                                            │
│ SKU / 名称 / 品类 / 单位 / 默认供应商                │
├─────────────────────────────────────────────────────┤
│ 成本维度（内部可见）                                 │
│ 标准采购价 / 物流成本 / 加工成本 / 损耗系数           │
│ 真实成本（自动计算）                                 │
├─────────────────────────────────────────────────────┤
│ 销售维度                                            │
│ 零售价 / 渠道价 / 渠道价策略 / 渠道价折扣率 / 最低售价 │
│ ToB 上架 / ToC 上架                                  │
├─────────────────────────────────────────────────────┤
│ 利润分析（实时计算）                                 │
│ ToC 毛利率 / ToB 毛利率                              │
├─────────────────────────────────────────────────────┤
│ 商品图片 (支持多张)                                  │
├─────────────────────────────────────────────────────┤
│ 品类属性 (根据品类动态渲染)                          │
│ 幅宽 / 褶皱工艺 / 材质等                            │
├─────────────────────────────────────────────────────┤
│ 供应商与库存                                        │
│ 默认供应商 / 是否库存品 / 安全库存                   │
└─────────────────────────────────────────────────────┘
```

#### 成本维度表单
| 字段 | 组件 | 必填 | 说明 |
|:---|:---|:---|:---|
| 标准采购价 | `InputNumber` | ✓ | 与供应商约定的原始单价 |
| 物流成本 | `InputNumber` | - | 从工厂到仓库或加工厂的平摊运费 |
| 加工成本 | `InputNumber` | - | 每米或每扇窗帘的缝制、制作费用 |
| 损耗系数 | `InputNumber` | - | 默认 0.05 (5%) |
| 真实成本 | `Text` | - | 自动计算：purchase_price + logistics_cost + processing_cost × (1 + loss_rate) |

#### 销售维度表单
| 字段 | 组件 | 必填 | 说明 |
|:---|:---|:---|:---|
| 零售价 | `InputNumber` | ✓ | 面向 ToC 散客的标价 |
| 渠道价策略 | `RadioGroup` | ✓ | 固定单价 / 零售价打折 |
| 渠道价 | `InputNumber` | - | 固定单价时必填 |
| 渠道价折扣率 | `InputNumber` | - | 零售价打折时必填，如 0.6 表示 6 折 |
| 最低售价 | `InputNumber` | ✓ | 给销售人员的权限底线 |
| ToB 上架 | `Switch` | - | 是否在 ToB 渠道上架 |
| ToC 上架 | `Switch` | - | 是否在 ToC 零售上架 |

#### 利润分析区
| 字段 | 说明 |
|:---|:---|
| ToC 毛利率 | (零售价 - 真实成本) / 零售价 × 100% |
| ToB 毛利率 | (渠道价 - 真实成本) / 渠道价 × 100% |

**实时计算规则**：
* 当用户修改零售价或渠道价时，自动重新计算毛利率
* 毛利率 < 20%：红色背景，提示"毛利过低"
* 毛利率 20%-40%：橙色背景，提示"毛利一般"
* 毛利率 > 40%：绿色背景，提示"毛利良好"

#### 动态属性区
使用 `Form.List` 组件，根据选择的品类动态渲染对应的属性字段。

### 5.4 属性模板配置页 (管理员)

| 功能 | 说明 |
|:---|:---|
| 选择品类 | 下拉选择要配置的品类 |
| 字段列表 | 显示该品类的所有属性字段 |
| 新增字段 | 定义字段名、类型、是否必填 |
| 编辑字段 | 修改字段属性、校验规则 |
| 排序字段 | 拖拽调整显示顺序 |
| 关联公式 | 将字段绑定到报价公式 |

## 6. 权限控制 (Permission Matrix)

### 6.1 页面级权限

| 页面 | 销售 | 采购员 | 管理员 | 店长 |
|:---|:---|:---|:---|:---|
| 供应商列表 | ✗ | ✓ | ✓ | ✓ |
| 商品列表 | ✓ (仅查看) | ✓ | ✓ | ✓ |
| 商品编辑 | ✗ | ✓ | ✓ | ✓ |
| 成本维度查看 | ✗ | ✓ | ✓ | ✓ |
| 成本维度编辑 | ✗ | ✗ | ✓ | ✓ |
| 销售维度编辑 | ✗ | ✓ | ✓ | ✓ |
| 特定渠道定价 | ✗ | ✓ | ✓ | ✓ |
| 组合商品管理 | ✗ | ✓ | ✓ | ✓ |
| 属性模板配置 | ✗ | ✗ | ✓ | ✗ |
| 库存管理 | ✗ | ✓ | ✓ | ✓ |

### 6.2 按钮级权限

| 操作 | 采购员 | 管理员 | 店长 |
|:---|:---|:---|:---|
| 新建供应商 | ✓ | ✓ | ✓ |
| 编辑供应商 | ✓ | ✓ | ✓ |
| 停用供应商 | ✗ | ✓ | ✓ |
| 新建商品 | ✓ | ✓ | ✓ |
| 编辑商品 | ✓ | ✓ | ✓ |
| 下架商品 | ✗ | ✓ | ✓ |
| 修改成本价 | ✗ | ✓ | ✓ |
| 修改零售价 | ✓ | ✓ | ✓ |
| 修改渠道价 | ✓ | ✓ | ✓ |
| 配置特定渠道价 | ✓ | ✓ | ✓ |
| 创建组合商品 | ✓ | ✓ | ✓ |
| 配置属性模板 | ✗ | ✓ | ✗ |

### 6.3 数据范围权限

| 角色 | 可见范围 |
|:---|:---|
| 采购员 | 全部供应商和商品，可查看成本维度 |
| 管理员 | 全部（成本维度查看权限需在权限矩阵表中单独配置） |
| 店长 | 本店关联的供应商和商品（成本维度查看权限需在权限矩阵表中单独配置） |
| 销售 | 仅查看商品的销售维度（零售价、渠道价），不可查看成本维度 |

**成本维度权限说明**：
* 成本维度（标准采购价、物流成本、加工成本、损耗系数、真实成本）默认仅采购员可查看。
* 管理员和店长是否可以查看成本维度，需在系统权限矩阵表中单独配置。
* 成本维度的编辑权限仅管理员拥有。

## 7. 通知与提醒 (Notifications)

| 触发事件 | 通知对象 | 渠道 | 内容 |
|:---|:---|:---|:---|
| 商品下架 | 采购员 | 系统 | 商品 XXX 已下架 |
| 库存不足 | 采购员+店长 | 系统 | 商品 XXX 库存不足 |
| 供应商停用 | 采购员 | 系统 | 供应商 XXX 已停用 |

## 8. 与其他模块的关联 (Module Relations)

| 模块 | 关联方式 | 数据流向 |
|:---|:---|:---|
| **报价单** | QuoteItem.product_id → Product.id | 商品 → 报价 |
| **订单** | OrderItem.product_id → Product.id | 商品 → 订单 |
| **采购单** | PO.supplier_id → Supplier.id | 供应商 → 采购 |
| **对账单** | AP.supplier_id → Supplier.id | 供应商 → 对账 |
| **渠道** | ChannelSpecificPrice.channel_id → Channel.id | 渠道 → 特定渠道定价 |
| **渠道** | ChannelSpecificPrice.product_id → Product.id | 商品 → 特定渠道定价 |
| **组合商品** | ProductBundleItem.bundle_id → ProductBundle.id | 组合商品 → 明细 |
| **组合商品** | ProductBundleItem.product_id → Product.id | 商品 → 组合商品 |

### 8.1 价格计算流程

```
销售录入线索/订单
    ↓
识别客户来源（渠道/设计师/直接客户）
    ↓
查询价格：
    ├─ 特定渠道客户 → 查找 channel_specific_prices → 使用专属价
    ├─ 渠道客户（底价供货模式） → 使用 channel_price（标准渠道结算价）× 渠道等级折扣率
    ├─ 渠道客户（返佣模式） → 使用 channel_price（标准渠道结算价）
    └─ 直接客户 → 使用 retail_price（对客价）
    ↓
计算毛利率（后台管理可见）
    ├─ ToC 毛利率 = (零售价 - 真实成本) / 零售价
    └─ ToB 毛利率 = (渠道结算价 - 真实成本) / 渠道结算价
```

### 8.2 成本计算流程

```
商品基础数据
    ├─ purchase_price（标准采购价）
    ├─ logistics_cost（物流成本）
    ├─ processing_cost（加工成本）
    └─ loss_rate（损耗系数）
    ↓
计算真实成本：
    internal_cost = purchase_price + logistics_cost + processing_cost × (1 + loss_rate)
    ↓
用于毛利率计算和利润分析
```

### 8.3 组合商品计算流程

```
组合商品（如窗帘套装）
    ↓
汇总子商品成本：
    ├─ 子商品 A 成本 × 数量
    ├─ 子商品 B 成本 × 数量
    └─ 子商品 C 成本 × 数量
    ↓
计算组合商品真实成本
    ↓
根据毛利率计算 ToB/ToC 总价
    ├─ ToC 零售价 = 真实成本 / (1 - ToC 毛利率)
    └─ ToB 渠道价 = 真实成本 / (1 - ToB 毛利率)
```
