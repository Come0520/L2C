# 定价参考模块需求文档

## 1. 业务目标
“定价参考” (Pricing Hints) 模块旨在为销售人员在新建或编辑报价单时提供有力的数据辅助和决策基准。通过全面聚合分析该产品的多维历史核心指标，进一步保障所填写报价兼具竞争力且能保住公司利润底线。

### 1.1 产品定价策略指引
在企业级交易中，报价并非一成不变，而是根据客户层级、采购规模和市场竞争环境动态调整。本系统依托于以下核心策略进行辅助：
- **底线防御策略**：无论任何情况下（特批除外），系统的“底限零售价 / Floor Price”均为不可轻易穿透的红线，防范销售人员为冲单导致业务实质性亏损。
- **利润导向策略**：基于历史平均长尾单，计算出合理区间的毛利（Guidance Margin），指导销售向平均健康水位靠拢。
- **市场对标策略**：通过近半年趋势走向与同品类大盘横向比对，帮助销售识别该单品目前是处于“价格战阶段”还是“高溢价期”。

## 2. 核心算法逻辑与指标详述

该模块根据前台传入的 `productId` 或 `sku` 对以下核心分析维度进行聚合计算：

### 2.1 历史售价水位与推荐指导 (Historical Sales & Suggestions)
- **回溯周期控制**：算法默认回溯 N 天（受入参 `periodDays` 控制，默认 90 天）。
- **聚合范围提取**：从 `orderItems` 订单行中，结合 `orders` 表，抽出属于当前租户（`t.tenantId = session.tenantId`）且状态为有效（`status NOT IN ('CANCELLED', 'DRAFT')`）的所有订单项记录。
- **核心算子**：
  - `minPrice / maxPrice`: 历史周期内该 sku 实际最低与最高成交单价（转为 DECIMAL 精度防止失真）。
  - `avgPrice`: 历史平均实单单价。
  - `lastPrice`: 获取依时间戳倒排的最新一笔成单价格，反映最直观的当下行情。
- **推荐指导价算法 (Suggested Price Engine)**：
  - 若 `avgPrice > 0` (存在有效历史单)，则优先采用 `avgPrice` 作为“建议成交价”。
  - 极端兜底（无历史出单）：若该商品尚无任何历史成单记录（全新上架），算法降级获取主档 `products` 表中的 `retailPrice`（指导销售价）挂回前端展示。
- **报价热度探测 (Quote Heatmap)**：同时统计关联 `quoteItems`，计算近期平均报价（`avgQuotePrice`）与报价笔数，感知潜在销售热度。

### 2.2 半年份价格趋势走势 (6-Month Trend Curve)
- **定义算法**: 将过往最近完整 6 个月时间段内产生的有效成单记录，利用 SQL 原生函数按月进行时间分片组装（`TO_CHAR(createdAt, 'YYYY-MM')` 分组）。
- **应用场景**: 最终映射为前端 Echarts 条形或折线图。提供产品生命周期不同阶段产生的季节性市场议价抛空或跳涨波形供参考。

### 2.3 多口径毛利润率 (Margin Analysis)
核心算法逻辑依托于基础商业公式： 
$$ \text{Margin} = \frac{\text{Price} - \text{Cost}}{\text{Price}} \times 100\% $$

模块输出三重关键预判指标，供业务决策层多维比对：
- **`guidance` (系统指导销售利润)**: 衡量标准理想状态。算法：`((retailPrice - cost) / retailPrice) * 100`。
- **`actual` (历史实销毛利)**: 基于大盘真实历史长尾均价。算法：`((avgSoldPrice - cost) / avgSoldPrice) * 100`。
- **`estimated` (当期预估销售毛利)**: 假设按本次系统推荐价达成交易所能套取的保底。算法：`((suggestedPrice - cost) / suggestedPrice) * 100`。
- **报警触发**: 前端交互层，一旦解析到接收到的利润空间（主要看 estimated 和 actual）低于设定警戒水位（如 <20%），会借由 UI 进行红色强视觉警示。

### 2.4 同品类横向参考 (Category Compare)
- **定位依据**: 算法解析本产品表的 `category` 字段取得品类元数据。
- **大盘捞取**: 找出该租户（`tenantId`）下所有同归属品类且当前状态为活跃（`isActive = true`）的产品群 `Products[]`。
- **计算逻辑**:
  - `minRetailPrice` / `avgRetailPrice` / `maxRetailPrice`
  - 提取群落的系统“零售指导价”（`retailPrice`）后综合打出“底限”、“平均水位”、“峰值天花板”三重护城河指引。
  - **核心目的**：旨在告诉报价人员，当前所选的这款商品在品牌序列中是处于入门低端打版、主力中端实惠，还是高端轻奢定位，从而间接指导砍价下限尺度。

## 3. 业务权限与租户隔离安全屏障
基于 L2C SaaS 多租户底座原则，本模块具备以下强制边界：
- **水平细粒度鉴权**：在核心读取层最外围调用 `checkPermission(session, 'quotes:create')`，严格限制仅拥有新建销售单或编辑销售单操作权限的账户方可调用此商业参谋接口。
- **租户绝对沙箱隔离**：所有的多维数据拼装层（包括 `orders`, `products`, `quotes` 的宽表联查捞取聚合计算），必须无一例外全链路强制附加 `eq(table.tenantId, tenantId)` 物理隔离屏障，严防商业核心数据跨租户越权泄露。

## 4. 性能优化、缓存策略与异常吞吐机制
- **微位面缓存命中 (React Cache)**：
  该海量聚合提取操作包裹在 `require('react').cache` 中。确保在 React Server Component 单一渲染上下文/一次请求链路周期内，针对同一传入的 `(productId, sku)`，多组件若发起了 N 次重复级拉取，框架只在此次栈内执行唯一一次 DB 穿透查询。大幅消减由组件深度嵌套造成的关联开销。
- **鲁棒异常捕获**:
  针对多维并发 DB 连接查询产生的不可抗拒断层（如连接池突爆、PG 集群抖动等），使用 `try...catch` 进行闭环包裹。通过全链路日志埋点 `logger.error` 回传包含 `(productId, sku, error_stack)` 的详细快照供后台基建回溯，而前置端仅仅静默吞没并返回 `{ success: false, error: "..." }` 防止数据库敏感架构泄露。
