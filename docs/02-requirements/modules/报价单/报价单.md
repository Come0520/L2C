# L2C SaaS 核心模块需求文档：智能报价与订单闭环系统 (V9.0 全量详尽版)

## 1. 模块概述
本模块负责 L2C（从线索到现金）全链路中的方案设计与成交转化。系统需具备多租户模式选择、高度自动化的多品类报价录入、精细的窗帘计算引擎、版本管理及“苹果风”方案对比功能。

## 2. 租户级业务模式 (Tenant Workflow Patterns)
租户可根据业务复杂度，在后台预设并选择工作流模式：

具体业务模式后期预设更多工作流供客户选择

## 2.1 报价单模式配置 (Quote Mode Configuration)

### 2.1.1 模式定义
系统支持两种报价模式，租户可根据客户类型灵活选择：

* **快速报价模式（默认）：**
  * 目标：追求快速报价，减少录入步骤
  * 适用场景：初次沟通、快速预算、简单户型、价格敏感型客户
  * 特点：仅展示核心必填字段，隐藏非关键专业信息
  * 默认字段：字段1（空间）、字段2（商品型号）、字段3（商品图片）、字段8（测量宽度）、字段9（测量高度）、字段10（拉动形式）、字段14（数量）、字段15（单价）、字段17（金额）

* **高级报价模式：**
  * 目标：提供完整的专业报价方案
  * 适用场景：正式报价、复杂户型、设计师合作、高端客户
  * 特点：展示所有字段，包含完整的专业参数和计算细节
  * 切换方式：点击"高级报价"按钮展开所有字段

### 2.1.2 客户级模式切换
* 同一租户下的不同客户可设置不同的报价模式
* 在客户档案中配置默认报价模式（快速/高级）
* 报价单创建时默认使用简单模式，自动应用客户默认模式
* 支持在报价单页面手动切换模式
* 模式切换时保留已录入数据，仅动态显示/隐藏非必填字段

### 2.1.3 租户级字段配置（系统设置）

**配置入口：**
* 系统设置 > 报价设置 > 快速报价字段配置
* **权限要求**：仅租户管理员可配置

**配置界面：**
* 字段清单：列出所有报价字段（字段1-20）
* 字段分组：按"用户输入组"、"商品信息组"、"尺寸与安装要求组"、"金额与计算组"分组展示
* 勾选操作：通过勾选框选择在简单模式下显示的字段
* 实时预览：勾选/取消勾选时，右侧实时预览简单模式表单效果
* 重置功能：提供"重置为系统默认"按钮，恢复到系统推荐的9个默认字段
* 保存功能：配置后需点击"保存"按钮生效

**配置优先级：**
* 租户级配置优先于系统默认配置
* 如果租户未配置，则使用系统默认配置

**配置存储：**
* 租户配置存储在 `tenants.settings.quoteModeConfig` JSONB 字段中
* 系统默认配置硬编码在代码中

**配置说明：**
* 租户管理员可以根据业务需求，自定义快速报价模式下显示的字段
* 配置后，该租户下的所有用户都使用相同的快速报价字段配置
* 用户无法进行个人设置，确保整个租户的报价标准统一

### 2.1.4 系统默认简单模式字段定义

**系统默认字段列表（推荐配置）：**
* ✅ **字段1：空间** - 下拉选择已有空间或手动输入新空间
* ✅ **字段2：商品型号** - 智能联想，输入即检索商品库
* ✅ **字段3：商品图片** - 引用商品库"细节图1"
* ✅ **字段8：测量宽度** - 数字，单位厘米
* ✅ **字段9：测量高度** - 数字，单位厘米
* ✅ **字段10：拉动形式** - 下拉选择：对开(默认)、单开（左）、单开（右）、多开
* ✅ **字段14：数量** - 由计算引擎自动生成的面料米数
* ✅ **字段15：单价** - 自动引用型号单价
* ✅ **字段17：金额** - 数量 × 单价，会计格式展示

**高级模式才显示的字段：**
* 🔒 **字段4：幅宽** - 引用商品库数据
* 🔒 **字段5：材质** - 自动引用
* 🔒 **字段6：克重** - 自动引用（单位：g/㎡）
* 🔒 **字段7：花距** - 自动引用
* 🔒 **字段11：安装位置** - 下拉选择：窗帘盒(默认)、口内、口外
* 🔒 **字段12：离地高度** - 数字输入，默认2cm
* 🔒 **字段13：褶皱倍数** - 步进器控制（1.5-3.5），步长0.1，默认2
* 🔒 **字段16：折扣** - 隐藏字段
* 🔒 **字段18：附件录入** - 嵌套子行（本布绑带、抱枕、成品绑带等）
* 🔒 **字段19：行内小计** - 主行金额 + 所有嵌套附件行金额
* 🔒 **字段20：备注** - 多行文本输入框，用于记录文字性内容（如特殊要求、注意事项等）

### 2.1.5 字段默认值规则
* 快速模式下，隐藏字段使用系统默认值：
  * 安装位置：默认"窗帘盒"
  * 离地高度：默认2cm
  * 褶皱倍数：默认2.0
  * 折扣：默认无折扣
* 高级模式下，用户可手动调整这些参数

### 2.1.5 UI 交互规范
* **模式切换按钮**：在报价单表单右上角提供"高级报价"按钮
* **默认状态**：报价单打开时默认为简单模式
* **切换效果**：点击"高级报价"按钮后，所有隐藏字段平滑展开
* **按钮状态**：
  - 简单模式：按钮显示"高级报价 ▼"
  - 高级模式：按钮显示"收起 ▲"
* **字段提示**：简单模式下，隐藏的字段在鼠标悬停时显示提示"点击高级报价查看"
* **数据保留**：切换模式时，已录入的数据完整保留

### 2.1.6 配置存储
配置采用三级优先级机制：用户级 > 租户级 > 系统默认

**用户级配置存储：**
* 存储位置：`users.settings.quoteModeConfig` JSONB 字段
* 数据结构示例：
```json
{
  "simpleModeFields": [
    "roomType",
    "productSku",
    "imageUrl",
    "width",
    "height",
    "openingStyle",
    "quantity",
    "unitPrice",
    "amount",
    "foldRatio",
    "installPosition"
  ],
  "customized": true,
  "updatedAt": "2026-01-09T10:30:00Z"
}
```

**租户级配置存储：**
* 存储位置：`tenants.settings.quoteModeConfig` JSONB 字段
* 数据结构示例：
```json
{
  "defaultMode": "SIMPLE",
  "simpleModeFields": [
    "roomType",
    "productSku",
    "imageUrl",
    "width",
    "height",
    "openingStyle",
    "quantity",
    "unitPrice",
    "amount"
  ],
  "defaultValues": {
    "installPosition": "CURTAIN_BOX",
    "groundClearance": 2,
    "foldRatio": 2.0
  }
}
```

**系统默认配置：**
* 硬编码在代码中，作为兜底方案
* 包含推荐的9个核心字段

**配置加载逻辑：**
```typescript
function loadQuoteModeConfig(userId: string, tenantId: string) {
  // 1. 优先加载用户级配置
  const userConfig = await db.query.users.findFirst({
    where: eq(users.id, userId),
    columns: { settings: true }
  });
  
  if (userConfig?.settings?.quoteModeConfig?.customized) {
    return userConfig.settings.quoteModeConfig;
  }
  
  // 2. 其次加载租户级配置
  const tenantConfig = await db.query.tenants.findFirst({
    where: eq(tenants.id, tenantId),
    columns: { settings: true }
  });
  
  if (tenantConfig?.settings?.quoteModeConfig) {
    return tenantConfig.settings.quoteModeConfig;
  }
  
  // 3. 最后使用系统默认配置
  return SYSTEM_DEFAULT_QUOTE_CONFIG;
}
```

## 3. 报价单页面架构 (Page Architecture)
采用 “总表 + 多品类分表 (Tabs)” 的 Master-Detail 结构。

### 3.1 Tab 0：报价总表 (Master Summary)
* **客户信息（只读）：** 仅展示姓名、电话、项目地址。
* **安全规则：** 严禁展示客户来源、介绍人、设计师、佣金等 CRM 敏感隐私字段。
* **汇总信息：** 自动聚合各品类分表（窗帘、墙布等）的小计金额。展示总金额、优惠、定金金额。

### 3.2 Tab 1-N：品类分表 (Category Tabs)
* **包含品类：** 窗帘、墙布&墙纸、墙咔、飘窗垫、标品等。
* **录入偏好设置：** 支持“先品类后空间（默认）”和“先空间后品类”两种录入路径。

## 4. 窗帘品类报价表：详细字段定义 (Field Definitions)

### 4.1 用户输入组 (Basic Entry)
* **字段 1：空间 (Space)：** 下拉选择已有空间或手动输入新空间。
* **字段 2：商品型号 (Product Model)：** 智能联想 (Autocomplete)。输入即检索商品库，选中后自动填充字段 3-7 及 15。

### 4.2 商品信息组 (Product Specs)
* **基础信息 (始终可见)：**
  * **字段 3：商品图片：** 引用商品库“细节图 1”。
  * **字段 4：幅宽 (Width)：** 引用商品库数据。
* **专业信息 (默认折叠，点击展开)：**
  * **字段 5：材质 (Material)：** 自动引用。
  * **字段 6：克重 (Weight)：** 自动引用（单位：`g/㎡`）。
  * **字段 7：花距 (Pattern Repeat)：** 自动引用。

### 4.3 尺寸与安装要求组 (Dimensions & Install)
* **字段 8：测量宽度 (Width)：** 数字，单位厘米(`cm`)。
* **字段 9：测量高度 (Height)：** 数字，单位厘米(`cm`)。
* **字段 10：拉动形式：**
  * 下拉选择：对开(默认)、单开（左）、单开（右）、多开。
  * 多开逻辑：若选择“多开”，需提供动态输入框，按从左到右顺序填写每一段的尺寸（数组存储）。
* **字段 11：安装位置：** 下拉选择：窗帘盒(默认)、口内、口外。
* **字段 12：离地高度：** 数字输入，默认 `2cm`。

### 4.4 金额与计算组 (Price & Calculation)
* **字段 13：褶皱倍数 (Fullness)：** 步进器控制（`1.5-3.5`），步长 `0.1`，默认 `2`。
* **字段 14：数量 (Quantity)：** 由计算引擎自动生成的面料米数。
* **字段 15：单价 (Unit Price)：** 自动引用型号单价。
* **字段 16：折扣 (Discount)：** 隐藏字段。
* **字段 17：金额 (Amount)：** `$数量 \times 单价$`，会计格式展示。

### 4.5 备注信息组 (Remarks)
* **字段 20：备注 (Remarks)：** 多行文本输入框，用于记录文字性内容（如特殊要求、注意事项、客户偏好等）。仅在高级模式下显示。

## 5. 嵌套附件逻辑 (Nested Attachment Logic)
当主行商品为“窗帘布”或“窗帘纱”时，支持在主行下方展开嵌套子行。

### 5.1 字段 18：附件录入 (Attachments)
* **交互：** 点击主行“+ 附件”按钮，在下方插入子行。
* **类型与联动规则：**
  * **本布绑带：** 面料数量固定为 `$0.15m$`（可调参数）。推荐数量逻辑：单开 `1` 个，对开 `2` 个。
  * **抱枕：** 单价自动锁定主行面料价格。尺寸自由定义（默认 `$45 \times 45$`）。支持多行。
  * **成品绑带/花边/自定义：** 手动录入数量与单价。

### 5.2 字段 19：行内小计 (Subtotal)
`$主行金额 + 所有嵌套附件行金额$`

## 6. 墙纸/墙布品类报价表：详细字段定义 (Wallpaper & Wallcloth Field Definitions)

### 6.1 品类区分与计算逻辑

系统需要明确区分**墙纸（Wallpaper）**和**墙布（Wallcloth）**两种不同的品类，它们在计算维度和销售单位上有本质区别。

#### 6.1.1 墙纸（Wallpaper）—— 定宽、计卷
墙纸通常是小卷包装，逻辑核心是**"裁剪损耗"**。

**基本属性：**
* 销售单位：卷
* 默认规格：0.53m (宽) × 10m (长) —— 根据具体商品的幅宽定（0.7m，1.1m等不等）

**计算步骤：**
1. **计算条数 (Strips)**: 墙面宽度 ÷ 墙纸宽度 = 需要的条数（结果向上取整）
2. **每卷可裁条数 (Strips per Roll)**: 一卷总长度 ÷ (墙面高度 + 裁剪损耗高度) = 每卷条数（结果向下取整）
   - 注：裁剪损耗通常为 10cm，若有花距对花要求，损耗更大
3. **计算卷数 (Total Rolls)**: 总条数 ÷ 每卷可裁条数 = 总卷数（结果向上取整）

**计算公式：**
$$\text{总价} = \text{总卷数} \times \text{单卷价格}$$

#### 6.1.2 墙布（Wallcloth）—— 定高、计平米
墙布通常是无缝铺贴，逻辑核心是**"高度适配"**。

**基本属性：**
* 销售单位：平方米 ($m^2$)
* 默认规格：幅宽（定高）通常为 2.8m - 3.2m

**计算逻辑：**
* **前提条件**: 如果墙面实际高度 < 墙布幅宽，则整面墙可以无缝铺贴
* **计算面积**: 墙面宽度 (米) × 墙布幅宽 (定高值) = 消耗面积

**计算公式：**
$$\text{总价} = (\text{墙面宽度} \times \text{墙布幅宽}) \times \text{每平米单价}$$

**特别注意**: 虽然墙布是按平米卖，但实际施工中是按"延长米"裁切的。系统需要确保"数量"字段自动带入这个面积。

### 6.2 墙纸/墙布模式配置
墙纸和墙布品类同样支持快速报价模式和高级报价模式，用户可在个人设置中自定义快速报价字段。

**配置入口：**
* 个人中心 > 设置 > 墙纸/墙布快速报价字段配置

**配置界面：**
* 字段清单：列出所有墙纸/墙布报价字段（字段1-5、7-9、14-20）
* 字段分组：按"用户输入组"、"商品信息组"、"尺寸与安装要求组"、"金额与计算组"、"备注信息组"分组展示
* 勾选操作：通过勾选框选择在简单模式下显示的字段
* 实时预览：勾选/取消勾选时，右侧实时预览简单模式表单效果
* 重置功能：提供"重置为系统默认"按钮，恢复到系统推荐的默认字段

### 6.3 系统默认墙纸/墙布简单模式字段定义

**系统默认字段列表（推荐配置）：**
* ✅ **字段1：空间** - 下拉选择已有空间或手动输入新空间
* ✅ **字段2：商品型号** - 智能联想，输入即检索商品库
* ✅ **字段3：商品图片** - 引用商品库"细节图1"
* ✅ **字段8：测量宽度** - 数字，单位厘米
* ✅ **字段9：测量高度** - 数字，单位厘米
* ✅ **字段14：数量** - 由计算引擎自动生成的数量（墙纸：卷数，墙布：平方米）
* ✅ **字段15：单价** - 自动引用型号单价
* ✅ **字段17：金额** - 数量 × 单价，会计格式展示

**高级模式才显示的字段：**
* 🔒 **字段4：幅宽** - 引用商品库数据
* 🔒 **字段5：材质** - 自动引用
* 🔒 **字段7：花距** - 自动引用
* 🔒 **字段16：折扣** - 隐藏字段
* 🔒 **字段18：附件录入** - 嵌套子行（胶水、基膜、自定义等）
* 🔒 **字段19：行内小计** - 主行金额 + 所有嵌套附件行金额
* 🔒 **字段20：备注** - 多行文本输入框，用于记录文字性内容

### 6.4 用户输入组 (Basic Entry)
* **字段 1：空间 (Space)：** 下拉选择已有空间或手动输入新空间。
* **字段 2：商品型号 (Product Model)：** 智能联想。输入即检索商品库，选中后自动填充字段 3-5 及 15。

### 6.5 商品信息组 (Product Specs)
* **基础信息 (始终可见)：**
  * **字段 3：商品图片：** 引用商品库"细节图 1"。
  * **字段 4：幅宽 (Width)：** 引用商品库数据。
* **专业信息 (默认折叠，点击展开)：**
  * **字段 5：材质 (Material)：** 自动引用。
  * **字段 7：花距 (Pattern Repeat)：** 自动引用。

### 6.6 尺寸与安装要求组 (Dimensions & Install)
* **字段 8：测量宽度 (Width)：** 数字，单位厘米(`cm`)。
* **字段 9：测量高度 (Height)：** 数字，单位厘米(`cm`)。

### 6.7 金额与计算组 (Price & Calculation)
* **字段 14：数量 (Quantity)：** 由计算引擎自动生成的数量。
  - 墙纸：卷数（向上取整）
  - 墙布：面积（平方米）
* **字段 15：单价 (Unit Price)：** 自动引用型号单价。
* **字段 16：折扣 (Discount)：** 隐藏字段。
* **字段 17：金额 (Amount)：** `$数量 \times 单价$`，会计格式展示。

### 6.8 备注信息组 (Remarks)
* **字段 20：备注 (Remarks)：** 多行文本输入框，用于记录文字性内容（如特殊要求、注意事项、客户偏好等）。仅在高级模式下显示。

## 7. 商品基础信息录入方案 (Product Information Entry)

### 7.1 品类分类与核心差异

系统需要明确区分**墙纸（Wallpaper）**和**墙布（Wallcloth）**两种不同的品类，它们在商品属性和销售单位上有本质区别。

#### 7.1.1 墙纸（Wallpaper）—— 定宽、计卷
**核心特征：**
* 销售单位：卷 (Roll)
* 规格定义：幅宽（定宽）× 卷长
* 计算维度：基于条数和卷数

**关键属性：**
* **幅宽（定宽值）**：0.53m、0.7m、1.1m等
* **卷长**：10m、15m、20m等
* **花距**：0cm（无花距）、32cm、64cm等
* **材质**：纯纸、PVC、无纺布等
* **对花方式**：直拼、错位拼等

#### 7.1.2 墙布（Wallcloth）—— 定高、计平米
**核心特征：**
* 销售单位：平方米 ($m^2$)
* 规格定义：幅宽（定高）
* 计算维度：基于面积

**关键属性：**
* **幅宽（定高值）**：2.8m、3.0m、3.2m等
* **材质**：刺绣、提花、植绒等
* **工艺**：印花、压花、烫金等

### 7.2 商品基础信息录入表单设计

#### 7.2.1 分步录入流程

**第一步：基础信息（所有品类通用）**
* **SKU**：文本输入，唯一标识
* **商品名称**：文本输入，必填
* **品类**：下拉选择（墙纸、墙布、窗帘面料等）
* **单位**：根据品类自动填充（墙纸：卷，墙布：平方米）
* **基准单价**：数字输入，必填
* **成本价**：数字输入，可选
* **默认供应商**：下拉选择
* **是否库存管理**：开关切换
* **库存数量**：数字输入（仅在启用库存管理时显示）
* **安全库存**：数字输入（仅在启用库存管理时显示）
* **商品图片**：图片上传，支持多图

**第二步：品类专属属性（根据品类动态显示）**

**墙纸专属字段：**
* **幅宽（定宽值）**：下拉选择（0.53m、0.7m、1.1m等），必填
* **卷长**：下拉选择（10m、15m、20m等），必填
* **花距**：数字输入，单位cm（0表示无花距），必填
* **材质**：下拉选择（纯纸、PVC、无纺布等），必填
* **对花方式**：下拉选择（直拼、错位拼等），必填

**墙布专属字段：**
* **幅宽（定高值）**：下拉选择（2.8m、3.0m、3.2m等），必填
* **材质**：下拉选择（刺绣、提花、植绒等），必填
* **工艺**：下拉选择（印花、压花、烫金等），必填

**第三步：其他属性（所有品类通用）**
* **商品描述**：多行文本输入
* **备注**：多行文本输入
* **标签**：多选标签（如：热销、新品、推荐等）

#### 7.2.2 UI 设计要点

**动态表单：**
* 根据品类选择自动显示/隐藏相应字段
* 墙纸和墙布的字段互斥，不同时显示
* 使用卡片式布局，每个步骤一个卡片

**智能提示：**
* 幅宽、卷长等字段提供常用选项下拉选择
* 支持手动输入自定义值
* 提供字段说明和示例

**实时预览：**
* 在录入过程中实时显示商品预览卡片
* 预览卡片展示商品图片、名称、规格、价格等关键信息

### 7.3 数据库存储结构

#### 7.3.1 利用现有 `products` 表

现有 `products` 表已经包含基础字段：

```typescript
{
    id: uuid,
    tenantId: uuid,
    sku: string,
    name: string,
    category: 'WALLPAPER' | 'WALLCLOTH' | 'CURTAIN_FABRIC' | ...,
    unit: string, // 墙纸：卷，墙布：平方米
    basePrice: decimal,
    costPrice: decimal,
    defaultSupplierId: uuid,
    isStockable: boolean,
    stockQuantity: decimal,
    safetyStock: decimal,
    images: jsonb, // 商品图片数组
    attributes: jsonb, // 品类专属属性
    isActive: boolean,
    createdAt: timestamp,
    updatedAt: timestamp,
    deletedAt: timestamp
}
```

#### 7.3.2 `attributes` 字段结构

**墙纸（Wallpaper）的 attributes 结构：**
```json
{
    "fabricWidth": 53,           // 幅宽（定宽值），单位：cm
    "rollLength": 1000,          // 卷长，单位：cm
    "patternRepeat": 32,         // 花距，单位：cm（0表示无花距）
    "material": "PVC",           // 材质
    "patternMatch": "STRAIGHT",  // 对花方式：STRAIGHT（直拼）、OFFSET（错位拼）
    "description": "进口PVC墙纸，防水防潮",
    "tags": ["热销", "新品"]
}
```

**墙布（Wallcloth）的 attributes 结构：**
```json
{
    "fabricWidth": 280,          // 幅宽（定高值），单位：cm
    "material": "刺绣",          // 材质
    "craft": "印花",             // 工艺
    "description": "高档刺绣墙布，手感柔软",
    "tags": ["高端", "推荐"]
}
```

### 7.4 数据验证规则

#### 7.4.1 墙纸验证规则

* **幅宽验证**：
  * 必须为正数
  * 常用值：53cm、70cm、110cm等
  * 允许自定义值，但需在合理范围内（30cm - 150cm）

* **卷长验证**：
  * 必须为正数
  * 常用值：10m、15m、20m等
  * 允许自定义值，但需在合理范围内（5m - 50m）

* **花距验证**：
  * 必须为非负数
  * 0表示无花距
  * 若有花距，需在合理范围内（1cm - 200cm）

* **材质验证**：
  * 必须从预定义选项中选择
  * 支持扩展自定义材质

* **对花方式验证**：
  * 必须从预定义选项中选择
  * 直拼、错位拼等

#### 7.4.2 墙布验证规则

* **幅宽验证**：
  * 必须为正数
  * 常用值：280cm、300cm、320cm等
  * 允许自定义值，但需在合理范围内（200cm - 400cm）

* **材质验证**：
  * 必须从预定义选项中选择
  * 支持扩展自定义材质

* **工艺验证**：
  * 必须从预定义选项中选择
  * 支持扩展自定义工艺

### 7.5 计算引擎集成

#### 7.5.1 自动引用商品属性

报价单计算引擎需要自动引用商品基础信息中的关键参数：

**墙纸计算引擎引用：**
* **幅宽（定宽值）**：从 `attributes.fabricWidth` 引用
* **卷长**：从 `attributes.rollLength` 引用
* **花距**：从 `attributes.patternRepeat` 引用
* **对花方式**：从 `attributes.patternMatch` 引用（影响对花损耗计算）

**墙布计算引擎引用：**
* **幅宽（定高值）**：从 `attributes.fabricWidth` 引用

#### 7.5.2 数据流转

1. **商品录入**：用户在商品库中录入商品基础信息
2. **数据存储**：商品信息存储到 `products` 表
3. **报价引用**：在报价单中选择商品时，系统自动引用商品属性
4. **计算应用**：计算引擎使用商品属性进行数量和价格计算
5. **快照保存**：报价单转订单时，保存商品属性快照，不受后续商品库变更影响

### 7.6 批量导入功能

#### 7.6.1 Excel 模板设计

**通用字段（所有品类）：**
* SKU
* 商品名称
* 品类
* 单位
* 基准单价
* 成本价
* 默认供应商编码
* 是否库存管理
* 库存数量
* 安全库存
* 商品图片URL（可选）

**墙纸专属字段：**
* 幅宽（定宽值，单位：cm）
* 卷长（单位：cm）
* 花距（单位：cm）
* 材质
* 对花方式

**墙布专属字段：**
* 幅宽（定高值，单位：cm）
* 材质
* 工艺

#### 7.6.2 导入验证

* **必填字段验证**：SKU、商品名称、品类、基准单价等必填字段不能为空
* **品类验证**：品类必须是预定义的有效值
* **数值验证**：幅宽、卷长、花距等数值字段必须为有效数字
* **枚举验证**：材质、对花方式、工艺等字段必须是预定义的有效值
* **唯一性验证**：SKU必须唯一，不能重复
* **格式验证**：图片URL必须为有效的URL格式

#### 7.6.3 导入流程

1. **下载模板**：用户下载标准Excel模板
2. **填写数据**：用户按照模板格式填写商品数据
3. **上传文件**：用户上传填写好的Excel文件
4. **数据验证**：系统自动验证数据格式和有效性
5. **错误提示**：如有错误，系统提示具体错误位置和原因
6. **确认导入**：用户确认无误后，系统批量导入数据
7. **导入结果**：系统显示导入结果（成功数量、失败数量、错误详情）

### 7.7 商品信息查询与展示

#### 7.7.1 商品列表页

**显示字段：**
* 商品图片（缩略图）
* SKU
* 商品名称
* 品类
* 单位
* 基准单价
* 库存数量（如果启用库存管理）
* 状态（启用/停用）
* 操作（编辑、删除、复制）

**筛选条件：**
* 品类（墙纸、墙布、窗帘面料等）
* SKU/商品名称（模糊搜索）
* 价格范围
* 库存状态（有货/缺货）
* 状态（启用/停用）

**排序选项：**
* SKU
* 商品名称
* 价格
* 库存数量
* 创建时间

#### 7.7.2 商品详情页

**基础信息展示：**
* 商品图片（轮播图）
* SKU
* 商品名称
* 品类
* 单位
* 基准单价
* 成本价
* 默认供应商
* 库存信息（如果启用库存管理）
* 商品描述
* 备注
* 标签

**品类专属属性展示：**

**墙纸专属：**
* 幅宽（定宽值）
* 卷长
* 花距
* 材质
* 对花方式

**墙布专属：**
* 幅宽（定高值）
* 材质
* 工艺

**操作按钮：**
* 编辑
* 复制
* 停用/启用
* 删除
* 查看历史版本

### 7.8 商品信息变更管理

#### 7.8.1 变更记录

系统需要记录商品信息的变更历史：

* **变更时间**
* **变更人**
* **变更字段**
* **变更前值**
* **变更后值**
* **变更原因**

#### 7.8.2 版本管理

* **当前版本**：显示商品当前的有效信息
* **历史版本**：查看商品的历史变更记录
* **版本对比**：对比不同版本之间的差异
* **版本回滚**：支持回滚到历史版本

#### 7.8.3 影响分析

商品信息变更可能影响以下业务：

* **报价单**：已创建但未转订单的报价单
* **订单**：已转订单的订单（不受影响，因为保存了快照）
* **库存**：库存数量变更影响库存管理

系统需要提供影响分析报告，告知用户变更可能影响的业务范围。

## 8. 墙布嵌套附件逻辑 (Wallpaper Nested Attachment Logic)
当主行商品为"墙布"或"墙纸"时，支持在主行下方展开嵌套子行。

### 7.1 字段 18：附件录入 (Attachments)
* **交互：** 点击主行"+ 附件"按钮，在下方插入子行。
* **类型与联动规则：**
  * **胶水：** 数量根据墙布面积自动计算（可调参数）。推荐数量逻辑：每平方米使用量可配置。
  * **基膜：** 数量根据墙布面积自动计算（可调参数）。推荐数量逻辑：每平方米使用量可配置。
  * **自定义：** 手动录入数量与单价。

### 7.2 字段 19：行内小计 (Subtotal)
`$主行金额 + 所有嵌套附件行金额$`

## 9. 窗帘数量计算引擎逻辑 (Calculation Engine)

> [!NOTE]
> 详细计算逻辑请参考 [数量计算逻辑文档](../../数量计算逻辑.md)

### 9.1 损耗与参数预设 (Tenant Settings)
* 侧边损耗 (`$Loss_{side}$`): `$5cm$`/边。
* 帘头损耗 (`$Loss_{header}$`): 包布带 `$20cm$`；贴布带 `$7cm$`。
* 底边损耗 (`$Loss_{bottom}$`): `$10cm$`。
* 定高阈值: 默认 `$275cm$` (超过此高度需触发预警或切换逻辑)。

### 9.2 核心计算流程
1. **成品高度 (`$H_f$`):** `$测量高度 + 轨道调节高度 - 离地高度$`
2. **成品宽度 (`$W_f$`):** `$测量宽度 + 修正宽度$`
3. **面料裁剪高度 (`$H_c$`):** `$H_f + 帘头损耗 + 底边损耗$`
4. **面料裁剪宽度 (`$W_c$`):** `$W_f \times 褶皱倍数 + (片数 \times 2 \times Loss_{side})$`

### 9.3 算法分支
* **定高面料 (Fixed Height):**
  * 数量 `$Q = W_c / 100$` (单位：米)。
  * 描述：若 `$H_f > (面料幅宽 - 帘头损耗 - 底边损耗)$`，系统触发"超高预警"。默认预警阈值为 275cm。

* **定宽面料 (Fixed Width):**
  * 幅数 `$N_{幅} = \lceil W_c / 面料幅宽 \rceil$`
  * 数量 `$Q = N_{幅} \times H_c / 100$`

## 10. 墙纸/墙布数量计算引擎逻辑 (Wallpaper & Wallcloth Calculation Engine)

> [!NOTE]
> 详细计算逻辑请参考 [数量计算逻辑文档](../../数量计算逻辑.md)

### 10.1 墙纸计算逻辑 (Wallpaper Calculation)

#### 10.1.1 损耗与参数预设 (Tenant Settings)
* **裁剪损耗 (`$Loss_{cut}$`)**: `$10cm$`/条（默认值，可在系统设置中调整）
* **花距 (`$PatternRepeat$`)**: 商品属性带来的固有参数，用于对花计算。

#### 10.1.2 核心计算流程

**第一步：计算条数**
1. **单段条数 (`$N_{strips}$`)**: `$\lceil (测量宽度 + Loss_{width}) / 墙纸宽度 \rceil$`
   - 每一面墙的宽度都需要加上宽度损耗
   - 宽度损耗默认为20cm，可在系统设置中调整
   - 结果向上取整

2. **空间总条数 (`$N_{total}$`)**: `$\sum (N_{strips})$`
   - 同一空间内所有墙段的条数之和

**第二步：计算每卷可裁条数**
3. **单条裁剪高度 (`$H_{strip}$`)**:
   - **基础高度**：`$H_{base} = 测量高度 + Loss_{cut}$`
   - **无对花情况**：`$H_{strip} = H_{base}$`
   - **有对花情况** (当 `$PatternRepeat > 0$`):
     - 计算循环数：`$N_{loops} = \lceil H_{base} / PatternRepeat \rceil$`
     - 最终高度：`$H_{strip} = N_{loops} \times PatternRepeat$`
   - *注：代码算法采用倍数对齐，比简单的固定损耗更准确，确保花纹完整。*

4. **每卷可裁条数 (`$N_{roll}$`)**: `$\lfloor 墙纸长度 / H_{strip} \rfloor$`
   - 一卷总长度 ÷ 单条裁剪高度
   - 结果向下取整

**第三步：计算最终卷数**
5. **最终卷数 (`$Q$`)**: `$\lceil N_{total} / N_{roll} \rceil$`
   - 总条数 ÷ 每卷可裁条数
   - 结果向上取整

#### 10.1.3 计算示例

**示例场景：**
- 空间：客厅
- 墙段1：测量宽度 300cm
- 墙段2：测量宽度 400cm
- 墙段3：测量宽度 250cm
- 墙纸规格：0.53m (宽) × 10m (长)
- 测量高度：260cm
- 宽度损耗：20cm（默认）
- 裁剪损耗：10cm（默认）
- 对花损耗：0cm（无对花要求）

**计算过程：**
1. 墙段1条数 = ⌈(300 + 20) / 53⌉ = ⌈320 / 53⌉ = 7条
2. 墙段2条数 = ⌈(400 + 20) / 53⌉ = ⌈420 / 53⌉ = 8条
3. 墙段3条数 = ⌈(250 + 20) / 53⌉ = ⌈270 / 53⌉ = 6条
4. 空间总条数 = 7 + 8 + 6 = 21条
5. 单条裁剪高度 = 260 + 10 + 0 = 270cm
6. 每卷可裁条数 = ⌊1000 / 270⌋ = ⌊3.7⌋ = 3条
7. 最终卷数 = ⌈21 / 3⌉ = ⌈7⌉ = 7卷

### 10.2 墙布计算逻辑 (Wallcloth Calculation)

#### 10.2.1 损耗与参数预设 (Tenant Settings)
* **宽度损耗 (`$Loss_{width}$`)**: `$20cm$`/段（默认值，可在系统设置中调整）。
* **上下损耗 (`$Loss_{height}$`)**: `$10cm$`（上下各5cm，默认值，可在系统设置中调整）。
* **墙布幅宽 (`$FabricWidth$`)**: 从商品库自动引用（如：53cm、70cm、100cm等）。

#### 10.2.2 核心计算流程

**第一步：计算用料数量**
1. **单段用料宽度 (`$W_{segment}$`)**: `$测量宽度 + Loss_{width}$`
   - 每一面墙的宽度都需要加上宽度损耗
   - 损耗默认为20cm，可在系统设置中调整

2. **空间总宽度 (`$W_{total}$`)**: `$\sum (W_{segment})$`
   - 同一空间内所有墙段的用料宽度之和

3. **墙布高度 (`$H_{wallpaper}$`)**: `$FabricWidth + Loss_{height}$`
   - 基础高度使用墙布幅宽
   - 加上上下损耗（上下各5cm，共10cm）
   - 只要测量高度 ≤ 幅宽，即可使用此计算方式
   - 若测量高度 > 幅宽，触发"超高预警"（后续版本支持）

4. **空间用料数量 (`$Q_{material}$`)**: `$W_{total} \times H_{wallpaper}$` (单位：平方厘米)

**第二步：计算最终数量**
5. **最终数量 (`$Q$`)**: `$Q_{material} / 10000$` (单位：平方米)

#### 10.2.3 计算示例

**示例场景：**
- 空间：客厅
- 墙段1：测量宽度 300cm
- 墙段2：测量宽度 400cm
- 墙段3：测量宽度 250cm
- 墙布幅宽：53cm
- 宽度损耗：20cm（默认）
- 上下损耗：10cm（上下各5cm，默认）

**计算过程：**
1. 墙段1用料宽度 = 300 + 20 = 320cm
2. 墙段2用料宽度 = 400 + 20 = 420cm
3. 墙段3用料宽度 = 250 + 20 = 270cm
4. 空间总宽度 = 320 + 420 + 270 = 1010cm
5. 墙布高度 = 53 + 10 = 63cm（幅宽 + 上下损耗）
6. 空间用料数量 = 1010 × 63 = 63,630 平方厘米
7. 最终数量 = 63,630 / 10,000 = 6.363 平方米

#### 10.2.4 约束条件
* **高度约束**: 若 `$测量高度 > 墙布幅宽$`，系统触发"超高预警"，提示用户选择更大幅宽的墙布或采用特殊拼接方案。
* **损耗可配置**: 
  - 宽度损耗默认20cm，租户可在系统设置中根据实际情况调整。
  - 上下损耗默认10cm（上下各5cm），租户可在系统设置中根据实际情况调整。

### 10.3 墙纸/墙布计算对比示例

**场景对比：一面墙宽 5m，高 2.6m**

**如果选墙纸 (0.53m宽/10m卷)：**
- 条数：$5 \div 0.53 = 9.43 \rightarrow$ 10条
- 每卷条数：$10 \div 2.6 = 3.84 \rightarrow$ 3条
- 需用卷数：$10 \div 3 = 3.33 \rightarrow$ 4卷

**如果选墙布 (2.8m定高)：**
- 面积：$5 \times 2.8 = 14$ 平方米

## 11. 版本管理与对比引擎 (Versioning & Compare)

### 11.1 版本状态管理规则

#### 11.1.1 多版本状态约束
* **唯一Active规则**：同一报价单下，同一时间只能有一个版本处于 `ACTIVE` 状态，其他版本必须为 `DRAFT` 状态
* **Active版本特权**：只有 `ACTIVE` 状态的版本才能转化为正式订单
* **状态切换规则**：
  - 将某个版本设置为 `ACTIVE` 时，自动将原 `ACTIVE` 版本降级为 `DRAFT`
  - `DRAFT` 版本可以编辑、删除
  - `ACTIVE` 版本不可编辑，只能查看或创建新版本

#### 11.1.2 版本状态定义

| 状态 | 状态码 | 说明 | 可操作 |
|:---|:---|:---|:---|
| **草稿** | `DRAFT` | 编辑中，不可转单 | 编辑、删除、设为Active |
| **生效** | `ACTIVE` | 当前有效版本，可转单 | 查看对比、创建新版本 |

#### 11.1.3 版本切换流程
```mermaid
graph LR
    A[草稿版本] -->|设为Active| B[Active版本]
    B -->|创建新版本| C[新草稿版本]
    B -->|转单| D[正式订单]
    C -->|设为Active| E[新Active版本]
    E -->|自动降级| F[原Active版本变草稿]
```

### 11.2 版本分支策略
* **覆盖保存：** 更新当前活跃版本的 JSONB 数据。
* **另存为新版本：** 克隆当前数据生成 V+1，用于不同方案的选择。

### 11.2 "苹果风"对比视图 (Comparison UI)
* **布局：** 侧并侧 (Side-by-Side) 网格布局，Header 吸顶展示总价。
* **多维切换：**
  * 按空间对比：纵向对齐不同方案在同一房间的商品、褶皱、附件差异。
  * 按品类对比：横向对比不同版本的预算分配（窗帘类总价 vs 墙布类总价）。
* **差异高亮：** 自动识别并标记新增项、删除项或参数变动项。

## 12. 订单流转逻辑 (Order Transition)
* **转单机制：** 仅 `ACTIVE` 状态版本可转为正式订单。
* **数据快照 (Snapshot)：** 转单时深度克隆所有 JSONB 数据（含图片地址、裁剪尺寸、工艺要求）。订单价格一经生成即锁定，不受后台商品库变动影响。
* **拆流路由：** 基于 `category_tag` 自动分流：
  * 窗帘/墙布主材 -> 供应商采购单。
  * 绑带/抱枕/缝制要求 -> 内部工单系统。
  * 胶水/基膜 -> 供应商采购单。

## 13. 技术实现规格 (Technical Specs)
* **前端：** Next.js + Shadcn UI + Tailwind CSS。
* **数据库：** Drizzle ORM + Supabase (JSONB 存储内容快照)。
* **关键组件：** Combobox 处理型号联想，Accordion 处理专业信息折叠，Grid 处理对比视图。