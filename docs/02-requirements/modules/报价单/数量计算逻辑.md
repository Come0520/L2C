# L2C 系统：窗帘数量计算引擎完整逻辑文档

## 1. 维度与配置管理 (Settings & Roles)
系统计算依赖于三个层级的参数输入：

### 1.1 系统级设置 (System Config - 租户预设)
* **计算开关：** 离地高度是否参与计算、轨道高度是否参与计算、侧边损耗是否参与。
* **标准损耗值：**
  * `SIDE_LOSS`：默认 `5cm` /边。
  * `HEADER_LOSS_WRAPPED` (包布带)：默认 `20cm` (布带 `15cm` + 翻边 `5cm`)。
  * `HEADER_LOSS_ATTACHED` (贴布带)：默认 `7cm`。
  * `BOTTOM_LOSS`：默认 `10cm`。
* **定高阈值：** 默认 `275cm` (超过此高度需触发预警或切换逻辑)。

### 1.2 用户/订单级设置 (User/Order Input)
* **基础尺寸：** 测量宽度 (`W_measured`)、测量高度 (`H_measured`)。
* **业务属性：** 褶皱倍数 (`F`)、离地高度 (`CLR`)、开合方式 (单开/双开/多开)。
* **工艺选择：** 帘头工艺 (包布带/贴布带)。

---

## 2. 第一步：确定成品尺寸 (Finished Size)
这是对外呈现给客户的规格。

1. **成品高度 (`H_finished`)：**
   ```math
   H_finished = H_measured - CLR
   ```

   *注：轨道厚度需从关联的轨道商品信息字段中自动引用。*

2. **成品宽度 (`W_finished`)：**
   ```math
   W_finished = W_measured × F
   ```

---

## 3. 第二步：确定计算尺寸与损耗 (Fabric Cut Size)
这是内部计算面料用量时的基准。

1. **面料宽度 (`W_cut`)：**
   ```math
   W_cut = W_finished + (2 × SIDE_LOSS)
   ```
   * *示例：双开（2片）增加 `10cm`；单开（1片）增加 `5cm`。*

2. **面料高度 (`H_cut`)：**
   * **包布带：**
     ```math
     H_cut = H_finished + HEADER_LOSS_WRAPPED + BOTTOM_LOSS
     ```
   * **贴布带：**
     ```math
     H_cut = H_finished + HEADER_LOSS_ATTACHED + BOTTOM_LOSS
     ```

---

## 4. 第三步：用料算法与冲突校验 (Quantity & Constraints)
根据面料物理属性（幅宽类型）进入不同分支：

### 4.1 定高面料分支 (Fixed Height Fabric)
**核心逻辑：** 限制高度，按宽度买面料。

1. **有效高度校验 (Constraint Check)：**
   * 系统读取面料总幅宽（如 `290cm`）。
   * 计算当前工艺下的最大有效成品高度：
     ```math
     H_max = 面料总幅宽 - HEADER_LOSS - BOTTOM_LOSS
     ```
   * **预警机制：**
     * 若 `H_finished <= H_max` (包布带模式)：正常计算。
     * 若 `H_finished <= H_max + 13cm`：系统提示“让渡帘头”，建议将包布带改为贴布带。
     * 若 `H_finished > H_max + 13cm`：提示“让渡底边”或手动确认超高工艺。

2. **数量计算：**
   ```math
   Q = W_cut
   ```
   * *单位：米 (m)，保留小数点后 1 位。*

### 4.2 定宽面料分支 (Fixed Width Fabric)
**核心逻辑：** 限制宽度（如 `140cm`），按高度买面料。

1. **计算所需幅数 (`N`)：**
   ```math
   N = ceil(W_cut / 面料幅宽)
   ```
   * *结果必须向上取整（进位）。*

2. **数量计算：**
   ```math
   Q = N × H_cut
   ```
   * *单位：米 (m)，保留小数点后 1 位，结果向上进位。*

---

## 5. 异常处理与联想功能
* **联想输入：** 在输入“商品型号”时，系统通过搜索建议（Autocomplete）快速匹配商品库，自动填充：幅宽、加工模式（定高/定宽）、克重、花距等。
* **版本对比：** 支持不同“褶皱倍数”或“帘头工艺”下的版本横向对比，参考苹果官网样式，突出显示总价和面料米数的差异。

---