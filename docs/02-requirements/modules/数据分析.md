# 数据分析模块 (Analytics) 需求规格说明

## 1. 业务概述
数据分析模块提供全方位的业务数据监控与洞察，涵盖销售、交付、售后、财务等核心环节。所有的统计指标支持按租户隔离，部分指标支持按个人/团队维度进行下钻。

## 2. 核心分析域与指标定义

本模块包含 11 个核心分析域，均已独立为 Server Action 以提供细粒度服务：

| 分析域 (Action) | 核心功能与指标定义 | 默认权限控制 |
|---|---|---|
| **核心仪表盘统计** (`dashboard-stats.ts`) | **销售额**：选定时间范围内订单的总金额<br/>**订单数**：选定时间范围内的成单数量<br/>**新增线索**：选定时间范围内新录入的线索总数<br/>**转化率**：成单数 / 新增线索数<br/>**待收款/付款**：未核销总应收、总应付额度 | `VIEW` |
| **销售漏斗** (`sales-funnel.ts`) | 追踪线索 -> 测量 -> 报价 -> 成交的全流程转化。<br/>计算**各阶段漏斗数量**、**阶段间转化率**、**各阶段平均耗时**。<br/>支持与上月同期进行**同比趋势分析**（上升/下降百分比）。 | `VIEW` |
| **业绩排名** (`leaderboard.ts`) | 团队业绩榜单，支持按成单**金额 (amount)** 或**数量 (count)**进行倒序排列。<br/>可自定义显示前 N 名 (Top N)，显示销售员名称及对应业绩。 | `VIEW_ALL` |
| **客户来源分析** (`customer-source.ts`) | 归属不同渠道 (Channel) 的线索占比统计。<br/>汇总各已知渠道的线索数量，并单列"直客/未分配"渠道数据。<br/>按来源线索总数倒序提取 Top 10 进行分布展示。 | `VIEW` |
| **订单趋势** (`order-trend.ts`) | 订单金额与数量的时间序列走势分析。<br/>支持按 **日 (day)、周 (week)、月 (month)** 三种聚合粒度进行图表数据输出。 | `VIEW` |
| **利润率分析** (`profit-margin.ts`) | 核心财务指标测算：<br/>**毛利** = 销售收入总额 - 采购成本总额<br/>**毛利率** = 毛利 / 销售收入 * 100%<br/>包含按月维度的利润趋势分析。 | `VIEW_ALL` |
| **报价参考价格** (`pricing-reference.ts`) | 针对特定产品的历史报价辅助工具。<br/>聚合指定时间周期（默认90天）内，已确认的非草稿报价数据。<br/>提供该产品的**均价**、**最高价**、**最低价**及**有效样本数**参考。 | `VIEW` |
| **AR 账龄分析** (`ar-aging.ts`) | 应收账款 (AR) 健康度分析：<br/>将未结清应收账款按 **0-30天、31-60天、61-90天、90天以上(高风险)** 进行分层统计占比。<br/>支持按负责的销售人员分组，透视各销售的待收总额及明细账单。 | `VIEW` |
| **现金流预测** (`cash-flow.ts`) | 基于确定的付款计划 (Payment Schedules) 进行短期（默认未来90天）现金流预测。<br/>输出**按周/按月预期回款**金额、各**款项类型 (Schedule Type)** 构成占比。<br/>单独统计并预警已逾期的未结款项总额及平均逾期天数。 | `VIEW` |
| **交付效率统计** (`delivery-efficiency.ts`) | 售后及生产履约进度评估：<br/>针对测量 (Measure) 和安装 (Install) 任务，分别统计：**平均耗时**（完成时间 - 创建时间）、**按时达成率**（完成时间 <= 计划时间）。<br/>统计当前的待处理任务数及逾期未完工任务数。 | `VIEW` |
| **售后健康度** (`after-sales-health.ts`) | 监控售后服务质量及成本：<br/>**退款率** = 售后实际扣款/退款总额 / 销售总额<br/>**客诉率** = 售后工单总数 / 总订单数<br/>**责任分布**：按定责方（厂家、物流、安装、销售等）统计定责单数量与金额分布。<br/>基于退款率及客诉率自动定级健康度 (**GOOD**, **NORMAL**, **WARNING**)。 | `VIEW` |

## 3. 权限矩阵映射 (Permission Matrix)

分析模块依赖严格的基于 RBAC 的权限管控：

- **普通员工 (例如 SALES)**：拥有 `ANALYTICS_PERMISSIONS.VIEW` 权限的普通销售仅能查阅**个人数据**（例如自己的漏斗和订单）。
- **门店管理层/高管 (例如 MANAGER, BOSS)**：拥有 `ANALYTICS_PERMISSIONS.VIEW_ALL`，可查阅**整个租户 (Tenant)** 的汇总数据以及销售业绩排名 (`leaderboard`)。
- **特定模块控制**：如财务相关的账龄和现金流数据，仅限配置了对应财务/管理角色的账户访问。

## 4. 架构与性能策略

- **租户隔离**：所有 Action 请求在拼接 SQL 条件时强制包含 `eq(table.tenantId, session.user.tenantId)`。
- **缓存策略**：
  - 数据变动非强实时，使用 Next.js 的 `unstable_cache` 做数据缓存层。
  - **Revalidate 时间**：缓存统一设置为 `3600` 秒（1 小时），降低数据库实时聚合压力。
  - **Cache Tags**：数据按维度采用 tags 进行组合（如 `[analytics-{tenantId}, analytics-dashboard]`），以支持通过 `revalidateTag` 进行定向手动刷新。
