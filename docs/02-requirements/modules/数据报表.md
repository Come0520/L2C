# 数据报表与仪表盘 (Analytics & Dashboard)

## 1. 模块概述 (Module Overview)

| 属性 | 说明 |
|:---|:---|
| **模块名称** | 数据报表 (Analytics & Dashboard) |
| **核心价值** | 提供宏观视角的"驾驶舱"，监控企业健康度和业绩 |
| **目标用户** | 店长、财务、销售、管理层 |
| **上游模块** | 所有业务模块 (数据汇聚) |
| **下游模块** | 无 (只读展示) |

## 2. 业务场景 (Business Scenario)

### 2.1 典型场景
1. **管理看板**: 店长查看全店销售业绩、订单状态分布
2. **个人业绩**: 销售查看个人线索转化率、成交金额排名
3. **财务监控**: 财务查看应收/应付账款、现金流情况
4. **效率分析**: 分析测量/安装准时率、订单周期

### 2.2 用户诉求
| 角色 | 关注指标 |
|:---|:---|
| **店长** | 销售漏斗、业绩排名、滞留预警、利润率 |
| **销售** | 个人业绩、待办提醒、目标完成率 |
| **财务** | 应收/应付账款、现金流、账龄分析 |
| **采购** | 供应商质量、交货准时率 |

## 3. 仪表盘设计 (Dashboard Design)

### 3.1 页面布局
```
┌─────────────────────────────────────────────────────┐
│ 数据仪表盘                    [时间范围 ▼] [自定义] │
├─────────────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │
│ │核心指标1│ │核心指标2│ │核心指标3│ │核心指标4│     │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘     │
├──────────────────────┬──────────────────────────────┤
│                      │                              │
│   销售漏斗 (Chart)    │   业绩排名 (Leaderboard)      │
│                      │                              │
├──────────────────────┼──────────────────────────────┤
│                      │                              │
│   订单趋势 (Chart)    │   滞留预警 (Alert List)       │
│                      │                              │
└──────────────────────┴──────────────────────────────┘
```

### 3.2 可配置性
*   **布局调整**: 使用 `react-grid-layout` 支持拖拽排序
*   **显示/隐藏**: 点击齿轮进入配置模式，勾选组件
*   **参数独立**: 每个组件可独立设置时间范围
*   **配置持久化**: 保存到 `user_dashboard_settings` 表

### 3.3 图表钻取交互 (Drill-down)

#### 3.3.1 钻取规则

| 图表类型 | 点击对象 | 钻取目标 | 筛选条件 |
|:---|:---|:---|:---|
| **销售漏斗** | 某个阶段 (如"成交") | 订单列表页 | `status=COMPLETED` 且 `created_at` 在当前时间范围内 |
| **销售漏斗** | 某个阶段 (如"测量") | 测量任务列表页 | `created_at` 在当前时间范围内 |
| **销售漏斗** | 某个阶段 (如"报价") | 报价单列表页 | `status IN (ACTIVE, LOCKED)` 且 `created_at` 在当前时间范围内 |
| **订单趋势** | 某个数据点 (如某天) | 订单列表页 | `created_at` 等于该日期 |
| **责任分布饼图** | 某个扇区 (如"供应商责任") | 售后工单列表页 | `responsibility_type=SUPPLIER` 且 `created_at` 在当前时间范围内 |
| **应收账款账龄** | 某个扇区 (如"0-30天") | 订单列表页 | `payment_status=PARTIAL` 且账龄在 0-30 天内 |
| **业绩排名** | 某个销售员 | 订单列表页 | `sales_id=该销售员ID` 且 `created_at` 在当前时间范围内 |

#### 3.3.2 实现方式

**跳转逻辑**：
1. 用户点击图表的可交互区域
2. 系统获取点击数据的上下文信息（阶段、日期、类型等）
3. 构造目标页面的 URL 参数（如 `?status=COMPLETED&startDate=2024-01-01&endDate=2024-01-31`）
4. 跳转到目标列表页，自动应用筛选条件

**用户体验**：
- 鼠标悬停时显示可点击提示（光标变为 pointer）
- 点击后使用新标签页打开，避免丢失当前仪表盘状态
- 目标页面顶部显示"从仪表盘钻取而来"提示，可一键返回

#### 3.3.3 不可钻取组件

以下组件不支持钻取交互：
- 核心指标卡片（数值展示）
- 滞留预警 Alert Table（本身已是列表，点击单号跳转单据详情）

## 4. 预置组件库 (Widget Library)

### 4.1 核心指标卡片 (Stat Cards)

使用 `Statistic` 组件 (Ant Design)：

| 组件 | 指标 | 计算逻辑 |
|:---|:---|:---|
| **本月销售额** | 订单成交金额 | SUM(orders.total_amount) WHERE created_at in 本月 |
| **本月新线索** | 新增线索数 | COUNT(leads) WHERE created_at in 本月 |
| **转化率** | 线索成交率 | WON / 总线索 × 100% |
| **待收款** | 应收账款 | SUM(orders.total_amount - paid_amount) |
| **待付款** | 应付账款 | SUM(po.total_cost) WHERE payment_status = PENDING |
| **平均订单周期** | 交付周期 | AVG(completed_at - created_at) |
| **本月毛利** | 销售毛利 | 销售额 - 采购成本 - 渠道佣金 - 虚拟成本 |
| **毛利率** | 毛利率 | 毛利 / 销售额 × 100% |

#### 利润率指标说明
**数据来源**：
- `销售额`：订单成交金额 (来自订单模块)
- `采购成本`：采购单总成本 (来自采购模块)
- `渠道佣金`：渠道分佣金额 (来自财务模块 `commission` 表)
- `虚拟成本`：公司责任成本 (来自财务模块 `virtual_cost` 表)

**计算公式**：
```
毛利 = 销售额 - 采购成本 - 渠道佣金 - 虚拟成本
毛利率 = 毛利 / 销售额 × 100%
```

**联动模块**：财务模块 (Finance) - 需获取 `virtual_cost` 和 `commission` 数据

### 4.2 销售漏斗 (Funnel Chart)

使用 `@ant-design/charts` Funnel 图：

| 阶段 | 数据源 | 说明 |
|:---|:---|:---|
| 线索 | COUNT(leads) | 全部线索 |
| 测量 | COUNT(measure_tasks) | 已预约测量 |
| 报价 | COUNT(quotes) WHERE status IN (ACTIVE, LOCKED) | 已出报价 |
| 成交 | COUNT(orders) | 已成交订单 |

#### 组件配置
| 配置项 | 组件 | 说明 |
|:---|:---|:---|
| 时间范围 | `DateRangePicker` | 默认本月 |
| 销售员 | `Select` | 店长可选全部/某销售 |

### 4.3 业绩排名 (Leaderboard)

使用 `Table` 或 `List` 组件：

| 列 | 说明 |
|:---|:---|
| 排名 | 1, 2, 3... |
| 销售员 | 姓名 + 头像 |
| 成交额 | 本月成交金额 |
| 订单数 | 本月成交订单数 |
| 转化率 | 成交/报价 |

#### 组件配置
| 配置项 | 组件 | 说明 |
|:---|:---|:---|
| 排序方式 | `Radio` | 按金额/按订单数 |
| 显示数量 | `Select` | Top 5/10/20 |

### 4.4 订单趋势 (Line Chart)

使用 `@ant-design/charts` Line 图：

| 维度 | 说明 |
|:---|:---|
| X轴 | 日期 (按天/周/月) |
| Y轴 | 订单金额 / 订单数量 (可切换) |
| 多条线 | 本期 vs 同期 (可选) |

### 4.5 应收账款账龄 (Pie/Bar Chart)

使用 `@ant-design/charts` Pie 或 Bar 图：

| 账龄 | 定义 |
|:---|:---|
| 0-30天 | 订单完成后 0-30 天 |
| 31-60天 | 订单完成后 31-60 天 |
| 61-90天 | 订单完成后 61-90 天 |
| 90天以上 | 超过 90 天 (高风险) |

### 4.6 滞留预警 (Alert Table)

使用 `Table` 组件，高亮显示：

| 列 | 说明 |
|:---|:---|
| 单据类型 | 订单/采购单/安装单 |
| 单号 | 可点击跳转 |
| 当前状态 | - |
| 滞留天数 | ≥3天显示红色 |
| 归属人 | - |

#### 筛选配置
| 配置项 | 组件 | 说明 |
|:---|:---|:---|
| 单据类型 | `Checkbox` | 多选 |
| 滞留阈值 | `InputNumber` | 默认 3 天 |

### 4.7 供应商准时率 (Bar Chart)

| 维度 | 说明 |
|:---|:---|
| X轴 | 供应商名称 |
| Y轴 | 准时率 (%) |
| 计算 | ONTIME / TOTAL × 100% |

### 4.8 测量/安装效率 (Mixed Chart)

| 指标 | 说明 |
|:---|:---|
| 准时上门率 | check_in_time ≤ scheduled_time |
| 平均上门时长 | AVG(completed_at - assigned_at) |
| 按工人排名 | 显示效率最高/最低的工人 |

### 4.9 售后监控 (After-Sales Dashboard)

#### 4.9.1 售后健康度指标卡片

| 组件 | 指标 | 计算逻辑 |
|:---|:---|:---|
| **退款率** | 退款金额占比 | 退款金额 / 销售总额 × 100% |
| **客诉率** | 售后工单占比 | 售后工单数 / 成交订单数 × 100% |
| **待处理工单** | 未关闭工单数 | COUNT(after_sales_tickets) WHERE status != CLOSED |
| **平均处理时长** | 工单处理效率 | AVG(closed_at - created_at) |

#### 4.9.2 责任分布饼图

使用 `@ant-design/charts` Pie 图展示售后责任归属：

| 责任类型 | 说明 |
|:---|:---|
| 供应商责任 | 产品质量问题、发货错误等 |
| 测量责任 | 测量数据错误、尺寸不符等 |
| 安装责任 | 安装质量问题、操作不当等 |
| 公司责任 | 流程问题、沟通失误等 |
| 客户责任 | 客户变更需求、使用不当等 |

#### 组件配置
| 配置项 | 组件 | 说明 |
|:---|:---|:---|
| 时间范围 | `DateRangePicker` | 默认本月 |
| 责任类型 | `Checkbox` | 多选筛选 |

#### 数据来源
- `退款金额`：来自财务模块 `refund` 表
- `售后工单`：来自售后模块 `after_sales_tickets` 表
- `责任归属`：售后工单的 `responsibility_type` 字段

## 5. 数据字段定义 (Field Definitions)

### 5.1 用户仪表盘配置表 (user_dashboard_settings)

| 字段名 | 类型 | 说明 |
|:---|:---|:---|
| id | UUID | 主键 |
| user_id | UUID | 关联用户 |
| layout | JSONB | 布局配置 (组件位置/大小) |
| visible_widgets | String[] | 显示的组件ID列表 |
| widget_configs | JSONB | 各组件的参数配置 |
| updated_at | DateTime | 更新时间 |

### 5.2 Layout JSON 结构
```typescript
interface LayoutConfig {
  widgets: {
    id: string;
    x: number;
    y: number;
    w: number;
    h: number;
    minW?: number;
    minH?: number;
  }[];
}
```

### 5.3 Widget Config JSON 结构
```typescript
interface WidgetConfig {
  [widgetId: string]: {
    timeRange: 'today' | 'week' | 'month' | 'quarter' | 'year' | 'custom';
    customRange?: [string, string];
    filters?: {
      salesId?: string;
      supplierId?: string;
      [key: string]: any;
    };
  };
}
```

## 6. 界面设计 (UI Design)

### 6.1 页面结构

#### 顶部工具栏
| 元素 | 组件 | 说明 |
|:---|:---|:---|
| 页面标题 | Text | "数据仪表盘" |
| 全局时间范围 | `DateRangePicker` | 应用到所有组件 (可被覆盖) |
| 自定义布局 | `Button` | 进入编辑模式 |
| 导出报表 | `Button` | 导出 PDF/Excel |

#### 编辑模式
*   进入后组件显示拖拽手柄
*   可拖动调整位置和大小
*   右上角齿轮进入组件配置
*   顶部显示"保存"/"取消"按钮

### 6.2 组件交互

#### 组件头部
| 元素 | 说明 |
|:---|:---|
| 标题 | 组件名称 |
| 时间范围 | 当前时间范围 (可点击切换) |
| 设置图标 | 进入组件配置 |
| 刷新图标 | 手动刷新数据 |

#### 组件配置弹窗
使用 `Drawer` 组件：
| 配置项 | 组件 | 说明 |
|:---|:---|:---|
| 时间范围 | `Radio` + `DateRangePicker` | 预设或自定义 |
| 数据筛选 | 根据组件类型动态渲染 | 销售员/供应商等 |
| 显示设置 | 根据组件类型动态渲染 | 显示数量/排序方式等 |

### 6.3 移动端适配 (Mobile Experience)

#### 6.3.1 布局降级策略

**响应式断点**：
- 桌面端：≥ 768px，使用 `react-grid-layout` 网格布局
- 移动端：< 768px，强制使用单列流式布局

**移动端布局特点**：
1. **强制单列流式布局**
   - 所有组件按顺序垂直排列
   - 组件宽度 100%，高度自适应内容
   - 禁用拖拽和调整大小功能

2. **隐藏"自定义布局"功能**
   - 移动端不显示"自定义布局"按钮
   - 不进入编辑模式
   - 使用预定义的默认组件顺序

3. **简化图表展示**
   - **趋势图 (Line Chart)** → 简化为 Sparkline (迷你图)
     - 隐藏 X 轴和 Y 轴
     - 仅显示趋势线条
     - 点击展开查看完整图表
   - **饼图** → 保持原样，但缩小尺寸
   - **漏斗图** → 保持原样，但缩小尺寸
   - **柱状图** → 保持原样，但简化标签

#### 6.3.2 移动端组件优先级

**移动端默认显示组件**（按优先级排序）：
1. 核心指标卡片（显示前 4 个关键指标）
2. 滞留预警 Alert Table（仅显示前 5 条）
3. 销售漏斗（简化版）
4. 订单趋势（Sparkline）
5. 业绩排名（仅显示 Top 5）

**移动端隐藏组件**：
- 供应商准时率
- 应收账款账龄（可点击展开）
- 测量/安装效率（可点击展开）
- 售后监控（可点击展开）

#### 6.3.3 移动端交互优化

**顶部工具栏简化**：
- 隐藏"自定义布局"按钮
- 时间范围选择器简化为快捷选项（今天/本周/本月）
- 导出按钮移至页面底部

**组件交互**：
- 图表点击后全屏展示完整版本
- 列表类组件支持下拉加载更多
- 核心指标卡片支持左右滑动查看更多指标

**性能优化**：
- 移动端默认只加载首屏组件
- 滚动时按需加载后续组件
- 图表使用轻量级渲染模式

## 7. 权限控制 (Permission Matrix)

### 7.1 页面级权限

| 页面 | 销售 | 派单员 | 采购员 | 财务 | 店长 |
|:---|:---|:---|:---|:---|:---|
| 仪表盘 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 自定义布局 | ✗ | ✗ | ✗ | ✗ | ✓ |

### 7.2 数据范围权限

| 角色 | 看到的数据范围 |
|:---|:---|
| **销售** | 仅自己的业绩数据 |
| **派单员** | 派单相关统计 |
| **采购员** | 采购/供应商相关统计 |
| **财务** | AR/AP 全部数据 |
| **店长** | 本店全部数据 |
| **管理层** | 跨店/全公司数据 |

### 7.3 组件可见性

| 组件 | 销售 | 财务 | 店长 |
|:---|:---|:---|:---|
| 销售漏斗 | ✓ (本人) | ✗ | ✓ (全店) |
| 业绩排名 | ✓ | ✗ | ✓ |
| 应收账款 | ✗ | ✓ | ✓ |
| 应付账款 | ✗ | ✓ | ✓ |
| 滞留预警 | ✓ (本人) | ✗ | ✓ (全店) |
| 供应商准时率 | ✗ | ✗ | ✓ |

## 8. 技术实现 (Technical Implementation)

### 8.1 数据源策略

| 策略 | 适用场景 | 说明 |
|:---|:---|:---|
| **实时聚合** | 核心指标卡片 | 直接 SUM/COUNT 业务表 |
| **定时快照** | 历史趋势 | 每日凌晨生成当日快照 |
| **物化视图** | 复杂报表 | PostgreSQL Materialized View |

### 8.2 图表库选型

| 库 | 用途 | 说明 |
|:---|:---|:---|
| `@ant-design/charts` | 主力图表库 | 与 Ant Design 风格一致 |
| `react-grid-layout` | 拖拽布局 | 仪表盘组件排列 |

### 8.3 性能优化
*   **懒加载**: 组件进入视口时才加载数据
*   **缓存**: 相同参数的请求缓存 5 分钟
*   **分页**: 排名/列表类组件默认只加载 Top N

## 9. 通知与提醒 (Notifications)

| 触发事件 | 通知对象 | 渠道 | 内容 |
|:---|:---|:---|:---|
| 日报生成 | 店长 | 飞书 | 昨日销售日报已生成 |
| 滞留预警 | 相关负责人 | 系统 | XXX单据滞留超过3天 |
| 收款逾期 | 销售+财务 | 系统+飞书 | 有订单收款逾期 |
| 目标完成 | 销售 | 系统 | 恭喜完成月度目标 |

## 10. 与其他模块的关联 (Module Relations)

| 模块 | 数据来源 | 说明 |
|:---|:---|:---|
| **线索** | 线索数量、转化率 | - |
| **报价单** | 报价数量、金额 | - |
| **订单** | 成交金额、订单状态 | - |
| **采购单** | 采购成本、供应商数据 | - |
| **安装单** | 效率指标、工人数据 | - |
| **对账单** | AR/AP 账款数据 | - |
