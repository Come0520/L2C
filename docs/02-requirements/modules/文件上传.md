# 文件上传模块需求文档

> 模块路径：`src/features/upload/`
> 当前版本：L5（升级自 L3）
> 最后更新：2026-02-21

---

## 1. 功能概述

文件上传模块为整个 L2C 平台提供统一的文件上传能力，支持两种存储策略：

| 存储策略 | 状态 | 说明 |
|---|---|---|
| **本地存储**（Local） | ✅ 当前启用 | 文件保存至服务器 `public/uploads/{tenantId}/` 目录 |
| **阿里云 OSS**（Object Storage） | 🚫 暂时禁用 | 需要配置 STS Token，待 OSS 环境就绪后启用 |

---

## 2. 支持的文件类型与大小限制

### 2.1 允许上传的 MIME 类型

| 分类 | MIME 类型 | 扩展名 |
|---|---|---|
| 图片 | `image/jpeg` | `.jpg`, `.jpeg` |
| 图片 | `image/png` | `.png` |
| 图片 | `image/gif` | `.gif` |
| 图片 | `image/webp` | `.webp` |
| 图片 | `image/svg+xml` | `.svg` |
| 文档 | `application/pdf` | `.pdf` |
| 文档 | `application/msword` | `.doc` |
| 文档 | `application/vnd.openxmlformats-officedocument.wordprocessingml.document` | `.docx` |
| 表格 | `application/vnd.ms-excel` | `.xls` |
| 表格 | `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet` | `.xlsx` |

> [!CAUTION]
> 明确禁止上传可执行文件（`.exe`、`.dll`、`.sh`、`.bat`）、脚本文件（`.js`、`.py`、`.php`）及所有未在列表中的类型。

### 2.2 文件大小限制

| 限制项 | 值 |
|---|---|
| 单文件最大体积 | **10 MB**（10 × 1024 × 1024 字节） |
| 最小体积 | 1 字节 |

---

## 3. API 接口说明

### 3.1 `uploadFileAction(formData: FormData)`

通过 FormData 上传单个文件。

**请求参数**

| 字段 | 类型 | 说明 |
|---|---|---|
| `file` | `File` | FormData 中的文件对象（必须） |

**响应格式**

```ts
// 成功
{ success: true; url: string }

// 失败
{ success: false; error: string }
```

**错误码说明**

| 错误信息 | 原因 |
|---|---|
| `未授权访问` | 未登录或 Session 无效 |
| `未上传文件` | FormData 中无 `file` 字段 |
| `文件大小不能超过 10MB` | 文件体积超限 |
| `不支持的文件类型` | MIME 类型不在白名单内 |
| `上传失败` | 服务器写入文件时发生异常 |

### 3.2 `validateUpload(params)`

仅校验上传元数据（文件名、大小、MIME 类型），不实际写入文件。

### 3.3 `getOSSToken()`（暂时禁用）

获取阿里云 OSS STS 临时凭证（15分钟有效期）。当前版本返回 `success: false`，待 OSS 配置就绪后启用。

---

## 4. 安全措施

### 4.1 MIME 类型校验

使用 Zod Schema 对文件的 `mimeType` 字段进行白名单校验，不在白名单内的类型直接拒绝，**不依赖文件扩展名**（防止扩展名欺骗）。

### 4.2 路径遍历防护（Path Traversal Protection）

文件保存前对文件名进行净化处理：

```ts
// 只允许字母、数字、点、连字符、下划线
const safeName = file.name.replace(/[^\w.\-]/g, '_');
```

此规则将 `../../../etc/passwd` 净化为 `______etc_passwd`，有效阻止目录穿越攻击。

### 4.3 租户隔离（Tenant Isolation）

文件存储路径按 `tenantId` 进行严格隔离：

```
public/uploads/{tenantId}/{timestamp}-{safeName}
```

不同租户的文件存储在独立目录中，互不可访问。

### 4.4 认证校验（Authentication Check）

所有上传请求必须携带有效 Session，并且 Session 中必须包含 `tenantId`，否则直接返回 `未授权访问`。

### 4.5 审计日志（Audit Log）

每次成功上传后，写入审计日志：

```ts
{
    action: 'UPLOAD_FILE',
    tableName: 'uploads',
    recordId: filename,         // 文件名
    userId: session.user.id,
    newValues: { fileName, fileSize, url }
}
```

---

## 5. 存储策略详解

### 5.1 本地存储（当前方案）

- **存储位置**：`{项目根目录}/public/uploads/{tenantId}/`
- **文件命名**：`{Unix时间戳}-{净化后文件名}`（避免命名冲突）
- **URL 格式**：`/uploads/{tenantId}/{时间戳}-{文件名}`（静态资源直接访问）

### 5.2 阿里云 OSS（未来方案）

当 OSS 功能启用后：
- STS Token 有效期：15 分钟（阿里云最小值：900 秒）
- 需要配置环境变量：`OSS_ACCESS_KEY_ID`、`OSS_ACCESS_KEY_SECRET`、`OSS_ROLE_ARN`、`OSS_BUCKET`、`OSS_REGION`

---

## 6. 权限矩阵

| 角色 | 上传文件 | 查看已上传文件 | 说明 |
|---|:---:|:---:|---|
| ADMIN | ✅ | ✅ | 管理员全权限 |
| MANAGER | ✅ | ✅ | 管理员全权限 |
| BOSS | ✅ | ✅ | 老板全权限 |
| STAFF | ✅ | ✅ | 员工可上传 |
| 未登录 | 🚫 | 🚫 | 拒绝所有请求 |

---

## 7. 配置参数

| 参数 | 当前值 | 说明 |
|---|---|---|
| `MAX_FILE_SIZE` | `10MB` | 单文件最大体积 |
| 上传路径 | `public/uploads/` | 本地存储根目录 |

---

## 8. 技术实现说明

### 8.1 主要依赖

| 依赖 | 用途 |
|---|---|
| `fs/promises.writeFile` | 异步写入文件 |
| `path.join` | 安全路径拼接 |
| `zod` | 文件元数据校验 |
| `@/shared/lib/auth` | Session 认证 |
| `@/shared/api/db` | 审计日志写入 |

### 8.2 为什么使用 FormData 而非 createSafeAction？

`createSafeAction` 基于 Zod Schema 的结构化数据，不直接支持 `File` 类型。因此 `uploadFileAction` 采用手动认证 + Zod 元数据校验的方式，在保持类型安全的同时支持 FormData 文件传输。
