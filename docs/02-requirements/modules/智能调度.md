# 智能调度 (Dispatch)

## 模块定位
本模块负责根据特定任务的需求，通过复杂的多维度加权算法，从所有可用安装工人池中“优中选优”，找到最能胜任当下任务的工人，提升履约效率，降低客户等待和失败率。这是纯算法模块，供前端及其他后端微服务直接调用算法接口。

## 场景用例
- 派单中心为某个“待成接”状态的窗帘安装任务分配师傅。
- 业务后台提供工人的推荐列表以作半人工参考。

## 算分核心与权重规则 (Scoring Matrix)

整个派单算法的总分区间为 **0-100分**。得分越高的工人排序越靠前，如果因为硬性不匹配导致得分过低或为 0，则会被剔除出备选池。算法分由三大部分组成：
`总积分 (Max 100) = 基础算法分(Max 100) + 距离加成(Max 10) + 排期可用加成(Max 10)`。

由于各项合计最大可达 120，最终均会被截断到 `Math.min(100, Total)` 以规范业务呈现。

### 1. 基础分：技能匹配 (Weight: 50)
派单的首要原则是该工人本身会做这个活。
- **专业技能完全匹配** (如任务是 `CURTAIN_FABRIC`，工人有 `CURTAIN` 技能)：+50分。
- **全能工降级匹配** (工人具备 `ALL` 技能，全职/全能型)：+40分。（为了优先把任务留给专门的师傅，全能工匹配上会有少许避让扣分）。
- **毫无匹配技能**：0分。（硬性规则：0分直接被排除当前订单备选列表）

### 2. 基础分：负载均衡 (Weight: 30)
为了防止部分优秀工人过度疲劳以及接单溢出，算法会自动执行负载倾斜。根据工人目前“正在进行中”的活动任务数 (`activeTaskCount`)：
- 空闲状态 (0单)：+30分。
- 正常状态 (<3单)：+20分。
- 忙碌状态 (<5单)：+10分。
- 严重超载 (≥5单)：-10分。此项为惩罚项。

### 3. 基础分：服务体验 (Weight: 20)
倾向将优质体验提供给客户，依据工人的平均过往评分 (`avgRating`, 满分 5.0)。
- 比例折算分： `(Rating / 5) * 20`。
- 如果是新工人暂无评分：默认给予中等值 +10分。

### 4. 距离优化因子 (Max: 10)
如果任务及工人均有地理经纬度信息，利用 Haversine 公式计算相对距离：
- `≤ 5公里`：+10分（最佳指派）。
- `≤ 20公里`：+5分（可以接受）。
- `> 20公里`：+0分。
- 无坐标信息：+5分（中立）。

### 5. 时间冲突防护 (Max: 10)
如果任务提供了计划时间及预期工时：
- 完全避开该工人的 `scheduledSlots` (已有排班)：+10分。
- 无计划时间提供：+5分（中立）。
- 时间冲突碰撞：如果系统开启了 `excludeConflicts = true`（默认），则直接剔除该工人；若未剔除，则此项得分为 0 放于低优先级。

---

## 防御性设计
1. 如果工人队列为空，防崩溃保护下将直接返回空匹配数组 `[]`。
2. 即使所有的派单工人由于过载处于负向惩罚项扣分，只要其具备该技能使得基础分大于 0 依然存在于备选列表以供派单使用，而并非强行断网，保障了即使在高峰期仍然有工单能被派送而非卡死。
