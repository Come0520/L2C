# 权限模块需求文档 (RBAC System)

## 1. 业务定义与目标
L2C (Lead to Cash) 平台是一个兼顾多门店管理与员工协作的综合系统，涉及非常广泛、细颗粒度且数据敏感度极强的业务流程（特别是财务与报价底价等）。本权限模块旨在提供**“三级递进 + 数据隔离”**的 Military-Grade RBAC（基于角色的访问控制）架构。

## 2. 核心架构与模型

系统底层由统一的 `PERMISSIONS` 常量字典 (见 `src/shared/config/permissions.ts`) 承载。

### 2.1 三态权限（Tri-state Permissions）
绝大多数常规的业务模块都会支持这三种标准能力：
- `VIEW`: 能够阅读、访问某个对象的模块入口和列表。
- `EDIT`: 拥有创建(Create)、修改(Update)、变更等影响数据的操作能力。
- `DELETE`: （高危控制项）能够从系统中移除（或软删除）此数据。

### 2.2 数据范围与归属权 (Data Isolation: OWN vs ALL)
为了隔离不同员工彼此间的业务竞争、避免客资串通等问题，系统对 `VIEW` 和 `EDIT` 在几乎所有的业务核心模块中强制划分为 `OWN` 和 `ALL`：
- `*.own.*`: **员工私域模型**。例如 `quote.own.view` 代表只能看自己创建的报价；`quote.own.edit` 代表有资格创建新的报价单并且只能编辑自己的报价。
- `*.all.*`: **主管公域模型**。例如 `order.all.edit` 代表可以随意编辑系统中任意成员签单的订单，通常授予店长或超级管理员。

### 2.3 开发规范铁律（防越权/IDOR 防范）
> [!CAUTION]
> 任何人在编写后端的 API / Server Actions 时，不能仅仅只依靠 `@/shared/lib/auth` 中的 `checkPermission(session, 'module.own.edit')` 拦截即可放行！！
> 
> **铁律：只要用户的权限仅包含对应的 `OWN` 及相关范围控制，实际的数据库增删改查语法中，必须显式附加 `eq(table.userId, session.user.id)` 或者相关的归属权过滤！** 如果仅判断权限通过，而不对数据的主人进行二次断言控制，就会直接导致水平越权漏洞 (Insecure Direct Object Reference, IDOR)。

## 3. 授权匹配机制策略（向下兼容）
本系统对细化的权限提供了降级匹配控制，通过 `auth.ts` -> `checkRolePermission`:
开发者仅需在常规的 UI 组建上要求鉴权通用行为（例如 `order.edit`），底层如果在数据库（或 `role_overrides` 中）发现该用户存在 `order.own.edit` 或 `order.all.edit`，便会判定该用户对于广义上的 "编辑" 有效并予以通行。

## 4. 角色配置体系说明
平台自带九大**内置标准角色** (如 `BOSS`, `MANAGER`, `SALES` 等)。在 `src/shared/config/roles.ts` 中记录其出厂静默绑定权限集。

针对特殊企业诉求的自定义修改，系统使用了**覆写矩阵机制** (Role Overrides):
数据库 `role_overrides` 结构 (`tenantId`, `roleCode`, `addedPermissions`, `removedPermissions`)，用来为不同租户微调该厂标角色下，特殊要求**增加与剥夺**的权限集，保障全局角色的稳定性同时提供个性化定制出口。
