# 师傅结算金额设计

## 概述

本文档描述了师傅结算金额的设计方案，包括标准价设置、结算金额来源、讨价还价流程、结算金额确认和结算单联动。

## 核心设计思路

```
标准价设置 → 结算金额来源 → 讨价还价流程 → 结算金额确认 → 结算单联动
```

### 关键特性

1. **标准价设置**：按品类+技能类型设置标准价
2. **结算金额来源**：系统标准价 + 讨价还价
3. **讨价还价流程**：最多2轮讨价还价
4. **结算金额确认**：师傅接单前手动确认
5. **结算单联动**：任务确认后生成结算单，按周期批量审核

## 数据结构设计

### 1. 标准价表（standard_prices）- 新增

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|---|
| id | UUID | ✓ | 主键 |
| category | String | ✓ | 品类（CURTAIN/WALLCLOTH/WALLPAPER） |
| skill_type | String | ✓ | 技能类型（MEASURE/INSTALL/REPAIR/CLEAN） |
| standard_price | Decimal(10,2) | ✓ | 标准价（元/次） |
| is_active | Boolean | ✓ | 是否启用 |
| effective_date | DateTime | ✓ | 生效日期 |
| expiry_date | DateTime | - | 失效日期 |
| created_at | DateTime | ✓ | 创建时间 |
| updated_at | DateTime | ✓ | 更新时间 |

**唯一索引**：(category, skill_type, effective_date)

### 2. 测量任务表（measure_tasks）- 新增字段

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|---|
| id | UUID | ✓ | 主键 |
| ... | ... | ... | ... |
| standard_price | Decimal(10,2) | ✓ | 系统标准价 |
| settlement_amount | Decimal(10,2) | ✓ | 结算金额（师傅确认的金额） |
| is_price_confirmed | Boolean | ✓ | 是否已确认结算金额 |
| price_confirmed_at | DateTime | - | 结算金额确认时间 |
| price_negotiation_count | Integer | ✓ | 讨价还价次数 |

### 3. 讨价还价记录表（price_negotiations）- 新增

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|---|
| id | UUID | ✓ | 主键 |
| task_id | UUID | ✓ | 关联任务ID（测量任务/安装任务） |
| task_type | String | ✓ | 任务类型（MEASURE/INSTALL） |
| worker_id | UUID | ✓ | 师傅ID |
| round | Integer | ✓ | 讨价还价轮次（1/2） |
| initiator | String | ✓ | 发起人（WORKER/DISPATCHER） |
| proposed_amount | Decimal(10,2) | ✓ | 提议金额 |
| status | String | ✓ | 状态（PENDING/ACCEPTED/REJECTED） |
| created_at | DateTime | ✓ | 创建时间 |
| responded_at | DateTime | - | 响应时间 |

### 4. 结算单表（settlement_bills）- 新增

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|---|
| id | UUID | ✓ | 主键 |
| bill_no | String | ✓ | 结算单号（例: SB20260101001） |
| worker_id | UUID | ✓ | 师傅ID |
| task_id | UUID | ✓ | 关联任务ID（测量任务/安装任务） |
| task_type | String | ✓ | 任务类型（MEASURE/INSTALL） |
| settlement_amount | Decimal(10,2) | ✓ | 结算金额 |
| status | String | ✓ | 状态（PENDING_AUDIT/AUDITED/SETTLED/CANCELLED） |
| audit_at | DateTime | - | 审核时间 |
| settled_at | DateTime | - | 结算时间 |
| created_at | DateTime | ✓ | 创建时间 |

## 业务逻辑设计

### 1. 标准价设置

#### 标准价设置规则

- **按品类+技能类型设置**：每个品类和技能类型的组合对应一个标准价
- **生效日期**：标准价可以设置生效日期，支持价格调整
- **唯一性**：同一品类+技能类型在同一时间段内只能有一个标准价
- **启用/禁用**：可以启用或禁用标准价

#### 标准价示例

| 品类 | 技能类型 | 标准价 | 生效日期 | 失效日期 | 是否启用 |
|:---|:---|:---|:---|:---|:---|
| CURTAIN | MEASURE | 100.00 | 2026-01-01 | - | ✓ |
| CURTAIN | INSTALL | 200.00 | 2026-01-01 | - | ✓ |
| WALLCLOTH | MEASURE | 150.00 | 2026-01-01 | - | ✓ |
| WALLCLOTH | INSTALL | 250.00 | 2026-01-01 | - | ✓ |
| WALLPAPER | MEASURE | 120.00 | 2026-01-01 | - | ✓ |
| WALLPAPER | INSTALL | 220.00 | 2026-01-01 | - | ✓ |

#### 标准价查询逻辑

```typescript
// 获取标准价
async function getStandardPrice(category: string, skillType: string): Promise<Decimal> {
  const standardPrice = await db.query.standardPrices.findFirst({
    where: and(
      eq(standardPrices.category, category),
      eq(standardPrices.skill_type, skillType),
      eq(standardPrices.is_active, true),
      lte(standardPrices.effective_date, new Date()),
      or(
        isNull(standardPrices.expiry_date),
        gt(standardPrices.expiry_date, new Date())
      )
    ),
    orderBy: desc(standardPrices.effective_date)
  });
  
  if (!standardPrice) {
    throw new Error(`未找到${category} ${skillType}的标准价`);
  }
  
  return standardPrice.standard_price;
}
```

### 2. 结算金额来源

#### 结算金额计算逻辑

```typescript
// 计算结算金额
async function calculateSettlementAmount(taskId: string): Promise<Decimal> {
  const task = await db.query.measureTasks.findFirst({
    where: eq(measureTasks.id, taskId),
    with: {
      quote: true
    }
  });
  
  // 获取标准价
  const standardPrice = await getStandardPrice(task.category, 'MEASURE');
  
  // 默认结算金额 = 系统标准价
  let settlementAmount = standardPrice;
  
  // 如果有讨价还价记录，使用讨价还价后的价格
  const negotiations = await db.query.priceNegotiations.findMany({
    where: and(
      eq(priceNegotiations.task_id, taskId),
      eq(priceNegotiations.status, 'ACCEPTED')
    ),
    orderBy: desc(priceNegotiations.round)
  });
  
  if (negotiations.length > 0) {
    settlementAmount = negotiations[0].proposed_amount;
  }
  
  return settlementAmount;
}
```

### 3. 讨价还价流程

#### 讨价还价流程（最多2轮）

```typescript
// 师傅发起讨价还价
async function initiatePriceNegotiation(
  taskId: string,
  workerId: string,
  proposedAmount: Decimal
): Promise<void> {
  const task = await db.query.measureTasks.findFirst({
    where: eq(measureTasks.id, taskId)
  });
  
  // 检查讨价还价次数
  if (task.price_negotiation_count >= 2) {
    throw new Error('讨价还价次数已达上限（2次）');
  }
  
  // 检查任务状态
  if (task.status !== 'PENDING_DISPATCH') {
    throw new Error('任务状态不允许讨价还价');
  }
  
  // 创建讨价还价记录
  await db.insert(priceNegotiations).values({
    id: generateUUID(),
    task_id: taskId,
    task_type: 'MEASURE',
    worker_id: workerId,
    round: task.price_negotiation_count + 1,
    initiator: 'WORKER',
    proposed_amount: proposedAmount,
    status: 'PENDING',
    created_at: new Date()
  });
  
  // 更新任务讨价还价次数
  await db.update(measureTasks)
    .set({
      price_negotiation_count: task.price_negotiation_count + 1
    })
    .where(eq(measureTasks.id, taskId));
  
  // 通知派单员
  await notifyDispatcher(workerId, taskId, proposedAmount);
}

// 派单员响应讨价还价
async function respondPriceNegotiation(
  negotiationId: string,
  response: 'ACCEPT' | 'REJECT' | 'COUNTER',
  counterAmount?: Decimal
): Promise<void> {
  const negotiation = await db.query.priceNegotiations.findFirst({
    where: eq(priceNegotiations.id, negotiationId),
    with: {
      task: true
    }
  });
  
  // 检查讨价还价状态
  if (negotiation.status !== 'PENDING') {
    throw new Error('讨价还价已处理');
  }
  
  // 检查讨价还价轮次
  if (negotiation.round >= 2) {
    throw new Error('讨价还价轮次已达上限（2轮）');
  }
  
  if (response === 'ACCEPT') {
    // 接受讨价还价
    await db.update(priceNegotiations)
      .set({
        status: 'ACCEPTED',
        responded_at: new Date()
      })
      .where(eq(priceNegotiations.id, negotiationId));
    
    // 更新任务结算金额
    await db.update(measureTasks)
      .set({
        settlement_amount: negotiation.proposed_amount
      })
      .where(eq(measureTasks.id, negotiation.task_id));
    
    // 通知师傅
    await notifyWorker(negotiation.worker_id, 'ACCEPT', negotiation.proposed_amount);
  } else if (response === 'REJECT') {
    // 拒绝讨价还价
    await db.update(priceNegotiations)
      .set({
        status: 'REJECTED',
        responded_at: new Date()
      })
      .where(eq(priceNegotiations.id, negotiationId));
    
    // 通知师傅
    await notifyWorker(negotiation.worker_id, 'REJECT', negotiation.task.standard_price);
  } else if (response === 'COUNTER') {
    // 还价
    await db.update(priceNegotiations)
      .set({
        status: 'REJECTED',
        responded_at: new Date()
      })
      .where(eq(priceNegotiations.id, negotiationId));
    
    // 创建新的讨价还价记录（派单员发起）
    await db.insert(priceNegotiations).values({
      id: generateUUID(),
      task_id: negotiation.task_id,
      task_type: 'MEASURE',
      worker_id: negotiation.worker_id,
      round: negotiation.round,
      initiator: 'DISPATCHER',
      proposed_amount: counterAmount,
      status: 'PENDING',
      created_at: new Date()
    });
    
    // 通知师傅
    await notifyWorker(negotiation.worker_id, 'COUNTER', counterAmount);
  }
}

// 师傅响应还价
async function respondCounterOffer(
  negotiationId: string,
  response: 'ACCEPT' | 'REJECT'
): Promise<void> {
  const negotiation = await db.query.priceNegotiations.findFirst({
    where: eq(priceNegotiations.id, negotiationId),
    with: {
      task: true
    }
  });
  
  // 检查讨价还价状态
  if (negotiation.status !== 'PENDING') {
    throw new Error('讨价还价已处理');
  }
  
  // 检查发起人
  if (negotiation.initiator !== 'DISPATCHER') {
    throw new Error('只能响应派单员的还价');
  }
  
  if (response === 'ACCEPT') {
    // 接受还价
    await db.update(priceNegotiations)
      .set({
        status: 'ACCEPTED',
        responded_at: new Date()
      })
      .where(eq(priceNegotiations.id, negotiationId));
    
    // 更新任务结算金额
    await db.update(measureTasks)
      .set({
        settlement_amount: negotiation.proposed_amount
      })
      .where(eq(measureTasks.id, negotiation.task_id));
    
    // 通知派单员
    await notifyDispatcher(negotiation.worker_id, 'ACCEPT', negotiation.proposed_amount);
  } else if (response === 'REJECT') {
    // 拒绝还价
    await db.update(priceNegotiations)
      .set({
        status: 'REJECTED',
        responded_at: new Date()
      })
      .where(eq(priceNegotiations.id, negotiationId));
    
    // 通知派单员
    await notifyDispatcher(negotiation.worker_id, 'REJECT', negotiation.task.standard_price);
  }
}
```

### 4. 结算金额确认

#### 结算金额确认流程

```typescript
// 师傅确认结算金额
async function confirmSettlementAmount(
  taskId: string,
  workerId: string
): Promise<void> {
  const task = await db.query.measureTasks.findFirst({
    where: eq(measureTasks.id, taskId)
  });
  
  // 检查任务状态
  if (task.status !== 'PENDING_DISPATCH') {
    throw new Error('任务状态不允许确认结算金额');
  }
  
  // 检查师傅
  if (task.worker_id !== workerId) {
    throw new Error('只能确认自己任务的结算金额');
  }
  
  // 检查是否已确认
  if (task.is_price_confirmed) {
    throw new Error('结算金额已确认');
  }
  
  // 更新任务结算金额确认状态
  await db.update(measureTasks)
    .set({
      is_price_confirmed: true,
      price_confirmed_at: new Date()
    })
    .where(eq(measureTasks.id, taskId));
  
  // 更新任务状态为"待上门"
  await db.update(measureTasks)
    .set({
      status: 'PENDING_VISIT'
    })
    .where(eq(measureTasks.id, taskId));
}
```

### 5. 结算单联动

#### 结算单生成逻辑

```typescript
// 生成结算单
async function generateSettlementBill(taskId: string): Promise<void> {
  const task = await db.query.measureTasks.findFirst({
    where: eq(measureTasks.id, taskId)
  });
  
  // 检查任务状态
  if (task.status !== 'COMPLETED') {
    throw new Error('任务未完成，无法生成结算单');
  }
  
  // 检查是否已生成结算单
  const existingBill = await db.query.settlementBills.findFirst({
    where: eq(settlementBills.task_id, taskId)
  });
  
  if (existingBill) {
    throw new Error('已生成结算单');
  }
  
  // 生成结算单号
  const billNo = await generateBillNo();
  
  // 创建结算单
  await db.insert(settlementBills).values({
    id: generateUUID(),
    bill_no: billNo,
    worker_id: task.worker_id,
    task_id: taskId,
    task_type: 'MEASURE',
    settlement_amount: task.settlement_amount,
    status: 'PENDING_AUDIT',
    created_at: new Date()
  });
}

// 批量审核结算单
async function batchAuditSettlementBills(
  billIds: string[],
  auditorId: string
): Promise<void> {
  const now = new Date();
  
  await db.update(settlementBills)
    .set({
      status: 'AUDITED',
      audit_at: now
    })
    .where(inArray(settlementBills.id, billIds));
  
  // 记录审核日志
  for (const billId of billIds) {
    await db.insert(settlementAuditLogs).values({
      id: generateUUID(),
      bill_id: billId,
      auditor_id: auditorId,
      action: 'AUDIT',
      created_at: now
    });
  }
}

// 批量结算
async function batchSettleBills(
  billIds: string[],
  settlerId: string
): Promise<void> {
  const now = new Date();
  
  await db.update(settlementBills)
    .set({
      status: 'SETTLED',
      settled_at: now
    })
    .where(inArray(settlementBills.id, billIds));
  
  // 记录结算日志
  for (const billId of billIds) {
    await db.insert(settlementAuditLogs).values({
      id: generateUUID(),
      bill_id: billId,
      settler_id: settlerId,
      action: 'SETTLE',
      created_at: now
    });
  }
}
```

## 界面设计

### 1. 师傅端 - 任务详情页

```
┌─────────────────────────────────────────────────────┐
│ 测量任务详情 #MS20260101001                    │
├─────────────────────────────────────────────────────┤
│ 客户信息                                     │
│ 姓名：张三                                    │
│ 电话：13800138000                              │
│ 地址：北京市朝阳区xxx小区xxx号楼xxx室             │
├─────────────────────────────────────────────────────┤
│ 任务信息                                     │
│ 品类：窗帘                                    │
│ 技能类型：测量                                 │
│ 预约时间：2026-01-20 10:00                    │
├─────────────────────────────────────────────────────┤
│ 结算金额                                     │
│ 系统标准价：100元                             │
│ 当前结算金额：100元                             │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ [确认结算金额 + 接单]               │      │
│ │ [发起讨价还价]                       │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 2. 师傅端 - 发起讨价还价弹窗

```
┌─────────────────────────────────────────────────────┐
│ 发起讨价还价                                 │
├─────────────────────────────────────────────────────┤
│ 系统标准价：100元                             │
│                                                     │
│ 请输入期望价格：                               │
│ ┌─────────────────────────────────────────────┐      │
│ │ [120] 元                              │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ 备注：                                         │
│ ┌─────────────────────────────────────────────┐      │
│ │ 师傅技能水平高，经验丰富...            │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ [取消]  [提交]                         │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 3. 派单员端 - 讨价还价请求

```
┌─────────────────────────────────────────────────────┐
│ 讨价还价请求                                 │
├─────────────────────────────────────────────────────┤
│ 任务信息                                     │
│ 任务号：MS20260101001                         │
│ 师傅：张师傅                                 │
│ 品类：窗帘                                    │
│ 技能类型：测量                                 │
├─────────────────────────────────────────────────────┤
│ 讨价还价信息                                 │
│ 系统标准价：100元                             │
│ 师傅期望价格：120元                           │
│ 备注：师傅技能水平高，经验丰富...                │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ [接受]  [拒绝]  [还价]               │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 4. 派单员端 - 还价弹窗

```
┌─────────────────────────────────────────────────────┐
│ 还价                                         │
├─────────────────────────────────────────────────────┤
│ 师傅期望价格：120元                           │
│                                                     │
│ 请输入还价：                                 │
│ ┌─────────────────────────────────────────────┐      │
│ │ [110] 元                              │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ 备注：                                         │
│ ┌─────────────────────────────────────────────┐      │
│ │ 公司标准价为100元，最高可接受110元...   │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ [取消]  [提交]                         │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 5. 师傅端 - 响应还价

```
┌─────────────────────────────────────────────────────┐
│ 响应还价                                     │
├─────────────────────────────────────────────────────┤
│ 派单员还价：110元                             │
│                                                     │
│ 您可以选择：                                   │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ [接受还价 + 接单]                   │      │
│ │ [拒绝还价]                           │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ 注意：拒绝还价后，只能接受原价（100元）或拒绝接单 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 6. 财务端 - 结算单列表

```
┌─────────────────────────────────────────────────────┐
│ 结算单列表                                   │
├─────────────────────────────────────────────────────┤
│ 筛选条件：                                   │
│ 日期范围：[2026-01-01] - [2026-01-31]         │
│ 师傅：[全部 ▼]                               │
│ 状态：[全部 ▼]                               │
│                                                     │
│ [批量审核]  [批量结算]                       │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 结算单号    │ 师傅  │ 金额  │ 状态  │ 操作 │
│ ├─────────────────────────────────────────────┤      │
│ │ SB20260101001 │ 张师傅 │ 100元 │ 待审核│ [审核]│
│ │ SB20260101002 │ 李师傅 │ 150元 │ 待审核│ [审核]│
│ │ SB20260101003 │ 王师傅 │ 120元 │ 已审核│ [结算]│
│ │ SB20260101004 │ 张师傅 │ 200元 │ 已结算│ [查看]│
│ └─────────────────────────────────────────────┘      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 业务规则

### 1. 标准价规则

- **唯一性**：同一品类+技能类型在同一时间段内只能有一个标准价
- **生效日期**：标准价可以设置生效日期，支持价格调整
- **启用/禁用**：可以启用或禁用标准价
- **查询优先级**：按生效日期降序查询，取最新的标准价

### 2. 结算金额规则

- **默认来源**：默认使用系统标准价
- **讨价还价**：如果有讨价还价记录，使用讨价还价后的价格
- **确认机制**：师傅必须确认结算金额后才能接单
- **不可修改**：结算金额确认后不可修改

### 3. 讨价还价规则

- **轮次限制**：最多2轮讨价还价
- **发起人**：第1轮由师傅发起，第2轮由派单员还价
- **响应时间**：派单员需在24小时内响应，师傅需在12小时内响应
- **失败处理**：讨价还价失败后，师傅只能接受原价或拒绝接单

### 4. 结算单规则

- **生成时机**：销售确认任务后立即生成结算单
- **批量审核**：按周期（每周/每月）批量审核结算单
- **批量结算**：审核通过后批量结算
- **状态流转**：待审核 → 已审核 → 已结算

## 通知机制

| 触发事件 | 通知对象 | 渠道 | 内容 |
|:---|:---|:---|---|
| 师傅发起讨价还价 | 派单员 | 系统+飞书 | 师傅发起讨价还价，期望价格：120元 |
| 派单员接受讨价还价 | 师傅 | 小程序+短信 | 讨价还价已接受，结算金额：120元 |
| 派单员拒绝讨价还价 | 师傅 | 小程序+短信 | 讨价还价已拒绝，请接受原价或拒绝接单 |
| 派单员还价 | 师傅 | 小程序+短信 | 派单员还价：110元，请确认 |
| 师傅接受还价 | 派单员 | 系统+飞书 | 师傅已接受还价，结算金额：110元 |
| 师傅拒绝还价 | 派单员 | 系统+飞书 | 师傅已拒绝还价 |
| 结算单生成 | 师傅 | 小程序 | 结算单已生成，等待审核 |
| 结算单审核 | 师傅 | 小程序+短信 | 结算单已审核，等待结算 |
| 结算单结算 | 师傅 | 小程序+短信 | 结算单已结算，款项已到账 |

## 注意事项

1. **数据一致性**：结算金额确认后，任务、讨价还价记录、结算单的数据必须保持一致
2. **技能匹配**：确保师傅具备对应品类的技能
3. **标准价准确**：标准价必须准确，避免计算错误
4. **讨价还价时效**：讨价还价有时效限制，避免无限协商
5. **结算单审核**：财务需及时审核结算单，避免积压
6. **用户体验**：界面设计要简洁明了，操作要流畅

## 联系人

如有疑问，请联系：
- 技术负责人：[姓名]
- 产品负责人：[姓名]
- 数据库管理员：[姓名]
