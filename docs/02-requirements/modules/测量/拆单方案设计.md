# 拆单方案设计

## 概述

本文档描述了报价单拆单的设计方案，采用**派单员接收到任务时拆单，系统给出推荐，派单员手动调整**。

## 核心设计思路

```
报价单创建 → 派单员接收到任务 → 系统推荐拆单方案 → 派单员手动调整 → 确认拆单 → 生成测量任务
```

### 关键特性

1. **按需拆单**：只在派单员主动触发时才拆单
2. **智能推荐**：系统根据品类和师傅技能自动推荐拆单方案
3. **手动调整**：派单员可以调整拆单结果
4. **成本优化**：优先推荐成本最低的方案
5. **灵活合并**：派单员可以合并品类到同一个测量任务

### 拆单粒度

**默认拆单粒度：按品类拆单**

将报价单中的商品按照品类（窗帘、墙布、墙纸等）进行拆分，每个品类生成一个测量任务。

**示例**：

```
报价单 QT20260101001 包含：
- 窗帘商品：主卧窗帘、客厅窗帘
- 墙布商品：主卧墙布、次卧墙布

拆单后生成：
- 测量任务1：窗帘测量（张师傅负责）
- 测量任务2：墙布测量（李师傅负责）
```

**派单员可合并品类**

派单员可以将多个品类合并到同一个测量任务，由一个师傅完成。

**示例**：

```
默认拆单：
- 测量任务1：窗帘测量（张师傅负责）
- 测量任务2：墙布测量（李师傅负责）

派单员合并品类后：
- 测量任务1：窗帘+墙布测量（张师傅负责）
```

**合并品类的适用场景**：

- 同一空间的不同品类（如客厅的窗帘+墙布）
- 师傅具备多种技能（如同时具备窗帘和墙布技能）
- 减少师傅上门次数，降低通勤成本

## 数据结构设计

### 1. 报价单表（quotes）- 新增字段

| 字段名   | 类型     | 必填 | 说明               |
| :------- | :------- | :--- | ------------------ |
| id       | UUID     | ✓    | 主键               |
| ...      | ...      | ...  | ...                |
| is_split | Boolean  | ✓    | 是否已拆单         |
| split_at | DateTime | -    | 拆单时间           |
| split_by | UUID     | -    | 拆单人（关联用户） |

### 2. 拆单方案表（quote_split_plans）- 新增

| 字段名         | 类型          | 必填 | 说明                                       |
| :------------- | :------------ | :--- | ------------------------------------------ |
| id             | UUID          | ✓    | 主键                                       |
| quote_id       | UUID          | ✓    | 关联报价单                                 |
| plan_type      | String        | ✓    | 方案类型（SINGLE_WORKER/MULTIPLE_WORKERS） |
| worker_ids     | JSONB         | ✓    | 师傅ID数组                                 |
| total_cost     | Decimal(10,2) | ✓    | 总成本                                     |
| worker_count   | Integer       | ✓    | 师傅数量                                   |
| avg_score      | Decimal(3,2)  | -    | 平均评分                                   |
| is_recommended | Boolean       | ✓    | 是否为推荐方案                             |
| created_at     | DateTime      | ✓    | 创建时间                                   |

### 3. 测量任务表（measure_tasks）- 新增字段

| 字段名     | 类型     | 必填 | 说明                           |
| :--------- | :------- | :--- | ------------------------------ |
| id         | UUID     | ✓    | 主键                           |
| quote_id   | UUID     | ✓    | 关联报价单                     |
| category   | String   | -    | 品类（支持多个品类，逗号分隔） |
| worker_id  | UUID     | ✓    | 师傅ID                         |
| status     | String   | ✓    | 状态                           |
| created_at | DateTime | ✓    | 创建时间                       |

## 业务逻辑设计

### 1. 系统推荐拆单方案

#### 推荐算法

```typescript
// 获取报价单的推荐拆单方案
async function getRecommendedSplitPlans(quoteId: string): Promise<SplitPlan[]> {
  const quote = await db.query.quotes.findFirst({
    where: eq(quotes.id, quoteId),
    with: {
      items: true,
    },
  });

  // 按品类分组
  const categoryGroups = groupBy(quote.items, 'category');
  const categories = Object.keys(categoryGroups);

  // 获取所有可用师傅
  const allWorkers = await getAllAvailableWorkers();

  // 生成所有可能的拆单方案
  const plans: SplitPlan[] = [];

  // 方案1：一个师傅完成所有任务（合并品类）
  for (const worker of allWorkers) {
    const canHandleAll = await canWorkerHandleAllCategories(worker.id, categories);
    if (canHandleAll) {
      const cost = await calculateTotalCost(worker.id, categories);
      plans.push({
        type: 'SINGLE_WORKER',
        workers: [worker],
        cost: cost,
        workerCount: 1,
        avgScore: worker.rating,
        categories: categories,
      });
    }
  }

  // 方案2：多个师傅分别完成不同品类任务（按品类拆单）
  if (categories.length >= 2) {
    for (let i = 0; i < allWorkers.length; i++) {
      for (let j = i + 1; j < allWorkers.length; j++) {
        const worker1 = allWorkers[i];
        const worker2 = allWorkers[j];

        const categories1 = await getWorkerCategories(worker1.id, categories);
        const categories2 = await getWorkerCategories(worker2.id, categories);

        if (categories1.length > 0 && categories2.length > 0) {
          const cost =
            (await calculateTotalCost(worker1.id, categories1)) +
            (await calculateTotalCost(worker2.id, categories2));
          plans.push({
            type: 'MULTIPLE_WORKERS',
            workers: [worker1, worker2],
            cost: cost,
            workerCount: 2,
            avgScore: (worker1.rating + worker2.rating) / 2,
            categories: [...categories1, ...categories2],
          });
        }
      }
    }
  }

  // 按成本排序
  plans.sort((a, b) => a.cost - b.cost);

  // 按师傅评分排序（成本相同时）
  plans.forEach((plan) => {
    const avgScore =
      plan.workers.reduce((sum, worker) => sum + worker.rating, 0) / plan.workers.length;
    plan.avgScore = avgScore;
  });

  plans.sort((a, b) => {
    if (a.cost !== b.cost) {
      return a.cost - b.cost;
    }
    return b.avgScore - a.avgScore;
  });

  // 标记前3个为推荐方案
  plans.forEach((plan, index) => {
    plan.isRecommended = index < 3;
  });

  return plans;
}
```

#### 推荐方案示例

假设报价单包含：窗帘（2个窗户）、墙布（3面墙）

可用师傅：

- 张师傅：[CURTAIN_MEASURE, WALLCLOTH_MEASURE]，单价100元/次，评分4.5
- 李师傅：[CURTAIN_MEASURE]，单价80元/次，评分4.0
- 王师傅：[WALLCLOTH_MEASURE]，单价90元/次，评分4.2

推荐方案：

| 方案  | 师傅          | 品类              | 成本  | 平均评分 | 是否推荐 |
| :---- | :------------ | :---------------- | :---- | :------- | -------- |
| 方案1 | 张师傅        | 窗帘+墙布（合并） | 200元 | 4.5      | ✅ 推荐  |
| 方案2 | 李师傅+王师傅 | 窗帘+墙布（拆分） | 170元 | 4.1      | ✅ 推荐  |
| 方案3 | 李师傅+张师傅 | 窗帘+墙布（拆分） | 180元 | 4.25     | ✅ 推荐  |
| 方案4 | 李师傅+王师傅 | 窗帘+墙布（拆分） | 170元 | 4.1      | -        |

**推荐结果**：方案2（成本最低）

### 2. 派单员手动调整拆单

#### 调整操作

派单员可以执行以下调整操作：

| 操作             | 说明                     | 示例                             |
| :--------------- | :----------------------- | -------------------------------- |
| **添加师傅**     | 在方案中添加新师傅       | 方案1只有张师傅，添加李师傅      |
| **移除师傅**     | 从方案中移除师傅         | 方案2有李师傅+王师傅，移除王师傅 |
| **替换师傅**     | 替换方案中的师傅         | 将李师傅替换为赵师傅             |
| **调整品类分配** | 调整师傅负责的品类       | 张师傅负责窗帘，改为负责墙布     |
| **合并品类**     | 将多个品类合并到一个师傅 | 将窗帘和墙布合并给张师傅         |
| **拆分品类**     | 将一个品类拆分给多个师傅 | 将窗帘拆分给李师傅和王师傅       |

#### 合并品类逻辑

```typescript
// 派单员合并品类
async function mergeCategories(
  planId: string,
  workerId: string,
  categories: string[]
): Promise<void> {
  const plan = await db.query.quoteSplitPlans.findFirst({
    where: eq(quoteSplitPlans.id, planId),
  });

  // 验证师傅是否具备所有品类的技能
  const worker = await db.query.users.findFirst({
    where: eq(users.id, workerId),
    with: {
      skills: true,
    },
  });

  const workerSkills = worker.skills.map((s) => s.skill_code);
  for (const category of categories) {
    const skillCode = `MEASURE_${category}`;
    if (!workerSkills.includes(skillCode)) {
      throw new Error(`师傅不具备${category}的测量技能`);
    }
  }

  // 重新分配品类
  const categoryWorkerMap: Record<string, string> = {};
  categoryWorkerMap[categories.join(',')] = workerId;

  // 重新计算成本
  const newCost = await calculateTotalCost(workerId, categories);

  // 更新拆单方案
  await db
    .update(quoteSplitPlans)
    .set({
      worker_ids: [workerId],
      total_cost: newCost,
      worker_count: 1,
      avg_score: worker.rating,
    })
    .where(eq(quoteSplitPlans.id, planId));
}
```

#### 调整逻辑

```typescript
// 派单员手动调整拆单方案
async function adjustSplitPlan(planId: string, adjustments: Adjustment[]): Promise<void> {
  const plan = await db.query.quoteSplitPlans.findFirst({
    where: eq(quoteSplitPlans.id, planId),
  });

  // 应用调整
  for (const adjustment of adjustments) {
    switch (adjustment.type) {
      case 'ADD_WORKER':
        // 添加师傅
        plan.worker_ids.push(adjustment.worker_id);
        plan.worker_count++;
        plan.total_cost += adjustment.cost;
        break;

      case 'REMOVE_WORKER':
        // 移除师傅
        const index = plan.worker_ids.indexOf(adjustment.worker_id);
        if (index > -1) {
          plan.worker_ids.splice(index, 1);
          plan.worker_count--;
          plan.total_cost -= adjustment.cost;
        }
        break;

      case 'REPLACE_WORKER':
        // 替换师傅
        const oldIndex = plan.worker_ids.indexOf(adjustment.old_worker_id);
        if (oldIndex > -1) {
          plan.worker_ids[oldIndex] = adjustment.new_worker_id;
          plan.total_cost = plan.total_cost - adjustment.old_cost + adjustment.new_cost;
        }
        break;

      case 'MERGE_CATEGORIES':
        // 合并品类
        await mergeCategories(planId, adjustment.worker_id, adjustment.categories);
        break;

      case 'SPLIT_CATEGORIES':
        // 拆分品类
        await splitCategories(planId, adjustment.categories, adjustment.worker_ids);
        break;
    }
  }

  // 重新计算平均评分
  const workers = await db.query.users.findMany({
    where: inArray(users.id, plan.worker_ids),
  });
  const avgScore = workers.reduce((sum, worker) => sum + worker.rating, 0) / workers.length;
  plan.avg_score = avgScore;

  // 更新拆单方案
  await db.update(quoteSplitPlans).set(plan).where(eq(quoteSplitPlans.id, planId));
}
```

### 3. 确认拆单并生成测量任务

```typescript
// 确认拆单方案并生成测量任务
async function confirmSplitPlan(
  quoteId: string,
  planId: string,
  dispatcherId: string
): Promise<void> {
  const quote = await db.query.quotes.findFirst({
    where: eq(quotes.id, quoteId),
    with: {
      items: true,
    },
  });

  // 检查是否已拆单
  if (quote.is_split) {
    throw new Error('该报价单已拆单');
  }

  const plan = await db.query.quoteSplitPlans.findFirst({
    where: eq(quoteSplitPlans.id, planId),
  });

  // 获取师傅列表
  const workers = await db.query.users.findMany({
    where: inArray(users.id, plan.worker_ids),
  });

  // 按品类分配师傅
  const categoryWorkerMap = await assignWorkersToCategories(workers, quote.items);

  // 为每个品类创建测量任务
  for (const [category, worker] of Object.entries(categoryWorkerMap)) {
    const measureTask = await db.insert(measureTasks).values({
      id: generateUUID(),
      quote_id: quoteId,
      category: category, // 支持多个品类，逗号分隔
      worker_id: worker.id,
      status: 'PENDING_DISPATCH',
      created_at: new Date(),
    });

    // 复制对应品类的商品明细
    const categoryItems = quote.items.filter((item) => {
      const taskCategories = category.split(',');
      return taskCategories.includes(item.category);
    });

    for (const item of categoryItems) {
      await db.insert(measureTaskItems).values({
        id: generateUUID(),
        measure_task_id: measureTask.id,
        quote_item_id: item.id,
        product_id: item.product_id,
        product_name: item.product_name,
        quantity: item.quantity,
      });
    }
  }

  // 更新报价单拆单状态
  await db
    .update(quotes)
    .set({
      is_split: true,
      split_at: new Date(),
      split_by: dispatcherId,
    })
    .where(eq(quotes.id, quoteId));
}
```

## 界面设计

### 1. 拆单推荐页面

```
┌─────────────────────────────────────────────────────┐
│ 拆单推荐                                     │
├─────────────────────────────────────────────────────┤
│ 报价单：QT20260101001                     │
│ 品类：窗帘、墙布                           │
│ 商品数：5件                                │
├─────────────────────────────────────────────────────┤
│ 推荐方案：                                   │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 方案1（推荐）                        │      │
│ ├─────────────────────────────────────────────┤      │
│ │ 师傅：张师傅                          │      │
│ │ 品类：窗帘、墙布（合并）               │      │
│ │ 成本：200元                            │      │
│ │ 评分：4.5星                            │      │
│ ├─────────────────────────────────────────────┤      │
│ │ [选择此方案]  [调整]                 │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 方案2（推荐）                        │      │
│ ├─────────────────────────────────────────────┤      │
│ │ 师傅：李师傅+王师傅                  │      │
│ │ 品类：窗帘、墙布（拆分）               │      │
│ │ 成本：170元                            │      │
│ │ 评分：4.1星                            │      │
│ ├─────────────────────────────────────────────┤      │
│ │ [选择此方案]  [调整]                 │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ [查看更多方案]  [自定义方案]                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 2. 调整拆单方案弹窗

```
┌─────────────────────────────────────────────────────┐
│ 调整拆单方案                                 │
├─────────────────────────────────────────────────────┤
│ 当前方案：                                   │
│ 师傅：张师傅                                  │
│ 品类：窗帘、墙布（合并）                   │
│ 成本：200元                                    │
├─────────────────────────────────────────────────────┤
│ 调整操作：                                   │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 添加师傅：                                 │      │
│ │ [选择师傅 ▼]  [添加]                 │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 替换师傅：                                 │      │
│ │ 原师傅：张师傅 → 新师傅：[选择 ▼]    │      │
│ │ [替换]                                   │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 合并品类：                                 │      │
│ │ 选择师傅：[张师傅 ▼]                   │      │
│ │ 品类：[✓ 窗帘] [✓ 墙布] [ 墙纸 ]     │      │
│ │ [合并]                                   │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 拆分品类：                                 │      │
│ │ 选择品类：[窗帘 ▼]                     │      │
│ │ 拆分给：[李师傅 ▼] [王师傅 ▼]       │      │
│ │ [拆分]                                   │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ [取消]  [保存]                                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 3. 确认拆单弹窗

```
┌─────────────────────────────────────────────────────┐
│ 确认拆单                                     │
├─────────────────────────────────────────────────────┤
│ 已选择方案：                                   │
│ 师傅：李师傅+王师傅                          │
│ 品类：窗帘、墙布（拆分）                   │
│ 成本：170元                                    │
│                                                     │
│ 生成的测量任务：                               │
│ ┌─────────────────────────────────────────────┐      │
│ │ 测量任务1：窗帘测量                    │      │
│ │ 师傅：李师傅                          │      │
│ │ 商品：2件                                │      │
│ ├─────────────────────────────────────────────┤      │
│ │ 测量任务2：墙布测量                    │      │
│ │ 师傅：王师傅                          │      │
│ │ 商品：3件                                │      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ [确认拆单]  [取消]                          │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 业务规则

### 1. 拆单规则

- **唯一性**：一个报价单只能拆单一次
- **完整性**：所有商品必须分配到测量任务
- **技能匹配**：师傅必须具备对应品类的技能
- **成本优化**：优先推荐成本最低的方案
- **默认拆单**：默认按品类拆单，每个品类生成一个测量任务

### 2. 合并品类规则

- **技能验证**：合并品类前，必须验证师傅是否具备所有品类的技能
- **成本计算**：合并品类后，成本按师傅的单价计算（不累加）
- **适用场景**：同一空间的不同品类、师傅具备多种技能、减少上门次数

### 3. 调整规则

- **可逆性**：调整操作可以撤销
- **实时计算**：调整后实时重新计算成本
- **技能验证**：添加/替换师傅时验证技能匹配
- **合并/拆分**：支持合并品类和拆分品类

### 4. 确认规则

- **二次确认**：确认前显示详细信息
- **不可撤销**：确认后无法撤销拆单
- **自动通知**：确认后自动通知师傅

## 通知机制

| 触发事件       | 通知对象 | 渠道        | 内容             |
| :------------- | :------- | :---------- | ---------------- |
| 系统推荐方案   | 派单员   | 系统        | 有新拆单推荐方案 |
| 派单员调整方案 | 派单员   | 系统        | 拆单方案已调整   |
| 派单员合并品类 | 派单员   | 系统        | 品类已合并       |
| 确认拆单       | 师傅     | 小程序+短信 | 有新测量任务     |
| 拆单失败       | 派单员   | 系统        | 拆单失败，请重试 |

## 注意事项

1. **数据一致性**：拆单后报价单和测量任务的数据必须保持一致
2. **技能匹配**：确保师傅具备对应品类的技能
3. **成本准确**：标准价必须准确，避免计算错误
4. **用户体验**：界面设计要简洁明了，操作要流畅
5. **合并品类**：合并品类时要验证师傅技能，避免技能不匹配
6. **拆单粒度**：默认按品类拆单，派单员可以根据实际情况合并品类

## 联系人

如有疑问，请联系：

- 技术负责人：[姓名]
- 产品负责人：[姓名]
- 数据库管理员：[姓名]
