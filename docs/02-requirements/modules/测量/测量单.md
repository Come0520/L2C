# 测量单模块需求 (Measurement)

## 1. 模块概述 (Module Overview)

| 属性 | 说明 |
|:---|:---|
| **模块名称** | 测量单 (Measure Task / Measure Sheet) |
| **核心价值** | L2C 链路中真实数据的源头，决定报价准确性和生产规格 |
| **目标用户** | 测量师傅、派单员、销售人员、店长 |
| **上游模块** | 线索、报价单 |
| **下游模块** | 报价单 (尺寸数据) |

## 2. 业务场景 (Business Scenario)

测量单是整个 L2C 链路中真实数据的源头。测量师傅手持卷尺或激光测距仪，在客户装修现场对每一个窗户进行实地测量。这些数据直接决定了后续报价的准确性和工厂生产的规格。

## 2. 核心字段定义 (Field Definitions)

### 2.1 基础信息

| 字段名 (DB/TS) | 类型 | 说明 |
| :--- | :--- | :--- |
| lead_id | UUID | 关联线索 ID (Source) |
| measure_no | String | 测量单号 (例: MS20251230001) |
| measured_by | UUID | 执行测量的师傅 ID |
| status | Enum | 状态: DRAFT (草稿), PENDING_REVIEW (待审), CONFIRMED (已确认) |
| check_in_time | DateTime | 测量师现场打卡时间 (用于考核履约准时率) |
| check_in_location | JSON | 打卡位置坐标 (Lat/Long/Address) |
| round | Integer | 测量轮次 (1=首次, 2=二次上门...) |
| variant | String | 方案分支 (A, B, C...) |
| version_display | String | 版本展示号 (例: V1.A, V2.A) |
| parent_id | UUID | 若为新版本，关联上一个版本的 ID |

## 3. 状态流转 (State Machine)

测量模块涉及"任务 (Task)"和"数据 (Sheet)"两个维度的状态。

### 3.1 测量任务 (Measure Task)
负责人员调度与进度履约。

| 状态名 | 说明 | 触发动作 |
| :--- | :--- | :--- |
| **待分配 (PENDING)** | 初始状态，等待派单。 | 线索转化/手动创建 |
| **分配中 (DISPATCHING)** | 已指派具体测量师，等待接单。 | 派单员选择测量师并点击"指派" |
| **待上门 (PENDING_VISIT)** | 测量师已接单，等待上门。 | 测量师点击"接单" |
| **待确认 (PENDING_CONFIRM)** | 测量已完成（数据已提交），等待销售确认。 | **数据驱动**: 测量师提交了 Measure Sheet (Confirmed)。 |
| **已完成 (COMPLETED)** | 销售确认数据无误，流程结束。 | 销售点击"确认" |
| **已取消 (CANCELLED)** | 任务终止。 | 销售取消预约 |

#### 状态回滚/驳回机制 (Rollback / Reject)

系统支持在特定状态下将任务驳回至上一状态，便于处理异常情况。

```mermaid
graph LR
    A[待分配] --> B[分配中]
    B --> C[待上门]
    C --> D[待确认]
    D --> E[已完成]
    
    D -.->|驳回: 数据有误| C
    C -.->|驳回: 工人无法上门| B
    B -.->|驳回: 取消指派| A
```

##### 驳回规则

| 当前状态 | 可驳回至 | 触发场景 | 操作人 |
|:---|:---|:---|:---|
| **待确认** | 待上门 | 销售发现数据有误，要求重测 | 销售 |
| **待上门** | 分配中 | 工人临时有事无法上门 | 工人/派单员 |
| **分配中** | 待分配 | 工人拒绝接单 / 派单员取消指派 | 工人/派单员 |

##### 驳回操作规范
*   **必填驳回原因**: 每次驳回必须填写原因，记录到操作日志
*   **关联数据处理**:
    *   从"待确认"驳回到"待上门"时，关联的 Measure Sheet 状态重置为 `DRAFT`
*   **通知机制**: 驳回后自动通知相关人员（销售/工人/派单员）
*   **驳回次数限制**: 同一任务累计驳回次数 ≥ 3 次时，自动升级预警给店长

### 3.2 测量数据 (Measure Sheet)
负责数据的录入与版本控制。

| 状态名 | 说明 | 触发动作 |
| :--- | :--- | :--- |
| **草稿 (DRAFT)** | 测量师现场录入中，可反复修改。 | 测量师开始录入 |
| **已确认 (CONFIRMED)** | 测量师提交数据，**不可再修改**。 | **数据驱动**: 必填字段校验通过 + 上传现场照片。 |
| **已归档 (ARCHIVED)** | 因重测产生的历史旧版本。 | 新版本 (Round + 1) 生效时自动归档。 |

## 4. 窗户测量明细 (Measurement Items)

存储在独立关联表或主表的 items (JSONB) 中：

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| room_name | String | 空间名称 (例: 主卧、次卧、客厅) |
| window_type | Enum | 窗型: STRAIGHT (直窗), L_SHAPE (L型), U_SHAPE (U型), ARC (弧形) |
| width | Decimal | 窗洞宽度 (mm) |
| height | Decimal | 窗洞高度 (mm) |
| install_type | Enum | 安装方式: TOP (顶装), SIDE (侧装) |
| bracket_dist | Decimal | 支架离地高度 (mm) |
| wall_material | Enum | 墙体材质: CONCRETE, WOOD, GYPSUM (影响安装打孔工艺) |
| has_box | Boolean | 是否有窗帘盒 |
| box_depth | Decimal | 窗帘盒深度 (mm) |
| is_electric | Boolean | 是否预留电机电源 |

### 2.3 附件与多媒体

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| site_photos | JSONB | 包含多个 OSS URL 的数组 |
| sketch_map | String | 师傅手绘草图的 OSS URL (可选) |

## 3. 业务规则 (Business Rules)

*   **创建规则 (Creation Rules)**:
    *   **多任务支持**: 一个线索可关联 **多个** 测量任务 (1:N)。
        *   **场景**: 窗帘和墙布由不同师傅测量；或分批次已测量。
    *   **直接创建**: 允许直接填写信息建立测量预约。
    *   **报价单转化**: 必须从"报价单 (Quote)"点击"预约测量"生成，保持上下文关联。
    *   **拆单机制**: 派单员接收到任务时，系统给出推荐拆单方案，派单员手动调整后确认拆单。
        *   **拆单触发**: 派单员在报价单详情页点击"预约测量"时触发拆单。
        *   **系统推荐**: 系统根据品类和师傅技能自动推荐拆单方案（优先推荐成本最低的方案）。
        *   **手动调整**: 派单员可以添加/移除/替换师傅，调整品类分配。
        *   **拆单粒度**: 按品类拆单（窗帘、墙布、墙纸等），每个品类生成一个测量任务。
        *   **唯一性**: 一个报价单只能拆单一次，拆单后报价单状态标记为已拆单。
*   **数据完整性**:
    *   每个"空间"必须至少录入一组 width 和 height。
    *   L型或U型窗必须录入转角分段尺寸。
*   **图片约束**: 每一个窗户明细必须关联至少一张现场实景照片，以便后期复核安装环境（如是否有暖气片遮挡）。
*   **状态流转**:
    *   DRAFT 状态下师傅可以随时修改。
    *   提交至 CONFIRMED 后，师傅端不可修改，系统自动通知销售员进行"报价"。
*   **现场考核 (On-site Check)**:
    *   师傅到达现场必须点击"签到打卡"。系统自动校验 `check_in_time` 与 `appointment_time`，判定是否迟到。
    *   打卡位置需在客户地址方圆 500m 内为有效。
*   **多版本体系 (Advanced Versioning)**: 系统支持 `Round (轮次)` + `Variant (方案)` 的双层版本控制。
    *   **场景 1：多方案 (Alternative Options)**: 
        *   同一个窗户，师傅可提交多种安装建议（例如：V1.A 建议顶装，V1.B 建议侧装）。
        *   **报价策略**: 支持针对不同方案分别生成报价单。
            *   **约束**: 一个报价单 (Quote) 只能关联一个测量方案 (Variant)。
            *   **能力**: 一个测量任务可对应多个测量方案 (Variant A, B)。
            *   **高阶比价**:
                *   针对同一个 **Variant A**，销售还可以创建 **多份报价单** (Quote A1-高配, Quote A2-低配)。
                *   **关系**: `1 Measure Variant` -> `N Quotes`。
                *   **场景**: 尺寸相同，但选品不同（进口布 vs 国产布）。
    *   **场景 2：重测/迭代 (Re-measurement)**:
        *   若方案不满意或需二次上门，生成新轮次 (V2.A)。
    *   **场景 2：重测/迭代 (Re-measurement)**:
        *   若方案不满意或需二次上门，生成新轮次 (V2.A)。
        *   历史轮次 (V1.x) 自动归档，仅作查看。
*   **费用准入机制 (Fee Gatekeeping)**:
    *   **默认**: 线索必须包含 "已支付" 的定金订单 (类型=EARNEST_MONEY) 才能发起测量。
    *   **豁免**: 支持发起 "免费测量审批流"，Approved 后可跳过检查。
    *   **开关**: 租户配置 `ENABLE_MEASURE_FEE_CHECK`。
*   **数据引用**:
    *   测量单仅作为 "数据源"，报价单可选择性关联并导入。不强制绑定。

## 4. 多端表现规范 (Terminal Behavior)

### 4.1 小程序端 (核心作业端)

*   **极简录入**: 采用大按钮设计，方便师傅在工地佩戴手套或单手操作。
*   **拍照优化**: 调用微信相机权限，并在上传前自动压缩图片，减少流量消耗。

#### 离线能力 (Offline Capability)
考虑工地网络环境复杂（地下室、偏远小区等），小程序需具备完整的离线作业能力。

##### 可离线缓存的数据
| 数据类型 | 缓存策略 | 说明 |
|:---|:---|:---|
| **待办任务列表** | 登录时同步 | 最多缓存 10 个待执行任务 |
| **客户基础信息** | 随任务同步 | 姓名/电话/地址 |
| **测量草稿** | 实时自动保存 | 每次输入自动暂存 LocalStorage |
| **拍摄照片** | 本地暂存 | 原图暂存，待联网后压缩上传 |

##### 离线操作限制
*   **可办理**: 新建测量草稿、录入尺寸、拍照、现场签到 (缓存 GPS)
*   **不可办理**: 最终提交确认、查看历史订单、接收新任务

##### 同步机制
1.  **检测网络恢复**: 使用微信 `onNetworkStatusChange` API 监听
2.  **自动队列上传**: 网络恢复后，按"时间先后"顺序上传待同步数据
3.  **进度反馈**: 显示"正在同步 (2/5)"进度条
4.  **失败重试**: 单项上传失败自动重试 3 次，仍失败则标红提示手动处理

##### 冲突解决策略
*   **时间戳优先**: 若同一条数据在离线期间被服务端修改，以**最后修改时间**为准
*   **草稿保护**: 本地草稿永不自动覆盖，若有冲突则弹窗提示用户选择"保留本地/使用服务端/合并"
*   **日志记录**: 冲突情况写入操作日志，便于问题排查

### 4.2 Web 端 (后台管理端)

*   **数据复核**: 店长可在 PC 端通过大图查看师傅上传的照片，比对录入尺寸是否合理。
*   **一键转报价**: 提供按钮直接跳转至 `03_quote` 模块，并自动带入尺寸参数。

## 5. 异常场景处理 (Error Handling)

*   **尺寸极端值**: 若输入的宽度 > 10,000mm 或高度 > 6,000mm，系统需弹出强提示询问"是否输入有误"。
*   **上传失败**: 图片上传 OSS 失败时，必须在界面显示红色警告，并提供"重试"按钮，防止数据丢失。

## 6. 界面设计 (UI Design)

### 6.1 列表页 (Measure Task List)

#### 展示字段
| 字段 | 宽度 | 说明 |
|:---|:---|:---|
| 测量单号 | 130px | 可点击跳转 |
| 客户 | 100px | 姓名+电话 |
| 地址 | 150px | 截断显示 |
| 状态 | 80px | 状态标签 |
| 测量师 | 80px | - |
| 预约时间 | 130px | - |
| 操作 | 150px | 按钮组 |

#### Tab 分组
| Tab | 说明 |
|:---|:---|
| 待分配 | 需要派单 |
| 待上门 | 今日/明日待办 |
| 待确认 | 待销售复核 |
| 已完成 | 历史记录 |

#### 筛选条件
| 筛选项 | 组件 | 说明 |
|:---|:---|:---|
| 日期范围 | `DateRangePicker` | 预约日期 |
| 状态 | `Select` | 全部状态 |
| 测量师 | `Select` | 派单员可见全部 |
| 销售 | `Select` | 店长可见 |

#### 操作按钮
| 按钮 | 条件 | 说明 |
|:---|:---|:---|
| **指派** | 待分配 | 选择测量师、预约时间 |
| **确认数据** | 待确认 | 销售确认 |
| **驳回重测** | 待确认 | 销售驳回 |
| **转报价** | 已完成 | 生成报价单 |

### 6.2 详情页 (Measure Task Detail)

#### 页面布局
```
┌─────────────────────────────────────────────────────┐
│ 测量单详情 #MS20260101001         [确认] [转报价]   │
├──────────────────────┬──────────────────────────────┤
│ 客户信息             │ 状态进度条                   │
│ 姓名/电话/地址       │ [分配→上门→确认→完成]       │
├──────────────────────┼──────────────────────────────┤
│ 派单信息             │ 测量版本切换                 │
│ 师傅/预约时间        │ [V1.A] [V1.B] [V2.A]         │
├──────────────────────┴──────────────────────────────┤
│ 测量明细 (空间列表 + 窗户尺寸)                       │
├─────────────────────────────────────────────────────┤
│ 现场照片 (分组展示)                                  │
├─────────────────────────────────────────────────────┤
│ 操作日志 / 驳回记录                                  │
└─────────────────────────────────────────────────────┘
```

#### 测量明细区
使用 `Collapse` 组件按空间分组：

| 空间级字段 | 组件 | 说明 |
|:---|:---|:---|
| 空间名称 | `Input` | 客厅/主卧等 |
| 窗型 | `Select` | 直窗/L型/U型等 |
| 是否有窗帘盒 | `Switch` | - |
| 是否预留电源 | `Switch` | - |

| 窗户级字段 | 组件 | 说明 |
|:---|:---|:---|
| 宽度 | `InputNumber` | mm |
| 高度 | `InputNumber` | mm |
| 安装方式 | `Radio` | 顶装/侧装 |
| 支架离地 | `InputNumber` | mm |
| 墙体材质 | `Select` | 混凝土/木质/石膏 |

#### 现场照片区
使用 `Image.PreviewGroup` 组件：
*   按空间分组
*   支持放大查看
*   显示拍摄时间

### 6.3 小程序端界面

#### 任务列表
*   卡片式布局
*   显示客户/地址/预约时间
*   一键导航按钮

#### 测量录入
*   大按钮设计 (适配手套操作)
*   语音输入尺寸 (可选)
*   实时保存草稿

#### 签到打卡
*   获取 GPS
*   显示距离客户地址距离
*   超过 500m 提示异常

## 7. 权限控制 (Permission Matrix)

### 7.1 页面级权限

| 页面 | 测量师 | 派单员 | 销售 | 店长 |
|:---|:---|:---|:---|:---|
| 任务列表 | ✓ (本人) | ✓ (全部) | ✓ (本人) | ✓ |
| 任务详情 | ✓ (本人) | ✓ | ✓ (本人) | ✓ |
| 数据录入 | ✓ (本人) | ✗ | ✗ | ✗ |

### 7.2 按钮级权限

| 操作 | 测量师 | 派单员 | 销售 | 店长 |
|:---|:---|:---|:---|:---|
| 指派 | ✗ | ✓ | ✗ | ✓ |
| 接单 | ✓ | ✗ | ✗ | ✗ |
| 签到 | ✓ | ✗ | ✗ | ✗ |
| 录入数据 | ✓ | ✗ | ✗ | ✗ |
| 提交数据 | ✓ | ✗ | ✗ | ✗ |
| 确认数据 | ✗ | ✗ | ✓ | ✓ |
| 驳回重测 | ✗ | ✓ | ✓ | ✓ |
| 转报价 | ✗ | ✗ | ✓ | ✓ |

### 7.3 数据范围权限

| 角色 | 可见范围 |
|:---|:---|
| 测量师 | 分配给自己的任务 |
| 派单员 | 全部任务 |
| 销售 | 自己线索关联的任务 |
| 店长 | 本店全部任务 |

## 8. 通知与提醒 (Notifications)

| 触发事件 | 通知对象 | 渠道 | 内容 |
|:---|:---|:---|:---|
| 测量任务创建 | 派单员 | 系统+飞书 | 有新测量任务待派单 |
| 指派成功 | 测量师 | 小程序+短信 | 有新测量任务 |
| 测量师接单 | 销售 | 系统 | 测量师已接单 |
| 测量师签到 | 销售 | 系统 | 测量师已到达现场 |
| 数据提交 | 销售 | 系统+飞书 | 测量完成待确认 |
| 确认/驳回 | 测量师 | 系统 | 数据已确认/需重测 |
| 今日任务提醒 | 测量师 | 小程序 | 今日有 N 个测量任务 |

## 9. 与其他模块的关联 (Module Relations)

| 模块 | 关联方式 | 数据流向 |
|:---|:---|:---|
| **线索** | MeasureTask.lead_id → Lead.id | 线索 → 测量 |
| **报价单** | Quote.measure_variant_id → MeasureVariant.id | 测量 → 报价 |
| **对账单-劳务** | 完成后生成测量费结算 | 测量 → 对账 |
| **数据报表** | 效率分析、准时率 | 测量 → 报表 |
