# 测量模块差异分析报告

**分析时间**: 2026-01-16  
**分析人**: Antigravity AI  
**需求文档**: `docs/02-requirements/modules/测量/测量单.md`  
**架构文档**: `docs/02-requirements/modules/测量/2026-01-14-measure-module-architecture-design.md`  
**API文档**: `docs/04-api/02-modules/measurement.md`

---

## 执行摘要 (Executive Summary)

本报告对测量模块的需求文档与实际代码实现进行了全面审计。测量模块在数据库schema和基础架构方面已基本搭建完成，但在**业务逻辑完整性**、**UI/UX实现**、**API功能覆盖**方面存在**显著差距**。

**总体完成度估算**: **40-45%**

**主要问题**:

- ✅ 数据库Schema基本完整 (~85%)
- ⚠️ 核心业务逻辑部分实现 (~40%)
- ⚠️ UI/UX骨架完成但细节缺失 (~45%)
- ⚠️ API功能覆盖不足 (~60%)
- ❌ 多端支持(小程序)未实现 (0%)
- ❌ 离线能力未实现 (0%)

---

## 数据分析进度

### 正在收集以下数据

- [x] 需求文档分析
- [x] 数据库Schema检查
- [x] API Actions实现检查
- [ ] UI组件完整性检查 (进行中)
- [ ] 移动端实现检查
- [ ] 集成测试覆盖检查

---

## 一、数据库Schema差异分析

### 1.1 `measure_tasks` 表

| 字段需求 (需求文档)               | Schema实现 (service.ts)      | 状态 | 说明                                                  |
| :-------------------------------- | :--------------------------- | :--: | :---------------------------------------------------- |
| `measure_no` (测量单号)           | ✅ `measureNo`               |  ✅  | 已实现                                                |
| `lead_id` (关联线索)              | ✅ `leadId`                  |  ✅  | 已实现                                                |
| `customer_id` (关联客户)          | ✅ `customerId`              |  ✅  | 已实现                                                |
| `measured_by` (测量师傅)          | ✅ `assignedWorkerId`        |  ✅  | 字段名不同但功能一致                                  |
| `status` (状态枚举)               | ✅ `status`                  |  ✅  | 已实现                                                |
| `check_in_time` (签到时间)        | ✅ `checkInAt`               |  ✅  | 字段名略有不同                                        |
| `check_in_location` (打卡位置)    | ✅ `checkInLocation` (JSONB) |  ✅  | 已实现                                                |
| `round` (测量轮次)                | ✅ `round`                   |  ✅  | 已实现                                                |
| `variant` (方案分支 A/B/C)        | ❌ **缺失**                  |  ❌  | **未在`measure_tasks`表实现，仅在`measure_sheets`表** |
| `version_display` (版本展示号)    | ❌ **缺失**                  |  ❌  | **未实现**                                            |
| `parent_id` (关联上一版本)        | ❌ **缺失**                  |  ❌  | **未实现**                                            |
| `type` (测量类型)                 | ✅ `type`                    |  ✅  | 已实现 (`measureTypeEnum`)                            |
| `scheduled_at` (预约时间)         | ✅ `scheduledAt`             |  ✅  | 已实现                                                |
| `remark` (备注)                   | ✅ `remark`                  |  ✅  | 已实现                                                |
| `reject_count` (驳回次数)         | ✅ `rejectCount`             |  ✅  | 已实现                                                |
| `reject_reason` (驳回原因)        | ✅ `rejectReason`            |  ✅  | 已实现                                                |
| `is_fee_exempt` (费用豁免)        | ✅ `isFeeExempt`             |  ✅  | 已实现                                                |
| `fee_check_status` (费用检查状态) | ✅ `feeCheckStatus`          |  ✅  | 已实现                                                |
| `fee_approval_id` (审批ID)        | ✅ `feeApprovalId`           |  ✅  | 已实现                                                |

**问题汇总**:

1. ❌ **缺失字段**: `variant` (方案分支)、`version_display`、`parent_id`
2. ⚠️ **设计问题**: 需求文档提到版本控制采用 "Round + Variant" 双层体系，但实际Schema将 `variant` 放在 `measure_sheets` 表而非 `measure_tasks` 表，导致：
   - 无法在任务级别直接标识方案（如V1.A、V1.B）
   - 版本查询和展示逻辑复杂化

### 1.2 `measure_sheets` 表

| 字段需求                 | Schema实现              | 状态 | 说明                              |
| :----------------------- | :---------------------- | :--: | :-------------------------------- |
| `task_id` (关联任务)     | ✅ `taskId`             |  ✅  | 已实现                            |
| `status` (状态)          | ✅ `status`             |  ✅  | 已实现 (DRAFT/CONFIRMED/ARCHIVED) |
| `round` (轮次)           | ✅ `round`              |  ✅  | 已实现                            |
| `variant` (方案 A/B/C)   | ✅ `variant`            |  ✅  | 已实现                            |
| `site_photos` (现场照片) | ✅ `sitePhotos` (JSONB) |  ✅  | 已实现                            |
| `sketch_map` (手绘草图)  | ✅ `sketchMap`          |  ✅  | 已实现                            |

**评估**: ✅ 此表结构完整，符合需求

### 1.3 `measure_items` 表 (测量明细)

| 字段需求                       | Schema实现               | 状态 | 说明   |
| :----------------------------- | :----------------------- | :--: | :----- |
| `room_name` (空间名称)         | ✅ `roomName`            |  ✅  | 已实现 |
| `window_type` (窗型枚举)       | ✅ `windowType`          |  ✅  | 已实现 |
| `width` (宽度)                 | ✅ `width` (Decimal)     |  ✅  | 已实现 |
| `height` (高度)                | ✅ `height` (Decimal)    |  ✅  | 已实现 |
| `install_type` (安装方式)      | ✅ `installType`         |  ✅  | 已实现 |
| `bracket_dist` (支架离地)      | ✅ `bracketDist`         |  ✅  | 已实现 |
| `wall_material` (墙体材质)     | ✅ `wallMaterial`        |  ✅  | 已实现 |
| `has_box` (是否有窗帘盒)       | ✅ `hasBox`              |  ✅  | 已实现 |
| `box_depth` (窗帘盒深度)       | ✅ `boxDepth`            |  ✅  | 已实现 |
| `is_electric` (是否预留电源)   | ✅ `isElectric`          |  ✅  | 已实现 |
| `remark` (备注)                | ✅ `remark`              |  ✅  | 已实现 |
| `segment_data` (L/U型分段数据) | ✅ `segmentData` (JSONB) |  ✅  | 已实现 |

**评估**: ✅ 此表结构完整，符合需求

### 1.4 枚举值对齐检查

| 枚举需求                                   | Schema实现 (`enums.ts`)    | 状态 | 差异              |
| :----------------------------------------- | :------------------------- | :--: | :---------------- |
| **窗型** (STRAIGHT, L_SHAPE, U_SHAPE, ARC) | ✅ `windowTypeEnum`        |  ✅  | 完全一致          |
| **安装方式** (TOP, SIDE)                   | ✅ `installTypeEnum`       |  ✅  | 完全一致          |
| **墙体材质** (CONCRETE, WOOD, GYPSUM)      | ✅ `wallMaterialEnum`      |  ✅  | 完全一致          |
| **任务状态**                               | ⚠️ `measureTaskStatusEnum` |  ⚠️  | 存在差异 (见下表) |

#### 1.4.1 任务状态枚举差异

| 需求文档状态               | Schema实现状态       | 状态 | 说明                          |
| :------------------------- | :------------------- | :--: | :---------------------------- |
| `PENDING` (待分配)         | ✅ `PENDING`         |  ✅  | 一致                          |
| `DISPATCHING` (分配中)     | ✅ `DISPATCHING`     |  ✅  | 一致                          |
| `PENDING_VISIT` (待上门)   | ✅ `PENDING_VISIT`   |  ✅  | 一致                          |
| `PENDING_CONFIRM` (待确认) | ✅ `PENDING_CONFIRM` |  ✅  | 一致                          |
| `COMPLETED` (已完成)       | ✅ `COMPLETED`       |  ✅  | 一致                          |
| `CANCELLED` (已取消)       | ✅ `CANCELLED`       |  ✅  | 一致                          |
| ❌ `PENDING_REVIEW`        | ⚠️ 未定义            |  ⚠️  | **API文档使用但Schema未定义** |
| ❌ `REJECTED`              | ⚠️ 未定义            |  ⚠️  | **API文档使用但Schema未定义** |

**问题**: API文档 (measurement.md) 中使用了 `PENDING_REVIEW` 和 `REJECTED` 状态，但这些状态未在数据库enum中定义。需要对齐。

---

## 二、业务逻辑实现差异分析

### 2.1 核心业务规则实现情况

| 业务规则需求                           | 代码实现位置                            | 实现状态 | 差异说明                   |
| :------------------------------------- | :-------------------------------------- | :------: | :------------------------- |
| **多任务支持** (1线索:N测量任务)       | Schema支持 (外键关系)                   |    ✅    | Schema层面支持             |
| **拆单机制**                           | ❌ 未实现                               |    ❌    | **完全缺失**               |
| **系统推荐拆单方案**                   | ❌ 未实现                               |    ❌    | **完全缺失**               |
| **数据完整性校验**                     | `schemas.ts`                            |    ⚠️    | 仅有基础校验，缺少复杂规则 |
| **图片约束** (每窗户至少1张照片)       | ❌ 未实现                               |    ❌    | **未强制校验**             |
| **现场考核** (签到打卡)                | `mutations.ts: checkInMeasureTask`      |    ⚠️    | 仅保存GPS，未校验距离/时间 |
| **打卡位置校验** (500m范围)            | ❌ 未实现                               |    ❌    | **完全缺失**               |
| **迟到判定**                           | ❌ 未实现                               |    ❌    | **完全缺失**               |
| **多版本体系** (Round+Variant)         | `workflows.ts: createNewMeasureVersion` |    ⚠️    | 仅简化实现，逻辑不完整     |
| **一个报价单只关联一个Variant**        | ❌ 未实现                               |    ❌    | 需在报价模块中实现         |
| **费用准入机制**                       | Schema字段存在                          |    ⚠️    | 字段存在，业务逻辑未实现   |
| **定金订单检查**                       | ❌ 未实现                               |    ❌    | **完全缺失**               |
| **免费测量审批流**                     | ❌ 未实现                               |    ❌    | **完全缺失**               |
| **状态回滚/驳回机制**                  | `workflows.ts: reviewMeasureTask`       |    ⚠️    | 仅支持驳回至PENDING_VISIT  |
| **驳回原因必填**                       | Schema有字段                            |    ⚠️    | 字段存在，未强制校验       |
| **驳回次数≥3预警店长**                 | ❌ 未实现                               |    ❌    | **完全缺失**               |
| **关联数据处理** (驳回时Sheet状态重置) | ❌ 未实现                               |    ❌    | **代码注释TODO，未实现**   |

**严重问题汇总**:

1. ❌ **拆单机制完全缺失**: 需求文档详细描述的派单员拆单、系统推荐、手动调整功能均未实现
2. ❌ **现场考核逻辑缺失**: 签到仅保存GPS,未实现距离校验、迟到判定
3. ❌ **费用准入机制未实现**: 定金检查、审批流程完全缺失
4. ❌ **驳回预警机制未实现**: 累计驳回3次预警逻辑缺失

### 2.2 API Actions实现覆盖度

| API需求 (measurement.md)                   | 实现函数                            | 实现状态 | 差异                 |
| :----------------------------------------- | :---------------------------------- | :------: | :------------------- |
| `POST /tasks` 创建测量任务                 | `mutations.ts: createMeasureTask`   |    ✅    | 已实现               |
| `GET /tasks` 查询任务列表                  | `queries.ts: getMeasureTasks`       |    ✅    | 已实现               |
| `GET /tasks/{id}` 查询任务详情             | `queries.ts: getMeasureTaskById`    |    ✅    | 已实现               |
| `POST /tasks/{id}/dispatch` 指派任务       | `mutations.ts: dispatchMeasureTask` |    ✅    | 已实现               |
| `POST /tasks/{id}/accept` 测量师接单       | `mutations.ts: acceptMeasureTask`   |    ✅    | 已实现               |
| `POST /tasks/{id}/check-in` 现场签到       | `mutations.ts: checkInMeasureTask`  |    ⚠️    | 已实现但缺少校验     |
| `POST /tasks/{id}/submit` 提交测量数据     | `workflows.ts: submitMeasureData`   |    ✅    | 已实现               |
| `POST /tasks/{id}/review` 审核测量数据     | `workflows.ts: reviewMeasureTask`   |    ⚠️    | 已实现但逻辑简化     |
| `POST /tasks/{id}/reject` 驳回测量任务     | ⚠️ 合并在`reviewMeasureTask`        |    ⚠️    | 未单独实现           |
| `POST /tasks/{id}/cancel` 取消测量任务     | ❌ 未实现                           |    ❌    | **完全缺失**         |
| `POST /tasks/{id}/fee-waiver` 费用豁免申请 | ❌ 未实现                           |    ❌    | **完全缺失**         |
| `GET /tasks/{id}/fee-status` 费用状态查询  | ❌ 未实现                           |    ❌    | **完全缺失**         |
| `POST /tasks/{id}/remeasure` 创建复测任务  | ❌ 未实现                           |    ❌    | **完全缺失**         |
| `GET /tasks/{id}/sync` 同步测量数据        | `sync-actions.ts`                   |    ⚠️    | 存在文件但逻辑待确认 |

**API覆盖率**: **约60%** (9/15个核心API)

---

## 三、UI/UX实现差异分析

### 3.1 列表页 (`/service/measurement`)

| UI需求                                                  | 组件实现                     | 实现状态 | 差异                            |
| :------------------------------------------------------ | :--------------------------- | :------: | :------------------------------ |
| **展示字段** (单号/客户/地址/状态/测量师/预约时间/操作) | `measure-task-table.tsx`     |    ✅    | 已完整实现                      |
| **Tab分组** (待分配/待上门/待确认/已完成)               | `measurement-filter-bar.tsx` |    ✅    | **已实现** (使用Tabs组件)       |
| **筛选条件** (日期/状态/测量师/销售)                    | `measurement-filter-bar.tsx` |    ⚠️    | 仅实现搜索框,**缺少日期筛选器** |
| **操作按钮** (指派/确认/驳回/转报价)                    | `measure-task-table.tsx`     |    ⚠️    | 仅实现"指派",**缺少转报价按钮** |
| **分页组件**                                            | `page.tsx` Line 48           |    ❌    | **完全缺失** (注释TODO)         |

### 3.2 详情页 (`/service/measurement/[id]`)

| UI需求                            | 组件实现        | 实现状态 | 差异                            |
| :-------------------------------- | :-------------- | :------: | :------------------------------ |
| **客户信息区**                    | `[id]/page.tsx` |    ✅    | 已实现 (显示客户姓名/地址)      |
| **状态进度条**                    | ❌ 未实现       |    ❌    | **完全缺失** (仅显示Badge)      |
| **测量版本切换** (V1.A/V1.B/V2.A) | ❌ 未实现       |    ❌    | **完全缺失**                    |
| **测量明细** (Collapse按空间分组) | `[id]/page.tsx` |    ⚠️    | 简化实现,**未使用Collapse**     |
| **现场照片** (分组展示+放大)      | `[id]/page.tsx` |    ⚠️    | 仅占位符,**未实现真实图片展示** |
| **操作日志/驳回记录**             | `[id]/page.tsx` |    ⚠️    | 仅显示remark,**无历史记录**     |

### 3.3 对话框组件

| 组件需求           | 文件                                        | 实现状态 | 说明                              |
| :----------------- | :------------------------------------------ | :------: | :-------------------------------- |
| 创建测量任务对话框 | `create-measure-task-dialog.tsx` (5228字节) |    ✅    | 已创建,功能需验证                 |
| 指派对话框         | `dispatch-dialog.tsx` (4643字节)            |    ✅    | 已创建,集成在Table中              |
| 确认/驳回对话框    | `confirm-reject-dialogs.tsx` (4272字节)     |    ✅    | 已创建,功能需验证                 |
| 提交数据对话框     | `submit-data-dialog.tsx` (1623字节)         |    ⚠️    | 已创建,**代码较少可能功能不完整** |

### 3.4 小程序端 (极简录入/离线能力)

| UI需求                    |           实现状态            | 差异         |
| :------------------------ | :---------------------------: | :----------- | -------- |
| **任务列表** (卡片式布局) |              ❌               | **完全缺失** |
| **大按钮设计** (适配手套) |              ❌               | **完全缺失** |
| **语音输入尺寸**          |              ❌               | **完全缺失** |
| **实时保存草稿**          |              ❌               | **完全缺失** |
| **签到打卡界面**          | `gps-check-in.tsx` (1088字节) | ⚠️           | 简化实现 |
| **离线缓存机制**          |              ❌               | **完全缺失** |
| **离线队列上传**          |              ❌               | **完全缺失** |
| **冲突解决策略**          |              ❌               | **完全缺失** |

**小程序端完成度**: **~5%** (仅有基础GPS组件)

---

## 四、关键功能缺失汇总

### 🔴 高优先级缺失 (P0)

1. **拆单机制** (完全缺失)
   - 系统推荐拆单方案
   - 派单员手动调整
   - 按品类拆单
   - 拆单唯一性校验

2. **费用准入机制** (完全缺失)
   - 定金订单检查
   - 免费测量审批流
   - 费用状态查询API

3. **现场考核完整逻辑** (部分缺失)
   - GPS距离校验 (500m)
   - 迟到判定
   - 打卡位置合法性检查

4. **驳回预警机制** (完全缺失)
   - 驳回次数≥3次预警
   - 自动通知店长

5. **小程序端** (完全缺失)
   - 移动端页面
   - 离线能力
   - 数据同步

### 🟡 中优先级缺失 (P1)

6. **版本管理增强**
   - `version_display` 字段
   - `parent_id` 字段
   - 版本切换UI

7. **操作日志**
   - 驳回记录展示
   - 状态变更历史

8. **复测任务创建** (API缺失)

9. **取消任务** (API缺失)

10. **通知机制** (文档有需求，实现待确认)

### 🟢 低优先级缺失 (P2)

11. **图片智能双图** (压缩+原图)

12. **异常值拦截** (黄线/红线双重校验)

13. **语音输入尺寸**

---

## 五、数据质量问题

### 5.1 字段命名不一致

| 需求文档命名    | Schema实现         | 建议                          |
| :-------------- | :----------------- | :---------------------------- |
| `measured_by`   | `assignedWorkerId` | 保持`assignedWorkerId`,更准确 |
| `check_in_time` | `checkInAt`        | 统一为`checkInAt`             |

**评估**: 命名差异属于可接受范围，无需强制修改

### 5.2 API文档与Schema枚举不一致

**问题**: `docs/04-api/02-modules/measurement.md` 使用了 `PENDING_REVIEW` 和 `REJECTED` 状态，但 `enums.ts` 未定义

**解决方案**:

- 方案A: 将API文档改为使用 `PENDING_CONFIRM` 替代 `PENDING_REVIEW`
- 方案B: 在Schema中添加 `PENDING_REVIEW` 和 `REJECTED` 枚举值

**建议**: 采用**方案A**,保持Schema简洁

---

## 六、改进建议优先级

### 第一阶段 (核心功能补齐 - P0)

1. **实现拆单机制**
   - 创建 `splitMeasureTask` API
   - 品类识别逻辑
   - 测量师技能匹配

2. **完善现场考核**
   - GPS距离校验
   - 迟到判定逻辑
   - 打卡失败提示

3. **费用准入功能**
   - 定金订单关联查询
   - 审批流集成
   - 费用状态API

4. **驳回预警机制**
   - 驳回次数监控
   - 自动通知逻辑

### 第二阶段 (UI/UX完善 - P1)

5. **补充缺失的UI组件**
   - Tab分组切换
   - 状态进度条
   - 版本切换器
   - 操作日志

6. **完善对话框功能**
   - 表单校验完整性
   - 错误提示优化

### 第三阶段 (移动端开发 - P0/P1)

7. **小程序端基础功能**
   - 任务列表页
   - 测量录入表单
   - 照片上传

8. **离线能力**
   - 数据缓存策略
   - 队列上传
   - 冲突解决

### 第四阶段 (高级功能 - P2)

9. **智能图片处理**
10. **异常数据拦截**
11. **语音输入**

---

## 七、风险提示

1. **🔴 严重**: 拆单机制缺失将影响多品类业务场景
2. **🔴 严重**: 小程序端缺失导致测量师无法实际使用系统
3. **🟡 高**: 费用准入未实现可能导致免费测量滥用
4. **🟡 高**: 现场考核不完整影响人员履约率统计
5. **🟢 中**: UI组件不完整影响用户体验但不阻塞核心流程

---

## 八、附录

### A. 关键文件清单

**需求文档**:

- `docs/02-requirements/modules/测量/测量单.md`
- `docs/02-requirements/modules/测量/2026-01-14-measure-module-architecture-design.md`
- `docs/04-api/02-modules/measurement.md`

**Schema实现**:

- `src/shared/api/schema/service.ts`
- `src/shared/api/schema/enums.ts`

**业务逻辑**:

- `src/features/service/measurement/actions/mutations.ts`
- `src/features/service/measurement/actions/queries.ts`
- `src/features/service/measurement/actions/workflows.ts`
- `src/features/service/measurement/schemas.ts`

**UI组件**:

- `src/features/service/measurement/components/*`
- `src/app/(dashboard)/service/measurement/page.tsx`
- `src/app/(dashboard)/service/measurement/[id]/page.tsx`

### B. 下一步行动

1. **立即启动**: P0级拆单机制开发
2. **本周完成**: 费用准入和现场考核逻辑
3. **本月目标**: 小程序端MVP上线

---

**报告结束**
