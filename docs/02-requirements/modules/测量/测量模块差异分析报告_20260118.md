# 测量模块差异分析报告 (2026-01-18 更新版)

**分析时间**: 2026-01-18
**分析人**: Antigravity AI
**对比基准**:
- 需求: `docs/02-requirements/modules/测量/测量单.md`
- 现状: `src/features/service/measurement` & `src/shared/api/schema/service.ts`

---

## 执行摘要 (Executive Summary)

相比 2026-01-16 的审计，测量模块在 **数据库Schema** 层面取得了显著进展，**拆单表 (`measure_task_splits`)** 和 **版本控制字段 (`version_display`, `parent_id`)** 已补齐。
然而，**核心业务逻辑** (拆单执行、费用校验、现场考核) 和 **API Actions** 仍未实现。

**总体完成度**: **50-55%** (Schema完成度提升至 95%+)

---

## 一、 已修复的差异 (Fixed Issues)

以下差异在代码中已修复 (相比 01-16 报告):

1.  **[Schema] 拆单表已创建**:
    *   `measure_task_splits` 表已定义，包含 details 如 `originalTaskId`, `newTaskId`, `reason`。
    *   状态: ✅ 已修复

2.  **[Schema] 版本管理字段已添加**:
    *   `measure_tasks` 表已新增 `versionDisplay` 和 `parentId` 字段。
    *   状态: ✅ 已修复

3.  **[Schema] 任务审批状态**:
    *   `measure_tasks.status` 添加了 `PENDING_APPROVAL` 状态，用于支持费用审批流程。
    *   状态: ✅ 已修复

---

## 二、 仍存在的关键差异 (Remaining Discrepancies)

### 2.1 核心业务逻辑 (Business Logic)

| 业务需求 | 现状 | 严重程度 | 说明 |
| :--- | :--- | :--- | :--- |
| **拆单执行 (Split Task)** | ❌ 未实现 | **Critical** | 仅有Schema，缺少 `splitMeasureTask` Action，无法进行拆单操作。 |
| **现场考核 (On-site Check)** | ⚠️ 不完整 | **Critical** | `checkInMeasureTask` 仅更新时间与坐标，**缺失** 距离校验 (Haversine) 和迟到判定逻辑。 |
| **费用准入 (Fee Gate)** | ❌ 未实现 | **Cornerstone** | 缺少 `checkEarnestMoney` (定金检查) 和 `submitFeeWaiver` (豁免申请) 的逻辑实现。 |
| **版本控制 (Versioning)** | ⚠️ 不完整 | **Major** | 虽然字段已加，但 `createNewMeasureVersion` 逻辑未完善，未自动生成 `V1.A` 格式版本号。 |

### 2.2 API 定义 (API)

| API 需求 | 现状 | 说明 |
| :--- | :--- | :--- |
| `POST /tasks/{id}/split` | ❌ 未实现 | 用于执行拆单 |
| `POST /tasks/{id}/fee-waiver`| ❌ 未实现 | 用于申请费用豁免 |
| `POST /tasks/{id}/cancel` | ❌ 未实现 | 用于取消任务 |
| `GET /tasks/{id}/fee-status` | ❌ 未实现 | 前端查询费用准入状态 |

### 2.3 UI/UX

*   **列表页**: 缺少 "日期筛选" 和 "转报价" 按钮。
*   **详情页**: 缺少 "版本切换" 组件。
*   **小程序**: 依然完全缺失 (0%)。

---

## 三、 建议行动计划

鉴于Schema已就绪，接下来的工作应集中在 **Backend Actions** 的实现上。

1.  **Priority 0 (立即执行)**:
    *   实现 `splitMeasureTask` Action。
    *   完善 `checkInMeasureTask` (加入距离计算)。
    *   实现 `checkMeasureFeeStatus` (定金检查)。

2.  **Priority 1**:
    *   完善 UI (筛选、版本切换)。
    *   开发小程序端基础页面。

---
**报告结束**
