# 测量模块整改任务清单

**基于**: 测量模块差异分析报告_20260116  
**计划周期**: 4周 (2026-01-16 至 2026-02-12)  
**总任务数**: 80+ 项  
**目标**: 完成度从 40% 提升至 85%+

---

## 📅 第一周：核心业务逻辑 (P0) - Day 1-7

**目标完成度**: 40% → 55%

### 🔴 拆单机制 (2天)
- [ ] 创建 `measure_task_splits` 表
- [ ] 为报价单添加 `is_split` 标记字段
- [ ] 实现 `analyzeSplitRequirement(quoteId)` - 品类分析
- [ ] 实现 `recommendWorkers(category)` - 师傅推荐
- [ ] 实现 `splitMeasureTask(quoteId, splitPlan)` - 执行拆单
- [ ] 添加拆单唯一性校验
- [ ] 创建 `SplitTaskDialog.tsx` 组件
- [ ] 在报价单详情页添加"预约测量"按钮
- [ ] 显示拆单方案预览表格

### 🔴 费用准入机制 (1.5天)
- [ ] 创建 `fee-checker.ts` 业务逻辑层
- [ ] 实现 `checkEarnestMoney(leadId)` - 定金检查
- [ ] 实现 `applyFeeWaiver(taskId, reason)` - 申请豁免
- [ ] 添加 `checkMeasureFeeStatus(taskId)` API
- [ ] 添加 `requestFeeWaiver(taskId, reason)` API
- [ ] 创建 `FeeWaiverDialog.tsx` 组件
- [ ] 指派时显示费用状态提示
- [ ] 费用未支付时禁用指派按钮

### 🔴 现场考核增强 (1天)
- [ ] 实现 Haversine 距离计算公式
- [ ] 在签到时查询客户地址坐标
- [ ] 计算并记录签到距离 (目标 <500m)
- [ ] 实现迟到判定逻辑 (15分钟阈值)
- [ ] 添加 `isLate` 和 `lateMinutes` 字段
- [ ] 签到成功后显示距离信息
- [ ] 超距离时显示黄色警告
- [ ] 迟到时显示红色标记

### 🔴 驳回预警机制 (0.5天)
- [ ] 在驳回逻辑中添加次数检查
- [ ] 驳回次数≥3时触发通知
- [ ] 创建通知模板 `MEASURE_REJECT_WARNING`
- [ ] 任务详情页显示驳回次数徽章
- [ ] 高频驳回任务标红显示

---

## 📅 第二周：UI/UX完善 (P1) - Day 8-14

**目标完成度**: 55% → 70%

### 🟡 分页与筛选增强 (1天)
- [ ] 引入 `Pagination` 组件到列表页
- [ ] 实现分页URL参数同步 (`?page=2`)
- [ ] 在 `MeasurementFilterBar` 添加 `DateRangePicker`
- [ ] 实现"预约日期"范围筛选
- [ ] 添加快捷日期选项 (今日/本周/本月)
- [ ] 添加"测量师"下拉筛选
- [ ] 添加"销售人员"下拉筛选 (店长可见)

### 🟡 版本管理UI (1.5天)
- [ ] (可选) 为 `measure_tasks` 添加 `version_display` 字段
- [ ] 创建 `VersionSwitcher.tsx` 组件
- [ ] 在详情页顶部显示当前版本
- [ ] 列出所有历史版本
- [ ] 实现版本切换查看功能
- [ ] 添加"创建方案B"按钮
- [ ] 添加"发起复测"按钮
- [ ] 完善 `createNewMeasureVersion` 逻辑
- [ ] 自动归档旧版本为 `ARCHIVED`

### 🟡 操作日志与历史记录 (1天)
- [ ] 查询 `audit_logs` 表获取操作历史
- [ ] 筛选测量任务相关日志
- [ ] 创建 `OperationTimeline.tsx` 组件
- [ ] 实现时间轴布局
- [ ] 驳回记录特殊标红显示
- [ ] 在详情页底部集成时间线

### 🟢 状态进度条 (0.5天)
- [ ] 创建 `StatusProgressBar.tsx` 组件
- [ ] 定义状态步骤流程
- [ ] 当前步骤高亮显示
- [ ] 已完成步骤显示勾选标记
- [ ] 集成到详情页头部

### 🟡 转报价功能 (0.5天)
- [ ] 列表操作列添加"转报价"按钮
- [ ] 仅 `COMPLETED` 状态显示按钮
- [ ] 实现跳转逻辑 (`/quotes/create?measureTaskId=xxx`)
- [ ] 报价创建页读取测量数据
- [ ] 自动预填充客户信息和尺寸

---

## 📅 第三周：小程序端开发 (P0) - Day 15-21

**目标完成度**: 70% → 85%

### 🔴 小程序任务列表页 (1.5天)
- [ ] 创建 `src/app/(mobile)/measure/page.tsx`
- [ ] 实现卡片式布局
- [ ] 展示客户姓名、电话、预约时间、地址
- [ ] 添加状态徽章
- [ ] 实现筛选Tab (待接单/待上门/已完成)
- [ ] 默认展示"待上门"
- [ ] 实现"一键导航"功能
- [ ] 调用微信 `openLocation` API

### 🔴 测量数据录入表单 (2天)
- [ ] 创建 `[id]/submit/page.tsx`
- [ ] 设计大按钮界面 (高度 56px)
- [ ] 实现步骤1: 选择空间
- [ ] 实现步骤2: 选择窗型
- [ ] 实现步骤3: 输入宽高 (NumberInput)
- [ ] 实现步骤4: 选填安装方式/墙体材质
- [ ] 实现步骤5: 上传现场照片 (≥1张)
- [ ] 支持添加多个空间
- [ ] 使用 `localStorage` 保存草稿
- [ ] 实现每次输入自动保存
- [ ] 调用微信 `chooseImage` API
- [ ] 实现前端图片压缩 (目标 500KB)
- [ ] 上传照片到OSS
- [ ] 显示上传进度条

### 🔴 签到打卡增强 (0.5天)
- [ ] 完善 `gps-check-in.tsx` 组件
- [ ] 调用微信 `getLocation` API
- [ ] 显示当前距离客户地址距离
- [ ] 超过500m显示黄色警告
- [ ] 签到成功后显示绿色提示

### 🔴 离线能力基础版 (2天)
- [ ] 引入 `IndexedDB` 库
- [ ] 实现任务列表离线缓存 (最新10个)
- [ ] 缓存客户基础信息
- [ ] 离线时可正常录入数据
- [ ] 数据暂存在待同步队列
- [ ] 监听微信 `onNetworkStatusChange`
- [ ] 网络恢复后自动触发上传
- [ ] 显示同步进度提示 (2/5)
- [ ] 失败项标红并支持手动重试
- [ ] 服务端添加版本号检查
- [ ] 冲突时弹窗提示用户
- [ ] 实现"保留本地"/"使用服务端"选项

---

## 📅 第四周：集成测试与优化 (P2) - Day 22-28

**目标完成度**: 85% → 90%+

### 🟢 E2E测试 (2天)
- [ ] 编写完整测量流程E2E测试
  - [ ] 销售创建测量任务
  - [ ] 费用准入检查
  - [ ] 派单员指派测量师
  - [ ] 测量师接单
  - [ ] 测量师现场签到 (GPS校验)
  - [ ] 测量师录入数据并提交
  - [ ] 销售审核确认
  - [ ] 转报价单
- [ ] 编写拆单流程E2E测试
  - [ ] 创建包含多品类的报价单
  - [ ] 系统推荐拆单
  - [ ] 派单员调整并确认
  - [ ] 验证生成独立任务
- [ ] 编写驳回流程E2E测试
  - [ ] 销售驳回测量数据
  - [ ] 验证状态回退
  - [ ] 验证驳回次数+1
  - [ ] 第3次驳回时验证通知
- [ ] 编写离线流程E2E测试
  - [ ] 测量师断网
  - [ ] 离线录入数据
  - [ ] 恢复网络
  - [ ] 验证自动同步成功
- [ ] 修复发现的Bug
- [ ] 验证所有流程可端到端运行

### 🟢 性能优化 (1天)
- [ ] 添加数据库复合索引 `(tenant_id, status, scheduled_at)`
- [ ] 优化分页查询避免全表扫描
- [ ] 列表页使用缩略图 (150x150)
- [ ] 详情页懒加载高清图
- [ ] 移除未使用代码 (Tree-shaking)
- [ ] 小程序图片sprite合并
- [ ] 验证列表加载时间 <1秒
- [ ] 验证小程序包体积 <2MB

### 🟢 文档与培训 (1天)
- [ ] 编写销售端操作指南
- [ ] 编写测量师端操作指南
- [ ] 编写派单员操作指南
- [ ] 更新API接口文档
- [ ] 编写数据库Schema说明文档
- [ ] 编写离线同步机制说明文档
- [ ] 为关键操作添加截图说明

---

## ✅ 验收标准

### 功能验收
- [ ] 核心API全部实现 (15/15个)
- [ ] Web端UI/UX完善 (90%+)
- [ ] 小程序端基础功能可用 (80%+)
- [ ] E2E测试通过率 >95%

### 性能验收
- [ ] 列表页加载 <1秒
- [ ] 图片上传成功率 >95%
- [ ] 离线同步成功率 >90%

### 文档验收
- [ ] 操作手册完整
- [ ] API文档更新
- [ ] 技术架构文档齐全

---

## 📊 进度跟踪

| 阶段 | 计划完成日期 | 预期完成度 | 实际完成度 | 状态 |
|:---|:---|:---:|:---:|:---:|
| 第一周 | 2026-01-23 | 55% | - | ⏳ 待启动 |
| 第二周 | 2026-01-30 | 70% | - | ⏳ 待启动 |
| 第三周 | 2026-02-06 | 85% | - | ⏳ 待启动 |
| 第四周 | 2026-02-12 | 90%+ | - | ⏳ 待启动 |

---

## 🚨 风险提示

- **拆单逻辑**: 第一周完成后立即与业务方验证
- **离线同步**: 实现版本号机制防止冲突
- **GPS定位**: 允许500m误差，记录但不阻塞
- **测量师培训**: 小程序上线前需提供操作培训

---

**文档链接**:
- [完整整改计划](./测量模块整改计划_20260116.md)
- [差异分析报告](./测量模块差异分析报告_20260116.md)
