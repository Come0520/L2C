# 测量模块整改计划

**制定时间**: 2026-01-16  
**基于**: [测量模块差异分析报告\_20260116.md](./测量模块差异分析报告_20260116.md)  
**当前完成度**: 40-45%  
**目标完成度**: 85%+

---

## 一、整改目标

### 1.1 总体目标

> 在**4周内**将测量模块从**40%**完成度提升至**85%**，实现核心业务流程完全可用，确保测量师可在小程序端正常作业，销售可在Web端完成全流程管理。

### 1.2 分阶段目标

| 阶段       | 时间      | 完成度目标 | 核心里程碑                          |
| :--------- | :-------- | :--------: | :---------------------------------- |
| **第一周** | Day 1-7   |    55%     | 拆单机制、费用准入、现场考核增强    |
| **第二周** | Day 8-14  |    70%     | UI/UX完善、分页、日期筛选、版本管理 |
| **第三周** | Day 15-21 |    85%     | 小程序端MVP、离线能力基础版         |
| **第四周** | Day 22-28 |    90%+    | 集成测试、Bug修复、性能优化         |

---

## 二、第一周：核心业务逻辑补齐 (P0)

**时间**: Day 1-7  
**负责人**: 待指定  
**目标完成度**: 40% → 55%

### 2.1 拆单机制实现 (2天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 2人天  
**依赖**: 品类枚举、师傅技能表

#### 实现任务

- [ ] **数据库增强**
  - [ ] 创建 `measure_task_splits` 表 (存储拆单记录)
    ```sql
    CREATE TABLE measure_task_splits (
      id UUID PRIMARY KEY,
      quote_id UUID REFERENCES quotes(id),
      parent_task_id UUID REFERENCES measure_tasks(id),
      category VARCHAR(50), -- CURTAIN, WALLPAPER, etc.
      created_at TIMESTAMPTZ DEFAULT NOW()
    );
    ```
  - [ ] 为报价单添加 `is_split` 标记字段

- [ ] **业务逻辑**
  - [ ] 创建 `src/features/service/measurement/actions/split.ts`
  - [ ] 实现 `analyzeSplitRequirement(quoteId)` - 品类分析
  - [ ] 实现 `recommendWorkers(category)` - 师傅推荐算法
  - [ ] 实现 `splitMeasureTask(quoteId, splitPlan)` - 执行拆单
  - [ ] 添加拆单唯一性校验 (一个报价单只能拆一次)

- [ ] **UI组件**
  - [ ] 创建 `SplitTaskDialog.tsx` (拆单确认对话框)
  - [ ] 在报价单详情页添加"预约测量"按钮
  - [ ] 显示拆单方案预览表格

**验收标准**:

- 能根据报价单商品品类自动推荐拆单方案
- 派单员可手动调整拆单结果
- 拆单后生成多个独立测量任务
- 重复拆单时抛出错误提示

---

### 2.2 费用准入机制 (1.5天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 1.5人天  
**依赖**: 审批模块、订单模块

#### 实现任务

- [ ] **业务逻辑**
  - [ ] 创建 `src/features/service/measurement/domain/fee-checker.ts`
  - [ ] 实现 `checkEarnestMoney(leadId)` - 定金检查
    - 查询线索关联的订单
    - 筛选类型为 `EARNEST_MONEY` 且已支付的订单
    - 返回是否满足准入条件
  - [ ] 实现 `applyFeeWaiver(taskId, reason)` - 申请豁免
    - 创建审批流实例
    - 关联测量任务
    - 更新 `feeApprovalId` 字段

- [ ] **API Actions**
  - [ ] 在 `mutations.ts` 添加 `checkMeasureFeeStatus(taskId)`
  - [ ] 在 `mutations.ts` 添加 `requestFeeWaiver(taskId, reason)`
  - [ ] 在指派任务前调用费用检查

- [ ] **UI组件**
  - [ ] 创建 `FeeWaiverDialog.tsx` (豁免申请对话框)
  - [ ] 在指派时显示费用状态提示
  - [ ] 费用未支付时禁用指派按钮，提示"需支付定金或申请豁免"

**验收标准**:

- 未支付定金的线索无法直接指派测量师
- 可发起免费测量审批流程
- 审批通过后允许指派
- 费用状态在任务详情页清晰展示

---

### 2.3 现场考核增强 (1天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 1人天  
**依赖**: 客户地址坐标

#### 实现任务

- [ ] **GPS距离校验**
  - [ ] 在 `checkInMeasureTask` 中添加距离计算
    ```typescript
    function calculateDistance(lat1, lng1, lat2, lng2): number {
      // Haversine公式
    }
    ```
  - [ ] 查询客户地址坐标 (如无坐标，跳过校验)
  - [ ] 距离 > 500m 时返回警告但允许签到
  - [ ] 记录签到距离到 `checkInLocation.distance`

- [ ] **迟到判定**
  - [ ] 比较 `checkInAt` 和 `scheduledAt`
  - [ ] 迟到超过15分钟标记为 `isLate: true`
  - [ ] 添加 `lateMinutes` 字段记录迟到分钟数

- [ ] **UI反馈**
  - [ ] 签到成功后显示距离信息
  - [ ] 超过500m显示黄色警告提示
  - [ ] 迟到时显示红色迟到标记

**验收标准**:

- 签到时自动计算距离并记录
- 超距离/迟到时有明确提示
- 数据可用于后续履约率统计

---

### 2.4 驳回预警机制 (0.5天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 0.5人天  
**依赖**: 通知中心

#### 实现任务

- [ ] **业务逻辑**
  - [ ] 在 `reviewMeasureTask` (驳回分支) 中添加检查
    ```typescript
    if (newRejectCount >= 3) {
      await notifyManager(taskId, 'MEASURE_REJECT_WARNING');
    }
    ```
  - [ ] 创建通知模板 `MEASURE_REJECT_WARNING`

- [ ] **UI展示**
  - [ ] 任务详情页显示驳回次数徽章
  - [ ] 驳回次数≥3时标红显示

**验收标准**:

- 第3次驳回时自动通知店长
- 驳回历史记录可查询
- 高频驳回任务醒目标记

---

## 三、第二周：UI/UX完善与版本管理 (P1)

**时间**: Day 8-14  
**负责人**: 待指定  
**目标完成度**: 55% → 70%

### 3.1 分页与筛选增强 (1天)

**优先级**: 🟡 P1 - 高  
**工作量**: 1人天

#### 实现任务

- [ ] **分页组件**
  - [ ] 引入 `Pagination` 组件
  - [ ] 在 `page.tsx` 替换注释 `{/* Pagination TODO */}`
  - [ ] 传递 `page`, `totalPages` 参数
  - [ ] URL参数同步 (`?page=2`)

- [ ] **日期筛选器**
  - [ ] 在 `MeasurementFilterBar` 添加 `DateRangePicker`
  - [ ] 支持筛选 "预约日期" 范围
  - [ ] 添加快捷选项：今日、本周、本月

- [ ] **高级筛选**
  - [ ] 添加"测量师"下拉选择
  - [ ] 添加"销售人员"下拉选择 (店长可见)

**验收标准**:

- 列表支持分页浏览
- 可按日期范围筛选任务
- 筛选条件可组合使用

---

### 3.2 版本管理UI (1.5天)

**优先级**: 🟡 P1 - 高  
**工作量**: 1.5人天

#### 实现任务

- [ ] **数据库修改** (可选优化)
  - [ ] 为 `measure_tasks` 添加 `version_display` 计算字段
    ```sql
    ALTER TABLE measure_tasks ADD COLUMN version_display VARCHAR(20);
    -- 自动生成如: V1.A, V2.B
    ```

- [ ] **UI组件**
  - [ ] 创建 `VersionSwitcher.tsx` (版本切换器)
  - [ ] 在详情页顶部显示当前版本 (如 V1.A)
  - [ ] 列出所有历史版本，支持切换查看
  - [ ] 创建新方案按钮 ("创建方案B")
  - [ ] 创建新轮次按钮 ("发起复测")

- [ ] **业务逻辑增强**
  - [ ] 完善 `createNewMeasureVersion` 逻辑
  - [ ] 自动归档旧版本为 `ARCHIVED`
  - [ ] 实现版本对比功能 (可选)

**验收标准**:

- 可创建同一轮次的多个方案 (A/B/C)
- 可发起复测生成新轮次版本
- 历史版本只读展示

---

### 3.3 操作日志与历史记录 (1天)

**优先级**: 🟡 P1 - 高  
**工作量**: 1人天

#### 实现任务

- [ ] **利用审计日志**
  - [ ] 查询 `audit_logs` 表获取操作历史
  - [ ] 筛选 `entity_type = 'measure_task'` 且 `entity_id = taskId`
  - [ ] 按时间倒序展示

- [ ] **UI组件**
  - [ ] 创建 `OperationTimeline.tsx` (操作时间线)
  - [ ] 在详情页底部显示
  - [ ] 样式参考：时间轴布局，左侧时间，右侧操作内容
  - [ ] 驳回记录特殊标红显示

**验收标准**:

- 可查看任务的完整状态变更历史
- 驳回原因清晰展示
- 操作人和时间准确记录

---

### 3.4 状态进度条 (0.5天)

**优先级**: 🟢 P2 - 中  
**工作量**: 0.5人天

#### 实现任务

- [ ] **UI组件**
  - [ ] 创建 `StatusProgressBar.tsx`
  - [ ] 步骤：待分配 → 分配中 → 待上门 → 待确认 → 已完成
  - [ ] 当前步骤高亮显示
  - [ ] 已完成步骤显示勾选标记

**验收标准**:

- 视觉化展示任务进度
- 状态变化直观易懂

---

### 3.5 转报价功能 (0.5天)

**优先级**: 🟡 P1 - 高  
**工作量**: 0.5人天

#### 实现任务

- [ ] **UI按钮**
  - [ ] 在列表操作列添加"转报价"按钮
  - [ ] 仅 `status = COMPLETED` 时显示
  - [ ] 点击后跳转到报价创建页，并自动带入测量数据

- [ ] **数据传递**
  - [ ] URL参数: `/quotes/create?measureTaskId=xxx`
  - [ ] 报价创建页自动读取测量明细
  - [ ] 预填充客户信息和尺寸数据

**验收标准**:

- 测量完成后可一键转报价
- 测量数据自动带入报价单

---

## 四、第三周：小程序端开发 (P0)

**时间**: Day 15-21  
**负责人**: 待指定  
**目标完成度**: 70% → 85%

### 4.1 小程序任务列表页 (1.5天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 1.5人天

#### 实现任务

- [ ] **页面创建**
  - [ ] 创建 `src/app/(mobile)/measure/page.tsx`
  - [ ] 卡片式布局，展示：
    - 客户姓名、电话
    - 预约时间
    - 地址 (带"导航"按钮)
    - 任务状态徽章

- [ ] **筛选Tab**
  - [ ] 待接单 / 待上门 / 已完成
  - [ ] 默认展示"待上门"

- [ ] **一键导航**
  - [ ] 调用微信 `openLocation` API
  - [ ] 传递客户地址经纬度

**验收标准**:

- 测量师可在小程序查看自己的任务列表
- 可按状态筛选
- 可一键导航到客户地址

---

### 4.2 测量数据录入表单 (2天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 2人天

#### 实现任务

- [ ] **页面创建**
  - [ ] 创建 `src/app/(mobile)/measure/[id]/submit/page.tsx`
  - [ ] 大按钮设计 (高度 56px，适配手套操作)
  - [ ] 使用 `NumberInput` 组件录入尺寸

- [ ] **录入流程**
  - [ ] 步骤1: 选择空间 (客厅/主卧/次卧...)
  - [ ] 步骤2: 选择窗型 (直窗/L型/U型/弧形)
  - [ ] 步骤3: 输入宽度、高度 (单位mm)
  - [ ] 步骤4: 选填项 (安装方式/墙体材质等)
  - [ ] 步骤5: 上传现场照片 (必传≥1张)
  - [ ] 支持添加多个空间

- [ ] **实时保存**
  - [ ] 使用 `localStorage` 保存草稿
  - [ ] 每次输入自动触发保存
  - [ ] 页面刷新后可恢复草稿

- [ ] **照片上传**
  - [ ] 调用微信相机 `chooseImage`
  - [ ] 前端压缩 (目标 500KB)
  - [ ] 上传到OSS
  - [ ] 显示上传进度

**验收标准**:

- 测量师可在小程序录入测量数据
- 草稿自动保存，防止数据丢失
- 照片上传成功率 >95%

---

### 4.3 签到打卡增强 (0.5天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 0.5人天

#### 实现任务

- [ ] **完善 `gps-check-in.tsx`**
  - [ ] 调用微信 `getLocation` API
  - [ ] 显示当前距离客户地址距离
  - [ ] 超过500m显示黄色警告但允许签到
  - [ ] 签到成功后显示绿色提示

**验收标准**:

- 测量师到现场可一键签到
- 距离信息清晰展示

---

### 4.4 离线能力基础版 (2天)

**优先级**: 🔴 P0 - 严重  
**工作量**: 2人天

#### 实现任务

- [ ] **离线数据缓存**
  - [ ] 使用 `IndexedDB` 存储待办任务列表
  - [ ] 登录时同步最新10个任务到本地
  - [ ] 缓存客户基础信息

- [ ] **离线录入**
  - [ ] 离线时可正常录入数据
  - [ ] 数据暂存在 `IndexedDB` 的待同步队列

- [ ] **网络恢复同步**
  - [ ] 监听微信 `onNetworkStatusChange`
  - [ ] 网络恢复后自动触发上传队列
  - [ ] 显示"正在同步 (2/5)"进度提示
  - [ ] 失败项标红，支持手动重试

- [ ] **冲突处理**
  - [ ] 服务端添加版本号检查
  - [ ] 冲突时弹窗提示："服务端数据已更新，是否覆盖？"
  - [ ] 提供"保留本地" / "使用服务端" 选项

**验收标准**:

- 无网络时可离线录入
- 网络恢复后自动同步
- 同步成功率 >90%
- 冲突有明确提示

---

## 五、第四周：集成测试与优化 (P2)

**时间**: Day 22-28  
**负责人**: 待指定  
**目标完成度**: 85% → 90%+

### 5.1 E2E测试 (2天)

#### 测试场景

- [ ] **完整测量流程**
  1. 销售创建测量任务
  2. 费用准入检查
  3. 派单员指派测量师
  4. 测量师接单
  5. 测量师现场签到 (GPS校验)
  6. 测量师录入数据并提交
  7. 销售审核确认
  8. 转报价单

- [ ] **拆单流程**
  1. 创建包含窗帘+墙布的报价单
  2. 点击"预约测量"
  3. 系统推荐拆分为2个任务
  4. 派单员调整后确认
  5. 验证生成2个独立任务

- [ ] **驳回流程**
  1. 销售驳回测量数据
  2. 任务状态回退至"待上门"
  3. 驳回次数+1
  4. 第3次驳回时通知店长

- [ ] **离线流程**
  1. 测量师断网
  2. 离线录入数据
  3. 恢复网络
  4. 自动同步成功

**验收标准**:

- 所有核心流程可端到端运行
- 无阻塞性Bug
- 用户体验流畅

---

### 5.2 性能优化 (1天)

#### 优化项

- [ ] **列表查询优化**
  - [ ] 添加复合索引: `(tenant_id, status, scheduled_at)`
  - [ ] 分页查询避免全表扫描

- [ ] **图片加载优化**
  - [ ] 列表页使用缩略图 (150x150)
  - [ ] 详情页懒加载高清图

- [ ] **小程序包体积**
  - [ ] Tree-shaking 移除未使用代码
  - [ ] 图片sprite合并

**验收标准**:

- 列表加载时间 <1秒
- 小程序包体积 <2MB

---

### 5.3 文档与培训 (1天)

#### 交付文档

- [ ] **操作手册**
  - [ ] 销售端操作指南
  - [ ] 测量师端操作指南
  - [ ] 派单员操作指南

- [ ] **技术文档**
  - [ ] API接口文档更新
  - [ ] 数据库Schema说明
  - [ ] 离线同步机制说明

**验收标准**:

- 文档完整清晰
- 关键操作有截图说明

---

## 六、资源规划

### 6.1 人力需求

| 角色             | 人数  | 时间投入      | 主要职责              |
| :--------------- | :---: | :------------ | :-------------------- |
| **后端工程师**   |  1人  | 全职4周       | 业务逻辑、API、数据库 |
| **前端工程师**   |  1人  | 全职4周       | Web端UI/UX            |
| **小程序工程师** |  1人  | 2周 (第3-4周) | 小程序开发、离线能力  |
| **测试工程师**   |  1人  | 1周 (第4周)   | E2E测试、Bug修复      |
| **产品经理**     | 0.5人 | 兼职全程      | 需求澄清、验收        |

**总人天估算**: 约 **80人天**

---

### 6.2 技术栈

- **后端**: Next.js Server Actions, Drizzle ORM, PostgreSQL
- **前端**: React, TypeScript, Shadcn UI, Tailwind CSS
- **小程序**: 微信小程序, TypeScript, IndexedDB
- **测试**: Playwright (E2E), Jest (单元测试)

---

## 七、风险管理

### 7.1 技术风险

| 风险             | 影响 | 概率 | 应对策略                       |
| :--------------- | :--- | :--: | :----------------------------- |
| 离线同步冲突频繁 | 高   |  中  | 实现版本号机制，提供冲突合并UI |
| GPS定位不准确    | 中   |  高  | 允许500m误差，记录但不阻塞     |
| 小程序包体积超限 | 低   |  低  | 代码分包，按需加载             |

### 7.2 业务风险

| 风险                   | 影响 | 概率 | 应对策略                     |
| :--------------------- | :--: | :--: | :--------------------------- |
| 拆单逻辑与实际业务不符 |  高  |  中  | 第一周完成后立即与业务方验证 |
| 测量师不习惯小程序操作 |  中  |  中  | 提供培训，优化UI易用性       |
| 费用准入规则变化       |  低  |  低  | 配置化设计，易于调整         |

---

## 八、验收标准

### 8.1 功能验收

- [x] 数据库Schema完整 (已完成85%)
- [ ] 核心API全部实现 (目标100%)
- [ ] Web端UI/UX完善 (目标90%)
- [ ] 小程序端基础功能可用 (目标80%)
- [ ] E2E测试通过率 >95%

### 8.2 性能验收

- [ ] 列表页加载 <1秒
- [ ] 图片上传成功率 >95%
- [ ] 离线同步成功率 >90%

### 8.3 文档验收

- [ ] 操作手册完整
- [ ] API文档更新
- [ ] 技术架构文档齐全

---

## 九、下一步行动

### 立即启动 (本周内)

1. ✅ **评审本计划** - 与产品、技术团队对齐
2. 🔴 **分配人力** - 指定负责人和协作人员
3. 🔴 **创建任务看板** - 按周拆分任务到项目管理工具
4. 🔴 **第一周启动会** - 明确拆单机制、费用准入的具体实现方案

### 每周检查点

- **周一晨会**: 同步本周目标和任务分配
- **周五复盘**: 检查完成度，识别风险，调整计划
- **关键决策**: 遇到技术/业务分歧时召集相关方会议决策

---

## 十、附录

### A. 参考文档

- [测量模块差异分析报告\_20260116.md](./测量模块差异分析报告_20260116.md)
- [测量单模块需求.md](./测量单.md)
- [测量模块架构设计.md](./2026-01-14-measure-module-architecture-design.md)
- [API文档 - measurement.md](../../../04-api/02-modules/measurement.md)

### B. 术语表

| 术语         | 说明                                         |
| :----------- | :------------------------------------------- |
| **拆单**     | 将一个报价单按品类拆分为多个测量任务         |
| **费用准入** | 测量前需满足定金支付或审批豁免               |
| **版本体系** | Round (轮次) + Variant (方案) 的组合版本管理 |
| **离线能力** | 小程序在无网络时可继续录入，网络恢复后同步   |

---

**计划制定人**: Antigravity AI  
**待审批**: 产品负责人、技术负责人  
**最后更新**: 2026-01-16
