# 渠道管理模块 (Channels) 需求规格说明

## 1. 业务概述
渠道管理模块 (Channels) 用于管理与企业进行分销或代理合作的外部组织/个人。它支撑了完整的 B2B 或 B2B2C 商业闭环，涵盖了从渠道生命周期管理到复杂的佣金/底价结算引擎。此模块必须满足最高级别的财务一致性和安全权限审计规范 (L5)。

## 2. 渠道生命周期
- **注册与审批**：新增渠道为 `PENDING`，经管理层审核后流转为 `ACTIVE` 或 `REJECTED`。
- **关联线索与订单**：开启或已激活的渠道可持续绑定新线索并在成单后产生佣金池数据。
- **层级依赖**：支持父子级渠道拓扑（如省代 -> 市代），禁用上级将触发下级级联验证。不支持直接删除带有有效下级的渠道节点以防数据孤岛。

## 3. 分佣机制与计算规则 (Commission Engine)
本模块支持两套平行的计价模式，订单发生或变更时，底层引擎自动重算利润与分成金额：

### 3.1. 比例返佣模式 (`COMMISSION`)
- **固定比例 (Fixed)**：基于订单销售额 (totalAmount) 乘以事先约定的固定千分/百分点。
- **阶梯抽成 (Tiered)**：引擎支持根据订单总额的阶梯门槛 (`minAmount` -> `maxAmount`) 动态匹配最合适的计算率。

### 3.2. 底价赚差价模式 (`BASE_PRICE`)
面向大 B 端加盟商。渠道方享受特定的全局等级折扣（如 S级 9折，A级 9.5折）。
- 基于平台产品的出库指导渠道底价 (`channelPrice`) * 等级折扣 = 渠道进货成本
- 基于实际成交卖价 (`unitPrice`) - 渠道进货成本 = 渠道所获代理毛利润

> **注意**：发生“全额/部分退款”时，引擎支持 `Clawback（佣金扣回）` 机制：对待结算的直接作废 (`VOID`)，对已结算的将会在下次账单中插入负向冲正记录 (`commissionAdjustment`) 确保资金无外流。

## 4. 结算单与财务打通 (Settlement & Finance)
零散的佣金明细按账期或阈值打包汇聚为**结算单 (Settlement)**：
1. **DRAFT/PENDING**：操作员圈定期数内的未结算佣金创建单据（此时支持人为增减 `adjustmentAmount`），提交审批。
2. **APPROVED**：财务/高管基于**职责分离制**（自己不能审批自己发起的单据）进行审查。一旦通过，利用 DB 事务原子性生成并推流至应付账款 (`paymentBills`)。
3. **PAID**：打款成功后最终流转并解绑状态。
