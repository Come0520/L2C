# 监控通知（Monitoring）模块需求文档

> 版本：v1.0 | 创建日期：2026-02-21 | 状态：L4 升级完成

---

## 1. 模块概述

监控通知模块负责系统内的通知发送、偏好管理、告警规则配置。
本模块为上层封装层，核心通知发送引擎位于 `features/notifications` 模块。

- **模块路径**：`src/features/monitoring/`
- **核心文件**：
  - `notification-actions.ts` — 通知操作（重新导出 + createNotification 类型映射）
  - `preference-actions.ts` — 用户通知偏好 CRUD
  - `actions/alert-rules.ts` — 告警规则管理 + 批量通知 + 通知模板
  - `components/notification-bell.tsx` — 小铃铛 UI 组件

---

## 2. 业务场景

| 场景 | 说明 |
|------|------|
| 即时通知 | 系统事件触发即时通知（订单创建、审批完成等） |
| 通知偏好 | 用户自定义各类通知的接收渠道（站内/短信/飞书/微信） |
| 告警规则 | 管理员配置自动告警条件（超时/库存不足等） |
| 批量通知 | 向指定角色组群发通知（系统维护/公告等） |

---

## 3. 通知类型映射

`createNotification` 的 `type` 参数使用简化分类，内部自动映射：

| 输入类型 | 映射为 | 说明 |
|----------|--------|------|
| `INFO` (默认) | `SYSTEM` | 普通信息通知 |
| `WARNING` | `ALERT` | 警告级别通知 |
| `ERROR` | `ALERT` | 错误级别通知 |

---

## 4. 告警规则系统

### 4.1 触发条件

| 条件代码 | 说明 | 参数 |
|----------|------|------|
| `ORDER_OVERDUE` | 订单超时未处理 | `thresholdDays` |
| `APPROVAL_PENDING` | 审批待处理超时 | `thresholdDays` |
| `PAYMENT_DUE` | 付款到期 | `thresholdDays` |
| `INVENTORY_LOW` | 库存不足 | `thresholdDays` |
| `CUSTOM` | 自定义条件 | `thresholdDays` |

### 4.2 通知模板

预设 5 种通知模板，支持 `{count}` 和 `{days}` 变量替换：

| 模板 | 标题 | 内容模板 |
|------|------|----------|
| `ORDER_OVERDUE` | ⚠️ 订单超时提醒 | 您有 {count} 个订单已超过 {days} 天未处理 |
| `APPROVAL_PENDING` | 📋 审批待处理提醒 | 您有 {count} 个审批已等待超过 {days} 天 |
| `PAYMENT_DUE` | 💰 付款到期提醒 | 有 {count} 笔付款将在 {days} 天内到期 |
| `INVENTORY_LOW` | 📦 库存不足预警 | {count} 种商品库存低于安全线 |
| `CUSTOM` | 🔔 自定义告警 | 通用告警内容 |

### 4.3 告警引擎数据映射

当前监控模块不具有独立的实体表，它直接依靠底层**溯源与风控防线**中的 `riskAlerts` 表作为数据源支撑：
- `riskAlerts.riskType` 映射对应告警规则的条件。
- `riskAlerts.title` 映射为告警规则的名称。
- `riskAlerts.status` 映射规则开关状态（`OPEN` 为开启，`IGNORED` 为关闭）。
- `riskAlerts.affectedCount` 映射阈值天数（用于超期告警条件）。
- 该映射实现不仅避免了数据冗余，也让告警引擎无缝契合全局风控体系。

---

## 5. API 说明

### 通知操作

| 函数 | 权限 | 说明 |
|------|------|------|
| `getMyNotifications` | 已登录 | 获取当前用户通知（支持分页） |
| `markNotificationAsRead` | 已登录（仅本人） | 标记通知为已读 |
| `getUnreadCount` | 已登录 | 获取未读通知数量 |
| `createNotification` | `notification.manage` | 创建通知（含类型映射） |

### 偏好管理

| 函数 | 权限 | 说明 |
|------|------|------|
| `getNotificationPreferences` | 已登录 | 获取个人通知偏好 |
| `updateNotificationPreference` | 已登录 | 更新偏好设置（含审计日志） |

### 告警规则

| 函数 | 权限 | 说明 |
|------|------|------|
| `createAlertRule` | `notification.manage` | 创建告警规则 |
| `listAlertRules` | 已登录 | 查询本租户的告警规则 |
| `updateAlertRule` | `notification.manage` | 更新告警规则 |
| `deleteAlertRule` | `notification.manage` | 删除告警规则 |
| `sendBulkNotification` | `notification.manage` | 向角色组批量发送通知 |

---

## 6. 权限矩阵

| 操作 | BOSS | ADMIN | MANAGER | SALES |
|------|------|-------|---------|-------|
| 查看自己通知 | ✅ | ✅ | ✅ | ✅ |
| 管理偏好 | ✅ | ✅ | ✅ | ✅ |
| 创建通知 | ✅ | ✅ | ❌ | ❌ |
| 管理告警规则 | ✅ | ✅ | ❌ | ❌ |
| 批量通知 | ✅ | ✅ | ❌ | ❌ |

---

## 7. 测试覆盖

| 文件 | 覆盖范围 |
|------|----------|
| `__tests__/actions.test.ts` | 基础安全测试（登录/Zod/偏好 CRUD） |
| `__tests__/monitoring-actions.test.ts` | 类型映射、权限、分页、告警规则 CRUD、批量通知 |

运行测试：

```powershell
npx vitest run src/features/monitoring/ --reporter=verbose
```

---

## 8. 扩展点

| 扩展点 | 当前状态 | 说明 |
|--------|----------|------|
| 定时触发引擎 | 骨架实现 | 需接入 cron job 定时检查告警条件并触发 |
| 批量通知用户查询 | TODO | 需查询角色对应用户列表后逐一发送 |
| 通知模板管理 | 硬编码 | 可迁移为数据库配置，支持后台管理 |
| 小铃铛实时推送 | 占位组件 | 需接入 WebSocket/SSE 实现推送 |
