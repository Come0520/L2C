# 租户管理模块需求文档

> 模块路径：`src/features/admin/`  
> 最后更新：2026-02-21

---

## 1. 功能概述

租户管理模块（Admin）为各租户提供内部管理能力，包含三大子模块：

- **师傅管理 (Worker Management)**：CRUD 管理师傅账号，支持启用/禁用
- **角色管理 (Role Management)**：自定义角色和权限配置
- **租户设置 (Tenant Settings)**：租户基本信息修改和安全配置（MFA）

> 注意：本模块管理的是**租户内部**资源，与 Platform（平台管理）模块为不同层级。

---

## 2. 角色权限矩阵

| 功能            | BOSS | admin | manager | 其他 |
|:---------------|:----:|:-----:|:-------:|:----:|
| 师傅列表查看     | ✅   | ✅    | ❌      | ❌   |
| 师傅信息修改     | ✅   | ✅    | ❌      | ❌   |
| 启用/禁用师傅    | ✅   | ✅    | ❌      | ❌   |
| 角色列表查看     | ✅   | ✅    | ❌      | ❌   |
| 角色权限编辑     | ✅   | ✅    | ❌      | ❌   |
| 创建新角色      | ✅   | ✅    | ❌      | ❌   |
| 租户信息修改     | ✅   | ✅    | ❌      | ❌   |
| MFA 配置        | ✅   | ✅    | ❌      | ❌   |

**权限码映射**：
- 师傅管理 → `settings.user` (PERMISSIONS.SETTINGS.USER_MANAGE)
- 角色管理 → `admin.role_manage` (PERMISSIONS.ADMIN.ROLE_MANAGE)
- 租户设置 → `admin.settings` / `admin.tenant` (PERMISSIONS.ADMIN.SETTINGS / TENANT_MANAGE)

---

## 3. 子模块详情

### 3.1 师傅管理

| 功能        | API 函数           | 说明                          |
|:-----------|:-------------------|:-----------------------------|
| 获取列表    | `getWorkers`       | 分页+搜索，按创建时间倒序      |
| 获取详情    | `getWorkerById`    | 按 ID+tenantId 双重过滤       |
| 更新信息    | `updateWorker`     | Zod 校验（id 必须 UUID）+ 审计 |

**安全措施**：
- id 字段使用 `z.string().uuid()` 校验（防路径注入）
- 自禁保护：管理员不能禁用自己的账号
- 所有写操作记录 `AuditService.log`（含旧值/新值）

### 3.2 角色管理

| 功能        | API 函数                  | 说明                      |
|:-----------|:-------------------------|:--------------------------|
| 角色列表    | `getRoles`               | 含关联用户数统计             |
| 创建角色    | `createRole`             | 重名检查 + 至少1个权限       |
| 权限编辑    | `updateRolePermissions`  | 更新后触发 revalidateTag    |

### 3.3 租户设置

| 功能        | API 函数              | 说明                            |
|:-----------|:---------------------|:-------------------------------|
| 获取信息    | `getTenantInfo`      | 返回名称/Logo/联系人/地址        |
| 更新信息    | `updateTenantInfo`   | 手机号正则、邮箱格式校验         |
| MFA 查询   | `getMfaConfig`       | 返回启用状态/适用角色/认证方式    |
| MFA 配置   | `updateMfaConfig`    | 支持 TOTP / SMS 两种方式        |

---

## 4. 数据校验规则

| Schema 名称             | 字段校验                                          |
|:------------------------|:-------------------------------------------------|
| updateWorkerSchema       | `id: uuid`, `isActive/name/phone/avatarUrl: optional` |
| createRoleSchema         | `name: 1~50字`, `permissions: ≥1个`               |
| updateRolePermissionsSchema | `roleId: uuid`, `permissions: ≥1个`            |
| updateTenantInfoSchema   | `name: 1~100字`, `contactPhone: 手机号正则`, `contactEmail: email` |
| updateMfaConfigSchema    | `enabled: boolean`, `method: totp/sms`, `applicableRoles: string[]` |

---

## 5. 安全措施

- **认证 (Auth)**：所有 Action 使用 `createSafeAction` 自动验证 Session
- **RBAC 权限**：通过 `checkPermission` 校验，所有管理操作需 admin 级权限
- **多租户隔离**：所有查询带 `tenantId` 条件
- **输入校验**：UUID 格式、手机号正则、邮箱格式
- **自禁保护**：管理员无法禁用自己的账号
- **审计日志**：所有写操作调用 `AuditService.log`（含旧值/新值差异）
- **缓存失效**：角色权限修改后触发 `revalidateTag('roles')`

---

## 6. API 数据流

### 6.1 租户信息查询流程

```
getTenantInfo(session) 
  → checkPermission(admin.settings)
  → db.query.tenants.findFirst(tenantId)
  → 返回 TenantInfoDTO（id, name, logoUrl, applicantName, applicantPhone, applicantEmail, region, status, createdAt）
```

### 6.2 租户信息更新流程

```
updateTenantInfo(params)
  → createSafeAction(Zod 校验) → checkPermission(admin.tenant)
  → 查询旧值 → db.update(tenants)
  → AuditService.log（含旧值/新值对比）
  → revalidatePath('/admin/settings')
```

### 6.3 MFA 配置流程

```
getMfaConfig(session) → 从 tenants.settings jsonb 读取 mfa 字段
  → 返回 MfaConfigDTO（enabled, applicableRoles, method）
  → 若无配置，返回默认值：{ enabled: false, applicableRoles: [], method: 'totp' }

updateMfaConfig(params)
  → createSafeAction(Zod 校验) → checkPermission(admin.settings)
  → 读取 currentSettings → 合并新 MFA 配置到 settings jsonb
  → AuditService.log → revalidatePath('/admin/settings/security')
```

---

## 7. 错误处理

| 场景 | 错误信息 | HTTP 语义 |
|:---|:---|:---|
| 未登录 | `success: false`（createSafeAction 拦截） | 401 |
| 权限不足 | `权限不足` | 403 |
| 租户不存在 | `租户不存在` | 404 |
| 师傅不存在 | `未找到该师傅` | 404 |
| Zod 校验失败 | `success: false`（含 fieldErrors） | 400 |
| 角色重名 | `角色名称已存在` | 409 |
| 自禁保护 | `不能禁用自己的账号` | 403 |
| 系统角色保护 | `系统内置角色不可修改/删除` | 403 |
| 角色有活跃用户 | `该角色下还有活跃用户，无法删除` | 409 |

---

## 8. 测试覆盖

| 测试文件 | 用例数 | 覆盖范围 |
|:---|:---:|:---|
| `actions.test.ts` | 5 | worker-management 基础安全测试 |
| `admin-actions.test.ts` | 30 | worker + role 全量安全测试（分页、Zod、自禁、审计、系统角色保护） |
| `tenant-settings.test.ts` | 26 | tenant-settings 全量测试（增删改查、MFA、审计） |
| **合计** | **61** | **全部 action 文件 100% 覆盖** |

---

## 9. 待扩展功能（Backlog）

- [ ] 操作日志查看界面（基于 AuditService 数据）
- [ ] 角色模板（预置常用角色权限组合）
- [ ] 批量导入师傅账号
- [ ] 企业微信/钉钉组织架构同步
