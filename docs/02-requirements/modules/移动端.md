# 移动端需求规范（千人千面架构）

> 创建日期：2026-01-19
> 状态：规划中
> 版本：v1.0

---

## 📋 概述

### 核心理念

采用 **"一端多角色"（千人千面）** 架构，开发一个统一的移动端应用，根据用户登录身份动态展示不同的功能模块。

### 目标平台

| 平台       | 优先级 | 技术方案                    |
| ---------- | ------ | --------------------------- |
| 微信小程序 | P0     | uni-app / Taro / 原生       |
| 安卓 App   | P1     | uni-app 导出 / React Native |
| iOS App    | P2     | 同安卓方案                  |

### 用户角色

| 角色          | 说明          | 来源     |
| ------------- | ------------- | -------- |
| **WORKER**    | 测量师/安装师 | 内部员工 |
| **SALES**     | 销售人员      | 内部员工 |
| **BOSS**      | 老板/管理层   | 内部员工 |
| **PURCHASER** | 采购员        | 内部员工 |
| **CUSTOMER**  | 终端客户      | 外部用户 |

---

## 🎨 界面架构

### TabBar 配置（按角色）

```
┌─────────────────────────────────────────────────────────────┐
│  WORKER（工人端）                                              │
│  ├── 📋 任务        # 今日任务、待处理、历史记录                   │
│  ├── 💰 收入        # 工费统计、提现记录                         │
│  └── 👤 我的        # 个人信息、设置                            │
├─────────────────────────────────────────────────────────────┤
│  SALES（销售端）                                               │
│  ├── 👥 客户        # 客户列表、跟进记录                         │
│  ├── 📝 报价        # 快速报价、报价单列表                        │
│  ├── 📊 业绩        # 个人业绩、排行榜                           │
│  └── 👤 我的        # 个人信息、设置                            │
├─────────────────────────────────────────────────────────────┤
│  BOSS（老板端）                                                │
│  ├── 📊 仪表盘      # BI 报表、关键指标                          │
│  ├── ✅ 审批        # 待审批事项、审批历史                        │
│  ├── 🏆 团队        # 员工业绩、排行榜                           │
│  └── 👤 我的        # 个人信息、设置                            │
├─────────────────────────────────────────────────────────────┤
│  PURCHASER（采购端）                                             │
│  ├── 📋 采购池      # 待采购清单、合并采购                         │
│  ├── 📦 物流        # 采购单物流状态跟踪                           │
│  ├── 💬 供应商      # 供应商沟通、问题反馈                          │
│  └── 👤 我的        # 个人信息、设置                            │
├─────────────────────────────────────────────────────────────┤
│  CUSTOMER（客户端）                                            │
│  ├── 📦 订单        # 订单列表、进度追踪                         │
│  ├── 🛠️ 服务        # 预约测量、预约安装                         │
│  └── 👤 我的        # 个人信息、地址管理、评价                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 📱 功能模块详情

### 1. 工人端（WORKER）

> 包含测量师和安装师两种角色

#### 1.1 完整工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│  阶段 1：派单 → 接单前                                             │
│  ├── 📢 收到派工通知（推送）                                        │
│  ├── 📄 查看工作内容（方便判断能否接单）                              │
│  │     ├── 测量师：报价单内容（隐藏价格+型号）                        │
│  │     └── 安装师：订单详情                                         │
│  ├── 💰 查看/协商工费（可"讨价还价"）                                 │
│  └── ✅ 确认接单（或拒绝/转派）                                      │
├─────────────────────────────────────────────────────────────────┤
│  阶段 2：接单后 → 上门前                                            │
│  ├── 📅 收到预约时间变更 → 需确认                                    │
│  ├── 📝 收到备注通知 → 回传"已读"                                    │
│  └── 🗺️ 导航到客户地址                                             │
├─────────────────────────────────────────────────────────────────┤
│  阶段 3：到达现场                                                   │
│  └── 📍 GPS 打卡（确认准时到达）                                     │
├─────────────────────────────────────────────────────────────────┤
│  阶段 4：工作中                                                     │
│  ├── 【测量师】                                                     │
│  │     ├── 📸 拍照（现场环境）                                      │
│  │     ├── 📐 多方案测量（1-N 种安装方案的尺寸）                      │
│  │     ├── ✍️ 填写数据（在报价单基础上补充尺寸）                      │
│  │     ├── 🎬 上传视频（复杂场景录制）                               │
│  │     ├── 🎤 语音备注                                              │
│  │     └── 💬 文字备注                                              │
│  └── 【安装师】                                                     │
│        ├── 📸 拍照（安装前/中/后）                                   │
│        └── ⚠️ 记录问题（安装过程中的异常）                           │
├─────────────────────────────────────────────────────────────────┤
│  阶段 5：完工                                                       │
│  ├── 📸 拍完工照                                                    │
│  ├── ✅ 提交完工                                                    │
│  │     ├── 客户在现场 → 客户 App 签字确认                            │
│  │     └── 客户不在 → 上传给销售，销售联系客户确认                    │
│  └── ⭐ 等待客户评价                                                │
├─────────────────────────────────────────────────────────────────┤
│  阶段 6：结算                                                       │
│  ├── 💰 工费结算（两种模式）                                         │
│  │     ├── 方式 A：验收后 N 天（可配置，如 7 天）                     │
│  │     └── 方式 B：月结                                              │
│  └── 📊 收入统计                                                    │
└─────────────────────────────────────────────────────────────────┘
```

#### 1.2 任务模块 API

| 功能         | 描述                                         | API                                            |
| ------------ | -------------------------------------------- | ---------------------------------------------- |
| 任务列表     | 按状态分类（待接单/已接单/进行中/已完成）    | `GET /api/mobile/tasks`                        |
| 任务详情     | 工作内容、客户信息（测量看报价，安装看订单） | `GET /api/mobile/tasks/:id`                    |
| 接单/拒单    | 确认或拒绝任务                               | `POST /api/mobile/tasks/:id/accept`            |
| 工费协商     | 申请调整工费                                 | `POST /api/mobile/tasks/:id/negotiate`         |
| 确认预约变更 | 确认新的上门时间                             | `POST /api/mobile/tasks/:id/confirm-schedule`  |
| 标记已读     | 确认已读备注                                 | `POST /api/mobile/tasks/:id/mark-read`         |
| GPS 打卡     | 到达/离开打卡                                | `POST /api/mobile/tasks/:id/checkin`           |
| 上传媒体     | 照片/视频/语音                               | `POST /api/mobile/tasks/:id/media`             |
| 提交测量数据 | 多方案测量尺寸                               | `POST /api/mobile/tasks/:id/measurement`       |
| 记录问题     | 异常情况上报                                 | `POST /api/mobile/tasks/:id/issue`             |
| 提交完工     | 完工报告                                     | `POST /api/mobile/tasks/:id/complete`          |
| 申请客户签字 | 发起签字请求                                 | `POST /api/mobile/tasks/:id/request-signature` |

#### 1.3 收入模块 API

| 功能     | 描述                         | API                                 |
| -------- | ---------------------------- | ----------------------------------- |
| 收入统计 | 本月/累计工费、待结算/已结算 | `GET /api/mobile/earnings`          |
| 收入明细 | 每单工费记录                 | `GET /api/mobile/earnings/details`  |
| 结算设置 | 查看个人结算方式（N天/月结） | `GET /api/mobile/earnings/settings` |

---

### 2. 销售端（SALES）

#### 2.1 客户模块

| 功能     | 描述                           | API                                   |
| -------- | ------------------------------ | ------------------------------------- |
| 我的客户 | 显示已分配的客户               | `GET /api/mobile/leads?type=mine`     |
| 公海客户 | 查看和领取公海客户             | `GET /api/mobile/leads?type=pool`     |
| 领取客户 | 从公海领取                     | `POST /api/mobile/leads/:id/claim`    |
| 客户详情 | 基本信息、跟进记录             | `GET /api/mobile/leads/:id`           |
| 添加跟进 | 记录跟进内容（文字/语音/图片） | `POST /api/mobile/leads/:id/followup` |

#### 2.2 现场报价

| 功能         | 描述                          | API                                |
| ------------ | ----------------------------- | ---------------------------------- |
| **快速报价** | 输入尺寸 → 估算价格（简化版） | `POST /api/mobile/quotes/quick`    |
| 报价列表     | 我的报价单                    | `GET /api/mobile/quotes`           |
| 分享报价     | 生成分享图片/小程序链接       | `GET /api/mobile/quotes/:id/share` |

**快速报价流程**：

```
选择品类 → 输入窗户数量/尺寸 → 选择面料档位（经济/品质/高端）→ 估算总价
```

> **注意**：完整报价单在 PC 端创建，移动端侧重快速估算和分享

#### 2.3 业绩统计

| 功能       | 描述                 | API                           |
| ---------- | -------------------- | ----------------------------- |
| 个人业绩   | 本月/本季/本年业绩   | `GET /api/mobile/performance` |
| 销售排行榜 | 团队内排名           | `GET /api/mobile/rankings`    |
| 目标达成率 | 目标 vs 已完成进度条 | `GET /api/mobile/targets`     |

**业绩指标**：

- 成交金额
- 成交单数
- 新增客户数
- 跟进次数

---

### 3. 老板端（BOSS）

#### 3.1 仪表盘（BI 报表）

| 功能         | 描述                         | API                                 |
| ------------ | ---------------------------- | ----------------------------------- |
| 今日核心指标 | 今日订单数/收款金额/新增线索 | `GET /api/mobile/dashboard/summary` |
| 趋势图表     | 日/周/月订单和收款趋势图     | `GET /api/mobile/dashboard/trends`  |
| 销售漏斗     | 线索→报价→订单转化率         | `GET /api/mobile/dashboard/funnel`  |

**核心指标卡片**：

```
┌────────────┬────────────┬────────────┐
│  今日订单  │  今日收款  │  新增线索  │
│     12     │  ¥58,600   │     8      │
│  较昨日↑3  │  较昨日↓5% │  较昨日↑2  │
└────────────┴────────────┴────────────┘
```

#### 3.2 移动审批（全类型）

| 功能       | 描述                   | API                                          |
| ---------- | ---------------------- | -------------------------------------------- |
| 待审批列表 | 所有待我审批的事项     | `GET /api/mobile/approvals?status=PENDING`   |
| 审批详情   | 查看申请详情           | `GET /api/mobile/approvals/:id`              |
| 一键批准   | 通过审批               | `POST /api/mobile/approvals/:id/approve`     |
| 一键驳回   | 拒绝审批（需填写原因） | `POST /api/mobile/approvals/:id/reject`      |
| 审批历史   | 已处理记录             | `GET /api/mobile/approvals?status=COMPLETED` |

**支持的审批类型**：

- 折扣审批
- 退款审批
- 费用报销
- 免费测量
- 其他自定义流程

#### 3.3 销售业绩排行

| 功能       | 描述                   | API                                        |
| ---------- | ---------------------- | ------------------------------------------ |
| 销售排行榜 | 按成交金额/单数排名    | `GET /api/mobile/team/rankings`            |
| 销售详情   | 点击查看某销售详细数据 | `GET /api/mobile/team/:userId/performance` |

**排行榜维度**：

- 本月成交金额
- 本月成交单数
- 本月新增客户

---

### 5. 采购端（PURCHASER）

> 内部采购员使用，侧重移动查看和沟通

#### 5.1 待采购清单

| 功能         | 描述                 | API                                                    |
| ------------ | -------------------- | ------------------------------------------------------ |
| 待采购池     | 汇总所有待采购商品   | `GET /api/mobile/purchase/pending-pool`                |
| 按产品分组   | 相同产品合并显示总量 | 同上                                                   |
| 按供应商筛选 | 筛选特定供应商的商品 | `GET /api/mobile/purchase/pending-pool?supplierId=xxx` |

#### 5.2 物流状态跟踪

| 功能       | 描述                 | API                                             |
| ---------- | -------------------- | ----------------------------------------------- |
| 采购单列表 | 我负责的采购单       | `GET /api/mobile/purchase/orders`               |
| 物流状态   | 查看各采购单物流进度 | `GET /api/mobile/purchase/orders/:id/logistics` |
| 到货提醒   | 货物到达通知         | 推送通知                                        |

**物流状态节点**：

```
已下单 → 厂家生产中 → 已发货 → 运输中 → 已到达 → 已签收
```

#### 5.3 供应商沟通

| 功能       | 描述               | API                                                |
| ---------- | ------------------ | -------------------------------------------------- |
| 供应商列表 | 常用供应商联系方式 | `GET /api/mobile/suppliers`                        |
| 一键拨打   | 快速联系供应商     | -                                                  |
| 问题反馈   | 记录沟通内容和问题 | `POST /api/mobile/purchase/orders/:id/feedback`    |
| 照片凭证   | 上传货损/缺件照片  | `POST /api/mobile/purchase/orders/:id/attachments` |

---

### 6. 客户端（CUSTOMER）

> MVP 阶段聚焦核心功能，后期扩展社区商城

#### 4.1 我的订单（MVP）

| 功能         | 描述                   | API                                           |
| ------------ | ---------------------- | --------------------------------------------- |
| 订单列表     | 显示所有订单           | `GET /api/mobile/orders`                      |
| 订单详情     | 订单信息、商品明细     | `GET /api/mobile/orders/:id`                  |
| **安装进度** | 仅显示安装相关进度节点 | `GET /api/mobile/orders/:id/install-progress` |

**安装进度节点**：

```
待安装 → 已预约 (显示预约时间) → 安装中 → 安装完成 → 已评价
```

#### 4.2 预约查看（MVP）

| 功能         | 描述                           | API                                |
| ------------ | ------------------------------ | ---------------------------------- |
| 预约时间查看 | 销售确认后，客户可查看预约时间 | `GET /api/mobile/appointments`     |
| 预约详情     | 查看测量/安装预约详情          | `GET /api/mobile/appointments/:id` |

> **注意**：预约由销售发起，客户只能查看，不能自主预约

#### 4.3 售后服务（MVP）

| 功能     | 描述                 | API                                            |
| -------- | -------------------- | ---------------------------------------------- |
| 发起售后 | 在小程序提交售后申请 | `POST /api/mobile/after-sales`                 |
| 售后进度 | 查看售后处理进度     | `GET /api/mobile/after-sales/:id`              |
| 上传凭证 | 上传问题照片/视频    | `POST /api/mobile/after-sales/:id/attachments` |

**售后发起流程**：

```
选择订单 → 选择问题商品 → 描述问题 → 上传照片 → 提交
```

#### 4.4 推荐返利（MVP）

| 功能       | 描述                 | API                                  |
| ---------- | -------------------- | ------------------------------------ |
| 我的推荐码 | 生成专属推荐二维码   | `GET /api/mobile/referral/code`      |
| 推荐记录   | 查看我推荐的客户     | `GET /api/mobile/referral/list`      |
| 返利记录   | 查看返利金额和状态   | `GET /api/mobile/referral/rewards`   |
| 提现申请   | 申请返利提现（如有） | `POST /api/mobile/referral/withdraw` |

**推荐规则**：

- 新客户扫码绑定推荐关系
- 下单成功后计算返利
- 返利金额 = 订单金额 × 返利比例（可配置）

#### 4.5 我的（通用）

| 功能     | 描述              | API                         |
| -------- | ----------------- | --------------------------- |
| 个人信息 | 姓名、电话、头像  | `GET /api/mobile/profile`   |
| 地址管理 | 收货/服务地址     | `GET /api/mobile/addresses` |
| 评价记录 | 我的评价列表      | `GET /api/mobile/reviews`   |
| 联系客服 | 在线咨询/一键拨打 | -                           |

#### 4.6 后期规划：社区商城

> 一期暂不实现，预留扩展

- 商品浏览
- 在线下单
- 优惠券
- 会员积分

---

## 🔐 认证与权限

### 登录方式

| 角色     | 登录方式      | 说明            |
| -------- | ------------- | --------------- |
| 内部员工 | 手机号 + 密码 | 支持短信验证码  |
| 客户     | 微信授权      | 自动获取 OpenID |

### 权限控制

```typescript
// 登录后返回用户信息
interface UserInfo {
  id: string;
  name: string;
  phone: string;
  role: 'WORKER' | 'SALES' | 'BOSS' | 'CUSTOMER';
  permissions: string[]; // 细粒度权限
  menuConfig: TabBarItem[]; // 动态菜单配置
}

// 根据角色动态配置 TabBar
const menuConfig = {
  WORKER: [
    { key: 'tasks', name: '任务', icon: 'list' },
    { key: 'earnings', name: '收入', icon: 'money' },
    { key: 'profile', name: '我的', icon: 'user' },
  ],
  // ... 其他角色
};
```

### API 认证

```
Authorization: Bearer <jwt_token>
X-Tenant-Id: <tenant_id>  // 可选，多租户场景
```

---

## 📡 API 规范

### 基础 URL

```
生产环境: https://api.l2c.com/api/mobile
测试环境: https://test-api.l2c.com/api/mobile
```

### 请求格式

```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer xxx"
}
```

### 响应格式

```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "code": 200
}

// 错误响应
{
  "success": false,
  "error": "错误信息",
  "code": 400
}
```

### 分页格式

```json
{
  "success": true,
  "data": {
    "items": [],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

---

## 🔄 数据同步策略

### 离线支持（工人端优先）

| 场景     | 策略                     |
| -------- | ------------------------ |
| 任务列表 | 本地缓存，网络恢复同步   |
| 照片上传 | 队列上传，失败重试       |
| GPS 打卡 | 本地记录，联网补传       |
| 报价计算 | 离线可用（价格本地缓存） |

### 实时推送

| 事件         | 推送方式                   | 接收角色 |
| ------------ | -------------------------- | -------- |
| 新任务分配   | WebSocket / 小程序订阅消息 | WORKER   |
| 订单状态变更 | 小程序订阅消息             | CUSTOMER |
| 新审批待处理 | 小程序服务通知             | BOSS     |
| 报价被查看   | 静默更新                   | SALES    |

---

## 📅 开发计划

### Phase 1：基础架构（3 天）

- [ ] 移动端 API 路由结构
- [ ] JWT 认证中间件
- [ ] 微信登录集成
- [ ] 角色权限过滤

### Phase 2：工人端（5 天）

- [ ] 任务列表与详情 API
- [ ] GPS 打卡 API
- [ ] 照片上传 API
- [ ] 完工确认 API
- [ ] 收入统计 API

### Phase 3：客户端（3 天）

- [ ] 订单列表与详情 API
- [ ] 进度追踪 API
- [ ] 预约服务 API
- [ ] 评价反馈 API

### Phase 4：销售端（4 天）

- [ ] 客户管理 API
- [ ] 快速报价 API
- [ ] 业绩统计 API
- [ ] 排行榜 API

### Phase 5：老板端（3 天）

- [ ] 仪表盘聚合 API
- [ ] 审批处理 API
- [ ] 团队管理 API

### Phase 6：文档与测试（2 天）

- [ ] OpenAPI 规范文档
- [ ] API 测试用例
- [ ] 集成测试

---

## ⚠️ 注意事项

1. **多租户隔离**：所有 API 必须验证 tenantId
2. **数据权限**：用户只能访问自己相关的数据
3. **敏感信息**：客户手机号等需脱敏处理
4. **性能优化**：仪表盘数据需要缓存机制
5. **兼容性**：API 变更需向后兼容

---

## 📎 相关文档

- [API 规范](../04-api/api_specification.md)
- [认证流程](../04-api/01-overview/authentication.md)
- [微信小程序接入指南](./微信小程序接入指南.md)（待创建）

---

_文档维护：请在需求变更后及时更新_
