# 系统基础设计 (System Foundation Design)

**最后更新日期**: 2026-01-14
**状态**: Approved (已确认)

## 1. 权限体系 (RBAC)

基于 **Level 4 RBAC (Resource-Action Based)** 模型设计，通过 Service 层方法拦截和 Drizzle ORM 查询过滤实现。

### 1.1 角色定义 (Roles)

| 角色 Key    | 名称        | 核心权限范围                             | 敏感限制                  |
| :---------- | :---------- | :--------------------------------------- | :------------------------ |
| `ADMIN`     | 店长/管理员 | 全局读写，审批流程终审，系统配置。       | 无                        |
| `SALES`     | 销售顾问    | 自己的线索/订单/客户/业绩。              | 不可见其他销售数据        |
| `MEASURER`  | 测量师      | 自己的测量任务 (待办/进行中/历史)。      | **严禁查看订单金额/单价** |
| `INSTALLER` | 安装师      | 自己的安装任务 (待办/进行中/历史)。      | **严禁查看订单金额/单价** |
| `PURCHASER` | 采购员      | 全局采购单，供应商管理，库存管理。       | 不可见销售提成            |
| `FINANCE`   | 财务专员    | 全局对账单 (AP/AR)，发票管理，收支流水。 | -                         |

### 1.2 数据权限 (Row Level Security)

通过 `services/permission.service.ts` 集中管理查询过滤器 (Query Filters)：

- **Worker Context**: 当 `current_role` 为 `MEASURER` 或 `INSTALLER` 时，强制在 SQL 查询层剔除 `amount`, `price`, `total` 等字段，返回 `null` 或 `0`，防止前端通过 Network 面板抓包泄露利润数据。

---

## 2. 工作台 (Workbench)

遵循 **Proof of Work (工作量证明)** 原则，通过数据状态驱动待办事项的生灭。

### 2.1 布局结构

- **Header**: 全局搜索 (Ctrl+K)、通知铃铛、用户头像。
- **Main**: Tabs 布局
  - **Tab 1: 我的待办 (My Todos)**
  - **Tab 2: 预警中心 (Alerts)**

### 2.2 待办逻辑 (Todo Logic)

待办事项由后端视图 (`View`) 实时聚合，不支持手动勾销。

| 角色   | 待办类型   | 触发条件 (Appear)                                                    | 消除条件 (Disappear)         |
| :----- | :--------- | :------------------------------------------------------------------- | :--------------------------- |
| Sales  | 待跟进线索 | 分配给本人 AND (`last_activity` > 7d OR `next_follow_date` <= Today) | **新增一条有效跟进记录**     |
| Sales  | 待确认方案 | 测量师提交了方案 (`measure_task.status` = `PENDING_CONFIRM`)         | **点击"确认方案"或"驳回"**   |
| Admin  | 待审批     | 有单据进入审批流且 `current_approver` = Me                           | **操作"通过"或"驳回"**       |
| Worker | 待上门     | 任务状态 = `PENDING_VISIT`                                           | **点击"签到" (开始服务)**    |
| Worker | 待服务     | 任务状态 = `IN_PROGRESS`                                             | **提交完工报告 (照片/数据)** |

---

## 3. 审批流引擎 (Approval Engine)

### 3.1 核心模型

- **Visual Designer**: 暂不开发图形化拖拽器 (Phase 2)，Phase 1 采用代码配置 + JSON Schema 定义。
- **Approval Instance**:
  - 每个审批是一个独立的状态机。
  - 审批记录与源单据解耦，审批通过后通过回调 (Callback) 更新源单据状态。

### 3.2 预置流程

1.  **坏账核销**: 财务发起 -> 店长审批。
2.  **订单撤销**: 销售发起 -> 店长审批 -> 财务确认 (若已收款)。
3.  **折扣申请**: 销售发起 -> 店长审批 (若折扣 > 基准线)。

---

## 4. 移动端互通 (Mobile Integration)

### 4.1 员工绑定

- **流程**:
  1. 员工打开微信小程序。
  2. 界面提示 "未绑定账号"。
  3. 员工输入 PC 端账号密码。
  4. 验证通过 -> 绑定 OpenID -> 自动进入工作台。

### 4.2 消息触达

- **SLA 红色预警**: 调用 **阿里云/腾讯云 SMS API** 发送短信。
- **常规通知**: 仅站内信 + 微信小程序内红点。
