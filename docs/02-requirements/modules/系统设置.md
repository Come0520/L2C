# 系统设置需求 (System Settings)

## 1. 模块概述 (Module Overview)

| 属性         | 说明                                               |
| :----------- | :------------------------------------------------- |
| **模块名称** | 系统设置 (System Settings)                         |
| **核心价值** | 提供租户级别的灵活配置能力，满足不同业务场景的需求 |
| **目标用户** | 超级管理员                                         |
| **上游模块** | 无                                                 |
| **下游模块** | 所有业务模块                                       |

## 2. 设置分类 (Settings Categories)

系统设置按功能模块分类，每个分类下包含多个配置项。

### 2.1 线索设置 (Lead Settings)

#### 2.1.1 公海机制设置

| 配置项             | 配置键                      | 类型    | 默认值 | 说明                                      |
| :----------------- | :-------------------------- | :------ | :----- | :---------------------------------------- |
| **启用自动回收**   | `ENABLE_LEAD_AUTO_RECYCLE`  | Boolean | true   | 是否启用线索自动回收机制                  |
| **超时未联系时间** | `LEAD_AUTO_RECYCLE_TIMEOUT` | Integer | 24     | 分配后 X 小时无跟进记录则自动回收（小时） |
| **超时未成交天数** | `LEAD_AUTO_RECYCLE_DAYS`    | Integer | 30     | 跟进 Y 天未转报价则自动回收（天）         |
| **每日认领上限**   | `LEAD_DAILY_CLAIM_LIMIT`    | Integer | 10     | 每人每日认领线索数量上限                  |

**配置说明**：

- 超时未联系时间：分配给销售后，如果在 X 小时内没有跟进记录，系统自动将线索回收至公海
- 超时未成交天数：销售跟进 Y 天后仍未生成报价单，系统自动将线索回收至公海
- 每日认领上限：限制每个销售每天从公海认领线索的数量，防止恶意占用资源

#### 2.1.2 自动分配规则

| 配置项           | 配置键                  | 类型 | 默认值      | 说明                             |
| :--------------- | :---------------------- | :--- | :---------- | :------------------------------- |
| **默认分配策略** | `LEAD_AUTO_ASSIGN_RULE` | Enum | ROUND_ROBIN | 线索自动分配策略（见下方枚举值） |

**分配策略枚举值**：
| 值 | 说明 |
|:---|:---|
| `ROUND_ROBIN` | 轮转：按销售顺序依次分配 |
| `LOAD_BALANCE` | 负载均衡：优先分配给当前线索数最少的销售 |
| `CHANNEL_SPECIFIC` | 渠道指定：特定渠道的线索自动分配给指定销售 |
| `TOP_PERFORMER` | 优秀奖励：转化率高或转化金额高的销售优先分配 |
| `MANUAL` | 手动：默认进公海，由店长/客服手动分配 |

**配置说明**：

- 租户可选择适合的分配策略
- 支持不同渠道使用不同策略（在渠道配置中覆盖全局设置）

#### 2.1.3 查重规则设置

| 配置项               | 配置键                              | 类型    | 默认值    | 说明                                   |
| :------------------- | :---------------------------------- | :------ | :-------- | :------------------------------------- |
| **重复线索处理策略** | `LEAD_DUPLICATE_STRATEGY`           | Enum    | AUTO_LINK | 重复线索的处理策略（见下方枚举值）     |
| **启用第二识别键**   | `ENABLE_SECOND_KEY_DUPLICATE_CHECK` | Boolean | true      | 是否启用地址（第二识别键）作为查重依据 |

**重复线索处理策略枚举值**：
| 值 | 说明 |
|:---|:---|
| `AUTO_LINK` | 自动归集：允许创建新线索，但自动关联至已存在的 `customer_id` |
| `FORBID` | 禁止重复：拒绝创建新线索，提示用户 |
| `ALLOW_INDEPENDENT` | 允许独立：允许创建重复线索，不强制关联 |

**配置说明**：

- 默认策略为自动归集，兼顾灵活性和数据一致性
- 第二识别键（地址）作为补充查重依据，当手机号为空或不存在时使用

#### 2.1.4 跟进规则设置

| 配置项               | 配置键                          | 类型    | 默认值 | 说明                       |
| :------------------- | :------------------------------ | :------ | :----- | :------------------------- |
| **水电阶段跟进间隔** | `LEAD_FOLLOW_UP_WATER_ELECTRIC` | Integer | 30     | 水电阶段默认跟进间隔（天） |
| **泥木阶段跟进间隔** | `LEAD_FOLLOW_UP_MUD_WOOD`       | Integer | 20     | 泥木阶段默认跟进间隔（天） |
| **安装阶段跟进间隔** | `LEAD_FOLLOW_UP_INSTALLATION`   | Integer | 7      | 安装阶段默认跟进间隔（天） |
| **油漆阶段跟进间隔** | `LEAD_FOLLOW_UP_PAINTING`       | Integer | 10     | 油漆阶段默认跟进间隔（天） |

**配置说明**：

- 根据装修进度自动推荐下次跟进时间
- 销售手动设置的跟进时间优先级高于系统推荐时间
- 租户可根据自身业务特点调整不同施工进度的默认跟进间隔

### 2.2 渠道设置 (Channel Settings)

#### 2.2.1 渠道保护期设置

| 配置项             | 配置键                      | 类型    | 默认值 | 说明                       |
| :----------------- | :-------------------------- | :------ | :----- | :------------------------- |
| **渠道保护期天数** | `CHANNEL_PROTECTION_PERIOD` | Integer | 30     | 渠道报备客户的保护期（天） |

**配置说明**：

- A 渠道报备客户 X 后，B 渠道在保护期内不得重复报备
- 保护期过后，其他渠道可以重新报备
- 若 A 渠道报备后已成交，则永久保护

#### 2.2.2 渠道等级评定规则

| 配置项           | 配置键                | 类型 | 默认值 | 说明                 |
| :--------------- | :-------------------- | :--- | :----- | :------------------- |
| **渠道等级配置** | `CHANNEL_LEVEL_RULES` | JSON | 见下方 | 渠道等级评定规则配置 |

**默认配置示例**：

```json
{
  "levels": [
    {
      "level": "S",
      "name": "战略伙伴",
      "minAmount": 500000,
      "commissionRate": 0.12,
      "priceDiscountRate": 0.95
    },
    {
      "level": "A",
      "name": "核心伙伴",
      "minAmount": 200000,
      "commissionRate": 0.1,
      "priceDiscountRate": 0.98
    },
    {
      "level": "B",
      "name": "普通伙伴",
      "minAmount": 50000,
      "commissionRate": 0.08,
      "priceDiscountRate": 1.0
    },
    {
      "level": "C",
      "name": "考察期",
      "minAmount": 0,
      "commissionRate": 0.05,
      "priceDiscountRate": 1.02
    }
  ]
}
```

**配置说明**：

- `minAmount`：年度成交额阈值（元）
- `commissionRate`：返点比例（如 0.12 表示 12%）
- `priceDiscountRate`：底价供货模式的等级折扣率（如 0.95 表示 95 折）
- 系统根据配置的规则自动计算渠道当前等级
- 支持手动调整渠道等级（需记录调整原因）

### 2.3 收款设置 (Payment Settings)

#### 2.3.1 定金收款设置

| 配置项             | 配置键                    | 类型    | 默认值        | 说明                                              |
| :----------------- | :------------------------ | :------ | :------------ | :------------------------------------------------ |
| **启用收款审批**   | `ENABLE_PAYMENT_APPROVAL` | Boolean | true          | 是否启用收款审批                                  |
| **收款审批人角色** | `PAYMENT_APPROVER_ROLE`   | Enum    | STORE_MANAGER | 收款审批人角色                                    |
| **定金最大比例**   | `EARNEST_MONEY_MAX_RATIO` | Decimal | 0.5           | 定金金额不能超过预估金额的比例（如 0.5 表示 50%） |

**收款审批人角色枚举值**：
| 值 | 说明 |
|:---|:---|
| `STORE_MANAGER` | 店长 |
| `FINANCE` | 财务 |
| `ADMIN` | 管理员 |

**配置说明**：

- 若未启用收款审批，收款单提交后自动变为 `VERIFIED` 状态，无需审核
- 若启用收款审批，需要配置的审批人角色审核通过后才能生效
- 定金最大比例限制防止销售收取过高定金

#### 2.3.2 免费测量审批设置

| 配置项                   | 配置键                          | 类型    | 默认值        | 说明                         |
| :----------------------- | :------------------------------ | :------ | :------------ | :--------------------------- |
| **启用免费测量审批**     | `ENABLE_FREE_MEASURE_APPROVAL`  | Boolean | true          | 是否启用免费测量审批         |
| **免费测量审批人角色**   | `FREE_MEASURE_APPROVER_ROLE`    | Enum    | STORE_MANAGER | 免费测量审批人角色           |
| **免费测量审批超时时长** | `FREE_MEASURE_APPROVAL_TIMEOUT` | Integer | 24            | 免费测量审批超时时长（小时） |

**免费测量审批人角色枚举值**：
| 值 | 说明 |
|:---|:---|
| `STORE_MANAGER` | 店长 |
| `ADMIN` | 管理员 |

**配置说明**：

- 若未启用免费测量审批，销售可直接发起免费测量，无需审批
- 若启用免费测量审批，需要配置的审批人角色审批通过后才能发起测量
- 审批超时后系统自动提醒审批人

### 2.4 测量设置 (Measurement Settings)

#### 2.4.1 测量费用准入设置

| 配置项               | 配置键                     | 类型    | 默认值 | 说明                 |
| :------------------- | :------------------------- | :------ | :----- | :------------------- |
| **启用测量费用检查** | `ENABLE_MEASURE_FEE_CHECK` | Boolean | true   | 是否启用测量费用检查 |

**配置说明**：

- 若未启用测量费用检查，销售可直接发起预约测量，无需满足费用准入条件
- 若启用测量费用检查，需要满足以下条件之一：
  - 已支付定金订单（类型=EARNEST_MONEY）
  - 已通过免费测量审批

#### 2.4.2 测量师工作量设置

| 配置项                 | 配置键                      | 类型    | 默认值 | 说明                           |
| :--------------------- | :-------------------------- | :------ | :----- | :----------------------------- |
| **测量师每日任务上限** | `MEASURER_DAILY_TASK_LIMIT` | Integer | 8      | 测量师每日可分配的任务数量上限 |

**配置说明**：

- 限制测量师每日可分配的任务数量，防止工作量过大
- 派单员在派单时，系统会自动检查测量师当日已分配的任务数量
- 若已达到上限，系统提示选择其他测量师

### 2.5 订单设置 (Order Settings)

#### 2.5.1 撤单审批设置

| 配置项             | 配置键                         | 类型    | 默认值        | 说明             |
| :----------------- | :----------------------------- | :------ | :------------ | :--------------- |
| **启用撤单审批**   | `ENABLE_ORDER_CANCEL_APPROVAL` | Boolean | true          | 是否启用撤单审批 |
| **撤单审批人角色** | `ORDER_CANCEL_APPROVER_ROLE`   | Enum    | STORE_MANAGER | 撤单审批人角色   |

**撤单审批人角色枚举值**：
| 值 | 说明 |
|:---|:---|
| `STORE_MANAGER` | 店长 |
| `ADMIN` | 管理员 |

**配置说明**：

- 若未启用撤单审批，销售可直接撤单（仅限待下单状态）
- 若启用撤单审批，需要配置的审批人角色审批通过后才能撤单
- 生产中及以后的订单不可撤单，需走售后退货流程

### 2.6 审批流设置 (Approval Workflow Settings)

#### 2.6.1 审批超时设置

| 配置项                   | 配置键                           | 类型    | 默认值 | 说明                               |
| :----------------------- | :------------------------------- | :------ | :----- | :--------------------------------- |
| **审批超时提醒时间**     | `APPROVAL_TIMEOUT_REMINDER`      | Integer | 2      | 审批超时前多少小时提醒（小时）     |
| **审批超时自动升级**     | `ENABLE_APPROVAL_AUTO_ESCALATE`  | Boolean | true   | 是否启用审批超时自动升级           |
| **审批超时自动升级时间** | `APPROVAL_AUTO_ESCALATE_TIMEOUT` | Integer | 24     | 审批超时多少小时后自动升级（小时） |

**配置说明**：

- 审批超时提醒：在审批即将超时前，系统自动提醒审批人
- 审批超时自动升级：若审批人在超时后仍未处理，系统自动升级审批人（如从店长升级至区域经理）
- 可针对不同类型的审批配置不同的超时策略（在审批流模板中配置）

### 2.7 通知设置 (Notification Settings)

#### 2.7.1 通知渠道设置

| 配置项             | 配置键                       | 类型    | 默认值 | 说明               |
| :----------------- | :--------------------------- | :------ | :----- | :----------------- |
| **启用系统内通知** | `ENABLE_SYSTEM_NOTIFICATION` | Boolean | true   | 是否启用系统内通知 |
| **启用飞书通知**   | `ENABLE_FEISHU_NOTIFICATION` | Boolean | true   | 是否启用飞书通知   |
| **启用短信通知**   | `ENABLE_SMS_NOTIFICATION`    | Boolean | false  | 是否启用短信通知   |
| **启用微信通知**   | `ENABLE_WECHAT_NOTIFICATION` | Boolean | true   | 是否启用微信通知   |

**配置说明**：

- 系统内通知：在系统内的消息中心显示通知
- 飞书通知：通过飞书机器人发送通知
- 短信通知：通过短信网关发送通知（需配置短信服务商）
- 微信通知：通过微信小程序或公众号发送通知

#### 2.7.2 通知类型设置

| 配置项           | 配置键                     | 类型 | 默认值 | 说明                   |
| :--------------- | :------------------------- | :--- | :----- | :--------------------- |
| **通知类型配置** | `NOTIFICATION_TYPE_CONFIG` | JSON | 见下方 | 不同通知类型的渠道配置 |

**默认配置示例**：

```json
{
  "NEW_LEAD_ASSIGNED": {
    "name": "新线索分配",
    "channels": ["SYSTEM", "FEISHU", "WECHAT"],
    "priority": "HIGH"
  },
  "APPROVAL_PENDING": {
    "name": "审批待处理",
    "channels": ["SYSTEM", "FEISHU"],
    "priority": "HIGH"
  },
  "APPROVAL_TIMEOUT": {
    "name": "审批超时",
    "channels": ["SYSTEM", "FEISHU", "SMS"],
    "priority": "URGENT"
  },
  "TASK_TIMEOUT": {
    "name": "任务超时",
    "channels": ["SYSTEM", "FEISHU"],
    "priority": "HIGH"
  }
}
```

**配置说明**：

- `channels`：通知渠道数组（SYSTEM/FEISHU/SMS/WECHAT）
- `priority`：通知优先级（NORMAL/HIGH/URGENT）
- 租户可根据自身需求配置不同通知类型的渠道和优先级

### 2.8 数据报表设置 (Data Report Settings)

#### 2.8.1 报表更新策略设置

| 配置项                 | 配置键                       | 类型    | 默认值 | 说明                       |
| :--------------------- | :--------------------------- | :------ | :----- | :------------------------- |
| **仪表盘数据更新频率** | `DASHBOARD_UPDATE_FREQUENCY` | Enum    | DAILY  | 仪表盘数据更新频率         |
| **支持手动刷新**       | `ENABLE_MANUAL_REFRESH`      | Boolean | true   | 是否支持手动刷新仪表盘数据 |

**仪表盘数据更新频率枚举值**：
| 值 | 说明 |
|:---|:---|
| `REAL_TIME` | 实时更新 |
| `HOURLY` | 每小时更新 |
| `DAILY` | 每日更新 |
| `WEEKLY` | 每周更新 |

**配置说明**：

- 实时更新：数据实时更新，但会增加服务器压力
- 定时更新：减轻服务器压力，但数据有一定延迟
- 支持手动刷新：用户可手动刷新获取最新数据

### 2.9 工费定价设置 (Labor Pricing Settings)

#### 2.9.1 基础工价表配置

| 配置项         | 配置键         | 类型 | 默认值 | 说明                       |
| :------------- | :------------- | :--- | :----- | :------------------------- |
| **基础工价表** | `LABOR_PRICES` | JSON | 见下方 | 不同任务类型的基础工价配置 |

**默认配置示例**：

```json
{
  "prices": [
    {
      "taskType": "MEASURE",
      "taskTypeName": "测量",
      "unitPrice": 5.0,
      "unit": "METER",
      "unitName": "米",
      "description": "测量费用按米计算"
    },
    {
      "taskType": "INSTALL",
      "taskTypeName": "安装",
      "unitPrice": 15.0,
      "unit": "PIECE",
      "unitName": "个",
      "description": "安装费用按个计算"
    },
    {
      "taskType": "INSTALL_AREA",
      "taskTypeName": "面积安装",
      "unitPrice": 50.0,
      "unit": "SQUARE_METER",
      "unitName": "平米",
      "description": "面积安装费用按平米计算"
    }
  ]
}
```

**配置说明**：

- `taskType`：任务类型枚举值（MEASURE/INSTALL/INSTALL_AREA）
- `taskTypeName`：任务类型名称（用于界面展示）
- `unitPrice`：单价（元）
- `unit`：计量单位枚举值（METER/PIECE/SQUARE_METER）
- `unitName`：计量单位名称（用于界面展示）
- 安装单和财务模块在计算工费时，根据任务类型和计量单位调用此配置

#### 2.9.2 特殊费用规则配置

| 配置项           | 配置键              | 类型 | 默认值 | 说明                             |
| :--------------- | :------------------ | :--- | :----- | :------------------------------- |
| **特殊费用规则** | `SPECIAL_FEE_RULES` | JSON | 见下方 | 高空费、远程费等特殊费用规则配置 |

**默认配置示例**：

```json
{
  "highAltitudeFee": {
    "enabled": true,
    "startHeight": 3.0,
    "fee": 100.0,
    "description": "高空作业费起始高度（米）及金额（元）"
  },
  "remoteFee": {
    "enabled": true,
    "startDistance": 50.0,
    "unitPrice": 2.0,
    "description": "远程费起始公里数及单价（元/公里）"
  }
}
```

**配置说明**：

- `highAltitudeFee`：高空作业费配置
  - `enabled`：是否启用高空作业费
  - `startHeight`：起始高度（米）
  - `fee`：固定费用金额（元）
- `remoteFee`：远程费配置
  - `enabled`：是否启用远程费
  - `startDistance`：起始距离（公里）
  - `unitPrice`：单价（元/公里）

### 2.10 财务通用设置 (Finance General Settings)

#### 2.10.1 财务基础参数配置

| 配置项           | 配置键             | 类型    | 默认值    | 说明                        |
| :--------------- | :----------------- | :------ | :-------- | :-------------------------- |
| **默认税率**     | `DEFAULT_TAX_RATE` | Decimal | 0.00      | 默认税率（如 0.00 表示 0%） |
| **默认计税模式** | `DEFAULT_TAX_MODE` | Enum    | EXCLUSIVE | 默认计税模式                |
| **货币符号**     | `CURRENCY_SYMBOL`  | String  | ¥         | 货币符号                    |

**默认计税模式枚举值**：
| 值 | 说明 |
|:---|:---|
| `EXCLUSIVE` | 价外税（不含税价 × 税率 = 税额） |
| `INCLUSIVE` | 价内税（含税价 ÷ (1 + 税率) × 税率 = 税额） |

**配置说明**：

- 默认税率：报价系统和财务模块计算税额时使用的默认税率
- 默认计税模式：决定税额的计算方式
  - 价外税：税额 = 不含税价 × 税率，含税价 = 不含税价 + 税额
  - 价内税：不含税价 = 含税价 ÷ (1 + 税率)，税额 = 含税价 - 不含税价
- 货币符号：用于界面展示金额时的货币符号

### 2.11 租户权益配置 (Tenant Rights Configuration)

#### 2.11.1 租户功能开关配置

| 配置项           | 配置键            | 类型 | 默认值 | 说明                 |
| :--------------- | :---------------- | :--- | :----- | :------------------- |
| **租户权益配置** | `TENANT_FEATURES` | JSON | 见下方 | 租户功能开关统一配置 |

**默认配置示例**：

```json
{
  "features": [
    {
      "key": "ENABLE_SMS",
      "name": "短信通知",
      "enabled": false,
      "editable": false,
      "description": "是否启用短信通知功能",
      "category": "NOTIFICATION"
    },
    {
      "key": "ENABLE_FEISHU_NOTIFICATION",
      "name": "飞书通知",
      "enabled": true,
      "editable": true,
      "description": "是否启用飞书通知功能",
      "category": "NOTIFICATION"
    },
    {
      "key": "ENABLE_WECHAT_NOTIFICATION",
      "name": "微信通知",
      "enabled": true,
      "editable": true,
      "description": "是否启用微信通知功能",
      "category": "NOTIFICATION"
    },
    {
      "key": "ENABLE_SYSTEM_NOTIFICATION",
      "name": "系统内通知",
      "enabled": true,
      "editable": true,
      "description": "是否启用系统内通知功能",
      "category": "NOTIFICATION"
    },
    {
      "key": "ENABLE_LEAD_AUTO_RECYCLE",
      "name": "线索自动回收",
      "enabled": true,
      "editable": true,
      "description": "是否启用线索自动回收机制",
      "category": "LEAD"
    },
    {
      "key": "ENABLE_PAYMENT_APPROVAL",
      "name": "收款审批",
      "enabled": true,
      "editable": true,
      "description": "是否启用收款审批",
      "category": "PAYMENT"
    },
    {
      "key": "ENABLE_FREE_MEASURE_APPROVAL",
      "name": "免费测量审批",
      "enabled": true,
      "editable": true,
      "description": "是否启用免费测量审批",
      "category": "MEASURE"
    },
    {
      "key": "ENABLE_ORDER_CANCEL_APPROVAL",
      "name": "撤单审批",
      "enabled": true,
      "editable": true,
      "description": "是否启用撤单审批",
      "category": "ORDER"
    },
    {
      "key": "ENABLE_MEASURE_FEE_CHECK",
      "name": "测量费用检查",
      "enabled": true,
      "editable": true,
      "description": "是否启用测量费用检查",
      "category": "MEASURE"
    },
    {
      "key": "ENABLE_APPROVAL_AUTO_ESCALATE",
      "name": "审批自动升级",
      "enabled": true,
      "editable": true,
      "description": "是否启用审批超时自动升级",
      "category": "APPROVAL"
    }
  ]
}
```

**配置说明**：

- `key`：功能开关键名（遵循 `ENABLE_` 前缀命名规范）
- `name`：功能开关名称（用于界面展示）
- `enabled`：是否启用该功能
- `editable`：是否允许租户管理员修改（false 表示由运营后台控制）
- `description`：功能说明
- `category`：功能分类（NOTIFICATION/LEAD/PAYMENT/MEASURE/ORDER/APPROVAL）
- 统一管理所有功能开关，便于套餐分级管理（如标准版 vs 专业版）
- 界面上根据 `editable` 字段控制是否可编辑

## 3. 界面设计 (UI Design)

### 3.1 系统设置首页

**页面布局**：

```
┌─────────────────────────────────────────────────────┐
│ 系统设置                                          │
├─────────────────────────────────────────────────────┤
│ 左侧导航栏               │ 右侧配置区               │
│ ├─ 线索设置             │                          │
│ │  ├─ 公海机制设置       │  [当前配置项的内容]        │
│ │  ├─ 自动分配规则       │                          │
│ │  ├─ 查重规则设置       │                          │
│ │  └─ 跟进规则设置       │                          │
│ ├─ 渠道设置             │                          │
│ │  ├─ 渠道保护期设置     │                          │
│ │  └─ 渠道等级评定规则   │                          │
│ ├─ 收款设置             │                          │
│ │  ├─ 定金收款设置       │                          │
│ │  └─ 免费测量审批设置   │                          │
│ ├─ 测量设置             │                          │
│ ├─ 订单设置             │                          │
│ ├─ 审批流设置           │                          │
│ ├─ 通知设置             │                          │
│ ├─ 数据报表设置         │                          │
│ ├─ 工费定价设置         │                          │
│ │  ├─ 基础工价表         │                          │
│ │  └─ 特殊费用规则       │                          │
│ ├─ 财务通用设置         │                          │
│ └─ 租户权益配置         │                          │
└─────────────────────────────────────────────────────┘
```

### 3.2 配置项编辑页面

**通用表单元素**：

| 配置项类型 | 组件          | 说明                             |
| :--------- | :------------ | :------------------------------- |
| Boolean    | `Switch`      | 开关组件                         |
| Integer    | `InputNumber` | 数字输入框                       |
| Decimal    | `InputNumber` | 数字输入框（支持小数）           |
| Enum       | `Select`      | 下拉选择框                       |
| JSON       | `CodeEditor`  | 代码编辑器（支持 JSON 语法高亮） |

**配置项编辑示例**：

**公海机制设置**：

```
┌─────────────────────────────────────────────────────┐
│ 公海机制设置                                       │
├─────────────────────────────────────────────────────┤
│ 启用自动回收                    [开启/关闭]       │
│ 超时未联系时间（小时）          [24]             │
│ 超时未成交天数（天）           [30]             │
│ 每日认领上限                  [10]             │
│                                                      │
│ [保存] [取消]                                        │
└─────────────────────────────────────────────────────┘
```

**渠道等级评定规则**：

```
┌─────────────────────────────────────────────────────┐
│ 渠道等级评定规则                                     │
├─────────────────────────────────────────────────────┤
│ [JSON 编辑器]                                       │
│ {                                                  │
│   "levels": [                                      │
│     {                                              │
│       "level": "S",                                │
│       "name": "战略伙伴",                            │
│       "minAmount": 500000,                          │
│       "commissionRate": 0.12,                        │
│       "priceDiscountRate": 0.95                      │
│     },                                             │
│     ...                                            │
│   ]                                                │
│ }                                                  │
│                                                      │
│ [验证 JSON] [保存] [取消]                            │
└─────────────────────────────────────────────────────┘
```

## 4. 业务规则 (Business Rules)

### 4.1 配置修改权限

| 配置分类     | 修改权限            | 说明                                               |
| :----------- | :------------------ | :------------------------------------------------- |
| 线索设置     | 超级管理员          | 只有超级管理员可以修改                             |
| 渠道设置     | 超级管理员          | 只有超级管理员可以修改                             |
| 收款设置     | 超级管理员          | 只有超级管理员可以修改                             |
| 测量设置     | 超级管理员          | 只有超级管理员可以修改                             |
| 订单设置     | 超级管理员          | 只有超级管理员可以修改                             |
| 审批流设置   | 超级管理员          | 只有超级管理员可以修改                             |
| 通知设置     | 超级管理员          | 只有超级管理员可以修改                             |
| 数据报表设置 | 超级管理员          | 只有超级管理员可以修改                             |
| 工费定价设置 | 超级管理员          | 只有超级管理员可以修改                             |
| 财务通用设置 | 超级管理员          | 只有超级管理员可以修改                             |
| 租户权益配置 | 超级管理员/运营后台 | 部分可配置项由租户管理员控制（根据 editable 字段） |

### 4.2 配置生效时机

| 配置项                   | 生效时机 | 说明                               |
| :----------------------- | :------- | :--------------------------------- |
| Boolean 类型配置         | 立即生效 | 保存后立即生效                     |
| Integer/Decimal 类型配置 | 立即生效 | 保存后立即生效                     |
| Enum 类型配置            | 立即生效 | 保存后立即生效                     |
| JSON 类型配置            | 立即生效 | 保存后立即生效（需验证 JSON 格式） |

### 4.3 配置历史记录

- 所有配置修改必须记录审计日志
- 记录内容包括：配置项、修改前值、修改后值、修改人、修改时间
- 支持查看配置修改历史
- 支持配置回滚（回滚到历史版本）

### 4.4 配置验证

- JSON 类型配置在保存前必须验证格式
- Integer/Decimal 类型配置必须验证取值范围
- Enum 类型配置必须验证枚举值有效性
- 若验证失败，提示具体错误信息，不允许保存

## 5. 权限控制 (Permission Matrix)

### 5.1 页面级权限

| 页面         | 超级管理员 | 管理员 | 普通用户 |
| :----------- | :--------- | :----- | :------- |
| 系统设置首页 | ✓          | ✗      | ✗        |
| 线索设置     | ✓          | ✗      | ✗        |
| 渠道设置     | ✓          | ✗      | ✗        |
| 收款设置     | ✓          | ✗      | ✗        |
| 测量设置     | ✓          | ✗      | ✗        |
| 订单设置     | ✓          | ✗      | ✗        |
| 审批流设置   | ✓          | ✗      | ✗        |
| 通知设置     | ✓          | ✗      | ✗        |
| 数据报表设置 | ✓          | ✗      | ✗        |
| 工费定价设置 | ✓          | ✗      | ✗        |
| 财务通用设置 | ✓          | ✗      | ✗        |
| 租户权益配置 | ✓          | ✗      | ✗        |

### 5.2 操作级权限

| 操作         | 超级管理员 | 管理员 | 普通用户 |
| :----------- | :--------- | :----- | :------- |
| 查看配置     | ✓          | ✗      | ✗        |
| 修改配置     | ✓          | ✗      | ✗        |
| 查看配置历史 | ✓          | ✗      | ✗        |
| 配置回滚     | ✓          | ✗      | ✗        |

## 6. 通知与提醒 (Notifications)

| 触发事件     | 通知对象   | 渠道 | 内容                        |
| :----------- | :--------- | :--- | :-------------------------- |
| 配置修改     | 超级管理员 | 系统 | 配置项 XXX 已修改           |
| 配置验证失败 | 超级管理员 | 系统 | 配置项 XXX 验证失败：XXX    |
| 配置回滚     | 超级管理员 | 系统 | 配置项 XXX 已回滚到历史版本 |

## 7. 与其他模块的关联 (Module Relations)

| 模块             | 关联方式 | 数据流向                                      |
| :--------------- | :------- | :-------------------------------------------- |
| **线索模块**     | 读取配置 | 系统设置 → 线索模块                           |
| **渠道模块**     | 读取配置 | 系统设置 → 渠道模块                           |
| **收款模块**     | 读取配置 | 系统设置 → 收款模块                           |
| **测量模块**     | 读取配置 | 系统设置 → 测量模块                           |
| **订单模块**     | 读取配置 | 系统设置 → 订单模块                           |
| **审批流模块**   | 读取配置 | 系统设置 → 审批流模块                         |
| **通知模块**     | 读取配置 | 系统设置 → 通知模块                           |
| **数据报表模块** | 读取配置 | 系统设置 → 数据报表模块                       |
| **安装单模块**   | 读取配置 | 系统设置 → 安装单模块（工费定价）             |
| **财务模块**     | 读取配置 | 系统设置 → 财务模块（工费定价、财务通用设置） |
| **报价模块**     | 读取配置 | 系统设置 → 报价模块（财务通用设置）           |

## 8. 技术实施建议

### 8.1 数据库层 (Drizzle Schema)

```typescript
// 系统配置表
export const systemSettings = pgTable('system_settings', {
  id: uuid('id').defaultRandom().primaryKey(),
  category: varchar('category', { length: 50 }).notNull(),
  key: varchar('key', { length: 100 }).notNull().unique(),
  value: text('value').notNull(),
  valueType: varchar('value_type', { length: 20 }).notNull(), // BOOLEAN/INTEGER/DECIMAL/ENUM/JSON
  description: text('description'),
  defaultValue: text('default_value'),
  isEditable: boolean('is_editable').default(true),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// 系统配置历史表
export const systemSettingHistory = pgTable('system_setting_history', {
  id: uuid('id').defaultRandom().primaryKey(),
  settingId: uuid('setting_id')
    .notNull()
    .references(() => systemSettings.id),
  oldValue: text('old_value'),
  newValue: text('new_value'),
  changedBy: uuid('changed_by').notNull(),
  changedAt: timestamp('changed_at').defaultNow(),
});

// 唯一索引
export const systemSettingsUniqueKey = uniqueIndex('unique_key').on(systemSettings.key);
```

### 8.2 业务逻辑层 (Server Actions)

```typescript
// 获取系统配置
export async function getSystemSetting(key: string): Promise<any> {
  const setting = await db.query.systemSettings.findFirst({
    where: eq(systemSettings.key, key),
  });

  if (!setting) {
    throw new Error(`系统配置项 ${key} 不存在`);
  }

  // 根据类型解析值
  switch (setting.valueType) {
    case 'BOOLEAN':
      return setting.value === 'true';
    case 'INTEGER':
      return parseInt(setting.value);
    case 'DECIMAL':
      return new Decimal(setting.value);
    case 'ENUM':
      return setting.value;
    case 'JSON':
      return JSON.parse(setting.value);
    default:
      return setting.value;
  }
}

// 更新系统配置
export async function updateSystemSetting(key: string, value: any, userId: string): Promise<void> {
  const setting = await db.query.systemSettings.findFirst({
    where: eq(systemSettings.key, key),
  });

  if (!setting) {
    throw new Error(`系统配置项 ${key} 不存在`);
  }

  if (!setting.isEditable) {
    throw new Error(`系统配置项 ${key} 不可编辑`);
  }

  // 验证值
  const validatedValue = validateSettingValue(setting, value);
  if (!validatedValue.valid) {
    throw new Error(`配置值验证失败：${validatedValue.error}`);
  }

  // 记录历史
  await db.insert(systemSettingHistory).values({
    settingId: setting.id,
    oldValue: setting.value,
    newValue: validatedValue.value,
    changedBy: userId,
  });

  // 更新配置
  await db
    .update(systemSettings)
    .set({
      value: validatedValue.value,
      updatedAt: new Date(),
    })
    .where(eq(systemSettings.key, key));
}

// 验证配置值
function validateSettingValue(
  setting: SystemSetting,
  value: any
): { valid: boolean; value?: string; error?: string } {
  switch (setting.valueType) {
    case 'BOOLEAN':
      if (typeof value !== 'boolean') {
        return { valid: false, error: '值必须是布尔类型' };
      }
      return { valid: true, value: value.toString() };

    case 'INTEGER':
      if (typeof value !== 'number' || !Number.isInteger(value)) {
        return { valid: false, error: '值必须是整数' };
      }
      return { valid: true, value: value.toString() };

    case 'DECIMAL':
      if (typeof value !== 'number' || isNaN(value)) {
        return { valid: false, error: '值必须是数字' };
      }
      return { valid: true, value: value.toString() };

    case 'ENUM':
      if (typeof value !== 'string') {
        return { valid: false, error: '值必须是字符串' };
      }
      // TODO: 验证枚举值有效性
      return { valid: true, value };

    case 'JSON':
      try {
        JSON.parse(value);
        return { valid: true, value: JSON.stringify(value) };
      } catch (e) {
        return { valid: false, error: 'JSON 格式错误' };
      }

    default:
      return { valid: false, error: '未知的配置类型' };
  }
}
```

## 9. 总结

本文档详细描述了 L2C 系统的系统设置需求，包括：

1. **设置分类**：按功能模块分类（线索、渠道、收款、测量、订单、审批流、通知、数据报表、工费定价、财务通用、租户权益）
2. **配置项定义**：每个配置项的配置键、类型、默认值、说明
3. **界面设计**：系统设置首页和配置项编辑页面的布局
4. **业务规则**：配置修改权限、配置生效时机、配置历史记录、配置验证
5. **权限控制**：页面级权限和操作级权限
6. **通知机制**：配置修改、验证失败、配置回滚的通知
7. **技术实施**：数据库层和业务逻辑层的代码示例

通过这些配置项，租户可以根据自身业务特点灵活调整系统行为，满足不同业务场景的需求。

---

## 2.12 收款规则配置 (AR Payment Rules Settings)

> 新增于 2026-01-20

### 2.12.1 分期付款规则

| 配置项               | 配置键               | 类型    | 默认值 | 说明                             |
| :------------------- | :------------------- | :------ | :----- | :------------------------------- |
| **是否允许分期付款** | `ENABLE_INSTALLMENT` | Boolean | true   | 开关控制是否允许分期收款         |
| **定金最低比例**     | `MIN_DEPOSIT_RATIO`  | Decimal | 0.30   | 定金最低比例（如 0.30 表示 30%） |
| **定金最低金额**     | `MIN_DEPOSIT_AMOUNT` | Decimal | 500.00 | 定金最低金额（元）               |
| **定金计算规则**     | `DEPOSIT_CALC_RULE`  | Enum    | HIGHER | 定金计算规则：比例与金额取孰高   |

**定金计算规则枚举值**：
| 值 | 说明 |
|:---|:---|
| `HIGHER` | 取两者孰高 |
| `LOWER` | 取两者孰低 |
| `RATIO_ONLY` | 仅按比例 |
| `AMOUNT_ONLY` | 仅按金额 |

**配置说明**：

- 订单创建时，系统根据配置计算最低定金要求
- 如选择 `HIGHER`，定金 = MAX(订单金额 × 定金比例, 定金最低金额)

### 2.12.2 安装前收款检查

| 配置项                       | 配置键                          | 类型    | 默认值 | 说明                           |
| :--------------------------- | :------------------------------ | :------ | :----- | :----------------------------- |
| **现结客户是否允许欠款安装** | `ALLOW_DEBT_INSTALL_CASH`       | Boolean | false  | 现结渠道客户是否允许未结清安装 |
| **欠款安装是否需审批**       | `REQUIRE_DEBT_INSTALL_APPROVAL` | Boolean | true   | 欠款安装时是否需要走审批流程   |

**业务逻辑**：

```
生成安装单时检查逻辑：
├── 获取订单来源渠道
├── 判断渠道结算方式
│   ├── 【月结渠道】
│   │   └── 检查: 渠道已欠款 + 本单金额 ≤ 授信额度
│   │       ├── 通过 → 允许生成安装单
│   │       └── 不通过 → 拦截或走超额审批
│   └── 【现结渠道】
│       └── 检查: 本单是否全款结清
│           ├── 已结清 → 允许生成安装单
│           └── 未结清 → 根据配置拦截或审批
```

### 2.12.3 渠道结算方式（在渠道管理中配置）

| 字段         | 字段名            | 类型    | 默认值 | 说明               |
| :----------- | :---------------- | :------ | :----- | :----------------- |
| **结算方式** | `settlement_type` | Enum    | CASH   | 渠道结算方式       |
| **授信额度** | `credit_limit`    | Decimal | 0      | 月结渠道的授信额度 |

**结算方式枚举值**：
| 值 | 说明 |
|:---|:---|
| `CASH` | 现结（客户必须付清） |
| `MONTHLY` | 月结（可挂账，额度内免付） |

---

## 2.13 付款策略配置 (AP Payment Strategy Settings)

> 新增于 2026-01-20

### 2.13.1 付款场景结算方式

付款场景分为三类，每类支持不同的结算方式：

| 场景         | 支持的结算方式   | 配置位置     |
| :----------- | :--------------- | :----------- |
| **采购付款** | 现付、月结、预存 | 供应商资料   |
| **劳务结算** | 按单即时结、月结 | 劳务人员资料 |
| **物流费用** | 按单即时结、月结 | 物流商资料   |

### 2.13.2 供应商/劳务人员结算配置

| 字段         | 字段名            | 类型    | 默认值 | 说明                       |
| :----------- | :---------------- | :------ | :----- | :------------------------- |
| **结算方式** | `settlement_type` | Enum    | CASH   | 结算方式                   |
| **预存余额** | `prepaid_balance` | Decimal | 0      | 预存账户余额（仅预存模式） |

**结算方式枚举值**：
| 值 | 适用场景 | 说明 |
|:---|:---|:---|
| `CASH` | 所有 | 现付（默认，新增时自动设为此值） |
| `MONTHLY` | 所有 | 月结（按月汇总结算） |
| `PREPAID` | 采购 | 预存（先充值后扣款） |

### 2.13.3 预存模式配置

| 配置项           | 配置键                | 类型    | 默认值  | 说明                                 |
| :--------------- | :-------------------- | :------ | :------ | :----------------------------------- |
| **预存赠送方式** | `PREPAID_BONUS_TYPE`  | Enum    | BALANCE | 预存充值时的赠送方式                 |
| **默认赠送比例** | `PREPAID_BONUS_RATIO` | Decimal | 0.10    | 赠送货款比例（如 0.10 表示赠送 10%） |

**预存赠送方式枚举值**：
| 值 | 说明 |
|:---|:---|
| `BALANCE` | 赠送货款（如存 1 万，账户 1.1 万） |
| `GOODS` | 赠送商品（需单独配置赠品） |

---

## 2.14 业务流程模式配置 (Business Workflow Mode Settings)

> 新增于 2026-01-20

根据租户规模（小店 vs 大店），配置不同的业务流程模式。

### 2.14.1 业务模式开关

| 配置项               | 配置键                        | 类型    | 默认值     | 说明                      |
| :------------------- | :---------------------------- | :------ | :--------- | :------------------------ |
| **启用线索分配**     | `ENABLE_LEAD_ASSIGNMENT`      | Boolean | true       | 禁用则所有线索归当前用户  |
| **测量派单模式**     | `MEASURE_DISPATCH_MODE`       | Enum    | DISPATCHER | 测量任务的派单方式        |
| **安装派单模式**     | `INSTALL_DISPATCH_MODE`       | Enum    | DISPATCHER | 安装任务的派单方式        |
| **启用劳务费用计算** | `ENABLE_LABOR_FEE_CALC`       | Boolean | true       | 禁用则不计算测量/安装工费 |
| **启用外发加工**     | `ENABLE_OUTSOURCE_PROCESSING` | Boolean | true       | 禁用则不计加工费          |
| **启用采购审批**     | `ENABLE_PURCHASE_APPROVAL`    | Boolean | true       | 禁用则采购直接付款无审批  |

**派单模式枚举值**：
| 值 | 说明 |
|:---|:---|
| `SELF` | 自己做（老板自己测量/安装，无派单环节） |
| `DISPATCHER` | 派单员派单（专人派单） |
| `SALES` | 销售直接派单 |

### 2.14.2 小店模式 vs 大店模式对比

| 模块          | 小店模式（老板一人） | 大店模式（团队分工）   |
| :------------ | :------------------- | :--------------------- |
| **线索管理**  | 禁用分配，无公海池   | 启用分配、公海池、轮转 |
| **测量/安装** | 自己做（无派单）     | 派单员/销售派单        |
| **劳务费用**  | 不计算（自己干）     | 按单计算工费           |
| **加工费用**  | 不计算（自己加工）   | 外发加工计费用         |
| **采购审批**  | 直接付款（无审批）   | 需采购员/老板审批      |

### 2.14.3 业务影响

**禁用线索分配时**：

- 新线索自动分配给当前创建者
- 公海池功能不可见
- 线索认领功能不可见

**派单模式为"自己做"时**：

- 跳过派单环节，直接进入"待测量/待安装"状态
- 无需选择测量师/安装师傅
- 完成后自动记录为当前用户完成

**禁用劳务费用计算时**：

- 工单完成后不生成工费结算记录
- 工费报表不统计该租户数据

**禁用采购审批时**：

- 采购单创建后直接进入"待付款"状态
- 付款无需审批流程
