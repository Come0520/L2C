# 线索模块需求与代码对比分析报告

**检查时间**: 2026-01-16
**参考文档**: 
- `docs/02-requirements/modules/线索/线索.md`
- `docs/整改计划.md`
**代码范围**: 
- `src/shared/api/schema/leads.ts`
- `src/services/lead.service.ts`
- `src/app/(dashboard)/leads`

---

## 1. 数据库 (Database Schema)

现状：Schema (`src/shared/api/schema/leads.ts`) 实现度较高，此前 Gap 分析中指出的缺失字段大部分已补全。

| 实体 | 字段/功能 | 状态 | 说明 |
|:---|:---|:---|:---|
| **Leads 表** | `tags` | ✅ 一致 | 需求为 String[], 实现为 text[] |
| | `url_params` | ✅ 已实现 | 实现为 jsonb，用于捕获落地页参数 |
| | `decoration_progress` | ✅ 已实现 | 新增装修阶段字段 |
| | `next_followup_recommendation` | ✅ 已实现 | 系统推荐跟进时间 |
| **Lead Activities 表** | `quote_id` | ✅ 已修复 | 代码中已存在 (Line 72) |
| | `purchase_intention` | ✅ 已修复 | 代码中已存在 (Line 73) |
| | `customer_level` | ✅ 已修复 | 代码中已存在 (Line 74) |

**剩余差异**:
- 无明显 Schema 结构缺失，现有结构已能支撑大部分核心需求。

---

## 2. 业务逻辑与 API (Business Logic)

逻辑层存在较大差距，主要是**自动化规则**和**查重策略**的精细度不足。

| 功能模块 | 需求点 | 现状 | 差距详情 |
|:---|:---|:---|:---|
| **查重机制** | 活跃线索校验 | ⚠️ 逻辑缺陷 | **严重**: `lead.service.ts` (Lines 33-38) 仅检查手机号是否存在，未校验状态。需求要求允许创建新线索，如果旧线索状态为 `WON` 或 `VOID`。当前代码会拦截所有重复手机号，导致老客户无法再次录入新线索。 |
| | 地址查重 | ✅ 已实现 | 代码中包含 Community + Address 的二级查重逻辑 (Lines 45-56)。 |
| **自动化分配** | Phase 1 策略 | ❌ 未实现 | `createLead` 默认为 `PENDING_ASSIGNMENT`，代码中未见轮转 (Round Robin) 或手动分配的具体实现逻辑（仅有数据库字段支持）。 |
| **公海机制** | 自动回收 | ❌ 未实现 | 缺失 Cron Job 或定时任务来处理超时未跟进/未成交的线索回收逻辑。 |
| **数据接入** | Excel 导入 | ❌ 未实现 | 未见 Excel 解析、校验及批量插入的 Service 或 Action 实现。 |
| | Webhook | ❌ 未实现 | 未见 `POST /api/v1/leads/webhook` 接口及签名校验逻辑。 |
| **关联逻辑** | 自动关联客户 | ✅ 已实现 | 代码中包含根据手机号自动查找并关联 `customerId` 的逻辑 (Lines 59-65)。 |

---

## 3. UI/UX 界面交互

UI 层面主要是关联业务模块的展示缺失，处于 "占位符" 状态。

| 页面 | 功能点 | 状态 | 差距详情 |
|:---|:---|:---|:---|
| **详情页** | 关联单据 | ❌ 缺失 | 测量单、报价单区域目前为 Placeholder ("暂无测量任务 (开发中)"), 代码被注释。 |
| | 状态进度条 | ⚠️ 待优化 | 使用了 `LeadStatusBar`，需确认是否符合 "待分配→待跟踪→跟踪中→成交" 的标准流转视觉要求。 |
| | 快速报价 | ⚠️ 待完善 | `QuickQuote` 按钮存在，但需验证其跳转和预填逻辑是否完善。 |
| **列表页** | 高级筛选 | ❓ 需验证 | 页面引入了 `LeadsAdvancedFilter`，需确认是否实现了多维度筛选（意向、渠道级联等）。 |
| **导入/导出** | 批量操作 | ❌ 未实现 | 缺少批量导入 Excel 的入口和结果反馈界面。 |

---

## 总结与建议

1.  **优先修复查重逻辑**：修改 `LeadService.createLead`，在检查手机号重复时增加 `status NOT IN ('WON', 'VOID')` 条件，支持老客新线索。
2.  **补全数据接入能力**：实现 Excel 导入功能（前端组件+后端解析），这对上线初期至关重要。
3.  **完善详情页关联**：解除测量单和报价单的 Placeholder，关联真实的业务数据查询。
4.  **实现自动化任务**：需要引入任务调度框架（或简单的 Cron），处理公海回收规则。
