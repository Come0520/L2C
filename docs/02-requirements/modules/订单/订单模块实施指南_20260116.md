# è®¢å•æ¨¡å—å®æ–½æŒ‡å—

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-16  
**åŸºäºæ–‡æ¡£**: [è®¢å•æ¨¡å—æ•´æ”¹è®¡åˆ’\_20260116.md](./è®¢å•æ¨¡å—æ•´æ”¹è®¡åˆ’_20260116.md)  
**ç›®æ ‡è¯»è€…**: åç«¯å¼€å‘ã€å‰ç«¯å¼€å‘ã€QAæµ‹è¯•ã€æŠ€æœ¯Leader

---

## ğŸ“‹ ç›®å½•

1. [æ€»ä½“æ¦‚è¿°](#1-æ€»ä½“æ¦‚è¿°)
2. [Week 1: Schemaå˜æ›´ + å¿«ç…§æœºåˆ¶](#week-1-schemaå˜æ›´--å¿«ç…§æœºåˆ¶)
3. [Week 2: å˜æ›´å•æµç¨‹](#week-2-å˜æ›´å•æµç¨‹)
4. [Week 3: æ™ºèƒ½æ‹†å•é€»è¾‘](#week-3-æ™ºèƒ½æ‹†å•é€»è¾‘)
5. [Week 4: å‘è´§ä¸ç‰©æµæµç¨‹](#week-4-å‘è´§ä¸ç‰©æµæµç¨‹)
6. [Week 5: å«åœæœºåˆ¶ + P1åŠŸèƒ½](#week-5-å«åœæœºåˆ¶--p1åŠŸèƒ½)
7. [Week 6: æµ‹è¯•ä¸ä¸Šçº¿å‡†å¤‡](#week-6-æµ‹è¯•ä¸ä¸Šçº¿å‡†å¤‡)
8. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)
9. [é£é™©åº”å¯¹](#é£é™©åº”å¯¹)

---

## 1. æ€»ä½“æ¦‚è¿°

### 1.1 æ•´æ”¹ç›®æ ‡

å°†è®¢å•æ¨¡å—å®Œæˆåº¦ä» **35%** æå‡è‡³ **90%+**ï¼Œå®ç°ç”Ÿäº§çº§åˆ«çš„è®¢å•ç®¡ç†èƒ½åŠ›ã€‚

### 1.2 åˆ†é˜¶æ®µç›®æ ‡

|  å‘¨æ¬¡  | ç›®æ ‡å®Œæˆåº¦ | æ ¸å¿ƒé‡Œç¨‹ç¢‘                |
| :----: | :--------: | :------------------------ |
| Week 1 |    45%     | å®ŒæˆSchemaå˜æ›´ + å¿«ç…§æœºåˆ¶ |
| Week 2 |    55%     | å®Œæˆå˜æ›´å•åŸºç¡€æµç¨‹        |
| Week 3 |    65%     | å®Œæˆæ™ºèƒ½æ‹†å•ç®—æ³•          |
| Week 4 |    75%     | å®Œæˆå‘è´§ä¸ç‰©æµæµç¨‹        |
| Week 5 |    85%     | å®ŒæˆP1åŠŸèƒ½ + å‰ç«¯ä¼˜åŒ–     |
| Week 6 |    90%+    | å®Œæˆæµ‹è¯•ä¸ä¸Šçº¿å‡†å¤‡        |

### 1.3 å…³é”®äº¤ä»˜ç‰©

**åç«¯äº¤ä»˜ç‰©**:

- æ•°æ®åº“Schemaè¿ç§»æ–‡ä»¶
- Serviceå±‚ä¸šåŠ¡é€»è¾‘å®ç°
- 18ä¸ªæ ¸å¿ƒAPIæ¥å£
- å•å…ƒæµ‹è¯•ä»£ç 

**å‰ç«¯äº¤ä»˜ç‰©**:

- è®¢å•åˆ—è¡¨é¡µ(å«ç­›é€‰åˆ†é¡µ)
- è®¢å•è¯¦æƒ…é¡µ(Tabå¸ƒå±€)
- æ‹†å•é¡µé¢
- å˜æ›´ç”³è¯·Dialog
- å‘è´§ç›¸å…³Dialog

**æ–‡æ¡£äº¤ä»˜ç‰©**:

- APIæ–‡æ¡£æ›´æ–°
- æ•°æ®åº“Schemaæ–‡æ¡£
- ä½¿ç”¨æ‰‹å†Œ

---

## 2. Week 1: Schemaå˜æ›´ + å¿«ç…§æœºåˆ¶ (P0)

**ç›®æ ‡**: å®Œæˆæ•°æ®åº“Schemaå˜æ›´å¹¶å®ç°è®¢å•å¿«ç…§æœºåˆ¶

### 2.1 æ•°æ®åº“Schemaå˜æ›´ (3å¤©)

#### 2.1.1 è®¢å•ä¸»è¡¨å­—æ®µè¡¥å…… (Day 1)

**æ–‡ä»¶**: `src/shared/api/schema/orders.ts`

**æ–°å¢å­—æ®µ**:

```typescript
export const orders = pgTable('orders', {
  // ... ç°æœ‰å­—æ®µ

  // æ–°å¢å­—æ®µ
  snapshotData: jsonb('snapshot_data').notNull(),
  haltedReason: text('halted_reason'),
  haltedAt: timestamp('halted_at'),
  cancelReason: text('cancel_reason'),
  cancelledBy: uuid('cancelled_by').references(() => users.id),
  cancelledAt: timestamp('cancelled_at'),
  lockedBy: uuid('locked_by').references(() => users.id),
  confirmationDeadline: timestamp('confirmation_deadline'),
});
```

**æ‰©å±•OrderStatusæšä¸¾**:

```typescript
export const orderStatusEnum = pgEnum('order_status', [
  'PENDING_CONFIRMATION', // æ–°å¢
  'PENDING_PO',
  'PENDING_PRODUCTION',
  'PENDING_DELIVERY',
  'PENDING_SHIPMENT',
  'SHIPPED',
  'DELIVERED',
  'COMPLETED',
  'HALTED', // æ–°å¢
  'CANCELLED',
]);
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‰€æœ‰æ–°å­—æ®µå·²æ·»åŠ åˆ°Schemaå®šä¹‰
- [ ] OrderStatusæšä¸¾åŒ…å«æ‰€æœ‰13ä¸ªçŠ¶æ€
- [ ] TypeScriptç±»å‹å®šä¹‰æ­£ç¡®
- [ ] å­—æ®µæ³¨é‡Šå®Œæ•´

#### 2.1.2 è®¢å•æ˜ç»†è¡¨å­—æ®µè¡¥å…… (Day 1.5)

**æ–‡ä»¶**: `src/shared/api/schema/order-items.ts`

**æ–°å¢å­—æ®µ**:

```typescript
export const orderItems = pgTable('order_items', {
  // ... ç°æœ‰å­—æ®µ

  // æ–°å¢å­—æ®µ
  supplierId: uuid('supplier_id').references(() => suppliers.id),
  purchaseOrderId: uuid('purchase_order_id').references(() => purchaseOrders.id),
  deliveryStatus: text('delivery_status'), // PENDING, SHIPPED, DELIVERED
  deliveredAt: timestamp('delivered_at'),
});
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‰€æœ‰æ–°å­—æ®µå·²æ·»åŠ åˆ°Schemaå®šä¹‰
- [ ] å¤–é”®å…³è”æ­£ç¡®
- [ ] å­—æ®µæ³¨é‡Šå®Œæ•´

#### 2.1.3 åˆ›å»ºå˜æ›´å•è¡¨ (Day 2)

**æ–‡ä»¶**: `src/shared/api/schema/change-requests.ts`

**å®Œæ•´Schema**:

```typescript
import { pgTable, uuid, text, timestamp, decimal, jsonb } from 'drizzle-orm/pg-core';
import { users } from './users';
import { orders } from './orders';

export const changeRequests = pgTable('change_requests', {
  id: uuid('id').defaultRandom().primaryKey(),
  tenantId: uuid('tenant_id').notNull(),
  orderId: uuid('order_id')
    .notNull()
    .references(() => orders.id, { onDelete: 'cascade' }),

  // å˜æ›´ä¿¡æ¯
  changeType: text('change_type').notNull(), // ADD_ITEM, REMOVE_ITEM, MODIFY_ITEM
  changeReason: text('change_reason').notNull(),
  originalItems: jsonb('original_items').notNull(),
  newItems: jsonb('new_items').notNull(),
  priceDifference: decimal('price_difference', { precision: 10, scale: 2 }),

  // å®¡æ‰¹ä¿¡æ¯
  status: text('status').notNull().default('PENDING'), // PENDING, APPROVED, REJECTED
  approvedBy: uuid('approved_by').references(() => users.id),
  approvedAt: timestamp('approved_at'),
  rejectedBy: uuid('rejected_by').references(() => users.id),
  rejectedAt: timestamp('rejected_at'),
  rejectionReason: text('rejection_reason'),

  // å®¡è®¡å­—æ®µ
  createdBy: uuid('created_by')
    .notNull()
    .references(() => users.id),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// ç´¢å¼•
export const changeRequestsIndexOrderId = index('idx_change_requests_order_id').on(
  changeRequests.orderId
);
export const changeRequestsIndexStatus = index('idx_change_requests_status').on(
  changeRequests.status
);
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] changeRequestsè¡¨Schemaå®šä¹‰å®Œæ•´
- [ ] å¤–é”®å…³è”æ­£ç¡®
- [ ] ç´¢å¼•å·²åˆ›å»º
- [ ] å­—æ®µæ³¨é‡Šå®Œæ•´

#### 2.1.4 æ€§èƒ½ç´¢å¼•åˆ›å»º (Day 2.5)

**æ–‡ä»¶**: `drizzle/migrations/XXXX_order_module_enhancement.sql`

**SQLè¯­å¥**:

```sql
-- è®¢å•è¡¨ç´¢å¼•
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX idx_orders_tenant_id ON orders(tenant_id);

-- è®¢å•æ˜ç»†è¡¨ç´¢å¼•
CREATE INDEX idx_order_items_supplier_id ON order_items(supplier_id);
CREATE INDEX idx_order_items_po_id ON order_items(purchase_order_id);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);

-- å˜æ›´å•è¡¨ç´¢å¼•
CREATE INDEX idx_change_requests_order_id ON change_requests(order_id);
CREATE INDEX idx_change_requests_status ON change_requests(status);
CREATE INDEX idx_change_requests_tenant_id ON change_requests(tenant_id);
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‰€æœ‰ç´¢å¼•å·²åˆ›å»º
- [ ] ç´¢å¼•å‘½åè§„èŒƒ
- [ ] å¤åˆç´¢å¼•é¡ºåºåˆç†(é«˜é€‰æ‹©æ€§å­—æ®µåœ¨å‰)

#### 2.1.5 è¿ç§»è„šæœ¬ç¼–å†™ä¸æµ‹è¯• (Day 3)

**æ–‡ä»¶**: `drizzle/migrations/XXXX_order_module_enhancement.sql`

**å®Œæ•´è¿ç§»è„šæœ¬**:

```sql
-- ============================================
-- è®¢å•æ¨¡å—å¢å¼ºè¿ç§»è„šæœ¬
-- ç‰ˆæœ¬: 20260116
-- ä½œè€…: åç«¯å¼€å‘å›¢é˜Ÿ
-- ============================================

BEGIN;

-- 1. æ‰©å±•OrderStatusæšä¸¾
CREATE TYPE order_status_new AS ENUM (
  'PENDING_CONFIRMATION',
  'PENDING_PO',
  'PENDING_PRODUCTION',
  'PENDING_DELIVERY',
  'PENDING_SHIPMENT',
  'SHIPPED',
  'DELIVERED',
  'COMPLETED',
  'HALTED',
  'CANCELLED'
);

-- è¿ç§»ç°æœ‰æ•°æ®
ALTER TABLE orders ALTER COLUMN status TYPE order_status_new
  USING status::text::order_status_new;

DROP TYPE order_status;
ALTER TYPE order_status_new RENAME TO order_status;

-- 2. è®¢å•ä¸»è¡¨æ–°å¢å­—æ®µ
ALTER TABLE orders ADD COLUMN snapshot_data JSONB NOT NULL DEFAULT '{}';
ALTER TABLE orders ADD COLUMN halted_reason TEXT;
ALTER TABLE orders ADD COLUMN halted_at TIMESTAMP;
ALTER TABLE orders ADD COLUMN cancel_reason TEXT;
ALTER TABLE orders ADD COLUMN cancelled_by UUID REFERENCES users(id);
ALTER TABLE orders ADD COLUMN cancelled_at TIMESTAMP;
ALTER TABLE orders ADD COLUMN locked_by UUID REFERENCES users(id);
ALTER TABLE orders ADD COLUMN confirmation_deadline TIMESTAMP;

-- 3. è®¢å•æ˜ç»†è¡¨æ–°å¢å­—æ®µ
ALTER TABLE order_items ADD COLUMN supplier_id UUID REFERENCES suppliers(id);
ALTER TABLE order_items ADD COLUMN purchase_order_id UUID REFERENCES purchase_orders(id);
ALTER TABLE order_items ADD COLUMN delivery_status TEXT DEFAULT 'PENDING';
ALTER TABLE order_items ADD COLUMN delivered_at TIMESTAMP;

-- 4. åˆ›å»ºå˜æ›´å•è¡¨
CREATE TABLE change_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,

  change_type TEXT NOT NULL CHECK (change_type IN ('ADD_ITEM', 'REMOVE_ITEM', 'MODIFY_ITEM')),
  change_reason TEXT NOT NULL,
  original_items JSONB NOT NULL,
  new_items JSONB NOT NULL,
  price_difference DECIMAL(10,2),

  status TEXT NOT NULL DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED')),
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMP,
  rejected_by UUID REFERENCES users(id),
  rejected_at TIMESTAMP,
  rejection_reason TEXT,

  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- 5. åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX idx_orders_tenant_id ON orders(tenant_id);

CREATE INDEX idx_order_items_supplier_id ON order_items(supplier_id);
CREATE INDEX idx_order_items_po_id ON order_items(purchase_order_id);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);

CREATE INDEX idx_change_requests_order_id ON change_requests(order_id);
CREATE INDEX idx_change_requests_status ON change_requests(status);
CREATE INDEX idx_change_requests_tenant_id ON change_requests(tenant_id);

-- 6. åˆ›å»ºè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_change_requests_updated_at
  BEFORE UPDATE ON change_requests
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

COMMIT;
```

**å›æ»šè„šæœ¬**:

```sql
-- ============================================
-- è®¢å•æ¨¡å—å¢å¼ºå›æ»šè„šæœ¬
-- ============================================

BEGIN;

-- åˆ é™¤è§¦å‘å™¨
DROP TRIGGER IF EXISTS update_change_requests_updated_at ON change_requests;

-- åˆ é™¤ç´¢å¼•
DROP INDEX IF EXISTS idx_change_requests_tenant_id;
DROP INDEX IF EXISTS idx_change_requests_status;
DROP INDEX IF EXISTS idx_change_requests_order_id;
DROP INDEX IF EXISTS idx_order_items_order_id;
DROP INDEX IF EXISTS idx_order_items_po_id;
DROP INDEX IF EXISTS idx_order_items_supplier_id;
DROP INDEX IF EXISTS idx_orders_tenant_id;
DROP INDEX IF EXISTS idx_orders_created_at;
DROP INDEX IF EXISTS idx_orders_customer_id;
DROP INDEX IF EXISTS idx_orders_status;

-- åˆ é™¤å˜æ›´å•è¡¨
DROP TABLE IF EXISTS change_requests;

-- åˆ é™¤è®¢å•æ˜ç»†è¡¨æ–°å¢å­—æ®µ
ALTER TABLE order_items DROP COLUMN IF EXISTS delivered_at;
ALTER TABLE order_items DROP COLUMN IF EXISTS delivery_status;
ALTER TABLE order_items DROP COLUMN IF EXISTS purchase_order_id;
ALTER TABLE order_items DROP COLUMN IF EXISTS supplier_id;

-- åˆ é™¤è®¢å•ä¸»è¡¨æ–°å¢å­—æ®µ
ALTER TABLE orders DROP COLUMN IF EXISTS confirmation_deadline;
ALTER TABLE orders DROP COLUMN IF EXISTS locked_by;
ALTER TABLE orders DROP COLUMN IF EXISTS cancelled_at;
ALTER TABLE orders DROP COLUMN IF EXISTS cancelled_by;
ALTER TABLE orders DROP COLUMN IF EXISTS cancel_reason;
ALTER TABLE orders DROP COLUMN IF EXISTS halted_at;
ALTER TABLE orders DROP COLUMN IF EXISTS halted_reason;
ALTER TABLE orders DROP COLUMN IF EXISTS snapshot_data;

-- æ¢å¤OrderStatusæšä¸¾
CREATE TYPE order_status_old AS ENUM (
  'PENDING_PO',
  'PENDING_PRODUCTION',
  'PENDING_DELIVERY',
  'PENDING_SHIPMENT',
  'SHIPPED',
  'DELIVERED',
  'COMPLETED',
  'CANCELLED'
);

ALTER TABLE orders ALTER COLUMN status TYPE order_status_old
  USING status::text::order_status_old;

DROP TYPE order_status;
ALTER TYPE order_status_old RENAME TO order_status;

COMMIT;
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] è¿ç§»è„šæœ¬åœ¨æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] å›æ»šè„šæœ¬æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡
- [ ] æ— æ•°æ®ä¸¢å¤±

### 2.2 è®¢å•å¿«ç…§æœºåˆ¶å®ç° (2å¤©)

#### 2.2.1 Serviceå±‚æ”¹é€  (Day 4)

**æ–‡ä»¶**: `src/services/order.service.ts`

**ä¿®æ”¹ `convertFromQuote` æ–¹æ³•**:

```typescript
import { db } from '@/shared/db';
import { orders, orderItems } from '@/shared/api/schema/orders';
import { quotes, quoteItems } from '@/shared/api/schema/quotes';

export class OrderService {
  /**
   * ä»æŠ¥ä»·å•åˆ›å»ºè®¢å•
   * @param quoteId æŠ¥ä»·å•ID
   * @param options åˆ›å»ºé€‰é¡¹
   * @returns åˆ›å»ºçš„è®¢å•ID
   */
  async convertFromQuote(
    quoteId: string,
    options: {
      paymentAmount?: number;
      paymentMethod?: 'CASH' | 'WECHAT' | 'ALIPAY' | 'BANK';
      paymentTime?: Date;
      paymentProofImg?: string;
      confirmationImg?: string;
    } = {}
  ): Promise<string> {
    return await db.transaction(async (tx) => {
      // 1. è·å–æŠ¥ä»·å•æ•°æ®
      const [quote] = await tx.select().from(quotes).where(eq(quotes.id, quoteId)).limit(1);

      if (!quote) {
        throw new Error('æŠ¥ä»·å•ä¸å­˜åœ¨');
      }

      if (quote.status !== 'WON') {
        throw new Error('ä»…WONçŠ¶æ€çš„æŠ¥ä»·å•å¯è½¬è®¢å•');
      }

      // 2. æ£€æŸ¥æ˜¯å¦å·²åˆ›å»ºè®¢å•
      const [existingOrder] = await tx
        .select()
        .from(orders)
        .where(eq(orders.quoteId, quoteId))
        .limit(1);

      if (existingOrder) {
        throw new Error('è¯¥æŠ¥ä»·å•å·²åˆ›å»ºè®¢å•');
      }

      // 3. è·å–æŠ¥ä»·æ˜ç»†
      const items = await tx.select().from(quoteItems).where(eq(quoteItems.quoteId, quoteId));

      // 4. ç”Ÿæˆå¿«ç…§æ•°æ®
      const snapshotData = this.generateSnapshot(quote, items);

      // 5. ç¡®å®šåˆå§‹çŠ¶æ€
      const initialStatus = quote.hasDeepDesign ? 'PENDING_CONFIRMATION' : 'PENDING_PO';

      // 6. æ¨æ–­ç»“ç®—æ–¹å¼
      const settlementType = this.inferSettlementType(quote.totalAmount, options.paymentAmount);

      // 7. åˆ›å»ºè®¢å•
      const [newOrder] = await tx
        .insert(orders)
        .values({
          orderNo: await this.generateOrderNo(),
          quoteId: quote.id,
          quoteVersionId: quote.versionId,
          leadId: quote.leadId,
          customerId: quote.customerId,
          customerName: quote.customerName,
          customerPhone: quote.customerPhone,
          deliveryAddress: quote.deliveryAddress,
          status: initialStatus,
          totalAmount: quote.totalAmount,
          paidAmount: options.paymentAmount || 0,
          settlementType,
          confirmationImg: options.confirmationImg,
          paymentProofImg: options.paymentProofImg,
          paymentAmount: options.paymentAmount,
          paymentMethod: options.paymentMethod,
          paymentTime: options.paymentTime,
          salesId: quote.salesId,
          snapshotData: JSON.stringify(snapshotData),
          confirmationDeadline: quote.hasDeepDesign
            ? new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7å¤©å
            : null,
        })
        .returning();

      // 8. åˆ›å»ºè®¢å•æ˜ç»†
      const orderItemValues = items.map((item) => ({
        orderId: newOrder.id,
        quoteItemId: item.id,
        roomName: item.roomName,
        productId: item.productId,
        productName: item.productName,
        category: item.category,
        unitPrice: item.unitPrice,
        quantity: item.quantity,
        width: item.width,
        height: item.height,
        subtotal: item.subtotal,
        status: 'PENDING',
      }));

      await tx.insert(orderItems).values(orderItemValues);

      // 9. æ›´æ–°æŠ¥ä»·å•çŠ¶æ€ä¸ºLOCKED
      await tx.update(quotes).set({ status: 'LOCKED' }).where(eq(quotes.id, quoteId));

      // 10. åˆ›å»ºARå¯¹è´¦å•
      await this.createARStatement(tx, newOrder);

      return newOrder.id;
    });
  }

  /**
   * ç”Ÿæˆè®¢å•å¿«ç…§æ•°æ®
   * @param quote æŠ¥ä»·å•
   * @param items æŠ¥ä»·æ˜ç»†
   * @returns å¿«ç…§æ•°æ®
   */
  private generateSnapshot(quote: any, items: any[]): any {
    return {
      quote: {
        id: quote.id,
        quoteNo: quote.quoteNo,
        versionId: quote.versionId,
        totalAmount: quote.totalAmount,
        hasDeepDesign: quote.hasDeepDesign,
        createdAt: quote.createdAt,
        items: items.map((item) => ({
          id: item.id,
          roomName: item.roomName,
          productId: item.productId,
          productName: item.productName,
          category: item.category,
          unitPrice: item.unitPrice,
          quantity: item.quantity,
          width: item.width,
          height: item.height,
          subtotal: item.subtotal,
        })),
      },
      customer: {
        id: quote.customerId,
        name: quote.customerName,
        phone: quote.customerPhone,
        address: quote.deliveryAddress,
      },
      snapshotTime: new Date().toISOString(),
    };
  }

  /**
   * æ¨æ–­ç»“ç®—æ–¹å¼
   * @param totalAmount è®¢å•æ€»é‡‘é¢
   * @param paidAmount å·²ä»˜é‡‘é¢
   * @returns ç»“ç®—æ–¹å¼
   */
  private inferSettlementType(totalAmount: number, paidAmount?: number): 'PREPAID' | 'MONTHLY' {
    const paid = Number(paidAmount || 0);
    const total = Number(totalAmount || 0);

    // é¢„ä»˜æ¬¾ >= 30% åˆ™ä¸ºé¢„ä»˜
    if (paid >= total * 0.3) {
      return 'PREPAID';
    }

    return 'MONTHLY';
  }

  /**
   * ç”Ÿæˆè®¢å•å·
   * @returns è®¢å•å· (OD20260116001)
   */
  private async generateOrderNo(): Promise<string> {
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');

    // æŸ¥è¯¢ä»Šæ—¥è®¢å•æ•°é‡
    const [result] = await db
      .select({ count: sql<number>`count(*)` })
      .from(orders)
      .where(and(sql`DATE(created_at) = CURRENT_DATE`, eq(orders.tenantId, getTenantId())));

    const seq = (result?.count || 0) + 1;
    return `OD${dateStr}${String(seq).padStart(3, '0')}`;
  }

  /**
   * åˆ›å»ºARå¯¹è´¦å•
   * @param tx æ•°æ®åº“äº‹åŠ¡
   * @param order è®¢å•
   */
  private async createARStatement(tx: any, order: any): Promise<void> {
    // TODO: é›†æˆè´¢åŠ¡æ¨¡å—åˆ›å»ºARå¯¹è´¦å•
    // æš‚æ—¶è·³è¿‡,å¾…è´¢åŠ¡æ¨¡å—å®Œæˆåå†å®ç°
  }
}
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] `convertFromQuote` æ–¹æ³•å®Œæ•´å®ç°
- [ ] å¿«ç…§æ•°æ®ç»“æ„æ­£ç¡®
- [ ] åˆå§‹çŠ¶æ€åˆ¤æ–­é€»è¾‘æ­£ç¡®
- [ ] ç»“ç®—æ–¹å¼æ¨æ–­é€»è¾‘æ­£ç¡®
- [ ] è®¢å•å·ç”Ÿæˆé€»è¾‘æ­£ç¡®
- [ ] äº‹åŠ¡å¤„ç†æ­£ç¡®

#### 2.2.2 åˆå§‹çŠ¶æ€é€»è¾‘ä¼˜åŒ– (Day 4.5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] `hasDeepDesign=true` æ—¶åˆå§‹çŠ¶æ€ä¸º `PENDING_CONFIRMATION`
- [ ] `hasDeepDesign=false` æ—¶åˆå§‹çŠ¶æ€ä¸º `PENDING_PO`
- [ ] `confirmationDeadline` å­—æ®µæ­£ç¡®è®¾ç½®

#### 2.2.3 ç»“ç®—æ–¹å¼æ¨æ–­é€»è¾‘ (Day 5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] é¢„ä»˜æ¬¾ >= 30% æ—¶è¿”å› `PREPAID`
- [ ] é¢„ä»˜æ¬¾ < 30% æ—¶è¿”å› `MONTHLY`
- [ ] è¾¹ç•Œå€¼æµ‹è¯•é€šè¿‡(30% exactly)

**æµ‹è¯•ç”¨ä¾‹**:

```typescript
describe('OrderService.inferSettlementType', () => {
  it('should return PREPAID when paid >= 30%', () => {
    expect(service.inferSettlementType(1000, 300)).toBe('PREPAID');
    expect(service.inferSettlementType(1000, 500)).toBe('PREPAID');
  });

  it('should return MONTHLY when paid < 30%', () => {
    expect(service.inferSettlementType(1000, 200)).toBe('MONTHLY');
    expect(service.inferSettlementType(1000, 0)).toBe('MONTHLY');
  });
});
```

### 2.3 Week 1 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] æ•°æ®åº“Schemaå˜æ›´å®Œæˆ
- [ ] è®¢å•å¿«ç…§æœºåˆ¶100%å¯ç”¨
- [ ] åˆ›å»ºè®¢å•å `snapshotData` å­—æ®µéç©º
- [ ] å¿«ç…§æ•°æ®ä¸æŠ¥ä»·æ•°æ®ä¸€è‡´
- [ ] æŠ¥ä»·æ•°æ®å˜æ›´åè®¢å•å¿«ç…§ä¸å—å½±å“

**ä»£ç è´¨é‡éªŒæ”¶**:

- [ ] TypeScriptæ— ç±»å‹é”™è¯¯
- [ ] ESLintæ— P0/P1é”™è¯¯
- [ ] ä»£ç æ³¨é‡Šå®Œæ•´
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 60%

---

## 3. Week 2: å˜æ›´å•æµç¨‹ (P0)

**ç›®æ ‡**: å®ç°å®Œæ•´çš„è®¢å•å˜æ›´è¯·æ±‚ã€å®¡æ‰¹ã€åº”ç”¨æµç¨‹

### 3.1 å˜æ›´å•Serviceå±‚ (2å¤©)

#### 3.1.1 åˆ›å»ºå˜æ›´è¯·æ±‚é€»è¾‘ (Day 6)

**æ–‡ä»¶**: `src/services/change-request.service.ts`

**å®Œæ•´å®ç°**:

```typescript
import { db } from '@/shared/db';
import { changeRequests } from '@/shared/api/schema/change-requests';
import { orders, orderItems } from '@/shared/api/schema/orders';
import { eq, and } from 'drizzle-orm';
import { Decimal } from 'decimal.js';

export class ChangeRequestService {
  /**
   * åˆ›å»ºå˜æ›´è¯·æ±‚
   * @param orderId è®¢å•ID
   * @param data å˜æ›´æ•°æ®
   * @param userId æ“ä½œäººID
   * @returns å˜æ›´è¯·æ±‚ID
   */
  async create(
    orderId: string,
    data: {
      changeType: 'ADD_ITEM' | 'REMOVE_ITEM' | 'MODIFY_ITEM';
      changeReason: string;
      originalItems: any[];
      newItems: any[];
    },
    userId: string
  ): Promise<string> {
    return await db.transaction(async (tx) => {
      // 1. éªŒè¯è®¢å•çŠ¶æ€
      const [order] = await tx.select().from(orders).where(eq(orders.id, orderId)).limit(1);

      if (!order) {
        throw new Error('è®¢å•ä¸å­˜åœ¨');
      }

      // ä»…å…è®¸ç‰¹å®šçŠ¶æ€ä¸‹å˜æ›´
      const allowedStatuses = ['PENDING_PO', 'PENDING_CONFIRMATION'];
      if (!allowedStatuses.includes(order.status)) {
        throw new Error(`å½“å‰çŠ¶æ€ ${order.status} ä¸å…è®¸å˜æ›´`);
      }

      // 2. è®¡ç®—å·®ä»·
      const priceDifference = this.calculatePriceDifference(data.originalItems, data.newItems);

      // 3. åˆ›å»ºå˜æ›´è¯·æ±‚
      const [changeRequest] = await tx
        .insert(changeRequests)
        .values({
          tenantId: getTenantId(),
          orderId,
          changeType: data.changeType,
          changeReason: data.changeReason,
          originalItems: JSON.stringify(data.originalItems),
          newItems: JSON.stringify(data.newItems),
          priceDifference: priceDifference.toString(),
          status: 'PENDING',
          createdBy: userId,
        })
        .returning();

      return changeRequest.id;
    });
  }

  /**
   * è®¡ç®—å·®ä»·
   * @param originalItems åŸå§‹å•†å“åˆ—è¡¨
   * @param newItems æ–°å•†å“åˆ—è¡¨
   * @returns å·®ä»·(æ­£æ•°=è¡¥å·®ä»·,è´Ÿæ•°=é€€å·®ä»·)
   */
  private calculatePriceDifference(originalItems: any[], newItems: any[]): Decimal {
    const originalTotal = originalItems.reduce(
      (sum, item) => sum.plus(new Decimal(item.subtotal || 0)),
      new Decimal(0)
    );

    const newTotal = newItems.reduce(
      (sum, item) => sum.plus(new Decimal(item.subtotal || 0)),
      new Decimal(0)
    );

    return newTotal.minus(originalTotal);
  }

  /**
   * å®¡æ‰¹å˜æ›´è¯·æ±‚
   * @param changeRequestId å˜æ›´è¯·æ±‚ID
   * @param approved æ˜¯å¦æ‰¹å‡†
   * @param userId å®¡æ‰¹äººID
   * @param rejectionReason æ‹’ç»åŸå› (å¯é€‰)
   */
  async approve(
    changeRequestId: string,
    approved: boolean,
    userId: string,
    rejectionReason?: string
  ): Promise<void> {
    return await db.transaction(async (tx) => {
      // 1. è·å–å˜æ›´è¯·æ±‚
      const [changeRequest] = await tx
        .select()
        .from(changeRequests)
        .where(eq(changeRequests.id, changeRequestId))
        .limit(1);

      if (!changeRequest) {
        throw new Error('å˜æ›´è¯·æ±‚ä¸å­˜åœ¨');
      }

      if (changeRequest.status !== 'PENDING') {
        throw new Error('å˜æ›´è¯·æ±‚å·²å¤„ç†');
      }

      // 2. æ›´æ–°å˜æ›´è¯·æ±‚çŠ¶æ€
      if (approved) {
        await tx
          .update(changeRequests)
          .set({
            status: 'APPROVED',
            approvedBy: userId,
            approvedAt: new Date(),
          })
          .where(eq(changeRequests.id, changeRequestId));

        // 3. åº”ç”¨å˜æ›´åˆ°è®¢å•
        await this.applyChange(tx, changeRequest);
      } else {
        await tx
          .update(changeRequests)
          .set({
            status: 'REJECTED',
            rejectedBy: userId,
            rejectedAt: new Date(),
            rejectionReason,
          })
          .where(eq(changeRequests.id, changeRequestId));
      }
    });
  }

  /**
   * åº”ç”¨å˜æ›´åˆ°è®¢å•
   * @param tx æ•°æ®åº“äº‹åŠ¡
   * @param changeRequest å˜æ›´è¯·æ±‚
   */
  private async applyChange(tx: any, changeRequest: any): Promise<void> {
    const orderId = changeRequest.orderId;
    const newItems = JSON.parse(changeRequest.newItems);
    const originalItems = JSON.parse(changeRequest.originalItems);

    switch (changeRequest.changeType) {
      case 'ADD_ITEM':
        // æ–°å¢å•†å“
        const addItems = newItems.map((item) => ({
          orderId,
          quoteItemId: item.id,
          roomName: item.roomName,
          productId: item.productId,
          productName: item.productName,
          category: item.category,
          unitPrice: item.unitPrice,
          quantity: item.quantity,
          width: item.width,
          height: item.height,
          subtotal: item.subtotal,
          status: 'PENDING',
        }));
        await tx.insert(orderItems).values(addItems);
        break;

      case 'REMOVE_ITEM':
        // åˆ é™¤å•†å“
        const removeIds = originalItems.map((item) => item.quoteItemId);
        await tx
          .delete(orderItems)
          .where(
            and(eq(orderItems.orderId, orderId), sql`${orderItems.quoteItemId} = ANY(${removeIds})`)
          );
        break;

      case 'MODIFY_ITEM':
        // ä¿®æ”¹å•†å“
        for (const newItem of newItems) {
          await tx
            .update(orderItems)
            .set({
              quantity: newItem.quantity,
              width: newItem.width,
              height: newItem.height,
              subtotal: newItem.subtotal,
            })
            .where(and(eq(orderItems.orderId, orderId), eq(orderItems.quoteItemId, newItem.id)));
        }
        break;
    }

    // æ›´æ–°è®¢å•æ€»é‡‘é¢
    await this.updateOrderTotalAmount(tx, orderId);
  }

  /**
   * æ›´æ–°è®¢å•æ€»é‡‘é¢
   * @param tx æ•°æ®åº“äº‹åŠ¡
   * @param orderId è®¢å•ID
   */
  private async updateOrderTotalAmount(tx: any, orderId: string): Promise<void> {
    const [result] = await tx
      .select({ total: sql<number>`sum(subtotal)` })
      .from(orderItems)
      .where(eq(orderItems.orderId, orderId));

    const totalAmount = result?.total || 0;

    await tx.update(orders).set({ totalAmount }).where(eq(orders.id, orderId));
  }

  /**
   * è·å–è®¢å•çš„å˜æ›´å†å²
   * @param orderId è®¢å•ID
   * @returns å˜æ›´å†å²åˆ—è¡¨
   */
  async getHistory(orderId: string): Promise<any[]> {
    return await db
      .select()
      .from(changeRequests)
      .where(eq(changeRequests.orderId, orderId))
      .orderBy(changeRequests.createdAt);
  }
}
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] `create` æ–¹æ³•å®ç°å®Œæ•´
- [ ] è®¢å•çŠ¶æ€éªŒè¯æ­£ç¡®
- [ ] å·®ä»·è®¡ç®—å‡†ç¡®
- [ ] `approve` æ–¹æ³•å®ç°å®Œæ•´
- [ ] å˜æ›´åº”ç”¨é€»è¾‘æ­£ç¡®
- [ ] è®¢å•æ€»é‡‘é¢æ›´æ–°æ­£ç¡®

#### 3.1.2 å®¡æ‰¹é€»è¾‘ (Day 6.5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] å®¡æ‰¹é€šè¿‡åè‡ªåŠ¨åº”ç”¨å˜æ›´
- [ ] å®¡æ‰¹æ‹’ç»åè®°å½•åŸå› 
- [ ] çŠ¶æ€æµè½¬æ­£ç¡®

#### 3.1.3 æ‹’ç»é€»è¾‘ (Day 7)

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‹’ç»åŸå› å¿…å¡«
- [ ] æ‹’ç»åè®¢å•ä¸å—å½±å“

### 3.2 å˜æ›´å•APIå®ç° (1.5å¤©)

#### 3.2.1 API Actionåˆ›å»º (Day 7.5)

**æ–‡ä»¶**: `src/features/orders/actions/change-requests.ts`

**å®Œæ•´å®ç°**:

```typescript
'use server';

import { createSafeAction } from '@/lib/actions';
import { z } from 'zod';
import { ChangeRequestService } from '@/services/change-request.service';
import { getTenantId, getUserId } from '@/lib/auth';

// åˆ›å»ºå˜æ›´è¯·æ±‚
const createChangeRequestSchema = z.object({
  orderId: z.string().uuid(),
  changeType: z.enum(['ADD_ITEM', 'REMOVE_ITEM', 'MODIFY_ITEM']),
  changeReason: z.string().min(1, 'å˜æ›´åŸå› ä¸èƒ½ä¸ºç©º'),
  originalItems: z.array(z.any()),
  newItems: z.array(z.any()),
});

export const createChangeRequest = createSafeAction(
  createChangeRequestSchema,
  async (data, ctx) => {
    const userId = getUserId();
    const tenantId = getTenantId();

    const service = new ChangeRequestService();
    const changeRequestId = await service.create(data.orderId, data, userId);

    return { success: true, changeRequestId };
  }
);

// è·å–å˜æ›´å†å²
const getChangeHistorySchema = z.object({
  orderId: z.string().uuid(),
});

export const getChangeHistory = createSafeAction(getChangeHistorySchema, async (data, ctx) => {
  const service = new ChangeRequestService();
  const history = await service.getHistory(data.orderId);

  return { success: true, history };
});

// å®¡æ‰¹å˜æ›´è¯·æ±‚
const approveChangeRequestSchema = z.object({
  changeRequestId: z.string().uuid(),
  approved: z.boolean(),
  rejectionReason: z.string().optional(),
});

export const approveChangeRequest = createSafeAction(
  approveChangeRequestSchema,
  async (data, ctx) => {
    const userId = getUserId();

    const service = new ChangeRequestService();
    await service.approve(data.changeRequestId, data.approved, userId, data.rejectionReason);

    return { success: true };
  }
);
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ‰€æœ‰API Actionåˆ›å»ºå®Œæˆ
- [ ] SchemaéªŒè¯æ­£ç¡®
- [ ] æƒé™æ£€æŸ¥æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„

#### 3.2.2 æƒé™æ§åˆ¶ (Day 8)

**éªŒæ”¶æ ‡å‡†**:

- [ ] åˆ›å»ºå˜æ›´: é”€å”®/å®¢æœ/åº—é•¿
- [ ] å®¡æ‰¹å˜æ›´: ä»…åº—é•¿

### 3.3 å˜æ›´å•å‰ç«¯UI (2.5å¤©)

#### 3.3.1 å˜æ›´ç”³è¯·Dialog (Day 8.5-9.5)

**æ–‡ä»¶**: `src/features/orders/components/change-request-dialog.tsx`

**ç»„ä»¶ç»“æ„**:

```typescript
'use client';

import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { createChangeRequest } from '../actions/change-requests';

interface ChangeRequestDialogProps {
  orderId: string;
  orderItems: any[];
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: () => void;
}

export function ChangeRequestDialog({
  orderId,
  orderItems,
  open,
  onOpenChange,
  onSuccess,
}: ChangeRequestDialogProps) {
  const [changeType, setChangeType] = useState<'ADD_ITEM' | 'REMOVE_ITEM' | 'MODIFY_ITEM'>('MODIFY_ITEM');
  const [changeReason, setChangeReason] = useState('');
  const [selectedItems, setSelectedItems] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async () => {
    if (!changeReason.trim()) {
      alert('è¯·å¡«å†™å˜æ›´åŸå› ');
      return;
    }

    setLoading(true);
    try {
      await createChangeRequest({
        orderId,
        changeType,
        changeReason,
        originalItems: selectedItems,
        newItems: selectedItems, // TODO: å®é™…åº”æ ¹æ®changeTypeå¤„ç†
      });

      onSuccess();
      onOpenChange(false);
      setChangeReason('');
      setSelectedItems([]);
    } catch (error) {
      alert(error instanceof Error ? error.message : 'åˆ›å»ºå¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>ç”³è¯·å˜æ›´è®¢å•</DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* å˜æ›´ç±»å‹é€‰æ‹© */}
          <div>
            <label className="text-sm font-medium">å˜æ›´ç±»å‹</label>
            <Select value={changeType} onValueChange={(v: any) => setChangeType(v)}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="ADD_ITEM">æ–°å¢å•†å“</SelectItem>
                <SelectItem value="REMOVE_ITEM">åˆ é™¤å•†å“</SelectItem>
                <SelectItem value="MODIFY_ITEM">ä¿®æ”¹å•†å“</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {/* å˜æ›´åŸå›  */}
          <div>
            <label className="text-sm font-medium">å˜æ›´åŸå›  *</label>
            <Textarea
              value={changeReason}
              onChange={(e) => setChangeReason(e.target.value)}
              placeholder="è¯·å¡«å†™å˜æ›´åŸå› "
              rows={3}
            />
          </div>

          {/* å•†å“é€‰æ‹©/ç¼–è¾‘ */}
          <div>
            <label className="text-sm font-medium">å•†å“æ˜ç»†</label>
            <div className="mt-2 border rounded-md">
              {orderItems.map((item) => (
                <div key={item.id} className="p-3 border-b last:border-0">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-medium">{item.productName}</div>
                      <div className="text-sm text-gray-500">
                        {item.roomName} - Â¥{item.subtotal}
                      </div>
                    </div>
                    {/* TODO: æ ¹æ®changeTypeæ˜¾ç¤ºä¸åŒçš„æ“ä½œ */}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* å·®ä»·æ˜¾ç¤º */}
          <div className="bg-blue-50 p-3 rounded-md">
            <div className="text-sm font-medium">é¢„è®¡å·®ä»·</div>
            <div className="text-lg font-bold text-blue-600">
              Â¥0.00
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            å–æ¶ˆ
          </Button>
          <Button onClick={handleSubmit} disabled={loading}>
            {loading ? 'æäº¤ä¸­...' : 'æäº¤å˜æ›´'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] Dialogç»„ä»¶UIå®Œæ•´
- [ ] æ”¯æŒä¸‰ç§å˜æ›´ç±»å‹
- [ ] å®æ—¶æ˜¾ç¤ºå·®ä»·è®¡ç®—
- [ ] å˜æ›´åŸå› å¿…å¡«éªŒè¯
- [ ] æäº¤æˆåŠŸååˆ·æ–°åˆ—è¡¨

#### 3.3.2 å˜æ›´å†å²Tab (Day 10)

**æ–‡ä»¶**: `src/features/orders/components/change-history-tab.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ—¶é—´è½´å±•ç¤ºæ‰€æœ‰å˜æ›´è®°å½•
- [ ] æ˜¾ç¤ºå˜æ›´å‰åå¯¹æ¯”
- [ ] çŠ¶æ€æ ‡ç­¾é¢œè‰²æ­£ç¡®

#### 3.3.3 å®¡æ‰¹é¡µé¢é›†æˆ (Day 10.5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] å¾…åŠäº‹é¡¹æ˜¾ç¤ºå¾…å®¡æ‰¹å˜æ›´å•
- [ ] å®¡æ‰¹DialogæŸ¥çœ‹è¯¦æƒ…
- [ ] æ‰¹å‡†/æ‹’ç»æŒ‰é’®å¯ç”¨

### 3.4 Week 2 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] ç«¯åˆ°ç«¯æµç¨‹å¯èµ°é€š(ç”³è¯·â†’å®¡æ‰¹â†’åº”ç”¨)
- [ ] å·®ä»·è®¡ç®—å‡†ç¡®
- [ ] å˜æ›´å†å²å¯è¿½æº¯

**ä»£ç è´¨é‡éªŒæ”¶**:

- [ ] TypeScriptæ— ç±»å‹é”™è¯¯
- [ ] ESLintæ— P0/P1é”™è¯¯
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 60%

---

## 4. Week 3: æ™ºèƒ½æ‹†å•é€»è¾‘ (P0)

**ç›®æ ‡**: å®ç°ä¾›åº”å•†æ™ºèƒ½åŒ¹é…ä¸æ‹†å•ç®—æ³•

### 4.1 æ‹†å•ç®—æ³•è®¾è®¡ä¸å®ç° (3å¤©)

#### 4.1.1 ä¾›åº”å•†åŒ¹é…ç®—æ³• (Day 11-12.5)

**æ–‡ä»¶**: `src/services/supplier-matcher.service.ts`

**å®Œæ•´å®ç°**:

```typescript
import { db } from '@/shared/db';
import { productSuppliers, suppliers } from '@/shared/api/schema/suppliers';
import { eq, and, sql } from 'drizzle-orm';

export class SupplierMatcherService {
  /**
   * ä¸ºè®¢å•å•†å“åŒ¹é…æœ€ä¼˜ä¾›åº”å•†
   * @param orderItems è®¢å•å•†å“åˆ—è¡¨
   * @returns æŒ‰ä¾›åº”å•†åˆ†ç»„çš„å•†å“
   */
  async matchSuppliers(orderItems: any[]): Promise<Map<string, any[]>> {
    const groups = new Map<string, any[]>();

    for (const item of orderItems) {
      const supplier = await this.findBestSupplier(item);
      const supplierId = supplier.id;

      if (!groups.has(supplierId)) {
        groups.set(supplierId, []);
      }
      groups.get(supplierId)!.push({
        ...item,
        supplierId,
        supplierName: supplier.name,
      });
    }

    return groups;
  }

  /**
   * æŸ¥æ‰¾æœ€ä¼˜ä¾›åº”å•†
   * @param item è®¢å•å•†å“
   * @returns æœ€ä¼˜ä¾›åº”å•†
   */
  private async findBestSupplier(item: any): Promise<any> {
    // 1. æŸ¥è¯¢è¯¥äº§å“çš„æ‰€æœ‰ä¾›åº”å•†
    const suppliers = await db
      .select({
        supplier: suppliers,
        productSupplier: productSuppliers,
      })
      .from(productSuppliers)
      .innerJoin(suppliers, eq(productSuppliers.supplierId, suppliers.id))
      .where(eq(productSuppliers.productId, item.productId));

    if (suppliers.length === 0) {
      throw new Error(`å•†å“ ${item.productName} æ— å¯ç”¨ä¾›åº”å•†`);
    }

    // 2. æŒ‰ä¼˜å…ˆçº§æ’åº
    const ranked = suppliers.sort((a, b) => {
      // ä¼˜å…ˆçº§: åº“å­˜å……è¶³ > ä»·æ ¼ä½ > å†å²è¯„åˆ†é«˜
      const aStock = a.productSupplier.stockQuantity || 0;
      const bStock = b.productSupplier.stockQuantity || 0;
      const itemQty = item.quantity || 0;

      // åº“å­˜å……è¶³ä¼˜å…ˆ
      if (aStock >= itemQty && bStock < itemQty) return -1;
      if (aStock < itemQty && bStock >= itemQty) return 1;

      // ä»·æ ¼ä¼˜å…ˆ
      const aPrice = Number(a.productSupplier.unitPrice || 0);
      const bPrice = Number(b.productSupplier.unitPrice || 0);
      if (aPrice !== bPrice) {
        return aPrice - bPrice;
      }

      // è¯„åˆ†ä¼˜å…ˆ
      const aRating = a.supplier.rating || 0;
      const bRating = b.supplier.rating || 0;
      return bRating - aRating;
    });

    return ranked[0].supplier;
  }

  /**
   * è·å–ä¾›åº”å•†è¿è´¹
   * @param supplierId ä¾›åº”å•†ID
   * @param totalAmount è®¢å•é‡‘é¢
   * @returns è¿è´¹
   */
  async getShippingFee(supplierId: string, totalAmount: number): Promise<number> {
    // TODO: æ ¹æ®ä¾›åº”å•†è¿è´¹è§„åˆ™è®¡ç®—
    // æš‚æ—¶è¿”å›å›ºå®šå€¼
    return 0;
  }
}
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] ä¾›åº”å•†åŒ¹é…ç®—æ³•å®ç°
- [ ] ä¼˜å…ˆçº§æ’åºæ­£ç¡®
- [ ] åº“å­˜æ£€æŸ¥æ­£ç¡®
- [ ] ä»·æ ¼æ¯”è¾ƒæ­£ç¡®
- [ ] è¯„åˆ†æ¯”è¾ƒæ­£ç¡®

#### 4.1.2 æŒ‰ä¾›åº”å•†åˆ†ç»„ (Day 13)

**éªŒæ”¶æ ‡å‡†**:

- [ ] å•†å“æŒ‰ä¾›åº”å•†åˆ†ç»„
- [ ] åˆ†ç»„é¢„è§ˆæ•°æ®æ­£ç¡®

#### 4.1.3 è¿è´¹åˆ†æ‘Šé€»è¾‘ (Day 13.5)

**æ–‡ä»¶**: `src/features/orders/logic/order-split-router.ts`

**å®Œæ•´å®ç°**:

```typescript
import { SupplierMatcherService } from '@/services/supplier-matcher.service';
import { Decimal } from 'decimal.js';

export interface SplitResult {
  supplierId: string;
  supplierName: string;
  items: any[];
  subtotal: Decimal;
  shippingFee: Decimal;
  total: Decimal;
}

export class OrderSplitRouter {
  private supplierMatcher: SupplierMatcherService;

  constructor() {
    this.supplierMatcher = new SupplierMatcherService();
  }

  /**
   * æ‹†å•é¢„è§ˆ
   * @param orderId è®¢å•ID
   * @returns æ‹†å•ç»“æœ
   */
  async preview(orderId: string): Promise<SplitResult[]> {
    // 1. è·å–è®¢å•å•†å“
    const orderItems = await this.getOrderItems(orderId);

    // 2. åŒ¹é…ä¾›åº”å•†
    const groups = await this.supplierMatcher.matchSuppliers(orderItems);

    // 3. è®¡ç®—è¿è´¹åˆ†æ‘Š
    const results = await this.allocateShippingFee(groups);

    return results;
  }

  /**
   * ç¡®è®¤æ‹†å•
   * @param orderId è®¢å•ID
   * @param splitResults æ‹†å•ç»“æœ
   */
  async confirm(orderId: string, splitResults: SplitResult[]): Promise<void> {
    // TODO: ç”Ÿæˆé‡‡è´­å•
    // TODO: æ›´æ–°orderItems.supplierIdå’ŒpurchaseOrderId
  }

  /**
   * è·å–è®¢å•å•†å“
   * @param orderId è®¢å•ID
   * @returns è®¢å•å•†å“åˆ—è¡¨
   */
  private async getOrderItems(orderId: string): Promise<any[]> {
    // TODO: æŸ¥è¯¢orderItemsè¡¨
    return [];
  }

  /**
   * è¿è´¹åˆ†æ‘Š
   * @param groups æŒ‰ä¾›åº”å•†åˆ†ç»„çš„å•†å“
   * @returns æ‹†å•ç»“æœ
   */
  private async allocateShippingFee(groups: Map<string, any[]>): Promise<SplitResult[]> {
    const results: SplitResult[] = [];

    // è®¡ç®—æ€»é‡‘é¢
    const totalAmount = Array.from(groups.values())
      .flat()
      .reduce((sum, item) => sum.plus(new Decimal(item.subtotal || 0)), new Decimal(0));

    // æŒ‰ä¾›åº”å•†åˆ†æ‘Šè¿è´¹
    for (const [supplierId, items] of groups.entries()) {
      const groupTotal = items.reduce(
        (sum, item) => sum.plus(new Decimal(item.subtotal || 0)),
        new Decimal(0)
      );

      const ratio = groupTotal.div(totalAmount);
      const shippingFee = await this.supplierMatcher.getShippingFee(supplierId, Number(groupTotal));

      const allocatedFee = new Decimal(shippingFee).mul(ratio);

      results.push({
        supplierId,
        supplierName: items[0].supplierName,
        items,
        subtotal: groupTotal,
        shippingFee: allocatedFee,
        total: groupTotal.plus(allocatedFee),
      });
    }

    return results;
  }
}
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] è¿è´¹åˆ†æ‘Šé€»è¾‘æ­£ç¡®
- [ ] æŒ‰é‡‘é¢æ¯”ä¾‹åˆ†æ‘Š
- [ ] è®¡ç®—ç²¾åº¦æ­£ç¡®(ä½¿ç”¨Decimal)

### 4.2 æ‹†å•APIå®ç° (1å¤©)

#### 4.2.1 æ‹†å•é¢„è§ˆAPI (Day 14)

**æ–‡ä»¶**: `src/features/orders/actions/split.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] `POST /api/orders/:id/split/preview` å®ç°
- [ ] è¿”å›åˆ†ç»„ç»“æœå’Œè¿è´¹åˆ†æ‘Š

#### 4.2.2 æ‹†å•ç¡®è®¤API (Day 14.5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] `POST /api/orders/:id/split/confirm` å®ç°
- [ ] ç”Ÿæˆå¤šä¸ªé‡‡è´­å•
- [ ] æ›´æ–°orderItemså­—æ®µ

### 4.3 æ‹†å•å‰ç«¯UI (2å¤©)

#### 4.3.1 æ‹†å•é¡µé¢ (Day 15-16)

**æ–‡ä»¶**: `src/app/(dashboard)/orders/[id]/split/page.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] å·¦ä¾§Itemsåˆ—è¡¨
- [ ] å³ä¾§åˆ†ç»„é¢„è§ˆ
- [ ] åº•éƒ¨è¿è´¹åˆ†æ‘Šæ˜ç»†è¡¨

#### 4.3.2 æ‹†å•Dialog (Day 16.5)

**æ–‡ä»¶**: `src/features/orders/components/split-order-dialog.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ˜¾ç¤ºé¢„è§ˆç»“æœ
- [ ] ç¡®è®¤åè·³è½¬é‡‡è´­å•åˆ—è¡¨

### 4.4 Week 3 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] æ™ºèƒ½åŒ¹é…å‡†ç¡®ç‡ >= 95%
- [ ] è¿è´¹åˆ†æ‘Šé€»è¾‘æ­£ç¡®
- [ ] ç”Ÿæˆçš„é‡‡è´­å•æ•°æ®å®Œæ•´

**ä»£ç è´¨é‡éªŒæ”¶**:

- [ ] TypeScriptæ— ç±»å‹é”™è¯¯
- [ ] ESLintæ— P0/P1é”™è¯¯
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 60%

---

## 5. Week 4: å‘è´§ä¸ç‰©æµæµç¨‹ (P0)

**ç›®æ ‡**: å®ç°å‘è´§ç”³è¯·ã€ç¡®è®¤å’Œç‰©æµè½¨è¿¹æŸ¥è¯¢

### 5.1 å‘è´§æµç¨‹åç«¯ (2å¤©)

#### 5.1.1 ç”³è¯·å‘è´§API (Day 17-18)

**æ–‡ä»¶**: `src/features/orders/actions/delivery.ts`

**å®Œæ•´å®ç°**:

```typescript
'use server';

import { createSafeAction } from '@/lib/actions';
import { z } from 'zod';
import { db } from '@/shared/db';
import { orders, orderItems } from '@/shared/api/schema/orders';
import { eq, and } from 'drizzle-orm';

const requestDeliverySchema = z.object({
  orderId: z.string().uuid(),
  deliveryAddress: z.string().min(1, 'å‘è´§åœ°å€ä¸èƒ½ä¸ºç©º'),
});

export const requestDelivery = createSafeAction(requestDeliverySchema, async (data, ctx) => {
  return await db.transaction(async (tx) => {
    // 1. éªŒè¯è®¢å•çŠ¶æ€
    const [order] = await tx.select().from(orders).where(eq(orders.id, data.orderId)).limit(1);

    if (!order) {
      throw new Error('è®¢å•ä¸å­˜åœ¨');
    }

    if (order.status !== 'PENDING_DELIVERY') {
      throw new Error('ä»…å¾…å‘è´§çŠ¶æ€å¯ç”³è¯·å‘è´§');
    }

    // 2. éªŒè¯åº“å­˜çŠ¶æ€
    const items = await tx.select().from(orderItems).where(eq(orderItems.orderId, data.orderId));

    const allInStock = items.every((item) => item.deliveryStatus === 'DELIVERED');
    if (!allInStock) {
      throw new Error('éƒ¨åˆ†å•†å“æœªå…¥åº“,æ— æ³•å‘è´§');
    }

    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    await tx
      .update(orders)
      .set({
        status: 'PENDING_SHIPMENT',
        deliveryAddress: data.deliveryAddress,
      })
      .where(eq(orders.id, data.orderId));

    return { success: true };
  });
});
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] åº“å­˜çŠ¶æ€éªŒè¯æ­£ç¡®
- [ ] å‘è´§åœ°å€éªŒè¯æ­£ç¡®
- [ ] çŠ¶æ€å˜æ›´æ­£ç¡®

#### 5.1.2 ç¡®è®¤å‘è´§API (Day 18.5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] å¡«å†™ç‰©æµå…¬å¸å’Œè¿å•å·
- [ ] çŠ¶æ€å˜æ›´è‡³SHIPPED
- [ ] è§¦å‘ç‰©æµè¿½è¸ª

### 5.2 ç‰©æµè½¨è¿¹é›†æˆ (2å¤©)

#### 5.2.1 å¿«é€’100 SDKå®‰è£…ä¸é…ç½® (Day 19)

**éªŒæ”¶æ ‡å‡†**:

- [ ] `pnpm add kuaidi100-sdk`
- [ ] é…ç½®API Key(ç¯å¢ƒå˜é‡)

#### 5.2.2 LogisticsServiceåˆ›å»º (Day 19.5-20)

**æ–‡ä»¶**: `src/services/logistics.service.ts`

**å®Œæ•´å®ç°**:

```typescript
import Kuaidi100 from 'kuaidi100-sdk';

export interface LogisticsTracking {
  trackingNumber: string;
  company: string;
  companyName: string;
  status: string;
  timeline: Array<{
    time: string;
    status: string;
    location: string;
    description: string;
  }>;
  estimatedDelivery: string | null;
}

export class LogisticsService {
  private client: any;

  constructor() {
    this.client = new Kuaidi100({
      key: process.env.KUAIDI100_API_KEY,
      secret: process.env.KUAIDI100_SECRET,
    });
  }

  /**
   * è®¢é˜…ç‰©æµæ¨é€
   * @param trackingNumber è¿å•å·
   * @param company ç‰©æµå…¬å¸ä»£ç 
   */
  async subscribe(trackingNumber: string, company: string): Promise<void> {
    await this.client.subscribe({
      company,
      number: trackingNumber,
      phone: '', // å¯é€‰
    });
  }

  /**
   * æŸ¥è¯¢ç‰©æµè½¨è¿¹
   * @param trackingNumber è¿å•å·
   * @param company ç‰©æµå…¬å¸ä»£ç 
   * @returns ç‰©æµè½¨è¿¹
   */
  async query(trackingNumber: string, company: string): Promise<LogisticsTracking> {
    const result = await this.client.query({
      company,
      number: trackingNumber,
    });

    return {
      trackingNumber,
      company,
      companyName: this.getCompanyName(company),
      status: result.state,
      timeline: result.data.map((item: any) => ({
        time: item.time,
        status: item.context,
        location: item.location || '',
        description: item.context,
      })),
      estimatedDelivery: null, // TODO: è§£æé¢„è®¡é€è¾¾æ—¶é—´
    };
  }

  /**
   * è·å–ç‰©æµå…¬å¸åç§°
   * @param code ç‰©æµå…¬å¸ä»£ç 
   * @returns ç‰©æµå…¬å¸åç§°
   */
  private getCompanyName(code: string): string {
    const companies: Record<string, string> = {
      SF: 'é¡ºä¸°é€Ÿè¿',
      DB: 'å¾·é‚¦å¿«é€’',
      ZTO: 'ä¸­é€šå¿«é€’',
      YTO: 'åœ†é€šé€Ÿé€’',
      STO: 'ç”³é€šå¿«é€’',
      SELF_PICKUP: 'è‡ªæ',
    };
    return companies[code] || code;
  }

  /**
   * å¤„ç†ç‰©æµå›è°ƒ
   * @param data å›è°ƒæ•°æ®
   */
  async handleWebhook(data: any): Promise<void> {
    // TODO: æ›´æ–°è®¢å•ç‰©æµçŠ¶æ€
    // TODO: é€šçŸ¥ç›¸å…³ç”¨æˆ·
  }
}
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] `subscribe` æ–¹æ³•å®ç°
- [ ] `query` æ–¹æ³•å®ç°
- [ ] Webhookå¤„ç†å®ç°

#### 5.2.3 ç‰©æµè½¨è¿¹API (Day 20.5)

**æ–‡ä»¶**: `src/features/orders/actions/logistics.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] `GET /api/orders/:id/logistics-track` å®ç°
- [ ] è¿”å›ç‰©æµçŠ¶æ€å’Œè½¨è¿¹åˆ—è¡¨

### 5.3 å‘è´§å‰ç«¯UI (2å¤©)

#### 5.3.1 å‘è´§ç”³è¯·Dialog (Day 21)

**æ–‡ä»¶**: `src/features/orders/components/delivery-request-dialog.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ˜¾ç¤ºå‘è´§åœ°å€(å…è®¸ä¿®æ”¹)
- [ ] åº“å­˜æ£€æŸ¥æç¤º

#### 5.3.2 ç¡®è®¤å‘è´§Dialog (Day 21.5)

**æ–‡ä»¶**: `src/features/orders/components/delivery-confirm-dialog.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] å¡«å†™ç‰©æµå…¬å¸å’Œè¿å•å·
- [ ] æ”¯æŒæ‰«ç å½•å…¥è¿å•å·

#### 5.3.3 ç‰©æµè½¨è¿¹å±•ç¤º (Day 22)

**æ–‡ä»¶**: `src/features/orders/components/logistics-track-card.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ—¶é—´è½´å±•ç¤ºç‰©æµè½¨è¿¹
- [ ] å®æ—¶æ›´æ–°(è½®è¯¢æˆ–WebSocket)

### 5.4 Week 4 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] å‘è´§æµç¨‹ç«¯åˆ°ç«¯å¯æ‰§è¡Œ
- [ ] ç‰©æµè½¨è¿¹å®æ—¶æ›´æ–°
- [ ] å¼‚å¸¸ç‰©æµçŠ¶æ€æœ‰æç¤º

**ä»£ç è´¨é‡éªŒæ”¶**:

- [ ] TypeScriptæ— ç±»å‹é”™è¯¯
- [ ] ESLintæ— P0/P1é”™è¯¯
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 60%

---

## 6. Week 5: å«åœæœºåˆ¶ + P1åŠŸèƒ½ (P0+P1)

**ç›®æ ‡**: å®Œæˆå«åœæœºåˆ¶å’Œå…¶ä»–P1é‡è¦åŠŸèƒ½

### 6.1 å«åœæœºåˆ¶ (1.5å¤©)

#### 6.1.1 å«åœAPI (Day 23)

**æ–‡ä»¶**: `src/features/orders/actions/halt.ts`

**å®Œæ•´å®ç°**:

```typescript
'use server';

import { createSafeAction } from '@/lib/actions';
import { z } from 'zod';
import { db } from '@/shared/db';
import { orders } from '@/shared/api/schema/orders';
import { eq } from 'drizzle-orm';

const haltOrderSchema = z.object({
  orderId: z.string().uuid(),
  haltedReason: z.string().min(1, 'å«åœåŸå› ä¸èƒ½ä¸ºç©º'),
});

export const haltOrder = createSafeAction(haltOrderSchema, async (data, ctx) => {
  return await db.transaction(async (tx) => {
    // 1. éªŒè¯è®¢å•çŠ¶æ€
    const [order] = await tx.select().from(orders).where(eq(orders.id, data.orderId)).limit(1);

    if (!order) {
      throw new Error('è®¢å•ä¸å­˜åœ¨');
    }

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å«åœ
    const canHaltStatuses = [
      'PENDING_PO',
      'PENDING_CONFIRMATION',
      'PENDING_PRODUCTION',
      'FABRIC_PURCHASING',
      'PROCESSING',
      'IN_PRODUCTION',
    ];

    if (!canHaltStatuses.includes(order.status)) {
      throw new Error(`å½“å‰çŠ¶æ€ ${order.status} ä¸å…è®¸å«åœ`);
    }

    // 2. è®°å½•å«åœ
    await tx
      .update(orders)
      .set({
        previousStatus: order.status,
        status: 'HALTED',
        haltedReason: data.haltedReason,
        haltedAt: new Date(),
      })
      .where(eq(orders.id, data.orderId));

    return { success: true };
  });
});
```

**éªŒæ”¶æ ‡å‡†**:

- [ ] è®°å½•previous_status
- [ ] è®°å½•halted_reasonå’Œhalted_at
- [ ] çŠ¶æ€å˜æ›´è‡³HALTED

#### 6.1.2 æ¢å¤API (Day 23.5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] æ¢å¤è‡³previous_status
- [ ] æ¸…ç©ºhalted_reasonå’Œhalted_at

#### 6.1.3 å«åœDialog (Day 24)

**æ–‡ä»¶**: `src/features/orders/components/halt-order-dialog.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] å¿…å¡«å«åœåŸå› 
- [ ] æ˜¾ç¤ºå«åœå†å²

### 6.2 æ’¤å•å®¡æ‰¹æµç¨‹ (2å¤©)

#### 6.2.1 æ’¤å•API (Day 24.5-25)

**æ–‡ä»¶**: `src/features/orders/actions/cancel.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æäº¤å®¡æ‰¹å·¥ä½œæµ
- [ ] å®¡æ‰¹é€šè¿‡åçŠ¶æ€å˜ä¸ºCANCELLED

#### 6.2.2 æ’¤å•Dialog (Day 25.5)

**æ–‡ä»¶**: `src/features/orders/components/cancel-order-dialog.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] å¿…å¡«æ’¤å•åŸå› 
- [ ] æ˜¾ç¤ºå®¡æ‰¹è¿›åº¦

### 6.3 å‰ç«¯ä¼˜åŒ– (2.5å¤©)

#### 6.3.1 Tabå¸ƒå±€é‡æ„ (Day 26)

**æ–‡ä»¶**: `src/app/(dashboard)/orders/[id]/page.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] è®¢å•è¯¦æƒ…é¡µæ”¹ä¸ºTabå¸ƒå±€
- [ ] Tab: è®¢å•è¯¦æƒ…/å˜æ›´å†å²/æ“ä½œæ—¥å¿—/å…³è”å•æ®

#### 6.3.2 é«˜çº§ç­›é€‰ä¸åˆ†é¡µ (Day 27)

**æ–‡ä»¶**: `src/features/orders/components/orders-filter-dialog.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] åˆ—è¡¨é¡µæ·»åŠ ç­›é€‰Dialog
- [ ] ç­›é€‰æ¡ä»¶: çŠ¶æ€/é”€å”®/é‡‘é¢åŒºé—´/æ—¥æœŸèŒƒå›´
- [ ] å®ç°å‰ç«¯åˆ†é¡µç»„ä»¶
- [ ] è¿æ¥åç«¯åˆ†é¡µAPI

#### 6.3.3 å¿«ç…§å¯¹æ¯”UI (Day 27.5)

**æ–‡ä»¶**: `src/features/orders/components/snapshot-compare-view.tsx`

**éªŒæ”¶æ ‡å‡†**:

- [ ] å·¦å³å¯¹æ¯”åŸå§‹æŠ¥ä»·vså½“å‰è®¢å•
- [ ] é«˜äº®å˜æ›´éƒ¨åˆ†

### 6.4 Week 5 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] å«åœ/æ¢å¤æµç¨‹å¯æ‰§è¡Œ
- [ ] æ’¤å•å®¡æ‰¹é›†æˆæˆåŠŸ
- [ ] ç­›é€‰å’Œåˆ†é¡µåŠŸèƒ½æ­£å¸¸

**ä»£ç è´¨é‡éªŒæ”¶**:

- [ ] TypeScriptæ— ç±»å‹é”™è¯¯
- [ ] ESLintæ— P0/P1é”™è¯¯
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 60%

---

## 7. Week 6: æµ‹è¯•ä¸ä¸Šçº¿å‡†å¤‡ (P2)

**ç›®æ ‡**: å®Œæˆæµ‹è¯•è¦†ç›–å’Œç”Ÿäº§å‡†å¤‡

### 7.1 å•å…ƒæµ‹è¯• (2å¤©)

#### 7.1.1 OrderServiceæµ‹è¯• (Day 28)

**æ–‡ä»¶**: `src/services/__tests__/order.service.test.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æµ‹è¯•è®¢å•åˆ›å»ºé€»è¾‘
- [ ] æµ‹è¯•å¿«ç…§ä¿å­˜
- [ ] æµ‹è¯•ç»“ç®—æ–¹å¼æ¨æ–­

#### 7.1.2 ChangeRequestServiceæµ‹è¯• (Day 28.5)

**æ–‡ä»¶**: `src/services/__tests__/change-request.service.test.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æµ‹è¯•å·®ä»·è®¡ç®—
- [ ] æµ‹è¯•å®¡æ‰¹ååº”ç”¨å˜æ›´

#### 7.1.3 æ‹†å•ç®—æ³•æµ‹è¯• (Day 29)

**æ–‡ä»¶**: `src/features/orders/logic/__tests__/order-split-router.test.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æµ‹è¯•ä¾›åº”å•†åŒ¹é…
- [ ] æµ‹è¯•è¿è´¹åˆ†æ‘Š

#### 7.1.4 çŠ¶æ€æµè½¬æµ‹è¯• (Day 29.5)

**æ–‡ä»¶**: `src/features/orders/__tests__/state-machine.test.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] æµ‹è¯•çŠ¶æ€æœºåˆæ³•æ€§
- [ ] æµ‹è¯•éæ³•çŠ¶æ€è½¬æ¢æ‹¦æˆª

### 7.2 E2Eæµ‹è¯• (2å¤©)

#### 7.2.1 å®Œæ•´è®¢å•æµç¨‹ (Day 30)

**æ–‡ä»¶**: `tests/e2e/order-lifecycle.spec.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] ä»æŠ¥ä»·è½¬è®¢å•
- [ ] æ‹†å•
- [ ] å‘è´§
- [ ] ç‰©æµè¿½è¸ª
- [ ] å®Œæˆ

#### 7.2.2 å˜æ›´å•æµç¨‹ (Day 30.5)

**æ–‡ä»¶**: `tests/e2e/order-change-request.spec.ts`

**éªŒæ”¶æ ‡å‡†**:

- [ ] ç”³è¯·å˜æ›´
- [ ] å®¡æ‰¹
- [ ] åº”ç”¨å˜æ›´

#### 7.2.3 å¼‚å¸¸æµç¨‹ (Day 31)

**éªŒæ”¶æ ‡å‡†**:

- [ ] å«åœä¸æ¢å¤
- [ ] æ’¤å•å®¡æ‰¹

### 7.3 æ€§èƒ½ä¼˜åŒ–ä¸å®‰å…¨åŠ å›º (2å¤©)

#### 7.3.1 æ€§èƒ½ä¼˜åŒ– (Day 31.5-32)

**éªŒæ”¶æ ‡å‡†**:

- [ ] è®¢å•åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–(ç´¢å¼•éªŒè¯)
- [ ] æ‹†å•ç®—æ³•æ€§èƒ½æµ‹è¯•(1000 items < 3s)
- [ ] å‰ç«¯åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨(å¦‚éœ€)

#### 7.3.2 å®‰å…¨åŠ å›º (Day 32.5)

**éªŒæ”¶æ ‡å‡†**:

- [ ] æƒé™æ£€æŸ¥å®Œå–„
- [ ] æ“ä½œæ—¥å¿—é›†æˆ(AuditLog)
- [ ] æ•æ„Ÿå­—æ®µè„±æ•(æ‰‹æœºå·)
- [ ] SQLæ³¨å…¥é˜²æŠ¤éªŒè¯

### 7.4 Week 6 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 70%
- [ ] E2Eæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- [ ] å®‰å…¨æ£€æŸ¥æ— P0/P1é—®é¢˜

---

## 8. éªŒæ”¶æ ‡å‡†

### 8.1 åŠŸèƒ½å®Œæ•´æ€§

- [ ] è®¢å•å¿«ç…§æœºåˆ¶100%å¯ç”¨
- [ ] å˜æ›´å•æµç¨‹ç«¯åˆ°ç«¯å¯æ‰§è¡Œ
- [ ] æ™ºèƒ½æ‹†å•ç®—æ³•æ­£ç¡®ç‡>=95%
- [ ] æ‰€æœ‰18ä¸ªæ ¸å¿ƒAPIå®ç°ä¸”æµ‹è¯•é€šè¿‡
- [ ] UI/UX Flowå®Œæ•´æ— é˜»å¡ç‚¹

### 8.2 æ€§èƒ½æ ‡å‡†

- [ ] 1000+è®¢å•åˆ—è¡¨åŠ è½½æ—¶é—´ <2s
- [ ] æ‹†å•ç®—æ³•å“åº”æ—¶é—´ <3s
- [ ] è®¢å•è¯¦æƒ…é¡µé¦–å±åŠ è½½ <1s

### 8.3 è´¨é‡æ ‡å‡†

- [ ] ä»£ç å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >=70%
- [ ] E2Eæµ‹è¯•è¦†ç›–æ ¸å¿ƒFlow
- [ ] æ— P0/P1çº§åˆ«linté”™è¯¯

---

## 9. é£é™©åº”å¯¹

### 9.1 é«˜é£é™©åº”å¯¹

**é£é™©1: æ‹†å•ç®—æ³•å¤æ‚åº¦è¶…é¢„æœŸ**

- **é¢„é˜²**: Week 1æå‰è¿›è¡Œç®—æ³•åŸå‹éªŒè¯
- **åº”å¯¹**: è‹¥ç®—æ³•éš¾åº¦è¿‡é«˜,å…ˆå®ç°æ‰‹åŠ¨é€‰æ‹©ä¾›åº”å•†ç‰ˆæœ¬,æ™ºèƒ½åŒ¹é…æ”¾åˆ°P2
- **é™çº§**: æœ€åæƒ…å†µä¸‹ä»…å®ç°æ‰‹åŠ¨æ‹†å•

**é£é™©2: é‡‡è´­æ¨¡å—æœªå®Œæˆ**

- **é¢„é˜²**: Week 1ç«‹å³å®¡è®¡é‡‡è´­æ¨¡å—,è¯„ä¼°å®Œæˆåº¦
- **åº”å¯¹**: è‹¥POæ¨¡å—ä¸¥é‡ä¸è¶³,å…ˆMocké‡‡è´­å•åˆ›å»º,åç»­è¡¥é½
- **é™çº§**: æ‹†å•ä»…åˆ†ç»„é¢„è§ˆ,ä¸å®é™…ç”ŸæˆPO

### 9.2 ä¸­é£é™©åº”å¯¹

**é£é™©3: å¿«é€’100 APIä¸ç¨³å®š**

- **é¢„é˜²**: Week 4å…ˆæµ‹è¯•APIè¿é€šæ€§å’Œç¨³å®šæ€§
- **åº”å¯¹**: å¢åŠ é™çº§æ–¹æ¡ˆ:æ‰‹åŠ¨å½•å…¥ç‰©æµä¿¡æ¯
- **é™çº§**: ç‰©æµè½¨è¿¹æ”¹ä¸ºæ‰‹åŠ¨æ›´æ–°

**é£é™©4: å®¡æ‰¹æµç¨‹æœªå®Œæˆ**

- **é¢„é˜²**: Week 2å…ˆç¡®è®¤Approvalæ¨¡å—çŠ¶æ€
- **åº”å¯¹**: ç®€åŒ–å®¡æ‰¹æµç¨‹,åº—é•¿ç›´æ¥æ‰¹å‡†,ä¸èµ°å¤æ‚å·¥ä½œæµ
- **é™çº§**: å˜æ›´å•å’Œæ’¤å•æ— éœ€å®¡æ‰¹,ä»…è®°å½•æ“ä½œäºº

**é£é™©5: å˜æ›´å•æµç¨‹ä¸å®é™…ä¸šåŠ¡ä¸ç¬¦**

- **é¢„é˜²**: Week 2å¼€å‘å‰ä¸ä¸šåŠ¡ç¡®è®¤è¯¦ç»†æµç¨‹
- **åº”å¯¹**: å¿«é€Ÿè¿­ä»£,åˆ†é˜¶æ®µäº¤ä»˜éªŒè¯
- **é™çº§**: å…ˆå®ç°åŸºç¡€å˜æ›´åŠŸèƒ½,å¤æ‚åœºæ™¯åç»­è¿­ä»£

---

## 10. é™„å½•

### 10.1 å…³é”®æ–‡ä»¶æ¸…å•

**Schema**:

- `src/shared/api/schema/orders.ts` - éœ€å¤§é‡ä¿®æ”¹
- `src/shared/api/schema/change-requests.ts` - æ–°å»º

**Service**:

- `src/services/order.service.ts` - éœ€æ‰©å±•
- `src/services/change-request.service.ts` - æ–°å»º
- `src/services/supplier-matcher.service.ts` - æ–°å»º
- `src/services/logistics.service.ts` - æ–°å»º

**Actions**:

- `src/features/orders/actions/orders.ts` - éœ€è¡¥å…¨API
- `src/features/orders/actions/change-requests.ts` - æ–°å»º
- `src/features/orders/actions/split.ts` - æ–°å»º
- `src/features/orders/actions/delivery.ts` - æ–°å»º
- `src/features/orders/actions/logistics.ts` - æ–°å»º
- `src/features/orders/actions/halt.ts` - æ–°å»º
- `src/features/orders/actions/cancel.ts` - æ–°å»º

**UI**:

- `src/app/(dashboard)/orders/page.tsx` - éœ€æ·»åŠ Tab/ç­›é€‰
- `src/app/(dashboard)/orders/[id]/page.tsx` - éœ€é‡æ„ä¸ºTabå¸ƒå±€
- `src/app/(dashboard)/orders/[id]/split/page.tsx` - æ–°å»º
- `src/features/orders/components/change-request-dialog.tsx` - æ–°å»º
- `src/features/orders/components/change-history-tab.tsx` - æ–°å»º
- `src/features/orders/components/split-order-dialog.tsx` - æ–°å»º
- `src/features/orders/components/delivery-request-dialog.tsx` - æ–°å»º
- `src/features/orders/components/delivery-confirm-dialog.tsx` - æ–°å»º
- `src/features/orders/components/logistics-track-card.tsx` - æ–°å»º
- `src/features/orders/components/halt-order-dialog.tsx` - æ–°å»º
- `src/features/orders/components/cancel-order-dialog.tsx` - æ–°å»º
- `src/features/orders/components/orders-filter-dialog.tsx` - æ–°å»º
- `src/features/orders/components/snapshot-compare-view.tsx` - æ–°å»º

**é€»è¾‘**:

- `src/features/orders/logic/order-split-router.ts` - éœ€å®Œå…¨é‡å†™

**æµ‹è¯•**:

- `src/services/__tests__/order.service.test.ts` - æ–°å»º
- `src/services/__tests__/change-request.service.test.ts` - æ–°å»º
- `src/features/orders/logic/__tests__/order-split-router.test.ts` - é‡å†™
- `src/features/orders/__tests__/state-machine.test.ts` - æ–°å»º
- `tests/e2e/order-lifecycle.spec.ts` - æ–°å»º
- `tests/e2e/order-change-request.spec.ts` - æ–°å»º

### 10.2 å¤–éƒ¨ä¾èµ–

| ä¾èµ–é¡¹             |   çŠ¶æ€    | é£é™© | ç¼“è§£æªæ–½                       |
| :----------------- | :-------: | :--: | :----------------------------- |
| é‡‡è´­æ¨¡å—(PO)       |  âš ï¸ æœªçŸ¥  |  é«˜  | Week 1å…ˆå®¡è®¡POæ¨¡å—             |
| å®¡æ‰¹æµç¨‹(Approval) |  âš ï¸ æœªçŸ¥  |  ä¸­  | ç®€åŒ–ä¸ºåº—é•¿ç›´æ¥å®¡æ‰¹(ä¸èµ°å·¥ä½œæµ) |
| å¿«é€’100 API        | âŒ æœªé›†æˆ |  ä¸­  | ç”³è¯·API Key,æµ‹è¯•è¿é€šæ€§         |
| æŠ¥ä»·æ¨¡å—(Quote)    | âœ… å·²å®Œæˆ |  ä½  | -                              |

---

**æ–‡æ¡£ç»“æŸ**
