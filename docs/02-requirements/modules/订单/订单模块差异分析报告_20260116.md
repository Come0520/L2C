# 订单模块差异分析报告

**生成时间**: 2026-01-16  
**审计对象**: 订单管理模块 (Order Module)  
**对比基准**: 需求文档 `docs/02-requirements/modules/订单/订单.md` + API文档 `docs/04-api/02-modules/orders.md`

---

## 1. 执行摘要 (Executive Summary)

### 1.1 总体完成度估算

| 维度 | 完成度 | 状态 |
|:---|:---:|:---|
| **数据库Schema** | **60%** | ⚠️ 核心字段缺失严重 |
| **业务逻辑** | **30%** | ❌ 多个核心功能未实现 |
| **API Coverage** | **35%** | ❌ 关键API缺失或Mock |
| **UI/UX实现** | **40%** | ⚠️ 基础展示有，高级功能缺 |
| **🎯 总体完成度** | **~35%** | ❌ **需要大量工作** |

### 1.2 关键风险与缺失功能

#### 🔴 P0 高优先级缺失

1. **订单快照机制 (Snapshot)** - 完全缺失
   - Schema中缺少 `snapshotData` JSONB字段
   - 报价数据未在订单创建时冻结
   - 变更单无法对比原始数据

2. **变更单 (Change Order)** - 完全缺失
   - 无 `changeRequests` 数据表
   - 无变更审批流程
   - 无差价计算逻辑

3. **订单锁定/解锁机制** - 部分实现
   - Schema有 `isLocked` 字段
   - Service有 `lockOrder` 方法
   - **但缺少解锁API和前端UI**

4. **叫停机制 (HALTED状态)** - 完全缺失
   - Schema enum缺少 `HALTED` 状态
   - 无叫停原因字段
   - 无恢复流程

5. **智能拆单逻辑** - Mock实现
   - `order-split-router.ts` 仅5行Mock代码
   - 无供应商匹配算法
   - 无运费分摊逻辑

6. **物流轨迹查询** - 完全缺失
   - API文档定义了 `GET /orders/{id}/logistics-track`
   - **实际未实现**
   - 缺少快递100 SDK集成

#### 🟡 P1 中优先级缺失

1. **深化图确认流程** - 状态存在但逻辑缺失
   - 有 `PENDING_CONFIRMATION` 状态
   - **缺少确认图片上传接口**
   - **缺少超时自动确认逻辑**

2. **订单撤单审批** - 完全缺失
   - Schema缺少 `cancelReason`, `cancelledAt`, `cancelledBy` 字段
   - 无审批工作流集成

3. **高级筛选与分页** - 基础实现
   - 列表页有搜索框，但**未连接后端**
   - Schema定义了筛选支持，但**前端未使用**
   - **完全缺少分页**

---

## 2. 数据库Schema差异分析

### 2.1 核心字段缺失

#### 2.1.1 订单主表 (orders)

| 字段名 | 需求文档要求 | 当前Schema | 差异说明 |
|:---|:---|:---:|:---|
| `snapshotData` | `JSONB NOT NULL` | ❌ 缺失 | **致命缺陷**: 无法保存报价快照 |
| `quote_version_id` | `UUID REFERENCES quotes(id)` | ✅ 已实现 | - |
| `halted_reason` | `TEXT` | ❌ 缺失 | 叫停功能无法记录原因 |
| `halted_at` | `TIMESTAMP` | ❌ 缺失 | 无法记录叫停时间 |
| `cancel_reason` | `TEXT` | ❌ 缺失 | 撤单功能缺失 |
| `cancelled_by` | `UUID REFERENCES users` | ❌ 缺失 | 无法追溯撤单人 |
| `cancelled_at` | `TIMESTAMP` | ❌ 缺失 | 无法记录撤单时间 |
| `locked_by` | `UUID REFERENCES users` | ❌ 缺失 | 有 `isLocked` 但不知道谁锁定的 |
| `confirmation_deadline` | `TIMESTAMP` | ❌ 缺失 | 深化图确认流程无超时机制 |

**影响**: 
- 无法实现完整的订单生命周期管理
- 数据追溯不完整，审计日志不全
- 变更单功能无法实施（依赖快照对比）

#### 2.1.2 订单明细表 (orderItems)

| 字段名 | 需求文档要求 | 当前Schema | 差异说明 |
|:---|:---|:---:|:---|
| 基础字段 | - | ✅ 完整 | `productId`, `quantity`, `width`, `height` 等均存在 |
| `supplier_id` | `UUID REFERENCES suppliers` | ❌ 缺失 | **拆单核心字段缺失** |
| `purchase_order_id` | `UUID REFERENCES purchase_orders` | ❌ 缺失 | 无法关联采购单 |
| `delivery_status` | `ENUM` | ❌ 缺失 | 无法跟踪单个Item交付状态 |
| `delivered_at` | `TIMESTAMP` | ❌ 缺失 | - |

**影响**:
- 拆单功能无法按供应商分配Item
- 采购流程与订单流程脱节
- 无法实现部分发货

#### 2.1.3 变更单表 (changeRequests) - **完全缺失**

**需求文档要求**:
```sql
CREATE TABLE change_requests (
  id UUID PRIMARY KEY,
  order_id UUID NOT NULL REFERENCES orders(id),
  change_type TEXT NOT NULL,  -- ADD_ITEM, REMOVE_ITEM, MODIFY_ITEM
  change_reason TEXT NOT NULL,
  original_items JSONB,
  new_items JSONB,
  price_difference DECIMAL(10,2),
  status TEXT NOT NULL,  -- PENDING, APPROVED, REJECTED
  approved_by UUID REFERENCES users(id),
  approved_at TIMESTAMP,
  created_by UUID NOT NULL,
  created_at TIMESTAMP DEFAULT now()
);
```

**当前Schema**: ❌ 整个表不存在

**影响**: 订单变更功能完全无法使用

### 2.2 状态枚举差异

#### 2.2.1 订单状态 (OrderStatus)

**需求文档定义** (13个状态):
```
PENDING_CONFIRMATION  -> 待深化图确认
PENDING_PO            -> 待下采购单
PENDING_PRODUCTION    -> 生产中
PENDING_DELIVERY      -> 待申请发货
PENDING_SHIPMENT      -> 待发货
SHIPPED               -> 已发货
DELIVERED             -> 已送达
COMPLETED             -> 已完成
HALTED                -> 已叫停 ⚠️
CANCELLED             -> 已取消
```

**当前Schema实现**:
```typescript
export type OrderStatus =
  | 'PENDING_PO'
  | 'PENDING_PRODUCTION'
  | 'PENDING_DELIVERY'
  | 'PENDING_SHIPMENT'
  | 'SHIPPED'
  | 'DELIVERED'
  | 'COMPLETED'
  | 'CANCELLED';
```

**缺失状态**:
- ❌ `PENDING_CONFIRMATION` - 深化图确认流程无法运转
- ❌ `HALTED` - 叫停功能无法实现

#### 2.2.2 订单明细状态 (OrderItemStatus)

**需求**: 明细需要独立状态（如 `PENDING`, `IN_PRODUCTION`, `SHIPPED`, `DELIVERED`）  
**当前**: ✅ 已实现基础状态

---

## 3. 业务逻辑差异分析

### 3.1 订单创建逻辑

#### 3.1.1 从报价转订单 (核心流程)

| 业务规则 | 需求定义 | 当前实现 | 符合度 |
|:---|:---|:---|:---:|
| 报价状态校验 | 仅 `WON` 报价可转订单 | ✅ 已实现 | ✅ |
| 重复订单检测 | 一个报价只能对应一个订单 | ✅ 已实现 | ✅ |
| 快照数据保存 | 订单需冻结报价当前数据 | ❌ **未实现** | ❌ |
| 收款凭证上传 | 支持首付款凭证 | ✅ 已实现 | ✅ |
| 默认订单状态 | 根据是否有深化图选择状态 | ❌ **硬编码为 PENDING_PO** | ⚠️ |

**核心缺陷**:
```typescript
// 当前实现 (order.service.ts:61)
const [newOrder] = await tx.insert(orders).values({
  // ...
  status: 'PENDING_PO',  // ❌ 应该根据quote.hasDeepDesign判断
  // ❌ 缺少: snapshotData: JSON.stringify(quote)
});
```

**需求要求**:
```typescript
const initialStatus = quote.hasDeepDesign 
  ? 'PENDING_CONFIRMATION'   // 需深化图确认
  : 'PENDING_PO';            // 直接下单
```

#### 3.1.2 结算方式推断

| 业务规则 | 需求定义 | 当前实现 | 符合度 |
|:---|:---|:---|:---:|
| 预付款判断逻辑 | `paidAmount >= totalAmount * 0.3` → `PREPAID` | ❌ **硬编码 PREPAID** | ❌ |
| 月结客户处理 | 检查客户 `creditAvailable` | ❌ **未实现** | ❌ |

**当前实现**:
```typescript
// order.service.ts:74
settlementType: 'PREPAID',  // ❌ 硬编码
```

**需求代码**:
```typescript
const paid = Number(options?.paymentAmount || 0);
const total = Number(quote.totalAmount || 0);

let settlementType: 'PREPAID' | 'MONTHLY' = 'MONTHLY';
if (paid >= total * 0.3) {
  settlementType = 'PREPAID';
}
```

### 3.2 订单锁定/解锁机制

| 功能 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| 锁定订单 | 防止修改订单Items | ✅ Service已实现 | - |
| 解锁订单 | 管理员可解锁 | ❌ **无unlockOrder方法** | 缺失 |
| 锁定人记录 | `locked_by` 字段 | ❌ Schema缺失 | 无法追溯 |
| 前端UI | 订单详情页显示锁定状态 | ❌ **完全缺失** | - |
| API接口 | `POST /orders/{id}/lock`, `/unlock` | ❌ **仅lock实现，unlock缺失** | - |

### 3.3 订单状态流转 (State Machine)

**需求文档定义的完整状态机**:
```
PENDING_CONFIRMATION (深化图) → 确认 → PENDING_PO
                              ↘ 拒绝 → CANCELLED

PENDING_PO → 下采购单 → PENDING_PRODUCTION
          ↘ 叫停 → HALTED

PENDING_PRODUCTION → 入库 → PENDING_DELIVERY
                   ↘ 叫停 → HALTED

PENDING_DELIVERY → 申请发货 → PENDING_SHIPMENT
PENDING_SHIPMENT → 确认发货 → SHIPPED
SHIPPED → 物流完成 → DELIVERED → 完成验收 → COMPLETED

# 任何状态均可 → CANCELLED (撤单审批)
# HALTED状态 → 可恢复至原状态
```

**当前实现**:
```typescript
// mutations.ts:17
export const updateOrderStatus = createSafeAction(updateOrderStatusSchema, 
  async (data, ctx) => {
    await db.update(orders).set({
        status: data.status as any,  // ❌ 无状态验证
    });
});
```

**缺陷**:
1. ❌ **无状态流转验证** - 可以随意从任何状态跳转到任何状态
2. ❌ **无业务规则检查** - 例如未下采购单就能变为生产中
3. ❌ **无操作日志记录** - 状态变更无审计
4. ❌ **无权限校验** - 任何用户都能改状态

### 3.4 智能拆单逻辑

**需求文档定义**:
1. 系统根据 `orderItems` 自动匹配每个Item的最优供应商
2. 按供应商分组生成多个采购单
3. 运费分摊规则：按金额比例分摊
4. 拆单结果需人工确认

**当前实现**:
```typescript
// order-split-router.ts - 仅5行Mock代码
export const splitOrder = async (orderId: string) => {
    return { success: true };  // ❌ 空壳实现
};
```

**完全缺失的逻辑**:
- ❌ 供应商匹配算法
- ❌ 运费分摊计算
- ❌ 拆单预览接口 (`POST /orders/{id}/split/preview`)
- ❌ 拆单确认接口 (`POST /orders/{id}/split/confirm`)
- ❌ 前端拆单页面 (`/orders/[id]/split`)

### 3.5 变更单 (Change Order) 流程

**需求文档定义的完整流程**:
1. 销售发起变更请求（新增/删除/修改Item）
2. 系统自动计算差价
3. 提交审批（店长审批）
4. 审批通过后自动应用变更
5. 补差价/退差价处理

**当前实现**: ❌ **完全未实现**

**缺失内容**:
- ❌ `changeRequests` 数据表
- ❌ 创建变更请求API
- ❌ 审批变更请求API
- ❌ 差价计算逻辑
- ❌ 前端变更申请Dialog
- ❌ 审批页面集成

### 3.6 发货与物流

#### 3.6.1 申请发货

| 功能 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| 申请发货API | `POST /orders/{id}/delivery/request` | ❌ 缺失 | - |
| 发货地址验证 | 必填 | ✅ Schema有字段 | 但无验证逻辑 |
| 库存检查 | 确保货物已入库 | ❌ **未实现** | - |

#### 3.6.2 物流轨迹

**需求**: `GET /orders/{id}/logistics-track` - 对接快递100 SDK  
**当前**: ❌ **完全未实现**

### 3.7 叫停与恢复机制

**需求**:
- 任何状态（除已完成/已取消）都可被叫停
- 叫停需记录原因和操作人
- 叫停后可恢复至原状态

**当前**: ❌ **完全未实现**
- Schema缺少 `HALTED` 状态
- 无 `halted_reason`, `halted_at`, `previous_status` 字段

---

## 4. API Coverage 差异分析

### 4.1 API实现完整性对比

| API端点 | HTTP方法 | 需求文档 | 实际文件 | 实现状态 | 优先级 |
|:---|:---:|:---:|:---|:---:|:---:|
| **基础CRUD** |
| `/api/orders` | POST | ✅ | `orders.ts:createOrderFromQuote` | ✅ 已实现 | P0 |
| `/api/orders` | GET | ✅ | `queries.ts:getOrders` | ✅ 已实现 | P0 |
| `/api/orders/{id}` | GET | ✅ | `queries.ts:getOrderById` | ✅ 已实现 | P0 |
| `/api/orders/{id}` | PUT | ✅ | - | ❌ **缺失** | P1 |
| **锁定机制** |
| `/api/orders/{id}/lock` | POST | ✅ | `order.service.ts:lockOrder` | ⚠️ Service实现，无Action | P0 |
| `/api/orders/{id}/unlock` | POST | ✅ | - | ❌ **完全缺失** | P1 |
| **拆单** |
| `/api/orders/{id}/split/preview` | POST | ✅ | - | ❌ **Mock仅5行** | P0 |
| `/api/orders/{id}/split/confirm` | POST | ✅ | - | ❌ **Mock仅5行** | P0 |
| **发货** |
| `/api/orders/{id}/delivery/request` | POST | ✅ | - | ❌ **缺失** | P0 |
| `/api/orders/{id}/delivery/confirm` | POST | ✅ | - | ❌ **缺失** | P0 |
| **物流** |
| `/api/orders/{id}/logistics` | PUT | ✅ | - | ❌ **缺失** | P1 |
| `/api/orders/{id}/logistics-track` | GET | ✅ | - | ❌ **缺失** | P1 |
| **变更单** |
| `/api/orders/{id}/change-requests` | POST | ✅ | - | ❌ **完全缺失** | P0 |
| `/api/change-requests/{id}/approve` | POST | ✅ | - | ❌ **完全缺失** | P0 |
| `/api/change-requests/{id}/reject` | POST | ✅ | - | ❌ **完全缺失** | P0 |
| **撤单** |
| `/api/orders/{id}/cancel` | POST | ✅ | - | ❌ **缺失** | P1 |
| **叫停** |
| `/api/orders/{id}/halt` | POST | ✅ | - | ❌ **完全缺失** | P1 |
| `/api/orders/{id}/resume` | POST | ✅ | - | ❌ **完全缺失** | P1 |

**统计**:
- **API总数**: 18个核心API
- **已完整实现**: 3个 (16.7%)
- **部分实现**: 1个 (lock有Service但无Action)
- **Mock实现**: 2个 (拆单相关)
- **完全缺失**: 12个 (66.7%)
- **🎯 API完成度**: **~20%**

### 4.2 重点缺失API详解

#### 4.2.1 拆单API (`/orders/{id}/split/*`)

**需求定义**:
```json
POST /api/orders/{id}/split/preview
Request:
{
  "items": [
    { "itemId": "uuid", "supplierId": "uuid", "quantity": "1.00" }
  ]
}

Response:
{
  "purchaseOrders": [
    {
      "supplierId": "uuid",
      "supplierName": "XX供应商",
      "items": [...],
      "subtotal": "1500.00",
      "shippingFee": "300.00",  // 分摊运费
      "total": "1800.00"
    }
  ]
}
```

**当前实现**: 仅返回 `{ success: true }`，无任何逻辑

#### 4.2.2 变更单API (`/orders/{id}/change-requests`)

**需求定义**: 完整的Change Order工作流（创建→审批→应用）  
**当前实现**: ❌ 无任何代码

#### 4.2.3 物流轨迹API (`/orders/{id}/logistics-track`)

**需求**: 对接快递100 API，实时查询物流信息  
**当前**: ❌ 未集成快递100 SDK

---

## 5. UI/UX实现差异分析

### 5.1 订单列表页 (`/orders`)

#### 5.1.1 需求定义的UI组件

| 组件 | 需求描述 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| **Tab分组** | 按状态分组（全部/待确认/生产中/已发货等） | ❌ **完全缺失** | 无Tab，只有单一列表 |
| **高级筛选** | 状态/销售/金额区间/日期范围 | ⚠️ **仅有搜索框** | 筛选Dialog未实现 |
| **分页** | 每页10条，支持翻页 | ❌ **完全缺失** | 一次性加载所有数据 |
| **搜索功能** | 客户名/订单号模糊搜索 | ⚠️ **UI存在，未连接后端** | Input未绑定事件 |
| **批量操作** | 批量导出/批量状态变更 | ❌ **缺失** | - |
| **快捷操作按钮** | 拆单/发货/查看 | ✅ **部分实现** | 按钮存在但无功能 |

**当前实现分析**:
```typescript
// order-list.tsx:38-53
<div className="flex items-center flex-1 min-w-[300px] gap-2">
    <Input placeholder="搜索客户、订单号..." />  // ❌ 无onChange事件
    <Button variant="outline" size="icon">
        <Filter className="h-4 w-4" />  // ❌ 无onClick事件
    </Button>
</div>
```

**实际效果**: 搜索框和筛选按钮是装饰性质，无任何功能

#### 5.1.2 数据表格 (OrderTable)

| 列 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| 订单号 | 可点击跳转详情 | ✅ 已实现 | - |
| 客户名 | 显示 | ✅ 已实现 | - |
| 订单金额 | 显示 | ✅ 已实现 | - |
| 已收金额 | 显示 | ✅ 已实现 | - |
| 状态Badge | 彩色标签 | ✅ 已实现 | - |
| 归属销售 | 显示 | ✅ 已实现 | - |
| 创建时间 | 显示 | ✅ 已实现 | - |
| 操作按钮 | 查看/拆单/发货等 | ⚠️ **按钮存在，无功能** | Icon是死的 |

**完成度**: 表格UI ~80%，但交互功能 ~10%

### 5.2 订单详情页 (`/orders/[id]`)

#### 5.2.1 需求定义的区块布局

**需求**: 6大区块
1. **头部状态栏** - 订单号 + 状态进度条
2. **Tab切换** - 订单详情/变更历史/操作日志/关联单据
3. **快照对比** - 原始报价 vs 当前订单（如有变更）
4. **订单明细** - Item列表
5. **财务概况** - 收款进度
6. **操作区** - 锁定/拆单/变更/发货按钮

**当前实现**: 部分区块存在，但核心功能缺失

#### 5.2.2 详细对比

| 区块 | 需求定义 | 当前实现 | 完成度 | 差异说明 |
|:---|:---|:---:|:---:|:---|
| **头部** | 订单号 + 状态Badge + 进度条 | ⚠️ | 60% | 无进度条，缺少步骤指示器 |
| **Tab切换** | 4个Tab（详情/变更/日志/关联） | ❌ | 0% | 无Tab组件，所有内容在一个页面 |
| **快照对比** | 原始报价 vs 当前订单 | ❌ | 0% | 无snapshotData，无法实现 |
| **订单明细表** | Item列表 + 规格 + 小计 | ✅ | 90% | 基本完整，缺供应商列 |
| **财务概况卡片** | 已收/待收/回款率 + 进度条 | ✅ | 85% | 已实现，UI优秀 |
| **客户信息卡片** | 客户名/地址/结算方式 | ✅ | 80% | 已实现 |
| **生命周期Timeline** | 状态历史 | ⚠️ | 40% | 组件存在但数据Mock |
| **关联单据** | 报价/采购/安装链接 | ⚠️ | 30% | 仅显示报价链接 |
| **操作按钮区** | 锁定/解锁/拆单/变更/发货/撤单 | ⚠️ | 20% | 按钮UI存在但无功能 |

**核心缺陷示例**:
```typescript
// order-detail-actions.tsx:2418 - 仅定义了UI骨架
<OrderDetailActions order={order} workers={workers} />
// ❌ 组件内绝大多数按钮无onClick实现
```

#### 5.2.3 缺失的关键Dialog组件

| Dialog | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| **拆单预览Dialog** | 显示智能拆单结果 | ❌ 未找到 | 完全缺失 |
| **变更申请Dialog** | 新增/删除/修改Item | ❌ 未找到 | 完全缺失 |
| **深化图确认Dialog** | 上传确认图片 | ❌ 未找到 | 完全缺失 |
| **发货申请Dialog** | 填写物流信息 | ❌ 未找到 | 完全缺失 |
| **撤单申请Dialog** | 填写撤单原因 | ❌ 未找到 | 完全缺失 |
| **叫停Dialog** | 填写叫停原因 | ❌ 未找到 | 完全缺失 |

### 5.3 拆单页面 (`/orders/[id]/split`) - **完全缺失**

**需求定义**:
- 左侧: Order Items列表，支持选择供应商
- 右侧: 拆单预览（自动分组按供应商）
- 底部: 运费分摊明细
- 确认按钮: 生成采购单

**当前**: ❌ 整个页面不存在

### 5.4 变更历史页面 (`/orders/[id]/changes`)

**需求**: 显示所有变更单历史（时间轴形式）  
**当前**: ❌ 无此路由

---

## 6. 权限与安全

### 6.1 权限定义

**需求文档定义的权限**:
```typescript
orders.view        // 查看订单
orders.create      // 创建订单
orders.update      // 修改订单
orders.lock        // 锁定订单
orders.split       // 拆单操作
orders.approve     // 审批变更
orders.cancel      // 撤单操作
```

**当前实现**: 
- ⚠️ `actions/orders.ts` 无权限检查
- ⚠️ `mutations.ts` 使用 `createSafeAction` 但未定义权限
- ⚠️ 前端UI无权限控制（按钮始终显示）

### 6.2 数据安全

| 安全措施 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| **多租户隔离** | 所有查询必须加 `tenantId` | ✅ 已实现 | - |
| **操作日志** | 所有变更记录审计日志 | ❌ **缺失** | 无AuditLog集成 |
| **敏感字段脱敏** | 客户手机号中间4位隐藏 | ❌ **缺失** | - |

---

## 7. 测试覆盖率

### 7.1 单元测试

**发现的测试文件**:
- `order-split-router.test.ts` - 拆单逻辑测试

**当前测试覆盖**: 估计 <5%

**缺失的关键测试**:
- ❌ OrderService单元测试
- ❌ 状态流转逻辑测试
- ❌ 快照机制测试
- ❌ 差价计算测试

### 7.2 E2E测试

**需求**: 完整的订单生命周期E2E测试  
**当前**: ❌ 未发现任何E2E测试文件

---

## 8. 性能与优化

### 8.1 分页缺失

**问题**: `getOrders` 支持分页参数，但前端未使用  
**影响**: 1000+订单时页面卡顿

```typescript
// queries.ts:8 - 后端支持分页
export async function getOrders(params: { 
  page?: number; 
  pageSize?: number 
}) {
  const page = params.page || 1;  // ✅ 后端逻辑正确
  // ...
}

// order-list.tsx:18 - 前端未传参
const orders = await getOrders();  // ❌ 未传分页参数
```

### 8.2 索引优化

**当前Schema**: 未发现性能索引  
**建议**: 为高频查询字段添加索引
```sql
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
```

---

## 9. 与其他模块的集成

### 9.1 报价模块 (Quotes)

| 集成点 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| 报价状态联动 | 转订单后报价变 `WON` | ✅ 已验证 | OrderService有检查 |
| 快照冻结 | 订单保存报价快照 | ❌ **缺失** | 无snapshotData字段 |

### 9.2 采购模块 (Purchase Orders)

| 集成点 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| 拆单生成PO | 自动创建采购单 | ❌ **缺失** | 拆单逻辑Mock |
| PO回写Item | PO状态更新orderItem | ❌ **缺失** | 无purchase_order_id字段 |

### 9.3 安装模块 (Installation)

| 集成点 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| 订单完成触发 | `DELIVERED`后创建安装单 | ❌ **缺失** | 无自动化逻辑 |

### 9.4 财务模块 (Finance)

| 集成点 | 需求定义 | 当前实现 | 差异 |
|:---|:---|:---:|:---|
| 收款登记 | 更新 `paidAmount` | ⚠️ **UI按钮存在，无功能** | 详情页有"登记收款"按钮,但未连接 |
| 对账单生成 | 月度自动生成AR | ❌ **缺失** | - |

---

## 10. 差异总结表

### 10.1 按优先级分类

#### P0 - 核心功能缺失 (阻塞上线)

| # | 缺失项 | 影响范围 | 预估工作量 |
|:---:|:---|:---|:---:|
| 1 | 订单快照机制 (snapshotData) | 变更单/历史对比 | 3天 |
| 2 | 变更单完整流程 (changeRequests表+API+UI) | 订单修改功能 | 8天 |
| 3 | 智能拆单逻辑 (算法+UI) | 采购流程 | 10天 |
| 4 | 订单锁定/解锁完整实现 (unlock API + UI) | 数据一致性 | 2天 |
| 5 | 深化图确认流程 (Dialog + 超时机制) | 订单流转 | 4天 |
| 6 | 发货申请与确认 (API + Dialog) | 物流流程 | 5天 |
| 7 | 叫停机制 (状态+字段+API+UI) | 异常处理 | 3天 |
| **P0小计** | | | **35天** |

#### P1 - 重要功能缺失

| # | 缺失项 | 影响范围 | 预估工作量 |
|:---:|:---|:---|:---:|
| 1 | 物流轨迹查询 (快递100集成) | 客户体验 | 3天 |
| 2 | 撤单审批流程 | 异常处理 | 4天 |
| 3 | 高级筛选与分页 (前端) | 用户体验 | 2天 |
| 4 | Tab切换 (详情/变更/日志/关联) | 信息组织 | 3天 |
| 5 | 快照对比UI (原始vs当前) | 数据可视化 | 3天 |
| 6 | 权限控制完善 | 安全性 | 3天 |
| 7 | 操作日志记录 (AuditLog) | 审计 | 2天 |
| **P1小计** | | | **20天** |

#### P2 - 优化类

| # | 缺失项 | 影响范围 | 预估工作量 |
|:---:|:---|:---|:---:|
| 1 | 批量操作 (导出/状态变更) | 效率 | 2天 |
| 2 | 性能索引优化 | 性能 | 1天 |
| 3 | E2E测试覆盖 | 质量 | 5天 |
| 4 | 敏感字段脱敏 | 合规 | 1天 |
| **P2小计** | | | **9天** |

### 10.2 总工作量估算

| 优先级 | 工作量 | 人员配置 | 预计周期 |
|:---:|:---:|:---|:---:|
| P0 | 35天 | 1后端 + 1前端 | 3-4周 |
| P1 | 20天 | 1后端 + 1前端 | 2周 |
| P2 | 9天 | 1后端 + 1前端 | 1周 |
| **总计** | **64天** | **2人并行** | **6-7周** |

### 10.3 里程碑规划

**Week 1-2**: P0核心功能 (快照+变更单)  
**Week 3-4**: P0核心功能 (拆单+发货)  
**Week 5**: P0收尾 + P1重要功能  
**Week 6**: P1完成 + P2优化  
**Week 7**: 测试与修复

---

## 11. 风险评估

### 11.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|:---|:---|:---:|:---|
| 拆单算法复杂度超预期 | 延期2周 | 高 | 提前进行算法原型验证 |
| 快照数据结构变更影响旧数据 | 数据丢失 | 中 | 设计向后兼容的Schema |
| 快递100 API不稳定 | 功能不可用 | 中 | 增加降级方案（手动录入） |

### 11.2 业务风险

| 风险 | 影响 | 概率 | 缓解措施 |
|:---|:---|:---:|:---|
| 变更单流程与实际业务不符 | 返工 | 高 | 提前与业务确认流程细节 |
| 运费分摊规则有争议 | 业务纠纷 | 中 | 文档化规则并获得确认 |

### 11.3 依赖风险

| 依赖模块 | 影响 | 状态 | 缓解措施 |
|:---|:---|:---:|:---|
| 报价模块 (Quote) | 快照数据来源 | ✅ 已完成 | - |
| 采购模块 (PO) | 拆单生成目标 | ⚠️ 未知完成度 | 需先审计PO模块 |
| 审批流程 (Approval) | 变更单审批 | ⚠️ 未知完成度 | 考虑简化流程或Mock |
| 快递100 SDK | 物流查询 | ❌ 未集成 | P1优先级，可延后 |

---

## 12. 建议行动计划

### 12.1 立即行动 (本周)

1. ✅ **确认本报告** - 与产品/技术团队对齐差异
2. 🔴 **阻塞问题解决** - 先审计采购模块和审批模块（订单依赖它们）
3. 🔴 **Schema变更设计** - 设计 `snapshotData` 和 `changeRequests` 表结构
4. 📋 **拆单算法设计** - 编写供应商匹配算法文档

### 12.2 短期目标 (2周内)

1. 完成P0核心Schema变更 (快照+变更单+叫停)
2. 实现变更单完整流程 (含审批)
3. 完成基础拆单逻辑 (手动选择供应商版本)

### 12.3 中期目标 (4周内)

1. 完成智能拆单算法
2. 实现发货与物流流程
3. 集成快递100 SDK

### 12.4 长期目标 (6周内)

1. 完成所有P1功能
2. 编写E2E测试
3. 性能优化与安全加固

---

## 13. 附录

### 13.1 关键代码文件清单

**Schema**:
- `src/shared/api/schema/orders.ts` - 需大量修改

**Service**:
- `src/services/order.service.ts` - 需扩展

**Actions**:
- `src/features/orders/actions/orders.ts` - 需补全API
- `src/features/orders/actions/mutations.ts` - 需重构
- `src/features/orders/actions/queries.ts` - 需扩展

**UI**:
- `src/app/(dashboard)/orders/page.tsx` - 需添加Tab/筛选
- `src/app/(dashboard)/orders/[id]/page.tsx` - 需重构为Tab布局
- `src/features/orders/components/order-list.tsx` - 需连接分页
- `src/features/orders/components/order-table.tsx` - 基本完整

**逻辑**:
- `src/features/orders/logic/order-split-router.ts` - **需完全重写**

### 13.2 需创建的新文件

**Schema**:
- `src/shared/api/schema/change-requests.ts`

**Service**:
- `src/services/change-request.service.ts`
- `src/services/logistics.service.ts`

**Actions**:
- `src/features/orders/actions/change-requests.ts`
- `src/features/orders/actions/logistics.ts`

**UI**:
- `src/app/(dashboard)/orders/[id]/split/page.tsx`
- `src/app/(dashboard)/orders/[id]/changes/page.tsx`
- `src/features/orders/components/split-order-dialog.tsx`
- `src/features/orders/components/change-request-dialog.tsx`
- `src/features/orders/components/halt-order-dialog.tsx`
- `src/features/orders/components/delivery-request-dialog.tsx`
- `src/features/orders/components/snapshot-compare-view.tsx`

**测试**:
- `src/features/orders/__tests__/order-service.test.ts`
- `src/features/orders/__tests__/change-request.test.ts`
- `tests/e2e/order-lifecycle.spec.ts`

---

## 14. 结论

订单模块当前完成度约为 **35%**，存在大量核心功能缺失。**最关键的问题**是：

1. **订单快照机制缺失** - 导致变更单功能无法实现
2. **智能拆单逻辑Mock** - 采购流程无法自动化
3. **变更单流程完全缺失** - 订单修改功能不可用
4. **状态流转无验证** - 数据一致性风险极高

**建议优先级**: P0功能 **必须** 在上线前完成，P1功能 **强烈建议** 完成以保证用户体验。

预计需要 **2名全职开发人员 (1前端+1后端) 工作6-7周** 方可达到生产级别。

---

**报告结束**
