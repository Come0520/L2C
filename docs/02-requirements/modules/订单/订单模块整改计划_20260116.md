# 订单模块整改计划

**版本**: v1.0  
**创建时间**: 2026-01-16  
**计划周期**: 6周 (2026-01-20 ~ 2026-03-02)  
**基于文档**: [订单模块差异分析报告_20260116.md](./订单模块差异分析报告_20260116.md)

---

## 1. 整改目标 (Objectives)

### 1.1 总体目标

将订单模块完成度从 **35%** 提升至 **90%+**，实现生产级别的订单管理能力。

### 1.2 分阶段目标

| 周次 | 目标完成度 | 核心里程碑 |
|:---:|:---:|:---|
| Week 1 | 45% | 完成Schema变更 + 快照机制 |
| Week 2 | 55% | 完成变更单基础流程 |
| Week 3 | 65% | 完成智能拆单算法 |
| Week 4 | 75% | 完成发货与物流流程 |
| Week 5 | 85% | 完成P1功能 + 前端优化 |
| Week 6 | 90%+ | 完成测试与上线准备 |

### 1.3 验收标准

**功能完整性**:
- ✅ 订单快照机制100%可用
- ✅ 变更单流程端到端可执行
- ✅ 智能拆单算法正确率≥95%
- ✅ 所有18个核心API实现且测试通过
- ✅ UI/UX Flow完整无阻塞点

**性能标准**:
- ✅ 1000+订单列表加载时间 <2s
- ✅ 拆单算法响应时间 <3s
- ✅ 订单详情页首屏加载 <1s

**质量标准**:
- ✅ 代码单元测试覆盖率 ≥70%
- ✅ E2E测试覆盖核心Flow
- ✅ 无P0/P1级别lint错误

---

## 2. 详细任务分解

### 2.1 Week 1: Schema变更 + 快照机制 (P0)

**目标**: 完成数据库Schema变更并实现订单快照机制

#### 2.1.1 数据库Schema变更 (3天)

**任务**: Schema设计与迁移  
**负责人**: 后端开发  
**工作量**: 3天

**详细步骤**:

1. **订单主表字段补充** (1天)
   - [ ] 添加 `snapshotData` JSONB字段
   - [ ] 添加 `haltedReason` TEXT字段
   - [ ] 添加 `haltedAt` TIMESTAMP字段
   - [ ] 添加 `cancelReason` TEXT字段
   - [ ] 添加 `cancelledBy` UUID字段
   - [ ] 添加 `cancelledAt` TIMESTAMP字段
   - [ ] 添加 `lockedBy` UUID字段
   - [ ] 添加 `confirmationDeadline` TIMESTAMP字段
   - [ ] 扩展 `OrderStatus` enum: 添加 `PENDING_CONFIRMATION`, `HALTED`

2. **订单明细表字段补充** (0.5天)
   - [ ] 添加 `supplierId` UUID字段 (关联suppliers表)
   - [ ] 添加 `purchaseOrderId` UUID字段 (关联purchase_orders表)
   - [ ] 添加 `deliveryStatus` ENUM字段
   - [ ] 添加 `deliveredAt` TIMESTAMP字段

3. **创建变更单表** (1天)
   ```sql
   CREATE TABLE change_requests (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     tenant_id UUID NOT NULL REFERENCES tenants(id),
     order_id UUID NOT NULL REFERENCES orders(id),
     change_type TEXT NOT NULL CHECK (change_type IN ('ADD_ITEM', 'REMOVE_ITEM', 'MODIFY_ITEM')),
     change_reason TEXT NOT NULL,
     original_items JSONB,
     new_items JSONB,
     price_difference DECIMAL(10,2),
     status TEXT NOT NULL CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED')) DEFAULT 'PENDING',
     approved_by UUID REFERENCES users(id),
     approved_at TIMESTAMP,
     rejected_by UUID REFERENCES users(id),
     rejected_at TIMESTAMP,
     rejection_reason TEXT,
     created_by UUID NOT NULL REFERENCES users(id),
     created_at TIMESTAMP DEFAULT now(),
     updated_at TIMESTAMP DEFAULT now()
   );
   
   CREATE INDEX idx_change_requests_order_id ON change_requests(order_id);
   CREATE INDEX idx_change_requests_status ON change_requests(status);
   ```

4. **性能索引创建** (0.5天)
   - [ ] `CREATE INDEX idx_orders_status ON orders(status);`
   - [ ] `CREATE INDEX idx_orders_customer_id ON orders(customer_id);`
   - [ ] `CREATE INDEX idx_orders_created_at ON orders(created_at DESC);`
   - [ ] `CREATE INDEX idx_order_items_supplier_id ON order_items(supplier_id);`
   - [ ] `CREATE INDEX idx_order_items_po_id ON order_items(purchase_order_id);`

5. **迁移脚本编写与测试** (0.5天)
   - [ ] 编写Drizzle migration文件
   - [ ] 本地数据库测试迁移
   - [ ] 编写回滚脚本（备用）

**交付物**:
- ✅ `drizzle/migrations/XXXX_order_module_enhancement.sql`
- ✅ `src/shared/api/schema/orders.ts` 更新
- ✅ `src/shared/api/schema/change-requests.ts` 新建

#### 2.1.2 订单快照机制实现 (2天)

**任务**: 在订单创建时冻结报价数据  
**负责人**: 后端开发  
**工作量**: 2天

**详细步骤**:

1. **Service层改造** (1天)
   - [ ] 修改 `OrderService.convertFromQuote` 方法
   - [ ] 在创建订单时保存 `snapshotData`
   ```typescript
   const snapshotData = {
     quote: {
       id: quote.id,
       version: quote.version,
       totalAmount: quote.totalAmount,
       createdAt: quote.createdAt,
     },
     items: quote.items.map(item => ({
       id: item.id,
       productName: item.productName,
       quantity: item.quantity,
       unitPrice: item.unitPrice,
       subtotal: item.subtotal,
       // ... 其他关键字段
     })),
     customer: {
       name: quote.customer.name,
       phone: quote.customer.phone,
       // ... 其他关键字段
     }
   };
   
   await tx.insert(orders).values({
     // ...
     snapshotData: JSON.stringify(snapshotData),
   });
   ```

2. **初始状态逻辑优化** (0.5天)
   - [ ] 根据 `quote.hasDeepDesign` 判断初始状态
   ```typescript
   const initialStatus = quote.hasDeepDesign 
     ? 'PENDING_CONFIRMATION'
     : 'PENDING_PO';
   ```

3. **结算方式推断逻辑** (0.5天)
   - [ ] 实现预付款判断
   ```typescript
   const paid = Number(options?.paymentAmount || 0);
   const total = Number(quote.totalAmount || 0);
   let settlementType: 'PREPAID' | 'MONTHLY' = 'MONTHLY';
   if (paid >= total * 0.3) {
     settlementType = 'PREPAID';
   }
   ```

**交付物**:
- ✅ `src/services/order.service.ts` 更新

**验收标准**:
- ✅ 创建订单后 `snapshotData` 字段非空
- ✅ 快照数据与报价数据一致
- ✅ 报价数据变更后订单快照不受影响

---

### 2.2 Week 2: 变更单流程 (P0)

**目标**: 实现完整的订单变更请求、审批、应用流程

#### 2.2.1 变更单Service层 (2天)

**任务**: 创建 `ChangeRequestService`  
**负责人**: 后端开发  
**工作量**: 2天

**详细步骤**:

1. **创建变更请求逻辑** (1天)
   - [ ] 实现 `ChangeRequestService.create` 方法
   - [ ] 验证订单状态（仅允许特定状态下变更）
   - [ ] 计算差价逻辑
   ```typescript
   const calculatePriceDifference = (
     originalItems: OrderItem[],
     newItems: OrderItem[]
   ): Decimal => {
     const originalTotal = originalItems.reduce(
       (sum, item) => sum + Number(item.subtotal), 0
     );
     const newTotal = newItems.reduce(
       (sum, item) => sum + Number(item.subtotal), 0
     );
     return new Decimal(newTotal - originalTotal);
   };
   ```

2. **审批逻辑** (0.5天)
   - [ ] 实现 `ChangeRequestService.approve` 方法
   - [ ] 审批后自动应用变更（更新订单Items和金额）
   - [ ] 生成补差价/退差价记录

3. **拒绝逻辑** (0.5天)
   - [ ] 实现 `ChangeRequestService.reject` 方法
   - [ ] 记录拒绝原因

**交付物**:
- ✅ `src/services/change-request.service.ts` 新建

#### 2.2.2 变更单API实现 (1.5天)

**任务**: 创建变更单相关Server Actions  
**负责人**: 后端开发  
**工作量**: 1.5天

**详细步骤**:

1. **API Action创建** (1天)
   - [ ] `POST /api/orders/:id/change-requests` - 创建变更请求
   - [ ] `GET /api/orders/:id/change-requests` - 获取变更历史
   - [ ] `POST /api/change-requests/:id/approve` - 审批变更
   - [ ] `POST /api/change-requests/:id/reject` - 拒绝变更

2. **权限控制** (0.5天)
   - [ ] 创建变更：销售/客服/店长
   - [ ] 审批变更：仅店长

**交付物**:
- ✅ `src/features/orders/actions/change-requests.ts` 新建

#### 2.2.3 变更单前端UI (2.5天)

**任务**: 创建变更申请与审批UI  
**负责人**: 前端开发  
**工作量**: 2.5天

**详细步骤**:

1. **变更申请Dialog** (1.5天)
   - [ ] 创建 `ChangeRequestDialog` 组件
   - [ ] 支持三种变更类型（新增/删除/修改Item）
   - [ ] 实时显示差价计算
   - [ ] 必填变更原因
   - [ ] 集成到订单详情页操作栏

2. **变更历史Tab** (0.5天)
   - [ ] 在订单详情页添加"变更历史"Tab
   - [ ] 时间轴展示所有变更记录
   - [ ] 显示变更前后对比

3. **审批页面集成** (0.5天)
   - [ ] 在待办事项中显示待审批变更单
   - [ ] 审批Dialog（查看详情+批准/拒绝）

**交付物**:
- ✅ `src/features/orders/components/change-request-dialog.tsx`
- ✅ `src/features/orders/components/change-history-tab.tsx`
- ✅ `src/app/(dashboard)/orders/[id]/page.tsx` 更新（添加Tab）

**验收标准**:
- ✅ 端到端流程可走通（申请→审批→应用）
- ✅ 差价计算准确
- ✅ 变更历史可追溯

---

### 2.3 Week 3: 智能拆单逻辑 (P0)

**目标**: 实现供应商智能匹配与拆单算法

#### 2.3.1 拆单算法设计与实现 (3天)

**任务**: 重写 `order-split-router.ts`  
**负责人**: 后端开发  
**工作量**: 3天

**详细步骤**:

1. **供应商匹配算法** (1.5天)
   - [ ] 查询每个产品的可用供应商
   - [ ] 按优先级排序（价格、库存、历史合作评分）
   - [ ] 实现最优匹配算法
   ```typescript
   async function matchSupplier(item: OrderItem): Promise<Supplier> {
     // 1. 查询该产品的所有供应商
     const suppliers = await db.query.productSuppliers.findMany({
       where: eq(productSuppliers.productId, item.productId),
       with: { supplier: true }
     });
     
     // 2. 按优先级排序
     const ranked = suppliers.sort((a, b) => {
       // 优先级: 库存充足 > 价格低 > 历史评分高
       if (a.stockQuantity >= item.quantity && b.stockQuantity < item.quantity) return -1;
       if (a.unitPrice < b.unitPrice) return -1;
       return a.supplier.rating - b.supplier.rating;
     });
     
     return ranked[0]?.supplier || throw new Error('No supplier found');
   }
   ```

2. **按供应商分组** (0.5天)
   - [ ] 将所有Items按匹配的供应商分组
   - [ ] 生成分组预览数据

3. **运费分摊逻辑** (1天)
   - [ ] 获取每个供应商的运费
   - [ ] 按金额比例分摊
   ```typescript
   function allocateShippingFee(
     groups: Map<string, OrderItem[]>,
     shippingFees: Map<string, Decimal>
   ) {
     const totalAmount = Array.from(groups.values())
       .flat()
       .reduce((sum, item) => sum + Number(item.subtotal), 0);
     
     groups.forEach((items, supplierId) => {
       const groupTotal = items.reduce((sum, item) => sum + Number(item.subtotal), 0);
       const ratio = groupTotal / totalAmount;
       const allocatedFee = shippingFees.get(supplierId) * ratio;
       // 分摊到各个Item
     });
   }
   ```

**交付物**:
- ✅ `src/features/orders/logic/order-split-router.ts` 重写
- ✅ `src/services/supplier-matcher.service.ts` 新建

#### 2.3.2 拆单API实现 (1天)

**任务**: 实现拆单预览与确认API  
**负责人**: 后端开发  
**工作量**: 1天

**详细步骤**:

1. **拆单预览API** (0.5天)
   - [ ] `POST /api/orders/:id/split/preview`
   - [ ] 返回分组结果和运费分摊

2. **拆单确认API** (0.5天)
   - [ ] `POST /api/orders/:id/split/confirm`
   - [ ] 生成多个采购单 (PurchaseOrder)
   - [ ] 更新 `orderItems.supplierId` 和 `purchaseOrderId`

**交付物**:
- ✅ `src/features/orders/actions/split.ts` 新建

#### 2.3.3 拆单前端UI (2天)

**任务**: 创建拆单页面  
**负责人**: 前端开发  
**工作量**: 2天

**详细步骤**:

1. **拆单页面** (1.5天)
   - [ ] 创建 `/orders/[id]/split` 路由
   - [ ] 左侧: Items列表，显示匹配的供应商（可手动调整）
   - [ ] 右侧: 分组预览（按供应商）
   - [ ] 底部: 运费分摊明细表

2. **拆单Dialog** (0.5天)
   - [ ] 从订单详情页"拆单"按钮弹出Dialog
   - [ ] 显示预览结果
   - [ ] 确认后跳转采购单列表

**交付物**:
- ✅ `src/app/(dashboard)/orders/[id]/split/page.tsx`
- ✅ `src/features/orders/components/split-order-dialog.tsx`

**验收标准**:
- ✅ 智能匹配准确率 ≥95%
- ✅ 运费分摊逻辑正确
- ✅ 生成的采购单数据完整

---

### 2.4 Week 4: 发货与物流流程 (P0)

**目标**: 实现发货申请、确认和物流轨迹查询

#### 2.4.1 发货流程后端 (2天)

**任务**: 实现发货相关API  
**负责人**: 后端开发  
**工作量**: 2天

**详细步骤**:

1. **申请发货API** (1天)
   - [ ] `POST /api/orders/:id/delivery/request`
   - [ ] 验证库存状态（所有Items已入库）
   - [ ] 验证发货地址
   - [ ] 状态变更: `PENDING_DELIVERY` → `PENDING_SHIPMENT`

2. **确认发货API** (1天)
   - [ ] `POST /api/orders/:id/delivery/confirm`
   - [ ] 填写物流公司和运单号
   - [ ] 状态变更: `PENDING_SHIPMENT` → `SHIPPED`
   - [ ] 触发物流追踪

**交付物**:
- ✅ `src/features/orders/actions/delivery.ts` 新建

#### 2.4.2 物流轨迹集成 (2天)

**任务**: 集成快递100 SDK  
**负责人**: 后端开发  
**工作量**: 2天

**详细步骤**:

1. **快递100 SDK安装与配置** (0.5天)
   - [ ] `pnpm add kuaidi100-sdk`
   - [ ] 配置API Key (环境变量)

2. **LogisticsService创建** (1天)
   - [ ] 实现 `LogisticsService.subscribe` - 订阅物流推送
   - [ ] 实现 `LogisticsService.query` - 查询物流轨迹
   - [ ] 处理回调Webhook

3. **物流轨迹API** (0.5天)
   - [ ] `GET /api/orders/:id/logistics-track`
   - [ ] 返回物流状态和轨迹列表

**交付物**:
- ✅ `src/services/logistics.service.ts` 新建
- ✅ `src/features/orders/actions/logistics.ts` 新建

#### 2.4.3 发货前端UI (2天)

**任务**: 创建发货相关UI组件  
**负责人**: 前端开发  
**工作量**: 2天

**详细步骤**:

1. **发货申请Dialog** (0.5天)
   - [ ] 创建 `DeliveryRequestDialog`
   - [ ] 显示发货地址（允许修改）
   - [ ] 库存检查提示

2. **确认发货Dialog** (0.5天)
   - [ ] 创建 `DeliveryConfirmDialog`
   - [ ] 填写物流公司和运单号
   - [ ] 支持扫码录入运单号

3. **物流轨迹展示** (1天)
   - [ ] 在订单详情页添加"物流信息"卡片
   - [ ] 时间轴展示物流轨迹
   - [ ] 实时更新（轮询或WebSocket）

**交付物**:
- ✅ `src/features/orders/components/delivery-request-dialog.tsx`
- ✅ `src/features/orders/components/delivery-confirm-dialog.tsx`
- ✅ `src/features/orders/components/logistics-track-card.tsx`

**验收标准**:
- ✅ 发货流程端到端可执行
- ✅ 物流轨迹实时更新
- ✅ 异常物流状态有提示

---

### 2.5 Week 5: 叫停机制 + P1功能 (P0+P1)

**目标**: 完成叫停机制和其他P1重要功能

#### 2.5.1 叫停机制 (1.5天)

**任务**: 实现订单叫停与恢复  
**负责人**: 后端开发 (1天) + 前端开发 (0.5天)

**后端步骤**:
1. **叫停API** (0.5天)
   - [ ] `POST /api/orders/:id/halt`
   - [ ] 记录 `previous_status`, `halted_reason`, `halted_at`
   - [ ] 状态变更至 `HALTED`

2. **恢复API** (0.5天)
   - [ ] `POST /api/orders/:id/resume`
   - [ ] 恢复至 `previous_status`

**前端步骤**:
3. **叫停Dialog** (0.5天)
   - [ ] 创建 `HaltOrderDialog`
   - [ ] 必填叫停原因
   - [ ] 显示叫停历史

**交付物**:
- ✅ `src/features/orders/actions/halt.ts`
- ✅ `src/features/orders/components/halt-order-dialog.tsx`

#### 2.5.2 撤单审批流程 (2天)

**任务**: 实现撤单申请与审批  
**负责人**: 后端开发 (1天) + 前端开发 (1天)

**后端步骤**:
1. **撤单API** (1天)
   - [ ] `POST /api/orders/:id/cancel`
   - [ ] 提交审批工作流（集成Approval模块）
   - [ ] 审批通过后状态变为 `CANCELLED`

**前端步骤**:
2. **撤单Dialog** (1天)
   - [ ] 创建 `CancelOrderDialog`
   - [ ] 必填撤单原因
   - [ ] 显示审批进度

**交付物**:
- ✅ `src/features/orders/actions/cancel.ts`
- ✅ `src/features/orders/components/cancel-order-dialog.tsx`

#### 2.5.3 前端优化 (2.5天)

**任务**: 完善UI/UX交互  
**负责人**: 前端开发  
**工作量**: 2.5天

**详细步骤**:

1. **Tab布局重构** (1天)
   - [ ] 订单详情页改为Tab布局
   - [ ] Tab: 订单详情 / 变更历史 / 操作日志 / 关联单据

2. **高级筛选与分页** (1天)
   - [ ] 列表页添加筛选Dialog
   - [ ] 筛选条件: 状态/销售/金额区间/日期范围
   - [ ] 实现前端分页组件
   - [ ] 连接后端分页API

3. **快照对比UI** (0.5天)
   - [ ] 创建 `SnapshotCompareView` 组件
   - [ ] 左右对比原始报价 vs 当前订单
   - [ ] 高亮变更部分

**交付物**:
- ✅ `src/app/(dashboard)/orders/[id]/page.tsx` 重构
- ✅ `src/features/orders/components/orders-filter-dialog.tsx`
- ✅ `src/features/orders/components/snapshot-compare-view.tsx`

**验收标准**:
- ✅ 叫停/恢复流程可执行
- ✅ 撤单审批集成成功
- ✅ 筛选和分页功能正常

---

### 2.6 Week 6: 测试与上线准备 (P2)

**目标**: 完成测试覆盖和生产准备

#### 2.6.1 单元测试 (2天)

**任务**: 编写核心逻辑单元测试  
**负责人**: 后端开发  
**工作量**: 2天

**测试覆盖**:
1. **OrderService测试** (0.5天)
   - [ ] 测试订单创建逻辑
   - [ ] 测试快照保存
   - [ ] 测试结算方式推断

2. **ChangeRequestService测试** (0.5天)
   - [ ] 测试差价计算
   - [ ] 测试审批后应用变更

3. **拆单算法测试** (0.5天)
   - [ ] 测试供应商匹配
   - [ ] 测试运费分摊

4. **状态流转测试** (0.5天)
   - [ ] 测试状态机合法性
   - [ ] 测试非法状态转换拦截

**交付物**:
- ✅ `src/services/__tests__/order.service.test.ts`
- ✅ `src/services/__tests__/change-request.service.test.ts`
- ✅ `src/features/orders/logic/__tests__/order-split-router.test.ts` 重写
- ✅ `src/features/orders/__tests__/state-machine.test.ts`

#### 2.6.2 E2E测试 (2天)

**任务**: 编写订单生命周期E2E测试  
**负责人**: QA / 前端开发  
**工作量**: 2天

**测试场景**:
1. **完整订单流程** (1天)
   - [ ] 从报价转订单
   - [ ] 拆单
   - [ ] 发货
   - [ ] 物流追踪
   - [ ] 完成

2. **变更单流程** (0.5天)
   - [ ] 申请变更
   - [ ] 审批
   - [ ] 应用变更

3. **异常流程** (0.5天)
   - [ ] 叫停与恢复
   - [ ] 撤单审批

**交付物**:
- ✅ `tests/e2e/order-lifecycle.spec.ts`
- ✅ `tests/e2e/order-change-request.spec.ts`

#### 2.6.3 性能优化与安全加固 (2天)

**任务**: 性能优化和安全检查  
**负责人**: 全栈  
**工作量**: 2天

**优化内容**:

1. **性能优化** (1天)
   - [ ] 订单列表查询优化（索引验证）
   - [ ] 拆单算法性能测试（1000 items < 3s）
   - [ ] 前端列表虚拟滚动（如需）

2. **安全加固** (1天)
   - [ ] 权限检查完善
   - [ ] 操作日志集成 (AuditLog)
   - [ ] 敏感字段脱敏（手机号）
   - [ ] SQL注入防护验证

**交付物**:
- ✅ 性能测试报告
- ✅ 安全检查清单

**验收标准**:
- ✅ 单元测试覆盖率 ≥70%
- ✅ E2E测试通过率 100%
- ✅ 性能指标达标
- ✅ 安全检查无P0/P1问题

---

## 3. 资源规划

### 3.1 人员配置

| 角色 | 人数 | 投入度 | 职责 |
|:---|:---:|:---:|:---|
| **后端开发** | 1 | 100% | Schema变更、Service层、API实现、单元测试 |
| **前端开发** | 1 | 100% | UI组件、页面重构、前端优化、E2E辅助 |
| **QA测试** | 1 | 50% | E2E测试编写、回归测试、Bug验证 |
| **技术Leader** | 1 | 20% | 代码Review、架构指导、风险把控 |

### 3.2 工作量估算

| 周次 | 后端工作量 | 前端工作量 | QA工作量 | 总人日 |
|:---:|:---:|:---:|:---:|:---:|
| Week 1 | 5天 | 0天 | 0天 | 5人日 |
| Week 2 | 3.5天 | 2.5天 | 0天 | 6人日 |
| Week 3 | 4天 | 2天 | 0天 | 6人日 |
| Week 4 | 4天 | 2天 | 0天 | 6人日 |
| Week 5 | 2.5天 | 3.5天 | 0天 | 6人日 |
| Week 6 | 2天 | 1天 | 3天 | 6人日 |
| **总计** | **21天** | **11天** | **3天** | **35人日** |

**备注**: 实际工作量会因并行开发而有所压缩，预计2人并行可在6周内完成。

### 3.3 外部依赖

| 依赖项 | 状态 | 风险 | 缓解措施 |
|:---|:---:|:---:|:---|
| 采购模块 (PO) | ⚠️ 未知 | 高 | Week 1先审计PO模块 |
| 审批流程 (Approval) | ⚠️ 未知 | 中 | 简化为店长直接审批（不走工作流） |
| 快递100 API | ❌ 未集成 | 中 | 申请API Key，测试连通性 |
| 报价模块 (Quote) | ✅ 已完成 | 低 | - |

---

## 4. 风险管理

### 4.1 风险识别

| 风险类型 | 风险描述 | 影响 | 概率 | 等级 |
|:---|:---|:---:|:---:|:---:|
| **技术风险** | 拆单算法复杂度超预期 | 延期2周 | 高 | 🔴 高 |
| **技术风险** | 快递100 API不稳定 | 物流功能不可用 | 中 | 🟡 中 |
| **依赖风险** | 采购模块未完成 | 拆单功能受阻 | 高 | 🔴 高 |
| **依赖风险** | 审批流程未完成 | 变更单/撤单无法审批 | 中 | 🟡 中 |
| **业务风险** | 变更单流程与实际业务不符 | 返工 | 中 | 🟡 中 |
| **资源风险** | 人员请假或离职 | 延期 | 低 | 🟢 低 |

### 4.2 风险应对策略

#### 🔴 高风险应对

**风险1: 拆单算法复杂度超预期**
- **预防**: Week 1提前进行算法原型验证
- **应对**: 若算法难度过高，先实现手动选择供应商版本，智能匹配放到P2
- **降级**: 最坏情况下仅实现手动拆单

**风险2: 采购模块未完成**
- **预防**: Week 1立即审计采购模块，评估完成度
- **应对**: 若PO模块严重不足，先Mock采购单创建，后续补齐
- **降级**: 拆单仅分组预览，不实际生成PO

#### 🟡 中风险应对

**风险3: 快递100 API不稳定**
- **预防**: Week 4先测试API连通性和稳定性
- **应对**: 增加降级方案：手动录入物流信息
- **降级**: 物流轨迹改为手动更新

**风险4: 审批流程未完成**
- **预防**: Week 2先确认Approval模块状态
- **应对**: 简化审批流程，店长直接批准，不走复杂工作流
- **降级**: 变更单和撤单无需审批，仅记录操作人

**风险5: 变更单流程与实际业务不符**
- **预防**: Week 2开发前与业务确认详细流程
- **应对**: 快速迭代，分阶段交付验证
- **降级**: 先实现基础变更功能，复杂场景后续迭代

---

## 5. 质量保证

### 5.1 代码规范

- ✅ 遵循项目ESLint规则，无P0/P1 lint错误
- ✅ 所有新代码必须通过TypeScript严格模式检查
- ✅ 关键函数必须有JSDoc注释（中文）
- ✅ 复杂逻辑必须有行内注释说明

### 5.2 Code Review

- ✅ 所有代码变更必须经过Code Review
- ✅ P0功能需Technical Leader Review
- ✅ Review重点: 业务逻辑正确性、性能、安全性

### 5.3 测试要求

- ✅ 单元测试覆盖率 ≥70%
- ✅ 所有API必须有集成测试
- ✅ 核心Flow必须有E2E测试
- ✅ 测试必须在CI中自动运行

### 5.4 文档要求

- ✅ 重要Service类必须有详细注释
- ✅ 复杂算法必须有设计文档
- ✅ API变更必须更新API文档
- ✅ 完成后编写《订单模块使用手册》

---

## 6. 交付检查清单

### 6.1 功能交付

- [ ] 订单快照机制100%可用
- [ ] 变更单端到端流程可执行
- [ ] 智能拆单算法准确率≥95%
- [ ] 发货与物流流程完整
- [ ] 叫停机制可用
- [ ] 撤单审批集成成功
- [ ] 18个核心API全部实现
- [ ] UI/UX无阻塞点

### 6.2 质量交付

- [ ] 单元测试覆盖率≥70%
- [ ] E2E测试覆盖核心Flow
- [ ] 性能指标达标
- [ ] 安全检查通过
- [ ] Code Review完成
- [ ] 无P0/P1 Bug

### 6.3 文档交付

- [ ] 《订单模块使用手册》
- [ ] API文档更新
- [ ] 数据库Schema文档更新
- [ ] 部署文档（Migration步骤）

---

## 7. 上线计划

### 7.1 上线准备

**Week 6**:
1. **数据库迁移预演** (生产环境)
2. **生产环境配置检查** (快递100 API Key等)
3. **回滚方案准备**

### 7.2 上线步骤

1. **数据库迁移** (维护窗口)
   - 执行Schema变更
   - 验证数据完整性

2. **代码部署**
   - 部署新版本代码
   - 验证服务启动正常

3. **功能验证**
   - 创建测试订单
   - 执行核心Flow验证

4. **监控观察**
   - 监控错误日志
   - 监控性能指标
   - 监控业务数据

### 7.3 回滚方案

- 保留上一版本代码（Git Tag）
- 准备数据库回滚脚本
- 定义回滚触发条件（如P0 Bug、性能劣化>50%）

---

## 8. 后续优化 (Post-Launch)

### 8.1 P2功能 (延后至上线后)

- 批量操作（批量导出、批量状态变更）
- 国际化支持（中英文切换）
- 高级报表（订单统计分析）
- 移动端优化（响应式布局增强）

### 8.2 持续优化

- 根据用户反馈迭代UI/UX
- 性能持续监控与优化
- 算法准确率持续提升
- 安全漏洞定期扫描

---

## 9. 总结

本整改计划旨在用 **6周时间** 将订单模块从35%完成度提升至90%+，实现生产级别的订单管理能力。核心关注点包括：

1. **订单快照机制** - 保证数据一致性
2. **变更单流程** - 支持订单修改
3. **智能拆单** - 提升采购效率
4. **发货物流** - 完善订单生命周期

通过严格的任务分解、风险管理和质量保证，确保按时高质量交付。

---

**计划制定人**: AI Agent  
**计划审批人**: _待填写_  
**计划开始日期**: 2026-01-20  
**计划结束日期**: 2026-03-02
