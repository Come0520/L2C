# L2C 认证体系架构文档 (SA-4 Refactor)

> 本文档规范了 L2C 系统从 L3 到 L5 的认证强化建设路线后的整体功能脉络。

## 1. 双端认证架构概览

L2C 核心针对业务形态切分为：PC端主服务 与 微信小程序端等移动分发渠道。

- **PC 端**：使用 `NextAuth v5`（当前为 beta 版）。采用 `Credentials Provider` 完成账密检验后进行 Session 分发。所有状态均处于会话内存结构下管理，安全性高，适用于大屏业务后台操作终端。
- **移动端**：使用独立轻量的 `JWT (jose)` 加密算法配合标准的 Bearer Token 在 API 链路传输，受客户端的 `localStorage` 维护凭证（适配小程序以及自建原声APP桥接）。

## 2. RBAC 权限模型 (基于 `checkRolePermission`)

内置三种核心匹配模式并做到了深度穿透与边界防护：

1. **精确匹配 (Exact Match)**：要求鉴权对象提供与底层定义的权限名完全一致的数据。
2. **通配符匹配 (Wildcard Match)**：如角色拥有 `*` 或 `**` 可直接过白通行。系统会自动识别管理员等超级角色的全量放行场景，省去了复杂的权限列举。此外内置了魔术字常量的短路放行机制。
3. **数据范围层级推导 (Implicit Scope)**：`order.own.edit` 甚至 `order.all.edit` 将被向下投射至对资源基础动作 `order.edit` 予以放行。该策略有效解决了底层服务鉴权过于精细，而动作入口声明又需要笼统管控时的权限脱节问题。

## 3. JWT 与移动端 Token 刷新流转 (Refresh Flow)

移动端的无感操作体验不仅依赖 Access Token，更高度依赖基于后端签退拦截的 Refresh 流程：

1. **结构定义**：采用不可逆向查原密钥的 HSA256 签名，核心载荷附带租户边界 `tenantId`、识别码 `userId` 与业务身份 `role`。
2. **刷新响应机制**：
   - 客户端携带过期 Access Token 向任意保护态接口发送请求时，会被中间件或边缘路由以 401 Reject 驳回。
   - 客户端捕获 401 失败后，将从本地读出 Refresh Token 下发至更新接口 `/api/mobile/auth/refresh`。
   - 后端重新检查发起续集请求的用户活跃状态 (`isActive`)，确保已离职员工即便持有长效刷新凭证也无法再换取全新通行证。

## 4. MFA 二次验证

当系统开启多因子强制验证时（通常是对于敏感高权租户配置的情节），登录状态机制会分为两大步执行：

1. 请求 `/api/mobile/auth/login` 进行手机号与密码匹配。
2. 返回带有特定时效短期的 `preAuthToken` 与强制短息接驳要求，只有当 `mfa/verify` 内二次校验该 token 的合法载荷并通过验证码比对，才会签发完整的 Access 及 Refresh Token。

## 5. Token 生命周期与速率控制边界

1. **访问令牌 (Access Token)**：24 小时过期，用于常规接口数据获取。
2. **刷新令牌 (Refresh Token)**：7 天过期，用于底层静默续签 Access，续签时自动检查用户当前 `isActive`，禁用账号会被立刻剥夺续签权。
3. **预授权令牌 (Pre-Auth)**：保留至高短效的 5 分钟，专用于跨步骤衔接登录凭据。
4. **防刷与限流基线**：基于单线程内存 Map 配置，限制单位时间内单 IP 或单用户的尝试失败次数（移动端登录API和Token刷新API限制通常配置在 1 分钟 / 10 次容错），拦截横向枚举撞库与恶意接口攻击行为。

## 6. 追踪审计点埋伏

全流程重要动作均整合了 `AuditService`，能够向 DB 日志数据下放审计存证（`tableName: auth_login`）：

- **登录与尝试**：失败密码匹配、速率拦截熔断、常规登录成功。
- **权限核验**：敏感查询可以通过传递 `CheckPermissionOptions.audit=true` 同步开启鉴权和行为追踪的双向记录。
