# 财务基础配置 (Finance Base)

## 1. 模块概述 (Module Overview)

| 属性 | 说明 |
|:---|:---|
| **模块名称** | 财务基础配置 (Finance Base) |
| **核心价值** | 提供财务系统的通用配置和基础规则 |
| **目标用户** | 财务、管理员、店长 |
| **关联模块** | 收款单、付款单、对账单 |

## 2. 系统设置 (System Settings)

### 2.1 租户级别配置

系统支持在租户级别配置财务相关规则，不同租户可以根据自身业务需求灵活设置。

#### 2.1.1 差额处理设置

| 配置项 | 配置键 | 类型 | 默认值 | 说明 |
|:---|:---|:---|:---|:---|
| **允许差额** | `allow_difference` | Boolean | `true` | 是否允许收款金额与应收金额存在差额 |
| **最大差额金额** | `max_difference_amount` | Decimal | `100` | 允许的最大差额金额（单位：元） |
| **差额处理方式** | `difference_handling` | Enum | `AUTO_ADJUST` | 差额处理方式（自动调整/手工记录/禁止） |

**差额处理方式说明：**

| 方式 | 代码 | 说明 |
|:---|:---|:---|
| **自动调整** | `AUTO_ADJUST` | 自动调整应收金额，使应收金额等于收款金额 |
| **手工记录** | `MANUAL_RECORD` | 记录差额，不调整应收金额，差额计入"差额科目" |
| **禁止** | `FORBIDDEN` | 不允许存在差额，必须严格匹配 |

**业务规则：**

1. **允许差额 + 自动调整：**
   * 收款金额与应收金额存在差额时，系统自动调整应收金额
   * 调整后的应收金额 = 收款金额
   * 系统记录调整日志，包含调整原因和调整金额

2. **允许差额 + 手工记录：**
   * 收款金额与应收金额存在差额时，系统记录差额
   * 应收金额保持不变
   * 差额计入财务的"差额科目"
   * 差额金额 = 收款金额 - 应收金额（正数为多收，负数为少收）

3. **允许差额 + 禁止：**
   * 收款金额与应收金额必须严格相等
   * 如果存在差额，系统拒绝保存并提示错误
   * 要求用户重新核对金额

4. **不允许差额：**
   * 收款金额与应收金额必须严格相等
   * 如果存在差额，系统拒绝保存并提示错误

#### 2.1.2 抹零设置

| 配置项 | 配置键 | 类型 | 默认值 | 说明 |
|:---|:---|:---|:---|:---|
| **允许抹零** | `allow_rounding` | Boolean | `true` | 是否允许对金额进行抹零处理 |
| **抹零方式** | `rounding_mode` | Enum | `ROUND_DOWN` | 抹零方式（向下取整/四舍五入/向上取整） |
| **抹零单位** | `rounding_unit` | Enum | `YUAN` | 抹零单位（元/角/分） |

**抹零方式说明：**

| 方式 | 代码 | 说明 | 示例（抹零到元） |
|:---|:---|:---|:---|
| **向下取整** | `ROUND_DOWN` | 直接舍弃小数部分 | 123.99 → 123.00 |
| **四舍五入** | `ROUND_HALF_UP` | 按四舍五入规则 | 123.99 → 124.00 |
| **向上取整** | `ROUND_UP` | 小数部分进位 | 123.01 → 124.00 |

**抹零单位说明：**

| 单位 | 代码 | 说明 | 示例 |
|:---|:---|:---|:---|
| **元** | `YUAN` | 抹零到整数元 | 123.99 → 124.00 |
| **角** | `JIAO` | 抹零到角（保留1位小数） | 123.99 → 123.90 |
| **分** | `FEN` | 抹零到分（保留2位小数） | 123.999 → 123.99 |

**业务规则：**

1. **允许抹零：**
   * 在收款时，系统根据抹零方式和抹零单位自动计算抹零后的金额
   * 抹零差额计入财务的"抹零科目"
   * 抹零差额 = 原始金额 - 抹零后金额
   * 系统记录抹零日志，包含抹零原因和抹零金额

2. **不允许抹零：**
   * 收款金额必须精确到分，不能进行抹零处理
   * 系统不提供抹零功能

#### 2.1.3 配置示例

**场景1：允许小额差额和抹零（推荐）**
```json
{
  "allow_difference": true,
  "max_difference_amount": 100,
  "difference_handling": "MANUAL_RECORD",
  "allow_rounding": true,
  "rounding_mode": "ROUND_DOWN",
  "rounding_unit": "YUAN"
}
```

**场景2：严格模式（不允许差额和抹零）**
```json
{
  "allow_difference": false,
  "max_difference_amount": 0,
  "difference_handling": "FORBIDDEN",
  "allow_rounding": false,
  "rounding_mode": null,
  "rounding_unit": null
}
```

**场景3：宽松模式（允许自动调整）**
```json
{
  "allow_difference": true,
  "max_difference_amount": 500,
  "difference_handling": "AUTO_ADJUST",
  "allow_rounding": true,
  "rounding_mode": "ROUND_HALF_UP",
  "rounding_unit": "JIAO"
}
```

### 2.2 配置界面

#### 2.2.1 系统设置页面

**页面路径：** 系统设置 > 财务设置

**页面布局：**
```
┌─────────────────────────────────────────────────────┐
│ 财务系统设置                              [保存]     │
├─────────────────────────────────────────────────────┤
│ 差额处理设置                                         │
│ ┌───────────────────────────────────────────────┐  │
│ │ ☑ 允许差额                                     │  │
│ │ 最大差额金额: [100] 元                         │  │
│ │ 差额处理方式: [手工记录 ▼]                     │  │
│ └───────────────────────────────────────────────┘  │
│                                                     │
│ 抹零设置                                             │
│ ┌───────────────────────────────────────────────┐  │
│ │ ☑ 允许抹零                                     │  │
│ │ 抹零方式: [向下取整 ▼]                         │  │
│ │ 抹零单位: [元 ▼]                               │  │
│ └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

**表单字段：**

| 字段 | 组件 | 必填 | 说明 |
|:---|:---|:---|:---|
| 允许差额 | `Switch` | - | 开关控制是否允许差额 |
| 最大差额金额 | `InputNumber` | - | 允许的最大差额金额，仅当允许差额时显示 |
| 差额处理方式 | `Select` | - | 选择差额处理方式，仅当允许差额时显示 |
| 允许抹零 | `Switch` | - | 开关控制是否允许抹零 |
| 抹零方式 | `Select` | - | 选择抹零方式，仅当允许抹零时显示 |
| 抹零单位 | `Select` | - | 选择抹零单位，仅当允许抹零时显示 |

**操作权限：**
* 仅管理员和店长可以修改系统设置
* 修改设置需要二次确认
* 系统记录设置修改日志，包含修改人、修改时间、修改内容

### 2.3 差额和抹零的应用场景

#### 2.3.1 收款场景

**场景1：客户多付小额款项**
* 订单金额：1000.00 元
* 客户实际支付：1000.50 元
* 差额：+0.50 元
* 处理方式：
  - **自动调整**：应收金额调整为 1000.50 元
  - **手工记录**：应收金额保持 1000.00 元，差额 0.50 元计入"差额科目"
  - **禁止**：系统拒绝保存，提示金额不匹配

**场景2：抹零处理**
* 订单金额：1234.99 元
* 客户实际支付：1234.00 元（要求抹零）
* 抹零差额：-0.99 元
* 处理方式：
  - **向下取整到元**：应收金额调整为 1234.00 元，抹零差额 0.99 元计入"抹零科目"
  - **四舍五入到元**：应收金额调整为 1235.00 元，抹零差额 -0.01 元计入"抹零科目"

#### 2.3.2 付款场景

**场景1：供应商发票金额与采购金额不一致**
* 采购金额：5000.00 元
* 供应商发票金额：5000.50 元
* 差额：+0.50 元
* 处理方式：
  - **自动调整**：应付金额调整为 5000.50 元
  - **手工记录**：应付金额保持 5000.00 元，差额 0.50 元计入"差额科目"
  - **禁止**：系统拒绝保存，提示金额不匹配

**场景2：抹零处理**
* 采购金额：6789.99 元
* 实际付款：6789.00 元（要求抹零）
* 抹零差额：-0.99 元
* 处理方式：
  - **向下取整到元**：应付金额调整为 6789.00 元，抹零差额 0.99 元计入"抹零科目"

### 2.4 财务科目说明

系统自动创建以下财务科目，用于记录差额和抹零：

| 科目代码 | 科目名称 | 科目类型 | 说明 |
|:---|:---|:---|:---|
| `DIFFERENCE_INCOME` | 差额收入 | 收入 | 记录收款差额（多收） |
| `DIFFERENCE_EXPENSE` | 差额支出 | 支出 | 记录付款差额（多付） |
| `ROUNDING_INCOME` | 抹零收入 | 收入 | 记录抹零差额（少收） |
| `ROUNDING_EXPENSE` | 抹零支出 | 支出 | 记录抹零差额（少付） |

**科目使用规则：**

1. **收款场景：**
   * 收款金额 > 应收金额：差额计入 `DIFFERENCE_INCOME`
   * 收款金额 < 应收金额：差额计入 `DIFFERENCE_EXPENSE`
   * 抹零处理：抹零差额计入 `ROUNDING_INCOME`（少收）或 `ROUNDING_EXPENSE`（多收）

2. **付款场景：**
   * 付款金额 > 应付金额：差额计入 `DIFFERENCE_EXPENSE`
   * 付款金额 < 应付金额：差额计入 `DIFFERENCE_INCOME`
   * 抹零处理：抹零差额计入 `ROUNDING_EXPENSE`（少付）或 `ROUNDING_INCOME`（多付）

## 3. 技术实施建议

### 3.1 数据库层 (Drizzle Schema)

```typescript
// 财务配置表
export const financeConfigs = pgTable('finance_configs', {
  id: uuid('id').defaultRandom().primaryKey(),
  tenantId: uuid('tenant_id').notNull(),
  configKey: varchar('config_key', { length: 100 }).notNull(),
  configValue: text('config_value').notNull(),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// 财务科目表
export const financeAccounts = pgTable('finance_accounts', {
  id: uuid('id').defaultRandom().primaryKey(),
  accountCode: varchar('account_code', { length: 50 }).notNull().unique(),
  accountName: varchar('account_name', { length: 100 }).notNull(),
  accountType: varchar('account_type', { length: 20 }).notNull(), // INCOME/EXPENSE
  description: text('description'),
  isActive: boolean('is_active').default(true),
  createdAt: timestamp('created_at').defaultNow(),
});
```

### 3.2 业务逻辑层 (Server Actions)

```typescript
// 抹零处理函数
export async function processRounding(
  amount: number,
  config: {
    allowRounding: boolean;
    roundingMode: 'ROUND_DOWN' | 'ROUND_HALF_UP' | 'ROUND_UP';
    roundingUnit: 'YUAN' | 'JIAO' | 'FEN';
  }
): Promise<{ roundedAmount: number; roundingDiff: number }> {
  if (!config.allowRounding) {
    return { roundedAmount: amount, roundingDiff: 0 };
  }

  let multiplier = 1;
  switch (config.roundingUnit) {
    case 'YUAN':
      multiplier = 1;
      break;
    case 'JIAO':
      multiplier = 10;
      break;
    case 'FEN':
      multiplier = 100;
      break;
  }

  const scaledAmount = amount * multiplier;
  let roundedScaled: number;

  switch (config.roundingMode) {
    case 'ROUND_DOWN':
      roundedScaled = Math.floor(scaledAmount);
      break;
    case 'ROUND_HALF_UP':
      roundedScaled = Math.round(scaledAmount);
      break;
    case 'ROUND_UP':
      roundedScaled = Math.ceil(scaledAmount);
      break;
  }

  const roundedAmount = roundedScaled / multiplier;
  const roundingDiff = amount - roundedAmount;

  return { roundedAmount, roundingDiff };
}

// 获取租户财务配置
export async function getTenantFinanceConfig(tenantId: string) {
  const configs = await db
    .select()
    .from(financeConfigs)
    .where(eq(financeConfigs.tenantId, tenantId));

  return configs.reduce((acc, config) => {
    acc[config.configKey] = config.configValue;
    return acc;
  }, {} as Record<string, string>);
}
```

### 3.3 UI 组件层

```typescript
// 财务设置表单组件
export function FinanceSettingsForm() {
  const [config, setConfig] = useState({
    allowDifference: true,
    maxDifferenceAmount: 100,
    differenceHandling: 'MANUAL_RECORD',
    allowRounding: true,
    roundingMode: 'ROUND_DOWN',
    roundingUnit: 'YUAN',
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle>财务系统设置</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        <div className="space-y-4">
          <h3 className="font-semibold">差额处理设置</h3>
          <div className="flex items-center space-x-2">
            <Switch
              checked={config.allowDifference}
              onCheckedChange={(checked) =>
                setConfig({ ...config, allowDifference: checked })
              }
            />
            <span>允许差额</span>
          </div>
          {config.allowDifference && (
            <>
              <div className="space-y-2">
                <Label>最大差额金额（元）</Label>
                <InputNumber
                  value={config.maxDifferenceAmount}
                  onChange={(value) =>
                    setConfig({ ...config, maxDifferenceAmount: value })
                  }
                />
              </div>
              <div className="space-y-2">
                <Label>差额处理方式</Label>
                <Select
                  value={config.differenceHandling}
                  onValueChange={(value) =>
                    setConfig({ ...config, differenceHandling: value })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="AUTO_ADJUST">自动调整</SelectItem>
                    <SelectItem value="MANUAL_RECORD">手工记录</SelectItem>
                    <SelectItem value="FORBIDDEN">禁止</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </>
          )}
        </div>

        <div className="space-y-4">
          <h3 className="font-semibold">抹零设置</h3>
          <div className="flex items-center space-x-2">
            <Switch
              checked={config.allowRounding}
              onCheckedChange={(checked) =>
                setConfig({ ...config, allowRounding: checked })
              }
            />
            <span>允许抹零</span>
          </div>
          {config.allowRounding && (
            <>
              <div className="space-y-2">
                <Label>抹零方式</Label>
                <Select
                  value={config.roundingMode}
                  onValueChange={(value) =>
                    setConfig({ ...config, roundingMode: value })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="ROUND_DOWN">向下取整</SelectItem>
                    <SelectItem value="ROUND_HALF_UP">四舍五入</SelectItem>
                    <SelectItem value="ROUND_UP">向上取整</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>抹零单位</Label>
                <Select
                  value={config.roundingUnit}
                  onValueChange={(value) =>
                    setConfig({ ...config, roundingUnit: value })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="YUAN">元</SelectItem>
                    <SelectItem value="JIAO">角</SelectItem>
                    <SelectItem value="FEN">分</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </>
          )}
        </div>

        <Button onClick={handleSave}>保存</Button>
      </CardContent>
    </Card>
  );
}
```
