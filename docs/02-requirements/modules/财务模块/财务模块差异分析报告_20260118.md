# 财务模块差异分析报告

**日期**: 2026-01-18
**分析对象**: 财务模块 (Finance)
**对比基准**:

- 需求文档: `docs/02-requirements/modules/财务模块/*.md`
- 代码实现: `src/features/finance/*`, `src/shared/api/schema/finance.ts`

---

## 1. 总体概览

当前财务模块的代码实现与需求文档存在较大差距。`docs/整改计划.md` 中列出的 "财务模块需求整改计划" 正是针对这些缺失功能的规划，目前的审计结果确认这些规划尚未被执行到代码层面。

主要缺失集中在：

1.  **资金调拨 (Internal Transfer)**: 完全缺失。
2.  **逆向流程 (Refunds)**: 客户退款和供应商退款的完整闭环（红字对账单 -> 退款单）完全缺失。
3.  **对账逻辑 (Reconciliation)**: 代码中的 `reconciliations` 表与文档要求的 "周期性账单确认 (Statement Confirmation)" 存在概念和命名上的差异。
4.  **账户管理**: 虚拟账户 (`VIRTUAL`) 支持缺失。

---

## 2. 数据库结构差异 (Database Schema)

| 实体/表名                   | 需求状态                    | 代码现状               | 差异描述                                                                                                 | 严重程度     |
| :-------------------------- | :-------------------------- | :--------------------- | :------------------------------------------------------------------------------------------------------- | :----------- |
| **internal_transfers**      | `财务基础.md` 定义          | **缺失**               | 缺少资金调拨表，无法记录提现、充值、备用金划转。                                                         | **Critical** |
| **financial_accounts**      | 支持 `VIRTUAL` 类型         | Enum 缺失              | 现有 Enum 仅包含 BANK/WECHAT/ALIPAY/CASH，缺失 VIRTUAL。                                                 | Major        |
| **credit_notes**            | `付款单.md` 定义            | **缺失**               | 缺少 "红字AR对账单" 表，客户退款缺乏前置单据。                                                           | **Critical** |
| **debit_notes**             | `收款单.md` 定义            | **缺失**               | 缺少 "红字AP对账单" 表，供应商退款缺乏前置单据。                                                         | **Critical** |
| **payment_bills**           | 支持 `REFUND_TO_CUSTOMER`   | 缺失 Type              | `type` 字段缺失 `REFUND_TO_CUSTOMER` 枚举值；缺失 `credit_note_id` 关联字段。                            | Major        |
| **receipt_bills**           | 支持 `REFUND_FROM_SUPPLIER` | 缺失 Type              | `type` 字段缺失 `REFUND_FROM_SUPPLIER` 枚举值；缺失 `debit_note_id` 关联字段。                           | Major        |
| **statement_confirmations** | `对账单.md` 定义            | 名为 `reconciliations` | 代码中使用 `reconciliations` 表，结构偏向于 "自动匹配" 而非 "周期性账单确认"。文档建议重命名并明确用途。 | Moderate     |

---

## 3. 业务逻辑与 API 差异 (Business Logic & APIs)

### 3.1 资金账户与调拨

- **需求**: 支持资金在不同内部账户间划转（如 微信 -> 银行），生成双向流水 (Transfer In/Out)。
- **现状**: 无相关 Action 或 Logic。
- **影响**: 财务无法在系统中记录资金流转，导致账户余额与实际不符。

### 3.2 客户退款 (Customer Refunds)

- **需求**: 订单取消/售后 -> 生成红字AR (Credit Note) -> 财务基于红字AR创建付款单 (Refund)。
- **现状**: 系统中无退款流程。目前可能只能通过手动负数订单或线下处理，缺乏系统约束和关联。
- **影响**: 售后资金流缺乏管控，易造成资金风险。

### 3.3 供应商退款 (Supplier Refunds)

- **需求**: 采购退货 -> 生成红字AP (Debit Note) -> 财务基于红字AP创建收款单 (Refund)。
- **现状**: 同上，无退款流程。

### 3.4 对账确认 (Statement Confirmation)

- **需求**: 按月生成对账单据，供客户/供应商确认盖章。
- **现状**: `src/features/finance` 下似乎主要侧重于 AR/AP 的单据管理，缺乏 "周期性生成对账单" 的定时任务或逻辑。`reconciliations` 表存在但业务逻辑未完全对应文档的 L2 确认流程。

---

## 4. UI/UX 差异

- **资金账户**: 编辑/新建弹窗中缺少 "虚拟账户" 选项。
- **资金调拨**: 缺少 "资金调拨" 页面及相关操作表单。
- **收/付款单**:
  - 新建付款单时，缺少 "客户退款" 类型及选择 "红字AR" 的交互。
  - 新建收款单时，缺少 "供应商退款" 类型及选择 "红字AP" 的交互。
- **对账单**: 缺少 "对账单据" 的生成、查看、确认（上传盖章文件）的完整 UI 流程。

---

## 5. 建议整改计划 (Recommendations)

此分析确认了 `docs/整改计划.md` 中关于财务模块的规划是准确且必要的。建议按以下步骤执行：

1.  **Schema 补全 (P0)**:
    - 创建 `internal_transfers` 表。
    - 创建 `credit_notes` 和 `debit_notes` 表。
    - 补全 `payment_bills` 和 `receipt_bills` 的类型枚举和关联字段。
    - 调整 `reconciliations` 表结构或新建 `statement_confirmations` 表（推荐后者以分离关注点）。

2.  **基础逻辑实现 (P0)**:
    - 实现 `VIRTUAL` 账户逻辑。
    - 实现资金调拨 (Transfer) 的 Action，确保原子性（一进一出）。

3.  **逆向流程实现 (P1)**:
    - 实现 "生成红字对账单" 的逻辑（需联动订单/采购模块）。
    - 实现基于红字单据的退款逻辑。

4.  **对账升级 (P2)**:
    - 实现周期性对账单生成逻辑。
    - 完善对账确认 UI。

---

**结论**: 财务模块目前处于 "基础收付功能可用，但深层业务闭环缺失" 的状态，无法满足复杂的资金流转（调拨、退款）和合规对账需求。需立即启动整改。
