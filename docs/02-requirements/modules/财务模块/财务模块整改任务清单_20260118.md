# 财务模块整改任务清单

## Phase 1: 基础架构 (Infrastructure) ✅ 已完成

- [x] **Schema**: 更新 `financial_accounts` 支持 `VIRTUAL` 类型 @schema ✅
- [x] **Schema**: 创建 `internal_transfers` 表 @schema (已存在)
- [x] **Action**: 实现 `createInternalTransfer` @action (已存在)
- [x] **Action**: 实现 `cancelInternalTransfer` (冲销调拨) @action ✅
- [x] **UI**: 资金调拨列表页开发 @ui ✅
- [x] **UI**: 资金调拨新建/详情弹窗 @ui ✅

## Phase 2: 逆向流程 (Refunds) ✅ 核心完成

- [x] **Schema**: 创建 `credit_notes` 表 @schema ✅
- [x] **Schema**: 创建 `debit_notes` 表 @schema ✅
- [x] **Schema**: 更新 `payment_bills` 支持REFUND类型 @schema ✅
- [x] **Schema**: 更新 `receipt_bills` 支持REFUND类型 @schema ✅
- [x] **Action**: 实现 `createCreditNote` @action ✅
- [x] **Action**: 实现 `approveCreditNote` (审批贷项) @action ✅
- [x] **Action**: `verifyPaymentBill` 已支持退款逻辑 @action ✅ (通用逻辑)
- [x] **Action**: 实现 `createDebitNote` @action ✅
- [x] **Action**: 实现 `approveDebitNote` (审批借项) @action ✅
- [x] **Action**: `createRefundStatement`/`createSupplierRefundStatement` 已存在 @action ✅
- [ ] **UI**: 付款单-客户退款适配 @ui (后续)
- [ ] **UI**: 收款单-供应商退款适配 @ui (后续)

## Phase 3: 对账与联动 (Reconciliation) ✅ 完成

- [x] **Schema**: 创建 `statement_confirmations` 表 @schema ✅
- [x] **Schema**: 创建 `statement_confirmation_details` 表 @schema ✅
- [x] **Action**: 实现 `generateStatementConfirmation` 生成对账确认单 @action ✅
- [x] **Action**: 工费结算联动 `generateLaborSettlement` 已存在 @action ✅
- [x] **Action**: 佣金联动 `commissionRecords` 已在AR中关联 @action ✅
