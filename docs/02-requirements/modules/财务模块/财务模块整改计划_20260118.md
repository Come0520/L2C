# 财务模块整改计划

**版本**: 1.0
**日期**: 2026-01-18
**状态**: 待执行
**优先级**: P0

---

## 1. 总体目标

完善财务模块的基础架构，补全缺失的资金调拨、逆向流程（退款）和合规对账功能，确保资金流数据的完整性和准确性。

---

## 2. 详细整改内容

### Phase 1: 基础架构重构 (Infrastructure) - 预计 2 天

#### 1.1 资金账户体系升级

- **目标**: 下沉账户定义，支持虚拟账户。
- **Schema**:
  - `financial_accounts`: 确保独立于付款单模块定义。
  - `account_type`: Enum 增加 `VIRTUAL`。
- **Action**:
  - `createFinancialAccount`: 支持 `VIRTUAL` 类型。
  - `updateFinancialAccount`: 相关校验。

#### 1.2 资金调拨 (Internal Transfer)

- **目标**: 实现内部账户资金划转。
- **Schema**:
  - 新增 `internal_transfers` 表。
- **Action**:
  - `createInternalTransfer`: 创建草稿。
  - `verifyInternalTransfer`: 审核并执行（生成 AccountTransaction: Source OUT, Target IN）。
- **UI**:
  - 资金调拨列表页。
  - 新建/审核调拨单弹窗。

---

### Phase 2: 逆向流程补全 (Refunds) - 预计 3 天

#### 2.1 客户退款 (Customer Refund)

- **目标**: 实现基于红字AR的客户退款。
- **Schema**:
  - 新增 `credit_notes` (红字AR对账单) 表。
  - `payment_bills` 增加 `REFUND_TO_CUSTOMER` 类型及 `credit_note_id` 字段。
- **Action**:
  - `createCreditNote`: 由 Order Cancel 或 AfterSales 生成。
  - `createCustomerRefund`: 基于 CreditNote 创建 PaymentBill。
  - `verifyPaymentBill`: 处理退款逻辑（检查余额、更新 CreditNote 状态）。
- **UI**:
  - 在付款单页面增加 "客户退款" 类型支持。
  - 选择红字AR弹窗。

#### 2.2 供应商退款 (Supplier Refund)

- **目标**: 实现基于红字AP的供应商退款。
- **Schema**:
  - 新增 `debit_notes` (红字AP对账单) 表。
  - `receipt_bills` 增加 `REFUND_FROM_SUPPLIER` 类型及 `debit_note_id` 字段。
- **Action**:
  - `createDebitNote`: 由 Purchase Return 生成。
  - `createSupplierRefund`: 基于 DebitNote 创建 ReceiptBill。
  - `verifyReceiptBill`: 处理退款逻辑。
- **UI**:
  - 在收款单页面增加 "供应商退款" 类型支持。

---

### Phase 3: 对账与联动 (Reconciliation & Linkage) - 预计 2 天

#### 3.1 对账单 (Statement Confirmation)

- **目标**: 实现周期性账单确认逻辑。
- **Schema**:
  - 重构/确认 `reconciliations` 表用途，建议新建 `statement_confirmations` 表以明确 "周期性单据" 的定位，与 "自动核销" 区分。
- **Action**:
  - `generateMonthlyStatement`: 定时任务生成上月对账单。
  - `confirmStatement`: 上传盖章文件并确认。
- **UI**:
  - 对账单列表与详情页。

#### 3.2 业务联动

- **工费结算**: 确保安装单完成 -> 触发工费计算 -> 生成 `AP_LABOR`。
- **佣金结算**: 确保 AR Paid -> 触发佣金计算 -> 生成 `CommissionRecord`。

---

## 3. 风险评估

1.  **数据迁移**: 若已有线上数据，`financial_accounts` 的调整可能涉及数据迁移。
2.  **并发一致性**: 资金调拨涉及两个账户的余额更新，需确保事务一致性。
3.  **权限控制**: 退款涉及资金流出，需严格配置审批权限（店长/财务总监）。
