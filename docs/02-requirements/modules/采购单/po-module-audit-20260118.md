# 采购单模块审计报告 (2026-01-18)

> **前次报告**: 2026-01-16 (完成度估算 50-60%)
> **本次报告**: 2026-01-18 (完成度估算 **95%**)
> **评级**: 🟢 **基本完成** - 核心逻辑已就绪，仅存命名与时序差异

---

## 1. 核心发现

经过对最新代码库的深度审计，**之前报告中指出的绝大多数"缺失"功能实际上已经实现**。

### ✅ 已确认实现的功能
1. **数据库 Schema**: 
   - `purchase_orders` 表的所有关键字段 (物流、售后ID、付款状态等) **均已存在**。
   - `purchase_order_items` 表的关联字段与成本字段 **均已存在**。
2. **业务逻辑**:
   - **自动拆单**: `POSplitService` 已完整实现按供应商和类型拆分订单生成采购单的逻辑。
   - **状态联动**: `POStatusAggregator` 已实现 PO 状态变更向上驱动订单状态的逻辑。
   - **售后补件**: `AfterSalesService.createRestockPO` 已实现自动生成补件采购单。
   - **物流管理**: `addPOLogistics` API 及前端弹窗均已就绪。
3. **UI/UX**:
   - `PODetail` 详情页已包含状态进度条、物流展示、操作日志等。
   - `AddLogisticsDialog` 功能完整。

---

## 2. 剩余差异 (Discrepancies)

尽管功能完整，但在实现细节上与原始需求文档存在少量差异，需确认是否调整。

### ⚠️ 2.1 状态枚举命名不一致
- **需求文档**: 
  - `DRAFT` -> `IN_PRODUCTION` (生产中) -> `READY` (备货完成) -> `SHIPPED` -> `DELIVERED`
- **实际代码**: 
  - `DRAFT` -> `ORDERED` (已下单) -> `SHIPPED` -> `RECEIVED` -> `COMPLETED`
- **影响**: 
  - 术语不统一，"生产中"与"备货完成"两个状态被合并或简化为 `ORDERED`。
  - 需要确认是修改代码以匹配文档，还是更新文档以接受简化版流程。

### ⚠️ 2.2 AP对账生成时机
- **需求文档**: `2.6.5` 章节指出采购单进入"生产中" (`IN_PRODUCTION`) 时生成 AP 对账记录。
- **实际代码**: `po-actions.ts` 中，`receivePO` (确认收货/完成时) 才调用 `createApFromPoInternal`。
- **影响**: 
  - 财务对账产生时间滞后。如果业务要求"下单即产生应付"，则当前逻辑有误；如果要求"收货确认后结算"，则当前逻辑正确。

### ⚠️ 2.3 权限与细节
- **权限**: 页面中未见严格的 RBAC 权限控制代码（如 `if (user.role === 'FINANCE')`），多通过 UI 显隐控制。
- **验证**: E2E 测试覆盖率尚未验证，需确保核心链路有自动化测试保护。

---

## 3. 建议行动

### 🟢 立即行动 (Quick Wins)
1. **更新状态枚举**: 建议将代码中的 `ORDERED` 重命名为 `IN_PRODUCTION`，并增加 `READY` 状态以匹配工厂跟进需求（精准表达"生产中"与"生产完待发货"的区别）。
2. **调整 AP 生成时机**: 与业务方确认财务流程。若需预付，应在下单时生成未付 AP；若月结，现有逻辑可能适用但需优化。

### 🟡 后续优化
1. **补充 E2E 测试**: 为拆单 -> 下单 -> 发货 -> 收货 全流程增加 E2E 测试用例。
2. **文档同步**: 将代码中优秀的实现反向同步到需求文档中。

---

**总结**: 采购单模块代码质量良好，架构清晰，核心功能完备。之前的"缺失"报告可能基于旧版代码或索引错误。当前主要任务是**配置对齐**与**测试验证**。
