# 销售目标模块需求文档

> 模块路径：`src/features/sales/`  
> 负责人：Admin/Manager/BOSS  
> 最后更新：2026-02-21

---

## 1. 功能概述

销售目标模块（Sales）为 L2C 系统提供销售业绩跟踪和目标管理能力，支持：

- **目标设定**：管理层为销售人员设定月度销售目标金额
- **仪表盘**：个人和团队两种视图，展示当月目标/完成/线索/报价/订单数据
- **趋势分析**：最近6个月目标完成率趋势曲线
- **排名对比**：团队成员间的当月业绩排名
- **预警提醒**：月中预测达成情况，识别高风险未达标成员

---

## 2. 角色权限矩阵

| 功能               | BOSS | admin | manager | sales | 其他 |
|:------------------|:----:|:-----:|:-------:|:-----:|:----:|
| 查看团队仪表盘      | ✅   | ✅    | ✅      | ❌    | ❌   |
| 查看个人仪表盘      | ✅   | ✅    | ✅      | ✅    | ❌   |
| 设定/修改销售目标   | ✅   | ✅    | ✅      | ❌    | ❌   |
| 查看个人目标        | ✅   | ✅    | ✅      | ✅    | ❌   |
| 查看团队排名        | ✅   | ✅    | ✅      | ❌    | ❌   |
| 查看完成率趋势      | ✅   | ✅    | ✅      | ✅*   | ❌   |
| 查看预警提醒        | ✅   | ✅    | ✅      | ❌    | ❌   |

> *sales 只能查看自己的趋势

---

## 3. 核心数据模型

### 3.1 销售目标（salesTargets）

| 字段          | 类型     | 说明                        |
|:-------------|:--------|:---------------------------|
| id           | UUID    | 主键                        |
| tenantId     | UUID    | 租户 ID（多租户隔离）         |
| userId       | UUID    | 销售人员 ID                  |
| year         | Integer | 年份（2020~2100）            |
| month        | Integer | 月份（1~12）                 |
| targetAmount | Decimal | 目标金额（元，精度 2 位小数） |
| updatedBy    | UUID    | 最后更新人 ID                |
| updatedAt    | Date    | 最后更新时间                 |

**唯一约束**：`(tenantId, userId, year, month)`

### 3.2 数据来源（仪表盘计算）

| 指标        | 数据来源                                               |
|:-----------|:------------------------------------------------------|
| 完成金额    | `quotes` 表中 `status='ACCEPTED'` 的 `finalAmount` 合计 |
| 线索数      | `customers` 表按 `pipelineStatus` 分组统计              |
| 报价数      | `quotes` 表记录数（含所有状态）                          |
| 订单数      | `quotes` 表中 `status='ORDERED'` 的记录数               |

---

## 4. 业务流程

### 4.1 设定目标流程

```
管理层 → 打开目标设置页 → 选择年月 → 输入各销售人员金额 → 保存
       ↓
 updateSalesTarget() 调用 → Zod 校验 → 权限检查 → Upsert → AuditService.log
```

### 4.2 仪表盘查看流程

```
用户登录 → getSalesDashboardStats()
         → 角色判断：admin/manager/BOSS → 团队视图（所有租户成员数据）
         →          其他角色          → 个人视图（仅本人数据）
```

### 4.3 预警提醒触发条件

- 月中（当天在该月中的进度 = 今天/总天数）线性外推月底预测完成率 < 80% 时标记为 `atRisk`
- 风险等级：
  - `high`：预测完成率 < 50%
  - `medium`：50% ≤ 预测完成率 < 80%
  - `low`：预测完成率 ≥ 80%（无风险）

---

## 5. 数据校验规则（Zod Schema）

| 动作                 | 校验规则                                                |
|:--------------------|:-------------------------------------------------------|
| getSalesTargets      | `year: int(2020~2100)`, `month: int(1~12)`             |
| updateSalesTarget    | 同上 + `userId: string(min:1)`, `amount: number(≥0)`   |
| getMySalesTarget     | `year?`, `month?`（与上同，但均可选）                   |

---

## 6. 安全措施

- **认证 (Auth)**：所有 Action 首先调用 `auth()` 验证 Session
- **多租户隔离 (Tenant Isolation)**：所有查询均带 `tenantId` 条件，防止跨租户数据泄露
- **权限控制 (RBAC)**：写操作和团队视图仅限 `admin/manager/BOSS` 角色
- **审计日志 (Audit Log)**：所有写操作调用 `AuditService.log`，记录旧值/新值

---

## 7. API 参考

### `getSalesTargets(year, month)`
获取指定年月所有销售人员的目标列表。

**返回**：`SalesTargetDTO[]` — 数组中每条包含 userId/userName/targetAmount/updatedAt。

### `updateSalesTarget(userId, year, month, amount)`
新建或更新指定销售人员的月度目标（Upsert）。

**副作用**：写入审计日志，刷新 `/settings/sales/targets` 页面缓存。

### `getMySalesTarget(year?, month?)`
获取当前登录用户的月度目标，不传参数默认取当月。

### `getSalesDashboardStats()`
获取仪表盘统计数据，根据角色自动切换团队/个人视图。
- **缓存策略 (Performance Cache)**：此查询被 `unstable_cache` 包裹（TTL=3600秒即1小时），以租户为边界进行严格隔离。
- **缓存 Key 模型**：`['sales-dashboard', tenantId, role, userId, year, month]`，保障跨角色或跨月的数据不发生错乱。

### `getSalesCompletionTrend(userId?)`
获取最近 6 个月的目标完成率趋势曲线，用于折线图展示。

### `getSalesRanking(year?, month?)`
获取当月团队销售排名（含完成金额、完成率、排名序号）。

### `getSalesTargetWarnings()`
获取月中预警列表，仅返回预测完成率 < 80% 的成员，按风险从高到低排序。

---

## 8. 前端组件说明

| 组件文件                      | 功能说明                          |
|:-----------------------------|:----------------------------------|
| `target-progress-card.tsx`   | 目标进度卡片，展示个人当月目标/完成/完成率+进度条 |
| `sales-ranking-table.tsx`    | 销售排名表，展示团队成员排名和完成情况         |

---

## 9. 待扩展功能（Backlog）

- [ ] 季度/年度目标支持
- [ ] 目标自动拆解（年度 → 月度建议值）
- [ ] 基于历史数据的目标推荐
- [ ] 微信/企微预警通知推送
