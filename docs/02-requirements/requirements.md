# 需求记录 (Requirements Log)

用于记录所有用户提出的需求变更和新增需求。

## 2026-01-06

### [Workbench] 工作台交互重构

- **来源**: 用户需求
- **状态**: 进行中
- **内容**:
  - **Tab 模式切换**: 将工作台重构为 Tabs 布局，一级 Tab 分别为“我的待办”和“预警中心”。
  - **侧边栏简化**: 移除侧边栏中关于待办、预警的二级入口，统一收敛至工作台内部 Tabs 切换。

### [Navigation] 菜单结构调整

- **来源**: 用户需求
- **状态**: 进行中
- **内容**:
  - **采购单归属调整**: 将“采购单”从“订单管理”模块移动至“供应链”模块，强调订单管理的销售属性。

### [General] 状态回滚/驳回机制

- **来源**: 用户需求
- **状态**: 已更新至 `docs/requirements/modules/测量单.md`, `安装单.md`
- **内容**:
  - 支持"待确认→待上门→分配中→待分配"的逐级驳回
  - 驳回必须填写原因，记录到操作日志
  - 从"待确认"驳回时关联数据重置为可编辑状态
  - 驳回次数 ≥ 3 次时自动升级预警给店长

### [Supply] 商品属性模板

- **来源**: 产品建议 (AI Review)
- **状态**: 已更新至 `docs/requirements/modules/供应链.md`
- **内容**:
  - 新增 3.1-3.5 商品属性模板设计
  - 定义 4 个品类的属性结构（窗帘布料/轨道/墙布/标品）
  - 支持可视化报价公式配置

### [General] 文档优化

- **来源**: 产品建议 (AI Review)
- **状态**: 已完成
- **内容**:
  - 清理 `对账单.md` 和 `测量单.md` 中的重复内容
  - 新建 `docs/requirements/状态码速查表.md`（汇总所有模块状态枚举）

### [System] 审批流引擎

- **来源**: 产品建议 (AI Review)
- **状态**: 已更新至 `docs/requirements/modules/系统基础.md`
- **内容**:
  - 新增可视化审批流设计器（拖拽式配置）
  - 预置"报价折扣/订单撤销/特殊工费/坏账核销"审批场景
  - 定义 ApprovalTemplate/ApprovalNode/ApprovalInstance 数据结构

### [Finance] 收款提醒机制

- **来源**: 产品建议 (AI Review)
- **状态**: 已更新至 `docs/requirements/modules/对账单.md`
- **内容**:
  - 明确"每单收款比例由销售与客户商议，系统不做固定规定"
  - 新增收款计划录入功能（多节点）
  - 新增到期/逾期/周汇总提醒规则

### [Lead] 渠道层级管理

- **来源**: 产品建议 (AI Review)
- **状态**: 已更新至 `docs/requirements/modules/线索.md`
- **内容**:
  - 将 source 字段升级为三级渠道结构（大类/子渠道/具体来源）
  - 支持渠道效果分析（转化率/客单价/ROI）

### [Measurement] 离线能力完善

- **来源**: 产品建议 (AI Review)
- **状态**: 已更新至 `docs/requirements/modules/测量单.md`
- **内容**:
  - 明确可离线缓存的数据范围（任务/草稿/照片）
  - 定义离线操作限制（可办理/不可办理）
  - 新增同步机制和冲突解决策略

### [Customer] 客户档案模块 (NEW)

- **来源**: 产品建议 (AI Review)
- **状态**: 已建立 `docs/requirements/modules/客户.md`
- **内容**:
  - 独立客户实体，支持复购/转介绍追踪
  - 客户画像（累计交易/价值分层）
  - 自动建档和去重合并逻辑

### [AfterSales] 售后服务模块 (NEW)

- **来源**: 产品建议 (AI Review)
- **状态**: 已建立 `docs/requirements/modules/售后.md`
- **内容**:
  - 完整售后状态机（待受理→处理中→待上门→待回访→已关闭）
  - 保修期判定和责任追溯
  - 售后质量分析报表

### [AfterSales] 定责单与财务联动

- **来源**: 用户需求
- **状态**: 已更新至 `docs/requirements/modules/售后.md`
- **内容**:
  - **定责单 (Liability Notice)**: 新增独立单据，支持责任归属确认
  - **确认机制**: 发送给责任方（内部员工/外部工人/供应商）确认
  - **异议处理**: 支持责任方提出异议并由管理层仲裁
  - **财务联动**: 售后成本计入对账单（供应商扣款/工人扣款/客户收费）

### [Notification] 统一消息中心

- **来源**: 系统架构 (Phase 2)
- **状态**: 规划完成 -> 开发中
- **内容**:
  - **多渠道分发**: 支持 站内信 (In-App), 飞书 (Lark), 微信 (WeChat), 短信 (SMS)。
  - **分级策略**:
    - **Toast**: 仅用于当前用户操作的即时反馈 (Success/Error)。不持久化。
    - **Notification**: 用于异步事件 (审批/状态变更/预警)。持久化存储，支持多端推送。
  - **偏好设置**: 用户可自定义不同类型消息的接收渠道 (如: 订单变更只看站内信, 审批任务需短信提醒)。

### [System] 建立自动化测试体系

- **来源**: 用户指令
- **状态**: 规划中 (计划已制定)
- **内容**:
  - **测试金字塔**:
    - **E2E (Playwright)**: 覆盖 7 大核心业务闭环 (Lead->Measure->Quote->Order->PO->Install->Finance)。
    - **Integration**: 重点测试 Server Actions 和 API Routes 的数据流转与权限控制。
    - **Unit (Jest/Vitest)**: 覆盖 Utils, Hooks, Complex Components (e.g. 报价计算引擎)。
  - **基础设施**: 测试数据库环境隔离、Seed Data 准备、CI/CD 预演。

---

## 2025-12-30

### [Measurement] 测量单模块详细需求

- **来源**: 用户会话
- **状态**: 已归档至 `docs/requirements/modules/测量单.md`
- **内容摘要**:
  - 定义了核心字段 (基础信息, 窗户明细, 附件)。
  - 明确了业务规则 (强关联, 数据完整性, 状态流转)。
  - 制定了多端规范 (小程序离线/大按钮, Web端复核/转报价)。
  - 定义了异常处理 (尺寸校验, 上传重试)。

### [Measurement] 测量单创建规则变更

- **来源**: 用户反馈
- **状态**: 已更新至 `docs/requirements/modules/测量单.md`
- **内容**: 修正“强关联线索单”的规则。改为支持“直接创建”或“从报价单创建”的灵活配置。

### [General] 人员体系文档化

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/roles/`
- **内容**:
  - 定义了销售、派单员、工人的职责边界。
  - 明确了“销售直派”与“派单员调度”并存的双轨制派单逻辑。
  - 强调了派单员作为中间桥梁的议价职能。

### [Workflow] 销售-测量协同流程

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/workflows/销售_测量_协同.md`
- **内容**: 梳理了“下行（需求/预选商品）”与“上行（尺寸/环境/可行性）”的信息闭环，定义了自动回填报价单的逻辑。

### [Measurement] 现场考核与多版本

- **来源**: 用户反馈
- **状态**: 已更新 `docs/requirements/modules/测量单.md`
- **内容**:
  - 增加 **现场打卡 (Check-in)** 功能。
  - 细化 **多版本体系 (Advanced Versioning)**:
    - **场景1**: 同一轮次的多方案 (V1.A, V1.B) —— 支持**一测多报**。即针对 V1.A 和 V1.B 分别生成独立的报价单，供客户比选。
    - **场景2**: 不同轮次的重测 (V1 -> V2) —— 解决迭代修改问题。

### [Quote] 报价单核心需求

- **来源**: 用户会话
- **状态**: 已建立 `docs/requirements/modules/报价单.md`
- **内容**:
  - **双入口**: 必须支持“线索关联创建”和“直接创建”。
  - **多品类**: 覆盖窗帘、墙布、墙咔、飘窗垫、标品。
  - **双视图**: 系统需支持“按空间统计”和“按品类统计”两种维度的即时切换。
  - **唯一生效**: 支持多版本报价（v1/v2/v3），但同一线索下时刻保持**唯一一份** Active 报价单。
  - **一键生成**: 支持从线索详情页 "一键生成草稿"，自动带入客户信息。
  - **自动回写**: 编辑报价单客户信息时，自动同步更新线索/客户档案。
  - **状态独立**: 报价单失败不关闭线索，仅成交 (Won) 触发线索成交。

### [Order] 订单创建规则

- **来源**: 必须由报价单 (`Quote`) 转化而来，禁止手动直接创建主订单。
- **状态要求**: 关联报价单必须为 `WON` (成交) 状态。
- **转化模式**: **严格模式 (Strict)**
  - 订单金额、商品明细完全继承自报价单，**不可修改**。
  - 若需调整，必须走 "变更申请 (Change Order)" 流程。
- **拆单逻辑**: **1:1 转化**
  - 1 个报价单 = 1 个主订单。
  - 此阶段不按品类拆分，但在发货和采购阶段会按供应商拆分。

### [Order] 采购与状态联动

- **来源**: 用户需求
- **状态**: 已更新 `docs/requirements/modules/订单.md`
- **内容**:
  - **采购拆单**: 支持“默认供应商自动匹配”与人工调整。
  - **全链路状态**: 待下单 -> 生产中 -> 待发货 (备货完) -> 发货中 (填单号) -> 待安装 (到货)。

### [Install] 安装与派单

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/modules/安装单.md`
- **内容**:
  - **独立单据**: 订单到货后生成安装单。
  - **状态流转**: 待分配 -> 分配中 (待接单) -> 待上门 -> 待确认 (验收) -> 完成。
  - **联动**: 安装完成触发订单完成。

### [Finance] 对账与结算

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/modules/对账单.md`
- **内容**:
  - **聚合**: 多订单 -> 一对账单 (1:N)。
  - **状态**: 待开票 -> 待回款 -> 完成。
  - **闭环**: 对账完成触发订单最终关闭 (Closed)。

### [Lead] 线索状态定义

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/modules/线索.md`
- **内容**:
  - **状态机**: 待分配 -> 待跟踪 -> 跟踪中 -> 已成交 / 作废。
  - **规则**: 明确了“待分配”属于公海池概念。
  - **自动化标签**: “已报价”和“已到店”标签由系统动作触发，记录时间戳。

### [Supply Chain] 供应商与采购对账

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/modules/供应链.md`, 更新 `对账单.md`
- **内容**:
  - **自动路由**: 商品绑定默认供应商，订单自动拆分为对应 PO。
  - **人工干预**: 明确支持在系统自动拆单后，人工手动调整供应商 (Override)。
  - **PO 详情**: 增加金额、物流、发送方式字段。
  - **AP 对账**: 状态流也明确为 待开票 -> 待付款 -> 完成。
  - **导出**: 全局支持 CSV/PDF。

### [Global] 状态流转防呆设计

- **来源**: 用户需求
- **状态**: 已更新 `安装单.md`, `对账单.md`, `订单.md`
- **内容**: **数据驱动状态 (Proof of Work)**。禁止单纯的“点击变状态”，必须通过核心业务动作驱动：
  - Install: 上传照片 -> 待确认。
  - Finance: 上传发票 -> 待付款。
  - Order: 全链路数据驱动 (Items拆单完->生产中; PO备货完->待发货; 销售申请->发货中; 填单号->已发货; 安装完->完成)。
  - **Dispatch**: 明确“派单”动作必须是选择具体的安装师傅。
  - **Measure**: 任务细化为 待分配 -> 分配中(待接单) -> 待上门 -> 待确认 -> 完成。
  - **Credentials**: 转订单需客户截图，转PO需供应商截图。

### [Purchase Order] 采购单独立模块化

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/modules/采购单.md`
- **内容**:
  - **独立性**: 从“订单”和“供应链”中剥离，独立管理。
  - **全生命周期**: 草稿 -> 生产中(凭证) -> 备货完成 -> 已发货(单号) -> 已到货。
  - **全生命周期**: 草稿 -> 生产中(凭证) -> 备货完成 -> 已发货(单号) -> 已到货。
  - **联动**: 向上驱动订单状态，向下生成财务对账。

### [Inventory] 标品与库存管理

- **来源**: 用户需求
- **状态**: 已更新 `供应链.md`, `采购单.md`
- **内容**:
  - **标品识别**: 商品增加 `is_stockable` 属性。
  - **内部路由**: 标品不走外部供应商，而是生成指向“自有仓库”的内部备货单。
  - **库存**: 包含简单的库存数量管理 (预占/扣减)。

### [Relation] 测量与报价的关系梳理

- **核心逻辑**: **多层级比价**
  - **第一层 (物理方案)**: 1 测量任务 -> N 测量方案 (Variant A-顶装 / B-侧装)。
  - **第二层 (选品方案)**: 1 测量方案 -> N 报价单 (Quote A1-贵 / A2-便宜)。
  - **灵活性**: 完美支持“同尺寸不同选品”的常见比价场景。
  - **生效**: 最终只能选择其一设为 `Active`，锁定方案与报价。

### [Relation] 订单与采购单的关系梳理

- **结构关系**: **1 (Order) : N (Purchase Orders)**
  - **拆分逻辑**: 系统根据商品的 `default_supplier_id` 或 `is_stockable` 属性自动拆分。
  - **场景**: 一个订单可能拆分为 [PO1-厂家A], [PO2-厂家B], [PO3-仓库领料]。
- **状态联动**: **自下而上不可逆驱动 (Bottom-Up Aggregation)**
  - **木桶效应**: 只有 **所有** 关联的 PO 都进入“备货完成”，订单才会变为“待发货”。
  - **单点阻碍**: 只要有一个 PO 卡在“生产中”，整个订单就不能发货（除非人工强制拆单发货）。

### [Relation] 订单与安装单的关系梳理

- **结构关系**: **1 (Order) : N (Install Tasks)**
  - **拆分逻辑**: 基于 **工种/品类 (Skillset)** 或 **到货时间**。
  - **场景**: [安装单A-窗帘 (师傅王)], [安装单B-墙布 (师傅李)]。
- **时间/触发关系**: **分批接力**
  - **启动**: 订单待安装时，可生成多张安装单。
  - **终结**: **木桶效应**，只有所有安装单都 `COMPLETED`，订单才 `COMPLETED`。

### [Relation] 线索与测量单的关系梳理

- **结构关系**: **1 (Lead) : N (Measure Tasks)**
  - **场景**: 分工种测量（窗帘/墙布）或 分批次测量。
  - **Dispatch**: 明确“派单”动作必须是选择具体的安装师傅。
  - **Dispatch**: 明确“派单”动作必须是选择具体的安装师傅。
  - **Measure**: 任务细化为 待分配 -> 分配中(待接单) -> 待上门 -> 待确认 -> 完成。

### [Supply Chain] 供应商与采购对账全局导出能力

- **来源**: 用户需求
- **状态**: 已更新 `docs/架构设计.md`
- **内容**:
  - **格式**: 支持 CSV 和 PDF。
  - **架构**: Shared 层提供工具/组件，Feature 层定义数据逻辑 (FSD模式)。
  - **覆盖**: 所有核心模块列表页及详情页。

### [System] 全局搜索与筛选

- **来源**: 用户需求
- **状态**: 已更新 `docs/requirements/modules/系统基础.md`
- **内容**:
  - **Global Filter**: 模块上下文感知的通用筛选器 (时间/状态/人员)。
  - **Global Search**: `Ctrl+K` 唤起，支持跨模块 (Leads/Orders/Tasks) 的聚合搜索。

### [Finance] 四项对账闭环

- **来源**: 用户反馈
- **状态**: 已更新 `docs/requirements/modules/对账单.md`
- **内容**:
  - **AR**: 客户收款。
  - **AP-Supplier**: 供应商采购付款。
  - **AP-Worker**: 测量师/安装师 劳务提成结算。
  - **Objects**: 明确财务模块需管理 客户、供应商、工人 三类结算对象。

### [Analytics] 可配置数据仪表盘

- **来源**: 用户需求
- **状态**: 已建立 `docs/requirements/modules/数据报表.md`
- **内容**:
  - **Widget Library**: 销售漏斗、财务AR/AP、交付效率等预置组件。
  - **Customizable**: 支持用户拖拽布局、隐藏组件、设置独立筛选参数。
  - **Metrics**: 覆盖 销售、财务、运营 三大维度。

### [System] 登录与UI风格

- **来源**: 用户需求
- **状态**: 已更新 `docs/requirements/modules/系统基础.md`
- **内容**:
  - **Auth**: 引入 **Auth.js** 解决 飞书/微信/手机验证码 登录。
  - **UI**: 引入 **Aceternity UI** + `next-themes` 实现多风格切换 (Themes)。

### [UI/UX] Liquid Glass 主题标准化 (快速上线策略)

- **来源**: 战略调整 (2026-01-03)
- **状态**: P0 (High Priority)
- **内容**:
  - **单一风格**: 暂时放弃多主题切换 (No more Parchment/Pro Max switch)，全力打磨 **Liquid Glass** (Light/Dark) 作为全站唯一默认风格。
  - **性能优先**: 解决因高斯模糊/饱和度导致的渲染卡顿，确保低端设备流畅运行。
  - **Dark Mode**: 锁定 **Deep Space Neon** 设计，作为暗黑模式的标准实现。
  - **目标**: 快速落地 (Quick Launch)，减少非核心 UI 维护成本。

## 2026-01-07

### [Verification] 租户隔离测试原则

- **来源**: 用户指令
- **状态**: 执行中
- **内容**:
  - **隔离原则**: 在正式部署 (Production Deployment) 之前，所有的模拟测试、数据播种、流程演练必须在 **测试租户 (TEST001)** 中进行。
  - **数据安全**: 严禁在生产环境或 DEMO 环境进行破坏性测试或大量灌水。
  - **验证标准**: 新功能必须在测试租户通过全流程闭环验证后，方可发布上线。

### [Measurement] 测量单信息同步

- **来源**: 用户需求
- **状态**: 已实现
- **内容**:
  - **下行信息（销售→测量师）**:
    - 纯线索场景：客户信息全集（电话、地址、称呼）、预计上门时间、测量备注、附件
    - 有方案场景：空间信息、预计尺寸、安装方式（隐藏价格/金额/产品型号）
  - **上行信息（测量师→销售）**:
    - 确认/修改原有方案尺寸
    - 同一空间新增多个安装方案
    - 多媒体附件上传（视频/图片/语音/文字）
  - **实现方式**: 扩展 `measureTasks` 表新增 `salesBrief`、`linkedQuoteId`、`attachments` 字段
    \n\n### [Onboarding] 新租户初始化问卷与系统配置\n- **来源**: 用户需求\n- **状态**: 待实现\n- **内容**: 新租户审批通过后，首次登录系统要求填写1~3个初始化调研问题（例如团队规模、协作模式、分工派单、专职采购等）。根据问卷结果自动应用预设的配置模版（包含角色权限划分、审核流程配置、部分业务节点的必填项及流转限制），以实现一键
    装配系统并提升初次体验。\n- **核心模版**: \n - 1人：极简战神模式\n - 2~5人：小微协作模式（支持内外勤分工等细分）\n - 6人及以上：标准企业模式（带完整的分层及组织架构审核）\n
