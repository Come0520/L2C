# 师傅身份统一数据迁移方案

## 概述

本文档描述了将测量师和安装师统一为"师傅"角色的数据迁移方案，采用**方案B（保留角色区分，但允许双重身份）**。

## 迁移目标

1. 在 `users` 表中新增 `worker_type` 字段
2. 根据现有角色设置 `worker_type` 值
3. 识别兼任两种角色的用户
4. 初始化技能标签数据（可选）

## 数据结构变更

### 1. users 表新增字段

```sql
ALTER TABLE users ADD COLUMN worker_type worker_type;

-- worker_type 枚举类型定义
CREATE TYPE worker_type AS ENUM ('MEASURER', 'INSTALLER', 'BOTH');
```

### 2. worker_skills 表（可选扩展）

```sql
CREATE TABLE worker_skills (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  worker_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  skill_tag VARCHAR(50) NOT NULL,
  is_primary BOOLEAN DEFAULT false,
  certified_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_worker_skills_worker_id ON worker_skills(worker_id);
CREATE INDEX idx_worker_skills_skill_tag ON worker_skills(skill_tag);
```

### 3. worker_standard_prices 表（新增）

```sql
CREATE TABLE worker_standard_prices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  worker_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  skill_tag VARCHAR(50) NOT NULL,
  standard_price DECIMAL(10, 2) NOT NULL,
  unit VARCHAR(20) NOT NULL,
  effective_date DATE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_worker_standard_prices_worker_id ON worker_standard_prices(worker_id);
CREATE INDEX idx_worker_standard_prices_effective_date ON worker_standard_prices(effective_date DESC);
```

## 迁移步骤

### 阶段1：添加字段

```sql
-- 步骤1：添加 worker_type 字段
ALTER TABLE users ADD COLUMN worker_type worker_type;

-- 步骤2：添加 skills 字段（JSONB类型，用于存储技能标签）
ALTER TABLE users ADD COLUMN skills JSONB;
```

### 阶段2：设置 worker_type

```sql
-- 步骤1：根据角色ID设置 worker_type
-- 假设：角色ID 1 = 测量师，角色ID 2 = 安装师
UPDATE users
SET worker_type = 'MEASURER'
WHERE role_id = 1;

UPDATE users
SET worker_type = 'INSTALLER'
WHERE role_id = 2;

-- 步骤2：其他角色设置为 null
UPDATE users
SET worker_type = NULL
WHERE role_id NOT IN (1, 2);
```

### 阶段3：识别兼任两种角色的用户

```sql
-- 查找同时创建了测量单和安装单的用户
WITH dual_role_users AS (
  SELECT DISTINCT u.id, u.name, u.worker_type
  FROM users u
  WHERE u.id IN (
    SELECT DISTINCT worker_id FROM measure_tasks
  )
  AND u.id IN (
    SELECT DISTINCT worker_id FROM install_tasks
  )
)
UPDATE users
SET worker_type = 'BOTH'
WHERE id IN (SELECT id FROM dual_role_users);
```

### 阶段4：初始化技能标签（可选）

```sql
-- 为测量师初始化技能标签
UPDATE users
SET skills = jsonb_build_object(
  'skills', jsonb_build_array(
    jsonb_build_object(
      'tag', 'CURTAIN_MEASURE',
      'is_primary', true,
      'certified_at', created_at
    )
  )
)
WHERE worker_type = 'MEASURER';

-- 为安装师初始化技能标签
UPDATE users
SET skills = jsonb_build_object(
  'skills', jsonb_build_array(
    jsonb_build_object(
      'tag', 'CURTAIN_INSTALL',
      'is_primary', true,
      'certified_at', created_at
    )
  )
)
WHERE worker_type = 'INSTALLER';

-- 为全能师傅初始化技能标签
UPDATE users
SET skills = jsonb_build_object(
  'skills', jsonb_build_array(
    jsonb_build_object(
      'tag', 'CURTAIN_MEASURE',
      'is_primary', true,
      'certified_at', created_at
    ),
    jsonb_build_object(
      'tag', 'CURTAIN_INSTALL',
      'is_primary', false,
      'certified_at', created_at
    )
  )
)
WHERE worker_type = 'BOTH';
```

## 迁移验证

### 验证1：检查字段是否添加成功

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'users'
AND column_name IN ('worker_type', 'skills');
```

### 验证2：检查 worker_type 分布

```sql
SELECT worker_type, COUNT(*) as count
FROM users
GROUP BY worker_type
ORDER BY worker_type;
```

### 验证3：检查兼任两种角色的用户

```sql
SELECT id, name, worker_type
FROM users
WHERE worker_type = 'BOTH';
```

### 验证4：检查技能标签数据

```sql
SELECT id, name, worker_type, skills
FROM users
WHERE worker_type IS NOT NULL
LIMIT 10;
```

## 回滚方案

如果迁移出现问题，可以执行以下回滚操作：

```sql
-- 步骤1：删除新增字段
ALTER TABLE users DROP COLUMN IF EXISTS skills;
ALTER TABLE users DROP COLUMN IF EXISTS worker_type;

-- 步骤2：删除新增表
DROP TABLE IF EXISTS worker_standard_prices;
DROP TABLE IF EXISTS worker_skills;

-- 步骤3：删除枚举类型
DROP TYPE IF EXISTS worker_type;
```

## 注意事项

1. **备份**：迁移前务必备份数据库
2. **测试**：先在测试环境执行迁移，验证无误后再在生产环境执行
3. **停机**：建议在业务低峰期执行迁移，避免影响用户使用
4. **监控**：迁移完成后，密切监控系统运行情况
5. **日志**：记录迁移过程中的所有操作，便于问题排查

## 后续优化

### 1. 性能优化

```sql
-- 为 worker_type 字段创建索引
CREATE INDEX idx_users_worker_type ON users(worker_type);

-- 为 skills 字段创建 GIN 索引（用于 JSONB 查询）
CREATE INDEX idx_users_skills ON users USING GIN (skills);
```

### 2. 数据清理

```sql
-- 清理无效的技能标签数据
UPDATE users
SET skills = NULL
WHERE worker_type IS NULL;
```

### 3. 数据校验

```sql
-- 校验 worker_type 与 skills 的一致性
SELECT id, name, worker_type, skills
FROM users
WHERE worker_type IS NOT NULL
AND (skills IS NULL OR jsonb_array_length(skills->'skills') = 0);
```

## 附录：TypeScript 类型定义

```typescript
// 师傅类型枚举
export enum WorkerType {
  MEASURER = 'MEASURER',
  INSTALLER = 'INSTALLER',
  BOTH = 'BOTH',
}

// 技能标签类型
export interface WorkerSkill {
  tag: string; // 技能标签：CURTAIN_MEASURE, WALLCLOTH_INSTALL...
  is_primary: boolean; // 是否为主要技能
  certified_at: string; // 认证时间
}

// 用户类型扩展
export interface User {
  id: string;
  name: string;
  role_id: number;
  worker_type: WorkerType | null;
  skills: {
    skills: WorkerSkill[];
  } | null;
  created_at: string;
  updated_at: string;
}
```

## 迁移时间估算

| 阶段     | 操作             | 预计时间   |
| :------- | :--------------- | ---------- |
| 阶段1    | 添加字段         | 5分钟      |
| 阶段2    | 设置 worker_type | 10分钟     |
| 阶段3    | 识别兼任用户     | 5分钟      |
| 阶段4    | 初始化技能标签   | 10分钟     |
| 验证     | 数据验证         | 15分钟     |
| **总计** | -                | **45分钟** |

## 联系人

如有疑问，请联系：

- 技术负责人：[姓名]
- 产品负责人：[姓名]
- 数据库管理员：[姓名]
