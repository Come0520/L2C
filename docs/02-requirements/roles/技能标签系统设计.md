# 技能标签系统设计

## 概述

本文档描述了师傅技能标签系统的设计方案，采用**混合分类 + 父子标签**（方案D）。

## 核心设计

### 标签层级结构

技能标签采用**父子层级结构**，支持灵活的技能组合和精准的派单匹配。

```
┌─────────────────────────────────────────────────────────┐
│ 技能标签树                                          │
├─────────────────────────────────────────────────────────┤
│                                                     │
│ ├── MEASURE（测量 - 父标签）                         │
│ │   ├── CURTAIN（窗帘）                            │
│ │   │   └── MEASURE.CURTAIN（窗帘测量）             │
│ │   ├── WALLCLOTH（墙布）                          │
│ │   │   └── MEASURE.WALLCLOTH（墙布测量）           │
│ │   ├── WALLPAPER（墙纸）                          │
│ │   │   └── MEASURE.WALLPAPER（墙纸测量）           │
│ │   └── WALLKICK（墙咔）                           │
│ │       └── MEASURE.WALLKICK（墙咔测量）             │
│                                                     │
│ ├── INSTALL（安装 - 父标签）                          │
│ │   ├── CURTAIN（窗帘）                            │
│ │   │   └── INSTALL.CURTAIN（窗帘安装）              │
│ │   ├── WALLCLOTH（墙布）                          │
│ │   │   └── INSTALL.WALLCLOTH（墙布安装）           │
│ │   ├── WALLPAPER（墙纸）                          │
│ │   │   └── INSTALL.WALLPAPER（墙纸安装）           │
│ │   └── WALLKICK（墙咔）                           │
│ │       └── INSTALL.WALLKICK（墙咔安装）             │
│                                                     │
│ ├── REPAIR（维修 - 父标签）                          │
│ │   └── REPAIR（维修）                              │
│                                                     │
│ └── CLEAN（清洗 - 父标签）                          │
│     └── CLEAN（清洗）                                │
│                                                     │
└─────────────────────────────────────────────────────────┘
```

### 标签编码规则

```
标签编码 = {父标签}.{子标签}
```

| 父标签 | 子标签 | 完整编码 | 说明 |
|:---|:---|:---|---|
| MEASURE | CURTAIN | `MEASURE.CURTAIN` | 窗帘测量 |
| MEASURE | WALLCLOTH | `MEASURE.WALLCLOTH` | 墙布测量 |
| MEASURE | WALLPAPER | `MEASURE.WALLPAPER` | 墙纸测量 |
| INSTALL | CURTAIN | `INSTALL.CURTAIN` | 窗帘安装 |
| INSTALL | WALLCLOTH | `INSTALL.WALLCLOTH` | 墙布安装 |
| INSTALL | WALLPAPER | `INSTALL.WALLPAPER` | 墙纸安装 |
| REPAIR | - | `REPAIR` | 维修 |
| CLEAN | - | `CLEAN` | 清洗 |

## 数据结构设计

### 1. 技能标签表（skill_tags）

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|---|
| id | UUID | ✓ | 主键 |
| code | String(50) | ✓ | 标签编码（如：MEASURE.CURTAIN） |
| name | String(50) | ✓ | 标签名称（如：窗帘测量） |
| description | Text | - | 标签描述 |
| parent_id | UUID | - | 父标签ID |
| level | Integer | ✓ | 层级（1=父标签，2=子标签） |
| category | String(20) | - | 品类（CURTAIN/WALLCLOTH/WALLPAPER） |
| skill_type | String(20) | - | 技能类型（MEASURE/INSTALL/REPAIR/CLEAN） |
| is_active | Boolean | ✓ | 是否启用 |
| is_system | Boolean | ✓ | 是否为系统预设标签 |
| sort_order | Integer | - | 排序 |
| created_at | DateTime | ✓ | 创建时间 |
| updated_at | DateTime | ✓ | 更新时间 |

### 2. 用户技能表（user_skills）

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|---|
| id | UUID | ✓ | 主键 |
| user_id | UUID | ✓ | 用户ID |
| skill_tag_id | UUID | ✓ | 技能标签ID |
| is_primary | Boolean | ✓ | 是否为主要技能 |
| proficiency_level | Integer | - | 熟练度（1-5星） |
| certified_at | DateTime | - | 认证时间 |
| created_at | DateTime | ✓ | 创建时间 |
| updated_at | DateTime | ✓ | 更新时间 |

### 3. 师傅标准价表（worker_standard_prices）

| 字段名 | 类型 | 必填 | 说明 |
|:---|:---|:---|---|
| id | UUID | ✓ | 主键 |
| user_id | UUID | ✓ | 用户ID |
| skill_tag_id | UUID | ✓ | 技能标签ID |
| standard_price | Decimal(10,2) | ✓ | 标准单价 |
| unit | String(20) | ✓ | 计价单位（元/次、元/米、元/平米） |
| effective_date | Date | ✓ | 生效日期 |
| expiry_date | Date | - | 失效日期（可选） |
| created_at | DateTime | ✓ | 创建时间 |
| updated_at | DateTime | ✓ | 更新时间 |

## 预设标签库

### 第一阶段：MVP标签

| 编码 | 名称 | 父标签 | 层级 | 品类 | 技能类型 |
|:---|:---|:---|:---|:---|---|
| `MEASURE` | 测量 | null | 1 | null | MEASURE |
| `INSTALL` | 安装 | null | 1 | null | INSTALL |
| `MEASURE.CURTAIN` | 窗帘测量 | MEASURE | 2 | CURTAIN | MEASURE |
| `MEASURE.WALLCLOTH` | 墙布测量 | MEASURE | 2 | WALLCLOTH | MEASURE |
| `MEASURE.WALLPAPER` | 墙纸测量 | MEASURE | 2 | WALLPAPER | MEASURE |
| `INSTALL.CURTAIN` | 窗帘安装 | INSTALL | 2 | CURTAIN | INSTALL |
| `INSTALL.WALLCLOTH` | 墙布安装 | INSTALL | 2 | WALLCLOTH | INSTALL |
| `INSTALL.WALLPAPER` | 墙纸安装 | INSTALL | 2 | WALLPAPER | INSTALL |

### 第二阶段：扩展标签

| 编码 | 名称 | 父标签 | 层级 | 品类 | 技能类型 |
|:---|:---|:---|:---|:---|---|
| `REPAIR` | 维修 | null | 1 | null | REPAIR |
| `CLEAN` | 清洗 | null | 1 | null | CLEAN |
| `MEASURE.WALLKICK` | 墙咔测量 | MEASURE | 2 | WALLKICK | MEASURE |
| `MEASURE.BAYWINDOW` | 飘窗垫测量 | MEASURE | 2 | BAYWINDOW | MEASURE |
| `INSTALL.WALLKICK` | 墙咔安装 | INSTALL | 2 | WALLKICK | INSTALL |
| `INSTALL.BAYWINDOW` | 飘窗垫安装 | INSTALL | 2 | BAYWINDOW | INSTALL |

## 派单逻辑

### 1. 检查师傅是否可以接任务

```typescript
async function canAssignTask(workerId: string, taskType: string, category: string): Promise<boolean> {
  const worker = await db.query.users.findFirst({
    where: eq(users.id, workerId),
    with: {
      skills: {
        with: {
          skillTag: true
        }
      }
    }
  });
  
  // 构造技能标签编码
  const skillTagCode = `${taskType}.${category}`;
  
  // 检查师傅是否具备该技能
  const hasSkill = worker.skills?.some(skill => 
    skill.skillTag.code === skillTagCode
  );
  
  return hasSkill;
}
```

### 2. 获取可用师傅列表

```typescript
async function getAvailableWorkers(taskType: string, category: string): Promise<Worker[]> {
  const skillTagCode = `${taskType}.${category}`;
  
  // 获取具备该技能的师傅
  const workers = await db.query.users.findMany({
    where: and(
      isNotNull(users.worker_type),
      eq(users.is_active, true)
    ),
    with: {
      skills: {
        with: {
          skillTag: true
        }
      },
      standardPrices: {
        where: and(
          eq(workerStandardPrices.skill_tag_id, sql`${skillTags.id}`),
          lte(workerStandardPrices.effective_date, new Date()),
          or(
            isNull(workerStandardPrices.expiry_date),
            gt(workerStandardPrices.expiry_date, new Date())
          )
        )
      }
    }
  });
  
  // 过滤具备该技能的师傅
  return workers.filter(worker => 
    worker.skills?.some(skill => 
      skill.skillTag.code === skillTagCode
    )
  );
}
```

### 3. 智能派单算法

```typescript
async function smartDispatch(taskType: string, category: string, quantity: number): Promise<DispatchPlan> {
  // 获取可用师傅
  const availableWorkers = await getAvailableWorkers(taskType, category);
  
  // 计算所有可能的派单方案
  const plans: DispatchPlan[] = [];
  
  // 方案1：一个师傅完成所有任务
  for (const worker of availableWorkers) {
    const cost = await calculateDispatchCost(taskType, category, [worker.id]);
    plans.push({
      type: 'SINGLE_WORKER',
      workers: [worker],
      cost: cost,
      workerCount: 1
    });
  }
  
  // 方案2：多个师傅分别完成不同品类任务
  if (availableWorkers.length >= 2) {
    for (let i = 0; i < availableWorkers.length; i++) {
      for (let j = i + 1; j < availableWorkers.length; j++) {
        const cost = await calculateDispatchCost(taskType, category, [
          availableWorkers[i].id,
          availableWorkers[j].id
        ]);
        plans.push({
          type: 'MULTIPLE_WORKERS',
          workers: [availableWorkers[i], availableWorkers[j]],
          cost: cost,
          workerCount: 2
        });
      }
    }
  }
  
  // 按成本排序
  plans.sort((a, b) => a.cost - b.cost);
  
  // 按师傅评分排序（成本相同时）
  plans.forEach(plan => {
    const avgScore = plan.workers.reduce((sum, worker) => sum + worker.rating, 0) / plan.workers.length;
    plan.avgScore = avgScore;
  });
  
  plans.sort((a, b) => {
    if (a.cost !== b.cost) {
      return a.cost - b.cost;
    }
    return b.avgScore - a.avgScore;
  });
  
  // 返回最优方案
  return plans[0];
}
```

## 管理界面设计

### 1. 技能标签管理页面

```
┌─────────────────────────────────────────────────────┐
│ 技能标签管理                         [新增标签]   │
├─────────────────────────────────────────────────────┤
│ 标签树形结构：                                   │
│                                                     │
│ ┌─ MEASURE（测量）                          │
│ │  ├─ CURTAIN（窗帘）                       │
│ │  │  └─ MEASURE.CURTAIN（窗帘测量）           │
│ │  ├─ WALLCLOTH（墙布）                     │
│ │  │  └─ MEASURE.WALLCLOTH（墙布测量）        │
│ │  └─ WALLPAPER（墙纸）                     │
│ │     └─ MEASURE.WALLPAPER（墙纸测量）         │
│                                                     │
│ ┌─ INSTALL（安装）                          │
│ │  ├─ CURTAIN（窗帘）                       │
│ │  │  └─ INSTALL.CURTAIN（窗帘安装）           │
│ │  ├─ WALLCLOTH（墙布）                     │
│ │  │  └─ INSTALL.WALLCLOTH（墙布安装）        │
│ │  └─ WALLPAPER（墙纸）                     │
│ │     └─ INSTALL.WALLPAPER（墙纸安装）         │
│                                                     │
│ ┌─ REPAIR（维修）                            │
│ └─ CLEAN（清洗）                             │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 2. 师傅技能管理页面

```
┌─────────────────────────────────────────────────────┐
│ 师傅技能管理                                     │
├─────────────────────────────────────────────────────┤
│ 师傅：张师傅                                     │
│                                                     │
│ 已具备技能：                                       │
│ ✓ 窗帘测量（主要技能）  [编辑]  [删除]        │
│ ✓ 墙布测量              [编辑]  [删除]        │
│ ✓ 窗帘安装              [编辑]  [删除]        │
│                                                     │
│ 添加技能：                                         │
│ [选择技能 ▼]  [是否主要技能 □]  [添加]      │
│                                                     │
│ 熟练度评分：                                       │
│ ⭐⭐⭐⭐☆（4星）                             │
│                                                     │
│ 认证时间：2026-01-01                            │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 3. 师傅标准价管理页面

```
┌─────────────────────────────────────────────────────┐
│ 师傅标准价管理                                   │
├─────────────────────────────────────────────────────┤
│ 师傅：张师傅                                     │
│                                                     │
│ 标准价列表：                                       │
│                                                     │
│ ┌─────────────────────────────────────────────┐      │
│ │ 技能标签          │ 标准价  │ 单位   │ 操作│      │
│ ├─────────────────────────────────────────────┤      │
│ │ 窗帘测量        │ 100元  │ 元/次  │ 编辑│      │
│ │ 墙布测量        │ 120元  │ 元/次  │ 编辑│      │
│ │ 窗帘安装        │ 150元  │ 元/次  │ 编辑│      │
│ │ 墙布安装        │ 180元  │ 元/次  │ 编辑│      │
│ └─────────────────────────────────────────────┘      │
│                                                     │
│ [新增标准价]                                       │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 数据初始化

### 1. 初始化技能标签

```sql
-- 插入父标签
INSERT INTO skill_tags (id, code, name, parent_id, level, skill_type, is_system) VALUES
  ('1', 'MEASURE', '测量', NULL, 1, 'MEASURE', true),
  ('2', 'INSTALL', '安装', NULL, 1, 'INSTALL', true),
  ('3', 'REPAIR', '维修', NULL, 1, 'REPAIR', true),
  ('4', 'CLEAN', '清洗', NULL, 1, 'CLEAN', true);

-- 插入子标签
INSERT INTO skill_tags (id, code, name, parent_id, level, category, skill_type, is_system) VALUES
  ('5', 'MEASURE.CURTAIN', '窗帘测量', '1', 2, 'CURTAIN', 'MEASURE', true),
  ('6', 'MEASURE.WALLCLOTH', '墙布测量', '1', 2, 'WALLCLOTH', 'MEASURE', true),
  ('7', 'MEASURE.WALLPAPER', '墙纸测量', '1', 2, 'WALLPAPER', 'MEASURE', true),
  ('8', 'INSTALL.CURTAIN', '窗帘安装', '2', 2, 'CURTAIN', 'INSTALL', true),
  ('9', 'INSTALL.WALLCLOTH', '墙布安装', '2', 2, 'WALLCLOTH', 'INSTALL', true),
  ('10', 'INSTALL.WALLPAPER', '墙纸安装', '2', 2, 'WALLPAPER', 'INSTALL', true);
```

### 2. 初始化师傅技能

```sql
-- 为张师傅添加技能
INSERT INTO user_skills (user_id, skill_tag_id, is_primary, certified_at) VALUES
  ('张师傅ID', '5', true, NOW()),  -- 窗帘测量（主要技能）
  ('张师傅ID', '6', false, NOW()), -- 墙布测量
  ('张师傅ID', '8', false, NOW()); -- 窗帘安装
```

### 3. 初始化师傅标准价

```sql
-- 为张师傅设置标准价
INSERT INTO worker_standard_prices (user_id, skill_tag_id, standard_price, unit, effective_date) VALUES
  ('张师傅ID', '5', 100.00, '元/次', '2026-01-01'),  -- 窗帘测量
  ('张师傅ID', '6', 120.00, '元/次', '2026-01-01'), -- 墙布测量
  ('张师傅ID', '8', 150.00, '元/次', '2026-01-01'); -- 窗帘安装
```

## 扩展性设计

### 1. 支持自定义标签

租户可以自定义技能标签：

```typescript
// 创建自定义标签
async function createCustomSkillTag(tenantId: string, code: string, name: string, parentId: string) {
  return await db.insert(skillTags).values({
    id: generateUUID(),
    code: code,
    name: name,
    parent_id: parentId,
    level: 2,
    is_system: false,
    tenant_id: tenantId  // 租户隔离
  });
}
```

### 2. 支持标签层级扩展

可以支持3层或更多层级：

```
┌── MEASURE（测量）
│   ├── CURTAIN（窗帘）
│   │   ├── MEASURE.CURTAIN.BASIC（基础测量）
│   │   └── MEASURE.CURTAIN.ADVANCED（高级测量）
│   └── WALLCLOTH（墙布）
│       └── MEASURE.WALLCLOTH.BASIC（基础测量）
```

### 3. 支持技能有效期

```typescript
// 检查技能是否过期
async function isSkillExpired(userSkillId: string): Promise<boolean> {
  const userSkill = await db.query.userSkills.findFirst({
    where: eq(userSkills.id, userSkillId)
  });
  
  if (!userSkill.expiry_date) {
    return false;
  }
  
  return userSkill.expiry_date < new Date();
}
```

## 注意事项

1. **标签唯一性**：标签编码必须全局唯一
2. **层级一致性**：子标签的 `parent_id` 必须指向父标签
3. **循环引用**：禁止创建循环引用的标签关系
4. **数据隔离**：自定义标签需要按租户隔离
5. **性能优化**：为常用查询字段创建索引

## 联系人

如有疑问，请联系：
- 技术负责人：[姓名]
- 产品负责人：[姓名]
- 数据库管理员：[姓名]
