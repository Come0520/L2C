# 订单-采购-履约流程 (Order to Fulfillment)

## 1. 概述
本流程描述从“报价单转化订单”开始，经过“自动拆单”，直到“工厂生产完成”的全过程。核心在于**自动化**与**木桶效应**的控制。

## 2. 流程图 (Flowchart)

```mermaid
graph TD
    A[Quote (Active)] -->|客户确认凭证| B(Order Created)
    B --> C{拆单引擎}
    C -->|定制品: 默认供应商| D[PO-1: 厂家A]
    C -->|定制品: 默认供应商| E[PO-2: 厂家B]
    C -->|标品: 库存检测| F[PO-3: 内部领料单]
    
    D --> D1{采购确认}
    D1 -->|上传厂家报价| D2[PO: IN_PRODUCTION]
    
    E --> E1{采购确认}
    E1 -->|上传厂家报价| E2[PO: IN_PRODUCTION]
    
    F --> F1{库管确认}
    F1 -->|确认预占| F2[PO: READY]
    
    D2 --> D3[工厂生产] -->|备货完成| D4[PO: READY]
    E2 --> E3[工厂生产] -->|备货完成| E4[PO: READY]
    
    D2 & E2 & F2 -.->|Any PO In Production| G[Order: IN_PRODUCTION]
    D4 & E4 & F2 -->|All POs Ready| H[Order: PENDING_DELIVERY]
```

## 3. 关键节点说明

### 3.1 订单创建 (Order Creation)
*   **前置**: 报价单必须 Active。
*   **动作**: 销售上传“客户转账/确认截图”。
*   **产物**: 生成 `orders` 记录，状态 `PENDING_PO`。

### 3.2 智能拆单 (Auto-Split)
*   **触发**: 订单创建后立即触发。
*   **逻辑**: 遍历 `order_items`。
    *   若 `product.is_stockable = true` -> 归入 **内部领料单**。
    *   否则 -> 按 `product.default_supplier_id` 归入对应 **采购单**。
*   **人工干预**: 客服在“待下单”状态下可手动调整 Item 的归属 PO。

### 3.3 生产启动 (Production Start)
*   **角色**: 采购员。
*   **动作**: 与工厂核对，上传“厂家报价单/聊天截图”。
*   **变迁**: PO 状态 `DRAFT` -> `IN_PRODUCTION`。
*   **联动**: 只要有一个 PO 进入生产，母订单即视为 `IN_PRODUCTION`。

### 3.4 备货完成 (Ready)
*   **角色**: 采购员 / 库管。
*   **动作**: 确认工厂已完工（或库存已备好）。
*   **变迁**: PO 状态 -> `READY`。
*   **联动**: **木桶效应** —— 只有当**所有**关联 PO 都变更为 `READY` 时，母订单才自动变更为 `PENDING_DELIVERY`，通知销售可发货。
