# 高可用与性能设计 (High Availability & Performance Design)

## 1. 设计目标

基于 Next.js App Router 和 Supabase BaaS 架构，构建 **NoOps（无运维）**、**Edge-First（边缘优先）** 的高性能系统。核心策略是充分利用框架和平台（Vercel + Supabase）的原生能力，而非引入复杂的第三方中间件。

## 2. 缓存架构体系

采用多级缓存策略，减少数据库回源，降低延迟。

### 2.1 Next.js 四级缓存
| 层级 | 机制 | 生命周期 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **L1** | **Request Memoization** | 单次请求 | RSC 树中重复的 fetch 调用 |
| **L2** | **Data Cache** | 持久化 (直至 revalidate) | 跨用户共享的公共数据 (产品目录、配置) |
| **L3** | **Full Route Cache** | 构建/部署期 | 静态渲染的页面 (HTML/RSC Payload) |
| **L4** | **Router Cache** | 浏览器会话 | 客户端导航时的页面预加载 |

### 2.2 边缘分发 (CDN)
依托 **Vercel Edge Network** 实现全球分发：
*   **静态资源**: 构建产物自动设置 `Cache-Control: immutable`，推送到全球边缘节点。
*   **图片优化**: 使用 `<Image />` 组件配合 Vercel Image Optimization API，自动处理 WebP/AVIF 格式转换与懒加载。
*   **字体优化**: `next/font` 自动内联字体文件，消除 CLS。

### 2.3 缓存控制示例
```typescript
// app/api/products/route.ts
export async function GET() {
  const res = await fetch('https://api.supabase.co/.../products', {
    next: { 
      revalidate: 3600, // ISR: 1小时更新一次
      tags: ['products'] // 用于按需清除
    }
  });
  return Response.json(await res.json());
}
```

### 2.4 按需失效 (On-Demand Revalidation)
当管理员修改数据时，通过 Server Action 精确清除缓存：
```typescript
import { revalidateTag } from 'next/cache';

export async function updateProduct() {
  // ... update db ...
  revalidateTag('products'); // 立即刷新 L2/L3 缓存
}
```

## 3. 高可用与防护机制

### 3.1 边缘限流 (Rate Limiting)
在 Next.js Middleware 层拦截恶意请求，保护后端资源。
*   **工具**: `@upstash/ratelimit` + Vercel KV.
*   **策略**:
    *   **公共 API**: 60 req/min (IP Based).
    *   **Auth 接口**: 5 req/min (防暴力破解).
    *   **AI 接口**: 10 req/day (User Based).

```typescript
// middleware.ts
export async function middleware(req: NextRequest) {
  if (req.nextUrl.pathname.startsWith('/api/sensitive')) {
    const { success } = await ratelimit.limit(req.ip ?? '127.0.0.1');
    if (!success) return new NextResponse('Too Many Requests', { status: 429 });
  }
}
```

### 3.2 客户端降级 (Client-side Degradation)
*   **Suspense**: 利用 React Suspense 处理异步数据加载，展示骨架屏 (Skeleton) 而非白屏。
*   **Error Boundaries**: 捕获组件级错误，提供 "重试" 按钮，避免整个页面崩溃。
*   **Feature Flags**: 通过环境变量或 Supabase Config 表动态关闭故障模块（如 AI 服务挂起时隐藏入口）。

### 3.3 数据库保护
*   **查询超时**: 为所有 Supabase 客户端调用设置 `AbortSignal` (e.g., 5s 超时)。
*   **实时推送**: 使用 Supabase Realtime (WebSocket) 替代短轮询，减少数据库 QPS 压力。
*   **静态兜底**: 即使数据库完全不可用，ISR 缓存的静态页面仍可对外服务。

## 4. 监控体系

*   **Vercel Speed Insights**: 监控真实用户体验指标 (LCP, FID, CLS).
*   **Supabase Dashboard**: 监控数据库连接池、CPU 使用率及慢查询.
*   **Sentry**: 全栈异常捕获与堆栈追踪.
