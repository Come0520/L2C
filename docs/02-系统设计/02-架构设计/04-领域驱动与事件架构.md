# 领域驱动与事件架构设计 (DDD & Event Architecture)

## 1. 架构概览

本方案基于 **实用主义 DDD (Pragmatic DDD)** 和 **模块化单体** 理念，利用 Next.js + Supabase 的技术特性，摒弃了传统微服务架构中复杂的 EventBus、Saga 和分布式事务协调器。核心目标是通过数据库原生能力和框架特性，实现高内聚、低耦合的业务逻辑组织。

## 2. 读写分离 (Lightweight CQRS)

不再引入独立的 Command/Query Bus，而是利用 Next.js 架构特性实现天然的职责分离。

### 2.1 写模型 (Command Side)
*   **载体**: Server Actions (`app/actions/*.ts`)。
*   **职责**:
    1.  **验证**: Zod Schema 校验输入。
    2.  **授权**: Session/Role 检查。
    3.  **业务逻辑**: 调用领域函数或数据库存储过程。
    4.  **持久化**: Supabase Client (Service Role) 写入。
    5.  **反馈**: `revalidatePath` 刷新缓存。

### 2.2 读模型 (Query Side)
*   **载体**: Server Components (RSC) 或 Client Components。
*   **职责**: 直接从数据库读取数据，不经过繁琐的 Service 层封装。
*   **优化**: 使用 Materialized Views (物化视图) 处理复杂聚合查询。

## 3. 事件架构 (Event Architecture)

### 3.1 数据库即事件源 (Database as Event Source)
不显式抛出 `DomainEvent` 对象，而是将数据库变更视为事实上的领域事件。
*   **Webhooks**: 监听表变更 (Insert/Update/Delete)，触发 Edge Functions 处理副作用（如发送邮件、同步 CRM）。
*   **Realtime**: 前端通过 WebSocket 订阅 `postgres_changes`，实现 UI 即时响应。

### 3.2 审计日志 (Audit Trail)
作为轻量级的 "事件溯源" 替代方案，记录关键数据的全生命周期变更。
*   **实现**: 通用 Postgres Trigger + `audit_logs` 表。
*   **内容**: 记录 `who` (user_id), `when` (timestamp), `what` (operation), `old_value`, `new_value`。

```sql
create trigger audit_orders
after insert or update or delete on orders
for each row execute function audit_trigger_func();
```

## 4. 数据一致性与事务

### 4.1 强一致性 (ACID)
利用 Postgres 本地事务保证核心业务（如订单创建+库存扣减）的原子性。
*   **实现**: 封装为 Postgres Functions (RPC)。
*   **调用**: Server Action -> `supabase.rpc('create_order_transaction', payload)`。

### 4.2 最终一致性 (Eventual Consistency)
对于跨系统交互（如支付回调、外部通知），采用 **Transactional Outbox** 模式。
1.  业务事务中同时写入 `orders` 表和 `job_queue` 表。
2.  `pg_cron` 或 Edge Function 异步消费 `job_queue`，执行外部 API 调用。
3.  利用 Supabase Webhook 的重试机制保证消息必达。

### 4.3 乐观并发 (Optimistic Locking)
使用 `version` 字段解决多人协作冲突：
```sql
update documents set content = $1, version = version + 1 
where id = $2 and version = $3;
```

## 5. 通信规范

### 5.1 客户端 -> 服务端
*   **RPC 风格**: Server Actions (优先用于写操作)。
*   **REST 风格**: Supabase Client (优先用于读操作/订阅)。
*   **类型安全**: 全链路共享 TypeScript 类型 (`database.types.ts`)。

### 5.2 服务端 -> 外部系统
*   **Fetch API**: 在 Server Actions 或 Edge Functions 中调用第三方 API。
*   **Webhooks**: 接收外部系统（如 Stripe）的回调，需校验签名。

### 5.3 模块间通信
由于是单体架构，模块间通信优先使用 **直接函数导入 (Direct Import)**。
```typescript
// features/orders/actions.ts
import { checkStock } from '@/features/products/utils'; // 直接调用
```
对于完全解耦的场景，才使用数据库 Webhook 触发。
