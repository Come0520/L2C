# Configuration & Key Governance

## 1. Environment Variable Architecture
The project uses a strict separation of concerns for environment variables, enforced by `src/config/env.ts`:

- **Client-Side** (`NEXT_PUBLIC_`): Publicly accessible configuration (e.g., Supabase URL, Analytics ID). Validated by `clientSchema`.
- **Server-Side** (No Prefix): Sensitive secrets (e.g., App Secrets, Webhooks). Validated by `serverSchema`. **NEVER** exposed to the browser.

## 2. Key Management Policy

| Key Type | Scope | Rotation Policy | Storage |
|----------|-------|-----------------|---------|
| **Supabase Anon Key** | Public | Yearly (or on breach) | Supabase Dashboard / `.env` |
| **Supabase Request Key** | Client | N/A (Dynamic) | Secure HttpOnly Cookie |
| **Service Role Key** | Server | **Strictly Secret**. Rotate immediately on leak. | Env Var Only (Never in code) |
| **Third-Party Secrets** | Server | Quarterly | Env Var (Feishu/WeChat) |

## 3. Security Best Practices
- **Validation**: application fails to start if `zod` validation fails (Zero-config startup prevention).
- **Leak Prevention**:
  - `src/config/env.ts` conditional export (`typeof window === 'undefined'`) prevents server keys from bundling.
  - Periodic git scanning for hardcoded secrets.
- **Audit**:
  - Regular review of Vercel/Supabase environment variable lists.
  - Delete unused keys immediately.

## 4. SSR Session Bridge
The `createClient` in `server.ts` uses the `cookies` API to forward the user session securely. It does NOT use the Service Role key, ensuring that SSR rendering has the exact same permission level as the user.
