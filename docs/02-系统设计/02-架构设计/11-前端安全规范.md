# 安全与密钥治理指南

## 1. 密钥管理原则

本项目遵循以下密钥管理原则：

- **最小权限原则**：仅授予必要的权限。
- **环境隔离**：不同环境（开发、测试、生产）使用不同的密钥。
- **配置分离**：敏感配置与代码分离，通过环境变量注入。
- **密钥不入库**：严禁将任何敏感密钥提交到版本控制系统。

## 2. 环境变量管理

本项目使用 `src/config/env.ts` 进行环境变量的统一管理和类型校验。

### 客户端变量 (`NEXT_PUBLIC_*`)
- 此类变量会暴露给浏览器，**严禁**包含任何私密信息（如 Service Role Key、App Secret）。
- 仅限于公共 API URL、公共 Key 等。

### 服务端变量
- 此类变量仅在服务器端（Node.js / Edge Runtime）可用。
- 包含数据库连接串、第三方服务 Secret、Webhook Token 等。
- `src/config/env.ts` 会自动拦截客户端对服务端变量的访问。

## 3. 密钥轮换策略

建议定期（如每 90 天）或在人员变动/潜在泄露时轮换以下密钥：

### Supabase Keys
1. 在 Supabase Dashboard -> Project Settings -> API 中生成新的 `anon` 和 `service_role` keys。
2. 更新 Vercel/部署平台的环境变量。
3. 重新部署应用。
4. 确认服务正常后，废弃旧 Keys。

### 数据库密码
1. 在 Supabase Dashboard -> Project Settings -> Database -> Password 中修改。
2. 更新连接字符串配置。

### 第三方集成 (飞书/微信)
1. 在对应开放平台重置 App Secret。
2. 同步更新环境变量。

## 4. 审计与监控

- **配置变更审计**：
  - Vercel/部署平台通常提供环境变量变更日志，应定期审查。
  - 代码中的 `env.ts` 变更需经过 Code Review。

- **密钥泄露扫描**：
  - CI/CD 流水线中并未集成自动密钥扫描（建议集成 `trufflehog` 或 `git-secrets`）。
  - 开发者在提交代码前应自查。

- **异常访问监控**：
  - 关注 Sentry 中的异常报错，特别是 401/403 错误，可能暗示密钥过期或配置错误。

## 5. 开发环境配置

本地开发时：
1. 复制 `.env.example` 为 `.env.local`。
2. 填入本地开发所需的密钥。
3. `.env.local` 已被 `.gitignore` 忽略，确保不会提交。

---
**注意**：如发现密钥泄露，请立即按照轮换策略进行废弃和更新，并评估潜在影响。
