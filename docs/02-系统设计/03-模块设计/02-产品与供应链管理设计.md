# 产品与供应链管理设计

## 1. 模块概述

产品与供应链管理模块支撑企业核心物资的流转，从产品定义、采购入库到库存管理和物流配送。该模块需要处理复杂的 SKU 属性、多级价格体系以及多仓库库存调度。

### 1.1 核心目标
- **标准化产品库**：建立统一的 SPU/SKU 模型，支持成品（床品）和定制品（窗帘、墙布）的差异化管理。
- **库存准确性**：实现多仓库实时库存同步，支持库存预警和批次管理。
- **供应链协同**：打通供应商采购、发货和对账流程，提升供应链响应速度。

### 1.2 业务范围
- **产品管理 (PIM)**：分类、属性、价格策略、上下架。
- **库存管理 (WMS)**：入库、出库、调拨、盘点。
- **采购管理 (SRM)**：供应商、采购单、进货。
- **物流管理 (TMS)**：发货、物流追踪、运费计算。

---

## 2. 核心功能设计

### 2.1 产品管理体系
#### 产品类型
1.  **标准成品 (Standard)**：如四件套、枕芯。
    *   管理方式：标准 SKU，固定库存。
2.  **定制半成品 (Custom)**：如窗帘布、纱。
    *   管理方式：按米/卷管理，涉及损耗计算。
3.  **服务产品 (Service)**：如测量费、安装费。
    *   管理方式：无库存，仅价格。

#### 价格体系 (5级价格)
- **L1 零售价**：门店标价。
- **L2 会员价**：普通会员折扣价。
- **L3 经销商价**：加盟商进货价。
- **L4 成本价**：财务核算成本。
- **L5 促销价**：限时活动价格。

### 2.2 库存管理策略
- **库存扣减**：
    *   **下单锁库**：创建订单时预占库存 (Locked Stock)。
    *   **支付扣减**：支付成功后实扣库存 (On-hand Stock)。
    *   **超时释放**：订单未支付超时 (如30分钟) 自动释放预占。
- **多仓逻辑**：
    *   支持 **总仓** (HQ) 和 **门店仓** (Store) 二级架构。
    *   支持门店间库存调拨 (Transfer)。

---

## 3. 数据库设计

### 3.1 产品模型 (Products & SKUs)

```sql
create table products (
  id uuid primary key default gen_random_uuid(),
  name varchar(200) not null,
  spu_code varchar(50) unique not null,
  category_id uuid references categories(id),
  type varchar(20) default 'standard', -- standard, custom, service
  
  brand varchar(50),
  unit varchar(20), -- 个, 米, 卷
  
  description text,
  images text[],
  
  status varchar(20) default 'active', -- active, draft, archived
  tenant_id uuid not null
);

create table skus (
  id uuid primary key default gen_random_uuid(),
  product_id uuid references products(id),
  sku_code varchar(50) unique not null,
  name varchar(200), -- 规格名称，如 "米白-2.0m"
  
  -- 规格属性 (JSONB 灵活存储)
  -- e.g. {"color": "Red", "size": "L", "material": "Cotton"}
  attributes jsonb,
  
  -- 价格体系
  price_retail decimal(10,2),
  price_member decimal(10,2),
  price_dealer decimal(10,2),
  cost_price decimal(10,2),
  
  weight decimal(10,2), -- 重量 (kg)
  volume decimal(10,2)  -- 体积 (m3)
);
```

### 3.2 库存模型 (Inventory)

```sql
create table inventory_items (
  id uuid primary key default gen_random_uuid(),
  sku_id uuid references skus(id),
  warehouse_id uuid references warehouses(id),
  
  quantity_on_hand int default 0, -- 现有库存
  quantity_locked int default 0,  -- 锁定库存 (订单预占)
  quantity_reserved int default 0, -- 预留库存 (特殊用途)
  
  -- 库位信息
  shelf_location varchar(50), -- 货架号
  
  updated_at timestamptz default now()
);

-- 库存变动日志 (Audit Trail)
create table inventory_logs (
  id bigint generated always as identity,
  sku_id uuid,
  warehouse_id uuid,
  change_amount int,
  change_type varchar(50), -- order_locked, sales_out, purchase_in, transfer
  reference_id uuid, -- 关联单号 (order_id, purchase_id)
  created_at timestamptz default now()
);
```

---

## 4. 供应链集成

### 4.1 供应商管理
- **资质管理**：营业执照、授权书有效期提醒。
- **绩效评估**：交货准时率、退货率自动统计。

### 4.2 采购流程
1.  **缺货预警** -> 生成 **采购申请**。
2.  **审批** -> 生成 **采购订单 (PO)** 发送供应商。
3.  **收货** -> 扫描条码 **入库** -> 增加库存。

### 4.3 物流对接
- 集成第三方物流 API (顺丰、京东)。
- 自动订阅物流轨迹 (Webhook 回调)，更新订单物流状态。
