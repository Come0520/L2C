# 订单与财务管理设计

## 1. 模块概述

订单与财务管理模块是实现商业变现的关键环节，负责将销售协议转化为实际收入。模块涵盖了从订单生成、履约交付到资金结算的全过程。

### 1.1 核心目标
- **交易闭环**：确保订单状态流转的准确性和可追溯性。
- **财务合规**：实现订单金额、支付流水和发票的一致性（三单匹配）。
- **履约高效**：自动化拆单、合并发货，提升订单处理速度。

### 1.2 业务范围
- **订单管理 (OMS)**：正向订单、逆向流程 (退换货)。
- **支付中心**：微信/支付宝/银联集成、分期付款。
- **结算中心**：对账单、佣金计算、供应商结算。
- **发票管理**：电子发票开具、红冲。

---

## 2. 业务流程

### 2.1 订单状态机 (Order State Machine)
订单生命周期严格遵循以下流转规则：

```mermaid
stateDiagram-v2
    [*] --> pending_payment: 下单
    pending_payment --> paid: 支付成功
    pending_payment --> cancelled: 超时/取消
    
    paid --> processing: 确认/备货
    processing --> shipping: 发货
    
    shipping --> installed: 安装完成 (定制品)
    shipping --> completed: 确认收货 (成品)
    
    installed --> completed: 验收通过
    
    completed --> [*]
    
    -- 逆向流程 --
    paid --> refunding: 申请退款
    refunding --> refunded: 退款完成
    refunding --> paid: 拒绝退款
```

### 2.2 财务对账流程
1.  **日终对账 (T+1)**：
    *   下载支付渠道 (微信/支付宝) 对账单。
    *   与系统内 `payments` 表进行核对。
2.  **异常处理**：
    *   **长款** (渠道有，系统无)：补录支付记录，人工确认。
    *   **短款** (系统有，渠道无)：查询支付网关状态，发起冲正或退款。

---

## 3. 核心功能设计

### 3.1 订单处理
- **订单拆分**：
    *   按 **仓库** 拆分：不同仓库发货。
    *   按 **类型** 拆分：成品 (快递发货) vs 定制品 (送货上门)。
- **价格计算**：
    *   总价 = 商品原价 - 促销优惠 - 优惠券 - 积分抵扣 + 运费 + 安装费。
    *   计算逻辑需在 Server Action 中原子执行，防止篡改。

### 3.2 支付系统
- **聚合支付**：封装统一 Payment Interface，适配不同渠道。
- **分阶段付款** (针对定制大单)：
    1.  **定金 (Deposit)**：下单付 30%，锁定优惠和排期。
    2.  **尾款 (Balance)**：安装前/发货前付 70%。

### 3.3 售后管理
- **仅退款**：未发货订单，原路退回。
- **退货退款**：已发货，需仓库确认收货入库后触发退款。
- **换货**：生成新的换货单 (关联原订单)。

---

## 4. 数据库设计

### 4.1 订单模型 (Orders)

```sql
create type order_status as enum (
  'pending_payment', 'paid', 'processing', 'shipping', 
  'installed', 'completed', 'cancelled', 'refunding', 'refunded'
);

create table sales_orders (
  id uuid primary key default gen_random_uuid(),
  order_no varchar(32) unique not null,
  
  -- 客户信息 (快照)
  customer_id uuid not null,
  shipping_address jsonb not null, -- {name, phone, address...}
  
  -- 金额信息
  total_amount decimal(10,2) not null,
  paid_amount decimal(10,2) default 0,
  discount_amount decimal(10,2) default 0,
  
  -- 状态
  status order_status default 'pending_payment',
  payment_status varchar(20) default 'unpaid', -- unpaid, partial, paid
  
  -- 业务归属
  store_id uuid,
  sales_rep_id uuid,
  
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table order_items (
  id uuid primary key default gen_random_uuid(),
  order_id uuid references sales_orders(id),
  sku_id uuid not null,
  product_name varchar(200), -- 快照
  sku_attrs jsonb,           -- 快照
  
  quantity int not null,
  unit_price decimal(10,2) not null,
  subtotal decimal(10,2) not null
);
```

### 4.2 支付流水 (Payments)

```sql
create table payments (
  id uuid primary key default gen_random_uuid(),
  payment_no varchar(32) unique not null, -- 支付单号
  order_id uuid references sales_orders(id),
  
  amount decimal(10,2) not null,
  channel varchar(20), -- wechat, alipay, bank, cash
  transaction_id varchar(100), -- 第三方流水号
  
  status varchar(20) default 'pending', -- pending, success, failed
  paid_at timestamptz
);
```

---

## 5. 前端界面规范

### 5.1 订单列表
- **多Tab视图**：全部 / 待付款 / 待发货 / 待收货 / 售后。
- **操作按钮**：根据状态动态显示 (如 "待付款" 显示 "去支付/取消", "待发货" 显示 "发货").
- **搜索过滤**：支持订单号、手机号、商品名称、下单时间范围搜索。

### 5.2 订单详情
- **进度条**：可视化展示订单当前所处状态节点。
- **费用明细**：清晰列出商品总价、各项优惠、运费、实付金额。
- **物流信息**：集成物流地图轨迹展示。
