# 服务与交付管理设计

## 1. 模块概述

服务与交付管理模块专注于解决软装行业 "三分产品，七分安装" 的痛点。通过标准化的测量和安装服务流程，提升交付质量和客户满意度，同时有效管理自有和外包服务团队。

### 1.1 核心目标
- **服务标准化**：规范测量、安装的预约、上门、作业和验收标准。
- **调度智能化**：基于地理位置 (LBS) 和技师技能，实现最优派单。
- **过程透明化**：客户可实时查看技师位置和服务进度。
- **质量可控化**：通过现场照片留痕和客户评价闭环管理质量。

### 1.2 业务范围
- **测量管理**：预约测量、分配技师、录入数据 (窗型、尺寸、墙体情况)。
- **安装管理**：安装派单、货物核对、安装实施、完工验收。
- **服务商管理**：技师招募、资质审核、培训认证、绩效考核。

---

## 2. 业务流程

### 2.1 测量服务流程
1.  **预约**：销售/客户发起申请，选择时间段。
2.  **派单**：系统根据 `Store` 覆盖范围自动推荐技师，或人工指派。
3.  **上门**：技师签到 (GPS打卡)。
4.  **作业**：
    *   拍照：窗户全景、局部特写。
    *   数据：录入宽、高、离地距离、窗帘盒深度等。
    *   确认：生成测量单，客户电子签名确认。
5.  **设计**：数据同步至设计/报价模块。

### 2.2 安装服务流程
1.  **发货通知**：订单发货触发安装任务创建。
2.  **预约安装**：货物送达后预约上门时间。
3.  **实施**：
    *   核对：开箱核对商品数量和完好度。
    *   安装：按规范施工。
    *   清理：清理现场垃圾。
4.  **验收**：客户检查并在 APP 上签字验收，触发订单完成状态。

---

## 3. 核心功能设计

### 3.1 智能调度引擎
- **规则因子**：
    *   **距离**：技师当前位置/常驻地 vs 客户地址。
    *   **技能**：安装电动窗帘需 "强电资质"。
    *   **排期**：避开已有任务时间段。
    *   **评分**：优先派给评分高的技师。

### 3.2 移动端作业工具 (小程序/App)
- **任务看板**：待接收、待上门、进行中、已完成。
- **地图导航**：一键唤起地图导航至客户家。
- **现场工具**：
    *   **AR测量** (未来规划)。
    *   **拍照水印**：自动添加时间、地点水印，防作假。

---

## 4. 数据库设计

### 4.1 测量单 (Measurement Orders)

```sql
create table measurement_orders (
  id uuid primary key default gen_random_uuid(),
  order_no varchar(32) unique not null,
  
  -- 关联信息
  lead_id uuid, -- 销售线索
  customer_id uuid,
  
  -- 预约信息
  address jsonb not null,
  appoint_time timestamptz,
  
  -- 执行信息
  worker_id uuid references service_providers(id),
  status varchar(20) default 'pending', -- pending, assigned, processing, completed
  
  -- 结果
  data jsonb, -- { "living_room": { "w": 300, "h": 280, "box": true } }
  images text[],
  customer_sign_url text,
  
  tenant_id uuid not null
);
```

### 4.2 安装单 (Installation Orders)

```sql
create table installation_orders (
  id uuid primary key default gen_random_uuid(),
  order_no varchar(32) unique not null,
  sales_order_id uuid references sales_orders(id),
  
  worker_id uuid references service_providers(id),
  appoint_time timestamptz,
  
  status varchar(20) default 'pending',
  
  -- 验收
  check_items jsonb, -- [{"item": "轨道牢固", "pass": true}, ...]
  customer_rating int, -- 1-5
  customer_comment text
);
```

### 4.3 服务商/技师 (Service Providers)

```sql
create table service_providers (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id), -- 关联登录账号
  
  name varchar(50) not null,
  phone varchar(20) not null,
  type varchar(20), -- internal (自有), external (外包)
  
  skills text[], -- [curtain, wallpaper, smart_home]
  level varchar(10) default 'L1', -- L1, L2, L3
  
  current_location point, -- 实时位置
  status varchar(20) default 'active' -- active, busy, offline
);
```

---

## 5. 前端界面规范

### 5.1 调度中心 (Web)
- **地图模式**：地图上展示所有待派单任务 (红点) 和技师位置 (蓝点/绿点)。
- **甘特图**：按时间轴展示技师任务排期，支持拖拽改派。

### 5.2 技师端 (Mobile)
- **作业流引导**：
    *   步骤1：出发 (点击触发通知客户)。
    *   步骤2：到达签到 (校验 GPS)。
    *   步骤3：作业 (强制上传照片)。
    *   步骤4：完工 (需客户扫码确认)。
