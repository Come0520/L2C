# 基础支撑服务设计

## 1. 模块概述

基础支撑服务模块为上层业务提供通用的系统级能力，包括用户认证、权限控制、系统配置、流程审批和消息通知。该模块利用 Supabase 原生能力 (Auth, Storage, Realtime) 构建，确保系统的安全、稳定和扩展性。

### 1.1 核心目标
- **安全统一**：统一的身份认证 (SSO) 和基于 RLS 的数据权限控制。
- **配置灵活**：支持系统参数、数据字典的热加载和动态配置。
- **流程规范**：提供轻量级审批工作流引擎，规范业务决策。
- **触达及时**：构建全渠道消息通知中心，确保关键信息不遗漏。

### 1.2 业务范围
- **认证中心 (IAM)**：注册、登录、MFA、SSO。
- **权限管理 (RBAC)**：角色、资源、菜单、数据权限。
- **配置中心**：系统参数、枚举字典、打印模板。
- **审批中心**：流程定义、发起审批、待办处理。
- **消息中心**：站内信、短信、邮件、微信模板消息。

---

## 2. 核心功能设计

### 2.1 认证与权限 (Auth & RBAC)
- **认证方式**：
    *   **手机号 + 验证码** (主推)。
    *   **微信扫码** (PC端)。
    *   **微信一键登录** (小程序)。
- **权限模型**：
    *   **功能权限**：基于 RBAC，控制菜单和按钮显隐。
    *   **数据权限**：基于 RLS (Row Level Security)。
        *   **本人可见**：`auth.uid() = owner_id`
        *   **部门可见**：递归查询部门树。
        *   **全公司可见**：管理员角色。

### 2.2 审批工作流 (Workflow)
采用 **JSON 配置化** 的轻量级流程引擎，不引入沉重的 BPMN 引擎。

- **流程节点**：
    *   **发起人** (Start)。
    *   **审批人** (Approver)：支持指定人、指定角色、主管。
    *   **抄送人** (CC)。
    *   **条件分支** (Condition)：如 `amount > 5000`。
- **数据结构**：
    ```json
    // 流程定义示例
    {
      "nodes": [
        { "id": "node1", "type": "start" },
        { "id": "node2", "type": "approver", "role": "manager" },
        { "id": "node3", "type": "end" }
      ]
    }
    ```

### 2.3 消息通知系统
- **多通道路由**：
    *   **重要通知** (审批/报警) -> 短信 + 站内信。
    *   **营销通知** -> 微信模板消息。
    *   **普通通知** -> 站内信。
- **实时推送**：利用 Supabase Realtime 实现前端未读消息红点实时更新。

---

## 3. 数据库设计

### 3.1 权限模型

```sql
-- 角色表
create table roles (
  id uuid primary key default gen_random_uuid(),
  code varchar(50) unique not null, -- admin, sales, manager
  name varchar(50) not null,
  permissions text[] -- ['user.read', 'order.create']
);

-- 用户-角色关联
create table user_roles (
  user_id uuid references auth.users(id),
  role_id uuid references roles(id),
  primary key (user_id, role_id)
);

-- RLS 辅助函数：检查是否有权限
create function has_permission(perm text) returns boolean as $$
  select exists (
    select 1 from user_roles ur
    join roles r on ur.role_id = r.id
    where ur.user_id = auth.uid()
    and r.permissions @> array[perm]
  );
$$ language sql security definer;
```

### 3.2 审批实例 (Approval Instances)

```sql
create table approval_instances (
  id uuid primary key default gen_random_uuid(),
  definition_id uuid, -- 关联流程定义
  
  business_type varchar(50), -- quote, leave, reimbursement
  business_id uuid, -- 业务单据ID
  
  current_node_id varchar(50),
  status varchar(20) default 'pending', -- pending, approved, rejected
  
  applicant_id uuid references auth.users(id),
  created_at timestamptz default now()
);

create table approval_records (
  id uuid primary key default gen_random_uuid(),
  instance_id uuid references approval_instances(id),
  node_id varchar(50),
  
  approver_id uuid references auth.users(id),
  action varchar(20), -- approve, reject
  comment text,
  
  processed_at timestamptz default now()
);
```

### 3.3 通知消息 (Notifications)

```sql
create table notifications (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id),
  
  title varchar(100) not null,
  content text,
  type varchar(20), -- system, workflow, marketing
  
  is_read boolean default false,
  read_at timestamptz,
  
  link_url text, -- 点击跳转链接
  created_at timestamptz default now()
);
```

---

## 4. 前端界面规范

### 4.1 消息中心 (顶部栏)
- **铃铛图标**：显示未读数徽标 (Badge)。
- **下拉列表**：展示最近 5 条未读消息，支持 "一键已读"。
- **消息列表页**：左侧分类 (全部/系统/审批)，右侧消息卡片。

### 4.2 审批中心
- **发起审批**：表单填写 + 流程预览图。
- **待办事项**：列表展示待我审批的任务，支持批量通过。
- **审批详情**：展示申请内容 + 审批时间轴 (Timeline)。
