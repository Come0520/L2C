# 数据分析与报表设计

## 1. 模块概述

数据分析与报表模块是企业的 "驾驶舱"，负责将业务过程中产生的海量数据转化为可视化的决策依据。通过多维度的数据分析，帮助管理层实时掌握经营状况，发现增长点和风险点。

### 1.1 核心目标
- **数据可视化**：将枯燥的数据转化为直观的图表 (ECharts/Recharts)。
- **决策实时化**：T+0 实时看板，秒级响应业务变化。
- **报表自动化**：定时生成日报、周报、月报，自动推送给相关人员。
- **分析自助化**：提供拖拽式报表设计器，满足个性化分析需求。

### 1.2 业务范围
- **经营驾驶舱**：GMV、毛利率、客单价、转化率等核心指标。
- **销售分析**：漏斗分析、业绩排名、目标达成率。
- **产品分析**：热销榜单、滞销预警、品类占比。
- **客户分析**：客户画像、复购率、流失分析。

---

## 2. 核心功能设计

### 2.1 统计维度 (Dimensions)
- **时间维度**：日、周、月、季、年、同比、环比。
- **组织维度**：全公司、大区、门店、小组、个人。
- **业务维度**：产品品类、客户等级、线索来源。

### 2.2 核心指标 (Metrics)
- **销售漏斗**：线索 -> 确认意向 -> 报价 -> 成交。
    *   关键指标：**线索转化率** (Conversion Rate)。
- **人效分析**：
    *   关键指标：**人均产出** (Revenue per Employee)。
- **库存周转**：
    *   关键指标：**库存周转天数** (Inventory Turnover Days)。

---

## 3. 数据库设计 (数据仓库层)

为了不影响业务库 (OLTP) 性能，复杂报表查询基于 **PostgreSQL Materialized Views (物化视图)** 或 **Read Replica (只读节点)** 进行。

### 3.1 事实表 (Fact Tables) - 逻辑概念
在 Supabase 中，我们通常使用 `Materialized Views` 来预计算聚合数据。

```sql
-- 每日销售聚合 (物化视图)
create materialized view analytics_daily_sales as
select
  date_trunc('day', o.created_at) as day,
  o.store_id,
  o.sales_rep_id,
  
  count(o.id) as order_count,
  sum(o.total_amount) as total_revenue,
  sum(o.discount_amount) as total_discount
from sales_orders o
where o.status = 'paid' or o.status = 'completed'
group by 1, 2, 3;

-- 创建索引加速查询
create index idx_analytics_daily_sales_day on analytics_daily_sales(day);

-- 刷新策略 (pg_cron)
-- select cron.schedule('0 0 * * *', 'refresh materialized view concurrently analytics_daily_sales');
```

### 3.2 报表配置 (Report Config)

```sql
create table report_templates (
  id uuid primary key default gen_random_uuid(),
  name varchar(100) not null,
  type varchar(20), -- dashboard, excel, pdf
  
  -- 布局配置
  layout_config jsonb, -- Grid Layout: x, y, w, h
  
  -- 图表组件
  components jsonb, -- [{type: 'bar', sql: 'select...', title: '销售额'}]
  
  created_by uuid references auth.users(id),
  is_public boolean default false
);
```

---

## 4. 前端界面规范

### 4.1 仪表盘 (Dashboard)
- **布局**：栅格化布局 (Grid Layout)，支持响应式。
- **核心组件**：
    *   **指标卡 (Statistic Card)**：展示核心数字 + 同比/环比趋势箭头。
    *   **折线图 (Line Chart)**：趋势分析。
    *   **柱状图 (Bar Chart)**：排名对比。
    *   **饼图 (Pie Chart)**：占比分析。
- **交互**：
    *   **全局筛选**：顶部时间范围、门店筛选器，联动所有图表。
    *   **下钻 (Drill-down)**：点击图表元素进入明细页。

### 4.2 报表导出
- **格式**：Excel (.xlsx), PDF, 图片 (.png).
- **方式**：
    *   **即时下载**：前端生成或后端流式返回。
    *   **邮件订阅**：配置定时任务，每日早 8:00 发送。
