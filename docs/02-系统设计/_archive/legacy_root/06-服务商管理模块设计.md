# ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿ - æœåŠ¡å•†ç®¡ç†æ¨¡å—è®¾è®¡

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**é¡¹ç›®åç§°ï¼š** ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»ŸæœåŠ¡å•†ç®¡ç†æ¨¡å—  
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2024å¹´  
**è®¾è®¡ç›®æ ‡ï¼š** æ„å»ºå®Œæ•´çš„æœåŠ¡å•†ç”Ÿæ€ç®¡ç†ä½“ç³»ï¼Œæ”¯æŒæµ‹é‡å¸ˆå’Œå®‰è£…å¸ˆçš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†  

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

### 1. æ¨¡å—ç›®æ ‡
- **æœåŠ¡å•†æ³¨å†Œ**ï¼šæ”¯æŒæµ‹é‡å¸ˆå’Œå®‰è£…å¸ˆçš„åœ¨çº¿æ³¨å†Œç”³è¯·
- **èµ„è´¨è®¤è¯**ï¼šå®Œæ•´çš„æœåŠ¡å•†èµ„è´¨å®¡æ ¸å’Œè®¤è¯æµç¨‹
- **æœåŠ¡ç®¡ç†**ï¼šæœåŠ¡å•†çš„æœåŠ¡èƒ½åŠ›ã€æœåŠ¡åŒºåŸŸã€æœåŠ¡æ—¶é—´ç®¡ç†
- **è®¢å•åˆ†é…**ï¼šæ™ºèƒ½çš„è®¢å•åˆ†é…å’Œè°ƒåº¦ç³»ç»Ÿ
- **ç»©æ•ˆè¯„ä¼°**ï¼šæœåŠ¡å•†çš„æœåŠ¡è´¨é‡è¯„ä¼°å’Œç»©æ•ˆç®¡ç†
- **ç»“ç®—ç®¡ç†**ï¼šæœåŠ¡è´¹ç”¨çš„è®¡ç®—ã€ç»“ç®—å’Œæ”¯ä»˜ç®¡ç†

### 2. æœåŠ¡å•†ç±»å‹
- **æµ‹é‡å¸ˆï¼ˆMeasure Providerï¼‰**ï¼šè´Ÿè´£ä¸Šé—¨æµ‹é‡æœåŠ¡
- **å®‰è£…å¸ˆï¼ˆInstall Providerï¼‰**ï¼šè´Ÿè´£äº§å“å®‰è£…æœåŠ¡
- **ç»¼åˆæœåŠ¡å•†**ï¼šåŒæ—¶æä¾›æµ‹é‡å’Œå®‰è£…æœåŠ¡

---

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### 1. æœåŠ¡å•†åŸºç¡€ä¿¡æ¯è¡¨

#### 1.1 service_providersï¼ˆæœåŠ¡å•†è¡¨ï¼‰
```sql
CREATE TABLE service_providers (
  id BIGSERIAL PRIMARY KEY,
  provider_code VARCHAR(32) UNIQUE NOT NULL COMMENT 'æœåŠ¡å•†ç¼–ç ',
  provider_name VARCHAR(100) NOT NULL COMMENT 'æœåŠ¡å•†åç§°',
  provider_type ENUM('measure', 'install', 'both') NOT NULL COMMENT 'æœåŠ¡å•†ç±»å‹',
  contact_person VARCHAR(50) NOT NULL COMMENT 'è”ç³»äºº',
  contact_phone VARCHAR(15) NOT NULL COMMENT 'è”ç³»ç”µè¯',
  contact_email VARCHAR(100) COMMENT 'è”ç³»é‚®ç®±',
  business_license VARCHAR(100) COMMENT 'è¥ä¸šæ‰§ç…§å·',
  id_card_number VARCHAR(18) COMMENT 'èº«ä»½è¯å·',
  address TEXT COMMENT 'åœ°å€',
  service_areas JSON COMMENT 'æœåŠ¡åŒºåŸŸï¼ˆçœå¸‚åŒºæ•°ç»„ï¼‰',
  service_radius INTEGER DEFAULT 50 COMMENT 'æœåŠ¡åŠå¾„ï¼ˆå…¬é‡Œï¼‰',
  status ENUM('pending', 'approved', 'rejected', 'suspended', 'inactive') DEFAULT 'pending' COMMENT 'çŠ¶æ€',
  rating DECIMAL(3,2) DEFAULT 0.00 COMMENT 'è¯„åˆ†',
  total_orders INTEGER DEFAULT 0 COMMENT 'æ€»è®¢å•æ•°',
  completed_orders INTEGER DEFAULT 0 COMMENT 'å®Œæˆè®¢å•æ•°',
  certification_level ENUM('bronze', 'silver', 'gold', 'platinum') DEFAULT 'bronze' COMMENT 'è®¤è¯ç­‰çº§',
  join_date DATE COMMENT 'åŠ å…¥æ—¥æœŸ',
  last_active_at TIMESTAMP COMMENT 'æœ€åæ´»è·ƒæ—¶é—´',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL COMMENT 'è½¯åˆ é™¤æ—¶é—´',
  
  INDEX idx_provider_code (provider_code),
  INDEX idx_provider_type (provider_type),
  INDEX idx_status (status),
  INDEX idx_service_areas (service_areas),
  INDEX idx_rating (rating),
  INDEX idx_created_at (created_at)
) COMMENT 'æœåŠ¡å•†åŸºç¡€ä¿¡æ¯è¡¨';
```

#### 1.2 provider_certificationsï¼ˆæœåŠ¡å•†è®¤è¯è¡¨ï¼‰
```sql
CREATE TABLE provider_certifications (
  id BIGSERIAL PRIMARY KEY,
  provider_id BIGINT NOT NULL COMMENT 'æœåŠ¡å•†ID',
  certification_type ENUM('business_license', 'id_card', 'skill_certificate', 'insurance', 'other') NOT NULL COMMENT 'è®¤è¯ç±»å‹',
  certification_name VARCHAR(100) NOT NULL COMMENT 'è®¤è¯åç§°',
  certificate_number VARCHAR(100) COMMENT 'è¯ä¹¦ç¼–å·',
  issuing_authority VARCHAR(100) COMMENT 'å‘è¯æœºå…³',
  issue_date DATE COMMENT 'å‘è¯æ—¥æœŸ',
  expiry_date DATE COMMENT 'è¿‡æœŸæ—¥æœŸ',
  file_url VARCHAR(500) COMMENT 'è¯ä¹¦æ–‡ä»¶URL',
  status ENUM('pending', 'approved', 'rejected', 'expired') DEFAULT 'pending' COMMENT 'è®¤è¯çŠ¶æ€',
  reviewer_id BIGINT COMMENT 'å®¡æ ¸äººID',
  review_time TIMESTAMP COMMENT 'å®¡æ ¸æ—¶é—´',
  review_notes TEXT COMMENT 'å®¡æ ¸å¤‡æ³¨',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (provider_id) REFERENCES service_providers(id),
  INDEX idx_provider_id (provider_id),
  INDEX idx_certification_type (certification_type),
  INDEX idx_status (status),
  INDEX idx_expiry_date (expiry_date)
) COMMENT 'æœåŠ¡å•†è®¤è¯è¡¨';
```

#### 1.3 provider_servicesï¼ˆæœåŠ¡å•†æœåŠ¡èƒ½åŠ›è¡¨ï¼‰
```sql
CREATE TABLE provider_services (
  id BIGSERIAL PRIMARY KEY,
  provider_id BIGINT NOT NULL COMMENT 'æœåŠ¡å•†ID',
  service_type ENUM('measure', 'install') NOT NULL COMMENT 'æœåŠ¡ç±»å‹',
  service_category VARCHAR(50) NOT NULL COMMENT 'æœåŠ¡åˆ†ç±»ï¼ˆçª—å¸˜ã€åºŠå“ç­‰ï¼‰',
  skill_level ENUM('junior', 'intermediate', 'senior', 'expert') DEFAULT 'junior' COMMENT 'æŠ€èƒ½ç­‰çº§',
  experience_years INTEGER DEFAULT 0 COMMENT 'ç»éªŒå¹´æ•°',
  hourly_rate DECIMAL(10,2) COMMENT 'å°æ—¶è´¹ç‡',
  service_fee DECIMAL(10,2) COMMENT 'æœåŠ¡è´¹ç”¨',
  is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (provider_id) REFERENCES service_providers(id),
  UNIQUE KEY uk_provider_service (provider_id, service_type, service_category),
  INDEX idx_provider_id (provider_id),
  INDEX idx_service_type (service_type),
  INDEX idx_service_category (service_category)
) COMMENT 'æœåŠ¡å•†æœåŠ¡èƒ½åŠ›è¡¨';
```

#### 1.4 provider_schedulesï¼ˆæœåŠ¡å•†æ’ç­è¡¨ï¼‰
```sql
CREATE TABLE provider_schedules (
  id BIGSERIAL PRIMARY KEY,
  provider_id BIGINT NOT NULL COMMENT 'æœåŠ¡å•†ID',
  schedule_date DATE NOT NULL COMMENT 'æ’ç­æ—¥æœŸ',
  start_time TIME NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  end_time TIME NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
  status ENUM('available', 'busy', 'off') DEFAULT 'available' COMMENT 'çŠ¶æ€',
  max_orders INTEGER DEFAULT 3 COMMENT 'æœ€å¤§æ¥å•æ•°',
  current_orders INTEGER DEFAULT 0 COMMENT 'å½“å‰æ¥å•æ•°',
  notes TEXT COMMENT 'å¤‡æ³¨',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (provider_id) REFERENCES service_providers(id),
  UNIQUE KEY uk_provider_schedule (provider_id, schedule_date, start_time),
  INDEX idx_provider_id (provider_id),
  INDEX idx_schedule_date (schedule_date),
  INDEX idx_status (status)
) COMMENT 'æœåŠ¡å•†æ’ç­è¡¨';
```

#### 1.5 provider_evaluationsï¼ˆæœåŠ¡å•†è¯„ä»·è¡¨ï¼‰
```sql
CREATE TABLE provider_evaluations (
  id BIGSERIAL PRIMARY KEY,
  provider_id BIGINT NOT NULL COMMENT 'æœåŠ¡å•†ID',
  order_id BIGINT NOT NULL COMMENT 'è®¢å•ID',
  customer_id BIGINT NOT NULL COMMENT 'å®¢æˆ·ID',
  service_rating INTEGER NOT NULL COMMENT 'æœåŠ¡è¯„åˆ†ï¼ˆ1-5ï¼‰',
  attitude_rating INTEGER NOT NULL COMMENT 'æ€åº¦è¯„åˆ†ï¼ˆ1-5ï¼‰',
  punctuality_rating INTEGER NOT NULL COMMENT 'å‡†æ—¶æ€§è¯„åˆ†ï¼ˆ1-5ï¼‰',
  overall_rating DECIMAL(3,2) NOT NULL COMMENT 'ç»¼åˆè¯„åˆ†',
  evaluation_content TEXT COMMENT 'è¯„ä»·å†…å®¹',
  evaluation_tags JSON COMMENT 'è¯„ä»·æ ‡ç­¾',
  is_anonymous BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦åŒ¿å',
  reply_content TEXT COMMENT 'å›å¤å†…å®¹',
  reply_time TIMESTAMP COMMENT 'å›å¤æ—¶é—´',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (provider_id) REFERENCES service_providers(id),
  INDEX idx_provider_id (provider_id),
  INDEX idx_order_id (order_id),
  INDEX idx_customer_id (customer_id),
  INDEX idx_overall_rating (overall_rating),
  INDEX idx_created_at (created_at)
) COMMENT 'æœåŠ¡å•†è¯„ä»·è¡¨';
```

#### 1.6 provider_settlementsï¼ˆæœåŠ¡å•†ç»“ç®—è¡¨ï¼‰
```sql
CREATE TABLE provider_settlements (
  id BIGSERIAL PRIMARY KEY,
  provider_id BIGINT NOT NULL COMMENT 'æœåŠ¡å•†ID',
  settlement_period VARCHAR(20) NOT NULL COMMENT 'ç»“ç®—å‘¨æœŸï¼ˆå¦‚2024-01ï¼‰',
  total_orders INTEGER DEFAULT 0 COMMENT 'æ€»è®¢å•æ•°',
  completed_orders INTEGER DEFAULT 0 COMMENT 'å®Œæˆè®¢å•æ•°',
  total_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT 'æ€»é‡‘é¢',
  service_fee DECIMAL(10,2) DEFAULT 0.00 COMMENT 'æœåŠ¡è´¹',
  platform_fee DECIMAL(10,2) DEFAULT 0.00 COMMENT 'å¹³å°è´¹ç”¨',
  deduction_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT 'æ‰£æ¬¾é‡‘é¢',
  bonus_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT 'å¥–åŠ±é‡‘é¢',
  settlement_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT 'ç»“ç®—é‡‘é¢',
  status ENUM('pending', 'confirmed', 'paid', 'disputed') DEFAULT 'pending' COMMENT 'ç»“ç®—çŠ¶æ€',
  settlement_date DATE COMMENT 'ç»“ç®—æ—¥æœŸ',
  payment_date DATE COMMENT 'æ”¯ä»˜æ—¥æœŸ',
  payment_method VARCHAR(50) COMMENT 'æ”¯ä»˜æ–¹å¼',
  payment_account VARCHAR(100) COMMENT 'æ”¯ä»˜è´¦æˆ·',
  notes TEXT COMMENT 'å¤‡æ³¨',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (provider_id) REFERENCES service_providers(id),
  UNIQUE KEY uk_provider_settlement (provider_id, settlement_period),
  INDEX idx_provider_id (provider_id),
  INDEX idx_settlement_period (settlement_period),
  INDEX idx_status (status),
  INDEX idx_settlement_date (settlement_date)
) COMMENT 'æœåŠ¡å•†ç»“ç®—è¡¨';
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### 1. æœåŠ¡å•†æ³¨å†Œä¸è®¤è¯

#### 1.1 æœåŠ¡å•†æ³¨å†Œç”³è¯·
```http
POST /v1/providers/register
Content-Type: application/json
Authorization: Bearer {token}

{
  "provider_name": "å¼ å¸ˆå‚…å®¶è£…æœåŠ¡",
  "provider_type": "both",
  "contact_person": "å¼ ä¸‰",
  "contact_phone": "13800138000",
  "contact_email": "zhangsan@example.com",
  "business_license": "91110000123456789X",
  "id_card_number": "110101199001011234",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“xxxå·",
  "service_areas": [
    {"province": "åŒ—äº¬å¸‚", "city": "åŒ—äº¬å¸‚", "district": "æœé˜³åŒº"},
    {"province": "åŒ—äº¬å¸‚", "city": "åŒ—äº¬å¸‚", "district": "æµ·æ·€åŒº"}
  ],
  "service_radius": 30
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "æ³¨å†Œç”³è¯·æäº¤æˆåŠŸ",
  "data": {
    "provider_id": 1001,
    "provider_code": "SP202401001",
    "status": "pending",
    "estimated_review_time": "3-5ä¸ªå·¥ä½œæ—¥"
  }
}
```

#### 1.2 ä¸Šä¼ è®¤è¯ææ–™
```http
POST /v1/providers/{providerId}/certifications
Content-Type: multipart/form-data
Authorization: Bearer {token}

{
  "certification_type": "business_license",
  "certification_name": "è¥ä¸šæ‰§ç…§",
  "certificate_number": "91110000123456789X",
  "issuing_authority": "åŒ—äº¬å¸‚å·¥å•†è¡Œæ”¿ç®¡ç†å±€",
  "issue_date": "2020-01-01",
  "expiry_date": "2030-01-01",
  "file": [æ–‡ä»¶]
}
```

#### 1.3 è·å–æœåŠ¡å•†åˆ—è¡¨
```http
GET /v1/providers?page=1&page_size=20&provider_type=measure&status=approved&city=åŒ—äº¬å¸‚
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "items": [
      {
        "id": 1001,
        "provider_code": "SP202401001",
        "provider_name": "å¼ å¸ˆå‚…å®¶è£…æœåŠ¡",
        "provider_type": "both",
        "contact_person": "å¼ ä¸‰",
        "contact_phone": "13800138000",
        "service_areas": [
          {"province": "åŒ—äº¬å¸‚", "city": "åŒ—äº¬å¸‚", "district": "æœé˜³åŒº"}
        ],
        "rating": 4.85,
        "total_orders": 156,
        "completed_orders": 152,
        "certification_level": "gold",
        "status": "approved"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 1,
      "total_pages": 1
    }
  }
}
```

### 2. æœåŠ¡å•†ç®¡ç†

#### 2.1 æ›´æ–°æœåŠ¡å•†ä¿¡æ¯
```http
PUT /v1/providers/{providerId}
Content-Type: application/json
Authorization: Bearer {token}

{
  "provider_name": "å¼ å¸ˆå‚…ä¸“ä¸šå®¶è£…",
  "contact_phone": "13800138001",
  "service_areas": [
    {"province": "åŒ—äº¬å¸‚", "city": "åŒ—äº¬å¸‚", "district": "æœé˜³åŒº"},
    {"province": "åŒ—äº¬å¸‚", "city": "åŒ—äº¬å¸‚", "district": "æµ·æ·€åŒº"},
    {"province": "åŒ—äº¬å¸‚", "city": "åŒ—äº¬å¸‚", "district": "ä¸°å°åŒº"}
  ],
  "service_radius": 50
}
```

#### 2.2 è®¾ç½®æœåŠ¡èƒ½åŠ›
```http
POST /v1/providers/{providerId}/services
Content-Type: application/json
Authorization: Bearer {token}

{
  "services": [
    {
      "service_type": "measure",
      "service_category": "curtain",
      "skill_level": "senior",
      "experience_years": 8,
      "hourly_rate": 80.00,
      "service_fee": 200.00
    },
    {
      "service_type": "install",
      "service_category": "curtain",
      "skill_level": "expert",
      "experience_years": 10,
      "hourly_rate": 100.00,
      "service_fee": 300.00
    }
  ]
}
```

#### 2.3 è®¾ç½®æ’ç­è®¡åˆ’
```http
POST /v1/providers/{providerId}/schedules
Content-Type: application/json
Authorization: Bearer {token}

{
  "schedules": [
    {
      "schedule_date": "2024-01-15",
      "start_time": "09:00",
      "end_time": "18:00",
      "status": "available",
      "max_orders": 3
    },
    {
      "schedule_date": "2024-01-16",
      "start_time": "09:00",
      "end_time": "17:00",
      "status": "available",
      "max_orders": 2
    }
  ]
}
```

### 3. è®¢å•åˆ†é…ä¸è°ƒåº¦

#### 3.1 æ™ºèƒ½åŒ¹é…æœåŠ¡å•†
```http
POST /v1/providers/match
Content-Type: application/json
Authorization: Bearer {token}

{
  "service_type": "measure",
  "service_category": "curtain",
  "customer_address": {
    "province": "åŒ—äº¬å¸‚",
    "city": "åŒ—äº¬å¸‚",
    "district": "æœé˜³åŒº",
    "detail": "xxxè¡—é“xxxå·",
    "longitude": 116.4074,
    "latitude": 39.9042
  },
  "preferred_date": "2024-01-15",
  "preferred_time": "14:00",
  "urgency": "normal"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "åŒ¹é…æˆåŠŸ",
  "data": {
    "recommended_providers": [
      {
        "provider_id": 1001,
        "provider_name": "å¼ å¸ˆå‚…å®¶è£…æœåŠ¡",
        "rating": 4.85,
        "distance": 3.2,
        "estimated_arrival": "30åˆ†é’Ÿ",
        "service_fee": 200.00,
        "available_times": [
          {"date": "2024-01-15", "time": "14:00"},
          {"date": "2024-01-15", "time": "15:00"},
          {"date": "2024-01-16", "time": "09:00"}
        ],
        "match_score": 95
      }
    ]
  }
}
```

#### 3.2 åˆ†é…è®¢å•ç»™æœåŠ¡å•†
```http
POST /v1/providers/{providerId}/orders/assign
Content-Type: application/json
Authorization: Bearer {token}

{
  "order_id": 10001,
  "scheduled_date": "2024-01-15",
  "scheduled_time": "14:00",
  "estimated_duration": 120,
  "service_notes": "å®¢æˆ·è¦æ±‚ä¸Šé—¨æµ‹é‡çª—å¸˜å°ºå¯¸"
}
```

### 4. ç»©æ•ˆè¯„ä¼°ä¸ç»“ç®—

#### 4.1 è·å–æœåŠ¡å•†ç»©æ•ˆæ•°æ®
```http
GET /v1/providers/{providerId}/performance?start_date=2024-01-01&end_date=2024-01-31
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "provider_id": 1001,
    "period": "2024-01",
    "performance_metrics": {
      "total_orders": 25,
      "completed_orders": 24,
      "completion_rate": 96.0,
      "average_rating": 4.8,
      "punctuality_rate": 95.0,
      "customer_satisfaction": 98.0,
      "response_time": 15.5,
      "total_revenue": 6000.00
    },
    "ranking": {
      "overall_rank": 3,
      "category_rank": 2,
      "region_rank": 1
    },
    "improvement_suggestions": [
      "å»ºè®®æé«˜å“åº”é€Ÿåº¦",
      "å¯ä»¥å¢åŠ æœåŠ¡æ—¶é—´æ®µ"
    ]
  }
}
```

#### 4.2 ç”Ÿæˆç»“ç®—å•
```http
POST /v1/providers/{providerId}/settlements
Content-Type: application/json
Authorization: Bearer {token}

{
  "settlement_period": "2024-01",
  "include_bonus": true,
  "notes": "æœˆåº¦ç»“ç®—"
}
```

#### 4.3 ç¡®è®¤ç»“ç®—æ”¯ä»˜
```http
PUT /v1/providers/settlements/{settlementId}/pay
Content-Type: application/json
Authorization: Bearer {token}

{
  "payment_method": "bank_transfer",
  "payment_account": "6222021234567890123",
  "payment_date": "2024-02-01"
}
```

---

## ğŸ¢ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 1. æœåŠ¡å•†æ³¨å†Œä¸è®¤è¯æœåŠ¡

```typescript
// provider-registration.service.ts
export class ProviderRegistrationService {
  constructor(
    private readonly providerRepository: Repository<ServiceProvider>,
    private readonly certificationRepository: Repository<ProviderCertification>,
    private readonly fileService: FileService,
    private readonly notificationService: NotificationService
  ) {}

  // æœåŠ¡å•†æ³¨å†Œç”³è¯·
  async registerProvider(registerDto: ProviderRegisterDto): Promise<ServiceProvider> {
    // 1. éªŒè¯åŸºç¡€ä¿¡æ¯
    await this.validateProviderInfo(registerDto);
    
    // 2. ç”ŸæˆæœåŠ¡å•†ç¼–ç 
    const providerCode = await this.generateProviderCode();
    
    // 3. åˆ›å»ºæœåŠ¡å•†è®°å½•
    const provider = this.providerRepository.create({
      ...registerDto,
      provider_code: providerCode,
      status: 'pending'
    });
    
    const savedProvider = await this.providerRepository.save(provider);
    
    // 4. å‘é€æ³¨å†Œç¡®è®¤é€šçŸ¥
    await this.notificationService.sendRegistrationConfirmation(savedProvider);
    
    // 5. é€šçŸ¥ç®¡ç†å‘˜å®¡æ ¸
    await this.notificationService.notifyAdminForReview(savedProvider);
    
    return savedProvider;
  }

  // ä¸Šä¼ è®¤è¯ææ–™
  async uploadCertification(
    providerId: number,
    certificationDto: CertificationUploadDto,
    file: Express.Multer.File
  ): Promise<ProviderCertification> {
    // 1. éªŒè¯æœåŠ¡å•†å­˜åœ¨
    const provider = await this.providerRepository.findOne({
      where: { id: providerId }
    });
    
    if (!provider) {
      throw new NotFoundException('æœåŠ¡å•†ä¸å­˜åœ¨');
    }
    
    // 2. ä¸Šä¼ æ–‡ä»¶
    const fileUrl = await this.fileService.uploadFile(file, 'certifications');
    
    // 3. åˆ›å»ºè®¤è¯è®°å½•
    const certification = this.certificationRepository.create({
      ...certificationDto,
      provider_id: providerId,
      file_url: fileUrl,
      status: 'pending'
    });
    
    const savedCertification = await this.certificationRepository.save(certification);
    
    // 4. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€è®¤è¯éƒ½å·²ä¸Šä¼ 
    await this.checkCertificationCompleteness(providerId);
    
    return savedCertification;
  }

  // å®¡æ ¸è®¤è¯ææ–™
  async reviewCertification(
    certificationId: number,
    reviewDto: CertificationReviewDto,
    reviewerId: number
  ): Promise<ProviderCertification> {
    const certification = await this.certificationRepository.findOne({
      where: { id: certificationId },
      relations: ['provider']
    });
    
    if (!certification) {
      throw new NotFoundException('è®¤è¯è®°å½•ä¸å­˜åœ¨');
    }
    
    // æ›´æ–°å®¡æ ¸ç»“æœ
    certification.status = reviewDto.status;
    certification.reviewer_id = reviewerId;
    certification.review_time = new Date();
    certification.review_notes = reviewDto.notes;
    
    const updatedCertification = await this.certificationRepository.save(certification);
    
    // å‘é€å®¡æ ¸ç»“æœé€šçŸ¥
    await this.notificationService.sendCertificationReviewResult(
      certification.provider,
      updatedCertification
    );
    
    // å¦‚æœæ‰€æœ‰è®¤è¯éƒ½é€šè¿‡ï¼Œæ›´æ–°æœåŠ¡å•†çŠ¶æ€
    if (reviewDto.status === 'approved') {
      await this.checkAndUpdateProviderStatus(certification.provider_id);
    }
    
    return updatedCertification;
  }

  // ç”ŸæˆæœåŠ¡å•†ç¼–ç 
  private async generateProviderCode(): Promise<string> {
    const year = new Date().getFullYear();
    const month = String(new Date().getMonth() + 1).padStart(2, '0');
    
    const count = await this.providerRepository.count({
      where: {
        created_at: Between(
          new Date(`${year}-${month}-01`),
          new Date(`${year}-${month}-31`)
        )
      }
    });
    
    const sequence = String(count + 1).padStart(3, '0');
    return `SP${year}${month}${sequence}`;
  }

  // æ£€æŸ¥è®¤è¯å®Œæ•´æ€§
  private async checkCertificationCompleteness(providerId: number): Promise<void> {
    const requiredCertifications = ['business_license', 'id_card', 'skill_certificate'];
    
    const approvedCertifications = await this.certificationRepository.find({
      where: {
        provider_id: providerId,
        status: 'approved',
        certification_type: In(requiredCertifications)
      }
    });
    
    if (approvedCertifications.length === requiredCertifications.length) {
      await this.providerRepository.update(providerId, {
        status: 'approved',
        join_date: new Date()
      });
      
      // å‘é€è®¤è¯å®Œæˆé€šçŸ¥
      const provider = await this.providerRepository.findOne({
        where: { id: providerId }
      });
      await this.notificationService.sendCertificationCompleted(provider);
    }
  }
}
```

### 2. æ™ºèƒ½è®¢å•åˆ†é…æœåŠ¡

```typescript
// order-assignment.service.ts
export class OrderAssignmentService {
  constructor(
    private readonly providerRepository: Repository<ServiceProvider>,
    private readonly scheduleRepository: Repository<ProviderSchedule>,
    private readonly serviceRepository: Repository<ProviderService>,
    private readonly geoService: GeoService
  ) {}

  // æ™ºèƒ½åŒ¹é…æœåŠ¡å•†
  async matchProviders(matchDto: ProviderMatchDto): Promise<ProviderMatch[]> {
    // 1. åŸºç¡€ç­›é€‰ï¼šæœåŠ¡ç±»å‹ã€åŒºåŸŸã€çŠ¶æ€
    const baseQuery = this.providerRepository
      .createQueryBuilder('provider')
      .leftJoinAndSelect('provider.services', 'service')
      .leftJoinAndSelect('provider.schedules', 'schedule')
      .where('provider.status = :status', { status: 'approved' })
      .andWhere('provider.provider_type IN (:...types)', {
        types: [matchDto.service_type, 'both']
      });

    // 2. åœ°ç†ä½ç½®ç­›é€‰
    const providers = await this.filterByLocation(baseQuery, matchDto.customer_address);
    
    // 3. æ—¶é—´å¯ç”¨æ€§ç­›é€‰
    const availableProviders = await this.filterByAvailability(
      providers,
      matchDto.preferred_date,
      matchDto.preferred_time
    );
    
    // 4. è®¡ç®—åŒ¹é…åˆ†æ•°
    const scoredProviders = await Promise.all(
      availableProviders.map(provider => this.calculateMatchScore(provider, matchDto))
    );
    
    // 5. æ’åºå¹¶è¿”å›æ¨èç»“æœ
    return scoredProviders
      .sort((a, b) => b.match_score - a.match_score)
      .slice(0, 5);
  }

  // åˆ†é…è®¢å•
  async assignOrder(assignDto: OrderAssignDto): Promise<void> {
    const { provider_id, order_id, scheduled_date, scheduled_time } = assignDto;
    
    // 1. éªŒè¯æœåŠ¡å•†å¯ç”¨æ€§
    await this.validateProviderAvailability(provider_id, scheduled_date, scheduled_time);
    
    // 2. æ›´æ–°æ’ç­è¡¨
    await this.updateProviderSchedule(provider_id, scheduled_date, scheduled_time);
    
    // 3. åˆ›å»ºæœåŠ¡è®¢å•å…³è”
    await this.createProviderOrderAssignment(assignDto);
    
    // 4. å‘é€é€šçŸ¥
    await this.notifyProviderAssignment(provider_id, order_id);
  }

  // è®¡ç®—åŒ¹é…åˆ†æ•°
  private async calculateMatchScore(
    provider: ServiceProvider,
    matchDto: ProviderMatchDto
  ): Promise<ProviderMatch> {
    let score = 0;
    
    // 1. è·ç¦»åˆ†æ•°ï¼ˆ40%æƒé‡ï¼‰
    const distance = await this.geoService.calculateDistance(
      provider.address,
      matchDto.customer_address
    );
    const distanceScore = Math.max(0, 100 - distance * 2);
    score += distanceScore * 0.4;
    
    // 2. è¯„åˆ†åˆ†æ•°ï¼ˆ30%æƒé‡ï¼‰
    const ratingScore = (provider.rating / 5) * 100;
    score += ratingScore * 0.3;
    
    // 3. å®Œæˆç‡åˆ†æ•°ï¼ˆ20%æƒé‡ï¼‰
    const completionRate = (provider.completed_orders / provider.total_orders) * 100;
    score += completionRate * 0.2;
    
    // 4. å“åº”æ—¶é—´åˆ†æ•°ï¼ˆ10%æƒé‡ï¼‰
    const responseScore = this.calculateResponseScore(provider.last_active_at);
    score += responseScore * 0.1;
    
    return {
      provider_id: provider.id,
      provider_name: provider.provider_name,
      rating: provider.rating,
      distance,
      match_score: Math.round(score),
      estimated_arrival: this.calculateEstimatedArrival(distance),
      available_times: await this.getAvailableTimes(provider.id, matchDto.preferred_date)
    };
  }

  // åœ°ç†ä½ç½®ç­›é€‰
  private async filterByLocation(
    query: SelectQueryBuilder<ServiceProvider>,
    customerAddress: CustomerAddress
  ): Promise<ServiceProvider[]> {
    // ä½¿ç”¨åœ°ç†ä½ç½®æŸ¥è¯¢ï¼Œç­›é€‰æœåŠ¡åŠå¾„å†…çš„æœåŠ¡å•†
    return query
      .andWhere(
        `ST_DWithin(
          ST_GeomFromText('POINT(:longitude :latitude)', 4326),
          ST_GeomFromText(CONCAT('POINT(', provider.longitude, ' ', provider.latitude, ')'), 4326),
          provider.service_radius * 1000
        )`,
        {
          longitude: customerAddress.longitude,
          latitude: customerAddress.latitude
        }
      )
      .getMany();
  }

  // æ—¶é—´å¯ç”¨æ€§ç­›é€‰
  private async filterByAvailability(
    providers: ServiceProvider[],
    preferredDate: string,
    preferredTime: string
  ): Promise<ServiceProvider[]> {
    const availableProviders = [];
    
    for (const provider of providers) {
      const schedule = await this.scheduleRepository.findOne({
        where: {
          provider_id: provider.id,
          schedule_date: preferredDate,
          start_time: LessThanOrEqual(preferredTime),
          end_time: MoreThanOrEqual(preferredTime),
          status: 'available'
        }
      });
      
      if (schedule && schedule.current_orders < schedule.max_orders) {
        availableProviders.push(provider);
      }
    }
    
    return availableProviders;
  }
}
```

### 3. ç»©æ•ˆè¯„ä¼°æœåŠ¡

```typescript
// performance-evaluation.service.ts
export class PerformanceEvaluationService {
  constructor(
    private readonly providerRepository: Repository<ServiceProvider>,
    private readonly evaluationRepository: Repository<ProviderEvaluation>,
    private readonly orderRepository: Repository<Order>
  ) {}

  // è®¡ç®—æœåŠ¡å•†ç»©æ•ˆæŒ‡æ ‡
  async calculatePerformanceMetrics(
    providerId: number,
    startDate: Date,
    endDate: Date
  ): Promise<PerformanceMetrics> {
    // 1. è·å–è®¢å•æ•°æ®
    const orders = await this.orderRepository.find({
      where: {
        measure_provider_id: providerId,
        created_at: Between(startDate, endDate)
      },
      relations: ['evaluations']
    });
    
    // 2. è®¡ç®—åŸºç¡€æŒ‡æ ‡
    const totalOrders = orders.length;
    const completedOrders = orders.filter(order => order.status === 'completed').length;
    const completionRate = totalOrders > 0 ? (completedOrders / totalOrders) * 100 : 0;
    
    // 3. è®¡ç®—è¯„åˆ†æŒ‡æ ‡
    const evaluations = orders.flatMap(order => order.evaluations);
    const averageRating = evaluations.length > 0 
      ? evaluations.reduce((sum, eval) => sum + eval.overall_rating, 0) / evaluations.length
      : 0;
    
    // 4. è®¡ç®—å‡†æ—¶ç‡
    const punctualOrders = orders.filter(order => 
      order.actual_start_time <= order.scheduled_start_time
    ).length;
    const punctualityRate = totalOrders > 0 ? (punctualOrders / totalOrders) * 100 : 0;
    
    // 5. è®¡ç®—å®¢æˆ·æ»¡æ„åº¦
    const satisfiedCustomers = evaluations.filter(eval => eval.overall_rating >= 4).length;
    const customerSatisfaction = evaluations.length > 0 
      ? (satisfiedCustomers / evaluations.length) * 100 
      : 0;
    
    // 6. è®¡ç®—å“åº”æ—¶é—´
    const responseTimes = orders.map(order => 
      order.provider_response_time || 0
    );
    const averageResponseTime = responseTimes.length > 0
      ? responseTimes.reduce((sum, time) => sum + time, 0) / responseTimes.length
      : 0;
    
    // 7. è®¡ç®—æ€»æ”¶å…¥
    const totalRevenue = orders
      .filter(order => order.status === 'completed')
      .reduce((sum, order) => sum + (order.service_fee || 0), 0);
    
    return {
      total_orders: totalOrders,
      completed_orders: completedOrders,
      completion_rate: Math.round(completionRate * 100) / 100,
      average_rating: Math.round(averageRating * 100) / 100,
      punctuality_rate: Math.round(punctualityRate * 100) / 100,
      customer_satisfaction: Math.round(customerSatisfaction * 100) / 100,
      response_time: Math.round(averageResponseTime * 100) / 100,
      total_revenue: totalRevenue
    };
  }

  // ç”Ÿæˆç»©æ•ˆæŠ¥å‘Š
  async generatePerformanceReport(
    providerId: number,
    period: string
  ): Promise<PerformanceReport> {
    const [year, month] = period.split('-');
    const startDate = new Date(parseInt(year), parseInt(month) - 1, 1);
    const endDate = new Date(parseInt(year), parseInt(month), 0);
    
    // 1. è®¡ç®—å½“æœŸç»©æ•ˆ
    const currentMetrics = await this.calculatePerformanceMetrics(
      providerId,
      startDate,
      endDate
    );
    
    // 2. è®¡ç®—ä¸ŠæœŸç»©æ•ˆï¼ˆç”¨äºå¯¹æ¯”ï¼‰
    const lastMonthStart = new Date(startDate);
    lastMonthStart.setMonth(lastMonthStart.getMonth() - 1);
    const lastMonthEnd = new Date(endDate);
    lastMonthEnd.setMonth(lastMonthEnd.getMonth() - 1);
    
    const lastMetrics = await this.calculatePerformanceMetrics(
      providerId,
      lastMonthStart,
      lastMonthEnd
    );
    
    // 3. è®¡ç®—æ’å
    const ranking = await this.calculateProviderRanking(providerId, period);
    
    // 4. ç”Ÿæˆæ”¹è¿›å»ºè®®
    const suggestions = this.generateImprovementSuggestions(currentMetrics, lastMetrics);
    
    return {
      provider_id: providerId,
      period,
      performance_metrics: currentMetrics,
      comparison_metrics: lastMetrics,
      ranking,
      improvement_suggestions: suggestions,
      generated_at: new Date()
    };
  }

  // è®¡ç®—æœåŠ¡å•†æ’å
  private async calculateProviderRanking(
    providerId: number,
    period: string
  ): Promise<ProviderRanking> {
    // è·å–åŒç±»å‹æœåŠ¡å•†çš„ç»©æ•ˆæ•°æ®è¿›è¡Œæ’å
    const provider = await this.providerRepository.findOne({
      where: { id: providerId }
    });
    
    if (!provider) {
      throw new NotFoundException('æœåŠ¡å•†ä¸å­˜åœ¨');
    }
    
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æŸ¥è¯¢æ‰€æœ‰åŒç±»å‹æœåŠ¡å•†çš„ç»©æ•ˆæ•°æ®
    return {
      overall_rank: 3,
      category_rank: 2,
      region_rank: 1,
      total_providers: 50
    };
  }

  // ç”Ÿæˆæ”¹è¿›å»ºè®®
  private generateImprovementSuggestions(
    current: PerformanceMetrics,
    last: PerformanceMetrics
  ): string[] {
    const suggestions: string[] = [];
    
    if (current.completion_rate < 95) {
      suggestions.push('å»ºè®®æé«˜è®¢å•å®Œæˆç‡ï¼ŒåŠ å¼ºæ—¶é—´ç®¡ç†');
    }
    
    if (current.average_rating < 4.5) {
      suggestions.push('å»ºè®®æå‡æœåŠ¡è´¨é‡ï¼Œå…³æ³¨å®¢æˆ·åé¦ˆ');
    }
    
    if (current.punctuality_rate < 90) {
      suggestions.push('å»ºè®®æé«˜å‡†æ—¶æ€§ï¼Œåˆç†å®‰æ’è¡Œç¨‹');
    }
    
    if (current.response_time > 30) {
      suggestions.push('å»ºè®®æé«˜å“åº”é€Ÿåº¦ï¼ŒåŠæ—¶å›å¤å®¢æˆ·');
    }
    
    if (current.completion_rate < last.completion_rate) {
      suggestions.push('å®Œæˆç‡æœ‰æ‰€ä¸‹é™ï¼Œéœ€è¦åˆ†æåŸå› å¹¶æ”¹è¿›');
    }
    
    return suggestions;
  }
}
```

### 4. ç»“ç®—ç®¡ç†æœåŠ¡

```typescript
// settlement.service.ts
export class SettlementService {
  constructor(
    private readonly settlementRepository: Repository<ProviderSettlement>,
    private readonly orderRepository: Repository<Order>,
    private readonly providerRepository: Repository<ServiceProvider>,
    private readonly paymentService: PaymentService
  ) {}

  // ç”Ÿæˆæœˆåº¦ç»“ç®—å•
  async generateMonthlySettlement(
    providerId: number,
    settlementPeriod: string
  ): Promise<ProviderSettlement> {
    // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç»“ç®—å•
    const existingSettlement = await this.settlementRepository.findOne({
      where: { provider_id: providerId, settlement_period: settlementPeriod }
    });
    
    if (existingSettlement) {
      throw new ConflictException('è¯¥æœŸé—´çš„ç»“ç®—å•å·²å­˜åœ¨');
    }
    
    // 2. è·å–ç»“ç®—æœŸé—´çš„è®¢å•æ•°æ®
    const [year, month] = settlementPeriod.split('-');
    const startDate = new Date(parseInt(year), parseInt(month) - 1, 1);
    const endDate = new Date(parseInt(year), parseInt(month), 0);
    
    const orders = await this.orderRepository.find({
      where: {
        measure_provider_id: providerId,
        status: 'completed',
        completed_at: Between(startDate, endDate)
      }
    });
    
    // 3. è®¡ç®—ç»“ç®—é‡‘é¢
    const settlementData = this.calculateSettlementAmount(orders);
    
    // 4. åˆ›å»ºç»“ç®—è®°å½•
    const settlement = this.settlementRepository.create({
      provider_id: providerId,
      settlement_period: settlementPeriod,
      ...settlementData,
      status: 'pending'
    });
    
    return await this.settlementRepository.save(settlement);
  }

  // è®¡ç®—ç»“ç®—é‡‘é¢
  private calculateSettlementAmount(orders: Order[]): Partial<ProviderSettlement> {
    const totalOrders = orders.length;
    const completedOrders = orders.filter(order => order.status === 'completed').length;
    
    // è®¡ç®—æœåŠ¡è´¹æ€»é¢
    const totalAmount = orders.reduce((sum, order) => sum + (order.service_fee || 0), 0);
    
    // è®¡ç®—å¹³å°è´¹ç”¨ï¼ˆå‡è®¾ä¸ºæœåŠ¡è´¹çš„10%ï¼‰
    const platformFee = totalAmount * 0.1;
    
    // è®¡ç®—æ‰£æ¬¾é‡‘é¢ï¼ˆè´¨é‡é—®é¢˜ã€æŠ•è¯‰ç­‰ï¼‰
    const deductionAmount = this.calculateDeductions(orders);
    
    // è®¡ç®—å¥–åŠ±é‡‘é¢ï¼ˆä¼˜è´¨æœåŠ¡å¥–åŠ±ï¼‰
    const bonusAmount = this.calculateBonus(orders);
    
    // æœ€ç»ˆç»“ç®—é‡‘é¢
    const settlementAmount = totalAmount - platformFee - deductionAmount + bonusAmount;
    
    return {
      total_orders: totalOrders,
      completed_orders: completedOrders,
      total_amount: totalAmount,
      service_fee: totalAmount,
      platform_fee: platformFee,
      deduction_amount: deductionAmount,
      bonus_amount: bonusAmount,
      settlement_amount: settlementAmount
    };
  }

  // è®¡ç®—æ‰£æ¬¾é‡‘é¢
  private calculateDeductions(orders: Order[]): number {
    // æ ¹æ®æŠ•è¯‰ã€é€€æ¬¾ç­‰æƒ…å†µè®¡ç®—æ‰£æ¬¾
    return orders.reduce((sum, order) => {
      let deduction = 0;
      
      // å¦‚æœæœ‰æŠ•è¯‰ä¸”æŠ•è¯‰æˆç«‹ï¼Œæ‰£é™¤ä¸€å®šè´¹ç”¨
      if (order.complaint_status === 'valid') {
        deduction += order.service_fee * 0.2; // æ‰£é™¤20%
      }
      
      // å¦‚æœæœ‰é€€æ¬¾ï¼Œæ‰£é™¤ç›¸åº”é‡‘é¢
      if (order.refund_amount > 0) {
        deduction += order.refund_amount;
      }
      
      return sum + deduction;
    }, 0);
  }

  // è®¡ç®—å¥–åŠ±é‡‘é¢
  private calculateBonus(orders: Order[]): number {
    // æ ¹æ®æœåŠ¡è´¨é‡ã€å®¢æˆ·è¯„ä»·ç­‰è®¡ç®—å¥–åŠ±
    const highRatingOrders = orders.filter(order => 
      order.average_rating >= 4.8
    );
    
    // é«˜è¯„åˆ†è®¢å•ç»™äºˆå¥–åŠ±
    return highRatingOrders.length * 50; // æ¯ä¸ªé«˜è¯„åˆ†è®¢å•å¥–åŠ±50å…ƒ
  }

  // ç¡®è®¤ç»“ç®—å¹¶æ”¯ä»˜
  async confirmAndPaySettlement(
    settlementId: number,
    paymentDto: SettlementPaymentDto
  ): Promise<ProviderSettlement> {
    const settlement = await this.settlementRepository.findOne({
      where: { id: settlementId },
      relations: ['provider']
    });
    
    if (!settlement) {
      throw new NotFoundException('ç»“ç®—å•ä¸å­˜åœ¨');
    }
    
    if (settlement.status !== 'confirmed') {
      throw new BadRequestException('ç»“ç®—å•çŠ¶æ€ä¸æ­£ç¡®');
    }
    
    try {
      // 1. æ‰§è¡Œæ”¯ä»˜
      const paymentResult = await this.paymentService.processPayment({
        amount: settlement.settlement_amount,
        recipient: paymentDto.payment_account,
        payment_method: paymentDto.payment_method,
        description: `æœåŠ¡å•†ç»“ç®—-${settlement.settlement_period}`
      });
      
      // 2. æ›´æ–°ç»“ç®—çŠ¶æ€
      settlement.status = 'paid';
      settlement.payment_date = new Date();
      settlement.payment_method = paymentDto.payment_method;
      settlement.payment_account = paymentDto.payment_account;
      
      const updatedSettlement = await this.settlementRepository.save(settlement);
      
      // 3. å‘é€æ”¯ä»˜é€šçŸ¥
      await this.notificationService.sendPaymentNotification(
        settlement.provider,
        updatedSettlement
      );
      
      return updatedSettlement;
      
    } catch (error) {
      // æ”¯ä»˜å¤±è´¥ï¼Œè®°å½•é”™è¯¯
      settlement.status = 'disputed';
      settlement.notes = `æ”¯ä»˜å¤±è´¥: ${error.message}`;
      await this.settlementRepository.save(settlement);
      
      throw new InternalServerErrorException('æ”¯ä»˜å¤„ç†å¤±è´¥');
    }
  }
}
```

---

## ğŸ“± å‰ç«¯ç•Œé¢è®¾è®¡

### 1. æœåŠ¡å•†ç®¡ç†åå°

#### 1.1 æœåŠ¡å•†åˆ—è¡¨é¡µé¢
- **ç­›é€‰åŠŸèƒ½**ï¼šæŒ‰æœåŠ¡å•†ç±»å‹ã€çŠ¶æ€ã€åœ°åŒºã€è¯„åˆ†ç­‰ç­›é€‰
- **æœç´¢åŠŸèƒ½**ï¼šæ”¯æŒæŒ‰æœåŠ¡å•†åç§°ã€ç¼–ç ã€è”ç³»äººæœç´¢
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡å®¡æ ¸ã€æ‰¹é‡å¯¼å‡ºç­‰
- **çŠ¶æ€ç®¡ç†**ï¼šç›´è§‚æ˜¾ç¤ºæœåŠ¡å•†çŠ¶æ€ï¼Œæ”¯æŒå¿«é€ŸçŠ¶æ€å˜æ›´

#### 1.2 æœåŠ¡å•†è¯¦æƒ…é¡µé¢
- **åŸºç¡€ä¿¡æ¯**ï¼šå±•ç¤ºæœåŠ¡å•†çš„åŸºæœ¬ä¿¡æ¯å’Œè”ç³»æ–¹å¼
- **è®¤è¯çŠ¶æ€**ï¼šæ˜¾ç¤ºå„é¡¹è®¤è¯çš„çŠ¶æ€å’Œæœ‰æ•ˆæœŸ
- **æœåŠ¡èƒ½åŠ›**ï¼šå±•ç¤ºæœåŠ¡å•†çš„æŠ€èƒ½ç­‰çº§å’ŒæœåŠ¡èŒƒå›´
- **ç»©æ•ˆæ•°æ®**ï¼šå›¾è¡¨å±•ç¤ºæœåŠ¡å•†çš„ç»©æ•ˆæŒ‡æ ‡
- **è®¢å•å†å²**ï¼šåˆ—è¡¨å±•ç¤ºå†å²è®¢å•å’Œè¯„ä»·

#### 1.3 è®¤è¯å®¡æ ¸é¡µé¢
- **ææ–™é¢„è§ˆ**ï¼šæ”¯æŒåœ¨çº¿é¢„è§ˆè®¤è¯ææ–™
- **å®¡æ ¸æµç¨‹**ï¼šæ¸…æ™°çš„å®¡æ ¸æ­¥éª¤å’ŒçŠ¶æ€è·Ÿè¸ª
- **æ‰¹æ³¨åŠŸèƒ½**ï¼šæ”¯æŒåœ¨ææ–™ä¸Šæ·»åŠ å®¡æ ¸æ‰¹æ³¨
- **æ‰¹é‡å®¡æ ¸**ï¼šæ”¯æŒæ‰¹é‡å¤„ç†ç›¸åŒç±»å‹çš„è®¤è¯

### 2. æœåŠ¡å•†ç§»åŠ¨ç«¯åº”ç”¨

#### 2.1 æœåŠ¡å•†å·¥ä½œå°
- **ä»Šæ—¥è®¢å•**ï¼šæ˜¾ç¤ºå½“æ—¥çš„æœåŠ¡è®¢å•
- **æ”¶å…¥ç»Ÿè®¡**ï¼šå®æ—¶æ˜¾ç¤ºæ”¶å…¥æ•°æ®
- **è¯„ä»·ç®¡ç†**ï¼šæŸ¥çœ‹å’Œå›å¤å®¢æˆ·è¯„ä»·
- **æ’ç­ç®¡ç†**ï¼šè®¾ç½®å’Œè°ƒæ•´å·¥ä½œæ—¶é—´

#### 2.2 è®¢å•ç®¡ç†
- **è®¢å•æ¥æ”¶**ï¼šæ–°è®¢å•æ¨é€å’Œå¿«é€Ÿæ¥å•
- **è®¢å•è¯¦æƒ…**ï¼šå®Œæ•´çš„è®¢å•ä¿¡æ¯å’Œå®¢æˆ·è”ç³»æ–¹å¼
- **æœåŠ¡è®°å½•**ï¼šè®°å½•æœåŠ¡è¿‡ç¨‹å’Œä¸Šä¼ æœåŠ¡ç…§ç‰‡
- **å®Œæˆç¡®è®¤**ï¼šæœåŠ¡å®Œæˆåçš„ç¡®è®¤å’Œç­¾å

---

## ğŸ“Š æ•°æ®åˆ†æä¸ç›‘æ§

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§

#### 1.1 æœåŠ¡å•†æŒ‡æ ‡
- **æ³¨å†Œè½¬åŒ–ç‡**ï¼šæ³¨å†Œç”³è¯·åˆ°è®¤è¯é€šè¿‡çš„è½¬åŒ–ç‡
- **æ´»è·ƒåº¦**ï¼šæœåŠ¡å•†çš„æ´»è·ƒç¨‹åº¦å’Œæ¥å•é¢‘ç‡
- **æœåŠ¡è´¨é‡**ï¼šå¹³å‡è¯„åˆ†ã€æŠ•è¯‰ç‡ã€å®Œæˆç‡
- **åœ°åŸŸåˆ†å¸ƒ**ï¼šæœåŠ¡å•†åœ¨å„åœ°åŒºçš„åˆ†å¸ƒæƒ…å†µ

#### 1.2 ä¸šåŠ¡æŒ‡æ ‡
- **è®¢å•åˆ†é…æ•ˆç‡**ï¼šè®¢å•åˆ†é…çš„æˆåŠŸç‡å’Œå“åº”æ—¶é—´
- **æœåŠ¡è¦†ç›–ç‡**ï¼šå„åœ°åŒºçš„æœåŠ¡è¦†ç›–æƒ…å†µ
- **å®¢æˆ·æ»¡æ„åº¦**ï¼šæ•´ä½“çš„å®¢æˆ·æ»¡æ„åº¦è¶‹åŠ¿
- **æ”¶å…¥åˆ†æ**ï¼šæœåŠ¡å•†æ”¶å…¥åˆ†å¸ƒå’Œå¢é•¿è¶‹åŠ¿

### 2. æ™ºèƒ½åˆ†æ

#### 2.1 æœåŠ¡å•†ç”»åƒåˆ†æ
- **èƒ½åŠ›æ¨¡å‹**ï¼šåŸºäºå†å²æ•°æ®æ„å»ºæœåŠ¡å•†èƒ½åŠ›æ¨¡å‹
- **è¡Œä¸ºåˆ†æ**ï¼šåˆ†ææœåŠ¡å•†çš„å·¥ä½œæ¨¡å¼å’Œåå¥½
- **é£é™©è¯„ä¼°**ï¼šè¯†åˆ«é«˜é£é™©æœåŠ¡å•†å’Œæ½œåœ¨é—®é¢˜
- **æˆé•¿è½¨è¿¹**ï¼šè·Ÿè¸ªæœåŠ¡å•†çš„æˆé•¿å’Œå‘å±•è·¯å¾„

#### 2.2 é¢„æµ‹åˆ†æ
- **éœ€æ±‚é¢„æµ‹**ï¼šé¢„æµ‹å„åœ°åŒºçš„æœåŠ¡éœ€æ±‚
- **å®¹é‡è§„åˆ’**ï¼šé¢„æµ‹æœåŠ¡å•†å®¹é‡éœ€æ±‚
- **æµå¤±é¢„è­¦**ï¼šè¯†åˆ«å¯èƒ½æµå¤±çš„æœåŠ¡å•†
- **è´¨é‡é¢„æµ‹**ï¼šé¢„æµ‹æœåŠ¡è´¨é‡è¶‹åŠ¿

---

## ğŸ”’ å®‰å…¨ä¸æƒé™æ§åˆ¶

### 1. æ•°æ®å®‰å…¨
- **æ•æ„Ÿä¿¡æ¯åŠ å¯†**ï¼šèº«ä»½è¯å·ã€é“¶è¡Œè´¦æˆ·ç­‰æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- **è®¿é—®æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ•°æ®è®¿é—®å’Œæ“ä½œæ—¥å¿—
- **æ•°æ®è„±æ•**ï¼šåœ¨éç”Ÿäº§ç¯å¢ƒä¸­å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œè„±æ•
- **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½é‡è¦æ•°æ®

### 2. æƒé™ç®¡ç†
- **è§’è‰²æƒé™**ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼ˆRBACï¼‰
- **æ•°æ®æƒé™**ï¼šåŸºäºæ•°æ®èŒƒå›´çš„æƒé™æ§åˆ¶
- **æ“ä½œæƒé™**ï¼šç»†ç²’åº¦çš„æ“ä½œæƒé™æ§åˆ¶
- **å®¡è®¡è¿½è¸ª**ï¼šå®Œæ•´çš„æ“ä½œå®¡è®¡è¿½è¸ª

---

## ğŸ“ æ€»ç»“

æœåŠ¡å•†ç®¡ç†æ¨¡å—æ˜¯L2Cç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡å®Œå–„çš„æœåŠ¡å•†ç”Ÿæ€ç®¡ç†ï¼Œç¡®ä¿ä¸ºå®¢æˆ·æä¾›ä¼˜è´¨çš„æœåŠ¡ä½“éªŒã€‚æœ¬è®¾è®¡æ–‡æ¡£æ¶µç›–äº†ï¼š

1. **å®Œæ•´çš„æ•°æ®æ¨¡å‹**ï¼šæ”¯æŒæœåŠ¡å•†å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. **æ ‡å‡†åŒ–APIæ¥å£**ï¼šæä¾›ç»Ÿä¸€çš„æœåŠ¡å•†ç®¡ç†æ¥å£
3. **æ™ºèƒ½åˆ†é…ç®—æ³•**ï¼šåŸºäºå¤šç»´åº¦çš„æ™ºèƒ½è®¢å•åˆ†é…
4. **ç»©æ•ˆè¯„ä¼°ä½“ç³»**ï¼šç§‘å­¦çš„æœåŠ¡å•†ç»©æ•ˆè¯„ä¼°æœºåˆ¶
5. **ç»“ç®—ç®¡ç†ç³»ç»Ÿ**ï¼šé€æ˜çš„è´¹ç”¨ç»“ç®—å’Œæ”¯ä»˜æµç¨‹
6. **ç§»åŠ¨ç«¯æ”¯æŒ**ï¼šä¾¿æ·çš„ç§»åŠ¨ç«¯æœåŠ¡å•†åº”ç”¨
7. **æ•°æ®åˆ†æèƒ½åŠ›**ï¼šæ·±å…¥çš„ä¸šåŠ¡æ•°æ®åˆ†æå’Œæ´å¯Ÿ
8. **å®‰å…¨ä¿éšœæœºåˆ¶**ï¼šå…¨é¢çš„æ•°æ®å®‰å…¨å’Œæƒé™æ§åˆ¶

é€šè¿‡è¿™ä¸ªå®Œæ•´çš„æœåŠ¡å•†ç®¡ç†æ¨¡å—ï¼ŒL2Cç³»ç»Ÿèƒ½å¤Ÿæœ‰æ•ˆç®¡ç†æœåŠ¡å•†èµ„æºï¼Œæé«˜æœåŠ¡è´¨é‡ï¼Œä¼˜åŒ–å®¢æˆ·ä½“éªŒï¼Œå®ç°å¯æŒç»­çš„ä¸šåŠ¡å¢é•¿ã€‚
