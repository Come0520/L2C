# ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿ - æŠ¥è¡¨åˆ†ææ¨¡å—è®¾è®¡

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**é¡¹ç›®åç§°ï¼š** ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»ŸæŠ¥è¡¨åˆ†ææ¨¡å—  
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2024å¹´  
**è®¾è®¡ç›®æ ‡ï¼š** æ„å»ºå…¨é¢çš„æ•°æ®åˆ†æå’ŒæŠ¥è¡¨ç³»ç»Ÿï¼Œä¸ºä¸šåŠ¡å†³ç­–æä¾›æ•°æ®æ”¯æŒ  

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

### 1. æ¨¡å—ç›®æ ‡
- **ä¸šåŠ¡åˆ†æ**ï¼šæä¾›å…¨é¢çš„ä¸šåŠ¡æ•°æ®åˆ†æå’Œæ´å¯Ÿ
- **å®æ—¶ç›‘æ§**ï¼šå®æ—¶ç›‘æ§å…³é”®ä¸šåŠ¡æŒ‡æ ‡å’Œç³»ç»ŸçŠ¶æ€
- **æŠ¥è¡¨ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆå„ç±»ä¸šåŠ¡æŠ¥è¡¨å’Œç»Ÿè®¡æŠ¥å‘Š
- **æ•°æ®å¯è§†åŒ–**ï¼šç›´è§‚çš„å›¾è¡¨å’Œä»ªè¡¨æ¿å±•ç¤º
- **é¢„æµ‹åˆ†æ**ï¼šåŸºäºå†å²æ•°æ®çš„è¶‹åŠ¿é¢„æµ‹å’Œé¢„è­¦
- **è‡ªå®šä¹‰æŠ¥è¡¨**ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æŠ¥è¡¨å’Œåˆ†æç»´åº¦

### 2. æŠ¥è¡¨ç±»å‹
- **é”€å”®æŠ¥è¡¨**ï¼šé”€å”®ä¸šç»©ã€è®¢å•åˆ†æã€å®¢æˆ·åˆ†æ
- **è¿è¥æŠ¥è¡¨**ï¼šæœåŠ¡å•†ç»©æ•ˆã€è®¢å•æµè½¬ã€å®¢æˆ·æ»¡æ„åº¦
- **è´¢åŠ¡æŠ¥è¡¨**ï¼šæ”¶å…¥åˆ†æã€æˆæœ¬åˆ†æã€åˆ©æ¶¦åˆ†æ
- **å¸‚åœºæŠ¥è¡¨**ï¼šå¸‚åœºè¶‹åŠ¿ã€ç«å“åˆ†æã€ç”¨æˆ·è¡Œä¸º
- **ç®¡ç†æŠ¥è¡¨**ï¼šKPIç›‘æ§ã€å¼‚å¸¸é¢„è­¦ã€å†³ç­–æ”¯æŒ

---

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### 1. æŠ¥è¡¨é…ç½®è¡¨

#### 1.1 report_templatesï¼ˆæŠ¥è¡¨æ¨¡æ¿è¡¨ï¼‰
```sql
CREATE TABLE report_templates (
  id BIGSERIAL PRIMARY KEY,
  template_code VARCHAR(50) UNIQUE NOT NULL COMMENT 'æ¨¡æ¿ç¼–ç ',
  template_name VARCHAR(100) NOT NULL COMMENT 'æ¨¡æ¿åç§°',
  template_type ENUM('sales', 'operation', 'finance', 'market', 'management') NOT NULL COMMENT 'æŠ¥è¡¨ç±»å‹',
  category VARCHAR(50) NOT NULL COMMENT 'æŠ¥è¡¨åˆ†ç±»',
  description TEXT COMMENT 'æŠ¥è¡¨æè¿°',
  data_source JSON NOT NULL COMMENT 'æ•°æ®æºé…ç½®',
  query_config JSON NOT NULL COMMENT 'æŸ¥è¯¢é…ç½®',
  chart_config JSON COMMENT 'å›¾è¡¨é…ç½®',
  layout_config JSON COMMENT 'å¸ƒå±€é…ç½®',
  filter_config JSON COMMENT 'ç­›é€‰å™¨é…ç½®',
  schedule_config JSON COMMENT 'è°ƒåº¦é…ç½®',
  is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿæ¨¡æ¿',
  is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
  creator_id BIGINT COMMENT 'åˆ›å»ºäººID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_template_code (template_code),
  INDEX idx_template_type (template_type),
  INDEX idx_category (category),
  INDEX idx_is_active (is_active),
  INDEX idx_creator_id (creator_id)
) COMMENT 'æŠ¥è¡¨æ¨¡æ¿è¡¨';
```

#### 1.2 report_instancesï¼ˆæŠ¥è¡¨å®ä¾‹è¡¨ï¼‰
```sql
CREATE TABLE report_instances (
  id BIGSERIAL PRIMARY KEY,
  template_id BIGINT NOT NULL COMMENT 'æ¨¡æ¿ID',
  instance_name VARCHAR(100) NOT NULL COMMENT 'å®ä¾‹åç§°',
  parameters JSON COMMENT 'æŠ¥è¡¨å‚æ•°',
  filter_values JSON COMMENT 'ç­›é€‰æ¡ä»¶å€¼',
  data_range JSON COMMENT 'æ•°æ®èŒƒå›´',
  status ENUM('generating', 'completed', 'failed', 'expired') DEFAULT 'generating' COMMENT 'çŠ¶æ€',
  file_url VARCHAR(500) COMMENT 'æŠ¥è¡¨æ–‡ä»¶URL',
  file_size BIGINT COMMENT 'æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
  generation_time INTEGER COMMENT 'ç”Ÿæˆè€—æ—¶ï¼ˆç§’ï¼‰',
  error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
  creator_id BIGINT COMMENT 'åˆ›å»ºäººID',
  generated_at TIMESTAMP COMMENT 'ç”Ÿæˆæ—¶é—´',
  expires_at TIMESTAMP COMMENT 'è¿‡æœŸæ—¶é—´',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (template_id) REFERENCES report_templates(id),
  INDEX idx_template_id (template_id),
  INDEX idx_status (status),
  INDEX idx_creator_id (creator_id),
  INDEX idx_generated_at (generated_at),
  INDEX idx_expires_at (expires_at)
) COMMENT 'æŠ¥è¡¨å®ä¾‹è¡¨';
```

#### 1.3 dashboard_configsï¼ˆä»ªè¡¨æ¿é…ç½®è¡¨ï¼‰
```sql
CREATE TABLE dashboard_configs (
  id BIGSERIAL PRIMARY KEY,
  dashboard_code VARCHAR(50) UNIQUE NOT NULL COMMENT 'ä»ªè¡¨æ¿ç¼–ç ',
  dashboard_name VARCHAR(100) NOT NULL COMMENT 'ä»ªè¡¨æ¿åç§°',
  dashboard_type ENUM('overview', 'sales', 'operation', 'finance', 'custom') NOT NULL COMMENT 'ä»ªè¡¨æ¿ç±»å‹',
  description TEXT COMMENT 'æè¿°',
  layout_config JSON NOT NULL COMMENT 'å¸ƒå±€é…ç½®',
  widget_configs JSON NOT NULL COMMENT 'ç»„ä»¶é…ç½®',
  refresh_interval INTEGER DEFAULT 300 COMMENT 'åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰',
  is_public BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å…¬å¼€',
  is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
  creator_id BIGINT COMMENT 'åˆ›å»ºäººID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_dashboard_code (dashboard_code),
  INDEX idx_dashboard_type (dashboard_type),
  INDEX idx_is_public (is_public),
  INDEX idx_creator_id (creator_id)
) COMMENT 'ä»ªè¡¨æ¿é…ç½®è¡¨';
```

#### 1.4 data_metricsï¼ˆæ•°æ®æŒ‡æ ‡è¡¨ï¼‰
```sql
CREATE TABLE data_metrics (
  id BIGSERIAL PRIMARY KEY,
  metric_code VARCHAR(50) UNIQUE NOT NULL COMMENT 'æŒ‡æ ‡ç¼–ç ',
  metric_name VARCHAR(100) NOT NULL COMMENT 'æŒ‡æ ‡åç§°',
  metric_type ENUM('count', 'sum', 'avg', 'rate', 'ratio') NOT NULL COMMENT 'æŒ‡æ ‡ç±»å‹',
  category VARCHAR(50) NOT NULL COMMENT 'æŒ‡æ ‡åˆ†ç±»',
  description TEXT COMMENT 'æŒ‡æ ‡æè¿°',
  calculation_formula TEXT NOT NULL COMMENT 'è®¡ç®—å…¬å¼',
  data_source VARCHAR(100) NOT NULL COMMENT 'æ•°æ®æº',
  unit VARCHAR(20) COMMENT 'å•ä½',
  decimal_places INTEGER DEFAULT 2 COMMENT 'å°æ•°ä½æ•°',
  threshold_config JSON COMMENT 'é˜ˆå€¼é…ç½®',
  is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_metric_code (metric_code),
  INDEX idx_metric_type (metric_type),
  INDEX idx_category (category),
  INDEX idx_is_active (is_active)
) COMMENT 'æ•°æ®æŒ‡æ ‡è¡¨';
```

#### 1.5 metric_valuesï¼ˆæŒ‡æ ‡å€¼è¡¨ï¼‰
```sql
CREATE TABLE metric_values (
  id BIGSERIAL PRIMARY KEY,
  metric_id BIGINT NOT NULL COMMENT 'æŒ‡æ ‡ID',
  dimension_values JSON COMMENT 'ç»´åº¦å€¼',
  metric_value DECIMAL(20,6) NOT NULL COMMENT 'æŒ‡æ ‡å€¼',
  calculation_date DATE NOT NULL COMMENT 'è®¡ç®—æ—¥æœŸ',
  calculation_hour INTEGER COMMENT 'è®¡ç®—å°æ—¶ï¼ˆ0-23ï¼‰',
  data_version INTEGER DEFAULT 1 COMMENT 'æ•°æ®ç‰ˆæœ¬',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (metric_id) REFERENCES data_metrics(id),
  UNIQUE KEY uk_metric_dimension_date (metric_id, dimension_values, calculation_date, calculation_hour),
  INDEX idx_metric_id (metric_id),
  INDEX idx_calculation_date (calculation_date),
  INDEX idx_metric_value (metric_value)
) COMMENT 'æŒ‡æ ‡å€¼è¡¨';
```

#### 1.6 report_subscriptionsï¼ˆæŠ¥è¡¨è®¢é˜…è¡¨ï¼‰
```sql
CREATE TABLE report_subscriptions (
  id BIGSERIAL PRIMARY KEY,
  template_id BIGINT NOT NULL COMMENT 'æ¨¡æ¿ID',
  user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  subscription_name VARCHAR(100) NOT NULL COMMENT 'è®¢é˜…åç§°',
  parameters JSON COMMENT 'æŠ¥è¡¨å‚æ•°',
  schedule_type ENUM('daily', 'weekly', 'monthly', 'quarterly') NOT NULL COMMENT 'è°ƒåº¦ç±»å‹',
  schedule_config JSON NOT NULL COMMENT 'è°ƒåº¦é…ç½®',
  delivery_method ENUM('email', 'system', 'both') DEFAULT 'email' COMMENT 'æ¨é€æ–¹å¼',
  delivery_config JSON COMMENT 'æ¨é€é…ç½®',
  is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
  last_execution_at TIMESTAMP COMMENT 'æœ€åæ‰§è¡Œæ—¶é—´',
  next_execution_at TIMESTAMP COMMENT 'ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (template_id) REFERENCES report_templates(id),
  INDEX idx_template_id (template_id),
  INDEX idx_user_id (user_id),
  INDEX idx_schedule_type (schedule_type),
  INDEX idx_is_active (is_active),
  INDEX idx_next_execution_at (next_execution_at)
) COMMENT 'æŠ¥è¡¨è®¢é˜…è¡¨';
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### 1. æŠ¥è¡¨æ¨¡æ¿ç®¡ç†

#### 1.1 åˆ›å»ºæŠ¥è¡¨æ¨¡æ¿
```http
POST /v1/reports/templates
Content-Type: application/json
Authorization: Bearer {token}

{
  "template_name": "æœˆåº¦é”€å”®åˆ†ææŠ¥è¡¨",
  "template_type": "sales",
  "category": "monthly_analysis",
  "description": "æœˆåº¦é”€å”®æ•°æ®åˆ†æï¼ŒåŒ…å«è®¢å•é‡ã€é”€å”®é¢ã€å®¢æˆ·åˆ†æç­‰",
  "data_source": {
    "tables": ["orders", "customers", "products"],
    "joins": [
      {
        "table": "customers",
        "on": "orders.customer_id = customers.id"
      }
    ]
  },
  "query_config": {
    "select": [
      "DATE_FORMAT(orders.created_at, '%Y-%m') as month",
      "COUNT(*) as order_count",
      "SUM(orders.total_amount) as total_sales",
      "COUNT(DISTINCT orders.customer_id) as customer_count"
    ],
    "where": [
      "orders.status = 'completed'",
      "orders.created_at >= :start_date",
      "orders.created_at <= :end_date"
    ],
    "group_by": ["DATE_FORMAT(orders.created_at, '%Y-%m')"],
    "order_by": ["month DESC"]
  },
  "chart_config": {
    "charts": [
      {
        "type": "line",
        "title": "æœˆåº¦é”€å”®è¶‹åŠ¿",
        "x_axis": "month",
        "y_axis": "total_sales"
      },
      {
        "type": "bar",
        "title": "æœˆåº¦è®¢å•é‡",
        "x_axis": "month",
        "y_axis": "order_count"
      }
    ]
  },
  "filter_config": {
    "filters": [
      {
        "name": "date_range",
        "type": "date_range",
        "label": "æ—¥æœŸèŒƒå›´",
        "required": true
      },
      {
        "name": "product_category",
        "type": "select",
        "label": "äº§å“åˆ†ç±»",
        "options": "dynamic"
      }
    ]
  }
}
```

#### 1.2 è·å–æŠ¥è¡¨æ¨¡æ¿åˆ—è¡¨
```http
GET /v1/reports/templates?page=1&page_size=20&template_type=sales&category=monthly_analysis
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "items": [
      {
        "id": 1,
        "template_code": "RPT_SALES_MONTHLY_001",
        "template_name": "æœˆåº¦é”€å”®åˆ†ææŠ¥è¡¨",
        "template_type": "sales",
        "category": "monthly_analysis",
        "description": "æœˆåº¦é”€å”®æ•°æ®åˆ†æ",
        "is_system": true,
        "is_active": true,
        "creator_name": "ç³»ç»Ÿç®¡ç†å‘˜",
        "created_at": "2024-01-01T00:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 1,
      "total_pages": 1
    }
  }
}
```

### 2. æŠ¥è¡¨ç”Ÿæˆä¸ç®¡ç†

#### 2.1 ç”ŸæˆæŠ¥è¡¨
```http
POST /v1/reports/generate
Content-Type: application/json
Authorization: Bearer {token}

{
  "template_id": 1,
  "instance_name": "2024å¹´1æœˆé”€å”®æŠ¥è¡¨",
  "parameters": {
    "start_date": "2024-01-01",
    "end_date": "2024-01-31",
    "product_category": "curtain"
  },
  "output_format": "excel",
  "async": true
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "æŠ¥è¡¨ç”Ÿæˆä»»åŠ¡å·²æäº¤",
  "data": {
    "instance_id": 1001,
    "task_id": "task_20240101_001",
    "estimated_time": 120,
    "status": "generating"
  }
}
```

#### 2.2 è·å–æŠ¥è¡¨ç”ŸæˆçŠ¶æ€
```http
GET /v1/reports/instances/{instanceId}/status
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "instance_id": 1001,
    "status": "completed",
    "progress": 100,
    "file_url": "https://example.com/reports/sales_202401.xlsx",
    "file_size": 2048576,
    "generation_time": 95,
    "generated_at": "2024-01-01T10:30:00Z"
  }
}
```

#### 2.3 ä¸‹è½½æŠ¥è¡¨
```http
GET /v1/reports/instances/{instanceId}/download
Authorization: Bearer {token}
```

### 3. ä»ªè¡¨æ¿ç®¡ç†

#### 3.1 åˆ›å»ºä»ªè¡¨æ¿
```http
POST /v1/dashboards
Content-Type: application/json
Authorization: Bearer {token}

{
  "dashboard_name": "é”€å”®æ€»è§ˆä»ªè¡¨æ¿",
  "dashboard_type": "sales",
  "description": "é”€å”®ä¸šåŠ¡æ€»è§ˆï¼ŒåŒ…å«å…³é”®æŒ‡æ ‡å’Œè¶‹åŠ¿åˆ†æ",
  "layout_config": {
    "grid": {
      "columns": 12,
      "rows": 8,
      "cell_height": 60
    }
  },
  "widget_configs": [
    {
      "id": "widget_1",
      "type": "metric_card",
      "title": "ä»Šæ—¥é”€å”®é¢",
      "position": {"x": 0, "y": 0, "w": 3, "h": 2},
      "data_source": {
        "metric_code": "daily_sales_amount",
        "filters": {"date": "today"}
      },
      "style": {
        "background_color": "#1890ff",
        "text_color": "#ffffff"
      }
    },
    {
      "id": "widget_2",
      "type": "line_chart",
      "title": "é”€å”®è¶‹åŠ¿",
      "position": {"x": 3, "y": 0, "w": 6, "h": 4},
      "data_source": {
        "metric_code": "daily_sales_trend",
        "time_range": "last_30_days"
      }
    }
  ],
  "refresh_interval": 300
}
```

#### 3.2 è·å–ä»ªè¡¨æ¿æ•°æ®
```http
GET /v1/dashboards/{dashboard_id}/data?refresh=true
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "dashboard_id": 1,
    "last_updated": "2024-01-01T10:30:00Z",
    "widgets": [
      {
        "widget_id": "widget_1",
        "data": {
          "value": 125680.50,
          "unit": "å…ƒ",
          "change": "+12.5%",
          "trend": "up"
        }
      },
      {
        "widget_id": "widget_2",
        "data": {
          "series": [
            {
              "name": "é”€å”®é¢",
              "data": [
                {"date": "2024-01-01", "value": 98500},
                {"date": "2024-01-02", "value": 105200},
                {"date": "2024-01-03", "value": 125680}
              ]
            }
          ]
        }
      }
    ]
  }
}
```

### 4. æ•°æ®æŒ‡æ ‡ç®¡ç†

#### 4.1 åˆ›å»ºæ•°æ®æŒ‡æ ‡
```http
POST /v1/metrics
Content-Type: application/json
Authorization: Bearer {token}

{
  "metric_name": "æ—¥é”€å”®é¢",
  "metric_type": "sum",
  "category": "sales",
  "description": "æ¯æ—¥é”€å”®æ€»é‡‘é¢",
  "calculation_formula": "SUM(orders.total_amount) WHERE orders.status = 'completed' AND DATE(orders.created_at) = :date",
  "data_source": "orders",
  "unit": "å…ƒ",
  "decimal_places": 2,
  "threshold_config": {
    "warning": 50000,
    "critical": 30000,
    "target": 100000
  }
}
```

#### 4.2 è·å–æŒ‡æ ‡æ•°æ®
```http
GET /v1/metrics/{metric_code}/values?start_date=2024-01-01&end_date=2024-01-31&dimension=date
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "metric_code": "daily_sales_amount",
    "metric_name": "æ—¥é”€å”®é¢",
    "unit": "å…ƒ",
    "values": [
      {
        "date": "2024-01-01",
        "value": 98500.00,
        "status": "normal"
      },
      {
        "date": "2024-01-02",
        "value": 105200.00,
        "status": "normal"
      },
      {
        "date": "2024-01-03",
        "value": 125680.50,
        "status": "good"
      }
    ],
    "summary": {
      "total": 329380.50,
      "average": 109793.50,
      "max": 125680.50,
      "min": 98500.00
    }
  }
}
```

### 5. æŠ¥è¡¨è®¢é˜…ç®¡ç†

#### 5.1 åˆ›å»ºæŠ¥è¡¨è®¢é˜…
```http
POST /v1/reports/subscriptions
Content-Type: application/json
Authorization: Bearer {token}

{
  "template_id": 1,
  "subscription_name": "æœˆåº¦é”€å”®æŠ¥è¡¨è®¢é˜…",
  "parameters": {
    "product_category": "all"
  },
  "schedule_type": "monthly",
  "schedule_config": {
    "day_of_month": 1,
    "hour": 9,
    "minute": 0
  },
  "delivery_method": "email",
  "delivery_config": {
    "recipients": ["manager@example.com", "sales@example.com"],
    "subject": "æœˆåº¦é”€å”®æŠ¥è¡¨ - {{month}}",
    "message": "è¯·æŸ¥æ”¶æœ¬æœˆé”€å”®æŠ¥è¡¨"
  }
}
```

#### 5.2 è·å–è®¢é˜…åˆ—è¡¨
```http
GET /v1/reports/subscriptions?page=1&page_size=20&template_id=1
Authorization: Bearer {token}
```

---

## ğŸ¢ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 1. æŠ¥è¡¨ç”ŸæˆæœåŠ¡

```typescript
// report-generation.service.ts
export class ReportGenerationService {
  constructor(
    private readonly templateRepository: Repository<ReportTemplate>,
    private readonly instanceRepository: Repository<ReportInstance>,
    private readonly dataService: DataService,
    private readonly chartService: ChartService,
    private readonly fileService: FileService,
    private readonly queueService: QueueService
  ) {}

  // ç”ŸæˆæŠ¥è¡¨
  async generateReport(generateDto: ReportGenerateDto): Promise<ReportInstance> {
    // 1. éªŒè¯æ¨¡æ¿
    const template = await this.templateRepository.findOne({
      where: { id: generateDto.template_id, is_active: true }
    });
    
    if (!template) {
      throw new NotFoundException('æŠ¥è¡¨æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨');
    }
    
    // 2. åˆ›å»ºæŠ¥è¡¨å®ä¾‹
    const instance = this.instanceRepository.create({
      template_id: generateDto.template_id,
      instance_name: generateDto.instance_name,
      parameters: generateDto.parameters,
      filter_values: generateDto.filter_values,
      status: 'generating',
      creator_id: generateDto.creator_id
    });
    
    const savedInstance = await this.instanceRepository.save(instance);
    
    // 3. å¼‚æ­¥ç”ŸæˆæŠ¥è¡¨
    if (generateDto.async) {
      await this.queueService.addJob('report-generation', {
        instanceId: savedInstance.id,
        templateId: template.id,
        parameters: generateDto.parameters
      });
    } else {
      await this.processReportGeneration(savedInstance.id);
    }
    
    return savedInstance;
  }

  // å¤„ç†æŠ¥è¡¨ç”Ÿæˆ
  async processReportGeneration(instanceId: number): Promise<void> {
    const startTime = Date.now();
    
    try {
      // 1. è·å–å®ä¾‹å’Œæ¨¡æ¿ä¿¡æ¯
      const instance = await this.instanceRepository.findOne({
        where: { id: instanceId },
        relations: ['template']
      });
      
      if (!instance) {
        throw new Error('æŠ¥è¡¨å®ä¾‹ä¸å­˜åœ¨');
      }
      
      // 2. æ‰§è¡Œæ•°æ®æŸ¥è¯¢
      const queryResult = await this.executeDataQuery(
        instance.template.query_config,
        instance.parameters
      );
      
      // 3. ç”Ÿæˆå›¾è¡¨
      const charts = await this.generateCharts(
        queryResult,
        instance.template.chart_config
      );
      
      // 4. ç”ŸæˆæŠ¥è¡¨æ–‡ä»¶
      const reportFile = await this.generateReportFile(
        queryResult,
        charts,
        instance.template,
        instance.parameters
      );
      
      // 5. ä¸Šä¼ æ–‡ä»¶
      const fileUrl = await this.fileService.uploadFile(reportFile, 'reports');
      
      // 6. æ›´æ–°å®ä¾‹çŠ¶æ€
      const generationTime = Math.round((Date.now() - startTime) / 1000);
      await this.instanceRepository.update(instanceId, {
        status: 'completed',
        file_url: fileUrl,
        file_size: reportFile.size,
        generation_time: generationTime,
        generated_at: new Date(),
        expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7å¤©åè¿‡æœŸ
      });
      
    } catch (error) {
      // æ›´æ–°å¤±è´¥çŠ¶æ€
      await this.instanceRepository.update(instanceId, {
        status: 'failed',
        error_message: error.message
      });
      
      throw error;
    }
  }

  // æ‰§è¡Œæ•°æ®æŸ¥è¯¢
  private async executeDataQuery(
    queryConfig: any,
    parameters: any
  ): Promise<any[]> {
    // 1. æ„å»ºSQLæŸ¥è¯¢
    const query = this.buildSqlQuery(queryConfig, parameters);
    
    // 2. æ‰§è¡ŒæŸ¥è¯¢
    const result = await this.dataService.executeQuery(query, parameters);
    
    // 3. æ•°æ®å¤„ç†å’Œæ ¼å¼åŒ–
    return this.formatQueryResult(result, queryConfig);
  }

  // æ„å»ºSQLæŸ¥è¯¢
  private buildSqlQuery(queryConfig: any, parameters: any): string {
    const { select, from, joins, where, group_by, order_by } = queryConfig;
    
    let sql = `SELECT ${select.join(', ')} FROM ${from}`;
    
    // æ·»åŠ JOIN
    if (joins && joins.length > 0) {
      joins.forEach(join => {
        sql += ` LEFT JOIN ${join.table} ON ${join.on}`;
      });
    }
    
    // æ·»åŠ WHEREæ¡ä»¶
    if (where && where.length > 0) {
      sql += ` WHERE ${where.join(' AND ')}`;
    }
    
    // æ·»åŠ GROUP BY
    if (group_by && group_by.length > 0) {
      sql += ` GROUP BY ${group_by.join(', ')}`;
    }
    
    // æ·»åŠ ORDER BY
    if (order_by && order_by.length > 0) {
      sql += ` ORDER BY ${order_by.join(', ')}`;
    }
    
    return sql;
  }

  // ç”Ÿæˆå›¾è¡¨
  private async generateCharts(
    data: any[],
    chartConfig: any
  ): Promise<Buffer[]> {
    const charts: Buffer[] = [];
    
    if (chartConfig && chartConfig.charts) {
      for (const config of chartConfig.charts) {
        const chartBuffer = await this.chartService.generateChart(data, config);
        charts.push(chartBuffer);
      }
    }
    
    return charts;
  }

  // ç”ŸæˆæŠ¥è¡¨æ–‡ä»¶
  private async generateReportFile(
    data: any[],
    charts: Buffer[],
    template: ReportTemplate,
    parameters: any
  ): Promise<Buffer> {
    // æ ¹æ®æ¨¡æ¿é…ç½®ç”ŸæˆExcelæˆ–PDFæ–‡ä»¶
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('æŠ¥è¡¨æ•°æ®');
    
    // 1. æ·»åŠ æ ‡é¢˜
    worksheet.addRow([template.template_name]);
    worksheet.addRow([`ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}`]);
    worksheet.addRow([]);
    
    // 2. æ·»åŠ å‚æ•°ä¿¡æ¯
    if (parameters) {
      worksheet.addRow(['æŠ¥è¡¨å‚æ•°:']);
      Object.entries(parameters).forEach(([key, value]) => {
        worksheet.addRow([key, value]);
      });
      worksheet.addRow([]);
    }
    
    // 3. æ·»åŠ æ•°æ®
    if (data.length > 0) {
      // æ·»åŠ è¡¨å¤´
      const headers = Object.keys(data[0]);
      worksheet.addRow(headers);
      
      // æ·»åŠ æ•°æ®è¡Œ
      data.forEach(row => {
        worksheet.addRow(Object.values(row));
      });
    }
    
    // 4. æ·»åŠ å›¾è¡¨
    charts.forEach((chart, index) => {
      const imageId = workbook.addImage({
        buffer: chart,
        extension: 'png'
      });
      
      worksheet.addImage(imageId, {
        tl: { col: 0, row: worksheet.rowCount + 2 },
        ext: { width: 600, height: 400 }
      });
    });
    
    // 5. ç”Ÿæˆæ–‡ä»¶
    return await workbook.xlsx.writeBuffer() as Buffer;
  }
}
```

### 2. ä»ªè¡¨æ¿æ•°æ®æœåŠ¡

```typescript
// dashboard-data.service.ts
export class DashboardDataService {
  constructor(
    private readonly dashboardRepository: Repository<DashboardConfig>,
    private readonly metricService: MetricService,
    private readonly cacheService: CacheService
  ) {}

  // è·å–ä»ªè¡¨æ¿æ•°æ®
  async getDashboardData(
    dashboardId: number,
    refresh: boolean = false
  ): Promise<DashboardData> {
    // 1. è·å–ä»ªè¡¨æ¿é…ç½®
    const dashboard = await this.dashboardRepository.findOne({
      where: { id: dashboardId, is_active: true }
    });
    
    if (!dashboard) {
      throw new NotFoundException('ä»ªè¡¨æ¿ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨');
    }
    
    // 2. æ£€æŸ¥ç¼“å­˜
    const cacheKey = `dashboard:${dashboardId}`;
    if (!refresh) {
      const cachedData = await this.cacheService.get(cacheKey);
      if (cachedData) {
        return cachedData;
      }
    }
    
    // 3. è·å–ç»„ä»¶æ•°æ®
    const widgetData = await this.getWidgetData(dashboard.widget_configs);
    
    // 4. æ„å»ºå“åº”æ•°æ®
    const dashboardData: DashboardData = {
      dashboard_id: dashboardId,
      last_updated: new Date(),
      widgets: widgetData
    };
    
    // 5. ç¼“å­˜æ•°æ®
    await this.cacheService.set(
      cacheKey,
      dashboardData,
      dashboard.refresh_interval
    );
    
    return dashboardData;
  }

  // è·å–ç»„ä»¶æ•°æ®
  private async getWidgetData(widgetConfigs: any[]): Promise<WidgetData[]> {
    const widgetData: WidgetData[] = [];
    
    for (const config of widgetConfigs) {
      try {
        const data = await this.getWidgetDataByType(config);
        widgetData.push({
          widget_id: config.id,
          data
        });
      } catch (error) {
        // è®°å½•é”™è¯¯ä½†ä¸å½±å“å…¶ä»–ç»„ä»¶
        console.error(`è·å–ç»„ä»¶æ•°æ®å¤±è´¥: ${config.id}`, error);
        widgetData.push({
          widget_id: config.id,
          error: error.message
        });
      }
    }
    
    return widgetData;
  }

  // æ ¹æ®ç»„ä»¶ç±»å‹è·å–æ•°æ®
  private async getWidgetDataByType(config: any): Promise<any> {
    switch (config.type) {
      case 'metric_card':
        return await this.getMetricCardData(config);
      
      case 'line_chart':
        return await this.getLineChartData(config);
      
      case 'bar_chart':
        return await this.getBarChartData(config);
      
      case 'pie_chart':
        return await this.getPieChartData(config);
      
      case 'table':
        return await this.getTableData(config);
      
      default:
        throw new Error(`ä¸æ”¯æŒçš„ç»„ä»¶ç±»å‹: ${config.type}`);
    }
  }

  // è·å–æŒ‡æ ‡å¡æ•°æ®
  private async getMetricCardData(config: any): Promise<any> {
    const { metric_code, filters } = config.data_source;
    
    // è·å–å½“å‰å€¼
    const currentValue = await this.metricService.getMetricValue(
      metric_code,
      filters
    );
    
    // è·å–å¯¹æ¯”å€¼ï¼ˆå¦‚æ˜¨æ—¥ã€ä¸Šæœˆç­‰ï¼‰
    const compareValue = await this.metricService.getCompareValue(
      metric_code,
      filters
    );
    
    // è®¡ç®—å˜åŒ–ç‡
    const change = this.calculateChange(currentValue, compareValue);
    
    return {
      value: currentValue,
      change: change.percentage,
      trend: change.trend,
      compare_value: compareValue
    };
  }

  // è·å–æŠ˜çº¿å›¾æ•°æ®
  private async getLineChartData(config: any): Promise<any> {
    const { metric_code, time_range, group_by } = config.data_source;
    
    const timeSeriesData = await this.metricService.getTimeSeriesData(
      metric_code,
      time_range,
      group_by
    );
    
    return {
      series: timeSeriesData.map(series => ({
        name: series.name,
        data: series.data.map(point => ({
          date: point.date,
          value: point.value
        }))
      }))
    };
  }

  // è®¡ç®—å˜åŒ–ç‡
  private calculateChange(current: number, previous: number): any {
    if (previous === 0) {
      return { percentage: '0%', trend: 'stable' };
    }
    
    const change = ((current - previous) / previous) * 100;
    const percentage = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
    const trend = change > 0 ? 'up' : change < 0 ? 'down' : 'stable';
    
    return { percentage, trend };
  }
}
```

### 3. æ•°æ®æŒ‡æ ‡è®¡ç®—æœåŠ¡

```typescript
// metric-calculation.service.ts
export class MetricCalculationService {
  constructor(
    private readonly metricRepository: Repository<DataMetric>,
    private readonly metricValueRepository: Repository<MetricValue>,
    private readonly dataService: DataService,
    private readonly schedulerService: SchedulerService
  ) {}

  // è®¡ç®—æ‰€æœ‰æŒ‡æ ‡
  async calculateAllMetrics(date: Date): Promise<void> {
    const metrics = await this.metricRepository.find({
      where: { is_active: true }
    });
    
    for (const metric of metrics) {
      try {
        await this.calculateMetric(metric, date);
      } catch (error) {
        console.error(`è®¡ç®—æŒ‡æ ‡å¤±è´¥: ${metric.metric_code}`, error);
      }
    }
  }

  // è®¡ç®—å•ä¸ªæŒ‡æ ‡
  async calculateMetric(metric: DataMetric, date: Date): Promise<void> {
    // 1. è§£æè®¡ç®—å…¬å¼
    const formula = this.parseFormula(metric.calculation_formula);
    
    // 2. æ‰§è¡Œè®¡ç®—æŸ¥è¯¢
    const result = await this.executeCalculation(formula, date);
    
    // 3. ä¿å­˜æŒ‡æ ‡å€¼
    await this.saveMetricValues(metric.id, result, date);
  }

  // è§£æè®¡ç®—å…¬å¼
  private parseFormula(formula: string): CalculationFormula {
    // ç®€åŒ–çš„å…¬å¼è§£æï¼Œå®é™…åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„è§£æå™¨
    const aggregateMatch = formula.match(/(SUM|COUNT|AVG|MAX|MIN)\(([^)]+)\)/i);
    const whereMatch = formula.match(/WHERE\s+(.+?)(?:\s+GROUP\s+BY|$)/i);
    const groupByMatch = formula.match(/GROUP\s+BY\s+(.+)$/i);
    
    return {
      aggregate: aggregateMatch ? aggregateMatch[1].toUpperCase() : 'COUNT',
      field: aggregateMatch ? aggregateMatch[2] : '*',
      where: whereMatch ? whereMatch[1] : '',
      groupBy: groupByMatch ? groupByMatch[1].split(',').map(s => s.trim()) : []
    };
  }

  // æ‰§è¡Œè®¡ç®—
  private async executeCalculation(
    formula: CalculationFormula,
    date: Date
  ): Promise<CalculationResult[]> {
    // æ„å»ºæŸ¥è¯¢SQL
    let sql = `SELECT `;
    
    // æ·»åŠ åˆ†ç»„å­—æ®µ
    if (formula.groupBy.length > 0) {
      sql += `${formula.groupBy.join(', ')}, `;
    }
    
    // æ·»åŠ èšåˆå‡½æ•°
    sql += `${formula.aggregate}(${formula.field}) as metric_value`;
    
    // æ·»åŠ æ•°æ®æº
    sql += ` FROM ${this.getDataSource(formula)}`;
    
    // æ·»åŠ WHEREæ¡ä»¶
    if (formula.where) {
      const whereClause = formula.where.replace(':date', `'${date.toISOString().split('T')[0]}'`);
      sql += ` WHERE ${whereClause}`;
    }
    
    // æ·»åŠ GROUP BY
    if (formula.groupBy.length > 0) {
      sql += ` GROUP BY ${formula.groupBy.join(', ')}`;
    }
    
    // æ‰§è¡ŒæŸ¥è¯¢
    const result = await this.dataService.executeQuery(sql);
    
    return result.map(row => ({
      dimensions: formula.groupBy.reduce((acc, field) => {
        acc[field] = row[field];
        return acc;
      }, {}),
      value: parseFloat(row.metric_value) || 0
    }));
  }

  // ä¿å­˜æŒ‡æ ‡å€¼
  private async saveMetricValues(
    metricId: number,
    results: CalculationResult[],
    date: Date
  ): Promise<void> {
    for (const result of results) {
      const metricValue = this.metricValueRepository.create({
        metric_id: metricId,
        dimension_values: result.dimensions,
        metric_value: result.value,
        calculation_date: date
      });
      
      await this.metricValueRepository.save(metricValue);
    }
  }

  // è·å–æ•°æ®æº
  private getDataSource(formula: CalculationFormula): string {
    // æ ¹æ®å…¬å¼ä¸­çš„å­—æ®µæ¨æ–­æ•°æ®æº
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æœ‰æ›´å¤æ‚çš„é€»è¾‘
    if (formula.field.includes('orders.')) {
      return 'orders';
    } else if (formula.field.includes('customers.')) {
      return 'customers';
    } else {
      return 'orders'; // é»˜è®¤æ•°æ®æº
    }
  }

  // å¯åŠ¨å®šæ—¶è®¡ç®—ä»»åŠ¡
  async startScheduledCalculation(): Promise<void> {
    // æ¯å°æ—¶è®¡ç®—ä¸€æ¬¡å®æ—¶æŒ‡æ ‡
    this.schedulerService.addCronJob('hourly-metrics', '0 * * * *', async () => {
      await this.calculateHourlyMetrics();
    });
    
    // æ¯å¤©å‡Œæ™¨è®¡ç®—æ—¥æŒ‡æ ‡
    this.schedulerService.addCronJob('daily-metrics', '0 1 * * *', async () => {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      await this.calculateAllMetrics(yesterday);
    });
  }

  // è®¡ç®—å°æ—¶æŒ‡æ ‡
  private async calculateHourlyMetrics(): Promise<void> {
    const now = new Date();
    const hourlyMetrics = await this.metricRepository.find({
      where: { 
        is_active: true,
        category: 'realtime'
      }
    });
    
    for (const metric of hourlyMetrics) {
      await this.calculateMetric(metric, now);
    }
  }
}
```

### 4. æŠ¥è¡¨è®¢é˜…æœåŠ¡

```typescript
// report-subscription.service.ts
export class ReportSubscriptionService {
  constructor(
    private readonly subscriptionRepository: Repository<ReportSubscription>,
    private readonly reportService: ReportGenerationService,
    private readonly emailService: EmailService,
    private readonly notificationService: NotificationService,
    private readonly schedulerService: SchedulerService
  ) {}

  // åˆ›å»ºæŠ¥è¡¨è®¢é˜…
  async createSubscription(
    subscriptionDto: CreateSubscriptionDto
  ): Promise<ReportSubscription> {
    // 1. åˆ›å»ºè®¢é˜…è®°å½•
    const subscription = this.subscriptionRepository.create({
      ...subscriptionDto,
      next_execution_at: this.calculateNextExecution(
        subscriptionDto.schedule_type,
        subscriptionDto.schedule_config
      )
    });
    
    const savedSubscription = await this.subscriptionRepository.save(subscription);
    
    // 2. æ³¨å†Œè°ƒåº¦ä»»åŠ¡
    await this.registerScheduleJob(savedSubscription);
    
    return savedSubscription;
  }

  // æ‰§è¡Œè®¢é˜…ä»»åŠ¡
  async executeSubscription(subscriptionId: number): Promise<void> {
    const subscription = await this.subscriptionRepository.findOne({
      where: { id: subscriptionId, is_active: true },
      relations: ['template']
    });
    
    if (!subscription) {
      throw new NotFoundException('è®¢é˜…ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨');
    }
    
    try {
      // 1. ç”ŸæˆæŠ¥è¡¨
      const reportInstance = await this.reportService.generateReport({
        template_id: subscription.template_id,
        instance_name: `${subscription.subscription_name} - ${new Date().toLocaleDateString()}`,
        parameters: subscription.parameters,
        async: false
      });
      
      // 2. ç­‰å¾…æŠ¥è¡¨ç”Ÿæˆå®Œæˆ
      await this.waitForReportCompletion(reportInstance.id);
      
      // 3. å‘é€æŠ¥è¡¨
      await this.deliverReport(subscription, reportInstance);
      
      // 4. æ›´æ–°æ‰§è¡Œæ—¶é—´
      await this.updateExecutionTime(subscription);
      
    } catch (error) {
      console.error(`æ‰§è¡Œè®¢é˜…ä»»åŠ¡å¤±è´¥: ${subscriptionId}`, error);
      
      // å‘é€é”™è¯¯é€šçŸ¥
      await this.notificationService.sendSubscriptionError(
        subscription,
        error.message
      );
    }
  }

  // å‘é€æŠ¥è¡¨
  private async deliverReport(
    subscription: ReportSubscription,
    reportInstance: ReportInstance
  ): Promise<void> {
    const { delivery_method, delivery_config } = subscription;
    
    if (delivery_method === 'email' || delivery_method === 'both') {
      await this.sendReportByEmail(subscription, reportInstance, delivery_config);
    }
    
    if (delivery_method === 'system' || delivery_method === 'both') {
      await this.sendReportBySystem(subscription, reportInstance);
    }
  }

  // é‚®ä»¶å‘é€æŠ¥è¡¨
  private async sendReportByEmail(
    subscription: ReportSubscription,
    reportInstance: ReportInstance,
    config: any
  ): Promise<void> {
    const reportFile = await this.downloadReportFile(reportInstance.file_url);
    
    await this.emailService.sendEmail({
      to: config.recipients,
      subject: this.replaceVariables(config.subject, subscription, reportInstance),
      html: this.replaceVariables(config.message, subscription, reportInstance),
      attachments: [
        {
          filename: `${subscription.subscription_name}.xlsx`,
          content: reportFile
        }
      ]
    });
  }

  // ç³»ç»Ÿå†…å‘é€æŠ¥è¡¨
  private async sendReportBySystem(
    subscription: ReportSubscription,
    reportInstance: ReportInstance
  ): Promise<void> {
    await this.notificationService.sendSystemNotification({
      user_id: subscription.user_id,
      title: 'è®¢é˜…æŠ¥è¡¨å·²ç”Ÿæˆ',
      content: `æ‚¨è®¢é˜…çš„æŠ¥è¡¨"${subscription.subscription_name}"å·²ç”Ÿæˆå®Œæˆ`,
      type: 'report',
      data: {
        subscription_id: subscription.id,
        instance_id: reportInstance.id,
        download_url: reportInstance.file_url
      }
    });
  }

  // è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
  private calculateNextExecution(
    scheduleType: string,
    scheduleConfig: any
  ): Date {
    const now = new Date();
    const next = new Date(now);
    
    switch (scheduleType) {
      case 'daily':
        next.setDate(next.getDate() + 1);
        next.setHours(scheduleConfig.hour || 9, scheduleConfig.minute || 0, 0, 0);
        break;
        
      case 'weekly':
        const daysUntilNext = (scheduleConfig.day_of_week - now.getDay() + 7) % 7;
        next.setDate(next.getDate() + (daysUntilNext || 7));
        next.setHours(scheduleConfig.hour || 9, scheduleConfig.minute || 0, 0, 0);
        break;
        
      case 'monthly':
        next.setMonth(next.getMonth() + 1);
        next.setDate(scheduleConfig.day_of_month || 1);
        next.setHours(scheduleConfig.hour || 9, scheduleConfig.minute || 0, 0, 0);
        break;
        
      case 'quarterly':
        next.setMonth(next.getMonth() + 3);
        next.setDate(scheduleConfig.day_of_month || 1);
        next.setHours(scheduleConfig.hour || 9, scheduleConfig.minute || 0, 0, 0);
        break;
    }
    
    return next;
  }

  // æ³¨å†Œè°ƒåº¦ä»»åŠ¡
  private async registerScheduleJob(subscription: ReportSubscription): Promise<void> {
    const cronExpression = this.buildCronExpression(
      subscription.schedule_type,
      subscription.schedule_config
    );
    
    await this.schedulerService.addCronJob(
      `subscription-${subscription.id}`,
      cronExpression,
      () => this.executeSubscription(subscription.id)
    );
  }

  // æ„å»ºCronè¡¨è¾¾å¼
  private buildCronExpression(scheduleType: string, config: any): string {
    const minute = config.minute || 0;
    const hour = config.hour || 9;
    
    switch (scheduleType) {
      case 'daily':
        return `${minute} ${hour} * * *`;
        
      case 'weekly':
        const dayOfWeek = config.day_of_week || 1;
        return `${minute} ${hour} * * ${dayOfWeek}`;
        
      case 'monthly':
        const dayOfMonth = config.day_of_month || 1;
        return `${minute} ${hour} ${dayOfMonth} * *`;
        
      case 'quarterly':
        const quarterDay = config.day_of_month || 1;
        return `${minute} ${hour} ${quarterDay} */3 *`;
        
      default:
        return `${minute} ${hour} * * *`; // é»˜è®¤æ¯æ—¥
    }
  }

  // ç­‰å¾…æŠ¥è¡¨ç”Ÿæˆå®Œæˆ
  private async waitForReportCompletion(instanceId: number): Promise<void> {
    const maxWaitTime = 10 * 60 * 1000; // æœ€å¤§ç­‰å¾…10åˆ†é’Ÿ
    const checkInterval = 5000; // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    const startTime = Date.now();
    
    while (Date.now() - startTime < maxWaitTime) {
      const instance = await this.reportService.getReportInstance(instanceId);
      
      if (instance.status === 'completed') {
        return;
      } else if (instance.status === 'failed') {
        throw new Error(`æŠ¥è¡¨ç”Ÿæˆå¤±è´¥: ${instance.error_message}`);
      }
      
      await new Promise(resolve => setTimeout(resolve, checkInterval));
    }
    
    throw new Error('æŠ¥è¡¨ç”Ÿæˆè¶…æ—¶');
  }

  // æ›¿æ¢å˜é‡
  private replaceVariables(
    template: string,
    subscription: ReportSubscription,
    reportInstance: ReportInstance
  ): string {
    return template
      .replace(/\{\{subscription_name\}\}/g, subscription.subscription_name)
      .replace(/\{\{date\}\}/g, new Date().toLocaleDateString())
      .replace(/\{\{month\}\}/g, new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' }))
      .replace(/\{\{instance_name\}\}/g, reportInstance.instance_name);
  }
}
```

---

## ğŸ“± å‰ç«¯ç•Œé¢è®¾è®¡

### 1. æŠ¥è¡¨ç®¡ç†ç•Œé¢

#### 1.1 æŠ¥è¡¨æ¨¡æ¿ç®¡ç†
- **æ¨¡æ¿åˆ—è¡¨**ï¼šå±•ç¤ºæ‰€æœ‰æŠ¥è¡¨æ¨¡æ¿ï¼Œæ”¯æŒåˆ†ç±»ç­›é€‰å’Œæœç´¢
- **æ¨¡æ¿ç¼–è¾‘å™¨**ï¼šå¯è§†åŒ–çš„æŠ¥è¡¨è®¾è®¡å™¨ï¼Œæ”¯æŒæ‹–æ‹½å¼å¸ƒå±€
- **æ•°æ®æºé…ç½®**ï¼šå›¾å½¢åŒ–çš„æ•°æ®æºå’ŒæŸ¥è¯¢é…ç½®ç•Œé¢
- **é¢„è§ˆåŠŸèƒ½**ï¼šå®æ—¶é¢„è§ˆæŠ¥è¡¨æ•ˆæœ

#### 1.2 æŠ¥è¡¨ç”Ÿæˆç•Œé¢
- **å‚æ•°è®¾ç½®**ï¼šå‹å¥½çš„å‚æ•°è¾“å…¥ç•Œé¢ï¼Œæ”¯æŒæ—¥æœŸé€‰æ‹©ã€ä¸‹æ‹‰é€‰æ‹©ç­‰
- **ç”Ÿæˆè¿›åº¦**ï¼šå®æ—¶æ˜¾ç¤ºæŠ¥è¡¨ç”Ÿæˆè¿›åº¦å’ŒçŠ¶æ€
- **ç»“æœå±•ç¤º**ï¼šåœ¨çº¿é¢„è§ˆæŠ¥è¡¨å†…å®¹ï¼Œæ”¯æŒä¸‹è½½å¤šç§æ ¼å¼
- **å†å²è®°å½•**ï¼šæŸ¥çœ‹å†å²ç”Ÿæˆçš„æŠ¥è¡¨å®ä¾‹

### 2. ä»ªè¡¨æ¿ç•Œé¢

#### 2.1 ä»ªè¡¨æ¿è®¾è®¡å™¨
- **ç»„ä»¶åº“**ï¼šä¸°å¯Œçš„å›¾è¡¨ç»„ä»¶å’ŒæŒ‡æ ‡å¡ç»„ä»¶
- **æ‹–æ‹½å¸ƒå±€**ï¼šæ”¯æŒæ‹–æ‹½å¼å¸ƒå±€å’Œå¤§å°è°ƒæ•´
- **æ ·å¼é…ç½®**ï¼šçµæ´»çš„æ ·å¼å’Œä¸»é¢˜é…ç½®
- **æ•°æ®ç»‘å®š**ï¼šç®€å•çš„æ•°æ®æºç»‘å®šé…ç½®

#### 2.2 ä»ªè¡¨æ¿å±•ç¤º
- **å“åº”å¼å¸ƒå±€**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
- **å®æ—¶åˆ·æ–°**ï¼šæ”¯æŒè‡ªåŠ¨åˆ·æ–°å’Œæ‰‹åŠ¨åˆ·æ–°
- **äº¤äº’åŠŸèƒ½**ï¼šæ”¯æŒé’»å–ã€ç­›é€‰ç­‰äº¤äº’æ“ä½œ
- **å…¨å±æ¨¡å¼**ï¼šæ”¯æŒå…¨å±å±•ç¤ºæ¨¡å¼

### 3. æ•°æ®åˆ†æç•Œé¢

#### 3.1 æŒ‡æ ‡ç®¡ç†
- **æŒ‡æ ‡å®šä¹‰**ï¼šå¯è§†åŒ–çš„æŒ‡æ ‡å®šä¹‰å’Œå…¬å¼ç¼–è¾‘
- **æŒ‡æ ‡ç›‘æ§**ï¼šå®æ—¶ç›‘æ§æŒ‡æ ‡çŠ¶æ€å’Œå¼‚å¸¸
- **é˜ˆå€¼è®¾ç½®**ï¼šçµæ´»çš„é˜ˆå€¼é…ç½®å’Œå‘Šè­¦è®¾ç½®
- **è¶‹åŠ¿åˆ†æ**ï¼šæŒ‡æ ‡çš„å†å²è¶‹åŠ¿å’Œå¯¹æ¯”åˆ†æ

#### 3.2 è‡ªåŠ©åˆ†æ
- **æ•°æ®æ¢ç´¢**ï¼šè‡ªç”±çš„æ•°æ®æŸ¥è¯¢å’Œæ¢ç´¢å·¥å…·
- **å›¾è¡¨ç”Ÿæˆ**ï¼šå¿«é€Ÿç”Ÿæˆå„ç±»åˆ†æå›¾è¡¨
- **æ•°æ®å¯¼å‡º**ï¼šæ”¯æŒå¯¼å‡ºåˆ†æç»“æœ
- **åˆ†æä¿å­˜**ï¼šä¿å­˜å’Œåˆ†äº«åˆ†æç»“æœ

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ•°æ®æŸ¥è¯¢ä¼˜åŒ–
- **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹åˆé€‚çš„ç´¢å¼•
- **æŸ¥è¯¢ç¼“å­˜**ï¼šç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
- **åˆ†é¡µæŸ¥è¯¢**ï¼šå¤§æ•°æ®é‡æŸ¥è¯¢ä½¿ç”¨åˆ†é¡µå¤„ç†
- **å¼‚æ­¥å¤„ç†**ï¼šå¤æ‚æŠ¥è¡¨ç”Ÿæˆä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—å¤„ç†

### 2. ç¼“å­˜ç­–ç•¥
- **å¤šçº§ç¼“å­˜**ï¼šRedisç¼“å­˜ + åº”ç”¨ç¼“å­˜ + CDNç¼“å­˜
- **æ™ºèƒ½å¤±æ•ˆ**ï¼šåŸºäºæ•°æ®æ›´æ–°çš„æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ
- **é¢„çƒ­æœºåˆ¶**ï¼šå®šæ—¶é¢„çƒ­çƒ­ç‚¹æ•°æ®
- **å‹ç¼©å­˜å‚¨**ï¼šç¼“å­˜æ•°æ®å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çœå†…å­˜

### 3. è®¡ç®—ä¼˜åŒ–
- **å¢é‡è®¡ç®—**ï¼šæŒ‡æ ‡è®¡ç®—é‡‡ç”¨å¢é‡æ–¹å¼ï¼Œé¿å…å…¨é‡è®¡ç®—
- **å¹¶è¡Œå¤„ç†**ï¼šå¤šæŒ‡æ ‡å¹¶è¡Œè®¡ç®—ï¼Œæé«˜æ•ˆç‡
- **é¢„è®¡ç®—**ï¼šå¸¸ç”¨æŒ‡æ ‡é¢„å…ˆè®¡ç®—å¹¶å­˜å‚¨
- **åˆ†å¸ƒå¼è®¡ç®—**ï¼šå¤§æ•°æ®é‡ä½¿ç”¨åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶

---

## ğŸ”’ å®‰å…¨ä¸æƒé™æ§åˆ¶

### 1. æ•°æ®å®‰å…¨
- **æ•°æ®è„±æ•**ï¼šæ•æ„Ÿæ•°æ®åœ¨æŠ¥è¡¨ä¸­è‡ªåŠ¨è„±æ•
- **è®¿é—®æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„æ•°æ®è®¿é—®æ§åˆ¶
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ•°æ®è®¿é—®å’Œæ“ä½œæ—¥å¿—
- **åŠ å¯†ä¼ è¾“**ï¼šæ•°æ®ä¼ è¾“å…¨ç¨‹åŠ å¯†

### 2. æŠ¥è¡¨å®‰å…¨
- **æ°´å°ä¿æŠ¤**ï¼šæŠ¥è¡¨æ·»åŠ ç”¨æˆ·æ°´å°ï¼Œé˜²æ­¢æ³„éœ²
- **ä¸‹è½½æ§åˆ¶**ï¼šæ§åˆ¶æŠ¥è¡¨ä¸‹è½½æƒé™å’Œæ¬¡æ•°
- **æœ‰æ•ˆæœŸç®¡ç†**ï¼šæŠ¥è¡¨æ–‡ä»¶è‡ªåŠ¨è¿‡æœŸåˆ é™¤
- **åˆ†äº«æ§åˆ¶**ï¼šæŠ¥è¡¨åˆ†äº«æƒé™å’ŒèŒƒå›´æ§åˆ¶

---

## ğŸ“ æ€»ç»“

æŠ¥è¡¨åˆ†ææ¨¡å—æ˜¯L2Cç³»ç»Ÿçš„æ•°æ®ä¸­æ¢ï¼Œä¸ºä¸šåŠ¡å†³ç­–æä¾›å…¨é¢çš„æ•°æ®æ”¯æŒã€‚æœ¬è®¾è®¡æ–‡æ¡£æ¶µç›–äº†ï¼š

1. **å®Œæ•´çš„æŠ¥è¡¨ä½“ç³»**ï¼šä»æ¨¡æ¿è®¾è®¡åˆ°æŠ¥è¡¨ç”Ÿæˆçš„å®Œæ•´æµç¨‹
2. **çµæ´»çš„ä»ªè¡¨æ¿**ï¼šå¯è§†åŒ–çš„æ•°æ®å±•ç¤ºå’Œç›‘æ§å¹³å°
3. **æ™ºèƒ½çš„æŒ‡æ ‡ç³»ç»Ÿ**ï¼šè‡ªåŠ¨åŒ–çš„æŒ‡æ ‡è®¡ç®—å’Œç›‘æ§æœºåˆ¶
4. **ä¾¿æ·çš„è®¢é˜…æœåŠ¡**ï¼šè‡ªåŠ¨åŒ–çš„æŠ¥è¡¨ç”Ÿæˆå’Œæ¨é€æœåŠ¡
5. **å¼ºå¤§çš„åˆ†æèƒ½åŠ›**ï¼šå¤šç»´åº¦çš„æ•°æ®åˆ†æå’Œæ´å¯ŸåŠŸèƒ½
6. **ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ**ï¼šç›´è§‚æ˜“ç”¨çš„å‰ç«¯ç•Œé¢è®¾è®¡
7. **é«˜æ€§èƒ½æ¶æ„**ï¼šä¼˜åŒ–çš„æŸ¥è¯¢å’Œè®¡ç®—æ€§èƒ½
8. **å…¨é¢çš„å®‰å…¨ä¿éšœ**ï¼šæ•°æ®å®‰å…¨å’Œè®¿é—®æ§åˆ¶æœºåˆ¶

é€šè¿‡è¿™ä¸ªå®Œæ•´çš„æŠ¥è¡¨åˆ†ææ¨¡å—ï¼ŒL2Cç³»ç»Ÿèƒ½å¤Ÿä¸ºç®¡ç†å±‚æä¾›åŠæ—¶ã€å‡†ç¡®ã€å…¨é¢çš„ä¸šåŠ¡æ•°æ®åˆ†æï¼Œæ”¯æŒç§‘å­¦çš„ä¸šåŠ¡å†³ç­–ï¼Œæ¨åŠ¨ä¸šåŠ¡æŒç»­å¢é•¿ã€‚
