# 权限管理模块设计

## 1. 模块概述

### 1.1 功能目标
- **RBAC权限模型**：基于角色的访问控制，支持用户-角色-权限的灵活配置
- **细粒度权限控制**：支持功能级、数据级、字段级的精细权限控制
- **动态权限管理**：支持权限的动态分配、回收和临时授权
- **多租户支持**：支持多组织、多部门的权限隔离
- **权限继承**：支持组织架构的权限继承机制
- **审计追踪**：完整的权限变更和访问审计日志

### 1.2 权限模型 (RBAC + ABAC 混合模型)

#### 1.2.1 RBAC 基础模型
- **用户(User)**：系统的实际使用者
- **角色(Role)**：权限的集合，代表特定的职能
- **权限(Permission)**：对特定资源的特定操作权限
- **资源(Resource)**：系统中的功能模块、数据对象等
- **组织(Organization)**：用户所属的组织结构
- **部门(Department)**：组织内的部门划分

#### 1.2.2 ABAC 属性模型
- **主体属性(Subject Attributes)**：用户的属性信息
  - 基本属性：用户ID、姓名、部门、职位、等级
  - 业务属性：销售区域、客户类型、产品线权限
  - 时间属性：工作时间、临时权限有效期
  - 地理属性：办公地点、IP地址范围
- **客体属性(Object Attributes)**：资源的属性信息
  - 数据属性：数据类型、敏感级别、所有者
  - 业务属性：客户等级、订单金额、产品类别
  - 状态属性：数据状态、审批状态、生命周期
- **环境属性(Environment Attributes)**：访问环境信息
  - 时间属性：访问时间、工作日/节假日
  - 地理属性：访问地点、IP地址
  - 设备属性：设备类型、安全等级
- **动作属性(Action Attributes)**：操作的属性信息
  - 操作类型：读取、创建、修改、删除、审批
  - 操作范围：批量操作、单条操作
  - 风险等级：高风险、中风险、低风险

#### 1.2.3 混合权限决策流程
1. **RBAC 基础检查**：验证用户角色是否具有基础权限
2. **ABAC 属性评估**：基于属性规则进行细粒度权限判断
3. **数据权限过滤**：根据数据权限规则过滤可访问数据
4. **字段权限控制**：控制字段的可见性和编辑权限
5. **时间权限验证**：检查时间窗口权限
6. **审计日志记录**：记录权限检查和访问日志

### 1.3 权限类型
- **功能权限**：对系统功能模块的访问权限
- **数据权限**：对特定数据范围的访问权限
- **操作权限**：对资源的增删改查等操作权限
- **字段权限**：对数据字段的可见性和编辑权限
- **时间权限**：基于时间的临时权限控制

## 2. 数据库设计

### 2.1 用户表 (users) - 扩展权限相关字段
```sql
-- 在现有用户表基础上添加权限相关字段
ALTER TABLE users ADD COLUMN organization_id BIGINT COMMENT '所属组织ID';
ALTER TABLE users ADD COLUMN department_id BIGINT COMMENT '所属部门ID';
ALTER TABLE users ADD COLUMN is_super_admin BOOLEAN DEFAULT FALSE COMMENT '是否超级管理员';
ALTER TABLE users ADD COLUMN permission_level TINYINT DEFAULT 1 COMMENT '权限等级(1-10)';
ALTER TABLE users ADD COLUMN last_login_at TIMESTAMP NULL COMMENT '最后登录时间';
ALTER TABLE users ADD COLUMN login_count INT DEFAULT 0 COMMENT '登录次数';
ALTER TABLE users ADD COLUMN is_locked BOOLEAN DEFAULT FALSE COMMENT '是否锁定';
ALTER TABLE users ADD COLUMN locked_at TIMESTAMP NULL COMMENT '锁定时间';
ALTER TABLE users ADD COLUMN locked_reason VARCHAR(255) COMMENT '锁定原因';
```

### 2.2 组织表 (organizations)
```sql
CREATE TABLE organizations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    org_code VARCHAR(50) NOT NULL UNIQUE COMMENT '组织编码',
    org_name VARCHAR(100) NOT NULL COMMENT '组织名称',
    parent_id BIGINT COMMENT '父组织ID',
    org_level TINYINT NOT NULL COMMENT '组织层级',
    org_path VARCHAR(500) COMMENT '组织路径',
    org_type ENUM('company', 'branch', 'department', 'team') NOT NULL COMMENT '组织类型',
    manager_id BIGINT COMMENT '负责人ID',
    contact_phone VARCHAR(15) COMMENT '联系电话',
    contact_email VARCHAR(100) COMMENT '联系邮箱',
    address VARCHAR(255) COMMENT '地址',
    description TEXT COMMENT '组织描述',
    sort_order INT DEFAULT 0 COMMENT '排序',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_parent_id (parent_id),
    INDEX idx_org_code (org_code),
    INDEX idx_org_path (org_path),
    FOREIGN KEY (parent_id) REFERENCES organizations(id),
    FOREIGN KEY (manager_id) REFERENCES users(id)
);
```

### 2.3 角色表 (roles)
```sql
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_code VARCHAR(50) NOT NULL UNIQUE COMMENT '角色编码',
    role_name VARCHAR(100) NOT NULL COMMENT '角色名称',
    role_type ENUM('system', 'business', 'custom') NOT NULL COMMENT '角色类型',
    organization_id BIGINT COMMENT '所属组织ID',
    parent_role_id BIGINT COMMENT '父角色ID',
    role_level TINYINT DEFAULT 1 COMMENT '角色层级',
    description TEXT COMMENT '角色描述',
    is_default BOOLEAN DEFAULT FALSE COMMENT '是否默认角色',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    max_users INT DEFAULT 0 COMMENT '最大用户数(0为不限制)',
    created_by BIGINT COMMENT '创建人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_role_code (role_code),
    INDEX idx_organization_id (organization_id),
    INDEX idx_parent_role_id (parent_role_id),
    FOREIGN KEY (organization_id) REFERENCES organizations(id),
    FOREIGN KEY (parent_role_id) REFERENCES roles(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 2.4 权限表 (permissions)
```sql
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    permission_code VARCHAR(100) NOT NULL UNIQUE COMMENT '权限编码',
    permission_name VARCHAR(100) NOT NULL COMMENT '权限名称',
    permission_type ENUM('menu', 'button', 'api', 'data', 'field') NOT NULL COMMENT '权限类型',
    resource_type VARCHAR(50) COMMENT '资源类型',
    resource_id VARCHAR(100) COMMENT '资源标识',
    action VARCHAR(50) NOT NULL COMMENT '操作类型(create,read,update,delete,execute)',
    parent_id BIGINT COMMENT '父权限ID',
    permission_level TINYINT DEFAULT 1 COMMENT '权限层级',
    permission_path VARCHAR(500) COMMENT '权限路径',
    module VARCHAR(50) COMMENT '所属模块',
    description TEXT COMMENT '权限描述',
    is_system BOOLEAN DEFAULT FALSE COMMENT '是否系统权限',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_permission_code (permission_code),
    INDEX idx_parent_id (parent_id),
    INDEX idx_resource (resource_type, resource_id),
    INDEX idx_module (module),
    FOREIGN KEY (parent_id) REFERENCES permissions(id)
);
```

### 2.5 用户角色关联表 (user_roles)
```sql
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    organization_id BIGINT COMMENT '组织范围ID',
    granted_by BIGINT COMMENT '授权人',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',
    expires_at TIMESTAMP NULL COMMENT '过期时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否有效',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_role_org (user_id, role_id, organization_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id),
    INDEX idx_organization_id (organization_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (organization_id) REFERENCES organizations(id),
    FOREIGN KEY (granted_by) REFERENCES users(id)
);
```

### 2.6 角色权限关联表 (role_permissions)
```sql
CREATE TABLE role_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_id BIGINT NOT NULL COMMENT '角色ID',
    permission_id BIGINT NOT NULL COMMENT '权限ID',
    permission_scope JSON COMMENT '权限范围配置',
    data_filter JSON COMMENT '数据过滤条件',
    field_permissions JSON COMMENT '字段权限配置',
    granted_by BIGINT COMMENT '授权人',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否有效',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id),
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES users(id)
);
```

### 2.7 用户权限表 (user_permissions)
```sql
CREATE TABLE user_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    permission_id BIGINT NOT NULL COMMENT '权限ID',
    permission_type ENUM('grant', 'deny') DEFAULT 'grant' COMMENT '权限类型',
    permission_scope JSON COMMENT '权限范围配置',
    data_filter JSON COMMENT '数据过滤条件',
    granted_by BIGINT COMMENT '授权人',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',
    expires_at TIMESTAMP NULL COMMENT '过期时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否有效',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_permission (user_id, permission_id),
    INDEX idx_user_id (user_id),
    INDEX idx_permission_id (permission_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES users(id)
);
```

### 2.8 数据权限规则表 (data_permission_rules)
```sql
CREATE TABLE data_permission_rules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    rule_code VARCHAR(50) NOT NULL UNIQUE COMMENT '规则编码',
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    rule_type ENUM('organization', 'department', 'user', 'custom') NOT NULL COMMENT '规则类型',
    rule_expression TEXT NOT NULL COMMENT '规则表达式',
    rule_description TEXT COMMENT '规则描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_by BIGINT COMMENT '创建人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_rule_code (rule_code),
    INDEX idx_resource_type (resource_type),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 2.8.1 ABAC 属性定义表 (abac_attributes)
```sql
CREATE TABLE abac_attributes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    attribute_code VARCHAR(50) NOT NULL UNIQUE COMMENT '属性编码',
    attribute_name VARCHAR(100) NOT NULL COMMENT '属性名称',
    attribute_type ENUM('subject', 'object', 'environment', 'action') NOT NULL COMMENT '属性类型',
    data_type ENUM('string', 'number', 'boolean', 'date', 'json', 'array') NOT NULL COMMENT '数据类型',
    attribute_source ENUM('user', 'resource', 'system', 'external') NOT NULL COMMENT '属性来源',
    source_field VARCHAR(100) COMMENT '来源字段',
    default_value TEXT COMMENT '默认值',
    validation_rule TEXT COMMENT '验证规则',
    description TEXT COMMENT '属性描述',
    is_required BOOLEAN DEFAULT FALSE COMMENT '是否必需',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_attribute_code (attribute_code),
    INDEX idx_attribute_type (attribute_type)
);
```

### 2.8.2 ABAC 策略表 (abac_policies)
```sql
CREATE TABLE abac_policies (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    policy_code VARCHAR(50) NOT NULL UNIQUE COMMENT '策略编码',
    policy_name VARCHAR(100) NOT NULL COMMENT '策略名称',
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    action VARCHAR(50) NOT NULL COMMENT '操作类型',
    effect ENUM('permit', 'deny') NOT NULL COMMENT '策略效果',
    priority INT DEFAULT 0 COMMENT '优先级(数字越大优先级越高)',
    condition_expression TEXT NOT NULL COMMENT '条件表达式',
    data_filter_expression TEXT COMMENT '数据过滤表达式',
    field_filter_expression TEXT COMMENT '字段过滤表达式',
    time_constraint JSON COMMENT '时间约束',
    ip_constraint JSON COMMENT 'IP约束',
    description TEXT COMMENT '策略描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_by BIGINT COMMENT '创建人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_policy_code (policy_code),
    INDEX idx_resource_action (resource_type, action),
    INDEX idx_priority (priority),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 2.8.3 用户属性值表 (user_attribute_values)
```sql
CREATE TABLE user_attribute_values (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    attribute_id BIGINT NOT NULL COMMENT '属性ID',
    attribute_value TEXT NOT NULL COMMENT '属性值',
    effective_from TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '生效时间',
    effective_to TIMESTAMP NULL COMMENT '失效时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否有效',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_attribute (user_id, attribute_id),
    INDEX idx_user_id (user_id),
    INDEX idx_attribute_id (attribute_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (attribute_id) REFERENCES abac_attributes(id)
);
```

### 2.8.4 资源属性值表 (resource_attribute_values)
```sql
CREATE TABLE resource_attribute_values (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    resource_id VARCHAR(100) NOT NULL COMMENT '资源ID',
    attribute_id BIGINT NOT NULL COMMENT '属性ID',
    attribute_value TEXT NOT NULL COMMENT '属性值',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否有效',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_resource_attribute (resource_type, resource_id, attribute_id),
    INDEX idx_resource (resource_type, resource_id),
    INDEX idx_attribute_id (attribute_id),
    FOREIGN KEY (attribute_id) REFERENCES abac_attributes(id)
);
```

### 2.8.5 字段权限配置表 (field_permissions)
```sql
CREATE TABLE field_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_type VARCHAR(50) NOT NULL COMMENT '资源类型',
    field_name VARCHAR(100) NOT NULL COMMENT '字段名称',
    field_type ENUM('visible', 'editable', 'sensitive') NOT NULL COMMENT '字段类型',
    permission_level TINYINT DEFAULT 1 COMMENT '权限等级(1-10)',
    encryption_required BOOLEAN DEFAULT FALSE COMMENT '是否需要加密',
    masking_rule VARCHAR(100) COMMENT '脱敏规则',
    access_condition TEXT COMMENT '访问条件',
    description TEXT COMMENT '字段描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_resource_field (resource_type, field_name),
    INDEX idx_resource_type (resource_type),
    INDEX idx_permission_level (permission_level)
);
```

### 2.9 权限审计日志表 (permission_audit_logs)
```sql
CREATE TABLE permission_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    log_type ENUM('login', 'logout', 'permission_check', 'role_change', 'permission_grant', 'permission_revoke') NOT NULL COMMENT '日志类型',
    user_id BIGINT COMMENT '用户ID',
    target_user_id BIGINT COMMENT '目标用户ID',
    role_id BIGINT COMMENT '角色ID',
    permission_id BIGINT COMMENT '权限ID',
    resource_type VARCHAR(50) COMMENT '资源类型',
    resource_id VARCHAR(100) COMMENT '资源ID',
    action VARCHAR(50) COMMENT '操作类型',
    result ENUM('success', 'failure', 'denied') NOT NULL COMMENT '操作结果',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    request_url VARCHAR(500) COMMENT '请求URL',
    request_method VARCHAR(10) COMMENT '请求方法',
    response_code INT COMMENT '响应状态码',
    error_message TEXT COMMENT '错误信息',
    extra_data JSON COMMENT '额外数据',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_log_type (log_type),
    INDEX idx_user_id (user_id),
    INDEX idx_target_user_id (target_user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_resource (resource_type, resource_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (target_user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id)
);
```

## 3. API接口设计

### 3.1 用户权限管理
```typescript
// 获取用户权限信息
GET /api/permissions/users/{userId}

// 获取用户菜单权限
GET /api/permissions/users/{userId}/menus

// 检查用户权限
POST /api/permissions/users/{userId}/check
{
  "resource": "order",
  "action": "read",
  "resourceId": "12345"
}

// 批量检查用户权限
POST /api/permissions/users/{userId}/batch-check
{
  "permissions": [
    {"resource": "order", "action": "read"},
    {"resource": "user", "action": "create"}
  ]
}

// 分配用户角色
POST /api/permissions/users/{userId}/roles
{
  "roleIds": [1, 2, 3],
  "organizationId": 1,
  "expiresAt": "2024-12-31 23:59:59"
}

// 移除用户角色
DELETE /api/permissions/users/{userId}/roles/{roleId}

// 直接授权用户权限
POST /api/permissions/users/{userId}/permissions
{
  "permissionIds": [1, 2, 3],
  "permissionType": "grant",
  "expiresAt": "2024-12-31 23:59:59"
}
```

### 3.2 角色管理
```typescript
// 获取角色列表
GET /api/permissions/roles?page=1&size=20&organization_id=1&role_type=business

// 创建角色
POST /api/permissions/roles
{
  "roleCode": "service_manager",
  "roleName": "服务经理",
  "roleType": "business",
  "organizationId": 1,
  "description": "负责服务管理的角色",
  "maxUsers": 10
}

// 更新角色
PUT /api/permissions/roles/{roleId}
{
  "roleName": "高级服务经理",
  "description": "更新后的角色描述"
}

// 删除角色
DELETE /api/permissions/roles/{roleId}

// 获取角色权限
GET /api/permissions/roles/{roleId}/permissions

// 设置角色权限
POST /api/permissions/roles/{roleId}/permissions
{
  "permissionIds": [1, 2, 3, 4, 5],
  "dataFilters": {
    "1": {"organizationId": "current"},
    "2": {"departmentId": "current"}
  }
}

// 获取角色用户
GET /api/permissions/roles/{role_id}/users?page=1&size=20

// 复制角色
POST /api/permissions/roles/{roleId}/copy
{
  "newRoleCode": "service_manager_copy",
  "newRoleName": "服务经理副本"
}
```

### 3.3 权限管理
```typescript
// 获取权限列表
GET /api/permissions?page=1&size=20&module=order&permission_type=menu

// 创建权限
POST /api/permissions
{
  "permissionCode": "order:read",
  "permissionName": "查看订单",
  "permissionType": "api",
  "resourceType": "order",
  "action": "read",
  "module": "order",
  "description": "查看订单信息的权限"
}

// 更新权限
PUT /api/permissions/{permissionId}
{
  "permissionName": "查看所有订单",
  "description": "更新后的权限描述"
}

// 删除权限
DELETE /api/permissions/{permissionId}

// 获取权限树
GET /api/permissions/tree?module=order

// 批量创建权限
POST /api/permissions/batch
{
  "permissions": [
    {
      "permissionCode": "order:create",
      "permissionName": "创建订单",
      "action": "create"
    },
    {
      "permissionCode": "order:update",
      "permissionName": "更新订单",
      "action": "update"
    }
  ]
}
```

### 3.4 ABAC 属性管理
```typescript
// 获取属性定义列表
GET /api/permissions/abac/attributes?page=1&size=20&attribute_type=subject

// 创建属性定义
POST /api/permissions/abac/attributes
{
  "attributeCode": "user_level",
  "attributeName": "用户等级",
  "attributeType": "subject",
  "dataType": "string",
  "attributeSource": "user",
  "sourceField": "level",
  "description": "用户等级属性"
}

// 更新属性定义
PUT /api/permissions/abac/attributes/{attributeId}
{
  "attributeName": "用户VIP等级",
  "description": "更新后的属性描述"
}

// 删除属性定义
DELETE /api/permissions/abac/attributes/{attributeId}

// 获取用户属性值
GET /api/permissions/abac/users/{userId}/attributes

// 设置用户属性值
POST /api/permissions/abac/users/{userId}/attributes
{
  "attributes": [
    {
      "attributeId": 1,
      "attributeValue": "VIP",
      "effectiveFrom": "2024-01-01 00:00:00",
      "effectiveTo": "2024-12-31 23:59:59"
    }
  ]
}

// 获取资源属性值
GET /api/permissions/abac/resources/{resourceType}/{resourceId}/attributes

// 设置资源属性值
POST /api/permissions/abac/resources/{resourceType}/{resourceId}/attributes
{
  "attributes": [
    {
      "attributeId": 2,
      "attributeValue": "confidential"
    }
  ]
}
```

### 3.5 ABAC 策略管理
```typescript
// 获取策略列表
GET /api/permissions/abac/policies?page=1&size=20&resource_type=order

// 创建策略
POST /api/permissions/abac/policies
{
  "policyCode": "order_access_policy",
  "policyName": "订单访问策略",
  "resourceType": "order",
  "action": "read",
  "effect": "permit",
  "priority": 100,
  "conditionExpression": "subject.level == 'VIP' AND object.status != 'deleted'",
  "dataFilterExpression": "customer_id = subject.customer_id",
  "fieldFilterExpression": "exclude(sensitive_fields) IF subject.role != 'admin'",
  "timeConstraint": {
    "allowedHours": "09:00-18:00",
    "allowedDays": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
  },
  "description": "VIP用户可以在工作时间访问自己的订单"
}

// 更新策略
PUT /api/permissions/abac/policies/{policyId}
{
  "policyName": "高级订单访问策略",
  "priority": 150
}

// 删除策略
DELETE /api/permissions/abac/policies/{policyId}

// 测试策略
POST /api/permissions/abac/policies/test
{
  "userId": 123,
  "resourceType": "order",
  "resourceId": "ORD001",
  "action": "read",
  "context": {
    "ip": "192.168.1.100",
    "time": "2024-01-15 14:30:00",
    "userAgent": "Mozilla/5.0..."
  }
}

// 策略评估
POST /api/permissions/abac/evaluate
{
  "subject": {
    "userId": 123,
    "attributes": {
      "level": "VIP",
      "department": "sales",
      "role": "manager"
    }
  },
  "object": {
    "resourceType": "order",
    "resourceId": "ORD001",
    "attributes": {
      "status": "active",
      "confidentiality": "normal"
    }
  },
  "action": "read",
  "environment": {
    "time": "2024-01-15 14:30:00",
    "ip": "192.168.1.100",
    "location": "office"
  }
}
```

### 3.6 字段权限管理
```typescript
// 获取字段权限配置
GET /api/permissions/fields?resource_type=customer

// 设置字段权限
POST /api/permissions/fields
{
  "resourceType": "customer",
  "fieldName": "phone",
  "fieldType": "sensitive",
  "permissionLevel": 8,
  "encryptionRequired": true,
  "maskingRule": "phone",
  "accessCondition": "subject.role IN ['admin', 'manager'] OR subject.department = 'customer_service'",
  "description": "客户电话字段权限"
}

// 更新字段权限
PUT /api/permissions/fields/{fieldId}
{
  "permissionLevel": 9,
  "accessCondition": "subject.role = 'admin'"
}

// 删除字段权限
DELETE /api/permissions/fields/{fieldId}

// 获取用户可访问字段
GET /api/permissions/users/{userId}/fields/{resourceType}

// 数据脱敏预览
POST /api/permissions/fields/mask-preview
{
  "fieldType": "phone",
  "originalValue": "13812345678",
  "maskingRule": "phone"
}
```

### 3.7 组织管理
```typescript
// 获取组织树
GET /api/permissions/organizations/tree

// 创建组织
POST /api/permissions/organizations
{
  "orgCode": "BRANCH_001",
  "orgName": "北京分公司",
  "parentId": 1,
  "orgType": "branch",
  "managerId": 123,
  "contactPhone": "010-12345678"
}

// 更新组织
PUT /api/permissions/organizations/{orgId}
{
  "orgName": "北京分公司(总部)",
  "managerId": 124
}

// 删除组织
DELETE /api/permissions/organizations/{orgId}

// 获取组织用户
GET /api/permissions/organizations/{org_id}/users?page=1&size=20

// 移动组织
POST /api/permissions/organizations/{orgId}/move
{
  "newParentId": 2
}
```

### 3.5 审计日志
```typescript
// 获取权限审计日志
GET /api/permissions/audit_logs?page=1&size=20&log_type=permission_check&user_id=123&start_date=2024-01-01&end_date=2024-01-31

// 获取用户登录日志
GET /api/permissions/audit_logs/login?user_id=123&page=1&size=20

// 获取权限变更日志
GET /api/permissions/audit_logs/changes?target_user_id=123&page=1&size=20

// 导出审计日志
GET /api/permissions/audit_logs/export?format=excel&start_date=2024-01-01&end_date=2024-01-31
```

## 4. 核心业务逻辑

### 4.1 权限检查服务 (PermissionService)
```typescript
class PermissionService {
  // 检查用户权限
  async checkPermission(userId: number, resource: string, action: string, resourceId?: string): Promise<boolean> {
    // 1. 检查超级管理员
    if (await this.isSuperAdmin(userId)) {
      return true;
    }
    
    // 2. 获取用户权限缓存
    let userPermissions = await this.getUserPermissionsFromCache(userId);
    if (!userPermissions) {
      userPermissions = await this.loadUserPermissions(userId);
      await this.cacheUserPermissions(userId, userPermissions);
    }
    
    // 3. 检查直接权限
    const directPermission = await this.checkDirectPermission(userPermissions, resource, action);
    if (directPermission !== null) {
      return directPermission;
    }
    
    // 4. 检查角色权限
    const rolePermission = await this.checkRolePermission(userPermissions, resource, action);
    if (rolePermission !== null) {
      // 5. 检查数据权限
      if (resourceId) {
        return await this.checkDataPermission(userId, resource, action, resourceId, userPermissions);
      }
      return rolePermission;
    }
    
    // 6. 记录权限检查日志
    await this.logPermissionCheck(userId, resource, action, resourceId, false);
    
    return false;
  }
  
  // 批量检查权限
  async batchCheckPermissions(userId: number, permissions: PermissionCheck[]): Promise<PermissionResult[]> {
    const results: PermissionResult[] = [];
    
    // 获取用户权限信息
    const userPermissions = await this.getUserPermissions(userId);
    
    for (const permission of permissions) {
      const hasPermission = await this.checkPermission(
        userId, 
        permission.resource, 
        permission.action, 
        permission.resourceId
      );
      
      results.push({
        resource: permission.resource,
        action: permission.action,
        resourceId: permission.resourceId,
        hasPermission
      });
    }
    
    return results;
  }
  
  // 获取用户菜单权限
  async getUserMenus(userId: number): Promise<MenuPermission[]> {
    // 1. 获取用户所有菜单权限
    const menuPermissions = await this.getUserMenuPermissions(userId);
    
    // 2. 构建菜单树
    const menuTree = this.buildMenuTree(menuPermissions);
    
    // 3. 过滤无权限的菜单
    return this.filterMenusByPermission(menuTree);
  }
  
  // 检查数据权限
  private async checkDataPermission(
    userId: number, 
    resource: string, 
    action: string, 
    resourceId: string,
    userPermissions: UserPermissions
  ): Promise<boolean> {
    // 1. 获取数据权限规则
    const dataRules = await this.getDataPermissionRules(resource);
    
    // 2. 应用组织权限规则
    if (await this.checkOrganizationDataPermission(userId, resource, resourceId, userPermissions)) {
      return true;
    }
    
    // 3. 应用部门权限规则
    if (await this.checkDepartmentDataPermission(userId, resource, resourceId, userPermissions)) {
      return true;
    }
    
    // 4. 应用自定义数据权限规则
    return await this.checkCustomDataPermission(userId, resource, resourceId, dataRules);
  }
  
  // 加载用户权限
  private async loadUserPermissions(userId: number): Promise<UserPermissions> {
    // 1. 获取用户基本信息
    const user = await this.getUserInfo(userId);
    
    // 2. 获取用户角色
    const userRoles = await this.getUserRoles(userId);
    
    // 3. 获取角色权限
    const rolePermissions = await this.getRolePermissions(userRoles.map(r => r.roleId));
    
    // 4. 获取用户直接权限
    const directPermissions = await this.getUserDirectPermissions(userId);
    
    // 5. 合并权限
    return this.mergePermissions(user, userRoles, rolePermissions, directPermissions);
  }
}
```

### 4.2 角色管理服务 (RoleService)
```typescript
class RoleService {
  // 创建角色
  async createRole(roleData: CreateRoleRequest): Promise<Role> {
    // 1. 验证角色数据
    await this.validateRoleData(roleData);
    
    // 2. 检查角色编码唯一性
    const existingRole = await this.findRoleByCode(roleData.roleCode);
    if (existingRole) {
      throw new Error('角色编码已存在');
    }
    
    // 3. 创建角色
    const role = await this.createRoleRecord(roleData);
    
    // 4. 设置默认权限
    if (roleData.permissionIds && roleData.permissionIds.length > 0) {
      await this.setRolePermissions(role.id, roleData.permissionIds);
    }
    
    // 5. 记录操作日志
    await this.logRoleOperation('create', role.id, roleData.createdBy);
    
    return role;
  }
  
  // 分配角色权限
  async setRolePermissions(roleId: number, permissionIds: number[], dataFilters?: Record<number, any>): Promise<void> {
    // 1. 验证角色存在
    const role = await this.getRoleById(roleId);
    if (!role) {
      throw new Error('角色不存在');
    }
    
    // 2. 验证权限存在
    const permissions = await this.getPermissionsByIds(permissionIds);
    if (permissions.length !== permissionIds.length) {
      throw new Error('部分权限不存在');
    }
    
    // 3. 删除现有权限
    await this.clearRolePermissions(roleId);
    
    // 4. 添加新权限
    for (const permissionId of permissionIds) {
      await this.addRolePermission({
        roleId,
        permissionId,
        dataFilter: dataFilters?.[permissionId],
        grantedBy: this.getCurrentUserId()
      });
    }
    
    // 5. 清除相关用户权限缓存
    await this.clearUserPermissionsCache(roleId);
    
    // 6. 记录操作日志
    await this.logRolePermissionChange(roleId, permissionIds);
  }
  
  // 复制角色
  async copyRole(sourceRoleId: number, newRoleData: CopyRoleRequest): Promise<Role> {
    // 1. 获取源角色信息
    const sourceRole = await this.getRoleById(sourceRoleId);
    if (!sourceRole) {
      throw new Error('源角色不存在');
    }
    
    // 2. 创建新角色
    const newRole = await this.createRole({
      ...sourceRole,
      roleCode: newRoleData.newRoleCode,
      roleName: newRoleData.newRoleName,
      createdBy: this.getCurrentUserId()
    });
    
    // 3. 复制权限
    const sourcePermissions = await this.getRolePermissions(sourceRoleId);
    if (sourcePermissions.length > 0) {
      await this.setRolePermissions(
        newRole.id, 
        sourcePermissions.map(p => p.permissionId),
        sourcePermissions.reduce((acc, p) => {
          acc[p.permissionId] = p.dataFilter;
          return acc;
        }, {} as Record<number, any>)
      );
    }
    
    return newRole;
  }
  
  // 删除角色
  async deleteRole(roleId: number): Promise<void> {
    // 1. 检查角色是否存在
    const role = await this.getRoleById(roleId);
    if (!role) {
      throw new Error('角色不存在');
    }
    
    // 2. 检查是否为系统角色
    if (role.roleType === 'system') {
      throw new Error('系统角色不能删除');
    }
    
    // 3. 检查是否有用户使用该角色
    const userCount = await this.getRoleUserCount(roleId);
    if (userCount > 0) {
      throw new Error('该角色下还有用户，不能删除');
    }
    
    // 4. 删除角色权限
    await this.clearRolePermissions(roleId);
    
    // 5. 删除角色
    await this.deleteRoleRecord(roleId);
    
    // 6. 记录操作日志
    await this.logRoleOperation('delete', roleId, this.getCurrentUserId());
  }
}
```

### 4.3 组织管理服务 (OrganizationService)
```typescript
class OrganizationService {
  // 创建组织
  async createOrganization(orgData: CreateOrganizationRequest): Promise<Organization> {
    // 1. 验证组织数据
    await this.validateOrganizationData(orgData);
    
    // 2. 检查组织编码唯一性
    const existingOrg = await this.findOrganizationByCode(orgData.orgCode);
    if (existingOrg) {
      throw new Error('组织编码已存在');
    }
    
    // 3. 计算组织层级和路径
    const orgLevel = await this.calculateOrgLevel(orgData.parentId);
    const orgPath = await this.calculateOrgPath(orgData.parentId, orgData.orgCode);
    
    // 4. 创建组织
    const organization = await this.createOrganizationRecord({
      ...orgData,
      orgLevel,
      orgPath
    });
    
    // 5. 更新父组织的子组织数量
    if (orgData.parentId) {
      await this.updateChildOrgCount(orgData.parentId);
    }
    
    // 6. 记录操作日志
    await this.logOrganizationOperation('create', organization.id);
    
    return organization;
  }
  
  // 移动组织
  async moveOrganization(orgId: number, newParentId: number): Promise<void> {
    // 1. 验证组织存在
    const organization = await this.getOrganizationById(orgId);
    if (!organization) {
      throw new Error('组织不存在');
    }
    
    // 2. 验证新父组织存在
    if (newParentId) {
      const newParent = await this.getOrganizationById(newParentId);
      if (!newParent) {
        throw new Error('新父组织不存在');
      }
    }
    
    // 3. 检查是否形成循环引用
    if (await this.wouldCreateCycle(orgId, newParentId)) {
      throw new Error('移动操作会形成循环引用');
    }
    
    // 4. 更新组织层级和路径
    const newOrgLevel = await this.calculateOrgLevel(newParentId);
    const newOrgPath = await this.calculateOrgPath(newParentId, organization.orgCode);
    
    // 5. 更新组织信息
    await this.updateOrganization(orgId, {
      parentId: newParentId,
      orgLevel: newOrgLevel,
      orgPath: newOrgPath
    });
    
    // 6. 递归更新子组织的层级和路径
    await this.updateChildOrganizations(orgId);
    
    // 7. 更新相关用户的权限缓存
    await this.clearOrganizationUsersPermissionCache(orgId);
    
    // 8. 记录操作日志
    await this.logOrganizationOperation('move', orgId, { newParentId });
  }
  
  // 获取组织树
  async getOrganizationTree(rootId?: number): Promise<OrganizationTree[]> {
    // 1. 获取所有组织
    const organizations = await this.getAllOrganizations(rootId);
    
    // 2. 构建组织树
    return this.buildOrganizationTree(organizations, rootId);
  }
  
  // 获取用户可访问的组织
  async getUserAccessibleOrganizations(userId: number): Promise<Organization[]> {
    // 1. 获取用户信息
    const user = await this.getUserInfo(userId);
    
    // 2. 获取用户角色的组织权限
    const userRoles = await this.getUserRoles(userId);
    const accessibleOrgIds = new Set<number>();
    
    // 3. 添加用户所属组织
    if (user.organizationId) {
      accessibleOrgIds.add(user.organizationId);
    }
    
    // 4. 添加角色关联的组织
    for (const role of userRoles) {
      if (role.organizationId) {
        accessibleOrgIds.add(role.organizationId);
      }
    }
    
    // 5. 根据数据权限规则扩展可访问组织
    const expandedOrgIds = await this.expandOrganizationsByDataRules(userId, Array.from(accessibleOrgIds));
    
    // 6. 获取组织详细信息
    return await this.getOrganizationsByIds(expandedOrgIds);
  }
}
```

## 5. 前端界面设计

### 5.1 管理后台界面

#### 5.1.1 用户权限管理
- **用户列表页面**
  - 用户搜索和筛选（组织、部门、角色、状态）
  - 用户权限概览（角色、权限数量、最后登录）
  - 批量操作（分配角色、锁定/解锁、导出）

- **用户权限详情页面**
  - 用户基本信息展示
  - 角色分配管理（添加/移除角色、设置过期时间）
  - 直接权限管理（特殊权限授权）
  - 权限继承关系图
  - 操作日志记录

#### 5.1.2 角色管理页面
- **角色列表页面**
  - 角色搜索和筛选（类型、组织、状态）
  - 角色信息展示（名称、类型、用户数、权限数）
  - 角色操作（编辑、复制、删除、权限设置）

- **角色权限设置页面**
  - 权限树形结构展示
  - 权限批量选择和设置
  - 数据权限规则配置
  - 权限预览和测试

#### 5.1.3 权限管理页面
- **权限列表页面**
  - 权限树形结构展示
  - 权限搜索和筛选（模块、类型、状态）
  - 权限操作（添加、编辑、删除、排序）

- **权限编辑页面**
  - 权限基本信息设置
  - 资源和操作配置
  - 数据权限规则设置
  - 权限测试功能

#### 5.1.4 组织管理页面
- **组织架构树**
  - 可视化组织架构展示
  - 拖拽移动组织节点
  - 组织信息快速编辑
  - 组织用户统计

- **组织详情页面**
  - 组织基本信息管理
  - 组织用户列表
  - 组织角色配置
  - 权限继承设置

#### 5.1.5 审计日志页面
- **权限审计日志**
  - 日志搜索和筛选（时间、用户、操作类型）
  - 日志详情查看
  - 异常行为告警
  - 日志导出功能

### 5.2 用户端界面

#### 5.2.1 个人权限查看
- **我的权限页面**
  - 当前角色和权限展示
  - 权限范围说明
  - 权限申请入口

- **权限申请页面**
  - 权限申请表单
  - 申请理由说明
  - 申请进度跟踪

## 6. 性能优化

### 6.1 权限缓存策略
- **用户权限缓存**：缓存用户的完整权限信息，减少数据库查询
- **角色权限缓存**：缓存角色权限映射关系
- **组织架构缓存**：缓存组织树结构，支持快速权限继承计算
- **权限检查缓存**：缓存频繁的权限检查结果

### 6.2 数据库优化
- **索引优化**：为权限查询相关字段建立合适的索引
- **分表策略**：对审计日志等大数据量表进行分表
- **查询优化**：优化复杂的权限查询SQL，减少JOIN操作
- **读写分离**：权限读取使用从库，权限变更使用主库

### 6.3 权限计算优化
- **权限预计算**：预计算用户的有效权限，避免实时计算
- **批量权限检查**：支持批量权限检查，减少网络开销
- **权限继承优化**：优化组织权限继承算法
- **异步权限更新**：权限变更后异步更新相关缓存

## 7. 安全与防护

### 7.1 权限安全
- **最小权限原则**：默认最小权限，按需授权
- **权限隔离**：不同组织间的权限完全隔离
- **敏感权限保护**：对敏感操作权限进行特殊保护
- **权限有效期**：支持临时权限和自动过期

### 7.2 访问安全
- **会话管理**：安全的用户会话管理和超时控制
- **多因子认证**：支持短信、邮箱等多因子认证
- **异常检测**：检测异常登录和权限使用行为
- **IP白名单**：支持IP地址访问限制

### 7.3 数据安全
- **权限加密**：敏感权限信息加密存储
- **审计完整性**：确保审计日志的完整性和不可篡改
- **数据脱敏**：在日志中对敏感数据进行脱敏
- **备份恢复**：权限数据的定期备份和恢复机制

## 8. 监控与告警

### 8.1 权限监控
- **权限使用统计**：统计权限的使用频率和分布
- **异常权限检测**：检测异常的权限分配和使用
- **权限变更监控**：监控权限的变更频率和模式
- **用户行为分析**：分析用户的权限使用行为

### 8.2 系统监控
- **性能监控**：监控权限检查的响应时间和吞吐量
- **缓存监控**：监控权限缓存的命中率和更新频率
- **数据库监控**：监控权限相关表的查询性能
- **错误监控**：监控权限相关的错误和异常

### 8.3 安全告警
- **异常登录告警**：异常时间、地点的登录行为
- **权限滥用告警**：权限的异常使用和滥用行为
- **敏感操作告警**：敏感权限的使用和变更
- **系统安全告警**：权限系统的安全威胁和攻击

## 9. 具体角色权限设计

### 9.1 INSTALLER（安装师傅）角色权限

```typescript
// 安装师傅权限数组
const INSTALLER_PERMISSIONS = [
  // 安装任务管理
  'installation:view_assigned',      // 查看分配的安装任务
  'installation:accept_task',        // 接受安装任务
  'installation:update_progress',    // 更新安装进度
  'installation:upload_photos',      // 上传安装照片
  'installation:complete_task',        // 完成安装任务
  'installation:report_issues',        // 报告安装问题
  
  // 个人信息管理
  'installer:view_profile',          // 查看个人信息
  'installer:update_status',         // 更新工作状态
  'installer:view_schedule',         // 查看工作安排
  'installer:view_earnings',         // 查看收入信息
  
  // 客户服务
  'installation:contact_customer',   // 联系客户
  'installation:view_customer_info', // 查看客户信息（仅限必要信息）
  
  // 工具管理
  'installer:view_tools',            // 查看工具清单
  'installer:report_tool_issues',    // 报告工具问题
];
```

**角色定位**：
- **核心职责**：执行现场安装任务，确保安装质量和客户满意度
- **工作范围**：仅限被分配的安装任务，不能主动接单或查看其他任务
- **权限特点**：操作型权限，主要围绕安装执行流程

**权限范围**：
- **允许操作**：
  - 查看和接受分配的安装任务
  - 更新安装进度和状态
  - 上传安装过程和完成照片
  - 报告安装过程中的问题
  - 查看个人工作安排和收入
  - 联系客户确认安装细节
  
- **禁止操作**：
  - 主动申请或分配安装任务
  - 查看其他师傅的任务信息
  - 修改订单或客户信息
  - 处理客户投诉或售后问题
  - 查看团队其他成员信息

**工作流程示例**：
```
接收任务通知 → 查看任务详情 → 接受任务 → 联系客户 → 上门安装 → 上传照片 → 完成任务 → 客户验收
```

**与测量师的区别**：
- 安装师傅负责产品安装，测量师负责尺寸测量
- 安装师傅需要上传更多现场照片
- 安装师傅直接面对最终安装质量验收

### 9.2 MEASURER（测量师）角色权限

```typescript
// 测量师权限数组
const MEASURER_PERMISSIONS = [
  // 测量任务管理
  'measurement:view_assigned',        // 查看分配的测量任务
  'measurement:accept_task',          // 接受测量任务
  'measurement:update_status',        // 更新测量状态
  'measurement:upload_data',          // 上传测量数据
  'measurement:upload_photos',        // 上传现场照片
  'measurement:complete_task',        // 完成测量任务
  'measurement:report_issues',        // 报告测量问题
  
  // 测量数据管理
  'measurement:view_requirements',    // 查看测量需求
  'measurement:create_measurement',   // 创建测量单
  'measurement:edit_measurement',     // 编辑测量单
  'measurement:submit_measurement',   // 提交测量单
  
  // 个人信息管理
  'measurer:view_profile',            // 查看个人信息
  'measurer:update_status',           // 更新工作状态
  'measurer:view_schedule',           // 查看工作安排
  'measurer:view_earnings',           // 查看收入信息
  
  // 客户服务
  'measurement:contact_customer',     // 联系客户
  'measurement:view_customer_info',   // 查看客户信息（仅限必要信息）
  
  // 工具管理
  'measurer:view_tools',              // 查看测量工具
  'measurer:report_tool_issues',      // 报告工具问题
];
```

**角色定位**：
- **核心职责**：执行现场测量任务，确保测量数据准确性和完整性
- **工作范围**：仅限被分配的测量任务，专注于尺寸数据采集
- **权限特点**：专业测量工具使用，数据精确度要求高

**权限范围**：
- **允许操作**：
  - 查看和接受分配的测量任务
  - 现场测量和数据采集
  - 上传测量数据和现场照片
  - 创建和编辑测量单
  - 查看个人工作安排和收入
  - 联系客户确认测量细节
  
- **禁止操作**：
  - 主动申请或分配测量任务
  - 查看其他测量师的任务信息
  - 修改订单或产品配置
  - 处理客户投诉或售后问题
  - 进行安装或设计工作

**工作流程示例**：
```
接收任务通知 → 查看测量需求 → 接受任务 → 联系客户 → 上门测量 → 上传数据 → 提交测量单 → 完成任务
```

**与安装师傅的区别**：
- 测量师负责数据采集，安装师傅负责产品安装
- 测量师需要专业测量工具，安装师傅需要安装工具
- 测量师工作在安装之前，安装师工作在测量之后
- 测量师影响产品定制，安装师影响最终使用效果

### 9.3 INSTALLATION_DISPATCHER（安装派单员）角色权限

```typescript
// 安装派单员权限数组
const INSTALLATION_DISPATCHER_PERMISSIONS = [
  // 任务分配管理
  'installation:view_pending_tasks',        // 查看待分配安装任务
  'installation:assign_team',               // 分配安装团队
  'installation:assign_measurer',         // 分配测量师
  'installation:reassign_task',           // 重新分配任务
  'installation:cancel_assignment',         // 取消分配
  
  // 团队管理
  'dispatcher:view_teams',                  // 查看安装团队信息
  'dispatcher:view_team_schedule',        // 查看团队工作安排
  'dispatcher:view_team_skills',          // 查看团队技能等级
  'dispatcher:update_team_status',        // 更新团队状态
  
  // 任务监控
  'installation:view_task_progress',      // 查看任务进度
  'installation:view_task_history',       // 查看任务历史
  'installation:monitor_deadlines',       // 监控截止日期
  'installation:handle_delays',           // 处理延期申请
  
  // 协调沟通
  'dispatcher:contact_teams',             // 联系安装团队
  'dispatcher:contact_customers',         // 联系客户确认时间
  'dispatcher:coordinate_schedules',    // 协调时间安排
  'dispatcher:send_notifications',          // 发送通知提醒
  
  // 数据分析
  'dispatcher:view_performance_metrics',  // 查看绩效指标
  'dispatcher:generate_assignment_reports', // 生成分配报告
  'dispatcher:view_workload_analysis',    // 查看工作量分析
];
```

**角色定位**：
- **核心职责**：合理分配安装和测量任务，确保资源最优配置
- **工作范围**：统筹管理所有待分配任务和可用团队资源
- **权限特点**：全局视角，调度权限，协调能力强

**权限范围**：
- **允许操作**：
  - 查看所有待分配的安装和测量任务
  - 根据团队技能和工作负荷分配任务
  - 重新分配或调整已分配的任务
  - 监控任务进度和截止日期
  - 协调客户、团队之间的时间安排
  - 查看团队绩效和工作量分析
  - 发送各类通知提醒
  
- **禁止操作**：
  - 直接执行安装或测量工作
  - 修改任务的技术要求或标准
  - 处理客户投诉或质量问题
  - 管理团队的薪酬或合同信息
  - 访问客户的完整个人信息

**工作流程示例**：
```
接收新任务 → 分析任务要求 → 匹配合适团队 → 检查团队档期 → 分配任务 → 通知相关方 → 跟踪进度 → 处理变更
```

**与安装师傅/测量师的关系**：
- **上游关系**：接收来自订单系统的任务需求
- **下游关系**：向安装师傅和测量师分配具体任务
- **协调关系**：在客户、团队、管理层之间进行协调
- **监控关系**：跟踪任务执行情况，必要时进行干预

**关键决策点**：
- 任务分配的优先级判断
- 团队技能与任务要求的匹配
- 时间安排的最优化
- 突发情况的应急处理

### 9.4 安装服务提供商角色类型

基于安装管理模块设计，安装服务提供商分为三种类型，每种类型有不同的权限和管理模式：

#### 9.4.1 内部团队管理员（INTERNAL_TEAM_MANAGER）

```typescript
// 内部团队管理员权限数组
const INTERNAL_TEAM_MANAGER_PERMISSIONS = [
  // 团队人员管理
  'internal:manage_installers',         // 管理安装师傅
  'internal:manage_measurers',          // 管理测量师
  'internal:hire_staff',                // 招聘新员工
  'internal:train_staff',               // 培训员工
  'internal:evaluate_performance',      // 绩效评估
  
  // 任务分配管理
  'internal:assign_internal_tasks',     // 分配内部任务
  'internal:priority_assignment',     // 优先级分配
  'internal:emergency_dispatch',        // 紧急调度
  
  // 质量控制
  'internal:quality_inspection',        // 质量检查
  'internal:handle_complaints',         // 处理投诉
  'internal:implement_standards',       // 执行标准
  
  // 数据分析
  'internal:view_team_stats',           // 查看团队统计
  'internal:generate_reports',          // 生成报告
  'internal:analyze_efficiency',        // 分析效率
];
```

**角色特点**：
- **管理模式**：直接管理公司直属员工
- **权限范围**：全面的人员管理和任务分配权限
- **质量责任**：对安装质量负全责，有质量检查权
- **成本控制**：需要平衡效率与成本，优化资源配置

#### 9.4.2 外包服务商管理员（OUTSOURCED_PROVIDER_MANAGER）

```typescript
// 外包服务商管理员权限数组
const OUTSOURCED_PROVIDER_MANAGER_PERMISSIONS = [
  // 服务商管理
  'outsourced:manage_providers',        // 管理服务商
  'outsourced:evaluate_providers',      // 评估服务商
  'outsourced:contract_management',     // 合同管理
  'outsourced:price_negotiation',       // 价格谈判
  
  // 任务外包管理
  'outsourced:assign_contract_tasks', // 分配外包任务
  'outsourced:monitor_progress',        // 监控进度
  'outsourced:quality_supervision',   // 质量监督
  'outsourced:acceptance_inspection', // 验收检查
  
  // 风险控制
  'outsourced:risk_assessment',         // 风险评估
  'outsourced:penalty_management',      // 违约处理
  'outsourced:emergency_replacement',   // 紧急替换
  
  // 商务管理
  'outsourced:payment_approval',        // 付款审批
  'outsourced:invoice_verification',    // 发票核验
  'outsourced:performance_tracking',    // 绩效跟踪
];
```

**角色特点**：
- **合作模式**：管理外部合作伙伴关系
- **权限重点**：合同管理、质量监督、风险控制
- **商务职能**：涉及价格谈判和付款审批
- **灵活性**：可以快速扩展服务能力，应对业务高峰

#### 9.4.3 混合模式协调员（MIXED_MODE_COORDINATOR）

```typescript
// 混合模式协调员权限数组
const MIXED_MODE_COORDINATOR_PERMISSIONS = [
  // 资源统筹
  'mixed:resource_planning',            // 资源规划
  'mixed:capacity_analysis',            // 容量分析
  'mixed:load_balancing',               // 负载均衡
  'mixed:optimal_assignment',           // 最优分配
  
  // 模式切换
  'mixed:internal_external_switch',   // 内外切换
  'mixed:emergency_coordination',       // 紧急协调
  'mixed:backup_planning',              // 备用方案
  
  // 质量统一
  'mixed:standard_unification',         // 标准统一
  'mixed:quality_benchmarking',         // 质量对标
  'mixed:cross_training',               // 交叉培训
  
  // 成本优化
  'mixed:cost_analysis',                // 成本分析
  'mixed:efficiency_optimization',      // 效率优化
  'mixed:roi_calculation',              // ROI计算
];
```

**角色特点**：
- **统筹职能**：协调内部团队和外部服务商
- **优化目标**：实现成本、质量、效率的最优平衡
- **灵活调度**：根据业务需求动态调整内外比例
- **标准化**：确保不同来源的服务质量一致性

#### 9.4.4 三种服务提供商角色对比

| 对比维度 | 内部团队管理员 | 外包服务商管理员 | 混合模式协调员 |
|---------|-------------|---------------|-------------|
| **管理对象** | 直属员工 | 外部合作伙伴 | 内部团队+外部服务商 |
| **权限重点** | 人员管理 | 合同管理 | 资源统筹 |
| **质量责任** | 全责 | 监督责任 | 统一标准 |
| **成本控制** | 人力成本优化 | 外包成本控制 | 综合成本优化 |
| **灵活性** | 低 | 高 | 最高 |
| **响应速度** | 快 | 中等 | 快 |
| **适用场景** | 稳定业务 | 临时性需求 | 复杂业务环境 |

#### 9.4.5 服务提供商选择策略

**选择依据**：
- **业务稳定性**：长期稳定业务优先内部团队
- **技能要求**：特殊技能需求考虑外包服务商
- **成本考量**：综合比较人力成本与外包成本
- **质量要求**：高标准质量要求优先内部团队
- **响应速度**：紧急需求考虑内部团队或优质外包商

**切换机制**：
- 根据业务波动动态调整内外比例
- 建立服务商评估和淘汰机制
- 设置质量红线，触发自动切换
- 建立应急预案，应对突发情况

### 9.5 权限管理角色的3种角色类型

基于权限管理模块设计，权限管理角色分为三种类型，每种类型负责不同的权限管理职责：

#### 9.5.1 系统管理员（SYSTEM_ADMIN）

```typescript
// 系统管理员权限数组
const SYSTEM_ADMIN_PERMISSIONS = [
  // 用户管理权限
  'system:user_create',               // 创建用户
  'system:user_edit',                 // 编辑用户
  'system:user_delete',               // 删除用户
  'system:user_view',                 // 查看用户
  'system:user_import',               // 批量导入用户
  'system:user_export',               // 导出用户信息
  'system:user_status_control',       // 用户状态控制
  'system:password_reset',            // 密码重置
  
  // 系统配置权限
  'system:config_view',               // 查看系统配置
  'system:config_edit',               // 编辑系统配置
  'system:parameter_set',             // 参数设置
  'system:log_view',                  // 查看系统日志
  'system:monitor_dashboard',         // 监控面板
  'system:performance_analysis',        // 性能分析
  
  // 数据管理权限
  'system:data_backup',               // 数据备份
  'system:data_restore',              // 数据恢复
  'system:data_import',               // 数据导入
  'system:data_export',               // 数据导出
  'system:data_cleanup',              // 数据清理
  'system:database_maintenance',      // 数据库维护
];
```

**角色定位**：
- **核心职责**：负责系统层面的用户管理和基础配置
- **权限特点**：技术性强，不涉及具体业务权限
- **工作范围**：系统运维、用户账号管理、基础配置维护

#### 9.5.2 权限管理员（PERMISSION_ADMIN）

```typescript
// 权限管理员权限数组
const PERMISSION_ADMIN_PERMISSIONS = [
  // 角色管理权限
  'permission:role_create',           // 创建角色
  'permission:role_edit',             // 编辑角色
  'permission:role_delete',             // 删除角色
  'permission:role_view',               // 查看角色
  'permission:role_copy',             // 复制角色
  'permission:role_status_control',     // 角色状态控制
  
  // 权限分配权限
  'permission:assign_permissions',    // 分配权限
  'permission:revoke_permissions',    // 回收权限
  'permission:batch_assignment',      // 批量分配
  'permission:temporary_authorization', // 临时授权
  'permission:inheritance_config',      // 继承配置
  
  // 权限审计权限
  'permission:audit_log_view',        // 查看审计日志
  'permission:permission_trace',      // 权限追踪
  'permission:access_analysis',       // 访问分析
  'permission:security_report',       // 安全报告
  'permission:anomaly_detection',     // 异常检测
];
```

**角色定位**：
- **核心职责**：专门负责权限系统的管理和维护
- **权限特点**：专业性强，聚焦权限分配和审计
- **工作范围**：角色管理、权限分配、权限审计分析

#### 9.5.3 业务权限管理员（BUSINESS_PERMISSION_ADMIN）

```typescript
// 业务权限管理员权限数组
const BUSINESS_PERMISSION_ADMIN_PERMISSIONS = [
  // 业务角色管理
  'business:role_create',               // 创建业务角色
  'business:role_edit',                 // 编辑业务角色
  'business:role_view',                 // 查看业务角色
  'business:role_template_manage',      // 角色模板管理
  
  // 业务权限配置
  'business:data_scope_config',         // 数据范围配置
  'business:field_permission_config',   // 字段权限配置
  'business:operation_permission_set',  // 操作权限设置
  'business:workflow_permission_config', // 工作流权限配置
  
  // 权限规则管理
  'business:rule_create',               // 创建规则
  'business:rule_edit',                 // 编辑规则
  'business:rule_test',                 // 规则测试
  'business:rule_simulation',           // 规则模拟
  
  // 权限咨询支持
  'business:permission_consultation',   // 权限咨询
  'business:permission_training',       // 权限培训
  'business:best_practices',            // 最佳实践
];
```

**角色定位**：
- **核心职责**：负责业务层面的权限设计和配置
- **权限特点**：业务导向，需要理解业务流程
- **工作范围**：业务角色设计、数据权限规则、权限咨询支持

#### 9.5.4 三种权限管理角色对比

| 对比维度 | 系统管理员 | 权限管理员 | 业务权限管理员 |
|---------|-----------|-----------|-------------|
| **管理对象** | 用户账号、系统配置 | 权限系统本身 | 业务权限规则 |
| **技术深度** | 高 | 高 | 中等 |
| **业务理解** | 低 | 中等 | 高 |
| **权限范围** | 系统级 | 权限系统级 | 业务级 |
| **工作频率** | 日常维护 | 定期调整 | 按需配置 |
| **风险控制** | 系统风险 | 权限风险 | 业务风险 |

#### 9.5.5 权限管理协作流程

**典型权限管理流程**：
```
业务需求提出 → 业务权限管理员分析设计 → 权限管理员技术实现 → 系统管理员用户分配 → 权限审计监控
```

**职责分工**：
- **业务权限管理员**：理解业务需求，设计合理的权限方案
- **权限管理员**：确保权限系统的安全性和合规性
- **系统管理员**：负责具体的用户账号管理和系统维护

**协作机制**：
- 建立权限变更审批流程
- 定期进行权限审计和清理
- 建立权限管理知识库
- 提供权限管理培训和支持
