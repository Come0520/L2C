# 罗莱L2C销售管理系统 - 线索管理模块设计

## 1. 模块概述

### 1.1 功能目标
线索管理模块是L2C销售管理系统的核心业务模块，负责管理从线索获取到转化成销售单的完整生命周期。

**主要目标：**
- **线索获取**：支持多渠道线索录入和导入
- **线索跟踪**：完整的线索跟进记录和状态管理
- **线索分配**：智能分配和手动分配相结合
- **线索转化**：线索到销售单的无缝转化
- **数据分析**：线索来源、转化率等数据分析
- **客户管理**：线索客户信息的统一管理

### 1.2 线索来源渠道
- **线上渠道**：官网、微信小程序、H5页面
- **线下渠道**：门店到访、电话咨询、展会活动
- **推荐渠道**：老客户推荐、员工推荐
- **广告渠道**：百度推广、微信广告、抖音广告
- **合作渠道**：装修公司、设计师推荐

### 1.3 线索状态流程
```
新建线索 → 待分配 → 已分配 → 跟进中 → 成交 / 失效
```

**说明：**
- "已报价"作为标签而非状态，线索在报价后仍保持"跟进中"状态
- 标签系统支持多标签，如：已报价、高意向、需维护等

## 2. 数据库设计

### 2.1 线索表 (leads)
```sql
CREATE TABLE leads (
    id BIGSERIAL PRIMARY KEY,
    lead_no VARCHAR(32) UNIQUE NOT NULL, -- 线索编号
    customer_name VARCHAR(100) NOT NULL, -- 客户姓名
    customer_phone VARCHAR(15) NOT NULL, -- 客户电话
    customer_email VARCHAR(100), -- 客户邮箱
    customer_wechat VARCHAR(100), -- 客户微信
    customer_address TEXT, -- 客户地址
    customer_city_id BIGINT, -- 客户城市
    customer_district VARCHAR(100), -- 客户区域
    
    -- 需求信息
    product_category VARCHAR(50), -- 产品类别：窗帘、墙布、墙咔
    room_type VARCHAR(50), -- 房间类型：客厅、卧室、书房等
    house_area DECIMAL(10,2), -- 房屋面积
    decoration_stage VARCHAR(50), -- 装修阶段：未装修、装修中、已装修
    budget_range VARCHAR(50), -- 预算范围
    expected_date DATE, -- 期望完成时间
    special_requirements TEXT, -- 特殊需求
    
    -- 线索来源
    source_channel VARCHAR(50) NOT NULL, -- 来源渠道
    source_detail VARCHAR(200), -- 来源详情
    referrer_id BIGINT, -- 推荐人ID
    referrer_name VARCHAR(100), -- 推荐人姓名
    utm_source VARCHAR(100), -- 广告来源
    utm_medium VARCHAR(100), -- 广告媒介
    utm_campaign VARCHAR(100), -- 广告活动
    
    -- 状态管理
    status VARCHAR(20) DEFAULT 'new', -- 状态：new(新建), assigned(已分配), following(跟进中), converted(已转化), invalid(已失效)
    priority VARCHAR(20) DEFAULT 'normal', -- 优先级：high, normal, low
    quality_score INTEGER DEFAULT 0, -- 质量评分 0-100
    
    -- 分配信息
    assigned_to BIGINT, -- 分配给谁
    assigned_at TIMESTAMP, -- 分配时间
    assigned_by BIGINT, -- 分配人
    store_id BIGINT, -- 所属门店
    city_id BIGINT, -- 所属城市
    
    -- 跟进信息
    last_contact_at TIMESTAMP, -- 最后联系时间
    next_contact_at TIMESTAMP, -- 下次联系时间
    contact_count INTEGER DEFAULT 0, -- 联系次数
    follow_up_status VARCHAR(50), -- 跟进状态
    
    -- 转化信息
    converted_at TIMESTAMP, -- 转化时间
    sales_order_id BIGINT, -- 关联销售单ID
    conversion_value DECIMAL(10,2), -- 转化金额
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (assigned_to) REFERENCES users(id),
    FOREIGN KEY (assigned_by) REFERENCES users(id),
    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (city_id) REFERENCES cities(id),
    FOREIGN KEY (customer_city_id) REFERENCES cities(id),
    FOREIGN KEY (referrer_id) REFERENCES users(id),
    FOREIGN KEY (sales_order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_leads_lead_no ON leads(lead_no);
CREATE INDEX idx_leads_customer_phone ON leads(customer_phone);
CREATE INDEX idx_leads_status ON leads(status);
CREATE INDEX idx_leads_assigned_to ON leads(assigned_to);
CREATE INDEX idx_leads_source_channel ON leads(source_channel);
CREATE INDEX idx_leads_created_at ON leads(created_at);
CREATE INDEX idx_leads_city_store ON leads(city_id, store_id);
CREATE INDEX idx_leads_next_contact ON leads(next_contact_at);
```

### 2.2 线索跟进记录表 (lead_follow_ups)
```sql
CREATE TABLE lead_follow_ups (
    id BIGSERIAL PRIMARY KEY,
    lead_id BIGINT NOT NULL REFERENCES leads(id),
    follow_up_type VARCHAR(20) NOT NULL, -- 跟进类型：电话、微信、上门、邮件
    contact_result VARCHAR(20) NOT NULL, -- 联系结果：已联系、未接通、拒绝、有意向
    content TEXT NOT NULL, -- 跟进内容
    next_action VARCHAR(100), -- 下一步行动
    next_contact_time TIMESTAMP, -- 下次联系时间
    
    -- 客户反馈
    customer_feedback TEXT, -- 客户反馈
    interest_level VARCHAR(20), -- 兴趣程度：高、中、低
    concerns TEXT, -- 客户顾虑
    
    -- 附件信息
    attachments JSONB, -- 附件列表
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_follow_ups_lead_id ON lead_follow_ups(lead_id);
CREATE INDEX idx_follow_ups_created_at ON lead_follow_ups(created_at);
CREATE INDEX idx_follow_ups_created_by ON lead_follow_ups(created_by);
```

### 2.3 线索分配记录表 (lead_assignments)
```sql
CREATE TABLE lead_assignments (
    id BIGSERIAL PRIMARY KEY,
    lead_id BIGINT NOT NULL REFERENCES leads(id),
    from_user_id BIGINT, -- 原分配人
    to_user_id BIGINT NOT NULL, -- 新分配人
    assignment_type VARCHAR(20) NOT NULL, -- 分配类型：auto, manual, transfer
    assignment_reason VARCHAR(200), -- 分配原因
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (from_user_id) REFERENCES users(id),
    FOREIGN KEY (to_user_id) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_assignments_lead_id ON lead_assignments(lead_id);
CREATE INDEX idx_assignments_to_user ON lead_assignments(to_user_id);
CREATE INDEX idx_assignments_created_at ON lead_assignments(created_at);
```

### 2.4 线索标签表 (lead_tags)
```sql
CREATE TABLE lead_tags (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL, -- 标签名称
    color VARCHAR(7) DEFAULT '#1890ff', -- 标签颜色
    category VARCHAR(50), -- 标签分类
    description TEXT, -- 标签描述
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 预设标签数据
INSERT INTO lead_tags (name, color, category, description) VALUES
('已报价', '#1890ff', 'business', '已向客户提供报价'),
('高意向', '#52c41a', 'quality', '客户意向度较高'),
('需维护', '#faad14', 'follow', '需要持续跟进维护'),
('重点客户', '#f5222d', 'priority', '重要客户优先处理'),
('预算充足', '#722ed1', 'budget', '客户预算充足');

-- 线索标签关联表
CREATE TABLE lead_tag_relations (
    id BIGSERIAL PRIMARY KEY,
    lead_id BIGINT NOT NULL REFERENCES leads(id),
    tag_id BIGINT NOT NULL REFERENCES lead_tags(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(lead_id, tag_id)
);
```

### 2.5 线索导入记录表 (lead_imports)
```sql
CREATE TABLE lead_imports (
    id BIGSERIAL PRIMARY KEY,
    import_no VARCHAR(32) UNIQUE NOT NULL, -- 导入批次号
    file_name VARCHAR(200) NOT NULL, -- 文件名
    file_url VARCHAR(500), -- 文件地址
    total_count INTEGER NOT NULL, -- 总记录数
    success_count INTEGER DEFAULT 0, -- 成功数量
    failed_count INTEGER DEFAULT 0, -- 失败数量
    duplicate_count INTEGER DEFAULT 0, -- 重复数量
    status VARCHAR(20) DEFAULT 'processing', -- 导入状态
    error_details JSONB, -- 错误详情
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 2.6 线索质量评分规则表 (lead_scoring_rules)
```sql
CREATE TABLE lead_scoring_rules (
    id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL, -- 规则名称
    rule_type VARCHAR(50) NOT NULL, -- 规则类型：source, behavior, profile
    condition_field VARCHAR(100) NOT NULL, -- 条件字段
    condition_operator VARCHAR(20) NOT NULL, -- 条件操作符
    condition_value VARCHAR(200) NOT NULL, -- 条件值
    score_value INTEGER NOT NULL, -- 得分值
    is_active BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 0, -- 优先级
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.7 外键约束说明

#### 2.7.1 外键约束的作用
外键约束确保数据库中表与表之间的引用完整性，防止出现无效的关联数据：

1. **数据完整性保障**：
   - 防止插入不存在的用户ID、门店ID、城市ID等
   - 确保线索分配给有效的销售人员
   - 保证线索关联的订单、推荐人等数据的有效性

2. **引用完整性维护**：
   - 当删除用户时，系统会检查是否有线索关联该用户
   - 防止删除仍有线索关联的门店或城市
   - 确保数据删除的安全性

3. **业务逻辑保障**：
   - 线索只能分配给系统中存在的用户
   - 线索只能关联到有效的门店和城市
   - 跟进记录只能由有效用户创建

#### 2.7.2 主要外键约束关系

| 表名 | 字段 | 引用表 | 引用字段 | 说明 |
|------|------|--------|----------|------|
| leads | assigned_to | users | id | 线索分配的销售人员 |
| leads | assigned_by | users | id | 执行分配操作的用户 |
| leads | store_id | stores | id | 线索所属门店 |
| leads | city_id | cities | id | 线索所属城市 |
| leads | customer_city_id | cities | id | 客户所在城市 |
| leads | referrer_id | users | id | 推荐人用户 |
| leads | sales_order_id | sales_orders | id | 转化后的销售订单 |
| leads | created_by | users | id | 线索创建人 |
| leads | updated_by | users | id | 线索更新人 |
| lead_follow_ups | lead_id | leads | id | 跟进的线索 |
| lead_follow_ups | created_by | users | id | 跟进记录创建人 |
| lead_assignments | lead_id | leads | id | 分配的线索 |
| lead_assignments | from_user_id | users | id | 原分配人 |
| lead_assignments | to_user_id | users | id | 新分配人 |
| lead_assignments | created_by | users | id | 分配操作执行人 |
| lead_tag_relations | lead_id | leads | id | 关联的线索 |
| lead_tag_relations | tag_id | lead_tags | id | 关联的标签 |
| lead_imports | created_by | users | id | 导入操作执行人 |

#### 2.7.3 外键约束的好处

1. **防止数据不一致**：
   - 避免线索分配给不存在的用户
   - 防止关联到已删除的门店或城市
   - 确保所有关联数据的有效性

2. **提高数据质量**：
   - 强制执行业务规则
   - 减少数据清理工作
   - 提高数据可靠性

3. **简化查询逻辑**：
   - 可以安全地进行表连接查询
   - 不需要额外的数据有效性检查
   - 提高查询性能

4. **支持级联操作**：
   - 可以配置级联删除或更新
   - 自动维护数据一致性
   - 简化数据维护操作

## 3. API接口设计

### 3.1 线索管理接口

#### 3.1.1 创建线索
```typescript
POST /api/leads
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "customerName": "string",
  "customerPhone": "string",
  "customerEmail": "string",
  "customerWechat": "string",
  "customerAddress": "string",
  "customerCityId": 1,
  "customerDistrict": "string",
  "productCategory": "窗帘",
  "roomType": "客厅",
  "houseArea": 120.5,
  "decorationStage": "装修中",
  "budgetRange": "1-3万",
  "expectedDate": "2024-03-01",
  "specialRequirements": "string",
  "sourceChannel": "官网",
  "sourceDetail": "产品页面咨询",
  "utmSource": "baidu",
  "utmMedium": "cpc",
  "utmCampaign": "春季促销",
  "priority": "normal",
  "tags": ["高意向", "预算充足"]
}

// 响应体
{
  "code": 200,
  "message": "线索创建成功",
  "data": {
    "id": 1,
    "leadNo": "LD202401010001",
    "customerName": "张三",
    "customerPhone": "13800138000",
    "status": "new",
    "qualityScore": 75,
    "createdAt": "2024-01-01T10:00:00Z"
  }
}
```

#### 3.1.2 获取线索列表
```typescript
GET /api/leads?page=1&limit=20&status=new&assigned_to=1&source_channel=官网
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "leadNo": "LD202401010001",
        "customerName": "张三",
        "customerPhone": "13800138000",
        "productCategory": "窗帘",
        "sourceChannel": "官网",
        "status": "new",
        "priority": "normal",
        "qualityScore": 75,
        "assignedTo": {
          "id": 1,
          "name": "李销售"
        },
        "createdAt": "2024-01-01T10:00:00Z",
        "nextContactAt": "2024-01-02T10:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

#### 3.1.3 获取线索详情
```typescript
GET /api/leads/{id}
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "id": 1,
    "leadNo": "LD202401010001",
    "customerInfo": {
      "name": "张三",
      "phone": "13800138000",
      "email": "zhangsan@example.com",
      "wechat": "zhangsan_wx",
      "address": "北京市朝阳区xxx",
      "cityId": 1,
      "district": "朝阳区"
    },
    "requirementInfo": {
      "productCategory": "窗帘",
      "roomType": "客厅",
      "houseArea": 120.5,
      "decorationStage": "装修中",
      "budgetRange": "1-3万",
      "expectedDate": "2024-03-01",
      "specialRequirements": "需要遮光效果好的"
    },
    "sourceInfo": {
      "channel": "官网",
      "detail": "产品页面咨询",
      "referrer": null,
      "utmSource": "baidu",
      "utmMedium": "cpc",
      "utmCampaign": "春季促销"
    },
    "statusInfo": {
      "status": "assigned",
      "priority": "normal",
      "qualityScore": 75,
      "assignedTo": {
        "id": 1,
        "name": "李销售"
      },
      "assignedAt": "2024-01-01T11:00:00Z"
    },
    "followUpInfo": {
      "lastContactAt": "2024-01-01T15:00:00Z",
      "nextContactAt": "2024-01-02T10:00:00Z",
      "contactCount": 2,
      "followUpStatus": "有意向"
    },
    "tags": ["高意向", "预算充足"],
    "createdAt": "2024-01-01T10:00:00Z",
    "updatedAt": "2024-01-01T15:00:00Z"
  }
}
```

#### 3.1.4 更新线索
```typescript
PUT /api/leads/{id}
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "customerName": "string",
  "customerPhone": "string",
  "budgetRange": "3-5万",
  "priority": "high",
  "tags": ["高意向", "预算充足", "急需"]
}

// 响应体
{
  "code": 200,
  "message": "线索更新成功",
  "data": {
    "id": 1,
    "updatedAt": "2024-01-01T16:00:00Z"
  }
}
```

### 3.2 线索分配接口

#### 3.2.1 分配线索
```typescript
POST /api/leads/{id}/assign
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "assignedTo": 2,
  "assignmentReason": "专业对口"
}

// 响应体
{
  "code": 200,
  "message": "线索分配成功",
  "data": {
    "leadId": 1,
    "assignedTo": 2,
    "assignedAt": "2024-01-01T16:00:00Z"
  }
}
```

#### 3.2.2 批量分配线索
```typescript
POST /api/leads/batch_assign
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "leadIds": [1, 2, 3],
  "assignedTo": 2,
  "assignmentReason": "批量分配"
}

// 响应体
{
  "code": 200,
  "message": "批量分配成功",
  "data": {
    "successCount": 3,
    "failedCount": 0,
    "results": [
      {
        "leadId": 1,
        "success": true
      }
    ]
  }
}
```

#### 3.2.3 自动分配线索
```typescript
POST /api/leads/auto_assign
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "cityId": 1,
  "storeId": 1,
  "productCategory": "窗帘",
  "count": 10
}

// 响应体
{
  "code": 200,
  "message": "自动分配完成",
  "data": {
    "assignedCount": 8,
    "unassignedCount": 2,
    "assignments": [
      {
        "userId": 1,
        "userName": "李销售",
        "assignedLeads": 3
      }
    ]
  }
}
```

### 3.3 线索跟进接口

#### 3.3.1 添加跟进记录
```typescript
POST /api/leads/{id}/follow_ups
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "followUpType": "电话",
  "contactResult": "已联系",
  "content": "客户对产品很感兴趣，询问了价格和安装时间",
  "nextAction": "发送产品资料",
  "nextContactTime": "2024-01-02T10:00:00Z",
  "customerFeedback": "希望看到更多样式选择",
  "interestLevel": "高",
  "concerns": "担心安装时间过长",
  "attachments": [
    {
      "name": "产品图片.jpg",
      "url": "/uploads/xxx.jpg",
      "type": "image"
    }
  ]
}

// 响应体
{
  "code": 200,
  "message": "跟进记录添加成功",
  "data": {
    "id": 1,
    "leadId": 1,
    "createdAt": "2024-01-01T16:00:00Z"
  }
}
```

#### 3.3.2 获取跟进记录
```typescript
GET /api/leads/{id}/follow_ups?page=1&limit=10
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "followUpType": "电话",
        "contactResult": "已联系",
        "content": "客户对产品很感兴趣",
        "nextAction": "发送产品资料",
        "nextContactTime": "2024-01-02T10:00:00Z",
        "customerFeedback": "希望看到更多样式选择",
        "interestLevel": "高",
        "concerns": "担心安装时间过长",
        "attachments": [],
        "createdBy": {
          "id": 1,
          "name": "李销售"
        },
        "createdAt": "2024-01-01T16:00:00Z"
      }
    ],
    "total": 5,
    "page": 1,
    "limit": 10
  }
}
```

### 3.4 线索转化接口

#### 3.4.1 转化为销售单
```typescript
POST /api/leads/{id}/convert
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "conversionNote": "客户确认购买意向，准备下单"
}

// 响应体
{
  "code": 200,
  "message": "线索转化成功",
  "data": {
    "leadId": 1,
    "salesOrderId": 1001,
    "salesOrderNo": "SO202401010001",
    "convertedAt": "2024-01-01T17:00:00Z"
  }
}
```

### 3.5 线索导入导出接口

#### 3.5.1 导入线索
```typescript
POST /api/leads/import
Content-Type: multipart/form-data
Authorization: Bearer {token}

// 请求体（FormData）
file: Excel文件
sourceChannel: "批量导入"
assignmentRule: "auto" // auto, manual, none

// 响应体
{
  "code": 200,
  "message": "导入任务已创建",
  "data": {
    "importId": 1,
    "importNo": "IMP202401010001",
    "status": "processing"
  }
}
```

#### 3.5.2 获取导入状态
```typescript
GET /api/leads/imports/{importId}
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "id": 1,
    "importNo": "IMP202401010001",
    "fileName": "leads_20240101.xlsx",
    "totalCount": 100,
    "successCount": 85,
    "failedCount": 10,
    "duplicateCount": 5,
    "status": "completed",
    "errorDetails": [
      {
        "row": 5,
        "error": "手机号格式不正确"
      }
    ],
    "createdAt": "2024-01-01T10:00:00Z",
    "completedAt": "2024-01-01T10:05:00Z"
  }
}
```

#### 3.5.3 导出线索
```typescript
POST /api/leads/export
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "filters": {
    "status": ["new", "assigned"],
    "sourceChannel": ["官网", "微信"],
    "dateRange": {
      "start": "2024-01-01",
      "end": "2024-01-31"
    }
  },
  "fields": ["customerName", "customerPhone", "sourceChannel", "status"],
  "format": "xlsx"
}

// 响应体
{
  "code": 200,
  "message": "导出任务已创建",
  "data": {
    "exportId": 1,
    "downloadUrl": "/api/downloads/leads_export_20240101.xlsx"
  }
}
```

## 4. 核心业务逻辑

### 4.1 线索服务 (LeadService)

```typescript
@Injectable()
export class LeadService {
  constructor(
    private leadRepository: LeadRepository,
    private followUpRepository: FollowUpRepository,
    private assignmentRepository: AssignmentRepository,
    private scoringService: LeadScoringService,
    private assignmentService: LeadAssignmentService,
    private notificationService: NotificationService
  ) {}

  /**
   * 创建线索
   */
  async createLead(createLeadDto: CreateLeadDto, userId: number): Promise<Lead> {
    // 1. 生成线索编号
    const leadNo = await this.generateLeadNo();

    // 2. 检查重复线索
    await this.checkDuplicateLead(createLeadDto.customerPhone);

    // 3. 计算质量评分
    const qualityScore = await this.scoringService.calculateScore(createLeadDto);

    // 4. 创建线索
    const lead = await this.leadRepository.create({
      ...createLeadDto,
      leadNo,
      qualityScore,
      status: 'new',
      createdBy: userId
    });

    // 5. 添加标签
    if (createLeadDto.tags?.length > 0) {
      await this.addLeadTags(lead.id, createLeadDto.tags);
    }

    // 6. 触发自动分配（如果配置了自动分配规则）
    await this.tryAutoAssignment(lead);

    // 7. 发送通知
    await this.notificationService.sendLeadCreatedNotification(lead);

    return lead;
  }

  /**
   * 分配线索
   */
  async assignLead(
    leadId: number,
    assignedTo: number,
    assignedBy: number,
    reason?: string
  ): Promise<void> {
    // 1. 获取线索信息
    const lead = await this.leadRepository.findById(leadId);
    if (!lead) {
      throw new NotFoundException('线索不存在');
    }

    // 2. 检查分配权限
    await this.checkAssignmentPermission(assignedBy, lead);

    // 3. 检查被分配人的工作负载
    const canAssign = await this.assignmentService.checkWorkload(assignedTo);
    if (!canAssign) {
      throw new BadRequestException('被分配人工作负载已满');
    }

    // 4. 更新线索状态
    await this.leadRepository.update(leadId, {
      assignedTo,
      assignedAt: new Date(),
      assignedBy,
      status: 'assigned'
    });

    // 5. 记录分配历史
    await this.assignmentRepository.create({
      leadId,
      fromUserId: lead.assignedTo,
      toUserId: assignedTo,
      assignmentType: 'manual',
      assignmentReason: reason,
      createdBy: assignedBy
    });

    // 6. 发送分配通知
    await this.notificationService.sendLeadAssignedNotification(
      leadId,
      assignedTo,
      assignedBy
    );
  }

  /**
   * 添加跟进记录
   */
  async addFollowUp(
    leadId: number,
    followUpDto: CreateFollowUpDto,
    userId: number
  ): Promise<FollowUp> {
    // 1. 验证线索存在且有权限
    const lead = await this.validateLeadAccess(leadId, userId);

    // 2. 创建跟进记录
    const followUp = await this.followUpRepository.create({
      ...followUpDto,
      leadId,
      createdBy: userId
    });

    // 3. 更新线索的跟进信息
    await this.leadRepository.update(leadId, {
      lastContactAt: new Date(),
      nextContactAt: followUpDto.nextContactTime,
      contactCount: lead.contactCount + 1,
      followUpStatus: this.determineFollowUpStatus(followUpDto)
    });

    // 4. 重新计算质量评分
    const newScore = await this.scoringService.recalculateScore(leadId);
    await this.leadRepository.update(leadId, { qualityScore: newScore });

    // 5. 检查是否需要升级优先级
    await this.checkPriorityUpgrade(leadId, followUpDto);

    return followUp;
  }

  /**
   * 转化线索为销售单
   */
  async convertToSalesOrder(
    leadId: number,
    conversionDto: ConvertLeadDto,
    userId: number
  ): Promise<{ leadId: number; salesOrderId: number }> {
    // 1. 验证线索状态
    const lead = await this.validateLeadForConversion(leadId, userId);

    // 2. 创建销售单
    const salesOrder = await this.salesOrderService.createFromLead(
      lead,
      conversionDto,
      userId
    );

    // 3. 更新线索状态
    await this.leadRepository.update(leadId, {
      status: 'converted',
      convertedAt: new Date(),
      salesOrderId: salesOrder.id,
      conversionValue: salesOrder.totalAmount
    });

    // 4. 记录转化事件
    await this.followUpRepository.create({
      leadId,
      followUpType: 'conversion',
      contactResult: 'converted',
      content: `线索已转化为销售单：${salesOrder.orderNo}`,
      createdBy: userId
    });

    // 5. 发送转化通知
    await this.notificationService.sendLeadConvertedNotification(
      leadId,
      salesOrder.id,
      userId
    );

    return {
      leadId,
      salesOrderId: salesOrder.id
    };
  }

  /**
   * 批量导入线索
   */
  async importLeads(
    file: Express.Multer.File,
    importDto: ImportLeadsDto,
    userId: number
  ): Promise<LeadImport> {
    // 1. 创建导入记录
    const importRecord = await this.leadImportRepository.create({
      importNo: await this.generateImportNo(),
      fileName: file.originalname,
      fileUrl: await this.fileService.uploadFile(file),
      totalCount: 0,
      status: 'processing',
      createdBy: userId
    });

    // 2. 异步处理导入
    this.processImportAsync(importRecord.id, file, importDto, userId);

    return importRecord;
  }

  /**
   * 异步处理导入
   */
  private async processImportAsync(
    importId: number,
    file: Express.Multer.File,
    importDto: ImportLeadsDto,
    userId: number
  ): Promise<void> {
    try {
      // 1. 解析Excel文件
      const data = await this.excelService.parseFile(file);
      
      // 2. 更新总数
      await this.leadImportRepository.update(importId, {
        totalCount: data.length
      });

      let successCount = 0;
      let failedCount = 0;
      let duplicateCount = 0;
      const errorDetails = [];

      // 3. 逐行处理数据
      for (let i = 0; i < data.length; i++) {
        try {
          const row = data[i];
          
          // 验证数据格式
          const validationResult = await this.validateImportRow(row);
          if (!validationResult.isValid) {
            failedCount++;
            errorDetails.push({
              row: i + 2, // Excel行号从2开始
              error: validationResult.error
            });
            continue;
          }

          // 检查重复
          const isDuplicate = await this.checkDuplicateLead(row.customerPhone);
          if (isDuplicate) {
            duplicateCount++;
            continue;
          }

          // 创建线索
          const leadData = this.mapImportRowToLead(row, importDto, userId);
          await this.createLead(leadData, userId);
          successCount++;

        } catch (error) {
          failedCount++;
          errorDetails.push({
            row: i + 2,
            error: error.message
          });
        }
      }

      // 4. 更新导入结果
      await this.leadImportRepository.update(importId, {
        successCount,
        failedCount,
        duplicateCount,
        errorDetails,
        status: 'completed',
        completedAt: new Date()
      });

    } catch (error) {
      // 5. 处理导入失败
      await this.leadImportRepository.update(importId, {
        status: 'failed',
        errorDetails: [{ error: error.message }],
        completedAt: new Date()
      });
    }
  }

  /**
   * 检查重复线索
   */
  private async checkDuplicateLead(phone: string): Promise<boolean> {
    const existingLead = await this.leadRepository.findByPhone(phone);
    return !!existingLead;
  }

  /**
   * 生成线索编号
   */
  private async generateLeadNo(): Promise<string> {
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
    const sequence = await this.getNextSequence('lead', dateStr);
    return `LD${dateStr}${sequence.toString().padStart(4, '0')}`;
  }
}
```

### 4.2 线索评分服务 (LeadScoringService)

```typescript
@Injectable()
export class LeadScoringService {
  constructor(
    private scoringRuleRepository: ScoringRuleRepository
  ) {}

  /**
   * 计算线索质量评分
   */
  async calculateScore(leadData: any): Promise<number> {
    const rules = await this.scoringRuleRepository.findActiveRules();
    let totalScore = 0;

    for (const rule of rules) {
      const score = this.evaluateRule(rule, leadData);
      totalScore += score;
    }

    // 确保分数在0-100范围内
    return Math.min(Math.max(totalScore, 0), 100);
  }

  /**
   * 重新计算线索评分
   */
  async recalculateScore(leadId: number): Promise<number> {
    const lead = await this.leadRepository.findById(leadId);
    const followUps = await this.followUpRepository.findByLeadId(leadId);
    
    // 结合线索基础信息和跟进情况重新计算
    const baseScore = await this.calculateScore(lead);
    const followUpScore = this.calculateFollowUpScore(followUps);
    
    return Math.min(baseScore + followUpScore, 100);
  }

  /**
   * 评估单个规则
   */
  private evaluateRule(rule: ScoringRule, data: any): number {
    const fieldValue = this.getFieldValue(data, rule.conditionField);
    
    switch (rule.conditionOperator) {
      case 'equals':
        return fieldValue === rule.conditionValue ? rule.scoreValue : 0;
      
      case 'contains':
        return fieldValue?.includes(rule.conditionValue) ? rule.scoreValue : 0;
      
      case 'greater_than':
        return Number(fieldValue) > Number(rule.conditionValue) ? rule.scoreValue : 0;
      
      case 'less_than':
        return Number(fieldValue) < Number(rule.conditionValue) ? rule.scoreValue : 0;
      
      case 'in':
        const values = rule.conditionValue.split(',');
        return values.includes(fieldValue) ? rule.scoreValue : 0;
      
      default:
        return 0;
    }
  }

  /**
   * 计算跟进评分
   */
  private calculateFollowUpScore(followUps: FollowUp[]): number {
    let score = 0;
    
    // 跟进频率评分
    if (followUps.length > 0) {
      score += Math.min(followUps.length * 2, 10);
    }
    
    // 最近跟进评分
    const lastFollowUp = followUps[0];
    if (lastFollowUp) {
      const daysSinceLastContact = this.getDaysDiff(lastFollowUp.createdAt, new Date());
      if (daysSinceLastContact <= 1) score += 5;
      else if (daysSinceLastContact <= 3) score += 3;
      else if (daysSinceLastContact <= 7) score += 1;
    }
    
    // 客户兴趣度评分
    const highInterestFollowUps = followUps.filter(f => f.interestLevel === '高');
    score += highInterestFollowUps.length * 3;
    
    return score;
  }
}
```

### 4.3 线索分配服务 (LeadAssignmentService)

```typescript
@Injectable()
export class LeadAssignmentService {
  constructor(
    private userRepository: UserRepository,
    private leadRepository: LeadRepository
  ) {}

  /**
   * 自动分配线索
   */
  async autoAssignLeads(criteria: AutoAssignCriteria): Promise<AssignmentResult> {
    // 1. 获取待分配的线索
    const leads = await this.leadRepository.findUnassignedLeads(criteria);
    
    // 2. 获取可分配的销售人员
    const salespeople = await this.getAvailableSalespeople(criteria);
    
    if (salespeople.length === 0) {
      throw new BadRequestException('没有可分配的销售人员');
    }

    // 3. 执行分配算法
    const assignments = await this.executeAssignmentAlgorithm(leads, salespeople);
    
    // 4. 批量更新分配结果
    await this.batchUpdateAssignments(assignments);
    
    return {
      assignedCount: assignments.length,
      unassignedCount: leads.length - assignments.length,
      assignments: this.groupAssignmentsByUser(assignments)
    };
  }

  /**
   * 获取可分配的销售人员
   */
  private async getAvailableSalespeople(criteria: AutoAssignCriteria): Promise<User[]> {
    return await this.userRepository.findSalespeopleByArea({
      cityId: criteria.cityId,
      storeId: criteria.storeId,
      roleTypes: ['sales_consultant', 'store_manager'],
      isActive: true
    });
  }

  /**
   * 执行分配算法（轮询 + 负载均衡）
   */
  private async executeAssignmentAlgorithm(
    leads: Lead[],
    salespeople: User[]
  ): Promise<Assignment[]> {
    const assignments: Assignment[] = [];
    
    // 获取每个销售人员当前的工作负载
    const workloads = await this.getCurrentWorkloads(salespeople.map(s => s.id));
    
    // 按工作负载排序（负载少的优先）
    const sortedSalespeople = salespeople.sort((a, b) => 
      workloads[a.id] - workloads[b.id]
    );
    
    let currentIndex = 0;
    
    for (const lead of leads) {
      // 选择当前负载最少的销售人员
      const assignedTo = sortedSalespeople[currentIndex % sortedSalespeople.length];
      
      assignments.push({
        leadId: lead.id,
        assignedTo: assignedTo.id,
        assignmentType: 'auto'
      });
      
      // 更新工作负载计数
      workloads[assignedTo.id]++;
      
      // 重新排序以保持负载均衡
      sortedSalespeople.sort((a, b) => workloads[a.id] - workloads[b.id]);
      
      currentIndex++;
    }
    
    return assignments;
  }

  /**
   * 检查工作负载
   */
  async checkWorkload(userId: number): Promise<boolean> {
    const currentWorkload = await this.getCurrentWorkload(userId);
    const maxWorkload = await this.getMaxWorkloadLimit(userId);
    
    return currentWorkload < maxWorkload;
  }

  /**
   * 获取当前工作负载
   */
  private async getCurrentWorkload(userId: number): Promise<number> {
    return await this.leadRepository.countActiveLeadsByUser(userId);
  }

  /**
   * 获取工作负载上限
   */
  private async getMaxWorkloadLimit(userId: number): Promise<number> {
    // 可以根据用户角色、经验等因素动态设置
    const user = await this.userRepository.findById(userId);
    
    switch (user.roleType) {
      case 'sales_consultant':
        return 50; // 销售顾问最多50个活跃线索
      case 'store_manager':
        return 30; // 店长最多30个活跃线索
      default:
        return 20;
    }
  }
}
```

## 5. 前端界面设计

### 5.1 Web端线索管理界面

#### 5.1.1 线索列表页面
```typescript
// pages/leads/index.tsx
import React, { useState, useEffect } from 'react';
import { Table, Button, Input, Select, DatePicker, Tag, Space } from 'antd';
import { PlusOutlined, SearchOutlined, FilterOutlined } from '@ant-design/icons';

const LeadsPage: React.FC = () => {
  const [leads, setLeads] = useState([]);
  const [loading, setLoading] = useState(false);
  const [filters, setFilters] = useState({
    status: '',
    sourceChannel: '',
    assignedTo: '',
    dateRange: null
  });

  const columns = [
    {
      title: '线索编号',
      dataIndex: 'leadNo',
      key: 'leadNo',
      width: 120
    },
    {
      title: '客户信息',
      key: 'customer',
      render: (record) => (
        <div>
          <div>{record.customerName}</div>
          <div style={{ color: '#666', fontSize: '12px' }}>
            {record.customerPhone}
          </div>
        </div>
      )
    },
    {
      title: '产品类别',
      dataIndex: 'productCategory',
      key: 'productCategory'
    },
    {
      title: '来源渠道',
      dataIndex: 'sourceChannel',
      key: 'sourceChannel'
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (status) => (
        <Tag color={getStatusColor(status)}>
          {getStatusText(status)}
        </Tag>
      )
    },
    {
      title: '优先级',
      dataIndex: 'priority',
      key: 'priority',
      render: (priority) => (
        <Tag color={getPriorityColor(priority)}>
          {getPriorityText(priority)}
        </Tag>
      )
    },
    {
      title: '质量评分',
      dataIndex: 'qualityScore',
      key: 'qualityScore',
      render: (score) => (
        <div>
          <div>{score}分</div>
          <div style={{ 
            width: '60px', 
            height: '4px', 
            backgroundColor: '#f0f0f0',
            borderRadius: '2px'
          }}>
            <div style={{
              width: `${score}%`,
              height: '100%',
              backgroundColor: getScoreColor(score),
              borderRadius: '2px'
            }} />
          </div>
        </div>
      )
    },
    {
      title: '分配给',
      key: 'assignedTo',
      render: (record) => (
        record.assignedTo ? record.assignedTo.name : '未分配'
      )
    },
    {
      title: '创建时间',
      dataIndex: 'createdAt',
      key: 'createdAt',
      render: (date) => new Date(date).toLocaleDateString()
    },
    {
      title: '操作',
      key: 'actions',
      render: (record) => (
        <Space>
          <Button size="small" onClick={() => viewLead(record.id)}>
            查看
          </Button>
          <Button size="small" onClick={() => editLead(record.id)}>
            编辑
          </Button>
          <Button size="small" onClick={() => assignLead(record.id)}>
            分配
          </Button>
        </Space>
      )
    }
  ];

  return (
    <div className="leads-page">
      <div className="page-header">
        <h1>线索管理</h1>
        <Space>
          <Button type="primary" icon={<PlusOutlined />} onClick={createLead}>
            新建线索
          </Button>
          <Button icon={<FilterOutlined />} onClick={showFilters}>
            筛选
          </Button>
        </Space>
      </div>

      <div className="search-filters">
        <Space>
          <Input
            placeholder="搜索客户姓名、电话"
            prefix={<SearchOutlined />}
            style={{ width: 200 }}
            onChange={handleSearch}
          />
          <Select
            placeholder="状态"
            style={{ width: 120 }}
            value={filters.status}
            onChange={(value) => setFilters({...filters, status: value})}
          >
            <Select.Option value="">全部</Select.Option>
            <Select.Option value="new">新建</Select.Option>
            <Select.Option value="assigned">已分配</Select.Option>
            <Select.Option value="following">跟进中</Select.Option>
            <Select.Option value="converted">已转化</Select.Option>
            <Select.Option value="invalid">已失效</Select.Option>
          </Select>
          <Select
            placeholder="来源渠道"
            style={{ width: 120 }}
            value={filters.sourceChannel}
            onChange={(value) => setFilters({...filters, sourceChannel: value})}
          >
            <Select.Option value="">全部</Select.Option>
            <Select.Option value="官网">官网</Select.Option>
            <Select.Option value="微信">微信</Select.Option>
            <Select.Option value="电话">电话</Select.Option>
            <Select.Option value="门店">门店</Select.Option>
          </Select>
        </Space>
      </div>

      <Table
        columns={columns}
        dataSource={leads}
        loading={loading}
        rowKey="id"
        pagination={{
          total: leads.length,
          pageSize: 20,
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total) => `共 ${total} 条记录`
        }}
      />
    </div>
  );
};
```

#### 5.1.2 线索详情页面
```typescript
// pages/leads/detail.tsx
import React, { useState, useEffect } from 'react';
import { Card, Descriptions, Timeline, Button, Modal, Form, Input } from 'antd';

const LeadDetailPage: React.FC = () => {
  const [lead, setLead] = useState(null);
  const [followUps, setFollowUps] = useState([]);
  const [showFollowUpModal, setShowFollowUpModal] = useState(false);

  return (
    <div className="lead-detail-page">
      <div className="page-header">
        <h1>线索详情</h1>
        <Space>
          <Button onClick={() => setShowFollowUpModal(true)}>
            添加跟进
          </Button>
          <Button type="primary" onClick={convertToOrder}>
            转化为销售单
          </Button>
        </Space>
      </div>

      <div className="detail-content">
        <Card title="客户信息" style={{ marginBottom: 16 }}>
          <Descriptions column={2}>
            <Descriptions.Item label="客户姓名">
              {lead?.customerName}
            </Descriptions.Item>
            <Descriptions.Item label="联系电话">
              {lead?.customerPhone}
            </Descriptions.Item>
            <Descriptions.Item label="客户邮箱">
              {lead?.customerEmail}
            </Descriptions.Item>
            <Descriptions.Item label="微信号">
              {lead?.customerWechat}
            </Descriptions.Item>
            <Descriptions.Item label="客户地址" span={2}>
              {lead?.customerAddress}
            </Descriptions.Item>
          </Descriptions>
        </Card>

        <Card title="需求信息" style={{ marginBottom: 16 }}>
          <Descriptions column={2}>
            <Descriptions.Item label="产品类别">
              {lead?.productCategory}
            </Descriptions.Item>
            <Descriptions.Item label="房间类型">
              {lead?.roomType}
            </Descriptions.Item>
            <Descriptions.Item label="房屋面积">
              {lead?.houseArea}㎡
            </Descriptions.Item>
            <Descriptions.Item label="装修阶段">
              {lead?.decorationStage}
            </Descriptions.Item>
            <Descriptions.Item label="预算范围">
              {lead?.budgetRange}
            </Descriptions.Item>
            <Descriptions.Item label="期望时间">
              {lead?.expectedDate}
            </Descriptions.Item>
            <Descriptions.Item label="特殊需求" span={2}>
              {lead?.specialRequirements}
            </Descriptions.Item>
          </Descriptions>
        </Card>

        <Card title="跟进记录" style={{ marginBottom: 16 }}>
          <Timeline>
            {followUps.map(followUp => (
              <Timeline.Item key={followUp.id}>
                <div>
                  <div style={{ fontWeight: 'bold' }}>
                    {followUp.followUpType} - {followUp.contactResult}
                  </div>
                  <div style={{ margin: '8px 0' }}>
                    {followUp.content}
                  </div>
                  <div style={{ color: '#666', fontSize: '12px' }}>
                    {followUp.createdBy.name} · {new Date(followUp.createdAt).toLocaleString()}
                  </div>
                </div>
              </Timeline.Item>
            ))}
          </Timeline>
        </Card>
      </div>

      <FollowUpModal
        visible={showFollowUpModal}
        onCancel={() => setShowFollowUpModal(false)}
        onSubmit={handleFollowUpSubmit}
        leadId={lead?.id}
      />
    </div>
  );
};
```

### 5.2 移动端线索管理界面

#### 5.2.1 移动端线索列表
```typescript
// pages/leads/index.tsx (Taro)
import { View, ScrollView, Input } from '@tarojs/components';
import { AtList, AtListItem, AtTag, AtButton } from 'taro-ui';

const LeadsPage = () => {
  const [leads, setLeads] = useState([]);
  const [searchText, setSearchText] = useState('');

  return (
    <View className="leads-page">
      <View className="search-bar">
        <Input
          placeholder="搜索客户姓名、电话"
          value={searchText}
          onInput={(e) => setSearchText(e.detail.value)}
        />
      </View>

      <ScrollView scrollY className="leads-list">
        {leads.map(lead => (
          <View key={lead.id} className="lead-item" onClick={() => viewLead(lead.id)}>
            <View className="lead-header">
              <View className="customer-name">{lead.customerName}</View>
              <AtTag
                size="small"
                type={getStatusType(lead.status)}
              >
                {getStatusText(lead.status)}
              </AtTag>
            </View>
            
            <View className="lead-info">
              <View className="phone">{lead.customerPhone}</View>
              <View className="source">{lead.sourceChannel}</View>
            </View>
            
            <View className="lead-meta">
              <View className="score">评分: {lead.qualityScore}</View>
              <View className="time">{formatTime(lead.createdAt)}</View>
            </View>
          </View>
        ))}
      </ScrollView>

      <View className="fab">
        <AtButton
          type="primary"
          circle
          size="small"
          onClick={createLead}
        >
          +
        </AtButton>
      </View>
    </View>
  );
};
```

## 6. 性能优化

### 6.1 数据库优化
- **索引优化**：为常用查询字段创建复合索引
- **分页查询**：使用游标分页提高大数据量查询性能
- **读写分离**：查询操作使用只读副本
- **数据归档**：定期归档历史线索数据

### 6.2 缓存策略
- **Redis缓存**：缓存热点线索数据和用户信息
- **查询缓存**：缓存复杂统计查询结果
- **分布式缓存**：使用一致性哈希分布缓存数据

### 6.3 异步处理
- **消息队列**：线索分配、通知发送使用异步处理
- **批量操作**：线索导入、批量分配使用后台任务
- **事件驱动**：使用事件总线处理线索状态变更

## 7. 安全和权限控制

### 7.1 数据权限
- **角色权限**：不同角色查看不同范围的线索数据
- **数据隔离**：按城市、门店进行数据隔离
- **字段权限**：敏感字段按权限显示

### 7.2 操作权限
- **创建权限**：驻店销售、业务、销售负责人均可创建线索
  - 驻店销售：负责到店客户实时录入，创建后默认归属自己，不可分配
  - 业务：负责大客户或特定渠道批量导入，创建后默认归属自己，不可分配
  - 销售负责人：负责总览或特殊情况创建，可进入"待分配"状态
- **分配权限**：
  - 销售负责人：最高层级分配权限，可分配给城市授权人员，可跨部门分配
  - 业务：中级分配权限，仅限分配已归属自己的线索，不可跨部门分配
  - 驻店销售：无分配权限，仅可接收上级分配的线索
- **转化权限**：只有线索负责人可转化线索

### 7.3 审计日志
- **操作记录**：记录所有线索相关操作
- **数据变更**：记录字段变更历史
- **访问日志**：记录线索访问日志

## 8. 监控和告警

### 8.1 业务监控
- **线索转化率**：监控各渠道线索转化情况
- **响应时间**：监控线索分配和跟进及时性
- **质量评分**：监控线索质量趋势

### 8.2 系统监控
- **API性能**：监控接口响应时间和成功率
- **数据库性能**：监控查询性能和连接数
- **缓存命中率**：监控缓存使用效果

### 8.3 告警配置
- **线索积压**：未分配线索超过阈值告警
- **跟进超时**：线索跟进超时告警
- **系统异常**：API错误率超过阈值告警

## 9. 总结

线索管理模块作为L2C销售管理系统的核心业务模块，提供了完整的线索生命周期管理解决方案。通过多渠道线索获取、智能分配算法、质量评分体系、完整的跟进记录，实现了线索的高效管理和转化。

**核心特性：**
- 支持多渠道线索录入和批量导入
- 智能线索分配和负载均衡
- 基于规则的质量评分系统
- 完整的跟进记录和状态管理
- 无缝转化为销售单
- 全面的数据分析和报表

该模块为销售团队提供了强大的线索管理工具，提高了线索转化率和销售效率，是整个销售流程的重要基础。
