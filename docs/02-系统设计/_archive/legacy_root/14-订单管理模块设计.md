# 罗莱L2C销售管理系统 - 订单管理模块设计

## 1. 模块概述

### 1.1 功能目标
订单管理模块是L2C销售管理系统的核心交易模块，负责管理从销售订单创建到交付完成的完整生命周期。

**主要目标：**
- **订单创建**：支持多种方式创建销售订单
- **订单状态管理**：完整的订单状态流转和跟踪
- **订单变更**：支持订单修改、取消、退款等操作
- **库存管理**：与库存系统集成，实时库存检查
- **财务集成**：与财务系统集成，支持多种支付方式
- **物流跟踪**：订单物流状态实时跟踪
- **售后服务**：完整的售后服务流程管理

### 1.2 订单类型
- **销售订单**：正常销售订单
- **定制订单**：个性化定制产品订单
- **补货订单**：补充发货订单
- **退换货订单**：退货、换货订单
- **维修订单**：售后维修服务订单

### 1.3 订单状态流程
```
待确认 → 已确认 → 待生产 → 生产中 → 待发货 → 已发货 → 待安装 → 安装中 → 已完成 → 已评价
                ↓
              已取消 → 退款中 → 已退款
```

## 2. 数据库设计

### 2.1 销售订单表 (sales_orders)
```sql
CREATE TABLE sales_orders (
    id BIGSERIAL PRIMARY KEY,
    order_no VARCHAR(32) UNIQUE NOT NULL, -- 订单编号
    
    -- 客户信息
    customer_id BIGINT, -- 客户ID
    customer_name VARCHAR(100) NOT NULL, -- 客户姓名
    customer_phone VARCHAR(15) NOT NULL, -- 客户电话
    customer_email VARCHAR(100), -- 客户邮箱
    
    -- 收货信息
    delivery_name VARCHAR(100) NOT NULL, -- 收货人姓名
    delivery_phone VARCHAR(15) NOT NULL, -- 收货人电话
    delivery_address TEXT NOT NULL, -- 收货地址
    delivery_city_id BIGINT NOT NULL, -- 收货城市
    delivery_district VARCHAR(100), -- 收货区域
    delivery_postcode VARCHAR(10), -- 邮政编码
    
    -- 订单基本信息
    order_type VARCHAR(20) DEFAULT 'sales', -- 订单类型
    order_source VARCHAR(50) NOT NULL, -- 订单来源
    lead_id BIGINT, -- 关联线索ID
    quotation_id BIGINT, -- 关联报价单ID
    
    -- 金额信息
    subtotal_amount DECIMAL(10,2) NOT NULL DEFAULT 0, -- 商品小计
    discount_amount DECIMAL(10,2) DEFAULT 0, -- 优惠金额
    shipping_fee DECIMAL(10,2) DEFAULT 0, -- 运费
    installation_fee DECIMAL(10,2) DEFAULT 0, -- 安装费
    tax_amount DECIMAL(10,2) DEFAULT 0, -- 税费
    total_amount DECIMAL(10,2) NOT NULL, -- 订单总额
    paid_amount DECIMAL(10,2) DEFAULT 0, -- 已付金额
    refund_amount DECIMAL(10,2) DEFAULT 0, -- 退款金额
    
    -- 状态信息
    status VARCHAR(20) DEFAULT 'pending', -- 订单状态
    payment_status VARCHAR(20) DEFAULT 'unpaid', -- 支付状态
    delivery_status VARCHAR(20) DEFAULT 'pending', -- 发货状态
    installation_status VARCHAR(20) DEFAULT 'pending', -- 安装状态
    
    -- 时间信息
    order_date DATE NOT NULL, -- 下单日期
    expected_delivery_date DATE, -- 预期交货日期
    actual_delivery_date DATE, -- 实际交货日期
    expected_installation_date DATE, -- 预期安装日期
    actual_installation_date DATE, -- 实际安装日期
    completion_date DATE, -- 完成日期
    
    -- 业务信息
    sales_person_id BIGINT NOT NULL, -- 销售人员
    store_id BIGINT NOT NULL, -- 所属门店
    city_id BIGINT NOT NULL, -- 所属城市
    
    -- 备注信息
    customer_notes TEXT, -- 客户备注
    internal_notes TEXT, -- 内部备注
    special_requirements TEXT, -- 特殊要求
    
    -- 优惠信息
    coupon_id BIGINT, -- 使用的优惠券
    promotion_id BIGINT, -- 参与的促销活动
    points_used INTEGER DEFAULT 0, -- 使用的积分
    points_earned INTEGER DEFAULT 0, -- 获得的积分
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (delivery_city_id) REFERENCES cities(id),
    FOREIGN KEY (lead_id) REFERENCES leads(id),
    FOREIGN KEY (quotation_id) REFERENCES quotations(id),
    FOREIGN KEY (sales_person_id) REFERENCES users(id),
    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (city_id) REFERENCES cities(id),
    FOREIGN KEY (coupon_id) REFERENCES coupons(id),
    FOREIGN KEY (promotion_id) REFERENCES promotions(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_sales_orders_order_no ON sales_orders(order_no);
CREATE INDEX idx_sales_orders_customer_phone ON sales_orders(customer_phone);
CREATE INDEX idx_sales_orders_status ON sales_orders(status);
CREATE INDEX idx_sales_orders_sales_person ON sales_orders(sales_person_id);
CREATE INDEX idx_sales_orders_store_city ON sales_orders(store_id, city_id);
CREATE INDEX idx_sales_orders_order_date ON sales_orders(order_date);
CREATE INDEX idx_sales_orders_lead_id ON sales_orders(lead_id);
```

### 2.2 订单商品表 (order_items)
```sql
CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES sales_orders(id),
    
    -- 商品信息
    product_id BIGINT NOT NULL, -- 商品ID
    product_sku VARCHAR(100) NOT NULL, -- 商品SKU
    product_name VARCHAR(200) NOT NULL, -- 商品名称
    product_category VARCHAR(50), -- 商品类别
    product_brand VARCHAR(100), -- 商品品牌
    product_model VARCHAR(100), -- 商品型号
    product_color VARCHAR(50), -- 商品颜色
    product_size VARCHAR(100), -- 商品尺寸
    
    -- 规格信息
    specifications JSONB, -- 商品规格（JSON格式）
    customization_details JSONB, -- 定制详情
    
    -- 数量和价格
    quantity DECIMAL(10,2) NOT NULL, -- 数量
    unit VARCHAR(20) DEFAULT '件', -- 单位
    unit_price DECIMAL(10,2) NOT NULL, -- 单价
    discount_rate DECIMAL(5,2) DEFAULT 0, -- 折扣率
    discount_amount DECIMAL(10,2) DEFAULT 0, -- 折扣金额
    subtotal DECIMAL(10,2) NOT NULL, -- 小计金额
    
    -- 生产信息
    production_status VARCHAR(20) DEFAULT 'pending', -- 生产状态
    production_start_date DATE, -- 生产开始日期
    production_end_date DATE, -- 生产完成日期
    production_notes TEXT, -- 生产备注
    
    -- 质检信息
    quality_status VARCHAR(20) DEFAULT 'pending', -- 质检状态
    quality_check_date DATE, -- 质检日期
    quality_notes TEXT, -- 质检备注
    
    -- 系统字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (product_id) REFERENCES products(id)
);

-- 索引
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
CREATE INDEX idx_order_items_sku ON order_items(product_sku);
CREATE INDEX idx_order_items_production_status ON order_items(production_status);
```

### 2.3 订单状态变更记录表 (order_status_logs)
```sql
CREATE TABLE order_status_logs (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES sales_orders(id),
    status_type VARCHAR(20) NOT NULL, -- 状态类型：order, payment, delivery, installation
    from_status VARCHAR(20), -- 原状态
    to_status VARCHAR(20) NOT NULL, -- 新状态
    change_reason VARCHAR(200), -- 变更原因
    notes TEXT, -- 备注
    attachments JSONB, -- 附件
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_status_logs_order_id ON order_status_logs(order_id);
CREATE INDEX idx_status_logs_status_type ON order_status_logs(status_type);
CREATE INDEX idx_status_logs_created_at ON order_status_logs(created_at);
```

### 2.4 订单支付记录表 (order_payments)
```sql
CREATE TABLE order_payments (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES sales_orders(id),
    payment_no VARCHAR(32) UNIQUE NOT NULL, -- 支付单号
    
    -- 支付信息
    payment_method VARCHAR(20) NOT NULL, -- 支付方式
    payment_channel VARCHAR(50), -- 支付渠道
    payment_amount DECIMAL(10,2) NOT NULL, -- 支付金额
    payment_type VARCHAR(20) DEFAULT 'payment', -- 支付类型：payment, refund
    
    -- 第三方支付信息
    third_party_order_no VARCHAR(100), -- 第三方订单号
    third_party_trade_no VARCHAR(100), -- 第三方交易号
    
    -- 状态信息
    payment_status VARCHAR(20) DEFAULT 'pending', -- 支付状态
    payment_time TIMESTAMP, -- 支付时间
    callback_time TIMESTAMP, -- 回调时间
    
    -- 备注信息
    payment_notes TEXT, -- 支付备注
    failure_reason TEXT, -- 失败原因
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_order_payments_order_id ON order_payments(order_id);
CREATE INDEX idx_order_payments_payment_no ON order_payments(payment_no);
CREATE INDEX idx_order_payments_third_party_order_no ON order_payments(third_party_order_no);
CREATE INDEX idx_order_payments_payment_status ON order_payments(payment_status);
```

### 2.5 订单物流表 (order_logistics)
```sql
CREATE TABLE order_logistics (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES sales_orders(id),
    logistics_no VARCHAR(32) UNIQUE NOT NULL, -- 物流单号
    
    -- 物流信息
    logistics_company VARCHAR(100), -- 物流公司
    tracking_no VARCHAR(100), -- 快递单号
    logistics_type VARCHAR(20) DEFAULT 'delivery', -- 物流类型：delivery, return
    
    -- 发货信息
    sender_name VARCHAR(100), -- 发货人
    sender_phone VARCHAR(15), -- 发货人电话
    sender_address TEXT, -- 发货地址
    
    -- 收货信息
    receiver_name VARCHAR(100), -- 收货人
    receiver_phone VARCHAR(15), -- 收货人电话
    receiver_address TEXT, -- 收货地址
    
    -- 状态信息
    logistics_status VARCHAR(20) DEFAULT 'preparing', -- 物流状态
    shipped_at TIMESTAMP, -- 发货时间
    delivered_at TIMESTAMP, -- 送达时间
    signed_by VARCHAR(100), -- 签收人
    
    -- 备注信息
    logistics_notes TEXT, -- 物流备注
    special_instructions TEXT, -- 特殊说明
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_order_logistics_order_id ON order_logistics(order_id);
CREATE INDEX idx_order_logistics_tracking_no ON order_logistics(tracking_no);
CREATE INDEX idx_order_logistics_status ON order_logistics(logistics_status);
```

### 2.6 订单安装表 (order_installations)
```sql
CREATE TABLE order_installations (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES sales_orders(id),
    installation_no VARCHAR(32) UNIQUE NOT NULL, -- 安装单号
    
    -- 安装信息
    installer_id BIGINT, -- 安装师傅ID
    installer_name VARCHAR(100), -- 安装师傅姓名
    installer_phone VARCHAR(15), -- 安装师傅电话
    installation_team_id BIGINT, -- 安装团队ID
    
    -- 预约信息
    appointment_date DATE, -- 预约日期
    appointment_time_slot VARCHAR(20), -- 预约时间段
    appointment_notes TEXT, -- 预约备注
    
    -- 安装地址
    installation_address TEXT NOT NULL, -- 安装地址
    installation_contact VARCHAR(100), -- 安装联系人
    installation_phone VARCHAR(15), -- 安装联系电话
    
    -- 状态信息
    installation_status VARCHAR(20) DEFAULT 'scheduled', -- 安装状态
    actual_start_time TIMESTAMP, -- 实际开始时间
    actual_end_time TIMESTAMP, -- 实际结束时间
    
    -- 安装结果
    installation_result VARCHAR(20), -- 安装结果：success, failed, partial
    quality_rating INTEGER, -- 质量评分 1-5
    customer_satisfaction INTEGER, -- 客户满意度 1-5
    installation_photos JSONB, -- 安装照片
    completion_notes TEXT, -- 完成备注
    
    -- 费用信息
    installation_fee DECIMAL(10,2) DEFAULT 0, -- 安装费用
    additional_fee DECIMAL(10,2) DEFAULT 0, -- 额外费用
    fee_notes TEXT, -- 费用说明
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (installer_id) REFERENCES users(id),
    FOREIGN KEY (installation_team_id) REFERENCES installation_teams(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_order_installations_order_id ON order_installations(order_id);
CREATE INDEX idx_order_installations_installer_id ON order_installations(installer_id);
CREATE INDEX idx_order_installations_appointment_date ON order_installations(appointment_date);
CREATE INDEX idx_order_installations_status ON order_installations(installation_status);
```

### 2.7 订单售后表 (order_after_sales)
```sql
CREATE TABLE order_after_sales (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES sales_orders(id),
    after_sales_no VARCHAR(32) UNIQUE NOT NULL, -- 售后单号
    
    -- 售后类型
    service_type VARCHAR(20) NOT NULL, -- 服务类型：return, exchange, repair, complaint
    service_reason VARCHAR(100), -- 服务原因
    service_description TEXT, -- 问题描述
    
    -- 申请信息
    applicant_name VARCHAR(100), -- 申请人
    applicant_phone VARCHAR(15), -- 申请人电话
    application_date DATE, -- 申请日期
    
    -- 处理信息
    handler_id BIGINT, -- 处理人ID
    handler_name VARCHAR(100), -- 处理人姓名
    handling_notes TEXT, -- 处理说明
    solution TEXT, -- 解决方案
    
    -- 状态信息
    service_status VARCHAR(20) DEFAULT 'pending', -- 服务状态
    priority VARCHAR(20) DEFAULT 'normal', -- 优先级
    
    -- 时间信息
    expected_completion_date DATE, -- 预期完成日期
    actual_completion_date DATE, -- 实际完成日期
    
    -- 费用信息
    service_fee DECIMAL(10,2) DEFAULT 0, -- 服务费用
    compensation_amount DECIMAL(10,2) DEFAULT 0, -- 赔偿金额
    
    -- 满意度
    customer_rating INTEGER, -- 客户评分 1-5
    customer_feedback TEXT, -- 客户反馈
    
    -- 系统字段
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 外键约束
    FOREIGN KEY (handler_id) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_after_sales_order_id ON order_after_sales(order_id);
CREATE INDEX idx_after_sales_service_type ON order_after_sales(service_type);
CREATE INDEX idx_after_sales_status ON order_after_sales(service_status);
CREATE INDEX idx_after_sales_handler_id ON order_after_sales(handler_id);
```

### 2.7 外键约束说明

#### 2.7.1 外键约束的作用
- **数据完整性**：确保引用的数据存在，防止无效的关联关系
- **引用完整性**：维护表之间的关联关系，确保数据的一致性
- **业务逻辑保障**：通过数据库层面的约束确保业务规则的执行

#### 2.7.2 主要外键约束关系

| 表名 | 字段名 | 引用表 | 引用字段 | 说明 |
|------|--------|--------|----------|------|
| sales_orders | customer_id | customers | id | 订单关联的客户 |
| sales_orders | delivery_city_id | cities | id | 配送城市 |
| sales_orders | lead_id | leads | id | 关联的线索 |
| sales_orders | quotation_id | quotations | id | 关联的报价单 |
| sales_orders | sales_person_id | users | id | 销售人员 |
| sales_orders | store_id | stores | id | 所属门店 |
| sales_orders | city_id | cities | id | 订单所在城市 |
| sales_orders | coupon_id | coupons | id | 使用的优惠券 |
| sales_orders | promotion_id | promotions | id | 参与的促销活动 |
| sales_orders | created_by | users | id | 创建人 |
| sales_orders | updated_by | users | id | 更新人 |
| order_items | product_id | products | id | 订单项关联的产品 |
| order_status_logs | created_by | users | id | 状态变更操作人 |
| order_payments | created_by | users | id | 支付记录创建人 |
| order_logistics | created_by | users | id | 物流记录创建人 |
| order_installations | installer_id | users | id | 安装人员 |
| order_installations | installation_team_id | installation_teams | id | 安装团队 |
| order_installations | created_by | users | id | 安装记录创建人 |
| order_after_sales | handler_id | users | id | 售后处理人 |
| order_after_sales | created_by | users | id | 售后记录创建人 |
| order_after_sales | updated_by | users | id | 售后记录更新人 |

#### 2.7.3 外键约束的好处
1. **防止数据不一致**：避免插入不存在的关联数据
2. **提高数据质量**：确保所有关联关系都是有效的
3. **简化查询逻辑**：可以安全地进行表连接操作
4. **支持级联操作**：可以配置级联删除或更新操作

## 3. API接口设计

### 3.1 订单管理接口

#### 3.1.1 创建订单
```typescript
POST /api/orders
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "customerInfo": {
    "customerId": 1,
    "customerName": "张三",
    "customerPhone": "13800138000",
    "customerEmail": "zhangsan@example.com"
  },
  "deliveryInfo": {
    "deliveryName": "张三",
    "deliveryPhone": "13800138000",
    "deliveryAddress": "北京市朝阳区xxx小区xxx号楼xxx室",
    "deliveryCityId": 1,
    "deliveryDistrict": "朝阳区",
    "deliveryPostcode": "100000"
  },
  "orderInfo": {
    "orderType": "sales",
    "orderSource": "线索转化",
    "leadId": 1,
    "quotationId": 1,
    "expectedDeliveryDate": "2024-02-01",
    "expectedInstallationDate": "2024-02-05",
    "customerNotes": "客户备注",
    "specialRequirements": "特殊要求"
  },
  "items": [
    {
      "productId": 1,
      "productSku": "CL001-RED-L",
      "productName": "遮光窗帘",
      "productCategory": "窗帘",
      "productBrand": "罗莱",
      "productColor": "红色",
      "productSize": "2.5m*2.8m",
      "specifications": {
        "material": "涤纶",
        "pattern": "纯色",
        "style": "现代简约"
      },
      "quantity": 2,
      "unit": "套",
      "unitPrice": 299.00,
      "discountRate": 10,
      "customizationDetails": {
        "width": 250,
        "height": 280,
        "installationType": "侧装"
      }
    }
  ],
  "paymentInfo": {
    "paymentMethod": "wechat_pay",
    "couponId": 1,
    "pointsUsed": 100
  }
}

// 响应体
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "id": 1,
    "orderNo": "SO202401010001",
    "totalAmount": 538.00,
    "status": "pending",
    "createdAt": "2024-01-01T10:00:00Z"
  }
}
```

#### 3.1.2 获取订单列表
```typescript
GET /api/orders?page=1&limit=20&status=pending&sales_person_id=1&start_date=2024-01-01&end_date=2024-01-31
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "orderNo": "SO202401010001",
        "customerName": "张三",
        "customerPhone": "13800138000",
        "totalAmount": 538.00,
        "status": "pending",
        "paymentStatus": "unpaid",
        "deliveryStatus": "pending",
        "installationStatus": "pending",
        "salesPerson": {
          "id": 1,
          "name": "李销售"
        },
        "store": {
          "id": 1,
          "name": "朝阳店"
        },
        "orderDate": "2024-01-01",
        "expectedDeliveryDate": "2024-02-01",
        "createdAt": "2024-01-01T10:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

#### 3.1.3 获取订单详情
```typescript
GET /api/orders/{id}
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "id": 1,
    "orderNo": "SO202401010001",
    "orderType": "sales",
    "orderSource": "线索转化",
    "status": "confirmed",
    "customerInfo": {
      "customerId": 1,
      "customerName": "张三",
      "customerPhone": "13800138000",
      "customerEmail": "zhangsan@example.com"
    },
    "deliveryInfo": {
      "deliveryName": "张三",
      "deliveryPhone": "13800138000",
      "deliveryAddress": "北京市朝阳区xxx小区xxx号楼xxx室",
      "deliveryCityId": 1,
      "deliveryDistrict": "朝阳区"
    },
    "amountInfo": {
      "subtotalAmount": 598.00,
      "discountAmount": 60.00,
      "shippingFee": 0.00,
      "installationFee": 0.00,
      "totalAmount": 538.00,
      "paidAmount": 538.00,
      "refundAmount": 0.00
    },
    "statusInfo": {
      "status": "confirmed",
      "paymentStatus": "paid",
      "deliveryStatus": "pending",
      "installationStatus": "pending"
    },
    "timeInfo": {
      "orderDate": "2024-01-01",
      "expectedDeliveryDate": "2024-02-01",
      "expectedInstallationDate": "2024-02-05"
    },
    "businessInfo": {
      "salesPerson": {
        "id": 1,
        "name": "李销售"
      },
      "store": {
        "id": 1,
        "name": "朝阳店"
      },
      "leadId": 1,
      "quotationId": 1
    },
    "items": [
      {
        "id": 1,
        "productId": 1,
        "productSku": "CL001-RED-L",
        "productName": "遮光窗帘",
        "productCategory": "窗帘",
        "productBrand": "罗莱",
        "productColor": "红色",
        "productSize": "2.5m*2.8m",
        "specifications": {
          "material": "涤纶",
          "pattern": "纯色",
          "style": "现代简约"
        },
        "quantity": 2,
        "unit": "套",
        "unitPrice": 299.00,
        "discountAmount": 60.00,
        "subtotal": 538.00,
        "productionStatus": "pending",
        "qualityStatus": "pending"
      }
    ],
    "payments": [
      {
        "id": 1,
        "paymentNo": "PAY202401010001",
        "paymentMethod": "wechat_pay",
        "paymentAmount": 538.00,
        "paymentStatus": "success",
        "paymentTime": "2024-01-01T10:30:00Z"
      }
    ],
    "statusLogs": [
      {
        "id": 1,
        "statusType": "order",
        "fromStatus": "pending",
        "toStatus": "confirmed",
        "changeReason": "客户确认订单",
        "createdBy": {
          "id": 1,
          "name": "李销售"
        },
        "createdAt": "2024-01-01T10:15:00Z"
      }
    ],
    "createdAt": "2024-01-01T10:00:00Z",
    "updatedAt": "2024-01-01T10:15:00Z"
  }
}
```

#### 3.1.4 更新订单状态
```typescript
PUT /api/orders/{id}/status
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "status": "confirmed",
  "changeReason": "客户确认订单",
  "notes": "客户已确认所有商品信息和价格"
}

// 响应体
{
  "code": 200,
  "message": "订单状态更新成功",
  "data": {
    "orderId": 1,
    "status": "confirmed",
    "updatedAt": "2024-01-01T10:15:00Z"
  }
}
```

#### 3.1.5 修改订单
```typescript
PUT /api/orders/{id}
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "deliveryInfo": {
    "deliveryAddress": "新的收货地址",
    "deliveryPhone": "新的收货电话"
  },
  "items": [
    {
      "id": 1,
      "quantity": 3,
      "unitPrice": 280.00
    }
  ],
  "changeReason": "客户要求修改数量和价格"
}

// 响应体
{
  "code": 200,
  "message": "订单修改成功",
  "data": {
    "orderId": 1,
    "newTotalAmount": 840.00,
    "updatedAt": "2024-01-01T11:00:00Z"
  }
}
```

### 3.2 订单支付接口

#### 3.2.1 创建支付
```typescript
POST /api/orders/{id}/payments
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "paymentMethod": "wechat_pay",
  "paymentAmount": 538.00,
  "paymentType": "payment",
  "paymentNotes": "订单首付款"
}

// 响应体
{
  "code": 200,
  "message": "支付创建成功",
  "data": {
    "paymentId": 1,
    "paymentNo": "PAY202401010001",
    "paymentUrl": "weixin://wxpay/bizpayurl?pr=xxx",
    "qrCode": "data:image/png;base64,xxx",
    "expireTime": "2024-01-01T10:30:00Z"
  }
}
```

#### 3.2.2 支付回调
```typescript
POST /api/payments/callback/wechat
Content-Type: application/json

// 微信支付回调数据
{
  "id": "xxx",
  "create_time": "2024-01-01T10:25:00+08:00",
  "event_type": "TRANSACTION.SUCCESS",
  "resource": {
    "original_type": "transaction",
    "algorithm": "AEAD_AES_256_GCM",
    "ciphertext": "xxx",
    "associated_data": "xxx",
    "nonce": "xxx"
  }
}

// 响应体
{
  "code": "SUCCESS",
  "message": "成功"
}
```

#### 3.2.3 查询支付状态
```typescript
GET /api/orders/{id}/payments/{paymentId}/status
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "paymentId": 1,
    "paymentNo": "PAY202401010001",
    "paymentStatus": "success",
    "paymentTime": "2024-01-01T10:25:00Z",
    "thirdPartyTradeNo": "4200001234567890123456789"
  }
}
```

### 3.3 订单物流接口

#### 3.3.1 创建物流单
```typescript
POST /api/orders/{id}/logistics
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "logisticsCompany": "顺丰速运",
  "logisticsType": "delivery",
  "senderInfo": {
    "senderName": "罗莱仓库",
    "senderPhone": "400-123-4567",
    "senderAddress": "北京市大兴区xxx仓库"
  },
  "specialInstructions": "易碎品，请轻拿轻放"
}

// 响应体
{
  "code": 200,
  "message": "物流单创建成功",
  "data": {
    "logisticsId": 1,
    "logisticsNo": "LOG202401010001",
    "trackingNo": "SF1234567890123",
    "estimatedDeliveryTime": "2024-01-03T18:00:00Z"
  }
}
```

#### 3.3.2 更新物流状态
```typescript
PUT /api/logistics/{id}/status
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "logisticsStatus": "delivered",
  "deliveredAt": "2024-01-03T15:30:00Z",
  "signedBy": "张三",
  "notes": "客户本人签收"
}

// 响应体
{
  "code": 200,
  "message": "物流状态更新成功",
  "data": {
    "logisticsId": 1,
    "logisticsStatus": "delivered",
    "updatedAt": "2024-01-03T15:30:00Z"
  }
}
```

#### 3.3.3 查询物流轨迹
```typescript
GET /api/logistics/{id}/tracking
Authorization: Bearer {token}

// 响应体
{
  "code": 200,
  "data": {
    "logisticsId": 1,
    "trackingNo": "SF1234567890123",
    "logisticsCompany": "顺丰速运",
    "currentStatus": "delivered",
    "trackingInfo": [
      {
        "time": "2024-01-03T15:30:00Z",
        "location": "北京市朝阳区",
        "description": "快件已签收，签收人：张三",
        "status": "delivered"
      },
      {
        "time": "2024-01-03T10:00:00Z",
        "location": "北京市朝阳区",
        "description": "快件正在派送中",
        "status": "delivering"
      },
      {
        "time": "2024-01-02T20:00:00Z",
        "location": "北京转运中心",
        "description": "快件已到达目的地网点",
        "status": "arrived"
      }
    ]
  }
}
```

### 3.4 订单安装接口

#### 3.4.1 预约安装
```typescript
POST /api/orders/{id}/installations
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "installerId": 1,
  "appointmentDate": "2024-02-05",
  "appointmentTimeSlot": "09:00-12:00",
  "installationAddress": "北京市朝阳区xxx小区xxx号楼xxx室",
  "installationContact": "张三",
  "installationPhone": "13800138000",
  "appointmentNotes": "客户要求上午安装"
}

// 响应体
{
  "code": 200,
  "message": "安装预约成功",
  "data": {
    "installationId": 1,
    "installationNo": "INS202401010001",
    "installer": {
      "id": 1,
      "name": "王师傅",
      "phone": "13900139000"
    },
    "appointmentDate": "2024-02-05",
    "appointmentTimeSlot": "09:00-12:00"
  }
}
```

#### 3.4.2 更新安装状态
```typescript
PUT /api/installations/{id}/status
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "installationStatus": "completed",
  "actualStartTime": "2024-02-05T09:30:00Z",
  "actualEndTime": "2024-02-05T11:30:00Z",
  "installationResult": "success",
  "qualityRating": 5,
  "customerSatisfaction": 5,
  "completionNotes": "安装顺利完成，客户满意",
  "installationPhotos": [
    {
      "url": "/uploads/installation_photo_1.jpg",
      "description": "安装完成效果图"
    }
  ]
}

// 响应体
{
  "code": 200,
  "message": "安装状态更新成功",
  "data": {
    "installationId": 1,
    "installationStatus": "completed",
    "updatedAt": "2024-02-05T11:30:00Z"
  }
}
```

### 3.5 订单售后接口

#### 3.5.1 创建售后申请
```typescript
POST /api/orders/{id}/after_sales
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "serviceType": "repair",
  "serviceReason": "产品质量问题",
  "serviceDescription": "窗帘轨道有异响，需要维修",
  "applicantName": "张三",
  "applicantPhone": "13800138000",
  "priority": "high"
}

// 响应体
{
  "code": 200,
  "message": "售后申请创建成功",
  "data": {
    "afterSalesId": 1,
    "afterSalesNo": "AS202401010001",
    "serviceType": "repair",
    "serviceStatus": "pending",
    "expectedCompletionDate": "2024-01-10",
    "createdAt": "2024-01-05T10:00:00Z"
  }
}
```

#### 3.5.2 处理售后申请
```typescript
PUT /api/after_sales/{id}/handle
Content-Type: application/json
Authorization: Bearer {token}

// 请求体
{
  "handlerId": 1,
  "handlingNotes": "已联系客户，确认问题原因",
  "solution": "安排师傅上门维修轨道",
  "serviceStatus": "processing",
  "expectedCompletionDate": "2024-01-08"
}

// 响应体
{
  "code": 200,
  "message": "售后申请处理成功",
  "data": {
    "afterSalesId": 1,
    "serviceStatus": "processing",
    "handler": {
      "id": 1,
      "name": "客服小李"
    },
    "updatedAt": "2024-01-05T14:00:00Z"
  }
}
```

## 4. 核心业务逻辑

### 4.1 订单服务 (OrderService)

```typescript
@Injectable()
export class OrderService {
  constructor(
    private orderRepository: OrderRepository,
    private orderItemRepository: OrderItemRepository,
    private paymentRepository: PaymentRepository,
    private logisticsRepository: LogisticsRepository,
    private installationRepository: InstallationRepository,
    private statusLogRepository: StatusLogRepository,
    private inventoryService: InventoryService,
    private paymentService: PaymentService,
    private notificationService: NotificationService,
    private pointsService: PointsService
  ) {}

  /**
   * 创建订单
   */
  async createOrder(createOrderDto: CreateOrderDto, userId: number): Promise<Order> {
    return await this.dataSource.transaction(async manager => {
      // 1. 生成订单编号
      const orderNo = await this.generateOrderNo();

      // 2. 验证库存
      await this.validateInventory(createOrderDto.items);

      // 3. 计算订单金额
      const amountInfo = await this.calculateOrderAmount(createOrderDto);

      // 4. 创建订单主记录
      const order = await manager.save(Order, {
        orderNo,
        ...createOrderDto.customerInfo,
        ...createOrderDto.deliveryInfo,
        ...createOrderDto.orderInfo,
        ...amountInfo,
        status: 'pending',
        paymentStatus: 'unpaid',
        deliveryStatus: 'pending',
        installationStatus: 'pending',
        orderDate: new Date(),
        salesPersonId: userId,
        createdBy: userId
      });

      // 5. 创建订单商品记录
      for (const itemDto of createOrderDto.items) {
        const itemAmount = this.calculateItemAmount(itemDto);
        await manager.save(OrderItem, {
          orderId: order.id,
          ...itemDto,
          ...itemAmount,
          productionStatus: 'pending',
          qualityStatus: 'pending'
        });
      }

      // 6. 预扣库存
      await this.inventoryService.reserveInventory(
        createOrderDto.items,
        order.id
      );

      // 7. 处理优惠券和积分
      if (createOrderDto.paymentInfo?.couponId) {
        await this.applyCoupon(order.id, createOrderDto.paymentInfo.couponId);
      }
      
      if (createOrderDto.paymentInfo?.pointsUsed > 0) {
        await this.pointsService.usePoints(
          createOrderDto.customerInfo.customerId,
          createOrderDto.paymentInfo.pointsUsed,
          order.id
        );
      }

      // 8. 记录状态变更
      await this.recordStatusChange(
        order.id,
        'order',
        null,
        'pending',
        '订单创建',
        userId,
        manager
      );

      // 9. 发送通知
      await this.notificationService.sendOrderCreatedNotification(order);

      return order;
    });
  }

  /**
   * 更新订单状态
   */
  async updateOrderStatus(
    orderId: number,
    statusDto: UpdateOrderStatusDto,
    userId: number
  ): Promise<void> {
    return await this.dataSource.transaction(async manager => {
      // 1. 获取当前订单
      const order = await this.orderRepository.findById(orderId);
      if (!order) {
        throw new NotFoundException('订单不存在');
      }

      // 2. 验证状态流转
      this.validateStatusTransition(order.status, statusDto.status);

      // 3. 更新订单状态
      await manager.update(Order, orderId, {
        status: statusDto.status,
        updatedBy: userId,
        updatedAt: new Date()
      });

      // 4. 记录状态变更
      await this.recordStatusChange(
        orderId,
        'order',
        order.status,
        statusDto.status,
        statusDto.changeReason,
        userId,
        manager
      );

      // 5. 执行状态相关的业务逻辑
      await this.handleStatusChange(order, statusDto.status, userId);

      // 6. 发送状态变更通知
      await this.notificationService.sendOrderStatusChangeNotification(
        orderId,
        order.status,
        statusDto.status,
        userId
      );
    });
  }

  /**
   * 处理状态变更的业务逻辑
   */
  private async handleStatusChange(
    order: Order,
    newStatus: string,
    userId: number
  ): Promise<void> {
    switch (newStatus) {
      case 'confirmed':
        // 订单确认后，正式扣减库存
        await this.inventoryService.confirmInventoryReservation(order.id);
        // 开始生产流程
        await this.startProduction(order.id);
        break;

      case 'cancelled':
        // 订单取消，释放库存
        await this.inventoryService.releaseInventoryReservation(order.id);
        // 处理退款
        if (order.paidAmount > 0) {
          await this.processRefund(order.id, order.paidAmount, '订单取消退款');
        }
        break;

      case 'completed':
        // 订单完成，发放积分
        await this.pointsService.earnPoints(
          order.customerId,
          this.calculateEarnedPoints(order.totalAmount),
          order.id
        );
        break;
    }
  }

  /**
   * 开始生产流程
   */
  private async startProduction(orderId: number): Promise<void> {
    const orderItems = await this.orderItemRepository.findByOrderId(orderId);
    
    for (const item of orderItems) {
      // 检查是否需要定制生产
      if (item.customizationDetails) {
        await this.productionService.createProductionTask({
          orderItemId: item.id,
          productId: item.productId,
          quantity: item.quantity,
          customizationDetails: item.customizationDetails,
          priority: 'normal'
        });
      }
      
      // 更新商品生产状态
      await this.orderItemRepository.update(item.id, {
        productionStatus: 'scheduled',
        productionStartDate: new Date()
      });
    }
  }

  /**
   * 计算订单金额
   */
  private async calculateOrderAmount(orderDto: CreateOrderDto): Promise<AmountInfo> {
    let subtotalAmount = 0;
    let discountAmount = 0;

    // 计算商品小计
    for (const item of orderDto.items) {
      const itemSubtotal = item.quantity * item.unitPrice;
      const itemDiscount = itemSubtotal * (item.discountRate || 0) / 100;
      
      subtotalAmount += itemSubtotal;
      discountAmount += itemDiscount;
    }

    // 计算运费
    const shippingFee = await this.calculateShippingFee(
      orderDto.deliveryInfo.deliveryCityId,
      subtotalAmount
    );

    // 计算安装费
    const installationFee = await this.calculateInstallationFee(orderDto.items);

    // 处理优惠券折扣
    if (orderDto.paymentInfo?.couponId) {
      const couponDiscount = await this.calculateCouponDiscount(
        orderDto.paymentInfo.couponId,
        subtotalAmount
      );
      discountAmount += couponDiscount;
    }

    // 处理积分抵扣
    let pointsDiscount = 0;
    if (orderDto.paymentInfo?.pointsUsed > 0) {
      pointsDiscount = await this.pointsService.calculatePointsValue(
        orderDto.paymentInfo.pointsUsed
      );
      discountAmount += pointsDiscount;
    }

    const totalAmount = subtotalAmount - discountAmount + shippingFee + installationFee;

    return {
      subtotalAmount,
      discountAmount,
      shippingFee,
      installationFee,
      totalAmount,
      paidAmount: 0,
      refundAmount: 0
    };
  }

  /**
   * 验证库存
   */
  private async validateInventory(items: CreateOrderItemDto[]): Promise<void> {
    for (const item of items) {
      const available = await this.inventoryService.checkAvailability(
        item.productId,
        item.productSku,
        item.quantity
      );
      
      if (!available) {
        throw new BadRequestException(
          `商品 ${item.productName} 库存不足，当前库存：${available.availableQuantity}`
        );
      }
    }
  }

  /**
   * 验证状态流转
   */
  private validateStatusTransition(currentStatus: string, newStatus: string): void {
    const allowedTransitions = {
      'pending': ['confirmed', 'cancelled'],
      'confirmed': ['production', 'cancelled'],
      'production': ['ready_to_ship', 'cancelled'],
      'ready_to_ship': ['shipped'],
      'shipped': ['delivered'],
      'delivered': ['installing'],
      'installing': ['completed'],
      'completed': [],
      'cancelled': []
    };

    const allowed = allowedTransitions[currentStatus] || [];
    if (!allowed.includes(newStatus)) {
      throw new BadRequestException(
        `不允许从状态 ${currentStatus} 转换到 ${newStatus}`
      );
    }
  }

  /**
   * 记录状态变更
   */
  private async recordStatusChange(
    orderId: number,
    statusType: string,
    fromStatus: string,
    toStatus: string,
    reason: string,
    userId: number,
    manager?: EntityManager
  ): Promise<void> {
    const repository = manager ? 
      manager.getRepository(OrderStatusLog) : 
      this.statusLogRepository;

    await repository.save({
      orderId,
      statusType,
      fromStatus,
      toStatus,
      changeReason: reason,
      createdBy: userId
    });
  }

  /**
   * 生成订单编号
   */
  private async generateOrderNo(): Promise<string> {
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
    const sequence = await this.getNextSequence('order', dateStr);
    return `SO${dateStr}${sequence.toString().padStart(4, '0')}`;
  }
}
```

### 4.2 支付服务 (PaymentService)

```typescript
@Injectable()
export class PaymentService {
  constructor(
    private paymentRepository: PaymentRepository,
    private orderRepository: OrderRepository,
    private wechatPayService: WechatPayService,
    private alipayService: AlipayService,
    private notificationService: NotificationService
  ) {}

  /**
   * 创建支付
   */
  async createPayment(
    orderId: number,
    paymentDto: CreatePaymentDto,
    userId: number
  ): Promise<PaymentResult> {
    // 1. 验证订单状态
    const order = await this.validateOrderForPayment(orderId);

    // 2. 生成支付单号
    const paymentNo = await this.generatePaymentNo();

    // 3. 创建支付记录
    const payment = await this.paymentRepository.create({
      orderId,
      paymentNo,
      paymentMethod: paymentDto.paymentMethod,
      paymentAmount: paymentDto.paymentAmount,
      paymentType: paymentDto.paymentType || 'payment',
      paymentStatus: 'pending',
      paymentNotes: paymentDto.paymentNotes,
      createdBy: userId
    });

    // 4. 调用第三方支付
    const paymentResult = await this.callThirdPartyPayment(payment, order);

    // 5. 更新支付记录
    await this.paymentRepository.update(payment.id, {
      thirdPartyOrderNo: paymentResult.thirdPartyOrderNo
    });

    return {
      paymentId: payment.id,
      paymentNo: payment.paymentNo,
      paymentUrl: paymentResult.paymentUrl,
      qrCode: paymentResult.qrCode,
      expireTime: paymentResult.expireTime
    };
  }

  /**
   * 处理支付回调
   */
  async handlePaymentCallback(
    paymentMethod: string,
    callbackData: any
  ): Promise<void> {
    let paymentInfo: PaymentCallbackInfo;

    // 1. 解析回调数据
    switch (paymentMethod) {
      case 'wechat_pay':
        paymentInfo = await this.wechatPayService.parseCallback(callbackData);
        break;
      case 'alipay':
        paymentInfo = await this.alipayService.parseCallback(callbackData);
        break;
      default:
        throw new BadRequestException('不支持的支付方式');
    }

    // 2. 查找支付记录
    const payment = await this.paymentRepository.findByThirdPartyOrderNo(
      paymentInfo.thirdPartyOrderNo
    );
    
    if (!payment) {
      throw new NotFoundException('支付记录不存在');
    }

    // 3. 验证支付金额
    if (payment.paymentAmount !== paymentInfo.paymentAmount) {
      throw new BadRequestException('支付金额不匹配');
    }

    // 4. 更新支付状态
    await this.updatePaymentStatus(
      payment.id,
      paymentInfo.paymentStatus,
      paymentInfo
    );

    // 5. 更新订单支付状态
    if (paymentInfo.paymentStatus === 'success') {
      await this.updateOrderPaymentStatus(payment.orderId, payment.paymentAmount);
    }
  }

  /**
   * 更新订单支付状态
   */
  private async updateOrderPaymentStatus(
    orderId: number,
    paymentAmount: number
  ): Promise<void> {
    const order = await this.orderRepository.findById(orderId);
    const newPaidAmount = order.paidAmount + paymentAmount;
    
    let paymentStatus = 'partial';
    if (newPaidAmount >= order.totalAmount) {
      paymentStatus = 'paid';
    }

    await this.orderRepository.update(orderId, {
      paidAmount: newPaidAmount,
      paymentStatus
    });

    // 如果订单已全额支付，自动确认订单
    if (paymentStatus === 'paid' && order.status === 'pending') {
      await this.orderService.updateOrderStatus(
        orderId,
        { status: 'confirmed', changeReason: '支付完成自动确认' },
        1 // 系统用户ID
      );
    }

    // 发送支付成功通知
    await this.notificationService.sendPaymentSuccessNotification(
      orderId,
      paymentAmount
    );
  }

  /**
   * 调用第三方支付
   */
  private async callThirdPartyPayment(
    payment: Payment,
    order: Order
  ): Promise<ThirdPartyPaymentResult> {
    const paymentRequest = {
      orderNo: payment.paymentNo,
      amount: payment.paymentAmount,
      subject: `罗莱订单-${order.orderNo}`,
      body: `订单号：${order.orderNo}，客户：${order.customerName}`,
      notifyUrl: `${this.configService.get('APP_URL')}/api/payments/callback/${payment.paymentMethod}`,
      returnUrl: `${this.configService.get('APP_URL')}/orders/${order.id}/payment-result`
    };

    switch (payment.paymentMethod) {
      case 'wechat_pay':
        return await this.wechatPayService.createPayment(paymentRequest);
      
      case 'alipay':
        return await this.alipayService.createPayment(paymentRequest);
      
      default:
        throw new BadRequestException('不支持的支付方式');
    }
  }

  /**
   * 处理退款
   */
  async processRefund(
    orderId: number,
    refundAmount: number,
    refundReason: string,
    userId: number
  ): Promise<void> {
    // 1. 验证退款条件
    const order = await this.validateOrderForRefund(orderId, refundAmount);

    // 2. 查找原支付记录
    const payments = await this.paymentRepository.findSuccessPaymentsByOrderId(orderId);
    
    if (payments.length === 0) {
      throw new BadRequestException('没有可退款的支付记录');
    }

    // 3. 按支付顺序退款
    let remainingRefundAmount = refundAmount;
    
    for (const payment of payments.reverse()) {
      if (remainingRefundAmount <= 0) break;
      
      const refundableAmount = Math.min(
        remainingRefundAmount,
        payment.paymentAmount
      );
      
      await this.createRefund(payment, refundableAmount, refundReason, userId);
      remainingRefundAmount -= refundableAmount;
    }

    // 4. 更新订单退款金额
    await this.orderRepository.update(orderId, {
      refundAmount: order.refundAmount + refundAmount
    });
  }

  /**
   * 创建退款
   */
  private async createRefund(
    originalPayment: Payment,
    refundAmount: number,
    refundReason: string,
    userId: number
  ): Promise<void> {
    // 1. 生成退款单号
    const refundNo = await this.generateRefundNo();

    // 2. 创建退款记录
    const refund = await this.paymentRepository.create({
      orderId: originalPayment.orderId,
      paymentNo: refundNo,
      paymentMethod: originalPayment.paymentMethod,
      paymentAmount: refundAmount,
      paymentType: 'refund',
      paymentStatus: 'pending',
      paymentNotes: refundReason,
      createdBy: userId
    });

    // 3. 调用第三方退款
    const refundResult = await this.callThirdPartyRefund(
      originalPayment,
      refund,
      refundAmount
    );

    // 4. 更新退款记录
    await this.paymentRepository.update(refund.id, {
      thirdPartyOrderNo: refundResult.refundNo,
      paymentStatus: refundResult.status
    });
  }
}
```

### 4.3 物流服务 (LogisticsService)

```typescript
@Injectable()
export class LogisticsService {
  constructor(
    private logisticsRepository: LogisticsRepository,
    private orderRepository: OrderRepository,
    private thirdPartyLogisticsService: ThirdPartyLogisticsService,
    private notificationService: NotificationService
  ) {}

  /**
   * 创建物流单
   */
  async createLogistics(
    orderId: number,
    logisticsDto: CreateLogisticsDto,
    userId: number
  ): Promise<Logistics> {
    // 1. 验证订单状态
    const order = await this.validateOrderForShipping(orderId);

    // 2. 生成物流单号
    const logisticsNo = await this.generateLogisticsNo();

    // 3. 创建物流记录
    const logistics = await this.logisticsRepository.create({
      orderId,
      logisticsNo,
      logisticsCompany: logisticsDto.logisticsCompany,
      logisticsType: logisticsDto.logisticsType || 'delivery',
      senderName: logisticsDto.senderInfo.senderName,
      senderPhone: logisticsDto.senderInfo.senderPhone,
      senderAddress: logisticsDto.senderInfo.senderAddress,
      receiverName: order.deliveryName,
      receiverPhone: order.deliveryPhone,
      receiverAddress: order.deliveryAddress,
      logisticsStatus: 'preparing',
      specialInstructions: logisticsDto.specialInstructions,
      createdBy: userId
    });

    // 4. 调用第三方物流API创建运单
    const trackingResult = await this.thirdPartyLogisticsService.createShipment({
      logisticsCompany: logisticsDto.logisticsCompany,
      senderInfo: logisticsDto.senderInfo,
      receiverInfo: {
        name: order.deliveryName,
        phone: order.deliveryPhone,
        address: order.deliveryAddress
      },
      goodsInfo: await this.getOrderGoodsInfo(orderId),
      specialInstructions: logisticsDto.specialInstructions
    });

    // 5. 更新物流记录
    await this.logisticsRepository.update(logistics.id, {
      trackingNo: trackingResult.trackingNo,
      logisticsStatus: 'shipped',
      shippedAt: new Date()
    });

    // 6. 更新订单发货状态
    await this.orderRepository.update(orderId, {
      deliveryStatus: 'shipped'
    });

    // 7. 发送发货通知
    await this.notificationService.sendShippingNotification(
      orderId,
      trackingResult.trackingNo,
      logisticsDto.logisticsCompany
    );

    return logistics;
  }

  /**
   * 查询物流轨迹
   */
  async getTrackingInfo(logisticsId: number): Promise<TrackingInfo> {
    const logistics = await this.logisticsRepository.findById(logisticsId);
    if (!logistics) {
      throw new NotFoundException('物流记录不存在');
    }

    // 调用第三方物流API查询轨迹
    const trackingInfo = await this.thirdPartyLogisticsService.queryTracking(
      logistics.logisticsCompany,
      logistics.trackingNo
    );

    // 更新本地物流状态
    if (trackingInfo.currentStatus !== logistics.logisticsStatus) {
      await this.updateLogisticsStatus(
        logisticsId,
        trackingInfo.currentStatus,
        trackingInfo.lastUpdateTime
      );
    }

    return {
      logisticsId: logistics.id,
      trackingNo: logistics.trackingNo,
      logisticsCompany: logistics.logisticsCompany,
      currentStatus: trackingInfo.currentStatus,
      trackingInfo: trackingInfo.trackingDetails
    };
  }

  /**
   * 更新物流状态
   */
  async updateLogisticsStatus(
    logisticsId: number,
    newStatus: string,
    updateTime?: Date
  ): Promise<void> {
    const logistics = await this.logisticsRepository.findById(logisticsId);
    if (!logistics) {
      throw new NotFoundException('物流记录不存在');
    }

    // 更新物流状态
    const updateData: any = {
      logisticsStatus: newStatus,
      updatedAt: updateTime || new Date()
    };

    if (newStatus === 'delivered') {
      updateData.deliveredAt = updateTime || new Date();
    }

    await this.logisticsRepository.update(logisticsId, updateData);

    // 更新订单发货状态
    if (newStatus === 'delivered') {
      await this.orderRepository.update(logistics.orderId, {
        deliveryStatus: 'delivered',
        actualDeliveryDate: updateTime || new Date()
      });

      // 发送签收通知
      await this.notificationService.sendDeliveryNotification(
        logistics.orderId,
        logistics.trackingNo
      );
    }
  }

  /**
   * 获取订单商品信息
   */
  private async getOrderGoodsInfo(orderId: number): Promise<GoodsInfo[]> {
    const orderItems = await this.orderItemRepository.findByOrderId(orderId);
    
    return orderItems.map(item => ({
      name: item.productName,
      quantity: item.quantity,
      unit: item.unit,
      weight: item.specifications?.weight || 1,
      volume: item.specifications?.volume || 0.1
    }));
  }
}
```

### 4.4 安装服务 (InstallationService)

```typescript
@Injectable()
export class InstallationService {
  constructor(
    private installationRepository: InstallationRepository,
    private orderRepository: OrderRepository,
    private installerService: InstallerService,
    private notificationService: NotificationService
  ) {}

  /**
   * 预约安装
   */
  async scheduleInstallation(
    orderId: number,
    installationDto: ScheduleInstallationDto,
    userId: number
  ): Promise<Installation> {
    // 1. 验证订单状态
    const order = await this.validateOrderForInstallation(orderId);

    // 2. 验证安装师傅可用性
    await this.validateInstallerAvailability(
      installationDto.installerId,
      installationDto.appointmentDate,
      installationDto.appointmentTimeSlot
    );

    // 3. 生成安装单号
    const installationNo = await this.generateInstallationNo();

    // 4. 创建安装记录
    const installation = await this.installationRepository.create({
      orderId,
      installationNo,
      installerId: installationDto.installerId,
      installerName: await this.getInstallerName(installationDto.installerId),
      installerPhone: await this.getInstallerPhone(installationDto.installerId),
      appointmentDate: installationDto.appointmentDate,
      appointmentTimeSlot: installationDto.appointmentTimeSlot,
      appointmentNotes: installationDto.appointmentNotes,
      installationAddress: installationDto.installationAddress,
      installationContact: installationDto.installationContact,
      installationPhone: installationDto.installationPhone,
      installationStatus: 'scheduled',
      installationFee: await this.calculateInstallationFee(orderId),
      createdBy: userId
    });

    // 5. 更新订单安装状态
    await this.orderRepository.update(orderId, {
      installationStatus: 'scheduled',
      expectedInstallationDate: installationDto.appointmentDate
    });

    // 6. 发送安装预约通知
    await this.notificationService.sendInstallationScheduleNotification(
      orderId,
      installation
    );

    return installation;
  }

  /**
   * 开始安装
   */
  async startInstallation(
    installationId: number,
    userId: number
  ): Promise<void> {
    const installation = await this.installationRepository.findById(installationId);
    if (!installation) {
      throw new NotFoundException('安装记录不存在');
    }

    // 更新安装状态
    await this.installationRepository.update(installationId, {
      installationStatus: 'in_progress',
      actualStartTime: new Date()
    });

    // 更新订单安装状态
    await this.orderRepository.update(installation.orderId, {
      installationStatus: 'installing'
    });

    // 发送安装开始通知
    await this.notificationService.sendInstallationStartNotification(
      installation.orderId,
      installation.installerName
    );
  }

  /**
   * 完成安装
   */
  async completeInstallation(
    installationId: number,
    completionDto: CompleteInstallationDto,
    userId: number
  ): Promise<void> {
    const installation = await this.installationRepository.findById(installationId);
    if (!installation) {
      throw new NotFoundException('安装记录不存在');
    }

    // 更新安装记录
    await this.installationRepository.update(installationId, {
      installationStatus: 'completed',
      actualEndTime: new Date(),
      installationResult: completionDto.installationResult,
      qualityRating: completionDto.qualityRating,
      customerSatisfaction: completionDto.customerSatisfaction,
      installationPhotos: completionDto.installationPhotos,
      completionNotes: completionDto.completionNotes,
      additionalFee: completionDto.additionalFee || 0,
      feeNotes: completionDto.feeNotes
    });

    // 更新订单状态
    await this.orderRepository.update(installation.orderId, {
      installationStatus: 'completed',
      actualInstallationDate: new Date(),
      status: 'completed',
      completionDate: new Date()
    });

    // 发送安装完成通知
    await this.notificationService.sendInstallationCompleteNotification(
      installation.orderId,
      completionDto.qualityRating
    );
  }

  /**
   * 验证安装师傅可用性
   */
  private async validateInstallerAvailability(
    installerId: number,
    appointmentDate: Date,
    timeSlot: string
  ): Promise<void> {
    const isAvailable = await this.installerService.checkAvailability(
      installerId,
      appointmentDate,
      timeSlot
    );

    if (!isAvailable) {
      throw new BadRequestException(
        `安装师傅在 ${appointmentDate} ${timeSlot} 时间段不可用`
      );
    }
  }
}
```

## 5. 前端界面设计

### 5.1 Web端界面 (Ant Design)

#### 5.1.1 订单列表页面
```typescript
// OrderList.tsx
import React, { useState, useEffect } from 'react';
import {
  Table,
  Card,
  Form,
  Input,
  Select,
  DatePicker,
  Button,
  Space,
  Tag,
  Modal,
  message
} from 'antd';
import { SearchOutlined, PlusOutlined, EyeOutlined } from '@ant-design/icons';

const { RangePicker } = DatePicker;
const { Option } = Select;

const OrderList: React.FC = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 20,
    total: 0
  });

  const columns = [
    {
      title: '订单编号',
      dataIndex: 'orderNo',
      key: 'orderNo',
      render: (text: string, record: any) => (
        <Button type="link" onClick={() => viewOrder(record.id)}>
          {text}
        </Button>
      )
    },
    {
      title: '客户信息',
      key: 'customer',
      render: (record: any) => (
        <div>
          <div>{record.customerName}</div>
          <div style={{ color: '#666', fontSize: '12px' }}>
            {record.customerPhone}
          </div>
        </div>
      )
    },
    {
      title: '订单金额',
      dataIndex: 'totalAmount',
      key: 'totalAmount',
      render: (amount: number) => `¥${amount.toFixed(2)}`
    },
    {
      title: '订单状态',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const statusConfig = {
          pending: { color: 'orange', text: '待确认' },
          confirmed: { color: 'blue', text: '已确认' },
          production: { color: 'purple', text: '生产中' },
          shipped: { color: 'cyan', text: '已发货' },
          completed: { color: 'green', text: '已完成' },
          cancelled: { color: 'red', text: '已取消' }
        };
        const config = statusConfig[status] || { color: 'default', text: status };
        return <Tag color={config.color}>{config.text}</Tag>;
      }
    },
    {
      title: '支付状态',
      dataIndex: 'paymentStatus',
      key: 'paymentStatus',
      render: (status: string) => {
        const statusConfig = {
          unpaid: { color: 'red', text: '未支付' },
          partial: { color: 'orange', text: '部分支付' },
          paid: { color: 'green', text: '已支付' }
        };
        const config = statusConfig[status] || { color: 'default', text: status };
        return <Tag color={config.color}>{config.text}</Tag>;
      }
    },
    {
      title: '销售人员',
      key: 'salesPerson',
      render: (record: any) => record.salesPerson?.name
    },
    {
      title: '下单时间',
      dataIndex: 'orderDate',
      key: 'orderDate'
    },
    {
      title: '操作',
      key: 'action',
      render: (record: any) => (
        <Space>
          <Button
            type="link"
            icon={<EyeOutlined />}
            onClick={() => viewOrder(record.id)}
          >
            查看
          </Button>
        </Space>
      )
    }
  ];

  const viewOrder = (orderId: number) => {
    // 跳转到订单详情页面
    window.location.href = `/orders/${orderId}`;
  };

  return (
    <Card title="订单管理">
      <Form layout="inline" style={{ marginBottom: 16 }}>
        <Form.Item name="orderNo" label="订单编号">
          <Input placeholder="请输入订单编号" />
        </Form.Item>
        <Form.Item name="customerPhone" label="客户电话">
          <Input placeholder="请输入客户电话" />
        </Form.Item>
        <Form.Item name="status" label="订单状态">
          <Select placeholder="请选择状态" style={{ width: 120 }}>
            <Option value="">全部</Option>
            <Option value="pending">待确认</Option>
            <Option value="confirmed">已确认</Option>
            <Option value="production">生产中</Option>
            <Option value="shipped">已发货</Option>
            <Option value="completed">已完成</Option>
            <Option value="cancelled">已取消</Option>
          </Select>
        </Form.Item>
        <Form.Item name="dateRange" label="下单时间">
          <RangePicker />
        </Form.Item>
        <Form.Item>
          <Button type="primary" icon={<SearchOutlined />}>
            搜索
          </Button>
        </Form.Item>
      </Form>

      <Table
        columns={columns}
        dataSource={orders}
        loading={loading}
        pagination={pagination}
        onChange={(pagination) => setPagination(pagination)}
        rowKey="id"
      />
    </Card>
  );
};

export default OrderList;
```

#### 5.1.2 订单详情页面
```typescript
// OrderDetail.tsx
import React, { useState, useEffect } from 'react';
import {
  Card,
  Descriptions,
  Table,
  Steps,
  Timeline,
  Button,
  Modal,
  Form,
  Select,
  Input,
  message,
  Tabs,
  Tag,
  Space
} from 'antd';

const { Step } = Steps;
const { TabPane } = Tabs;
const { TextArea } = Input;

const OrderDetail: React.FC = () => {
  const [order, setOrder] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [statusModalVisible, setStatusModalVisible] = useState(false);

  const orderSteps = [
    { title: '订单创建', status: 'finish' },
    { title: '订单确认', status: 'finish' },
    { title: '生产中', status: 'process' },
    { title: '已发货', status: 'wait' },
    { title: '安装完成', status: 'wait' }
  ];

  const itemColumns = [
    {
      title: '商品信息',
      key: 'product',
      render: (record: any) => (
        <div>
          <div style={{ fontWeight: 'bold' }}>{record.productName}</div>
          <div style={{ color: '#666', fontSize: '12px' }}>
            SKU: {record.productSku}
          </div>
          <div style={{ color: '#666', fontSize: '12px' }}>
            规格: {record.productSize} | 颜色: {record.productColor}
          </div>
        </div>
      )
    },
    {
      title: '数量',
      key: 'quantity',
      render: (record: any) => `${record.quantity} ${record.unit}`
    },
    {
      title: '单价',
      dataIndex: 'unitPrice',
      key: 'unitPrice',
      render: (price: number) => `¥${price.toFixed(2)}`
    },
    {
      title: '小计',
      dataIndex: 'subtotal',
      key: 'subtotal',
      render: (amount: number) => `¥${amount.toFixed(2)}`
    },
    {
      title: '生产状态',
      dataIndex: 'productionStatus',
      key: 'productionStatus',
      render: (status: string) => {
        const statusConfig = {
          pending: { color: 'orange', text: '待生产' },
          scheduled: { color: 'blue', text: '已排产' },
          in_progress: { color: 'purple', text: '生产中' },
          completed: { color: 'green', text: '生产完成' }
        };
        const config = statusConfig[status] || { color: 'default', text: status };
        return <Tag color={config.color}>{config.text}</Tag>;
      }
    }
  ];

  return (
    <div>
      <Card title={`订单详情 - ${order?.orderNo}`} style={{ marginBottom: 16 }}>
        <Steps current={2} style={{ marginBottom: 24 }}>
          {orderSteps.map((step, index) => (
            <Step key={index} title={step.title} status={step.status} />
          ))}
        </Steps>

        <Descriptions column={3} bordered>
          <Descriptions.Item label="订单编号">{order?.orderNo}</Descriptions.Item>
          <Descriptions.Item label="订单状态">
            <Tag color="blue">{order?.status}</Tag>
          </Descriptions.Item>
          <Descriptions.Item label="下单时间">{order?.orderDate}</Descriptions.Item>
          <Descriptions.Item label="客户姓名">{order?.customerName}</Descriptions.Item>
          <Descriptions.Item label="客户电话">{order?.customerPhone}</Descriptions.Item>
          <Descriptions.Item label="客户邮箱">{order?.customerEmail}</Descriptions.Item>
          <Descriptions.Item label="收货人">{order?.deliveryName}</Descriptions.Item>
          <Descriptions.Item label="收货电话">{order?.deliveryPhone}</Descriptions.Item>
          <Descriptions.Item label="收货地址" span={2}>{order?.deliveryAddress}</Descriptions.Item>
          <Descriptions.Item label="订单总额">¥{order?.totalAmount?.toFixed(2)}</Descriptions.Item>
          <Descriptions.Item label="已付金额">¥{order?.paidAmount?.toFixed(2)}</Descriptions.Item>
          <Descriptions.Item label="销售人员">{order?.salesPerson?.name}</Descriptions.Item>
        </Descriptions>

        <div style={{ marginTop: 16 }}>
          <Space>
            <Button type="primary" onClick={() => setStatusModalVisible(true)}>
              更新状态
            </Button>
            <Button>修改订单</Button>
            <Button>查看物流</Button>
            <Button>安排安装</Button>
          </Space>
        </div>
      </Card>

      <Tabs defaultActiveKey="items">
        <TabPane tab="订单商品" key="items">
          <Table
            columns={itemColumns}
            dataSource={order?.items || []}
            pagination={false}
            rowKey="id"
          />
        </TabPane>

        <TabPane tab="支付记录" key="payments">
          <Table
            columns={[
              { title: '支付单号', dataIndex: 'paymentNo', key: 'paymentNo' },
              { title: '支付方式', dataIndex: 'paymentMethod', key: 'paymentMethod' },
              { title: '支付金额', dataIndex: 'paymentAmount', key: 'paymentAmount' },
              { title: '支付状态', dataIndex: 'paymentStatus', key: 'paymentStatus' },
              { title: '支付时间', dataIndex: 'paymentTime', key: 'paymentTime' }
            ]}
            dataSource={order?.payments || []}
            pagination={false}
            rowKey="id"
          />
        </TabPane>

        <TabPane tab="状态日志" key="logs">
          <Timeline>
            {order?.statusLogs?.map((log: any, index: number) => (
              <Timeline.Item key={index}>
                <div>
                  <strong>{log.toStatus}</strong> - {log.changeReason}
                </div>
                <div style={{ color: '#666', fontSize: '12px' }}>
                  {log.createdBy?.name} · {log.createdAt}
                </div>
              </Timeline.Item>
            ))}
          </Timeline>
        </TabPane>
      </Tabs>

      <Modal
        title="更新订单状态"
        visible={statusModalVisible}
        onCancel={() => setStatusModalVisible(false)}
        footer={null}
      >
        <Form layout="vertical">
          <Form.Item label="新状态" name="status" rules={[{ required: true }]}>
            <Select placeholder="请选择新状态">
              <Select.Option value="confirmed">确认订单</Select.Option>
              <Select.Option value="production">开始生产</Select.Option>
              <Select.Option value="shipped">已发货</Select.Option>
              <Select.Option value="completed">已完成</Select.Option>
              <Select.Option value="cancelled">取消订单</Select.Option>
            </Select>
          </Form.Item>
          <Form.Item label="变更原因" name="changeReason" rules={[{ required: true }]}>
            <TextArea rows={3} placeholder="请输入状态变更原因" />
          </Form.Item>
          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                确认更新
              </Button>
              <Button onClick={() => setStatusModalVisible(false)}>
                取消
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default OrderDetail;
```

### 5.2 移动端界面 (Taro + Taro UI)

#### 5.2.1 订单列表页面
```typescript
// OrderList.tsx (Mobile)
import React, { useState, useEffect } from 'react';
import { View, Text } from '@tarojs/components';
import { AtList, AtListItem, AtTag, AtSearchBar, AtTabs, AtTabsPane } from 'taro-ui';
import Taro from '@tarojs/taro';

const OrderList: React.FC = () => {
  const [orders, setOrders] = useState([]);
  const [activeTab, setActiveTab] = useState(0);
  const [searchValue, setSearchValue] = useState('');

  const tabList = [
    { title: '全部' },
    { title: '待确认' },
    { title: '生产中' },
    { title: '已发货' },
    { title: '已完成' }
  ];

  const getStatusTag = (status: string) => {
    const statusConfig = {
      pending: { color: 'orange', text: '待确认' },
      confirmed: { color: 'blue', text: '已确认' },
      production: { color: 'purple', text: '生产中' },
      shipped: { color: 'cyan', text: '已发货' },
      completed: { color: 'green', text: '已完成' },
      cancelled: { color: 'red', text: '已取消' }
    };
    const config = statusConfig[status] || { color: 'default', text: status };
    return <AtTag type="primary" size="small">{config.text}</AtTag>;
  };

  const viewOrder = (orderId: number) => {
    Taro.navigateTo({
      url: `/pages/order/detail?id=${orderId}`
    });
  };

  return (
    <View className="order-list">
      <AtSearchBar
        value={searchValue}
        onChange={setSearchValue}
        placeholder="搜索订单编号或客户电话"
      />

      <AtTabs current={activeTab} tabList={tabList} onClick={setActiveTab}>
        <AtTabsPane current={activeTab} index={0}>
          <AtList>
            {orders.map((order: any) => (
              <AtListItem
                key={order.id}
                title={
                  <View>
                    <Text className="order-no">{order.orderNo}</Text>
                    {getStatusTag(order.status)}
                  </View>
                }
                note={
                  <View>
                    <Text className="customer-info">
                      {order.customerName} · {order.customerPhone}
                    </Text>
                    <Text className="amount">¥{order.totalAmount.toFixed(2)}</Text>
                    <Text className="date">{order.orderDate}</Text>
                  </View>
                }
                arrow="right"
                onClick={() => viewOrder(order.id)}
              />
            ))}
          </AtList>
        </AtTabsPane>
      </AtTabs>
    </View>
  );
};

export default OrderList;
```

## 6. 性能优化

### 6.1 数据库优化
- **索引优化**：为常用查询字段创建复合索引
- **分页查询**：使用游标分页提高大数据量查询性能
- **读写分离**：订单查询使用只读副本
- **数据归档**：定期归档历史订单数据

### 6.2 缓存策略
- **Redis缓存**：缓存热点订单数据和统计信息
- **查询缓存**：缓存复杂的订单统计查询结果
- **分布式缓存**：使用Redis Cluster提高缓存可用性

### 6.3 异步处理
- **消息队列**：使用RabbitMQ处理订单状态变更通知
- **批量操作**：批量处理订单状态更新和库存操作
- **定时任务**：定时同步第三方物流信息

## 7. 安全与权限控制

### 7.1 数据权限
- **角色权限**：基于用户角色控制订单访问权限
- **城市隔离**：不同城市用户只能访问本城市订单
- **门店隔离**：门店用户只能访问本门店订单
- **字段权限**：敏感字段（如金额）需要特殊权限

### 7.2 操作权限
- **订单创建**：销售人员、店长
- **状态变更**：销售人员、店长、运营人员
- **价格修改**：店长、区域经理
- **订单取消**：店长、区域经理

### 7.3 审计日志
- **操作记录**：记录所有订单操作的详细日志
- **敏感操作**：价格修改、订单取消等需要审批
- **数据备份**：定期备份订单数据

## 8. 监控与告警

### 8.1 业务监控
- **订单转化率**：线索到订单的转化率
- **订单完成率**：订单按时完成率
- **客户满意度**：安装服务满意度评分
- **退款率**：订单退款比例

### 8.2 系统监控
- **API性能**：订单相关API响应时间
- **数据库性能**：订单表查询性能
- **缓存命中率**：Redis缓存命中率

### 8.3 告警规则
```yaml
ALERT_RULES:
  - name: "订单积压告警"
    condition: "pending_orders_count > 100"
    severity: "warning"
    message: "待处理订单数量过多"
  
  - name: "支付失败率告警"
    condition: "payment_failure_rate > 5%"
    severity: "critical"
    message: "支付失败率过高"
  
  - name: "订单API异常"
    condition: "order_api_error_rate > 1%"
    severity: "critical"
    message: "订单API错误率过高"
  
  - name: "安装延期告警"
    condition: "overdue_installations_count > 10"
    severity: "warning"
    message: "安装延期订单过多"
```

---

**文档版本**: v1.0  
**创建时间**: 2024-01-01  
**最后更新**: 2024-01-01  
**负责人**: 系统架构师
