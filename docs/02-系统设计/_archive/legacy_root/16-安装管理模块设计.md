# 安装管理模块设计

## 1. 模块概述

### 1.1 功能目标
安装管理模块负责管理从产品生产完成到客户验收的整个安装服务流程，确保安装质量和客户满意度。

**核心目标**：
- **安装调度**：合理安排安装师傅和安装时间
- **流程管控**：规范安装预约、执行、验收的完整流程
- **质量保证**：确保安装质量符合标准要求
- **服务跟踪**：全程跟踪安装进度和服务质量
- **售后支持**：处理安装相关的售后问题
- **资源优化**：优化安装师傅调度和工具配置

### 1.2 业务流程
```
生产完成 → 安装预约 → 师傅分配 → 上门安装 → 质量检查 → 客户验收 → 安装完成
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
  通知客户   确定时间   路线规划   现场施工   自检验收   客户签字   售后跟踪
```

### 1.3 安装类型
- **标准安装**：常规产品的标准安装服务
- **复杂安装**：需要特殊工艺或环境的复杂安装
- **补装**：遗漏项目的补充安装
- **维修安装**：售后维修相关的安装服务
- **改装**：客户要求的产品改装服务

### 1.4 安装状态流转
```
待安排 → 已预约 → 已分配 → 安装中 → 待验收 → 已完成 → 已归档
  ↓       ↓       ↓       ↓       ↓       ↓       ↓
pending scheduled assigned installing pending_acceptance completed archived
```

## 2. 数据库设计

### 2.1 安装订单表 (installation_orders)
```sql
CREATE TABLE installation_orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  installation_no VARCHAR(32) NOT NULL UNIQUE COMMENT '安装单号',
  order_id BIGINT NOT NULL COMMENT '关联销售订单ID',
  order_no VARCHAR(32) NOT NULL COMMENT '销售订单号',
  measurement_id BIGINT COMMENT '关联测量订单ID',
  
  -- 客户信息
  customer_id BIGINT NOT NULL COMMENT '客户ID',
  customer_name VARCHAR(100) NOT NULL COMMENT '客户姓名',
  customer_phone VARCHAR(15) NOT NULL COMMENT '客户电话',
  
  -- 安装地址
  installation_address TEXT NOT NULL COMMENT '安装地址',
  installation_contact VARCHAR(100) COMMENT '现场联系人',
  installation_phone VARCHAR(15) COMMENT '现场联系电话',
  
  -- 安装安排
  installer_team_id BIGINT COMMENT '安装团队ID',
  installer_leader_id BIGINT COMMENT '安装队长ID',
  installer_leader_name VARCHAR(100) COMMENT '安装队长姓名',
  installer_leader_phone VARCHAR(15) COMMENT '安装队长电话',
  team_members JSON COMMENT '团队成员信息',
  
  -- 预约信息
  appointment_date DATE COMMENT '预约安装日期',
  appointment_time_slot VARCHAR(20) COMMENT '预约时间段',
  estimated_duration INT COMMENT '预计安装时长(小时)',
  appointment_notes TEXT COMMENT '预约备注',
  
  -- 安装执行
  actual_start_time DATETIME COMMENT '实际开始时间',
  actual_end_time DATETIME COMMENT '实际结束时间',
  actual_duration INT COMMENT '实际安装时长(分钟)',
  
  -- 安装状态
  installation_status ENUM('pending', 'scheduled', 'assigned', 'installing', 
    'pending_acceptance', 'completed', 'cancelled', 'rework') 
    NOT NULL DEFAULT 'pending' COMMENT '安装状态',
  installation_type ENUM('standard', 'complex', 'supplement', 'repair', 'modification') 
    NOT NULL DEFAULT 'standard' COMMENT '安装类型',
  
  -- 安装结果
  installation_result JSON COMMENT '安装结果详情',
  installation_photos JSON COMMENT '安装照片',
  before_photos JSON COMMENT '安装前照片',
  after_photos JSON COMMENT '安装后照片',
  quality_rating TINYINT COMMENT '质量评分(1-5)',
  customer_satisfaction TINYINT COMMENT '客户满意度(1-5)',
  
  -- 验收信息
  acceptance_status ENUM('pending', 'passed', 'failed', 'partial') 
    DEFAULT 'pending' COMMENT '验收状态',
  acceptance_time DATETIME COMMENT '验收时间',
  acceptance_notes TEXT COMMENT '验收备注',
  customer_signature TEXT COMMENT '客户签字',
  
  -- 异常处理
  exception_reason TEXT COMMENT '异常原因',
  rework_reason TEXT COMMENT '返工原因',
  rework_count INT DEFAULT 0 COMMENT '返工次数',
  
  -- 费用信息
  installation_fee DECIMAL(10,2) DEFAULT 0.00 COMMENT '安装费用',
  additional_fee DECIMAL(10,2) DEFAULT 0.00 COMMENT '额外费用',
  material_fee DECIMAL(10,2) DEFAULT 0.00 COMMENT '材料费用',
  fee_notes TEXT COMMENT '费用说明',
  
  -- 工具设备
  required_tools JSON COMMENT '所需工具清单',
  required_materials JSON COMMENT '所需材料清单',
  
  -- 环境要求
  environment_requirements JSON COMMENT '环境要求',
  special_instructions TEXT COMMENT '特殊说明',
  
  -- 审核信息
  reviewed_by BIGINT COMMENT '审核人ID',
  reviewed_at DATETIME COMMENT '审核时间',
  review_notes TEXT COMMENT '审核备注',
  
  -- 系统字段
  created_by BIGINT NOT NULL COMMENT '创建人ID',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  -- 外键约束
  FOREIGN KEY (order_id) REFERENCES sales_orders(id),
  FOREIGN KEY (measurement_id) REFERENCES measurement_orders(id),
  FOREIGN KEY (customer_id) REFERENCES customers(id),
  FOREIGN KEY (installer_team_id) REFERENCES installation_teams(id),
  FOREIGN KEY (installer_leader_id) REFERENCES installers(id),
  FOREIGN KEY (reviewed_by) REFERENCES users(id),
  FOREIGN KEY (created_by) REFERENCES users(id),
  
  INDEX idx_order_id (order_id),
  INDEX idx_customer_id (customer_id),
  INDEX idx_installer_team_id (installer_team_id),
  INDEX idx_appointment_date (appointment_date),
  INDEX idx_installation_status (installation_status),
  INDEX idx_created_at (created_at)
) COMMENT='安装订单表';
```

### 2.2 安装项目表 (installation_items)
```sql
CREATE TABLE installation_items (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  installation_id BIGINT NOT NULL COMMENT '安装订单ID',
  order_item_id BIGINT NOT NULL COMMENT '订单商品ID',
  
  -- 商品信息
  product_id BIGINT NOT NULL COMMENT '产品ID',
  product_name VARCHAR(200) NOT NULL COMMENT '产品名称',
  product_sku VARCHAR(100) NOT NULL COMMENT '产品SKU',
  product_category VARCHAR(100) COMMENT '产品分类',
  product_specifications JSON COMMENT '产品规格',
  
  -- 安装要求
  installation_requirements JSON COMMENT '安装要求',
  installation_position VARCHAR(200) COMMENT '安装位置',
  installation_method VARCHAR(100) COMMENT '安装方式',
  special_requirements TEXT COMMENT '特殊要求',
  
  -- 安装数据
  installation_data JSON COMMENT '安装数据',
  installation_dimensions JSON COMMENT '安装尺寸',
  installation_photos JSON COMMENT '安装照片',
  
  -- 质量检查
  quality_checkpoints JSON COMMENT '质量检查点',
  quality_results JSON COMMENT '质量检查结果',
  quality_issues JSON COMMENT '质量问题',
  
  -- 状态
  item_status ENUM('pending', 'installing', 'completed', 'exception') 
    NOT NULL DEFAULT 'pending' COMMENT '项目状态',
  completion_percentage DECIMAL(5,2) DEFAULT 0.00 COMMENT '完成百分比',
  
  -- 时间记录
  start_time DATETIME COMMENT '开始安装时间',
  end_time DATETIME COMMENT '完成安装时间',
  
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- 外键约束
  FOREIGN KEY (installation_id) REFERENCES installation_orders(id) ON DELETE CASCADE,
  FOREIGN KEY (order_item_id) REFERENCES order_items(id),
  FOREIGN KEY (product_id) REFERENCES products(id),
  
  INDEX idx_installation_id (installation_id),
  INDEX idx_order_item_id (order_item_id),
  INDEX idx_product_id (product_id)
) COMMENT='安装项目表';
```

### 2.3 安装团队表 (installation_teams)
```sql
CREATE TABLE installation_teams (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  team_no VARCHAR(32) NOT NULL UNIQUE COMMENT '团队编号',
  team_name VARCHAR(100) NOT NULL COMMENT '团队名称',
  team_leader_id BIGINT NOT NULL COMMENT '队长ID',
  team_leader_name VARCHAR(100) NOT NULL COMMENT '队长姓名',
  
  -- 团队信息
  team_type ENUM('internal', 'external', 'mixed') 
    NOT NULL DEFAULT 'internal' COMMENT '团队类型',
  work_city VARCHAR(50) NOT NULL COMMENT '工作城市',
  work_areas JSON COMMENT '工作区域',
  specialties JSON COMMENT '专业特长',
  
  -- 团队能力
  skill_level ENUM('junior', 'intermediate', 'senior', 'expert') 
    NOT NULL DEFAULT 'intermediate' COMMENT '技能等级',
  max_concurrent_orders INT DEFAULT 3 COMMENT '最大并发订单数',
  supported_categories JSON COMMENT '支持的产品分类',
  
  -- 工作状态
  team_status ENUM('available', 'busy', 'maintenance', 'inactive') 
    NOT NULL DEFAULT 'available' COMMENT '团队状态',
  current_orders INT DEFAULT 0 COMMENT '当前订单数',
  
  -- 评价信息
  total_orders INT DEFAULT 0 COMMENT '总订单数',
  completed_orders INT DEFAULT 0 COMMENT '完成订单数',
  average_rating DECIMAL(3,2) DEFAULT 0.00 COMMENT '平均评分',
  customer_satisfaction DECIMAL(3,2) DEFAULT 0.00 COMMENT '客户满意度',
  on_time_rate DECIMAL(3,2) DEFAULT 0.00 COMMENT '准时率',
  
  -- 联系信息
  contact_phone VARCHAR(15) COMMENT '联系电话',
  emergency_contact VARCHAR(100) COMMENT '紧急联系人',
  emergency_phone VARCHAR(15) COMMENT '紧急联系电话',
  
  -- 系统字段
  status ENUM('active', 'inactive') NOT NULL DEFAULT 'active' COMMENT '状态',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- 外键约束
  FOREIGN KEY (team_leader_id) REFERENCES installers(id),
  
  INDEX idx_team_leader_id (team_leader_id),
  INDEX idx_work_city (work_city),
  INDEX idx_team_status (team_status),
  INDEX idx_skill_level (skill_level)
) COMMENT='安装团队表';
```

### 2.4 安装师傅表 (installers)
```sql
CREATE TABLE installers (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  installer_no VARCHAR(32) NOT NULL UNIQUE COMMENT '安装师傅编号',
  name VARCHAR(100) NOT NULL COMMENT '姓名',
  phone VARCHAR(15) NOT NULL COMMENT '电话',
  id_card VARCHAR(18) COMMENT '身份证号',
  
  -- 基本信息
  gender ENUM('male', 'female') COMMENT '性别',
  birth_date DATE COMMENT '出生日期',
  address TEXT COMMENT '住址',
  emergency_contact VARCHAR(100) COMMENT '紧急联系人',
  emergency_phone VARCHAR(15) COMMENT '紧急联系电话',
  
  -- 工作信息
  employee_type ENUM('full_time', 'part_time', 'outsource') 
    NOT NULL DEFAULT 'full_time' COMMENT '员工类型',
  work_city VARCHAR(50) COMMENT '工作城市',
  work_areas JSON COMMENT '工作区域',
  team_id BIGINT COMMENT '所属团队ID',
  role ENUM('measurer', 'installer', 'dispatcher') 
    NOT NULL DEFAULT 'installer' COMMENT '团队角色',
  
  -- 技能信息
  skill_level ENUM('junior', 'intermediate', 'senior', 'expert') 
    NOT NULL DEFAULT 'junior' COMMENT '技能等级',
  specialties JSON COMMENT '专业特长',
  certifications JSON COMMENT '认证证书',
  training_records JSON COMMENT '培训记录',
  
  -- 工作状态
  work_status ENUM('available', 'busy', 'leave', 'inactive') 
    NOT NULL DEFAULT 'available' COMMENT '工作状态',
  max_daily_orders INT DEFAULT 2 COMMENT '每日最大接单量',
  
  -- 工具设备
  owned_tools JSON COMMENT '拥有的工具',
  tool_maintenance_records JSON COMMENT '工具维护记录',
  
  -- 评价信息
  total_orders INT DEFAULT 0 COMMENT '总订单数',
  completed_orders INT DEFAULT 0 COMMENT '完成订单数',
  average_rating DECIMAL(3,2) DEFAULT 0.00 COMMENT '平均评分',
  customer_satisfaction DECIMAL(3,2) DEFAULT 0.00 COMMENT '客户满意度',
  quality_score DECIMAL(3,2) DEFAULT 0.00 COMMENT '质量评分',
  
  -- 系统字段
  status ENUM('active', 'inactive') NOT NULL DEFAULT 'active' COMMENT '状态',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- 外键约束
  FOREIGN KEY (team_id) REFERENCES installation_teams(id),
  
  INDEX idx_phone (phone),
  INDEX idx_work_city (work_city),
  INDEX idx_team_id (team_id),
  INDEX idx_work_status (work_status),
  INDEX idx_skill_level (skill_level)
) COMMENT='安装师傅表';
```

### 2.5 安装标准表 (installation_standards)
```sql
CREATE TABLE installation_standards (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  standard_name VARCHAR(200) NOT NULL COMMENT '标准名称',
  product_category VARCHAR(100) NOT NULL COMMENT '适用产品分类',
  
  -- 标准内容
  installation_steps JSON NOT NULL COMMENT '安装步骤',
  quality_requirements JSON COMMENT '质量要求',
  safety_requirements JSON COMMENT '安全要求',
  tool_requirements JSON COMMENT '工具要求',
  material_requirements JSON COMMENT '材料要求',
  
  -- 检查标准
  quality_checkpoints JSON COMMENT '质量检查点',
  acceptance_criteria JSON COMMENT '验收标准',
  
  -- 标准状态
  standard_status ENUM('active', 'inactive') NOT NULL DEFAULT 'active',
  version VARCHAR(20) NOT NULL DEFAULT '1.0' COMMENT '版本号',
  
  created_by BIGINT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- 外键约束
  FOREIGN KEY (created_by) REFERENCES users(id),
  
  INDEX idx_product_category (product_category),
  INDEX idx_standard_status (standard_status)
) COMMENT='安装标准表';
```

### 2.6 安装日志表 (installation_logs)
```sql
CREATE TABLE installation_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  installation_id BIGINT NOT NULL COMMENT '安装订单ID',
  
  -- 日志信息
  log_type ENUM('status_change', 'progress_update', 'quality_check', 'exception', 'note') 
    NOT NULL COMMENT '日志类型',
  from_status VARCHAR(50) COMMENT '原状态',
  to_status VARCHAR(50) COMMENT '新状态',
  operation VARCHAR(100) NOT NULL COMMENT '操作',
  description TEXT COMMENT '描述',
  
  -- 附加信息
  progress_percentage DECIMAL(5,2) COMMENT '进度百分比',
  quality_score DECIMAL(3,2) COMMENT '质量评分',
  photos JSON COMMENT '相关照片',
  
  -- 操作人信息
  operator_id BIGINT NOT NULL COMMENT '操作人ID',
  operator_name VARCHAR(100) NOT NULL COMMENT '操作人姓名',
  operator_role VARCHAR(50) COMMENT '操作人角色',
  
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  -- 外键约束
  FOREIGN KEY (installation_id) REFERENCES installation_orders(id) ON DELETE CASCADE,
  FOREIGN KEY (operator_id) REFERENCES users(id),
  
  INDEX idx_installation_id (installation_id),
  INDEX idx_log_type (log_type),
  INDEX idx_created_at (created_at)
) COMMENT='安装日志表';
```

### 2.7 外键约束说明

#### 2.7.1 外键约束的作用
- **数据完整性**：确保引用的数据存在，防止无效的关联关系
- **引用完整性**：维护表之间的关联关系，确保数据的一致性
- **业务逻辑保障**：通过数据库层面的约束确保业务规则的执行

#### 2.7.2 主要外键约束关系

| 表名 | 字段名 | 引用表 | 引用字段 | 说明 |
|------|--------|--------|----------|------|
| installation_orders | order_id | sales_orders | id | 关联的销售订单 |
| installation_orders | measurement_id | measurement_orders | id | 关联的测量订单 |
| installation_orders | customer_id | customers | id | 安装订单关联的客户 |
| installation_orders | installer_team_id | installation_teams | id | 分配的安装团队 |
| installation_orders | installer_leader_id | installers | id | 安装队长 |
| installation_orders | reviewed_by | users | id | 审核人 |
| installation_orders | created_by | users | id | 创建人 |
| installation_items | installation_id | installation_orders | id | 所属安装订单 |
| installation_items | order_item_id | order_items | id | 关联的订单项 |
| installation_items | product_id | products | id | 安装的产品 |
| installation_teams | team_leader_id | installers | id | 团队队长 |
| installers | team_id | installation_teams | id | 所属团队 |
| installation_standards | created_by | users | id | 标准创建人 |
| installation_logs | installation_id | installation_orders | id | 关联的安装订单 |
| installation_logs | operator_id | users | id | 操作人 |

#### 2.7.3 外键约束的好处
1. **防止数据不一致**：避免插入不存在的关联数据
2. **提高数据质量**：确保所有关联关系都是有效的
3. **简化查询逻辑**：可以安全地进行表连接操作
4. **支持级联操作**：可以配置级联删除或更新操作

#### 2.7.4 循环引用处理
注意：`installation_teams` 表的 `team_leader_id` 引用 `installers` 表，而 `installers` 表的 `team_id` 引用 `installation_teams` 表，形成循环引用。在实际实施时需要：
1. 先创建不带外键约束的表
2. 插入基础数据
3. 再添加外键约束
4. 或者将其中一个外键设置为可空，避免循环依赖

## 3. API接口设计

### 3.1 安装订单管理

#### 3.1.1 创建安装订单
```typescript
POST /api/installations
Content-Type: application/json

{
  "orderId": 12345,
  "installationType": "standard",
  "appointmentDate": "2024-01-20",
  "appointmentTimeSlot": "09:00-17:00",
  "installationAddress": "北京市朝阳区xxx小区xxx号楼xxx室",
  "installationContact": "张先生",
  "installationPhone": "13800138000",
  "estimatedDuration": 8,
  "specialInstructions": "客户要求轻声作业",
  "environmentRequirements": {
    "powerSupply": true,
    "waterSupply": false,
    "ventilation": true
  },
  "requiredTools": ["电钻", "水平仪", "螺丝刀套装"],
  "requiredMaterials": ["膨胀螺丝", "密封胶"]
}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 78901,
    "installationNo": "I202401200001",
    "status": "pending",
    "createdAt": "2024-01-15T10:00:00Z"
  }
}
```

#### 3.1.2 获取安装订单列表
```typescript
GET /api/installations?page=1&page_size=20&status=pending&team_id=123&start_date=2024-01-01&end_date=2024-01-31

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 78901,
        "installationNo": "I202401200001",
        "orderNo": "SO202401100001",
        "customerName": "张三",
        "customerPhone": "13800138000",
        "installationAddress": "北京市朝阳区xxx小区",
        "appointmentDate": "2024-01-20",
        "appointmentTimeSlot": "09:00-17:00",
        "installerTeamName": "精装团队A组",
        "installerLeaderName": "李队长",
        "installationStatus": "scheduled",
        "installationType": "standard",
        "estimatedDuration": 8,
        "createdAt": "2024-01-15T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 150,
      "totalPages": 8
    }
  }
}
```

#### 3.1.3 获取安装订单详情
```typescript
GET /api/installations/{id}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 78901,
    "installationNo": "I202401200001",
    "orderId": 12345,
    "orderNo": "SO202401100001",
    "measurementId": 67890,
    "customerInfo": {
      "customerId": 123,
      "customerName": "张三",
      "customerPhone": "13800138000"
    },
    "installationAddress": "北京市朝阳区xxx小区xxx号楼xxx室",
    "installationContact": "张先生",
    "installationPhone": "13800138000",
    "installerTeam": {
      "teamId": 456,
      "teamName": "精装团队A组",
      "leaderId": 789,
      "leaderName": "李队长",
      "leaderPhone": "13900139000",
      "members": [
        {
          "installerId": 790,
          "installerName": "王师傅",
          "installerPhone": "13800138001",
          "role": "member"
        }
      ]
    },
    "appointmentDate": "2024-01-20",
    "appointmentTimeSlot": "09:00-17:00",
    "estimatedDuration": 8,
    "actualStartTime": "2024-01-20T09:00:00Z",
    "actualEndTime": "2024-01-20T16:30:00Z",
    "actualDuration": 450,
    "installationStatus": "completed",
    "installationType": "standard",
    "acceptanceStatus": "passed",
    "acceptanceTime": "2024-01-20T16:45:00Z",
    "qualityRating": 5,
    "customerSatisfaction": 5,
    "installationFee": 500.00,
    "additionalFee": 0.00,
    "materialFee": 50.00,
    "requiredTools": ["电钻", "水平仪", "螺丝刀套装"],
    "requiredMaterials": ["膨胀螺丝", "密封胶"],
    "beforePhotos": [
      "https://example.com/before1.jpg",
      "https://example.com/before2.jpg"
    ],
    "afterPhotos": [
      "https://example.com/after1.jpg",
      "https://example.com/after2.jpg"
    ],
    "items": [
      {
        "id": 1,
        "productName": "定制衣柜",
        "productSku": "YG001",
        "installationPosition": "主卧室",
        "installationMethod": "墙面固定",
        "itemStatus": "completed",
        "completionPercentage": 100.00,
        "qualityResults": {
          "levelness": "合格",
          "stability": "合格",
          "appearance": "优秀"
        }
      }
    ]
  }
}
```

### 3.2 安装团队管理

#### 3.2.1 分配安装团队
```typescript
POST /api/installations/{id}/assign_team
Content-Type: application/json

{
  "teamId": 456,
  "appointmentDate": "2024-01-20",
  "appointmentTimeSlot": "09:00-17:00",
  "estimatedDuration": 8,
  "notes": "客户要求准时到达，轻声作业"
}

Response:
{
  "code": 200,
  "message": "安装团队分配成功",
  "data": {
    "installationId": 78901,
    "teamInfo": {
      "teamId": 456,
      "teamName": "精装团队A组",
      "leaderName": "李队长",
      "leaderPhone": "13900139000",
      "memberCount": 3
    },
    "appointmentInfo": {
      "appointmentDate": "2024-01-20",
      "appointmentTimeSlot": "09:00-17:00",
      "estimatedDuration": 8
    }
  }
}
```

#### 3.2.2 获取可用安装团队
```typescript
GET /api/installation_teams/available?date=2024-01-20&duration=8&city=北京&skill_level=senior&category=衣柜

Response:
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "teamId": 456,
      "teamName": "精装团队A组",
      "leaderName": "李队长",
      "leaderPhone": "13900139000",
      "skillLevel": "senior",
      "averageRating": 4.8,
      "completedOrders": 256,
      "workAreas": ["朝阳区", "海淀区"],
      "specialties": ["衣柜安装", "橱柜安装"],
      "currentOrders": 1,
      "maxConcurrentOrders": 3,
      "estimatedTravelTime": 45
    }
  ]
}
```

### 3.3 安装执行

#### 3.3.1 开始安装
```typescript
POST /api/installations/{id}/start
Content-Type: application/json

{
  "actualStartTime": "2024-01-20T09:00:00Z",
  "teamMembers": [
    {
      "installerId": 789,
      "installerName": "李队长",
      "role": "leader"
    },
    {
      "installerId": 790,
      "installerName": "王师傅",
      "role": "member"
    }
  ],
  "environmentNotes": "现场环境良好，具备安装条件",
  "beforePhotos": ["before1.jpg", "before2.jpg"]
}

Response:
{
  "code": 200,
  "message": "安装已开始",
  "data": {
    "installationId": 78901,
    "status": "installing",
    "actualStartTime": "2024-01-20T09:00:00Z"
  }
}
```

#### 3.3.2 更新安装进度
```typescript
POST /api/installations/{id}/update_progress
Content-Type: application/json

{
  "completionPercentage": 60.0,
  "currentStep": "主体安装",
  "progressNotes": "主体框架安装完成，正在进行门板安装",
  "progressPhotos": ["progress1.jpg", "progress2.jpg"],
  "qualityCheckResults": {
    "levelness": "合格",
    "stability": "合格"
  },
  "itemProgress": [
    {
      "itemId": 1,
      "completionPercentage": 60.0,
      "currentStep": "门板安装",
      "qualityResults": {
        "levelness": "合格",
        "stability": "合格"
      }
    }
  ]
}

Response:
{
  "code": 200,
  "message": "进度更新成功",
  "data": {
    "installationId": 78901,
    "completionPercentage": 60.0,
    "updatedAt": "2024-01-20T13:30:00Z"
  }
}
```

#### 3.3.3 完成安装
```typescript
POST /api/installations/{id}/complete
Content-Type: application/json

{
  "actualEndTime": "2024-01-20T16:30:00Z",
  "completionNotes": "安装顺利完成，质量良好",
  "afterPhotos": ["after1.jpg", "after2.jpg", "after3.jpg"],
  "qualityRating": 5,
  "finalQualityCheck": {
    "overall": "优秀",
    "levelness": "合格",
    "stability": "合格",
    "appearance": "优秀",
    "functionality": "合格"
  },
  "materialUsage": {
    "膨胀螺丝": 20,
    "密封胶": 2
  },
  "additionalFee": 0,
  "feeNotes": "无额外费用"
}

Response:
{
  "code": 200,
  "message": "安装完成",
  "data": {
    "installationId": 78901,
    "status": "pending_acceptance",
    "completedAt": "2024-01-20T16:30:00Z",
    "nextStep": "customer_acceptance"
  }
}
```

#### 3.3.4 客户验收
```typescript
POST /api/installations/{id}/acceptance
Content-Type: application/json

{
  "acceptanceStatus": "passed",
  "acceptanceTime": "2024-01-20T16:45:00Z",
  "customerSatisfaction": 5,
  "acceptanceNotes": "客户非常满意，安装质量优秀",
  "customerSignature": "signature_image_base64",
  "customerFeedback": "师傅们工作认真负责，安装质量很好"
}

Response:
{
  "code": 200,
  "message": "验收完成",
  "data": {
    "installationId": 78901,
    "status": "completed",
    "acceptanceStatus": "passed",
    "acceptedAt": "2024-01-20T16:45:00Z"
  }
}
```

## 4. 核心业务逻辑

### 4.1 安装服务 (InstallationService)

```typescript
@Injectable()
export class InstallationService {
  constructor(
    private installationRepository: InstallationRepository,
    private teamRepository: TeamRepository,
    private orderRepository: OrderRepository,
    private notificationService: NotificationService,
    private schedulingService: SchedulingService,
    private qualityService: QualityService
  ) {}

  /**
   * 创建安装订单
   */
  async createInstallation(
    createDto: CreateInstallationDto,
    userId: number
  ): Promise<Installation> {
    // 1. 验证销售订单状态
    const order = await this.validateOrderForInstallation(createDto.orderId);

    // 2. 检查测量数据
    if (order.measurementStatus !== 'completed') {
      throw new BadRequestException('测量未完成，无法创建安装订单');
    }

    // 3. 生成安装单号
    const installationNo = await this.generateInstallationNo();

    // 4. 创建安装订单
    const installation = await this.installationRepository.create({
      installationNo,
      orderId: createDto.orderId,
      orderNo: order.orderNo,
      measurementId: order.measurementId,
      customerId: order.customerId,
      customerName: order.customerName,
      customerPhone: order.customerPhone,
      installationAddress: createDto.installationAddress,
      installationContact: createDto.installationContact,
      installationPhone: createDto.installationPhone,
      appointmentDate: createDto.appointmentDate,
      appointmentTimeSlot: createDto.appointmentTimeSlot,
      estimatedDuration: createDto.estimatedDuration,
      installationType: createDto.installationType,
      environmentRequirements: createDto.environmentRequirements,
      requiredTools: createDto.requiredTools,
      requiredMaterials: createDto.requiredMaterials,
      specialInstructions: createDto.specialInstructions,
      installationStatus: 'pending',
      createdBy: userId
    });

    // 5. 创建安装项目
    await this.createInstallationItems(installation.id, order.items);

    // 6. 更新订单状态
    await this.orderRepository.update(createDto.orderId, {
      installationStatus: 'scheduled',
      installationId: installation.id
    });

    // 7. 发送通知
    await this.notificationService.sendInstallationCreatedNotification(
      installation
    );

    return installation;
  }

  /**
   * 自动分配安装团队
   */
  async autoAssignTeam(
    installationId: number,
    criteria: TeamAssignmentCriteria
  ): Promise<void> {
    const installation = await this.installationRepository.findById(installationId);
    if (!installation) {
      throw new NotFoundException('安装订单不存在');
    }

    // 1. 获取可用安装团队
    const availableTeams = await this.getAvailableTeams(
      criteria.date,
      criteria.duration,
      criteria.city,
      criteria.skillLevel,
      criteria.category
    );

    if (availableTeams.length === 0) {
      throw new BadRequestException('暂无可用安装团队');
    }

    // 2. 智能分配算法
    const selectedTeam = await this.selectOptimalTeam(
      availableTeams,
      installation
    );

    // 3. 分配安装团队
    await this.assignTeam(installationId, selectedTeam.id, criteria);
  }

  /**
   * 智能选择最优安装团队
   */
  private async selectOptimalTeam(
    availableTeams: InstallationTeam[],
    installation: Installation
  ): Promise<InstallationTeam> {
    // 评分算法：综合考虑技能、评分、距离、工作量
    const scoredTeams = await Promise.all(
      availableTeams.map(async (team) => {
        const score = await this.calculateTeamScore(team, installation);
        return { team, score };
      })
    );

    // 按评分排序，选择最高分
    scoredTeams.sort((a, b) => b.score - a.score);
    return scoredTeams[0].team;
  }

  /**
   * 计算团队评分
   */
  private async calculateTeamScore(
    team: InstallationTeam,
    installation: Installation
  ): Promise<number> {
    let score = 0;

    // 1. 技能匹配度 (35%)
    const skillScore = this.calculateSkillMatchScore(team, installation);
    score += skillScore * 0.35;

    // 2. 历史评分 (25%)
    const ratingScore = team.averageRating * 20; // 5分制转100分制
    score += ratingScore * 0.25;

    // 3. 距离因素 (20%)
    const distanceScore = await this.calculateDistanceScore(team, installation);
    score += distanceScore * 0.2;

    // 4. 工作负载 (15%)
    const workloadScore = this.calculateWorkloadScore(team);
    score += workloadScore * 0.15;

    // 5. 准时率 (5%)
    const punctualityScore = team.onTimeRate * 100;
    score += punctualityScore * 0.05;

    return score;
  }

  /**
   * 开始安装
   */
  async startInstallation(
    installationId: number,
    startDto: StartInstallationDto,
    userId: number
  ): Promise<void> {
    const installation = await this.installationRepository.findById(installationId);
    if (!installation) {
      throw new NotFoundException('安装订单不存在');
    }

    if (installation.installationStatus !== 'assigned') {
      throw new BadRequestException('安装订单状态不正确');
    }

    // 1. 更新安装状态
    await this.installationRepository.update(installationId, {
      installationStatus: 'installing',
      actualStartTime: startDto.actualStartTime || new Date(),
      teamMembers: startDto.teamMembers,
      beforePhotos: startDto.beforePhotos
    });

    // 2. 初始化安装项目状态
    await this.initializeInstallationItems(installationId);

    // 3. 记录日志
    await this.logInstallationOperation(
      installationId,
      'status_change',
      'assigned',
      'installing',
      '开始安装',
      userId
    );

    // 4. 发送通知
    await this.notificationService.sendInstallationStartNotification(
      installation
    );
  }

  /**
   * 更新安装进度
   */
  async updateProgress(
    installationId: number,
    progressDto: UpdateProgressDto,
    userId: number
  ): Promise<void> {
    const installation = await this.installationRepository.findById(installationId);
    if (!installation) {
      throw new NotFoundException('安装订单不存在');
    }

    // 1. 更新整体进度
    await this.installationRepository.update(installationId, {
      completionPercentage: progressDto.completionPercentage
    });

    // 2. 更新项目进度
    if (progressDto.itemProgress) {
      await this.updateItemProgress(installationId, progressDto.itemProgress);
    }

    // 3. 质量检查
    if (progressDto.qualityCheckResults) {
      await this.performQualityCheck(
        installationId,
        progressDto.qualityCheckResults
      );
    }

    // 4. 记录进度日志
    await this.logInstallationOperation(
      installationId,
      'progress_update',
      null,
      null,
      `进度更新至${progressDto.completionPercentage}%`,
      userId,
      {
        progressPercentage: progressDto.completionPercentage,
        photos: progressDto.progressPhotos
      }
    );

    // 5. 发送进度通知
    if (progressDto.completionPercentage >= 50 && 
        progressDto.completionPercentage < 60) {
      await this.notificationService.sendInstallationProgressNotification(
        installation,
        progressDto.completionPercentage
      );
    }
  }

  /**
   * 完成安装
   */
  async completeInstallation(
    installationId: number,
    completeDto: CompleteInstallationDto,
    userId: number
  ): Promise<void> {
    const installation = await this.installationRepository.findById(installationId);
    if (!installation) {
      throw new NotFoundException('安装订单不存在');
    }

    // 1. 最终质量检查
    const finalQualityCheck = await this.performFinalQualityCheck(
      installationId,
      completeDto.finalQualityCheck
    );

    if (!finalQualityCheck.passed) {
      throw new BadRequestException('质量检查未通过，无法完成安装');
    }

    // 2. 更新安装状态
    await this.installationRepository.update(installationId, {
      installationStatus: 'pending_acceptance',
      actualEndTime: completeDto.actualEndTime || new Date(),
      actualDuration: this.calculateDuration(
        installation.actualStartTime,
        completeDto.actualEndTime
      ),
      afterPhotos: completeDto.afterPhotos,
      qualityRating: completeDto.qualityRating,
      additionalFee: completeDto.additionalFee || 0,
      materialFee: this.calculateMaterialFee(completeDto.materialUsage)
    });

    // 3. 更新所有项目状态为完成
    await this.completeAllInstallationItems(installationId);

    // 4. 记录完成日志
    await this.logInstallationOperation(
      installationId,
      'status_change',
      'installing',
      'pending_acceptance',
      '安装完成，等待客户验收',
      userId
    );

    // 5. 发送完成通知
    await this.notificationService.sendInstallationCompleteNotification(
      installation
    );
  }

  /**
   * 客户验收
   */
  async customerAcceptance(
    installationId: number,
    acceptanceDto: CustomerAcceptanceDto,
    userId: number
  ): Promise<void> {
    const installation = await this.installationRepository.findById(installationId);
    if (!installation) {
      throw new NotFoundException('安装订单不存在');
    }

    if (installation.installationStatus !== 'pending_acceptance') {
      throw new BadRequestException('安装订单状态不正确');
    }

    // 1. 更新验收信息
    await this.installationRepository.update(installationId, {
      installationStatus: acceptanceDto.acceptanceStatus === 'passed' ? 'completed' : 'rework',
      acceptanceStatus: acceptanceDto.acceptanceStatus,
      acceptanceTime: acceptanceDto.acceptanceTime || new Date(),
      acceptanceNotes: acceptanceDto.acceptanceNotes,
      customerSatisfaction: acceptanceDto.customerSatisfaction,
      customerSignature: acceptanceDto.customerSignature
    });

    // 2. 更新订单状态
    if (acceptanceDto.acceptanceStatus === 'passed') {
      await this.orderRepository.update(installation.orderId, {
        installationStatus: 'completed',
        status: 'completed'
      });
    }

    // 3. 更新团队统计
    await this.updateTeamStats(
      installation.installerTeamId,
      acceptanceDto
    );

    // 4. 处理验收结果
    if (acceptanceDto.acceptanceStatus === 'passed') {
      // 验收通过
      await this.handleAcceptancePassed(installation);
    } else {
      // 验收失败，需要返工
      await this.handleAcceptanceFailed(installation, acceptanceDto);
    }

    // 5. 发送验收通知
    await this.notificationService.sendAcceptanceNotification(
      installation,
      acceptanceDto.acceptanceStatus
    );
  }

  /**
   * 质量检查
   */
  private async performQualityCheck(
    installationId: number,
    qualityResults: any
  ): Promise<QualityCheckResult> {
    const installation = await this.installationRepository.findById(installationId);
    const standard = await this.getInstallationStandard(
      installation.installationType
    );

    return await this.qualityService.checkInstallationQuality(
      installation,
      qualityResults,
      standard
    );
  }

  /**
   * 生成安装单号
   */
  private async generateInstallationNo(): Promise<string> {
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
    
    const count = await this.installationRepository.countByDate(today);
    const sequence = (count + 1).toString().padStart(4, '0');
    
    return `I${dateStr}${sequence}`;
  }
}
```

### 4.2 安装团队调度服务 (TeamSchedulingService)

```typescript
@Injectable()
export class TeamSchedulingService {
  constructor(
    private teamRepository: TeamRepository,
    private installationRepository: InstallationRepository,
    private geoService: GeoService
  ) {}

  /**
   * 获取可用安装团队
   */
  async getAvailableTeams(
    date: Date,
    duration: number,
    city: string,
    skillLevel?: string,
    category?: string
  ): Promise<InstallationTeam[]> {
    // 1. 基础筛选条件
    const baseConditions = {
      teamStatus: 'available',
      workCity: city,
      status: 'active'
    };

    if (skillLevel) {
      baseConditions['skillLevel'] = skillLevel;
    }

    // 2. 获取符合条件的团队
    let teams = await this.teamRepository.findByConditions(baseConditions);

    // 3. 按产品分类筛选
    if (category) {
      teams = teams.filter(team => 
        team.supportedCategories.includes(category)
      );
    }

    // 4. 检查时间可用性
    const availableTeams = await Promise.all(
      teams.map(async (team) => {
        const isAvailable = await this.checkTeamAvailability(
          team.id,
          date,
          duration
        );
        return isAvailable ? team : null;
      })
    );

    return availableTeams.filter(Boolean);
  }

  /**
   * 检查团队可用性
   */
  private async checkTeamAvailability(
    teamId: number,
    date: Date,
    duration: number
  ): Promise<boolean> {
    // 1. 检查当日已安排的安装任务
    const existingInstallations = await this.installationRepository.findByTeamAndDate(
      teamId,
      date
    );

    // 2. 检查并发订单数限制
    const team = await this.teamRepository.findById(teamId);
    if (existingInstallations.length >= team.maxConcurrentOrders) {
      return false;
    }

    // 3. 检查时间冲突（简化版本，实际需要更复杂的时间段计算）
    const totalDuration = existingInstallations.reduce(
      (sum, installation) => sum + installation.estimatedDuration,
      0
    );

    // 假设每天工作8小时
    if (totalDuration + duration > 8) {
      return false;
    }

    return true;
  }

  /**
   * 优化安装路线
   */
  async optimizeInstallationRoute(
    teamId: number,
    date: Date
  ): Promise<RouteOptimizationResult> {
    // 1. 获取当日所有安装任务
    const installations = await this.installationRepository.findByTeamAndDate(
      teamId,
      date
    );

    if (installations.length <= 1) {
      return { optimized: false, originalRoute: installations };
    }

    // 2. 计算地址间距离矩阵
    const addresses = installations.map(i => i.installationAddress);
    const distanceMatrix = await this.geoService.calculateDistanceMatrix(addresses);

    // 3. 考虑安装时长的路线优化
    const optimizedOrder = this.optimizeRouteWithDuration(
      installations,
      distanceMatrix
    );

    // 4. 重新排序安装任务
    const optimizedInstallations = optimizedOrder.map(index => installations[index]);

    return {
      optimized: true,
      originalRoute: installations,
      optimizedRoute: optimizedInstallations,
      timeSaved: this.calculateTimeSaved(installations, optimizedInstallations, distanceMatrix)
    };
  }

  /**
   * 考虑安装时长的路线优化
   */
  private optimizeRouteWithDuration(
    installations: Installation[],
    distanceMatrix: number[][]
  ): number[] {
    // 使用改进的贪心算法，考虑安装时长和距离
    const n = installations.length;
    const visited = new Array(n).fill(false);
    const route = [0]; // 从第一个点开始
    visited[0] = true;

    for (let i = 1; i < n; i++) {
      let bestScore = -Infinity;
      let nextInstallation = -1;

      for (let j = 0; j < n; j++) {
        if (!visited[j]) {
          // 综合考虑距离和时间窗口
          const distance = distanceMatrix[route[route.length - 1]][j];
          const timeWindow = this.calculateTimeWindowScore(
            installations[route[route.length - 1]],
            installations[j]
          );
          
          const score = timeWindow - distance * 0.1; // 距离权重较小
          
          if (score > bestScore) {
            bestScore = score;
            nextInstallation = j;
          }
        }
      }

      if (nextInstallation !== -1) {
        route.push(nextInstallation);
        visited[nextInstallation] = true;
      }
    }

    return route;
  }

  /**
   * 计算时间窗口评分
   */
  private calculateTimeWindowScore(
    current: Installation,
    next: Installation
  ): number {
    // 根据预约时间段计算时间窗口匹配度
    const currentEnd = this.parseTimeSlot(current.appointmentTimeSlot).end;
    const nextStart = this.parseTimeSlot(next.appointmentTimeSlot).start;
    
    // 如果下一个安装可以在当前安装结束后进行，给予高分
    if (nextStart >= currentEnd) {
      return 100;
    }
    
    // 否则根据时间差给予相应分数
    const timeDiff = Math.abs(nextStart - currentEnd);
    return Math.max(0, 100 - timeDiff * 10);
  }
}
```

## 5. 前端界面设计

### 5.1 Web端界面 (Ant Design)

#### 5.1.1 安装订单列表页面
```typescript
// InstallationList.tsx
import React, { useState, useEffect } from 'react';
import {
  Table,
  Card,
  Form,
  Input,
  Select,
  DatePicker,
  Button,
  Space,
  Tag,
  Modal,
  Progress,
  message,
  Tooltip
} from 'antd';
import { 
  SearchOutlined, 
  PlusOutlined, 
  EyeOutlined, 
  TeamOutlined,
  ClockCircleOutlined,
  CheckCircleOutlined
} from '@ant-design/icons';

const { RangePicker } = DatePicker;
const { Option } = Select;

const InstallationList: React.FC = () => {
  const [installations, setInstallations] = useState([]);
  const [loading, setLoading] = useState(false);
  const [assignModalVisible, setAssignModalVisible] = useState(false);
  const [selectedInstallation, setSelectedInstallation] = useState(null);

  const columns = [
    {
      title: '安装单号',
      dataIndex: 'installationNo',
      key: 'installationNo',
      render: (text: string, record: any) => (
        <Button type="link" onClick={() => viewInstallation(record.id)}>
          {text}
        </Button>
      )
    },
    {
      title: '关联订单',
      dataIndex: 'orderNo',
      key: 'orderNo'
    },
    {
      title: '客户信息',
      key: 'customer',
      render: (record: any) => (
        <div>
          <div>{record.customerName}</div>
          <div style={{ color: '#666', fontSize: '12px' }}>
            {record.customerPhone}
          </div>
        </div>
      )
    },
    {
      title: '安装地址',
      dataIndex: 'installationAddress',
      key: 'installationAddress',
      ellipsis: true,
      render: (text: string) => (
        <Tooltip title={text}>
          <span>{text}</span>
        </Tooltip>
      )
    },
    {
      title: '预约时间',
      key: 'appointment',
      render: (record: any) => (
        <div>
          <div>
            <ClockCircleOutlined style={{ marginRight: 4 }} />
            {record.appointmentDate}
          </div>
          <div style={{ color: '#666', fontSize: '12px' }}>
            {record.appointmentTimeSlot}
          </div>
          <div style={{ color: '#999', fontSize: '12px' }}>
            预计{record.estimatedDuration}小时
          </div>
        </div>
      )
    },
    {
      title: '安装团队',
      key: 'team',
      render: (record: any) => (
        record.installerTeamName ? (
          <div>
            <div>
              <TeamOutlined style={{ marginRight: 4 }} />
              {record.installerTeamName}
            </div>
            <div style={{ color: '#666', fontSize: '12px' }}>
              {record.installerLeaderName}
            </div>
            <div style={{ color: '#666', fontSize: '12px' }}>
              {record.installerLeaderPhone}
            </div>
          </div>
        ) : (
          <Button 
            type="link" 
            icon={<TeamOutlined />}
            onClick={() => assignTeam(record)}
          >
            分配团队
          </Button>
        )
      )
    },
    {
      title: '安装进度',
      key: 'progress',
      render: (record: any) => {
        if (record.installationStatus === 'installing') {
          return (
            <div>
              <Progress 
                percent={record.completionPercentage || 0} 
                size="small" 
                status="active"
              />
              <div style={{ fontSize: '12px', color: '#666' }}>
                进行中
              </div>
            </div>
          );
        }
        return null;
      }
    },
    {
      title: '安装状态',
      dataIndex: 'installationStatus',
      key: 'installationStatus',
      render: (status: string) => {
        const statusConfig = {
          pending: { color: 'orange', text: '待安排' },
          scheduled: { color: 'blue', text: '已预约' },
          assigned: { color: 'cyan', text: '已分配' },
          installing: { color: 'purple', text: '安装中' },
          pending_acceptance: { color: 'gold', text: '待验收' },
          completed: { color: 'green', text: '已完成' },
          cancelled: { color: 'red', text: '已取消' },
          rework: { color: 'volcano', text: '返工' }
        };
        const config = statusConfig[status] || { color: 'default', text: status };
        return <Tag color={config.color}>{config.text}</Tag>;
      }
    },
    {
      title: '安装类型',
      dataIndex: 'installationType',
      key: 'installationType',
      render: (type: string) => {
        const typeConfig = {
          standard: '标准安装',
          complex: '复杂安装',
          supplement: '补充安装',
          repair: '维修安装',
          modification: '改装服务'
        };
        return typeConfig[type] || type;
      }
    },
    {
      title: '验收状态',
      dataIndex: 'acceptanceStatus',
      key: 'acceptanceStatus',
      render: (status: string) => {
        if (!status || status === 'pending') return null;
        
        const statusConfig = {
          passed: { color: 'green', text: '验收通过', icon: <CheckCircleOutlined /> },
          failed: { color: 'red', text: '验收失败' },
          partial: { color: 'orange', text: '部分通过' }
        };
        const config = statusConfig[status];
        return config ? (
          <Tag color={config.color} icon={config.icon}>
            {config.text}
          </Tag>
        ) : null;
      }
    },
    {
      title: '创建时间',
      dataIndex: 'createdAt',
      key: 'createdAt',
      render: (time: string) => time?.slice(0, 16)
    },
    {
      title: '操作',
      key: 'action',
      render: (record: any) => (
        <Space>
          <Button
            type="link"
            icon={<EyeOutlined />}
            onClick={() => viewInstallation(record.id)}
          >
            查看
          </Button>
        </Space>
      )
    }
  ];

  const assignTeam = (installation: any) => {
    setSelectedInstallation(installation);
    setAssignModalVisible(true);
  };

  const viewInstallation = (installationId: number) => {
    window.location.href = `/installations/${installationId}`;
  };

  return (
    <Card title="安装管理">
      <Form layout="inline" style={{ marginBottom: 16 }}>
        <Form.Item name="installationNo" label="安装单号">
          <Input placeholder="请输入安装单号" />
        </Form.Item>
        <Form.Item name="orderNo" label="订单编号">
          <Input placeholder="请输入订单编号" />
        </Form.Item>
        <Form.Item name="customerPhone" label="客户电话">
          <Input placeholder="请输入客户电话" />
        </Form.Item>
        <Form.Item name="installationStatus" label="安装状态">
          <Select placeholder="请选择状态" style={{ width: 120 }}>
            <Option value="">全部</Option>
            <Option value="pending">待安排</Option>
            <Option value="scheduled">已预约</Option>
            <Option value="assigned">已分配</Option>
            <Option value="installing">安装中</Option>
            <Option value="pending_acceptance">待验收</Option>
            <Option value="completed">已完成</Option>
          </Select>
        </Form.Item>
        <Form.Item name="teamId" label="安装团队">
          <Select placeholder="请选择团队" style={{ width: 150 }}>
            <Option value="">全部</Option>
            <Option value="1">精装团队A组</Option>
            <Option value="2">精装团队B组</Option>
          </Select>
        </Form.Item>
        <Form.Item name="dateRange" label="预约时间">
          <RangePicker />
        </Form.Item>
        <Form.Item>
          <Button type="primary" icon={<SearchOutlined />}>
            搜索
          </Button>
        </Form.Item>
      </Form>

      <Table
        columns={columns}
        dataSource={installations}
        loading={loading}
        rowKey="id"
        scroll={{ x: 1400 }}
        pagination={{
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total, range) => 
            `第 ${range[0]}-${range[1]} 条/共 ${total} 条`
        }}
      />

      <Modal
        title="分配安装团队"
        visible={assignModalVisible}
        onCancel={() => setAssignModalVisible(false)}
        footer={null}
        width={700}
      >
        <AssignTeamForm
          installation={selectedInstallation}
          onSuccess={() => {
            setAssignModalVisible(false);
            message.success('团队分配成功');
            // 刷新列表
          }}
        />
      </Modal>
    </Card>
  );
};

export default InstallationList;
```

#### 5.1.2 安装订单详情页面
```typescript
// InstallationDetail.tsx
import React, { useState, useEffect } from 'react';
import {
  Card,
  Descriptions,
  Steps,
  Timeline,
  Image,
  Button,
  Space,
  Tag,
  Progress,
  Modal,
  Form,
  Input,
  Rate,
  Upload,
  message,
  Divider
} from 'antd';
import {
  ClockCircleOutlined,
  CheckCircleOutlined,
  ExclamationCircleOutlined,
  CameraOutlined,
  TeamOutlined,
  PhoneOutlined,
  EnvironmentOutlined
} from '@ant-design/icons';

const { Step } = Steps;
const { TextArea } = Input;

const InstallationDetail: React.FC = () => {
  const [installation, setInstallation] = useState(null);
  const [progressModalVisible, setProgressModalVisible] = useState(false);
  const [acceptanceModalVisible, setAcceptanceModalVisible] = useState(false);

  const getStatusStep = (status: string) => {
    const statusMap = {
      'pending': 0,
      'scheduled': 1,
      'assigned': 2,
      'installing': 3,
      'pending_acceptance': 4,
      'completed': 5
    };
    return statusMap[status] || 0;
  };

  const renderInstallationItems = () => (
    <Card title="安装项目" style={{ marginTop: 16 }}>
      {installation?.items?.map((item, index) => (
        <Card key={index} type="inner" style={{ marginBottom: 8 }}>
          <Descriptions column={3} size="small">
            <Descriptions.Item label="产品名称">{item.productName}</Descriptions.Item>
            <Descriptions.Item label="产品SKU">{item.productSku}</Descriptions.Item>
            <Descriptions.Item label="安装位置">{item.installationPosition}</Descriptions.Item>
            <Descriptions.Item label="安装方式">{item.installationMethod}</Descriptions.Item>
            <Descriptions.Item label="项目状态">
              <Tag color={item.itemStatus === 'completed' ? 'green' : 'blue'}>
                {item.itemStatus === 'completed' ? '已完成' : '进行中'}
              </Tag>
            </Descriptions.Item>
            <Descriptions.Item label="完成进度">
              <Progress percent={item.completionPercentage} size="small" />
            </Descriptions.Item>
          </Descriptions>
          {item.qualityResults && (
            <div style={{ marginTop: 8 }}>
              <strong>质量检查结果：</strong>
              {Object.entries(item.qualityResults).map(([key, value]) => (
                <Tag key={key} color={value === '合格' ? 'green' : 'orange'}>
                  {key}: {value}
                </Tag>
              ))}
            </div>
          )}
        </Card>
      ))}
    </Card>
  );

  return (
    <div>
      <Card title={`安装订单详情 - ${installation?.installationNo}`}>
        <Steps current={getStatusStep(installation?.installationStatus)} style={{ marginBottom: 24 }}>
          <Step title="待安排" description="等待安排安装" />
          <Step title="已预约" description="客户预约时间" />
          <Step title="已分配" description="分配安装团队" />
          <Step title="安装中" description="现场安装施工" />
          <Step title="待验收" description="等待客户验收" />
          <Step title="已完成" description="安装完成" />
        </Steps>

        <Descriptions bordered column={3}>
          <Descriptions.Item label="安装单号">{installation?.installationNo}</Descriptions.Item>
          <Descriptions.Item label="关联订单">{installation?.orderNo}</Descriptions.Item>
          <Descriptions.Item label="安装类型">
            <Tag>{installation?.installationType}</Tag>
          </Descriptions.Item>
          <Descriptions.Item label="客户姓名">{installation?.customerName}</Descriptions.Item>
          <Descriptions.Item label="客户电话">
            <PhoneOutlined style={{ marginRight: 4 }} />
            {installation?.customerPhone}
          </Descriptions.Item>
          <Descriptions.Item label="现场联系人">{installation?.installationContact}</Descriptions.Item>
          <Descriptions.Item label="安装地址" span={3}>
            <EnvironmentOutlined style={{ marginRight: 4 }} />
            {installation?.installationAddress}
          </Descriptions.Item>
          <Descriptions.Item label="预约日期">{installation?.appointmentDate}</Descriptions.Item>
          <Descriptions.Item label="预约时段">{installation?.appointmentTimeSlot}</Descriptions.Item>
          <Descriptions.Item label="预计时长">{installation?.estimatedDuration}小时</Descriptions.Item>
        </Descriptions>

        {installation?.installerTeam && (
          <Card title="安装团队信息" style={{ marginTop: 16 }}>
            <Descriptions bordered column={2}>
              <Descriptions.Item label="团队名称">
                <TeamOutlined style={{ marginRight: 4 }} />
                {installation.installerTeam.teamName}
              </Descriptions.Item>
              <Descriptions.Item label="队长姓名">{installation.installerTeam.leaderName}</Descriptions.Item>
              <Descriptions.Item label="队长电话">
                <PhoneOutlined style={{ marginRight: 4 }} />
                {installation.installerTeam.leaderPhone}
              </Descriptions.Item>
              <Descriptions.Item label="团队成员">
                {installation.installerTeam.members?.map(member => (
                  <Tag key={member.installerId}>{member.installerName}</Tag>
                ))}
              </Descriptions.Item>
            </Descriptions>
          </Card>
        )}

        {renderInstallationItems()}

        {installation?.installationStatus === 'installing' && (
          <Card title="安装进度" style={{ marginTop: 16 }}>
            <Progress 
              percent={installation.completionPercentage || 0} 
              status="active"
              strokeColor={{
                '0%': '#108ee9',
                '100%': '#87d068',
              }}
            />
            <div style={{ marginTop: 16 }}>
              <Button type="primary" onClick={() => setProgressModalVisible(true)}>
                更新进度
              </Button>
            </div>
          </Card>
        )}

        {installation?.beforePhotos?.length > 0 && (
          <Card title="安装前照片" style={{ marginTop: 16 }}>
            <Image.PreviewGroup>
              {installation.beforePhotos.map((photo, index) => (
                <Image
                  key={index}
                  width={120}
                  height={120}
                  src={photo}
                  style={{ marginRight: 8, marginBottom: 8 }}
                />
              ))}
            </Image.PreviewGroup>
          </Card>
        )}

        {installation?.afterPhotos?.length > 0 && (
          <Card title="安装后照片" style={{ marginTop: 16 }}>
            <Image.PreviewGroup>
              {installation.afterPhotos.map((photo, index) => (
                <Image
                  key={index}
                  width={120}
                  height={120}
                  src={photo}
                  style={{ marginRight: 8, marginBottom: 8 }}
                />
              ))}
            </Image.PreviewGroup>
          </Card>
        )}

        {installation?.installationStatus === 'pending_acceptance' && (
          <Card title="客户验收" style={{ marginTop: 16 }}>
            <Button type="primary" onClick={() => setAcceptanceModalVisible(true)}>
              客户验收
            </Button>
          </Card>
        )}
      </Card>

      <Modal
        title="更新安装进度"
        visible={progressModalVisible}
        onCancel={() => setProgressModalVisible(false)}
        footer={null}
        width={600}
      >
        <UpdateProgressForm
          installation={installation}
          onSuccess={() => {
            setProgressModalVisible(false);
            message.success('进度更新成功');
          }}
        />
      </Modal>

      <Modal
        title="客户验收"
        visible={acceptanceModalVisible}
        onCancel={() => setAcceptanceModalVisible(false)}
        footer={null}
        width={600}
      >
        <CustomerAcceptanceForm
          installation={installation}
          onSuccess={() => {
            setAcceptanceModalVisible(false);
            message.success('验收完成');
          }}
        />
      </Modal>
    </div>
  );
};

export default InstallationDetail;
```

### 5.2 移动端界面 (Taro + Taro UI)

#### 5.2.1 安装师傅工作台
```typescript
// InstallerWorkbench.tsx
import React, { useState, useEffect } from 'react';
import { View, Text, Button } from '@tarojs/components';
import { AtCard, AtList, AtListItem, AtButton, AtProgress, AtTag, AtModal } from 'taro-ui';
import Taro from '@tarojs/taro';

const InstallerWorkbench: React.FC = () => {
  const [todayInstallations, setTodayInstallations] = useState([]);
  const [currentInstallation, setCurrentInstallation] = useState(null);
  const [showProgressModal, setShowProgressModal] = useState(false);

  const getStatusColor = (status: string) => {
    const colorMap = {
      'assigned': 'blue',
      'installing': 'orange',
      'pending_acceptance': 'green',
      'completed': 'grey'
    };
    return colorMap[status] || 'grey';
  };

  const getStatusText = (status: string) => {
    const textMap = {
      'assigned': '待开始',
      'installing': '进行中',
      'pending_acceptance': '待验收',
      'completed': '已完成'
    };
    return textMap[status] || status;
  };

  const startInstallation = async (installation: any) => {
    try {
      await Taro.showModal({
        title: '确认开始安装',
        content: `确定开始安装订单 ${installation.installationNo} 吗？`
      });
      
      // 调用开始安装API
      setCurrentInstallation(installation);
      Taro.showToast({
        title: '安装已开始',
        icon: 'success'
      });
    } catch (error) {
      console.error('开始安装失败:', error);
    }
  };

  const updateProgress = () => {
    setShowProgressModal(true);
  };

  const navigateToDetail = (installationId: number) => {
    Taro.navigateTo({
      url: `/pages/installation/detail?id=${installationId}`
    });
  };

  const callCustomer = (phone: string) => {
    Taro.makePhoneCall({
      phoneNumber: phone
    });
  };

  const openNavigation = (address: string) => {
    Taro.openLocation({
      name: '安装地址',
      address: address
    });
  };

  return (
    <View className="installer-workbench">
      <AtCard title="今日安装任务" extra={`共${todayInstallations.length}个任务`}>
        {todayInstallations.length === 0 ? (
          <View className="empty-state">
            <Text>今日暂无安装任务</Text>
          </View>
        ) : (
          <AtList>
            {todayInstallations.map((installation, index) => (
              <AtListItem
                key={installation.id}
                title={installation.installationNo}
                note={`${installation.customerName} | ${installation.appointmentTimeSlot}`}
                extraText={
                  <AtTag 
                    size="small" 
                    type="primary" 
                    color={getStatusColor(installation.installationStatus)}
                  >
                    {getStatusText(installation.installationStatus)}
                  </AtTag>
                }
                onClick={() => navigateToDetail(installation.id)}
              />
            ))}
          </AtList>
        )}
      </AtCard>

      {currentInstallation && (
        <AtCard title="当前安装" className="current-installation">
          <View className="installation-info">
            <Text className="installation-no">{currentInstallation.installationNo}</Text>
            <Text className="customer-info">
              客户：{currentInstallation.customerName} | {currentInstallation.customerPhone}
            </Text>
            <Text className="address">
              地址：{currentInstallation.installationAddress}
            </Text>
            
            {currentInstallation.installationStatus === 'installing' && (
              <View className="progress-section">
                <Text>安装进度</Text>
                <AtProgress 
                  percent={currentInstallation.completionPercentage || 0}
                  status="progress"
                  strokeWidth={8}
                />
              </View>
            )}
          </View>

          <View className="action-buttons">
            {currentInstallation.installationStatus === 'assigned' && (
              <AtButton 
                type="primary" 
                size="small"
                onClick={() => startInstallation(currentInstallation)}
              >
                开始安装
              </AtButton>
            )}
            
            {currentInstallation.installationStatus === 'installing' && (
              <AtButton 
                type="primary" 
                size="small"
                onClick={updateProgress}
              >
                更新进度
              </AtButton>
            )}

            <AtButton 
              size="small"
              onClick={() => callCustomer(currentInstallation.customerPhone)}
            >
              联系客户
            </AtButton>
            
            <AtButton 
              size="small"
              onClick={() => openNavigation(currentInstallation.installationAddress)}
            >
              导航
            </AtButton>
          </View>
        </AtCard>
      )}

      <AtModal
        isOpened={showProgressModal}
        title="更新安装进度"
        onClose={() => setShowProgressModal(false)}
        onCancel={() => setShowProgressModal(false)}
        onConfirm={() => {
          // 处理进度更新
          setShowProgressModal(false);
          Taro.showToast({
            title: '进度更新成功',
            icon: 'success'
          });
        }}
      >
        <ProgressUpdateForm installation={currentInstallation} />
      </AtModal>
    </View>
  );
};

export default InstallerWorkbench;
```

## 6. 性能优化

### 6.1 数据库优化
- **索引优化**：为常用查询字段建立复合索引
- **分页查询**：大数据量列表采用分页加载
- **读写分离**：查询操作使用只读副本
- **数据归档**：定期归档历史安装数据

### 6.2 缓存策略
- **Redis缓存**：缓存安装团队信息、安装标准等
- **地理位置缓存**：缓存地址坐标和距离计算结果
- **查询缓存**：缓存复杂查询结果
- **分布式缓存**：支持多实例缓存同步

### 6.3 异步处理
- **消息队列**：安装状态变更、通知发送使用异步处理
- **批量操作**：批量更新安装进度和统计数据
- **定时任务**：定期清理过期数据和生成报表

## 7. 安全与权限控制

### 7.1 数据权限
- **角色权限**：基于角色的安装数据访问控制
- **区域隔离**：按城市/门店隔离安装数据
- **团队隔离**：安装师傅只能查看自己的安装任务

### 7.2 操作权限
- **创建权限**：销售人员可创建安装订单
- **分配权限**：安装主管可分配安装团队
- **执行权限**：安装师傅可更新安装进度
- **验收权限**：客服人员可处理客户验收

### 7.3 数据安全
- **照片加密**：安装照片采用加密存储
- **数据备份**：定期备份安装数据
- **访问日志**：记录所有数据访问操作

## 8. 监控与告警

### 8.1 业务监控
- **安装完成率**：按时间段统计安装完成情况
- **客户满意度**：统计客户验收满意度
- **团队效率**：监控安装团队工作效率
- **质量评分**：跟踪安装质量评分趋势

### 8.2 系统监控
- **API性能**：监控安装相关API响应时间
- **数据库性能**：监控数据库查询性能
- **文件上传**：监控照片上传成功率

### 8.3 告警规则
```typescript
const ALERT_RULES = {
  // 安装延期告警
  installation_delay: {
    condition: '预约时间超过当前时间24小时且状态为assigned',
    level: 'warning',
    message: '安装任务延期，需要重新安排'
  },
  
  // 团队工作量告警
  team_overload: {
    condition: '团队当日安装任务数 > maxConcurrentOrders',
    level: 'error',
    message: '安装团队工作量超载'
  },
  
  // 客户满意度告警
  low_satisfaction: {
    condition: '客户满意度 < 3分',
    level: 'warning',
    message: '客户满意度较低，需要关注'
  },
  
  // 安装质量告警
  quality_issue: {
    condition: '质量评分 < 3分 或 验收状态为failed',
    level: 'error',
    message: '安装质量问题，需要立即处理'
  }
};
```
```

现
