# 产品管理模块设计

## 1. 模块概述

### 1.1 功能目标
产品管理模块是整个定制家具系统的核心模块，负责管理产品信息、规格配置、价格体系、库存管理等，为销售、报价、生产等业务提供基础数据支撑。

**核心目标**：
- **产品信息管理**：维护完整的产品基础信息和属性
- **规格配置管理**：支持灵活的产品规格和配置组合
- **价格体系管理**：建立多层次的产品价格体系
- **库存管理**：实时跟踪产品库存状态
- **分类管理**：建立科学的产品分类体系
- **版本控制**：支持产品信息的版本管理和历史追溯

### 1.2 业务流程
```
产品规划 → 产品创建 → 规格配置 → 价格设定 → 库存初始化 → 上架销售
    ↓         ↓         ↓         ↓         ↓           ↓
  市场调研   基础信息   属性配置   成本核算   库存管理     销售支持
```

### 1.3 产品类型
- **标准产品**：规格固定的标准化产品
- **定制产品**：可根据客户需求定制的产品
- **组合产品**：由多个子产品组成的套装产品
- **配件产品**：作为主产品配件的辅助产品
- **服务产品**：安装、维修等服务类产品

### 1.4 产品状态流转
```
草稿 → 待审核 → 已审核 → 已上架 → 已下架 → 已停产
  ↓      ↓       ↓       ↓       ↓       ↓
draft  pending  approved active  inactive discontinued
```

## 2. 数据库设计

### 2.1 产品基础信息表 (products)
```sql
CREATE TABLE products (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  product_code VARCHAR(50) NOT NULL UNIQUE COMMENT '产品编码',
  product_name VARCHAR(200) NOT NULL COMMENT '产品名称',
  product_name_en VARCHAR(200) COMMENT '产品英文名称',
  short_name VARCHAR(100) COMMENT '产品简称',
  
  -- 分类信息
  category_id BIGINT NOT NULL COMMENT '产品分类ID',
  category_path VARCHAR(500) COMMENT '分类路径',
  brand_id BIGINT COMMENT '品牌ID',
  series_id BIGINT COMMENT '系列ID',
  
  -- 产品类型
  product_type ENUM('standard', 'custom', 'combo', 'accessory', 'service') 
    NOT NULL DEFAULT 'standard' COMMENT '产品类型',
  is_customizable BOOLEAN DEFAULT FALSE COMMENT '是否可定制',
  is_combo BOOLEAN DEFAULT FALSE COMMENT '是否组合产品',
  
  -- 基础属性
  material VARCHAR(100) COMMENT '主要材质',
  style VARCHAR(100) COMMENT '风格',
  color VARCHAR(100) COMMENT '颜色',
  size_range VARCHAR(200) COMMENT '尺寸范围',
  weight_range VARCHAR(100) COMMENT '重量范围',
  
  -- 描述信息
  short_description TEXT COMMENT '简短描述',
  detailed_description TEXT COMMENT '详细描述',
  features JSON COMMENT '产品特点',
  specifications JSON COMMENT '技术规格',
  usage_scenarios JSON COMMENT '使用场景',
  
  -- 媒体资源
  main_image VARCHAR(500) COMMENT '主图片',
  image_gallery JSON COMMENT '图片库',
  video_urls JSON COMMENT '视频链接',
  model_3d_url VARCHAR(500) COMMENT '3D模型链接',
  
  -- 价格信息
  base_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '基础价格',
  cost_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '成本价格',
  market_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '市场价格',
  min_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '最低价格',
  max_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '最高价格',
  price_unit VARCHAR(20) DEFAULT '件' COMMENT '价格单位',
  
  -- 库存信息
  stock_unit VARCHAR(20) DEFAULT '件' COMMENT '库存单位',
  min_stock_level INT DEFAULT 0 COMMENT '最低库存',
  max_stock_level INT DEFAULT 0 COMMENT '最高库存',
  reorder_point INT DEFAULT 0 COMMENT '补货点',
  lead_time INT DEFAULT 0 COMMENT '生产周期(天)',
  
  -- 销售信息
  is_saleable BOOLEAN DEFAULT TRUE COMMENT '是否可销售',
  sales_start_date DATE COMMENT '销售开始日期',
  sales_end_date DATE COMMENT '销售结束日期',
  min_order_quantity INT DEFAULT 1 COMMENT '最小起订量',
  max_order_quantity INT COMMENT '最大订购量',
  
  -- 生产信息
  is_producible BOOLEAN DEFAULT TRUE COMMENT '是否可生产',
  production_complexity ENUM('simple', 'medium', 'complex') 
    DEFAULT 'medium' COMMENT '生产复杂度',
  production_time INT DEFAULT 0 COMMENT '生产时间(小时)',
  quality_level ENUM('standard', 'premium', 'luxury') 
    DEFAULT 'standard' COMMENT '质量等级',
  
  -- 物流信息
  package_length DECIMAL(8,2) COMMENT '包装长度(cm)',
  package_width DECIMAL(8,2) COMMENT '包装宽度(cm)',
  package_height DECIMAL(8,2) COMMENT '包装高度(cm)',
  package_weight DECIMAL(8,2) COMMENT '包装重量(kg)',
  is_fragile BOOLEAN DEFAULT FALSE COMMENT '是否易碎',
  special_handling JSON COMMENT '特殊处理要求',
  
  -- 状态信息
  product_status ENUM('draft', 'pending', 'approved', 'active', 'inactive', 'discontinued') 
    NOT NULL DEFAULT 'draft' COMMENT '产品状态',
  version VARCHAR(20) DEFAULT '1.0' COMMENT '版本号',
  is_deleted BOOLEAN DEFAULT FALSE COMMENT '是否删除',
  
  -- 审核信息
  reviewed_by BIGINT COMMENT '审核人ID',
  reviewed_at DATETIME COMMENT '审核时间',
  review_notes TEXT COMMENT '审核备注',
  
  -- 统计信息
  view_count INT DEFAULT 0 COMMENT '浏览次数',
  order_count INT DEFAULT 0 COMMENT '订购次数',
  sales_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT '销售金额',
  rating_average DECIMAL(3,2) DEFAULT 0.00 COMMENT '平均评分',
  rating_count INT DEFAULT 0 COMMENT '评分次数',
  
  -- 系统字段
  created_by BIGINT NOT NULL COMMENT '创建人ID',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_by BIGINT COMMENT '更新人ID',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  INDEX idx_product_code (product_code),
  INDEX idx_category_id (category_id),
  INDEX idx_brand_id (brand_id),
  INDEX idx_product_type (product_type),
  INDEX idx_product_status (product_status),
  INDEX idx_is_saleable (is_saleable),
  INDEX idx_created_at (created_at),
  FULLTEXT idx_search (product_name, short_description)
) COMMENT='产品基础信息表';
```

### 2.2 产品分类表 (product_categories)
```sql
CREATE TABLE product_categories (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  category_code VARCHAR(50) NOT NULL UNIQUE COMMENT '分类编码',
  category_name VARCHAR(100) NOT NULL COMMENT '分类名称',
  category_name_en VARCHAR(100) COMMENT '英文名称',
  
  -- 层级结构
  parent_id BIGINT DEFAULT 0 COMMENT '父分类ID',
  level INT NOT NULL DEFAULT 1 COMMENT '层级',
  path VARCHAR(500) COMMENT '分类路径',
  is_leaf BOOLEAN DEFAULT TRUE COMMENT '是否叶子节点',
  
  -- 分类属性
  category_type ENUM('physical', 'virtual', 'service') 
    DEFAULT 'physical' COMMENT '分类类型',
  sort_order INT DEFAULT 0 COMMENT '排序',
  icon VARCHAR(200) COMMENT '图标',
  image VARCHAR(500) COMMENT '分类图片',
  
  -- 描述信息
  description TEXT COMMENT '分类描述',
  keywords VARCHAR(500) COMMENT '关键词',
  
  -- 配置信息
  attributes JSON COMMENT '分类属性配置',
  specifications JSON COMMENT '规格配置',
  pricing_rules JSON COMMENT '定价规则',
  
  -- 状态信息
  status ENUM('active', 'inactive') NOT NULL DEFAULT 'active' COMMENT '状态',
  is_deleted BOOLEAN DEFAULT FALSE COMMENT '是否删除',
  
  -- 统计信息
  product_count INT DEFAULT 0 COMMENT '产品数量',
  
  created_by BIGINT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_by BIGINT,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_parent_id (parent_id),
  INDEX idx_level (level),
  INDEX idx_status (status),
  INDEX idx_sort_order (sort_order)
) COMMENT='产品分类表';
```

### 2.3 产品规格表 (product_specifications)
```sql
CREATE TABLE product_specifications (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  product_id BIGINT NOT NULL COMMENT '产品ID',
  spec_name VARCHAR(100) NOT NULL COMMENT '规格名称',
  spec_code VARCHAR(50) NOT NULL COMMENT '规格编码',
  
  -- 规格类型
  spec_type ENUM('size', 'color', 'material', 'style', 'function', 'other') 
    NOT NULL COMMENT '规格类型',
  data_type ENUM('text', 'number', 'select', 'multi_select', 'range') 
    NOT NULL DEFAULT 'text' COMMENT '数据类型',
  
  -- 规格值
  spec_value TEXT COMMENT '规格值',
  spec_options JSON COMMENT '可选项',
  min_value DECIMAL(10,2) COMMENT '最小值',
  max_value DECIMAL(10,2) COMMENT '最大值',
  unit VARCHAR(20) COMMENT '单位',
  
  -- 价格影响
  price_impact DECIMAL(10,2) DEFAULT 0.00 COMMENT '价格影响',
  price_type ENUM('fixed', 'percentage', 'formula') 
    DEFAULT 'fixed' COMMENT '价格类型',
  price_formula TEXT COMMENT '价格公式',
  
  -- 库存影响
  stock_impact INT DEFAULT 0 COMMENT '库存影响',
  lead_time_impact INT DEFAULT 0 COMMENT '生产周期影响',
  
  -- 显示配置
  is_required BOOLEAN DEFAULT FALSE COMMENT '是否必填',
  is_visible BOOLEAN DEFAULT TRUE COMMENT '是否显示',
  sort_order INT DEFAULT 0 COMMENT '排序',
  display_name VARCHAR(100) COMMENT '显示名称',
  description TEXT COMMENT '描述',
  
  -- 验证规则
  validation_rules JSON COMMENT '验证规则',
  
  status ENUM('active', 'inactive') NOT NULL DEFAULT 'active',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_product_id (product_id),
  INDEX idx_spec_type (spec_type),
  INDEX idx_status (status),
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) COMMENT='产品规格表';
```

### 2.4 产品库存表 (product_inventory)
```sql
CREATE TABLE product_inventory (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  product_id BIGINT NOT NULL COMMENT '产品ID',
  warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
  
  -- 库存数量
  available_quantity INT DEFAULT 0 COMMENT '可用库存',
  reserved_quantity INT DEFAULT 0 COMMENT '预留库存',
  total_quantity INT DEFAULT 0 COMMENT '总库存',
  in_transit_quantity INT DEFAULT 0 COMMENT '在途库存',
  
  -- 库存成本
  unit_cost DECIMAL(10,2) DEFAULT 0.00 COMMENT '单位成本',
  total_cost DECIMAL(15,2) DEFAULT 0.00 COMMENT '总成本',
  average_cost DECIMAL(10,2) DEFAULT 0.00 COMMENT '平均成本',
  
  -- 库存状态
  stock_status ENUM('normal', 'low', 'out_of_stock', 'excess') 
    DEFAULT 'normal' COMMENT '库存状态',
  last_in_date DATETIME COMMENT '最后入库时间',
  last_out_date DATETIME COMMENT '最后出库时间',
  
  -- 预警设置
  min_stock_alert INT DEFAULT 0 COMMENT '最低库存预警',
  max_stock_alert INT DEFAULT 0 COMMENT '最高库存预警',
  reorder_point INT DEFAULT 0 COMMENT '补货点',
  reorder_quantity INT DEFAULT 0 COMMENT '补货数量',
  
  -- 统计信息
  total_in_quantity INT DEFAULT 0 COMMENT '累计入库数量',
  total_out_quantity INT DEFAULT 0 COMMENT '累计出库数量',
  turnover_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '周转率',
  
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY uk_product_warehouse (product_id, warehouse_id),
  INDEX idx_warehouse_id (warehouse_id),
  INDEX idx_stock_status (stock_status),
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) COMMENT='产品库存表';
```

### 2.5 产品价格表 (product_prices)
```sql
CREATE TABLE product_prices (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  product_id BIGINT NOT NULL COMMENT '产品ID',
  price_type ENUM('base', 'cost', 'market', 'promotion', 'vip', 'wholesale') 
    NOT NULL COMMENT '价格类型',
  
  -- 价格信息
  price DECIMAL(10,2) NOT NULL COMMENT '价格',
  currency VARCHAR(10) DEFAULT 'CNY' COMMENT '货币',
  unit VARCHAR(20) DEFAULT '件' COMMENT '单位',
  
  -- 适用条件
  min_quantity INT DEFAULT 1 COMMENT '最小数量',
  max_quantity INT COMMENT '最大数量',
  customer_level VARCHAR(50) COMMENT '客户等级',
  region VARCHAR(100) COMMENT '适用地区',
  channel VARCHAR(50) COMMENT '销售渠道',
  
  -- 有效期
  effective_date DATE COMMENT '生效日期',
  expiry_date DATE COMMENT '失效日期',
  
  -- 价格规则
  pricing_formula TEXT COMMENT '定价公式',
  discount_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '折扣率',
  markup_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '加价率',
  
  -- 状态信息
  status ENUM('active', 'inactive', 'pending') NOT NULL DEFAULT 'active',
  is_default BOOLEAN DEFAULT FALSE COMMENT '是否默认价格',
  
  -- 审核信息
  approved_by BIGINT COMMENT '审核人ID',
  approved_at DATETIME COMMENT '审核时间',
  
  created_by BIGINT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_product_id (product_id),
  INDEX idx_price_type (price_type),
  INDEX idx_status (status),
  INDEX idx_effective_date (effective_date),
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) COMMENT='产品价格表';
```

### 2.6 产品组合表 (product_combos)
```sql
CREATE TABLE product_combos (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  combo_product_id BIGINT NOT NULL COMMENT '组合产品ID',
  child_product_id BIGINT NOT NULL COMMENT '子产品ID',
  
  -- 组合信息
  quantity INT NOT NULL DEFAULT 1 COMMENT '数量',
  is_required BOOLEAN DEFAULT TRUE COMMENT '是否必需',
  is_replaceable BOOLEAN DEFAULT FALSE COMMENT '是否可替换',
  
  -- 价格信息
  unit_price DECIMAL(10,2) DEFAULT 0.00 COMMENT '单价',
  discount_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '折扣率',
  
  -- 显示信息
  sort_order INT DEFAULT 0 COMMENT '排序',
  display_name VARCHAR(200) COMMENT '显示名称',
  description TEXT COMMENT '描述',
  
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  UNIQUE KEY uk_combo_child (combo_product_id, child_product_id),
  INDEX idx_child_product_id (child_product_id),
  FOREIGN KEY (combo_product_id) REFERENCES products(id) ON DELETE CASCADE,
  FOREIGN KEY (child_product_id) REFERENCES products(id) ON DELETE CASCADE
) COMMENT='产品组合表';
```

## 3. API接口设计

### 3.1 产品管理

#### 3.1.1 创建产品
```typescript
POST /api/products
Content-Type: application/json

{
  "productCode": "YG001",
  "productName": "现代简约衣柜",
  "shortName": "简约衣柜",
  "categoryId": 123,
  "brandId": 456,
  "seriesId": 789,
  "productType": "custom",
  "isCustomizable": true,
  "material": "实木颗粒板",
  "style": "现代简约",
  "color": "白色",
  "sizeRange": "宽度120-300cm，高度200-240cm",
  "shortDescription": "现代简约风格定制衣柜，环保材质",
  "detailedDescription": "采用E0级实木颗粒板制作...",
  "features": [
    "环保E0级板材",
    "静音导轨",
    "防潮处理",
    "可定制尺寸"
  ],
  "specifications": {
    "material": "实木颗粒板",
    "thickness": "18mm",
    "edge": "PVC封边",
    "hardware": "奥地利百隆"
  },
  "mainImage": "https://example.com/images/yg001_main.jpg",
  "imageGallery": [
    "https://example.com/images/yg001_1.jpg",
    "https://example.com/images/yg001_2.jpg"
  ],
  "basePrice": 1200.00,
  "costPrice": 800.00,
  "marketPrice": 1500.00,
  "priceUnit": "平方米",
  "stockUnit": "套",
  "minStockLevel": 10,
  "leadTime": 15,
  "minOrderQuantity": 1,
  "productionComplexity": "medium",
  "productionTime": 48,
  "qualityLevel": "premium"
}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 12345,
    "productCode": "YG001",
    "productName": "现代简约衣柜",
    "productStatus": "draft",
    "version": "1.0",
    "createdAt": "2024-01-15T10:00:00Z"
  }
}
```

### 4.2 库存服务 (InventoryService)

```typescript
@Injectable()
export class InventoryService {
  constructor(
    private inventoryRepository: InventoryRepository,
    private productRepository: ProductRepository,
    private warehouseRepository: WarehouseRepository,
    private inventoryLogRepository: InventoryLogRepository,
    private notificationService: NotificationService,
    private eventBus: EventBus
  ) {}

  /**
   * 更新库存
   */
  async updateInventory(
    productId: number,
    warehouseId: number,
    operation: InventoryOperation,
    quantity: number,
    reason: string,
    userId: number,
    unitCost?: number
  ): Promise<InventoryUpdateResult> {
    const inventory = await this.getOrCreateInventory(productId, warehouseId);
    
    // 1. 验证操作
    await this.validateInventoryOperation(inventory, operation, quantity);

    // 2. 计算新库存
    const newQuantities = this.calculateNewQuantities(
      inventory,
      operation,
      quantity
    );

    // 3. 更新库存记录
    const updatedInventory = await this.inventoryRepository.update(
      inventory.id,
      {
        ...newQuantities,
        unitCost: unitCost || inventory.unitCost,
        totalCost: newQuantities.totalQuantity * (unitCost || inventory.unitCost),
        averageCost: this.calculateAverageCost(inventory, quantity, unitCost),
        stockStatus: this.determineStockStatus(newQuantities),
        updatedAt: new Date()
      }
    );

    // 4. 记录库存日志
    await this.inventoryLogRepository.create({
      productId,
      warehouseId,
      operation,
      quantity,
      beforeQuantity: inventory.totalQuantity,
      afterQuantity: newQuantities.totalQuantity,
      unitCost: unitCost || inventory.unitCost,
      reason,
      operatedBy: userId,
      operatedAt: new Date()
    });

    // 5. 检查库存预警
    await this.checkStockAlerts(updatedInventory);

    // 6. 发布库存变更事件
    await this.eventBus.publish('inventory.updated', {
      productId,
      warehouseId,
      operation,
      quantity,
      newQuantity: newQuantities.totalQuantity
    });

    return {
      success: true,
      inventory: updatedInventory,
      operation,
      quantity
    };
  }

  /**
   * 预留库存
   */
  async reserveInventory(
    productId: number,
    warehouseId: number,
    quantity: number,
    orderId: number,
    userId: number
  ): Promise<InventoryReservation> {
    const inventory = await this.inventoryRepository.findByProductAndWarehouse(
      productId,
      warehouseId
    );

    if (!inventory || inventory.availableQuantity < quantity) {
      throw new InsufficientStockException(
        `库存不足，可用库存：${inventory?.availableQuantity || 0}，需要：${quantity}`
      );
    }

    // 1. 更新库存数量
    await this.inventoryRepository.update(inventory.id, {
      availableQuantity: inventory.availableQuantity - quantity,
      reservedQuantity: inventory.reservedQuantity + quantity
    });

    // 2. 创建预留记录
    const reservation = await this.inventoryReservationRepository.create({
      productId,
      warehouseId,
      orderId,
      quantity,
      status: 'active',
      reservedBy: userId,
      reservedAt: new Date(),
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24小时后过期
    });

    // 3. 记录操作日志
    await this.inventoryLogRepository.create({
      productId,
      warehouseId,
      operation: 'reserve',
      quantity,
      beforeQuantity: inventory.availableQuantity + quantity,
      afterQuantity: inventory.availableQuantity,
      reason: `订单预留 - ${orderId}`,
      operatedBy: userId,
      operatedAt: new Date()
    });

    return reservation;
  }

  /**
   * 释放库存预留
   */
  async releaseReservation(
    reservationId: number,
    userId: number
  ): Promise<void> {
    const reservation = await this.inventoryReservationRepository.findById(
      reservationId
    );

    if (!reservation || reservation.status !== 'active') {
      throw new NotFoundException('预留记录不存在或已失效');
    }

    const inventory = await this.inventoryRepository.findByProductAndWarehouse(
      reservation.productId,
      reservation.warehouseId
    );

    // 1. 更新库存数量
    await this.inventoryRepository.update(inventory.id, {
      availableQuantity: inventory.availableQuantity + reservation.quantity,
      reservedQuantity: inventory.reservedQuantity - reservation.quantity
    });

    // 2. 更新预留状态
    await this.inventoryReservationRepository.update(reservationId, {
      status: 'released',
      releasedBy: userId,
      releasedAt: new Date()
    });

    // 3. 记录操作日志
    await this.inventoryLogRepository.create({
      productId: reservation.productId,
      warehouseId: reservation.warehouseId,
      operation: 'release',
      quantity: reservation.quantity,
      beforeQuantity: inventory.availableQuantity,
      afterQuantity: inventory.availableQuantity + reservation.quantity,
      reason: `释放预留 - 订单${reservation.orderId}`,
      operatedBy: userId,
      operatedAt: new Date()
    });
  }

  /**
   * 库存盘点
   */
  async performStockTaking(
    warehouseId: number,
    productIds: number[],
    userId: number
  ): Promise<StockTakingResult> {
    const stockTaking = await this.stockTakingRepository.create({
      warehouseId,
      status: 'in_progress',
      startedBy: userId,
      startedAt: new Date()
    });

    const results = [];

    for (const productId of productIds) {
      const inventory = await this.inventoryRepository.findByProductAndWarehouse(
        productId,
        warehouseId
      );

      if (inventory) {
        const stockTakingItem = await this.stockTakingItemRepository.create({
          stockTakingId: stockTaking.id,
          productId,
          systemQuantity: inventory.totalQuantity,
          actualQuantity: null, // 待盘点
          status: 'pending'
        });

        results.push(stockTakingItem);
      }
    }

    return {
      stockTakingId: stockTaking.id,
      items: results,
      status: 'in_progress'
    };
  }

  /**
   * 检查库存预警
   */
  private async checkStockAlerts(inventory: ProductInventory): Promise<void> {
    const product = await this.productRepository.findById(inventory.productId);
    const warehouse = await this.warehouseRepository.findById(inventory.warehouseId);

    // 1. 低库存预警
    if (inventory.availableQuantity <= inventory.minStockAlert) {
      await this.notificationService.sendAlert({
        type: 'low_stock',
        title: '库存不足预警',
        message: `产品 ${product.productName} 在 ${warehouse.warehouseName} 库存不足`,
        data: {
          productId: inventory.productId,
          warehouseId: inventory.warehouseId,
          currentStock: inventory.availableQuantity,
          minStock: inventory.minStockAlert
        },
        recipients: ['inventory_manager', 'procurement_manager']
      });
    }

    // 2. 零库存预警
    if (inventory.availableQuantity === 0) {
      await this.notificationService.sendAlert({
        type: 'out_of_stock',
        title: '库存为零预警',
        message: `产品 ${product.productName} 在 ${warehouse.warehouseName} 已无库存`,
        data: {
          productId: inventory.productId,
          warehouseId: inventory.warehouseId
        },
        recipients: ['inventory_manager', 'sales_manager']
      });
    }

    // 3. 超库存预警
    if (inventory.totalQuantity > inventory.maxStockAlert) {
      await this.notificationService.sendAlert({
        type: 'excess_stock',
        title: '库存过多预警',
        message: `产品 ${product.productName} 在 ${warehouse.warehouseName} 库存过多`,
        data: {
          productId: inventory.productId,
          warehouseId: inventory.warehouseId,
          currentStock: inventory.totalQuantity,
          maxStock: inventory.maxStockAlert
        },
        recipients: ['inventory_manager']
      });
    }
  }

  /**
   * 计算平均成本
   */
  private calculateAverageCost(
    inventory: ProductInventory,
    quantity: number,
    unitCost?: number
  ): number {
    if (!unitCost) return inventory.averageCost;

    const totalCost = inventory.totalCost + (quantity * unitCost);
    const totalQuantity = inventory.totalQuantity + quantity;

    return totalQuantity > 0 ? totalCost / totalQuantity : 0;
  }

  /**
   * 确定库存状态
   */
  private determineStockStatus(quantities: any): string {
    if (quantities.availableQuantity === 0) {
      return 'out_of_stock';
    } else if (quantities.availableQuantity <= quantities.minStockAlert) {
      return 'low';
    } else if (quantities.totalQuantity > quantities.maxStockAlert) {
      return 'excess';
    } else {
      return 'normal';
    }
  }
}
```

### 4.3 价格服务 (PriceService)

```typescript
@Injectable()
export class PriceService {
  constructor(
    private priceRepository: PriceRepository,
    private productRepository: ProductRepository,
    private customerRepository: CustomerRepository,
    private cacheService: CacheService
  ) {}

  /**
   * 获取产品价格
   */
  async getProductPrice(
    productId: number,
    priceType: string = 'base',
    quantity: number = 1,
    customerId?: number,
    region?: string,
    channel?: string
  ): Promise<ProductPrice> {
    // 1. 构建价格查询条件
    const conditions = {
      productId,
      priceType,
      status: 'active',
      effectiveDate: { $lte: new Date() },
      expiryDate: { $gte: new Date() }
    };

    // 2. 添加客户等级条件
    if (customerId) {
      const customer = await this.customerRepository.findById(customerId);
      if (customer) {
        conditions.customerLevel = customer.level;
      }
    }

    // 3. 添加地区和渠道条件
    if (region) conditions.region = region;
    if (channel) conditions.channel = channel;

    // 4. 查询价格
    const prices = await this.priceRepository.findByConditions(conditions);

    // 5. 选择最适合的价格
    const selectedPrice = this.selectBestPrice(prices, quantity);

    if (!selectedPrice) {
      // 使用产品基础价格
      const product = await this.productRepository.findById(productId);
      return {
        productId,
        price: product.basePrice,
        currency: 'CNY',
        unit: product.priceUnit,
        priceType: 'base',
        effectiveDate: new Date(),
        source: 'product_base_price'
      };
    }

    return selectedPrice;
  }

  /**
   * 批量设置价格
   */
  async setBatchPrices(
    priceUpdates: BatchPriceUpdate[],
    userId: number
  ): Promise<BatchPriceResult> {
    const results = [];
    const errors = [];

    for (const update of priceUpdates) {
      try {
        // 1. 验证产品存在
        const product = await this.productRepository.findById(update.productId);
        if (!product) {
          errors.push({
            productId: update.productId,
            error: '产品不存在'
          });
          continue;
        }

        // 2. 验证价格合理性
        const validation = await this.validatePrice(update);
        if (!validation.isValid) {
          errors.push({
            productId: update.productId,
            error: validation.message
          });
          continue;
        }

        // 3. 创建或更新价格
        const price = await this.createOrUpdatePrice(update, userId);
        results.push(price);

        // 4. 清除价格缓存
        await this.clearPriceCache(update.productId);

      } catch (error) {
        errors.push({
          productId: update.productId,
          error: error.message
        });
      }
    }

    return {
      success: results.length,
      failed: errors.length,
      results,
      errors
    };
  }

  /**
   * 价格计算引擎
   */
  async calculatePrice(
    productId: number,
    specifications: ProductSpecification[],
    quantity: number,
    customerId?: number,
    promotionCode?: string
  ): Promise<PriceCalculation> {
    // 1. 获取基础价格
    const basePrice = await this.getProductPrice(
      productId,
      'base',
      quantity,
      customerId
    );

    // 2. 计算规格价格影响
    const specificationCost = await this.calculateSpecificationCost(
      productId,
      specifications
    );

    // 3. 计算数量折扣
    const quantityDiscount = await this.calculateQuantityDiscount(
      productId,
      quantity,
      customerId
    );

    // 4. 计算促销折扣
    const promotionDiscount = promotionCode
      ? await this.calculatePromotionDiscount(
          productId,
          promotionCode,
          customerId
        )
      : { rate: 0, amount: 0 };

    // 5. 计算最终价格
    const unitPrice = basePrice.price + specificationCost.totalCost;
    const subtotal = unitPrice * quantity;
    const quantityDiscountAmount = subtotal * quantityDiscount.rate;
    const promotionDiscountAmount = Math.min(
      (subtotal - quantityDiscountAmount) * promotionDiscount.rate,
      promotionDiscount.amount
    );
    const totalDiscount = quantityDiscountAmount + promotionDiscountAmount;
    const finalPrice = subtotal - totalDiscount;

    return {
      productId,
      basePrice: basePrice.price,
      specificationCost: specificationCost.totalCost,
      unitPrice,
      quantity,
      subtotal,
      quantityDiscount: {
        rate: quantityDiscount.rate,
        amount: quantityDiscountAmount
      },
      promotionDiscount: {
        code: promotionCode,
        rate: promotionDiscount.rate,
        amount: promotionDiscountAmount
      },
      totalDiscount,
      finalPrice,
      currency: basePrice.currency,
      calculatedAt: new Date(),
      breakdown: {
        basePrice: basePrice.price,
        specifications: specificationCost.breakdown,
        discounts: [
          {
            type: 'quantity',
            rate: quantityDiscount.rate,
            amount: quantityDiscountAmount
          },
          {
            type: 'promotion',
            code: promotionCode,
            rate: promotionDiscount.rate,
            amount: promotionDiscountAmount
          }
        ]
      }
    };
  }

  /**
   * 选择最佳价格
   */
  private selectBestPrice(
    prices: ProductPrice[],
    quantity: number
  ): ProductPrice | null {
    if (!prices.length) return null;

    // 1. 过滤数量范围
    const validPrices = prices.filter(price => {
      return quantity >= (price.minQuantity || 1) &&
             (price.maxQuantity === null || quantity <= price.maxQuantity);
    });

    if (!validPrices.length) return prices[0];

    // 2. 按优先级排序（价格类型、客户等级、地区等）
    validPrices.sort((a, b) => {
      // 优先级：vip > wholesale > promotion > market > base
      const priorityOrder = {
        'vip': 5,
        'wholesale': 4,
        'promotion': 3,
        'market': 2,
        'base': 1
      };

      const aPriority = priorityOrder[a.priceType] || 0;
      const bPriority = priorityOrder[b.priceType] || 0;

      if (aPriority !== bPriority) {
        return bPriority - aPriority;
      }

      // 相同优先级时选择价格更低的
      return a.price - b.price;
    });

    return validPrices[0];
  }
}
```

## 5. 前端界面设计

### 5.1 Web端界面 (Ant Design)

#### 5.1.1 产品列表页面
```typescript
import React, { useState, useEffect } from 'react';
import {
  Table,
  Card,
  Form,
  Input,
  Select,
  Button,
  Space,
  Tag,
  Image,
  Tooltip,
  Modal,
  message,
  Drawer,
  Descriptions,
  Statistic,
  Row,
  Col
} from 'antd';
import {
  SearchOutlined,
  PlusOutlined,
  EditOutlined,
  EyeOutlined,
  DeleteOutlined,
  ExportOutlined,
  FilterOutlined,
  ReloadOutlined
} from '@ant-design/icons';

const ProductList: React.FC = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [products, setProducts] = useState([]);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 20,
    total: 0
  });
  const [filters, setFilters] = useState({});
  const [selectedRowKeys, setSelectedRowKeys] = useState([]);
  const [detailVisible, setDetailVisible] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState(null);

  // 表格列定义
  const columns = [
    {
      title: '产品图片',
      dataIndex: 'mainImage',
      key: 'mainImage',
      width: 80,
      render: (image: string) => (
        <Image
          width={60}
          height={60}
          src={image}
          fallback="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3Ik1RnG4W+FgYxN"
          style={{ objectFit: 'cover', borderRadius: 4 }}
        />
      )
    },
    {
      title: '产品信息',
      key: 'productInfo',
      width: 300,
      render: (record: any) => (
        <div>
          <div style={{ fontWeight: 'bold', marginBottom: 4 }}>
            {record.productName}
          </div>
          <div style={{ color: '#666', fontSize: 12 }}>
            编码：{record.productCode}
          </div>
          <div style={{ color: '#666', fontSize: 12 }}>
            分类：{record.categoryName}
          </div>
          <Space size={4} style={{ marginTop: 4 }}>
            <Tag color="blue">{record.productType}</Tag>
            {record.isCustomizable && <Tag color="green">可定制</Tag>}
            {record.isCombo && <Tag color="orange">组合产品</Tag>}
          </Space>
        </div>
      )
    },
    {
      title: '价格信息',
      key: 'pricing',
      width: 150,
      render: (record: any) => (
        <div>
          <div style={{ fontWeight: 'bold', color: '#f50' }}>
            ¥{record.basePrice?.toFixed(2)}
          </div>
          <div style={{ color: '#999', fontSize: 12, textDecoration: 'line-through' }}>
            市场价：¥{record.marketPrice?.toFixed(2)}
          </div>
          <div style={{ color: '#666', fontSize: 12 }}>
            单位：{record.priceUnit}
          </div>
        </div>
      )
    },
    {
      title: '库存状态',
      key: 'inventory',
      width: 120,
      render: (record: any) => (
        <div>
          <div>
            <Tag color={
              record.stockStatus === 'normal' ? 'green' :
              record.stockStatus === 'low' ? 'orange' :
              record.stockStatus === 'out_of_stock' ? 'red' : 'blue'
            }>
              {record.stockStatus === 'normal' ? '正常' :
               record.stockStatus === 'low' ? '偏低' :
               record.stockStatus === 'out_of_stock' ? '缺货' : '充足'}
            </Tag>
          </div>
          <div style={{ fontSize: 12, color: '#666' }}>
            库存：{record.availableQuantity}
          </div>
        </div>
      )
    },
    {
      title: '状态',
      dataIndex: 'productStatus',
      key: 'productStatus',
      width: 100,
      render: (status: string) => (
        <Tag color={
          status === 'active' ? 'green' :
          status === 'inactive' ? 'red' :
          status === 'draft' ? 'blue' :
          status === 'pending' ? 'orange' : 'default'
        }>
          {status === 'active' ? '已上架' :
           status === 'inactive' ? '已下架' :
           status === 'draft' ? '草稿' :
           status === 'pending' ? '待审核' : status}
        </Tag>
      )
    },
    {
      title: '统计信息',
      key: 'statistics',
      width: 120,
      render: (record: any) => (
        <div style={{ fontSize: 12 }}>
          <div>浏览：{record.viewCount}</div>
          <div>订购：{record.orderCount}</div>
          <div>评分：{record.ratingAverage?.toFixed(1)} ⭐</div>
        </div>
      )
    },
    {
      title: '操作',
      key: 'actions',
      width: 150,
      fixed: 'right',
      render: (record: any) => (
        <Space size="small">
          <Tooltip title="查看详情">
            <Button
              type="text"
              icon={<EyeOutlined />}
              onClick={() => handleViewDetail(record)}
            />
          </Tooltip>
          <Tooltip title="编辑">
            <Button
              type="text"
              icon={<EditOutlined />}
              onClick={() => handleEdit(record)}
            />
          </Tooltip>
          <Tooltip title="删除">
            <Button
              type="text"
              danger
              icon={<DeleteOutlined />}
              onClick={() => handleDelete(record)}
            />
          </Tooltip>
        </Space>
      )
    }
  ];

  // 搜索表单
  const SearchForm = () => (
    <Card style={{ marginBottom: 16 }}>
      <Form
        form={form}
        layout="inline"
        onFinish={handleSearch}
      >
        <Form.Item name="keyword">
          <Input
            placeholder="搜索产品名称、编码"
            prefix={<SearchOutlined />}
            style={{ width: 200 }}
          />
        </Form.Item>
        <Form.Item name="categoryId">
          <Select
            placeholder="选择分类"
            style={{ width: 150 }}
            allowClear
          >
            <Select.Option value={123}>衣柜</Select.Option>
            <Select.Option value={124}>橱柜</Select.Option>
            <Select.Option value={125}>书柜</Select.Option>
          </Select>
        </Form.Item>
        <Form.Item name="productType">
          <Select
            placeholder="产品类型"
            style={{ width: 120 }}
            allowClear
          >
            <Select.Option value="standard">标准产品</Select.Option>
            <Select.Option value="custom">定制产品</Select.Option>
            <Select.Option value="combo">组合产品</Select.Option>
          </Select>
        </Form.Item>
        <Form.Item name="productStatus">
          <Select
            placeholder="状态"
            style={{ width: 100 }}
            allowClear
          >
            <Select.Option value="active">已上架</Select.Option>
            <Select.Option value="inactive">已下架</Select.Option>
            <Select.Option value="draft">草稿</Select.Option>
            <Select.Option value="pending">待审核</Select.Option>
          </Select>
        </Form.Item>
        <Form.Item>
          <Space>
            <Button type="primary" htmlType="submit" icon={<SearchOutlined />}>
              搜索
            </Button>
            <Button onClick={handleReset} icon={<ReloadOutlined />}>
              重置
            </Button>
          </Space>
        </Form.Item>
      </Form>
    </Card>
  );

  // 操作栏
  const ActionBar = () => (
    <Card style={{ marginBottom: 16 }}>
      <Row justify="space-between" align="middle">
        <Col>
          <Space>
            <Button
              type="primary"
              icon={<PlusOutlined />}
              onClick={handleCreate}
            >
              新建产品
            </Button>
            <Button
              icon={<ExportOutlined />}
              onClick={handleExport}
              disabled={!selectedRowKeys.length}
            >
              批量导出
            </Button>
            <Button
              danger
              icon={<DeleteOutlined />}
              onClick={handleBatchDelete}
              disabled={!selectedRowKeys.length}
            >
              批量删除
            </Button>
          </Space>
        </Col>
        <Col>
          <Space>
            <Statistic
              title="总产品数"
              value={pagination.total}
              style={{ marginRight: 16 }}
            />
            <Button
              icon={<FilterOutlined />}
              onClick={() => setFilters({})}
            >
              高级筛选
            </Button>
          </Space>
        </Col>
      </Row>
    </Card>
  );

  // 事件处理函数
  const handleSearch = (values: any) => {
    setFilters(values);
    setPagination({ ...pagination, current: 1 });
    loadProducts({ ...values, page: 1 });
  };

  const handleReset = () => {
    form.resetFields();
    setFilters({});
    setPagination({ ...pagination, current: 1 });
    loadProducts({ page: 1 });
  };

  const handleViewDetail = (record: any) => {
    setSelectedProduct(record);
    setDetailVisible(true);
  };

  const handleEdit = (record: any) => {
    // 跳转到编辑页面
    window.location.href = `/products/edit/${record.id}`;
  };

  const handleDelete = (record: any) => {
    Modal.confirm({
      title: '确认删除',
      content: `确定要删除产品 "${record.productName}" 吗？`,
      onOk: async () => {
        try {
          // 调用删除API
          message.success('删除成功');
          loadProducts();
        } catch (error) {
          message.error('删除失败');
        }
      }
    });
  };

  const handleCreate = () => {
    window.location.href = '/products/create';
  };

  const loadProducts = async (params = {}) => {
    setLoading(true);
    try {
      // 调用API获取产品列表
      const response = await fetch('/api/products', {
        method: 'GET',
        // 添加查询参数
      });
      const data = await response.json();
      
      setProducts(data.data.list);
      setPagination({
        ...pagination,
        total: data.data.pagination.total
      });
    } catch (error) {
      message.error('加载失败');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadProducts();
  }, []);

  return (
    <div style={{ padding: 24 }}>
      <SearchForm />
      <ActionBar />
      
      <Card>
        <Table
          columns={columns}
          dataSource={products}
          loading={loading}
          pagination={{
            ...pagination,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) =>
              `第 ${range[0]}-${range[1]} 条，共 ${total} 条`
          }}
          rowSelection={{
            selectedRowKeys,
            onChange: setSelectedRowKeys
          }}
          scroll={{ x: 1200 }}
          onChange={(pag, filters, sorter) => {
            setPagination(pag);
            loadProducts({
              page: pag.current,
              pageSize: pag.pageSize,
              ...filters
            });
          }}
        />
      </Card>

      {/* 产品详情抽屉 */}
      <Drawer
        title="产品详情"
        width={800}
        open={detailVisible}
        onClose={() => setDetailVisible(false)}
      >
        {selectedProduct && (
          <ProductDetail product={selectedProduct} />
        )}
      </Drawer>
    </div>
  );
};

export default ProductList;
```

#### 5.1.2 产品详情组件
```typescript
import React from 'react';
import {
  Descriptions,
  Image,
  Tag,
  Space,
  Divider,
  Card,
  Row,
  Col,
  Statistic,
  Table,
  Progress
} from 'antd';

interface ProductDetailProps {
  product: any;
}

const ProductDetail: React.FC<ProductDetailProps> = ({ product }) => {
  // 规格表格列
  const specColumns = [
    {
      title: '规格名称',
      dataIndex: 'specName',
      key: 'specName'
    },
    {
      title: '规格类型',
      dataIndex: 'specType',
      key: 'specType',
      render: (type: string) => (
        <Tag color="blue">{type}</Tag>
      )
    },
    {
      title: '数据类型',
      dataIndex: 'dataType',
      key: 'dataType'
    },
    {
      title: '价格影响',
      dataIndex: 'priceImpact',
      key: 'priceImpact',
      render: (impact: number) => (
        impact > 0 ? `+¥${impact}` : impact < 0 ? `-¥${Math.abs(impact)}` : '无影响'
      )
    },
    {
      title: '是否必填',
      dataIndex: 'isRequired',
      key: 'isRequired',
      render: (required: boolean) => (
        <Tag color={required ? 'red' : 'green'}>
          {required ? '必填' : '可选'}
        </Tag>
      )
    }
  ];

  return (
    <div>
      {/* 基础信息 */}
      <Card title="基础信息" style={{ marginBottom: 16 }}>
        <Row gutter={16}>
          <Col span={8}>
            <Image
              width="100%"
              src={product.mainImage}
              fallback="data:image/png;base64,..."
            />
          </Col>
          <Col span={16}>
            <Descriptions column={2}>
              <Descriptions.Item label="产品名称">
                {product.productName}
              </Descriptions.Item>
              <Descriptions.Item label="产品编码">
                {product.productCode}
              </Descriptions.Item>
              <Descriptions.Item label="产品分类">
                {product.categoryName}
              </Descriptions.Item>
              <Descriptions.Item label="品牌">
                {product.brandName}
              </Descriptions.Item>
              <Descriptions.Item label="产品类型">
                <Tag color="blue">{product.productType}</Tag>
              </Descriptions.Item>
              <Descriptions.Item label="状态">
                <Tag color={product.productStatus === 'active' ? 'green' : 'red'}>
                  {product.productStatus}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="材质">
                {product.material}
              </Descriptions.Item>
              <Descriptions.Item label="风格">
                {product.style}
              </Descriptions.Item>
              <Descriptions.Item label="尺寸范围" span={2}>
                {product.sizeRange}
              </Descriptions.Item>
              <Descriptions.Item label="产品描述" span={2}>
                {product.shortDescription}
              </Descriptions.Item>
            </Descriptions>
          </Col>
        </Row>
      </Card>

      {/* 价格信息 */}
      <Card title="价格信息" style={{ marginBottom: 16 }}>
        <Row gutter={16}>
          <Col span={6}>
            <Statistic
              title="基础价格"
              value={product.basePrice}
              precision={2}
              prefix="¥"
              suffix={`/${product.priceUnit}`}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="市场价格"
              value={product.marketPrice}
              precision={2}
              prefix="¥"
              suffix={`/${product.priceUnit}`}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="成本价格"
              value={product.costPrice}
              precision={2}
              prefix="¥"
              suffix={`/${product.priceUnit}`}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="毛利率"
              value={((product.basePrice - product.costPrice) / product.basePrice * 100)}
              precision={1}
              suffix="%"
            />
          </Col>
        </Row>
      </Card>

      {/* 库存信息 */}
      <Card title="库存信息" style={{ marginBottom: 16 }}>
        <Row gutter={16}>
          <Col span={6}>
            <Statistic
              title="可用库存"
              value={product.availableQuantity}
              suffix={product.stockUnit}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="预留库存"
              value={product.reservedQuantity}
              suffix={product.stockUnit}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="总库存"
              value={product.totalQuantity}
              suffix={product.stockUnit}
            />
          </Col>
          <Col span={6}>
            <div>
              <div style={{ marginBottom: 8 }}>库存状态</div>
              <Tag color={
                product.stockStatus === 'normal' ? 'green' :
                product.stockStatus === 'low' ? 'orange' : 'red'
              }>
                {product.stockStatus === 'normal' ? '正常' :
                 product.stockStatus === 'low' ? '偏低' : '缺货'}
              </Tag>
            </div>
          </Col>
        </Row>
        
        <Divider />
        
        <Row gutter={16}>
          <Col span={8}>
            <div style={{ marginBottom: 8 }}>库存周转率</div>
            <Progress
              percent={product.turnoverRate * 10}
              format={() => `${product.turnoverRate?.toFixed(1)}`}
            />
          </Col>
          <Col span={8}>
            <Statistic
              title="最低库存"
              value={product.minStockLevel}
              suffix={product.stockUnit}
            />
          </Col>
          <Col span={8}>
            <Statistic
              title="补货点"
              value={product.reorderPoint}
              suffix={product.stockUnit}
            />
          </Col>
        </Row>
      </Card>

      {/* 产品规格 */}
      {product.specifications && product.specifications.length > 0 && (
        <Card title="产品规格" style={{ marginBottom: 16 }}>
          <Table
            columns={specColumns}
            dataSource={product.specifications}
            pagination={false}
            size="small"
          />
        </Card>
      )}

      {/* 统计信息 */}
      <Card title="统计信息">
        <Row gutter={16}>
          <Col span={6}>
            <Statistic
              title="浏览次数"
              value={product.viewCount}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="订购次数"
              value={product.orderCount}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="销售金额"
              value={product.salesAmount}
              precision={2}
              prefix="¥"
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="平均评分"
              value={product.ratingAverage}
              precision={1}
              suffix="⭐"
            />
          </Col>
        </Row>
      </Card>
    </div>
  );
};

export default ProductDetail;
```

## 6. 性能优化

### 6.1 数据库优化
- **索引优化**：为常用查询字段创建复合索引
- **分页查询**：使用游标分页提高大数据量查询性能
- **读写分离**：查询操作使用只读副本
- **数据归档**：定期归档历史数据
- **查询优化**：优化复杂查询SQL，避免全表扫描

### 6.2 缓存策略
- **Redis缓存**：缓存热门产品信息、价格信息
- **本地缓存**：缓存产品分类、规格配置等相对静态数据
- **CDN缓存**：产品图片、视频等媒体资源使用CDN
- **查询缓存**：缓存复杂查询结果
- **缓存预热**：系统启动时预加载热门数据

### 6.3 异步处理
- **消息队列**：产品索引更新、价格计算等异步处理
- **批量操作**：批量更新产品信息、价格信息
- **定时任务**：定期同步库存、更新统计数据

## 7. 安全与权限控制

### 7.1 数据权限
- **角色权限**：不同角色查看不同范围的产品数据
- **数据隔离**：按品牌、分类、地区等维度隔离数据
- **敏感信息**：成本价格等敏感信息权限控制

### 7.2 操作权限
- **创建权限**：产品经理、运营人员可创建产品
- **编辑权限**：产品负责人可编辑产品信息
- **审核权限**：高级管理员可审核产品上架
- **价格权限**：财务人员可设置产品价格
- **库存权限**：仓库管理员可管理库存

### 7.3 数据安全
- **数据加密**：敏感数据加密存储
- **访问日志**：记录所有数据访问和修改日志
- **数据备份**：定期备份产品数据
- **权限审计**：定期审计用户权限

## 8. 监控与告警

### 8.1 业务监控
- **产品数量**：监控各状态产品数量变化
- **价格变动**：监控产品价格异常变动
- **库存状态**：监控库存不足、过量等异常
- **查询性能**：监控产品搜索响应时间

### 8.2 系统监控
- **API性能**：监控产品相关API响应时间
- **数据库性能**：监控数据库查询性能
- **缓存命中率**：监控缓存使用效果
- **存储使用**：监控图片、文件存储使用情况

### 8.3 告警规则
- **库存告警**：库存不足、零库存告警
- **价格告警**：价格异常变动告警
- **性能告警**：API响应时间超阈值告警
- **错误告警**：系统错误率超阈值告警
```

#### 3.1.2 获取产品列表
```typescript
GET /api/products?page=1&page_size=20&category_id=123&product_type=custom&status=active&keyword=衣柜&sort_by=created_at&sort_order=desc

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 12345,
        "productCode": "YG001",
        "productName": "现代简约衣柜",
        "shortName": "简约衣柜",
        "categoryName": "衣柜",
        "brandName": "欧派",
        "seriesName": "现代系列",
        "productType": "custom",
        "productStatus": "active",
        "mainImage": "https://example.com/images/yg001_main.jpg",
        "basePrice": 1200.00,
        "marketPrice": 1500.00,
        "stockStatus": "normal",
        "availableQuantity": 50,
        "isCustomizable": true,
        "isSaleable": true,
        "viewCount": 1250,
        "orderCount": 85,
        "ratingAverage": 4.8,
        "createdAt": "2024-01-15T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 156,
      "totalPages": 8
    },
    "filters": {
      "categories": [
        { "id": 123, "name": "衣柜", "count": 45 },
        { "id": 124, "name": "橱柜", "count": 38 }
      ],
      "brands": [
        { "id": 456, "name": "欧派", "count": 32 },
        { "id": 457, "name": "索菲亚", "count": 28 }
      ],
      "priceRanges": [
        { "range": "0-1000", "count": 25 },
        { "range": "1000-2000", "count": 68 }
      ]
    }
  }
}
```

#### 3.1.3 获取产品详情
```typescript
GET /api/products/{id}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 12345,
    "productCode": "YG001",
    "productName": "现代简约衣柜",
    "shortName": "简约衣柜",
    "productNameEn": "Modern Simple Wardrobe",
    "category": {
      "id": 123,
      "name": "衣柜",
      "path": "家具/卧室家具/衣柜"
    },
    "brand": {
      "id": 456,
      "name": "欧派",
      "logo": "https://example.com/brands/oupai.jpg"
    },
    "series": {
      "id": 789,
      "name": "现代系列",
      "description": "简约现代风格系列"
    },
    "productType": "custom",
    "isCustomizable": true,
    "isCombo": false,
    "material": "实木颗粒板",
    "style": "现代简约",
    "color": "白色",
    "sizeRange": "宽度120-300cm，高度200-240cm",
    "weightRange": "80-200kg",
    "shortDescription": "现代简约风格定制衣柜，环保材质",
    "detailedDescription": "采用E0级实木颗粒板制作，配备奥地利百隆五金件...",
    "features": [
      "环保E0级板材",
      "静音导轨",
      "防潮处理",
      "可定制尺寸"
    ],
    "specifications": {
      "material": "实木颗粒板",
      "thickness": "18mm",
      "edge": "PVC封边",
      "hardware": "奥地利百隆",
      "warranty": "5年质保"
    },
    "usageScenarios": [
      "卧室主衣柜",
      "衣帽间",
      "儿童房衣柜"
    ],
    "mainImage": "https://example.com/images/yg001_main.jpg",
    "imageGallery": [
      "https://example.com/images/yg001_1.jpg",
      "https://example.com/images/yg001_2.jpg",
      "https://example.com/images/yg001_3.jpg"
    ],
    "videoUrls": [
      "https://example.com/videos/yg001_intro.mp4"
    ],
    "model3dUrl": "https://example.com/models/yg001.glb",
    "pricing": {
      "basePrice": 1200.00,
      "costPrice": 800.00,
      "marketPrice": 1500.00,
      "minPrice": 1000.00,
      "maxPrice": 2000.00,
      "priceUnit": "平方米",
      "currency": "CNY"
    },
    "inventory": {
      "stockUnit": "套",
      "availableQuantity": 50,
      "reservedQuantity": 5,
      "totalQuantity": 55,
      "stockStatus": "normal",
      "minStockLevel": 10,
      "reorderPoint": 15,
      "leadTime": 15
    },
    "sales": {
      "isSaleable": true,
      "salesStartDate": "2024-01-01",
      "minOrderQuantity": 1,
      "maxOrderQuantity": 10
    },
    "production": {
      "isProducible": true,
      "productionComplexity": "medium",
      "productionTime": 48,
      "qualityLevel": "premium"
    },
    "logistics": {
      "packageLength": 250.0,
      "packageWidth": 60.0,
      "packageHeight": 20.0,
      "packageWeight": 120.0,
      "isFragile": false,
      "specialHandling": []
    },
    "productStatus": "active",
    "version": "1.0",
    "statistics": {
      "viewCount": 1250,
      "orderCount": 85,
      "salesAmount": 102000.00,
      "ratingAverage": 4.8,
      "ratingCount": 42
    },
    "specifications": [
      {
        "id": 1,
        "specName": "宽度",
        "specCode": "width",
        "specType": "size",
        "dataType": "range",
        "minValue": 120.0,
        "maxValue": 300.0,
        "unit": "cm",
        "priceImpact": 50.0,
        "priceType": "formula",
        "priceFormula": "width * 50",
        "isRequired": true,
        "displayName": "衣柜宽度"
      },
      {
        "id": 2,
        "specName": "颜色",
        "specCode": "color",
        "specType": "color",
        "dataType": "select",
        "specOptions": [
          { "value": "white", "label": "白色", "priceImpact": 0 },
          { "value": "black", "label": "黑色", "priceImpact": 100 },
          { "value": "wood", "label": "原木色", "priceImpact": 200 }
        ],
        "isRequired": true,
        "displayName": "柜体颜色"
      }
    ],
    "createdBy": 1001,
    "createdAt": "2024-01-15T10:00:00Z",
    "updatedAt": "2024-01-20T15:30:00Z"
  }
}
```

### 3.2 产品规格管理

#### 3.2.1 添加产品规格
```typescript
POST /api/products/{productId}/specifications
Content-Type: application/json

{
  "specName": "高度",
  "specCode": "height",
  "specType": "size",
  "dataType": "range",
  "minValue": 200.0,
  "maxValue": 240.0,
  "unit": "cm",
  "priceImpact": 30.0,
  "priceType": "formula",
  "priceFormula": "(height - 200) * 30",
  "isRequired": true,
  "isVisible": true,
  "sortOrder": 2,
  "displayName": "衣柜高度",
  "description": "衣柜的总高度，可根据房间层高定制",
  "validationRules": {
    "min": 200,
    "max": 240,
    "step": 10
  }
}

Response:
{
  "code": 200,
  "message": "规格添加成功",
  "data": {
    "id": 567,
    "specName": "高度",
    "specCode": "height",
    "productId": 12345,
    "createdAt": "2024-01-15T10:00:00Z"
  }
}
```

#### 3.2.2 获取产品规格列表
```typescript
GET /api/products/{productId}/specifications

Response:
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "specName": "宽度",
      "specCode": "width",
      "specType": "size",
      "dataType": "range",
      "minValue": 120.0,
      "maxValue": 300.0,
      "unit": "cm",
      "priceImpact": 50.0,
      "priceType": "formula",
      "priceFormula": "width * 50",
      "isRequired": true,
      "isVisible": true,
      "sortOrder": 1,
      "displayName": "衣柜宽度",
      "description": "衣柜的总宽度",
      "status": "active"
    },
    {
      "id": 2,
      "specName": "颜色",
      "specCode": "color",
      "specType": "color",
      "dataType": "select",
      "specOptions": [
        {
          "value": "white",
          "label": "白色",
          "priceImpact": 0,
          "image": "https://example.com/colors/white.jpg"
        },
        {
          "value": "black",
          "label": "黑色",
          "priceImpact": 100,
          "image": "https://example.com/colors/black.jpg"
        }
      ],
      "isRequired": true,
      "isVisible": true,
      "sortOrder": 2,
      "displayName": "柜体颜色",
      "status": "active"
    }
  ]
}
```

### 3.3 产品库存管理

#### 3.3.1 更新库存
```typescript
PUT /api/products/{productId}/inventory
Content-Type: application/json

{
  "warehouseId": 1,
  "operation": "adjust",
  "quantity": 20,
  "reason": "盘点调整",
  "unitCost": 800.00,
  "notes": "年度盘点发现库存差异"
}

Response:
{
  "code": 200,
  "message": "库存更新成功",
  "data": {
    "productId": 12345,
    "warehouseId": 1,
    "availableQuantity": 70,
    "totalQuantity": 75,
    "stockStatus": "normal",
    "updatedAt": "2024-01-15T10:00:00Z"
  }
}
```

#### 3.3.2 获取库存信息
```typescript
GET /api/products/{product_id}/inventory?warehouse_id=1

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "productId": 12345,
    "productName": "现代简约衣柜",
    "productCode": "YG001",
    "warehouses": [
      {
        "warehouseId": 1,
        "warehouseName": "北京仓库",
        "availableQuantity": 70,
        "reservedQuantity": 5,
        "totalQuantity": 75,
        "inTransitQuantity": 10,
        "unitCost": 800.00,
        "totalCost": 60000.00,
        "averageCost": 800.00,
        "stockStatus": "normal",
        "minStockAlert": 10,
        "reorderPoint": 15,
        "lastInDate": "2024-01-10T14:30:00Z",
        "lastOutDate": "2024-01-14T09:15:00Z",
        "turnoverRate": 2.5
      }
    ],
    "totalInventory": {
      "totalAvailable": 70,
      "totalReserved": 5,
      "totalQuantity": 75,
      "totalValue": 60000.00
    }
  }
}
```

## 4. 核心业务逻辑

### 4.1 产品服务 (ProductService)

```typescript
@Injectable()
export class ProductService {
  constructor(
    private productRepository: ProductRepository,
    private categoryRepository: CategoryRepository,
    private specificationRepository: SpecificationRepository,
    private inventoryRepository: InventoryRepository,
    private priceRepository: PriceRepository,
    private cacheService: CacheService,
    private searchService: SearchService
  ) {}

  /**
   * 创建产品
   */
  async createProduct(
    createDto: CreateProductDto,
    userId: number
  ): Promise<Product> {
    // 1. 验证产品编码唯一性
    await this.validateProductCode(createDto.productCode);

    // 2. 验证分类存在性
    const category = await this.categoryRepository.findById(createDto.categoryId);
    if (!category) {
      throw new NotFoundException('产品分类不存在');
    }

    // 3. 生成产品编码（如果未提供）
    if (!createDto.productCode) {
      createDto.productCode = await this.generateProductCode(createDto.categoryId);
    }

    // 4. 创建产品
    const product = await this.productRepository.create({
      ...createDto,
      categoryPath: category.path,
      productStatus: 'draft',
      version: '1.0',
      createdBy: userId
    });

    // 5. 创建默认规格（如果是可定制产品）
    if (createDto.isCustomizable) {
      await this.createDefaultSpecifications(product.id, createDto.categoryId);
    }

    // 6. 创建默认价格
    await this.createDefaultPricing(product.id, createDto);

    // 7. 初始化库存
    if (createDto.initialInventory) {
      await this.initializeInventory(product.id, createDto.initialInventory);
    }

    // 8. 更新搜索索引
    await this.searchService.indexProduct(product);

    return product;
  }

  /**
   * 更新产品信息
   */
  async updateProduct(
    productId: number,
    updateDto: UpdateProductDto,
    userId: number
  ): Promise<Product> {
    const product = await this.productRepository.findById(productId);
    if (!product) {
      throw new NotFoundException('产品不存在');
    }

    // 1. 检查是否可以修改
    if (product.productStatus === 'active' && updateDto.productStatus !== 'active') {
      await this.validateProductStatusChange(product, updateDto.productStatus);
    }

    // 2. 处理版本控制
    let newVersion = product.version;
    if (this.isSignificantChange(product, updateDto)) {
      newVersion = this.incrementVersion(product.version);
      await this.createProductVersion(product);
    }

    // 3. 更新产品信息
    const updatedProduct = await this.productRepository.update(productId, {
      ...updateDto,
      version: newVersion,
      updatedBy: userId
    });

    // 4. 更新相关数据
    if (updateDto.specifications) {
      await this.updateProductSpecifications(productId, updateDto.specifications);
    }

    if (updateDto.pricing) {
      await this.updateProductPricing(productId, updateDto.pricing);
    }

    // 5. 清除缓存
    await this.clearProductCache(productId);

    // 6. 更新搜索索引
    await this.searchService.updateProductIndex(updatedProduct);

    return updatedProduct;
  }

  /**
   * 产品搜索
   */
  async searchProducts(
    searchDto: ProductSearchDto
  ): Promise<ProductSearchResult> {
    // 1. 构建搜索条件
    const searchConditions = this.buildSearchConditions(searchDto);

    // 2. 执行搜索
    let searchResult;
    if (searchDto.keyword) {
      // 全文搜索
      searchResult = await this.searchService.searchProducts(
        searchDto.keyword,
        searchConditions,
        searchDto.pagination
      );
    } else {
      // 条件查询
      searchResult = await this.productRepository.findByConditions(
        searchConditions,
        searchDto.pagination
      );
    }

    // 3. 获取聚合数据（筛选项）
    const aggregations = await this.getSearchAggregations(searchConditions);

    // 4. 处理搜索结果
    const products = await this.enrichProductList(searchResult.items);

    return {
      items: products,
      pagination: searchResult.pagination,
      aggregations,
      searchTime: searchResult.searchTime
    };
  }

  /**
   * 计算产品价格
   */
  async calculateProductPrice(
    productId: number,
    specifications: ProductSpecification[],
    quantity: number = 1,
    customerLevel?: string
  ): Promise<ProductPriceCalculation> {
    const product = await this.getProductWithSpecs(productId);
    if (!product) {
      throw new NotFoundException('产品不存在');
    }

    // 1. 获取基础价格
    const basePrice = await this.getProductBasePrice(
      productId,
      quantity,
      customerLevel
    );

    // 2. 计算规格价格影响
    const specPriceImpact = await this.calculateSpecificationPriceImpact(
      product.specifications,
      specifications
    );

    // 3. 计算数量折扣
    const quantityDiscount = await this.calculateQuantityDiscount(
      productId,
      quantity
    );

    // 4. 计算最终价格
    const unitPrice = basePrice + specPriceImpact.totalImpact;
    const subtotal = unitPrice * quantity;
    const discountAmount = subtotal * quantityDiscount.rate;
    const totalPrice = subtotal - discountAmount;

    return {
      productId,
      basePrice,
      specificationImpact: specPriceImpact,
      quantityDiscount,
      unitPrice,
      quantity,
      subtotal,
      discountAmount,
      totalPrice,
      currency: 'CNY',
      calculatedAt: new Date()
    };
  }

  /**
   * 验证产品配置
   */
  async validateProductConfiguration(
    productId: number,
    specifications: ProductSpecification[]
  ): Promise<ProductConfigurationValidation> {
    const product = await this.getProductWithSpecs(productId);
    if (!product) {
      throw new NotFoundException('产品不存在');
    }

    const validationResult: ProductConfigurationValidation = {
      isValid: true,
      errors: [],
      warnings: [],
      suggestions: []
    };

    // 1. 验证必填规格
    for (const spec of product.specifications) {
      if (spec.isRequired) {
        const providedSpec = specifications.find(s => s.specCode === spec.specCode);
        if (!providedSpec) {
          validationResult.isValid = false;
          validationResult.errors.push({
            specCode: spec.specCode,
            message: `${spec.displayName}是必填项`
          });
        }
      }
    }

    // 2. 验证规格值
    for (const providedSpec of specifications) {
      const specDef = product.specifications.find(s => s.specCode === providedSpec.specCode);
      if (specDef) {
        const specValidation = await this.validateSpecificationValue(
          specDef,
          providedSpec.value
        );
        if (!specValidation.isValid) {
          validationResult.isValid = false;
          validationResult.errors.push(...specValidation.errors);
        }
        validationResult.warnings.push(...specValidation.warnings);
      }
    }

    // 3. 验证规格组合
    const combinationValidation = await this.validateSpecificationCombination(
      product.id,
      specifications
    );
    if (!combinationValidation.isValid) {
      validationResult.isValid = false;
      validationResult.errors.push(...combinationValidation.errors);
    }

    // 4. 生成优化建议
    validationResult.suggestions = await this.generateConfigurationSuggestions(
      product,
      specifications
    );

    return validationResult;
  }

  /**
   * 生成产品编码
   */
  private async generateProductCode(categoryId: number): Promise<string> {
    const category = await this.categoryRepository.findById(categoryId);
    const categoryCode = category.categoryCode;
    
    // 获取该分类下的产品数量
    const count = await this.productRepository.countByCategory(categoryId);
    const sequence = (count + 1).toString().padStart(3, '0');
    
    return `${categoryCode}${sequence}`;
  }

  /**
   * 创建默认规格
   */
  private async createDefaultSpecifications(
    productId: number,
    categoryId: number
  ): Promise<void> {
    const category = await this.categoryRepository.findById(categoryId);
    const defaultSpecs = category.attributes?.defaultSpecifications || [];

    for (const spec of defaultSpecs) {
      await this.specificationRepository.create({
        productId,
        ...spec
      });
    }
  }

  /**
   * 计算规格价格影响
   */
  private async calculateSpecificationPriceImpact(
    specDefinitions: ProductSpecification[],
    providedSpecs: ProductSpecification[]
  ): Promise<SpecificationPriceImpact> {
    const impacts = [];
    let totalImpact = 0;

    for (const providedSpec of providedSpecs) {
      const specDef = specDefinitions.find(s => s.specCode === providedSpec.specCode);
      if (specDef && specDef.priceImpact) {
        let impact = 0;

        switch (specDef.priceType) {
          case 'fixed':
            impact = specDef.priceImpact;
            break;
          case 'percentage':
            // 需要基础价格来计算百分比
            impact = 0; // 在上层计算
            break;
          case 'formula':
            impact = this.evaluatePriceFormula(
              specDef.priceFormula,
              providedSpec.value
            );
            break;
        }

        impacts.push({
          specCode: specDef.specCode,
          specName: specDef.specName,
          value: providedSpec.value,
          impact,
          priceType: specDef.priceType
        });

        totalImpact += impact;
      }
    }

    return {
      impacts,
      totalImpact
    };
  }

  /**
   * 评估价格公式
   */
  private evaluatePriceFormula(formula: string, value: any): number {
    try {
      // 简单的公式评估，实际应该使用更安全的表达式解析器
      const expression = formula.replace(/\b\w+\b/g, (match) => {
        return match === 'value' ? value : match;
      });
      
      // 这里应该使用安全的表达式评估器
      return eval(expression) || 0;
    } catch (error) {
      console.error('价格公式评估失败:', error);
      return 0;
    }
  }
}
```
