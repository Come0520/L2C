# 库存管理模块设计

## 1. 模块概述

### 1.1 功能目标
库存管理模块是L2C销售管理系统的核心模块之一，负责管理产品库存的全生命周期，确保库存数据的准确性和实时性，支持多仓库、多品类的库存管理需求。

### 1.2 核心功能
- **库存实时监控**：实时跟踪各仓库、各产品的库存数量
- **库存预警机制**：低库存、超库存、滞销库存预警
- **库存调拨管理**：支持仓库间库存调拨和转移
- **库存盘点管理**：定期盘点和差异处理
- **库存预留机制**：订单下单时预留库存，避免超卖
- **库存成本管理**：支持FIFO、LIFO、加权平均等成本核算方法
- **库存报表分析**：库存周转率、库存价值、滞销分析等

### 1.3 业务价值
- 防止超卖和缺货，提升客户满意度
- 优化库存结构，降低库存成本
- 提高库存周转率，减少资金占用
- 支持多仓库运营，提升配送效率

## 2. 业务流程设计

### 2.1 库存入库流程
```
采购到货 → 质检验收 → 入库登记 → 库存更新 → 成本核算 → 入库完成
```

### 2.2 库存出库流程
```
订单确认 → 库存检查 → 库存预留 → 拣货出库 → 库存扣减 → 成本结转 → 出库完成
```

### 2.3 库存调拨流程
```
调拨申请 → 审批确认 → 出库准备 → 在途管理 → 入库确认 → 库存更新 → 调拨完成
```

### 2.4 库存盘点流程
```
盘点计划 → 冻结库存 → 实地盘点 → 差异分析 → 差异处理 → 库存调整 → 盘点完成
```

## 3. 数据库设计

### 3.1 仓库信息表 (warehouses)
```sql
CREATE TABLE warehouses (
    id BIGSERIAL PRIMARY KEY,
    warehouse_code VARCHAR(20) NOT NULL UNIQUE COMMENT '仓库编码',
    warehouse_name VARCHAR(100) NOT NULL COMMENT '仓库名称',
    warehouse_type VARCHAR(20) NOT NULL COMMENT '仓库类型：main-主仓,branch-分仓,virtual-虚拟仓',
    address TEXT COMMENT '仓库地址',
    contact_person VARCHAR(50) COMMENT '联系人',
    contact_phone VARCHAR(15) COMMENT '联系电话',
    manager_id BIGINT COMMENT '仓库管理员ID',
    capacity DECIMAL(10,2) COMMENT '仓库容量(平方米)',
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态：active-启用,inactive-停用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (manager_id) REFERENCES users(id),
    INDEX idx_warehouse_code (warehouse_code),
    INDEX idx_warehouse_type (warehouse_type),
    INDEX idx_status (status)
);
```

### 3.2 库存主表 (inventory)
```sql
CREATE TABLE inventory (
    id BIGSERIAL PRIMARY KEY,
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    product_id BIGINT NOT NULL COMMENT '产品ID',
    sku_code VARCHAR(50) NOT NULL COMMENT 'SKU编码',
    available_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '可用库存数量',
    reserved_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '预留库存数量',
    total_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '总库存数量',
    unit_cost DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT '单位成本',
    total_cost DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '总成本',
    safety_stock DECIMAL(10,2) DEFAULT 0 COMMENT '安全库存',
    max_stock DECIMAL(10,2) DEFAULT 0 COMMENT '最大库存',
    min_stock DECIMAL(10,2) DEFAULT 0 COMMENT '最小库存',
    last_in_date TIMESTAMP COMMENT '最后入库时间',
    last_out_date TIMESTAMP COMMENT '最后出库时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    UNIQUE KEY uk_warehouse_product (warehouse_id, product_id, sku_code),
    INDEX idx_sku_code (sku_code),
    INDEX idx_available_quantity (available_quantity),
    INDEX idx_last_in_date (last_in_date),
    INDEX idx_last_out_date (last_out_date),
    
    -- 添加业务逻辑验证约束
    CONSTRAINT chk_inventory_quantities_non_negative CHECK (
        available_quantity >= 0 AND 
        reserved_quantity >= 0 AND 
        total_quantity >= 0
    ),
    CONSTRAINT chk_inventory_total_quantity_logic CHECK (
        total_quantity = available_quantity + reserved_quantity
    ),
    CONSTRAINT chk_inventory_stock_levels CHECK (
        (safety_stock IS NULL OR safety_stock >= 0) AND
        (min_stock IS NULL OR min_stock >= 0) AND
        (max_stock IS NULL OR max_stock >= 0) AND
        (min_stock IS NULL OR max_stock IS NULL OR max_stock >= min_stock)
    ),
    CONSTRAINT chk_inventory_costs_non_negative CHECK (
        unit_cost >= 0 AND total_cost >= 0
    )
);
```

### 3.3 库存变动记录表 (inventory_transactions)
```sql
CREATE TABLE inventory_transactions (
    id BIGSERIAL PRIMARY KEY,
    transaction_no VARCHAR(30) NOT NULL UNIQUE COMMENT '变动单号',
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    product_id BIGINT NOT NULL COMMENT '产品ID',
    sku_code VARCHAR(50) NOT NULL COMMENT 'SKU编码',
    transaction_type VARCHAR(20) NOT NULL COMMENT '变动类型：in-入库,out-出库,transfer-调拨,adjust-调整',
    business_type VARCHAR(30) NOT NULL COMMENT '业务类型：purchase-采购,sale-销售,return-退货,transfer-调拨,adjust-盘点调整',
    reference_id BIGINT COMMENT '关联业务ID',
    reference_no VARCHAR(50) COMMENT '关联业务单号',
    quantity_before DECIMAL(10,2) NOT NULL COMMENT '变动前数量',
    quantity_change DECIMAL(10,2) NOT NULL COMMENT '变动数量(正数为增加,负数为减少)',
    quantity_after DECIMAL(10,2) NOT NULL COMMENT '变动后数量',
    unit_cost DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT '单位成本',
    total_cost DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '总成本',
    operator_id BIGINT NOT NULL COMMENT '操作人ID',
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (operator_id) REFERENCES users(id),
    INDEX idx_transaction_no (transaction_no),
    INDEX idx_warehouse_product (warehouse_id, product_id),
    INDEX idx_transaction_type (transaction_type),
    INDEX idx_business_type (business_type),
    INDEX idx_reference (reference_id, reference_no),
    INDEX idx_operation_time (operation_time)
);
```

### 3.4 库存预留记录表 (inventory_reservations)
```sql
CREATE TABLE inventory_reservations (
    id BIGSERIAL PRIMARY KEY,
    reservation_no VARCHAR(30) NOT NULL UNIQUE COMMENT '预留单号',
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    product_id BIGINT NOT NULL COMMENT '产品ID',
    sku_code VARCHAR(50) NOT NULL COMMENT 'SKU编码',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    order_item_id BIGINT COMMENT '订单明细ID',
    reserved_quantity DECIMAL(10,2) NOT NULL COMMENT '预留数量',
    used_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '已使用数量',
    remaining_quantity DECIMAL(10,2) NOT NULL COMMENT '剩余数量',
    reservation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '预留时间',
    expire_time TIMESTAMP COMMENT '过期时间',
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态：active-有效,used-已使用,expired-已过期,cancelled-已取消',
    operator_id BIGINT NOT NULL COMMENT '操作人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (operator_id) REFERENCES users(id),
    INDEX idx_reservation_no (reservation_no),
    INDEX idx_warehouse_product (warehouse_id, product_id),
    INDEX idx_order (order_id, order_item_id),
    INDEX idx_status (status),
    INDEX idx_expire_time (expire_time)
);
```

### 3.5 库存调拨单表 (inventory_transfers)
```sql
CREATE TABLE inventory_transfers (
    id BIGSERIAL PRIMARY KEY,
    transfer_no VARCHAR(30) NOT NULL UNIQUE COMMENT '调拨单号',
    from_warehouse_id BIGINT NOT NULL COMMENT '调出仓库ID',
    to_warehouse_id BIGINT NOT NULL COMMENT '调入仓库ID',
    transfer_type VARCHAR(20) NOT NULL COMMENT '调拨类型：normal-正常调拨,emergency-紧急调拨',
    total_items INT NOT NULL DEFAULT 0 COMMENT '调拨商品种类数',
    total_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '调拨总数量',
    total_cost DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '调拨总成本',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '状态：pending-待审批,approved-已审批,shipped-已发货,received-已收货,completed-已完成,cancelled-已取消',
    applicant_id BIGINT NOT NULL COMMENT '申请人ID',
    approver_id BIGINT COMMENT '审批人ID',
    shipper_id BIGINT COMMENT '发货人ID',
    receiver_id BIGINT COMMENT '收货人ID',
    apply_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    approve_time TIMESTAMP COMMENT '审批时间',
    ship_time TIMESTAMP COMMENT '发货时间',
    receive_time TIMESTAMP COMMENT '收货时间',
    complete_time TIMESTAMP COMMENT '完成时间',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (from_warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (to_warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (applicant_id) REFERENCES users(id),
    FOREIGN KEY (approver_id) REFERENCES users(id),
    FOREIGN KEY (shipper_id) REFERENCES users(id),
    FOREIGN KEY (receiver_id) REFERENCES users(id),
    INDEX idx_transfer_no (transfer_no),
    INDEX idx_from_warehouse (from_warehouse_id),
    INDEX idx_to_warehouse (to_warehouse_id),
    INDEX idx_status (status),
    INDEX idx_apply_time (apply_time)
);
```

### 3.6 库存调拨明细表 (inventory_transfer_items)
```sql
CREATE TABLE inventory_transfer_items (
    id BIGSERIAL PRIMARY KEY,
    transfer_id BIGINT NOT NULL COMMENT '调拨单ID',
    product_id BIGINT NOT NULL COMMENT '产品ID',
    sku_code VARCHAR(50) NOT NULL COMMENT 'SKU编码',
    transfer_quantity DECIMAL(10,2) NOT NULL COMMENT '调拨数量',
    unit_cost DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT '单位成本',
    total_cost DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '总成本',
    shipped_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '已发货数量',
    received_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '已收货数量',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (transfer_id) REFERENCES inventory_transfers(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    INDEX idx_transfer_id (transfer_id),
    INDEX idx_product_id (product_id),
    INDEX idx_sku_code (sku_code)
);
```

### 3.7 库存盘点单表 (inventory_stocktakes)
```sql
CREATE TABLE inventory_stocktakes (
    id BIGSERIAL PRIMARY KEY,
    stocktake_no VARCHAR(30) NOT NULL UNIQUE COMMENT '盘点单号',
    warehouse_id BIGINT NOT NULL COMMENT '仓库ID',
    stocktake_type VARCHAR(20) NOT NULL COMMENT '盘点类型：full-全盘,partial-抽盘,cycle-循环盘点',
    total_items INT NOT NULL DEFAULT 0 COMMENT '盘点商品种类数',
    total_book_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '账面总数量',
    total_actual_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '实盘总数量',
    total_diff_quantity DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '差异总数量',
    total_diff_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '差异总金额',
    status VARCHAR(20) DEFAULT 'planning' COMMENT '状态：planning-计划中,counting-盘点中,completed-已完成,cancelled-已取消',
    plan_start_time TIMESTAMP COMMENT '计划开始时间',
    plan_end_time TIMESTAMP COMMENT '计划结束时间',
    actual_start_time TIMESTAMP COMMENT '实际开始时间',
    actual_end_time TIMESTAMP COMMENT '实际结束时间',
    creator_id BIGINT NOT NULL COMMENT '创建人ID',
    supervisor_id BIGINT COMMENT '盘点主管ID',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (creator_id) REFERENCES users(id),
    FOREIGN KEY (supervisor_id) REFERENCES users(id),
    INDEX idx_stocktake_no (stocktake_no),
    INDEX idx_warehouse_id (warehouse_id),
    INDEX idx_stocktake_type (stocktake_type),
    INDEX idx_status (status),
    INDEX idx_plan_start_time (plan_start_time)
);
```

## 4. API接口设计

### 4.1 库存查询接口
```http
GET /api/v1/inventory
GET /api/v1/inventory/{warehouse_id}/products/{product_id}
GET /api/v1/inventory/low_stock
GET /api/v1/inventory/search?sku={sku}&warehouse={warehouse}
```

### 4.2 库存操作接口
```http
POST /api/v1/inventory/reserve          # 库存预留
POST /api/v1/inventory/release          # 释放预留
POST /api/v1/inventory/adjust           # 库存调整
POST /api/v1/inventory/transfer         # 库存调拨
```

### 4.3 库存报表接口
```http
GET /api/v1/inventory/reports/summary   # 库存汇总报表
GET /api/v1/inventory/reports/turnover  # 库存周转报表
GET /api/v1/inventory/reports/aging     # 库存账龄报表
GET /api/v1/inventory/reports/valuation # 库存估值报表
```

## 5. 业务规则

### 5.1 库存预留规则
- 订单确认时自动预留库存
- 预留库存有效期为24小时，超时自动释放
- 支付完成后将预留库存转为实际扣减
- 订单取消时自动释放预留库存

### 5.2 库存预警规则
- 可用库存 ≤ 安全库存时触发低库存预警
- 总库存 ≥ 最大库存时触发超库存预警
- 库存为0时触发缺货预警
- 90天无出库记录触发滞销预警

### 5.3 成本核算规则
- 支持FIFO（先进先出）、LIFO（后进先出）、加权平均三种成本核算方法
- 默认使用加权平均法
- 成本核算方法一旦设定，不可随意更改

## 6. 集成设计

### 6.1 与订单管理集成
- 订单确认时检查库存可用性
- 订单支付后扣减库存
- 订单取消时释放预留库存
- 退货时增加库存

### 6.2 与采购管理集成
- 采购入库时增加库存
- 采购退货时减少库存
- 自动触发采购建议

### 6.3 与财务管理集成
- 库存变动时同步成本数据
- 提供库存估值数据
- 支持库存成本结转

## 7. 性能优化

### 7.1 缓存策略
- 热门商品库存信息缓存到Redis
- 库存预警信息缓存
- 库存统计数据缓存

### 7.2 数据库优化
- 库存主表按仓库分区
- 库存变动记录表按时间分区
- 定期归档历史数据

### 7.3 并发控制
- 库存扣减使用乐观锁机制
- 关键操作使用分布式锁
- 支持库存操作的幂等性

## 8. 监控告警

### 8.1 业务监控
- 库存准确率监控
- 库存周转率监控
- 缺货率监控
- 超卖事件监控

### 8.2 系统监控
- 库存操作响应时间
- 库存查询QPS
- 数据库连接池状态
- 缓存命中率

## 9. 安全设计

### 9.1 权限控制
- 基于角色的库存操作权限
- 仓库级别的数据权限
- 敏感操作的审批流程

### 9.2 数据安全
- 库存变动的完整审计日志
- 关键操作的数字签名
- 数据传输加密

## 10. 扩展性设计

### 10.1 多仓库支持
- 支持无限扩展仓库数量
- 支持仓库层级管理
- 支持虚拟仓库概念

### 10.2 多品类支持
- 支持不同品类的库存管理策略
- 支持批次管理
- 支持序列号管理

---

**文档版本：** v1.0  
**创建日期：** 2025年1月21日  
**维护人员：** 系统架构师  
**审核状态：** 待审核
