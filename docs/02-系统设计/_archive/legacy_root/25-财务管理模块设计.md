# 财务管理模块设计

## 1. 模块概述

### 1.1 功能目标
财务管理模块是L2C销售管理系统的核心模块之一，负责管理销售过程中的所有财务数据，包括收款、付款、对账、成本核算、财务报表等，确保财务数据的准确性和合规性。

### 1.2 核心功能
- **收款管理**：订单收款、分期收款、预收款管理
- **付款管理**：供应商付款、费用支付、退款处理
- **对账管理**：银行对账、第三方支付对账、内部对账
- **成本核算**：销售成本、服务成本、运营成本核算
- **财务报表**：收入报表、成本报表、利润报表、现金流报表
- **发票管理**：发票开具、发票验证、税务管理
- **资金管理**：资金流水、资金预测、资金调度

### 1.3 业务价值
- 确保财务数据准确性和实时性
- 提高财务处理效率，降低人工成本
- 支持财务合规和税务管理
- 提供决策支持的财务分析数据

## 2. 业务流程设计

### 2.1 收款流程
```
订单确认 → 收款通知 → 客户付款 → 支付确认 → 收款入账 → 财务核销 → 收款完成
```

### 2.2 退款流程
```
退款申请 → 财务审核 → 退款审批 → 退款执行 → 退款确认 → 账务处理 → 退款完成
```

### 2.3 对账流程
```
数据获取 → 自动匹配 → 差异识别 → 人工核实 → 差异处理 → 对账确认 → 对账完成
```

### 2.4 成本核算流程
```
成本数据收集 → 成本分摊 → 成本核算 → 成本分析 → 成本报告 → 成本优化
```

## 3. 数据库设计

### 3.1 财务账户表 (financial_accounts)
```sql
CREATE TABLE financial_accounts (
    id BIGSERIAL PRIMARY KEY,
    account_code VARCHAR(20) NOT NULL UNIQUE COMMENT '账户编码',
    account_name VARCHAR(100) NOT NULL COMMENT '账户名称',
    account_type VARCHAR(20) NOT NULL COMMENT '账户类型：bank-银行账户,alipay-支付宝,wechat-微信,cash-现金',
    bank_name VARCHAR(100) COMMENT '银行名称',
    account_number VARCHAR(50) COMMENT '账户号码',
    account_holder VARCHAR(100) COMMENT '账户持有人',
    balance DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '账户余额',
    frozen_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '冻结金额',
    available_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '可用金额',
    currency VARCHAR(10) DEFAULT 'CNY' COMMENT '币种',
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态：active-启用,inactive-停用,frozen-冻结',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_account_code (account_code),
    INDEX idx_account_type (account_type),
    INDEX idx_status (status)
);
```

### 3.2 收款记录表 (payment_receipts)
```sql
CREATE TABLE payment_receipts (
    id BIGSERIAL PRIMARY KEY,
    receipt_no VARCHAR(30) NOT NULL UNIQUE COMMENT '收款单号',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    customer_id BIGINT NOT NULL COMMENT '客户ID',
    payment_method VARCHAR(20) NOT NULL COMMENT '支付方式：alipay-支付宝,wechat-微信,bank-银行转账,cash-现金',
    payment_channel VARCHAR(50) COMMENT '支付渠道',
    transaction_id VARCHAR(100) COMMENT '第三方交易号',
    receipt_amount DECIMAL(10,2) NOT NULL COMMENT '收款金额',
    actual_amount DECIMAL(10,2) NOT NULL COMMENT '实收金额',
    fee_amount DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '手续费',
    account_id BIGINT NOT NULL COMMENT '收款账户ID',
    payment_time TIMESTAMP COMMENT '支付时间',
    confirm_time TIMESTAMP COMMENT '确认时间',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '状态：pending-待确认,confirmed-已确认,failed-失败,cancelled-已取消',
    payment_proof TEXT COMMENT '支付凭证',
    remark TEXT COMMENT '备注',
    operator_id BIGINT COMMENT '操作人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (account_id) REFERENCES financial_accounts(id),
    FOREIGN KEY (operator_id) REFERENCES users(id),
    INDEX idx_receipt_no (receipt_no),
    INDEX idx_order_id (order_id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_payment_method (payment_method),
    INDEX idx_transaction_id (transaction_id),
    INDEX idx_payment_time (payment_time),
    INDEX idx_status (status)
);
```

### 3.3 退款记录表 (payment_refunds)
```sql
CREATE TABLE payment_refunds (
    id BIGSERIAL PRIMARY KEY,
    refund_no VARCHAR(30) NOT NULL UNIQUE COMMENT '退款单号',
    receipt_id BIGINT COMMENT '原收款记录ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    customer_id BIGINT NOT NULL COMMENT '客户ID',
    refund_type VARCHAR(20) NOT NULL COMMENT '退款类型：full-全额退款,partial-部分退款',
    refund_reason VARCHAR(100) COMMENT '退款原因',
    refund_amount DECIMAL(10,2) NOT NULL COMMENT '退款金额',
    fee_amount DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '退款手续费',
    actual_refund_amount DECIMAL(10,2) NOT NULL COMMENT '实际退款金额',
    refund_method VARCHAR(20) NOT NULL COMMENT '退款方式：original-原路退回,bank-银行转账,cash-现金',
    account_id BIGINT NOT NULL COMMENT '退款账户ID',
    refund_account VARCHAR(100) COMMENT '退款账户信息',
    apply_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    approve_time TIMESTAMP COMMENT '审批时间',
    refund_time TIMESTAMP COMMENT '退款时间',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '状态：pending-待审批,approved-已审批,processing-处理中,completed-已完成,failed-失败,cancelled-已取消',
    applicant_id BIGINT NOT NULL COMMENT '申请人ID',
    approver_id BIGINT COMMENT '审批人ID',
    processor_id BIGINT COMMENT '处理人ID',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (receipt_id) REFERENCES payment_receipts(id),
    FOREIGN KEY (order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (account_id) REFERENCES financial_accounts(id),
    FOREIGN KEY (applicant_id) REFERENCES users(id),
    FOREIGN KEY (approver_id) REFERENCES users(id),
    FOREIGN KEY (processor_id) REFERENCES users(id),
    INDEX idx_refund_no (refund_no),
    INDEX idx_receipt_id (receipt_id),
    INDEX idx_order_id (order_id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_refund_type (refund_type),
    INDEX idx_apply_time (apply_time),
    INDEX idx_status (status)
);
```

### 3.4 财务流水表 (financial_transactions)
```sql
CREATE TABLE financial_transactions (
    id BIGSERIAL PRIMARY KEY,
    transaction_no VARCHAR(30) NOT NULL UNIQUE COMMENT '流水号',
    account_id BIGINT NOT NULL COMMENT '账户ID',
    transaction_type VARCHAR(20) NOT NULL COMMENT '交易类型：income-收入,expense-支出,transfer-转账',
    business_type VARCHAR(30) NOT NULL COMMENT '业务类型：sale-销售,refund-退款,fee-手续费,cost-成本',
    reference_id BIGINT COMMENT '关联业务ID',
    reference_no VARCHAR(50) COMMENT '关联业务单号',
    amount DECIMAL(15,2) NOT NULL COMMENT '交易金额',
    balance_before DECIMAL(15,2) NOT NULL COMMENT '交易前余额',
    balance_after DECIMAL(15,2) NOT NULL COMMENT '交易后余额',
    currency VARCHAR(10) DEFAULT 'CNY' COMMENT '币种',
    exchange_rate DECIMAL(10,6) DEFAULT 1 COMMENT '汇率',
    transaction_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '交易时间',
    counterpart VARCHAR(100) COMMENT '交易对方',
    description TEXT COMMENT '交易描述',
    operator_id BIGINT COMMENT '操作人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (account_id) REFERENCES financial_accounts(id),
    FOREIGN KEY (operator_id) REFERENCES users(id),
    INDEX idx_transaction_no (transaction_no),
    INDEX idx_account_id (account_id),
    INDEX idx_transaction_type (transaction_type),
    INDEX idx_business_type (business_type),
    INDEX idx_reference (reference_id, reference_no),
    INDEX idx_transaction_time (transaction_time)
);
```

### 3.5 对账记录表 (reconciliation_records)
```sql
CREATE TABLE reconciliation_records (
    id BIGSERIAL PRIMARY KEY,
    reconciliation_no VARCHAR(30) NOT NULL UNIQUE COMMENT '对账单号',
    account_id BIGINT NOT NULL COMMENT '账户ID',
    reconciliation_type VARCHAR(20) NOT NULL COMMENT '对账类型：bank-银行对账,alipay-支付宝对账,wechat-微信对账',
    reconciliation_date DATE NOT NULL COMMENT '对账日期',
    start_time TIMESTAMP NOT NULL COMMENT '对账开始时间',
    end_time TIMESTAMP NOT NULL COMMENT '对账结束时间',
    system_count INT NOT NULL DEFAULT 0 COMMENT '系统记录数',
    system_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '系统金额',
    external_count INT NOT NULL DEFAULT 0 COMMENT '外部记录数',
    external_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '外部金额',
    matched_count INT NOT NULL DEFAULT 0 COMMENT '匹配记录数',
    matched_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '匹配金额',
    unmatched_count INT NOT NULL DEFAULT 0 COMMENT '未匹配记录数',
    unmatched_amount DECIMAL(15,2) NOT NULL DEFAULT 0 COMMENT '未匹配金额',
    status VARCHAR(20) DEFAULT 'processing' COMMENT '状态：processing-处理中,completed-已完成,failed-失败',
    operator_id BIGINT NOT NULL COMMENT '操作人ID',
    complete_time TIMESTAMP COMMENT '完成时间',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (account_id) REFERENCES financial_accounts(id),
    FOREIGN KEY (operator_id) REFERENCES users(id),
    INDEX idx_reconciliation_no (reconciliation_no),
    INDEX idx_account_id (account_id),
    INDEX idx_reconciliation_type (reconciliation_type),
    INDEX idx_reconciliation_date (reconciliation_date),
    INDEX idx_status (status)
);
```

### 3.6 发票管理表 (invoices)
```sql
CREATE TABLE invoices (
    id BIGSERIAL PRIMARY KEY,
    invoice_no VARCHAR(30) NOT NULL UNIQUE COMMENT '发票号码',
    invoice_code VARCHAR(20) COMMENT '发票代码',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    customer_id BIGINT NOT NULL COMMENT '客户ID',
    invoice_type VARCHAR(20) NOT NULL COMMENT '发票类型：ordinary-普通发票,special-专用发票,electronic-电子发票',
    invoice_title VARCHAR(200) NOT NULL COMMENT '发票抬头',
    tax_number VARCHAR(30) COMMENT '纳税人识别号',
    invoice_amount DECIMAL(10,2) NOT NULL COMMENT '发票金额',
tax_amount DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '税额',
total_amount DECIMAL(10,2) NOT NULL COMMENT '价税合计',
    tax_rate DECIMAL(5,4) NOT NULL DEFAULT 0 COMMENT '税率',
    invoice_date DATE COMMENT '开票日期',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '状态：pending-待开票,issued-已开票,cancelled-已作废,red-已红冲',
    invoice_file_url VARCHAR(500) COMMENT '发票文件URL',
    applicant_id BIGINT NOT NULL COMMENT '申请人ID',
    issuer_id BIGINT COMMENT '开票人ID',
    apply_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    issue_time TIMESTAMP COMMENT '开票时间',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (applicant_id) REFERENCES users(id),
    FOREIGN KEY (issuer_id) REFERENCES users(id),
    INDEX idx_invoice_no (invoice_no),
    INDEX idx_invoice_code (invoice_code),
    INDEX idx_order_id (order_id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_invoice_type (invoice_type),
    INDEX idx_invoice_date (invoice_date),
    INDEX idx_status (status)
);
```

### 3.7 成本核算表 (cost_accounting)
```sql
CREATE TABLE cost_accounting (
    id BIGSERIAL PRIMARY KEY,
    accounting_no VARCHAR(30) NOT NULL UNIQUE COMMENT '核算单号',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    accounting_period VARCHAR(10) NOT NULL COMMENT '核算期间(YYYY-MM)',
    product_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '产品成本',
material_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '材料成本',
labor_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '人工成本',
manufacturing_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '制造费用',
logistics_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '物流成本',
installation_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '安装成本',
service_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '服务成本',
other_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '其他成本',
total_cost DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '总成本',
sales_amount DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '销售金额',
gross_profit DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '毛利润',
    gross_profit_rate DECIMAL(5,4) NOT NULL DEFAULT 0 COMMENT '毛利率',
    status VARCHAR(20) DEFAULT 'draft' COMMENT '状态：draft-草稿,confirmed-已确认,closed-已关闭',
    accountant_id BIGINT NOT NULL COMMENT '核算人ID',
    accounting_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '核算时间',
    confirm_time TIMESTAMP COMMENT '确认时间',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (accountant_id) REFERENCES users(id),
    INDEX idx_accounting_no (accounting_no),
    INDEX idx_order_id (order_id),
    INDEX idx_accounting_period (accounting_period),
    INDEX idx_status (status),
    INDEX idx_accounting_time (accounting_time)
);
```

## 4. API接口设计

### 4.1 收款管理接口
```http
POST /api/v1/finance/receipts              # 创建收款记录
PUT /api/v1/finance/receipts/{id}/confirm   # 确认收款
GET /api/v1/finance/receipts               # 查询收款记录
GET /api/v1/finance/receipts/{id}          # 获取收款详情
```

### 4.2 退款管理接口
```http
POST /api/v1/finance/refunds               # 申请退款
PUT /api/v1/finance/refunds/{id}/approve    # 审批退款
PUT /api/v1/finance/refunds/{id}/process    # 处理退款
GET /api/v1/finance/refunds                # 查询退款记录
```

### 4.3 对账管理接口
```http
POST /api/v1/finance/reconciliation        # 启动对账
GET /api/v1/finance/reconciliation         # 查询对账记录
GET /api/v1/finance/reconciliation/{id}/details # 对账详情
PUT /api/v1/finance/reconciliation/{id}/complete # 完成对账
```

### 4.4 财务报表接口
```http
GET /api/v1/finance/reports/income         # 收入报表
GET /api/v1/finance/reports/cost           # 成本报表
GET /api/v1/finance/reports/profit         # 利润报表
GET /api/v1/finance/reports/cashflow       # 现金流报表
```

### 4.5 发票管理接口
```http
POST /api/v1/finance/invoices              # 申请开票
PUT /api/v1/finance/invoices/{id}/issue     # 开具发票
GET /api/v1/finance/invoices               # 查询发票
PUT /api/v1/finance/invoices/{id}/cancel    # 作废发票
```

## 5. 业务规则

### 5.1 收款规则
- 支持多种支付方式：支付宝、微信、银行转账、现金等
- 支持分期收款和预收款
- 收款金额不能超过订单应收金额
- 收款确认后自动更新订单支付状态

### 5.2 退款规则
- 退款金额不能超过已收款金额
- 退款需要经过审批流程
- 支持原路退回和银行转账退款
- 退款完成后自动更新订单状态

### 5.3 对账规则
- 每日自动对账，差异超过阈值时人工处理
- 支持银行、支付宝、微信等多渠道对账
- 对账差异需要及时处理和说明
- 对账完成后生成对账报告

### 5.4 发票规则
- 支持普通发票、专用发票、电子发票
- 发票金额不能超过订单金额
- 发票开具后不可修改，只能作废重开
- 电子发票自动发送给客户

## 6. 集成设计

### 6.1 与订单管理集成
- 订单确认后生成应收款
- 收款确认后更新订单支付状态
- 退款处理后更新订单状态
- 提供订单财务状态查询

### 6.2 与库存管理集成
- 获取产品成本数据
- 库存变动时同步成本信息
- 提供成本核算基础数据

### 6.3 与第三方支付集成
- 支付宝、微信支付接口集成
- 银行支付接口集成
- 支付状态实时同步
- 支付对账数据获取

### 6.4 与税务系统集成
- 发票开具接口集成
- 税务申报数据提供
- 税率自动获取和更新

## 7. 性能优化

### 7.1 缓存策略
- 账户余额信息缓存
- 汇率信息缓存
- 财务报表数据缓存
- 对账结果缓存

### 7.2 数据库优化
- 财务流水表按时间分区
- 对账记录表按账户分区
- 定期归档历史数据
- 关键查询索引优化

### 7.3 并发控制
- 账户余额更新使用悲观锁
- 关键财务操作使用分布式锁
- 支持财务操作的幂等性
- 异步处理非关键财务任务

## 8. 监控告警

### 8.1 业务监控
- 收款成功率监控
- 退款处理时效监控
- 对账差异率监控
- 财务数据准确性监控

### 8.2 系统监控
- 支付接口响应时间
- 财务操作QPS
- 数据库性能监控
- 第三方接口可用性

### 8.3 风险监控
- 大额交易监控
- 异常退款监控
- 账户余额异常监控
- 对账长期未完成监控

## 9. 安全设计

### 9.1 权限控制
- 基于角色的财务操作权限
- 敏感财务操作需要双重验证
- 财务数据访问权限控制
- 关键操作审批流程

### 9.2 数据安全
- 财务数据传输加密
- 敏感财务信息脱敏显示
- 完整的财务操作审计日志
- 财务数据备份和恢复

### 9.3 风险控制
- 大额交易风险控制
- 异常交易识别和拦截
- 资金流向监控
- 反洗钱合规检查

## 10. 合规设计

### 10.1 财务合规
- 符合会计准则要求
- 支持财务审计需求
- 税务合规处理
- 财务报告规范

### 10.2 数据合规
- 财务数据保留期限管理
- 个人财务信息保护
- 跨境资金流动合规
- 监管报告自动生成

---

**文档版本：** v1.0  
**创建日期：** 2025年1月21日  
**维护人员：** 系统架构师  
**审核状态：** 待审核
