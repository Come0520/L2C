# 物流管理模块设计

## 1. 模块概述

### 1.1 功能目标
物流管理模块是L2C销售管理系统的重要组成部分，负责管理从订单发货到客户收货的全流程物流服务，包括物流商管理、运单管理、物流跟踪、配送管理等，确保物流信息的透明化和可追溯性。

### 1.2 核心功能
- **物流商管理**：物流服务商信息管理和评价体系
- **运单管理**：运单创建、打印、跟踪、签收管理
- **物流跟踪**：实时物流状态跟踪和轨迹查询
- **配送管理**：配送计划、配送员管理、配送路线优化
- **异常处理**：物流异常识别、处理和客户通知
- **成本管理**：物流成本核算和费用结算
- **服务评价**：物流服务质量评价和改进

### 1.3 业务价值
- 提升物流服务透明度，改善客户体验
- 优化物流成本，提高配送效率
- 降低物流异常率，减少客户投诉
- 支持多物流商管理，提高服务可靠性

## 2. 业务流程设计

### 2.1 发货流程
```
订单确认 → 拣货打包 → 选择物流商 → 创建运单 → 交付物流 → 物流揽收 → 发货完成
```

### 2.2 配送流程
```
物流揽收 → 运输中转 → 到达配送站 → 派送通知 → 配送员配送 → 客户签收 → 配送完成
```

### 2.3 跟踪流程
```
运单创建 → 状态同步 → 轨迹更新 → 异常识别 → 客户通知 → 问题处理 → 跟踪完成
```

### 2.4 异常处理流程
```
异常识别 → 异常分类 → 责任判定 → 处理方案 → 执行处理 → 客户沟通 → 异常关闭
```

## 3. 数据库设计

### 3.1 物流服务商表 (logistics_providers)
```sql
CREATE TABLE logistics_providers (
    id BIGSERIAL PRIMARY KEY,
    provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT '物流商编码',
    provider_name VARCHAR(100) NOT NULL COMMENT '物流商名称',
    provider_type VARCHAR(20) NOT NULL COMMENT '物流商类型：express-快递,logistics-物流,self-自配送',
    contact_person VARCHAR(50) COMMENT '联系人',
    contact_phone VARCHAR(15) COMMENT '联系电话',
    contact_email VARCHAR(100) COMMENT '联系邮箱',
    service_areas TEXT COMMENT '服务区域(JSON格式)',
    price_config TEXT COMMENT '价格配置(JSON格式)',
    api_config TEXT COMMENT 'API配置(JSON格式)',
    service_level DECIMAL(3,2) DEFAULT 0 COMMENT '服务评级(0-5分)',
    on_time_rate DECIMAL(5,4) DEFAULT 0 COMMENT '准时率',
    damage_rate DECIMAL(5,4) DEFAULT 0 COMMENT '破损率',
    complaint_rate DECIMAL(5,4) DEFAULT 0 COMMENT '投诉率',
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态：active-启用,inactive-停用,suspended-暂停',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_provider_code (provider_code),
    INDEX idx_provider_type (provider_type),
    INDEX idx_status (status),
    INDEX idx_service_level (service_level)
);
```

### 3.2 运单信息表 (shipping_orders)
```sql
CREATE TABLE shipping_orders (
    id BIGSERIAL PRIMARY KEY,
    tracking_no VARCHAR(50) NOT NULL UNIQUE COMMENT '运单号',
    order_id BIGINT NOT NULL COMMENT '销售订单ID',
    provider_id BIGINT NOT NULL COMMENT '物流服务商ID',
    shipping_type VARCHAR(20) NOT NULL COMMENT '配送类型：standard-标准配送,express-加急配送,appointment-预约配送',
    package_count INT NOT NULL DEFAULT 1 COMMENT '包裹数量',
    total_weight DECIMAL(8,3) COMMENT '总重量(kg)',
    total_volume DECIMAL(10,6) COMMENT '总体积(m³)',
    declared_value DECIMAL(10,2) COMMENT '声明价值',
    shipping_fee DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '运费',
    insurance_fee DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT '保险费',
    cod_amount DECIMAL(10,2) DEFAULT 0 COMMENT '代收货款金额',
    
    -- 发件人信息
    sender_name VARCHAR(50) NOT NULL COMMENT '发件人姓名',
    sender_phone VARCHAR(15) NOT NULL COMMENT '发件人电话',
    sender_address TEXT NOT NULL COMMENT '发件人地址',
    sender_postcode VARCHAR(10) COMMENT '发件人邮编',
    
    -- 收件人信息
    receiver_name VARCHAR(50) NOT NULL COMMENT '收件人姓名',
    receiver_phone VARCHAR(15) NOT NULL COMMENT '收件人电话',
    receiver_address TEXT NOT NULL COMMENT '收件人地址',
    receiver_postcode VARCHAR(10) COMMENT '收件人邮编',
    
    -- 时间信息
    ship_time TIMESTAMP COMMENT '发货时间',
    pickup_time TIMESTAMP COMMENT '揽收时间',
    delivery_time TIMESTAMP COMMENT '派送时间',
    sign_time TIMESTAMP COMMENT '签收时间',
    expected_delivery_time TIMESTAMP COMMENT '预计送达时间',
    
    status VARCHAR(20) DEFAULT 'created' COMMENT '状态：created-已创建,picked-已揽收,transit-运输中,delivering-派送中,signed-已签收,exception-异常,returned-已退回',
    current_location VARCHAR(200) COMMENT '当前位置',
    remark TEXT COMMENT '备注',
    operator_id BIGINT COMMENT '操作人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (provider_id) REFERENCES logistics_providers(id),
    FOREIGN KEY (operator_id) REFERENCES users(id),
    INDEX idx_tracking_no (tracking_no),
    INDEX idx_order_id (order_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_status (status),
    INDEX idx_ship_time (ship_time),
    INDEX idx_expected_delivery_time (expected_delivery_time)
);
```

### 3.3 物流轨迹表 (shipping_tracks)
```sql
CREATE TABLE shipping_tracks (
    id BIGSERIAL PRIMARY KEY,
    shipping_order_id BIGINT NOT NULL COMMENT '运单ID',
    tracking_no VARCHAR(50) NOT NULL COMMENT '运单号',
    track_time TIMESTAMP NOT NULL COMMENT '轨迹时间',
    track_status VARCHAR(50) NOT NULL COMMENT '轨迹状态',
    track_location VARCHAR(200) COMMENT '轨迹位置',
    track_description TEXT NOT NULL COMMENT '轨迹描述',
    operator_name VARCHAR(50) COMMENT '操作员姓名',
    operator_phone VARCHAR(15) COMMENT '操作员电话',
    is_signed BOOLEAN DEFAULT FALSE COMMENT '是否签收',
    signer_name VARCHAR(50) COMMENT '签收人姓名',
    sign_type VARCHAR(20) COMMENT '签收类型：self-本人签收,proxy-代签,cabinet-快递柜,station-驿站',
    longitude DECIMAL(10,7) COMMENT '经度',
    latitude DECIMAL(10,7) COMMENT '纬度',
    source VARCHAR(20) DEFAULT 'api' COMMENT '数据来源：api-接口,manual-手动',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (shipping_order_id) REFERENCES shipping_orders(id),
    INDEX idx_shipping_order_id (shipping_order_id),
    INDEX idx_tracking_no (tracking_no),
    INDEX idx_track_time (track_time),
    INDEX idx_track_status (track_status),
    INDEX idx_is_signed (is_signed)
);
```

### 3.4 配送员信息表 (delivery_staff)
```sql
CREATE TABLE delivery_staff (
    id BIGSERIAL PRIMARY KEY,
    staff_code VARCHAR(20) NOT NULL UNIQUE COMMENT '配送员编码',
    staff_name VARCHAR(50) NOT NULL COMMENT '配送员姓名',
    phone VARCHAR(15) NOT NULL COMMENT '手机号码',
    id_card VARCHAR(20) COMMENT '身份证号',
    provider_id BIGINT COMMENT '所属物流商ID',
    service_area TEXT COMMENT '服务区域',
    vehicle_type VARCHAR(20) COMMENT '车辆类型：bike-自行车,ebike-电动车,car-汽车,truck-货车',
    vehicle_no VARCHAR(20) COMMENT '车牌号码',
    max_load DECIMAL(8,3) COMMENT '最大载重(kg)',
    working_hours VARCHAR(50) COMMENT '工作时间',
    rating DECIMAL(3,2) DEFAULT 0 COMMENT '评分(0-5分)',
    delivery_count INT DEFAULT 0 COMMENT '配送次数',
    on_time_count INT DEFAULT 0 COMMENT '准时次数',
    complaint_count INT DEFAULT 0 COMMENT '投诉次数',
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态：active-在职,inactive-离职,suspended-停职',
    hire_date DATE COMMENT '入职日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (provider_id) REFERENCES logistics_providers(id),
    INDEX idx_staff_code (staff_code),
    INDEX idx_phone (phone),
    INDEX idx_provider_id (provider_id),
    INDEX idx_status (status),
    INDEX idx_rating (rating)
);
```

### 3.5 配送任务表 (delivery_tasks)
```sql
CREATE TABLE delivery_tasks (
    id BIGSERIAL PRIMARY KEY,
    task_no VARCHAR(30) NOT NULL UNIQUE COMMENT '任务编号',
    staff_id BIGINT NOT NULL COMMENT '配送员ID',
    delivery_date DATE NOT NULL COMMENT '配送日期',
    total_orders INT NOT NULL DEFAULT 0 COMMENT '总订单数',
    completed_orders INT NOT NULL DEFAULT 0 COMMENT '已完成订单数',
    failed_orders INT NOT NULL DEFAULT 0 COMMENT '失败订单数',
    total_distance DECIMAL(8,2) DEFAULT 0 COMMENT '总距离(km)',
    start_time TIMESTAMP COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '状态：pending-待执行,executing-执行中,completed-已完成,cancelled-已取消',
    route_plan TEXT COMMENT '路线规划(JSON格式)',
    actual_route TEXT COMMENT '实际路线(JSON格式)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (staff_id) REFERENCES delivery_staff(id),
    INDEX idx_task_no (task_no),
    INDEX idx_staff_id (staff_id),
    INDEX idx_delivery_date (delivery_date),
    INDEX idx_status (status)
);
```

### 3.6 配送任务明细表 (delivery_task_items)
```sql
CREATE TABLE delivery_task_items (
    id BIGSERIAL PRIMARY KEY,
    task_id BIGINT NOT NULL COMMENT '配送任务ID',
    shipping_order_id BIGINT NOT NULL COMMENT '运单ID',
    sequence_no INT NOT NULL COMMENT '配送顺序',
    planned_time TIMESTAMP COMMENT '计划配送时间',
    actual_time TIMESTAMP COMMENT '实际配送时间',
    delivery_status VARCHAR(20) DEFAULT 'pending' COMMENT '配送状态：pending-待配送,delivering-配送中,success-成功,failed-失败,rescheduled-改期',
    failure_reason VARCHAR(100) COMMENT '失败原因',
    customer_feedback TEXT COMMENT '客户反馈',
    delivery_photo VARCHAR(500) COMMENT '配送照片URL',
    signature_photo VARCHAR(500) COMMENT '签收照片URL',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (task_id) REFERENCES delivery_tasks(id),
    FOREIGN KEY (shipping_order_id) REFERENCES shipping_orders(id),
    INDEX idx_task_id (task_id),
    INDEX idx_shipping_order_id (shipping_order_id),
    INDEX idx_sequence_no (sequence_no),
    INDEX idx_delivery_status (delivery_status)
);
```

### 3.7 物流异常表 (logistics_exceptions)
```sql
CREATE TABLE logistics_exceptions (
    id BIGSERIAL PRIMARY KEY,
    exception_no VARCHAR(30) NOT NULL UNIQUE COMMENT '异常单号',
    shipping_order_id BIGINT NOT NULL COMMENT '运单ID',
    exception_type VARCHAR(30) NOT NULL COMMENT '异常类型：delay-延误,damage-破损,lost-丢失,address-地址问题,refuse-拒收,weather-天气,other-其他',
    exception_level VARCHAR(20) NOT NULL COMMENT '异常级别：low-低,medium-中,high-高,critical-紧急',
    exception_description TEXT NOT NULL COMMENT '异常描述',
    occurrence_time TIMESTAMP NOT NULL COMMENT '发生时间',
    discovery_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '发现时间',
    location VARCHAR(200) COMMENT '发生地点',
    responsible_party VARCHAR(50) COMMENT '责任方',
    impact_assessment TEXT COMMENT '影响评估',
    
    -- 处理信息
    handler_id BIGINT COMMENT '处理人ID',
    handle_time TIMESTAMP COMMENT '处理时间',
    handle_method TEXT COMMENT '处理方法',
    handle_result TEXT COMMENT '处理结果',
    compensation_amount DECIMAL(10,2) DEFAULT 0 COMMENT '赔偿金额',
    
    status VARCHAR(20) DEFAULT 'open' COMMENT '状态：open-待处理,processing-处理中,resolved-已解决,closed-已关闭',
    customer_notified BOOLEAN DEFAULT FALSE COMMENT '是否已通知客户',
    customer_feedback TEXT COMMENT '客户反馈',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (shipping_order_id) REFERENCES shipping_orders(id),
    FOREIGN KEY (handler_id) REFERENCES users(id),
    INDEX idx_exception_no (exception_no),
    INDEX idx_shipping_order_id (shipping_order_id),
    INDEX idx_exception_type (exception_type),
    INDEX idx_exception_level (exception_level),
    INDEX idx_occurrence_time (occurrence_time),
    INDEX idx_status (status)
);
```

## 4. API接口设计

### 4.1 运单管理接口
```http
POST /api/v1/logistics/shipping_orders      # 创建运单
GET /api/v1/logistics/shipping_orders       # 查询运单列表
GET /api/v1/logistics/shipping_orders/{id}  # 获取运单详情
PUT /api/v1/logistics/shipping_orders/{id}  # 更新运单信息
DELETE /api/v1/logistics/shipping_orders/{id} # 取消运单
```

### 4.2 物流跟踪接口
```http
GET /api/v1/logistics/tracking/{tracking_no}     # 查询物流轨迹
POST /api/v1/logistics/tracking/sync             # 同步物流状态
GET /api/v1/logistics/tracking/batch             # 批量查询物流状态
POST /api/v1/logistics/tracking/webhook          # 物流状态回调
```

### 4.3 配送管理接口
```http
POST /api/v1/logistics/delivery/tasks           # 创建配送任务
GET /api/v1/logistics/delivery/tasks            # 查询配送任务
PUT /api/v1/logistics/delivery/tasks/{id}/assign # 分配配送员
PUT /api/v1/logistics/delivery/tasks/{id}/complete # 完成配送
```

### 4.4 异常处理接口
```http
POST /api/v1/logistics/exceptions               # 创建异常单
GET /api/v1/logistics/exceptions                # 查询异常列表
PUT /api/v1/logistics/exceptions/{id}/handle     # 处理异常
PUT /api/v1/logistics/exceptions/{id}/close      # 关闭异常
```

### 4.5 物流商管理接口
```http
POST /api/v1/logistics/providers                # 添加物流商
GET /api/v1/logistics/providers                 # 查询物流商列表
PUT /api/v1/logistics/providers/{id}             # 更新物流商信息
GET /api/v1/logistics/providers/{id}/performance # 物流商绩效
```

## 5. 业务规则

### 5.1 运单创建规则
- 订单支付确认后才能创建运单
- 根据收货地址自动选择最优物流商
- 支持多包裹运单和合并发货
- 运单创建后自动生成运单号

### 5.2 物流跟踪规则
- 每小时自动同步物流状态
- 关键状态变更实时推送给客户
- 超过预期送达时间自动标记延误
- 异常状态自动触发处理流程

### 5.3 配送规则
- 同城配送优先使用自配送
- 根据配送员位置和负载智能分配任务
- 支持预约配送和加急配送
- 配送失败自动安排重新配送

### 5.4 异常处理规则
- 异常发生后2小时内必须响应
- 高级别异常自动升级处理
- 客户投诉异常优先处理
- 异常处理完成后自动通知客户

## 6. 集成设计

### 6.1 与订单管理集成
- 订单确认后自动创建运单
- 物流状态变更同步更新订单状态
- 签收确认后自动完成订单
- 提供订单物流信息查询

### 6.2 与库存管理集成
- 发货时自动扣减库存
- 退货时自动增加库存
- 提供在途库存信息
- 支持库存调拨物流

### 6.3 与客户服务集成
- 物流异常自动创建客服工单
- 提供客户物流查询接口
- 配送预约信息同步
- 客户投诉处理联动

### 6.4 与第三方物流集成
- 标准化物流API接口
- 支持多家物流商接入
- 物流费用自动计算
- 物流数据实时同步

## 7. 性能优化

### 7.1 缓存策略
- 物流商信息缓存
- 热门路线配送时效缓存
- 物流轨迹数据缓存
- 配送员位置信息缓存

### 7.2 数据库优化
- 物流轨迹表按时间分区
- 运单表按物流商分区
- 定期归档历史数据
- 关键查询索引优化

### 7.3 接口优化
- 物流状态批量查询
- 异步处理物流回调
- 物流数据增量同步
- 接口调用频率限制

## 8. 监控告警

### 8.1 业务监控
- 运单及时率监控
- 物流异常率监控
- 客户满意度监控
- 配送成功率监控

### 8.2 系统监控
- 物流API响应时间
- 数据同步成功率
- 系统处理能力监控
- 第三方接口可用性

### 8.3 预警机制
- 运单长时间无更新预警
- 大量异常集中发生预警
- 物流商服务质量下降预警
- 配送员异常行为预警

## 9. 安全设计

### 9.1 数据安全
- 客户地址信息加密存储
- 配送员个人信息保护
- 物流轨迹数据脱敏
- 敏感操作审计日志

### 9.2 接口安全
- 第三方接口调用鉴权
- API调用频率限制
- 数据传输加密
- 回调接口验签

### 9.3 隐私保护
- 客户位置信息保护
- 配送员轨迹隐私
- 数据访问权限控制
- 数据保留期限管理

## 10. 扩展性设计

### 10.1 多物流商支持
- 标准化物流接口
- 插件化物流商接入
- 物流商服务能力配置
- 智能物流商选择

### 10.2 国际化支持
- 多语言物流状态
- 国际物流规则支持
- 跨境物流合规
- 多时区时间处理

### 10.3 新技术集成
- 物联网设备集成
- 人工智能路线优化
- 区块链物流溯源
- 无人配送支持

---

**文档版本：** v1.0  
**创建日期：** 2025年1月21日  
**维护人员：** 系统架构师  
**审核状态：** 待审核
