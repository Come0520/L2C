# 客户关系管理(CRM)模块设计

## 1. 模块概述

### 1.1 功能目标
客户关系管理(CRM)模块旨在统一管理客户信息，建立完整的客户画像，提升客户服务质量和销售转化率。解决当前系统中客户信息分散在各模块、无法形成统一客户视图的问题。

### 1.2 核心功能
- **客户信息管理**：统一客户档案、联系人管理、客户分级
- **客户画像分析**：行为分析、偏好分析、价值评估
- **客户生命周期管理**：获客、培育、转化、留存、流失预警
- **客户服务管理**：服务记录、投诉处理、满意度调查
- **营销活动管理**：精准营销、活动跟踪、效果评估
- **客户沟通管理**：沟通记录、跟进提醒、互动历史

### 1.3 业务价值
- **提升客户体验**：360度客户视图，个性化服务
- **增加销售转化**：精准营销，提高成单率
- **降低流失率**：预警机制，及时挽回
- **优化资源配置**：客户价值分析，重点客户管理

## 2. 业务流程设计

### 2.1 客户获取流程
```
线索导入 → 客户识别 → 信息补全 → 客户分级 → 分配销售
```

### 2.2 客户培育流程
```
需求分析 → 营销活动 → 跟进记录 → 商机识别 → 转化跟踪
```

### 2.3 客户服务流程
```
服务请求 → 需求分析 → 服务执行 → 结果反馈 → 满意度调查
```

### 2.4 客户流失预警流程
```
行为监控 → 风险评估 → 预警触发 → 挽回策略 → 执行跟踪
```

## 3. 数据库设计

### 3.1 客户主表 (customers)
```sql
CREATE TABLE customers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_code VARCHAR(32) UNIQUE NOT NULL COMMENT '客户编码',
    customer_name VARCHAR(100) NOT NULL COMMENT '客户名称',
    customer_type ENUM('individual', 'enterprise') NOT NULL COMMENT '客户类型',
    customer_level ENUM('A', 'B', 'C', 'D') DEFAULT 'D' COMMENT '客户等级',
    customer_status ENUM('active', 'inactive', 'blacklist') DEFAULT 'active' COMMENT '客户状态',
    industry VARCHAR(50) COMMENT '所属行业',
    company_size ENUM('small', 'medium', 'large') COMMENT '企业规模',
    annual_revenue DECIMAL(15,2) COMMENT '年营业额',
    credit_rating ENUM('AAA', 'AA', 'A', 'BBB', 'BB', 'B', 'C') COMMENT '信用等级',
    source VARCHAR(50) COMMENT '客户来源',
    acquisition_date DATE COMMENT '获客日期',
    last_contact_date DATETIME COMMENT '最后联系时间',
    assigned_sales_id BIGINT COMMENT '分配销售ID',
    assigned_service_id BIGINT COMMENT '分配客服ID',
    FOREIGN KEY (assigned_sales_id) REFERENCES users(id),
    FOREIGN KEY (assigned_service_id) REFERENCES users(id),
    tags JSON COMMENT '客户标签',
    remarks TEXT COMMENT '备注信息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by BIGINT NOT NULL,
    updated_by BIGINT,
    INDEX idx_customer_code (customer_code),
    INDEX idx_customer_level (customer_level),
    INDEX idx_assigned_sales (assigned_sales_id),
    INDEX idx_acquisition_date (acquisition_date)
);
```

### 3.2 客户联系人表 (customer_contacts)
```sql
CREATE TABLE customer_contacts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT NOT NULL,
    contact_name VARCHAR(50) NOT NULL COMMENT '联系人姓名',
    contact_title VARCHAR(50) COMMENT '职位',
    contact_phone VARCHAR(15) COMMENT '联系电话',
    contact_email VARCHAR(100) COMMENT '邮箱',
    contact_wechat VARCHAR(50) COMMENT '微信号',
    is_primary BOOLEAN DEFAULT FALSE COMMENT '是否主要联系人',
    is_decision_maker BOOLEAN DEFAULT FALSE COMMENT '是否决策人',
    contact_status ENUM('active', 'inactive') DEFAULT 'active',
    birthday DATE COMMENT '生日',
    preferences JSON COMMENT '偏好信息',
    remarks TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_contact_phone (contact_phone),
    INDEX idx_contact_email (contact_email)
);
```

### 3.3 客户地址表 (customer_addresses)
```sql
CREATE TABLE customer_addresses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT NOT NULL,
    address_type ENUM('billing', 'shipping', 'office', 'home') NOT NULL,
    province VARCHAR(20) NOT NULL,
    city VARCHAR(20) NOT NULL,
    district VARCHAR(20),
    detailed_address VARCHAR(200) NOT NULL,
    postal_code VARCHAR(10),
    is_default BOOLEAN DEFAULT FALSE COMMENT '是否默认地址',
    contact_name VARCHAR(50) COMMENT '联系人',
    contact_phone VARCHAR(15) COMMENT '联系电话',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_address_type (address_type)
);
```

### 3.4 客户互动记录表 (customer_interactions)
```sql
CREATE TABLE customer_interactions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT NOT NULL,
    contact_id BIGINT COMMENT '联系人ID',
    interaction_type ENUM('call', 'email', 'meeting', 'visit', 'wechat', 'other') NOT NULL,
    interaction_direction ENUM('inbound', 'outbound') NOT NULL,
    subject VARCHAR(200) NOT NULL COMMENT '主题',
    content TEXT COMMENT '内容',
    interaction_date DATETIME NOT NULL,
    duration_minutes INT COMMENT '持续时间(分钟)',
    outcome ENUM('successful', 'failed', 'follow_up_needed') COMMENT '结果',
    next_action VARCHAR(200) COMMENT '下一步行动',
    next_action_date DATETIME COMMENT '下次跟进时间',
    staff_id BIGINT NOT NULL COMMENT '执行人员ID',
    attachments JSON COMMENT '附件信息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (contact_id) REFERENCES customer_contacts(id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_interaction_date (interaction_date),
    INDEX idx_staff_id (staff_id),
    INDEX idx_next_action_date (next_action_date)
);
```

### 3.5 客户价值分析表 (customer_value_analysis)
```sql
CREATE TABLE customer_value_analysis (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT NOT NULL,
    analysis_date DATE NOT NULL,
    total_orders INT DEFAULT 0 COMMENT '总订单数',
    total_amount DECIMAL(15,2) DEFAULT 0 COMMENT '总消费金额',
    avg_order_amount DECIMAL(15,2) DEFAULT 0 COMMENT '平均订单金额',
    last_order_date DATE COMMENT '最后下单日期',
    order_frequency DECIMAL(5,2) COMMENT '下单频率(次/月)',
    customer_lifetime_value DECIMAL(15,2) COMMENT '客户生命周期价值',
    churn_probability DECIMAL(5,4) COMMENT '流失概率',
    satisfaction_score DECIMAL(3,2) COMMENT '满意度评分',
    referral_count INT DEFAULT 0 COMMENT '推荐客户数',
    complaint_count INT DEFAULT 0 COMMENT '投诉次数',
    service_cost DECIMAL(10,2) DEFAULT 0 COMMENT '服务成本',
    profit_margin DECIMAL(5,4) COMMENT '利润率',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    UNIQUE KEY uk_customer_date (customer_id, analysis_date),
    INDEX idx_analysis_date (analysis_date),
    INDEX idx_clv (customer_lifetime_value),
    INDEX idx_churn_probability (churn_probability)
);
```

### 3.6 营销活动表 (marketing_campaigns)
```sql
CREATE TABLE marketing_campaigns (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_name VARCHAR(100) NOT NULL COMMENT '活动名称',
    campaign_type ENUM('email', 'sms', 'phone', 'event', 'promotion') NOT NULL,
    campaign_status ENUM('draft', 'active', 'paused', 'completed', 'cancelled') DEFAULT 'draft',
    target_audience JSON COMMENT '目标受众条件',
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    budget DECIMAL(10,2) COMMENT '预算',
    actual_cost DECIMAL(10,2) DEFAULT 0 COMMENT '实际成本',
    target_count INT COMMENT '目标客户数',
    sent_count INT DEFAULT 0 COMMENT '发送数量',
    open_count INT DEFAULT 0 COMMENT '打开数量',
    click_count INT DEFAULT 0 COMMENT '点击数量',
    conversion_count INT DEFAULT 0 COMMENT '转化数量',
    revenue DECIMAL(15,2) DEFAULT 0 COMMENT '产生收入',
    roi DECIMAL(5,4) COMMENT 'ROI',
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_campaign_status (campaign_status),
    INDEX idx_start_date (start_date),
    INDEX idx_created_by (created_by)
);
```

### 3.7 客户服务记录表 (customer_service_records)
```sql
CREATE TABLE customer_service_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT NOT NULL,
    contact_id BIGINT COMMENT '联系人ID',
    service_type ENUM('consultation', 'complaint', 'technical_support', 'after_sales', 'other') NOT NULL,
    priority ENUM('low', 'medium', 'high', 'urgent') DEFAULT 'medium',
    status ENUM('open', 'in_progress', 'resolved', 'closed', 'cancelled') DEFAULT 'open',
    subject VARCHAR(200) NOT NULL COMMENT '服务主题',
    description TEXT NOT NULL COMMENT '问题描述',
    resolution TEXT COMMENT '解决方案',
    assigned_staff_id BIGINT COMMENT '分配客服ID',
    created_date DATETIME NOT NULL,
    first_response_date DATETIME COMMENT '首次响应时间',
    resolved_date DATETIME COMMENT '解决时间',
    closed_date DATETIME COMMENT '关闭时间',
    satisfaction_rating INT COMMENT '满意度评分(1-5)',
    satisfaction_feedback TEXT COMMENT '满意度反馈',
    escalated BOOLEAN DEFAULT FALSE COMMENT '是否升级',
    escalation_reason VARCHAR(200) COMMENT '升级原因',
    tags JSON COMMENT '标签',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (contact_id) REFERENCES customer_contacts(id),
    INDEX idx_customer_id (customer_id),
    INDEX idx_status (status),
    INDEX idx_priority (priority),
    INDEX idx_assigned_staff (assigned_staff_id),
    INDEX idx_created_date (created_date)
);
```

## 4. API接口设计

### 4.1 客户管理接口

#### 4.1.1 客户查询
```http
GET /api/v1/crm/customers
GET /api/v1/crm/customers/{id}
GET /api/v1/crm/customers/search?keyword={keyword}&level={level}&status={status}
```

#### 4.1.2 客户操作
```http
POST /api/v1/crm/customers
PUT /api/v1/crm/customers/{id}
DELETE /api/v1/crm/customers/{id}
PUT /api/v1/crm/customers/{id}/level
PUT /api/v1/crm/customers/{id}/assign_sales
```

### 4.2 客户画像接口

#### 4.2.1 客户价值分析
```http
GET /api/v1/crm/customers/{id}/value_analysis
POST /api/v1/crm/customers/{id}/value_analysis/refresh
GET /api/v1/crm/customers/{id}/behavior_analysis
```

#### 4.2.2 客户互动记录
```http
GET /api/v1/crm/customers/{id}/interactions
POST /api/v1/crm/customers/{id}/interactions
PUT /api/v1/crm/interactions/{id}
GET /api/v1/crm/interactions/pending_follow_up
```

### 4.3 营销活动接口

#### 4.3.1 活动管理
```http
GET /api/v1/crm/campaigns
POST /api/v1/crm/campaigns
PUT /api/v1/crm/campaigns/{id}
POST /api/v1/crm/campaigns/{id}/execute
GET /api/v1/crm/campaigns/{id}/statistics
```

### 4.4 客户服务接口

#### 4.4.1 服务记录管理
```http
GET /api/v1/crm/service_records
POST /api/v1/crm/service_records
PUT /api/v1/crm/service_records/{id}
PUT /api/v1/crm/service_records/{id}/assign
PUT /api/v1/crm/service_records/{id}/resolve
```

## 5. 业务规则

### 5.1 客户分级规则
- **A级客户**：年消费≥50万或潜在价值≥100万
- **B级客户**：年消费20-50万或潜在价值50-100万
- **C级客户**：年消费5-20万或潜在价值20-50万
- **D级客户**：年消费<5万或潜在价值<20万

### 5.2 流失预警规则
- **高风险**：90天未下单且历史活跃客户
- **中风险**：60天未互动且近期消费下降
- **低风险**：30天未互动但消费稳定

### 5.3 自动分配规则
- 新客户按地区和行业自动分配销售
- 服务请求按优先级和工作负载分配客服
- VIP客户指定专属服务团队

## 6. 集成设计

### 6.1 与线索管理集成
- 线索转化为客户时自动创建客户档案
- 继承线索的基础信息和跟进记录
- 统一客户标识，避免重复创建

### 6.2 与订单管理集成
- 订单信息自动更新客户价值分析
- 订单状态变化触发客户互动记录
- 客户等级影响订单审批流程

### 6.3 与财务管理集成
- 客户信用等级影响付款条件
- 应收账款信息影响客户风险评估
- 客户价值分析包含财务数据

### 6.4 与营销系统集成
- 客户画像数据支持精准营销
- 营销活动效果反馈客户行为分析
- 客户偏好指导产品推荐

## 7. 性能优化

### 7.1 缓存策略
- **客户基础信息**：Redis缓存，TTL 1小时
- **客户画像数据**：Redis缓存，TTL 6小时
- **热点客户数据**：本地缓存，TTL 30分钟

### 7.2 数据库优化
- 客户表按地区分区
- 互动记录表按时间分区
- 价值分析表定期归档历史数据

### 7.3 查询优化
- 客户搜索使用Elasticsearch
- 复杂统计查询使用数据仓库
- 实时数据和历史数据分离

## 8. 监控告警

### 8.1 业务监控
- 客户获取成本监控
- 客户流失率预警
- 服务响应时间监控
- 营销活动ROI监控

### 8.2 系统监控
- API响应时间监控
- 数据库连接池监控
- 缓存命中率监控
- 数据同步延迟监控

## 9. 安全设计

### 9.1 数据权限
- 客户数据按销售区域控制访问
- 敏感信息（如财务数据）需特殊权限
- 客户联系方式脱敏显示

### 9.2 操作审计
- 客户信息修改全程记录
- 敏感操作需要审批
- 数据导出行为监控

### 9.3 隐私保护
- 客户个人信息加密存储
- 支持客户数据删除请求
- 遵循数据保护法规

## 10. 扩展性设计

### 10.1 多租户支持
- 支持多品牌客户管理
- 数据隔离和权限控制
- 个性化配置支持

### 10.2 AI能力集成
- 客户流失预测模型
- 智能客户分级
- 个性化推荐引擎
- 智能客服机器人

### 10.3 第三方集成
- 社交媒体数据集成
- 第三方数据源补充
- 外部营销平台对接
- 客户数据平台(CDP)集成
