# 合同管理模块设计

## 1. 模块概述

### 1.1 功能目标
合同管理模块旨在建立完整的合同生命周期管理体系，规范合同签署、执行、变更和结算流程，降低法务风险，提升合同执行效率，确保商务条款的有效执行。

### 1.2 核心功能
- **合同模板管理**：标准模板、条款库、智能生成
- **合同起草管理**：合同创建、条款编辑、风险审查
- **合同审批管理**：多级审批、法务审核、电子签署
- **合同执行管理**：执行监控、里程碑跟踪、变更管理
- **合同结算管理**：收付款管理、发票管理、结算核对
- **合同档案管理**：文档存储、版本控制、到期提醒

### 1.3 业务价值
- **降低法务风险**：标准化合同条款，规范审批流程
- **提升执行效率**：自动化流程，实时监控执行状态
- **优化成本控制**：精确成本核算，及时风险预警
- **增强合规管理**：完整审计轨迹，满足合规要求

## 2. 业务流程设计

### 2.1 合同签署流程
```
需求确认 → 合同起草 → 内部审批 → 法务审核 → 客户确认 → 电子签署 → 合同生效
```

### 2.2 合同执行流程
```
合同生效 → 执行计划 → 里程碑监控 → 变更管理 → 验收确认 → 结算管理
```

### 2.3 合同变更流程
```
变更申请 → 影响评估 → 商务谈判 → 变更审批 → 补充协议 → 执行调整
```

### 2.4 合同结算流程
```
结算申请 → 执行确认 → 金额核对 → 发票开具 → 收付款管理 → 结算完成
```

## 3. 数据库设计

### 3.1 合同主表 (contracts)
```sql
CREATE TABLE contracts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    contract_number VARCHAR(50) UNIQUE NOT NULL COMMENT '合同编号',
    contract_name VARCHAR(200) NOT NULL COMMENT '合同名称',
    contract_type ENUM('sales', 'purchase', 'service', 'framework', 'nda', 'other') NOT NULL COMMENT '合同类型',
    contract_category ENUM('standard', 'custom', 'template') DEFAULT 'standard' COMMENT '合同类别',
    contract_status ENUM('draft', 'reviewing', 'approved', 'signed', 'executing', 'completed', 'terminated', 'cancelled') DEFAULT 'draft' COMMENT '合同状态',
    priority ENUM('low', 'medium', 'high', 'urgent') DEFAULT 'medium' COMMENT '优先级',
    
    -- 合同主体信息
    party_a_type ENUM('company', 'individual') NOT NULL COMMENT '甲方类型',
    party_a_name VARCHAR(200) NOT NULL COMMENT '甲方名称',
    party_a_contact VARCHAR(100) COMMENT '甲方联系人',
    party_a_phone VARCHAR(15) COMMENT '甲方电话',
    party_a_address TEXT COMMENT '甲方地址',
    
    party_b_type ENUM('company', 'individual') NOT NULL COMMENT '乙方类型',
    party_b_name VARCHAR(200) NOT NULL COMMENT '乙方名称',
    party_b_contact VARCHAR(100) COMMENT '乙方联系人',
    party_b_phone VARCHAR(15) COMMENT '乙方电话',
    party_b_address TEXT COMMENT '乙方地址',
    
    -- 合同金额信息
    contract_amount DECIMAL(15,2) NOT NULL COMMENT '合同总金额',
    currency VARCHAR(10) DEFAULT 'CNY' COMMENT '币种',
    tax_rate DECIMAL(5,4) DEFAULT 0.13 COMMENT '税率',
    tax_amount DECIMAL(15,2) COMMENT '税额',
    amount_including_tax DECIMAL(15,2) COMMENT '含税金额',
    
    -- 合同时间信息
    signing_date DATE COMMENT '签署日期',
    effective_date DATE COMMENT '生效日期',
    expiry_date DATE COMMENT '到期日期',
    delivery_date DATE COMMENT '交付日期',
    warranty_period_months INT COMMENT '质保期(月)',
    
    -- 付款信息
    payment_terms TEXT COMMENT '付款条件',
    payment_method ENUM('bank_transfer', 'check', 'cash', 'letter_of_credit', 'other') COMMENT '付款方式',
    advance_payment_ratio DECIMAL(5,4) COMMENT '预付款比例',
    progress_payment_ratio DECIMAL(5,4) COMMENT '进度款比例',
    final_payment_ratio DECIMAL(5,4) COMMENT '尾款比例',
    
    -- 关联信息
    customer_id BIGINT COMMENT '客户ID',
    supplier_id BIGINT COMMENT '供应商ID',
    order_id BIGINT COMMENT '关联订单ID',
    project_id BIGINT COMMENT '关联项目ID',
    template_id BIGINT COMMENT '合同模板ID',
    parent_contract_id BIGINT COMMENT '主合同ID(补充协议)',
    
    -- 执行信息
    execution_progress DECIMAL(5,4) DEFAULT 0 COMMENT '执行进度',
    paid_amount DECIMAL(15,2) DEFAULT 0 COMMENT '已付金额',
    received_amount DECIMAL(15,2) DEFAULT 0 COMMENT '已收金额',
    invoiced_amount DECIMAL(15,2) DEFAULT 0 COMMENT '已开票金额',
    
    -- 风险信息
    risk_level ENUM('low', 'medium', 'high', 'critical') DEFAULT 'low' COMMENT '风险等级',
    risk_description TEXT COMMENT '风险描述',
    
    -- 审批信息
    created_by BIGINT NOT NULL COMMENT '创建人',
    assigned_lawyer_id BIGINT COMMENT '分配律师ID',
    approved_by BIGINT COMMENT '审批人',
    approved_date DATETIME COMMENT '审批日期',
    
    -- 文档信息
    contract_file_path VARCHAR(500) COMMENT '合同文件路径',
    signed_file_path VARCHAR(500) COMMENT '签署文件路径',
    
    remarks TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_contract_number (contract_number),
    INDEX idx_contract_status (contract_status),
    INDEX idx_contract_type (contract_type),
    INDEX idx_customer_id (customer_id),
    INDEX idx_supplier_id (supplier_id),
    INDEX idx_signing_date (signing_date),
    INDEX idx_expiry_date (expiry_date),
    INDEX idx_created_by (created_by),
    
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    FOREIGN KEY (order_id) REFERENCES sales_orders(id),
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (template_id) REFERENCES contract_templates(id),
    FOREIGN KEY (parent_contract_id) REFERENCES contracts(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (assigned_lawyer_id) REFERENCES users(id),
    FOREIGN KEY (approved_by) REFERENCES users(id)
);
```

### 3.2 合同模板表 (contract_templates)
```sql
CREATE TABLE contract_templates (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    template_name VARCHAR(100) NOT NULL COMMENT '模板名称',
    template_code VARCHAR(50) UNIQUE NOT NULL COMMENT '模板编码',
    template_type ENUM('sales', 'purchase', 'service', 'framework', 'nda', 'other') NOT NULL COMMENT '模板类型',
    template_category ENUM('standard', 'industry', 'custom') DEFAULT 'standard' COMMENT '模板类别',
    template_status ENUM('draft', 'active', 'inactive', 'archived') DEFAULT 'draft' COMMENT '模板状态',
    version VARCHAR(20) NOT NULL COMMENT '版本号',
    template_content LONGTEXT NOT NULL COMMENT '模板内容',
    template_variables JSON COMMENT '模板变量',
    approval_workflow JSON COMMENT '审批流程配置',
    applicable_amount_min DECIMAL(15,2) COMMENT '适用金额下限',
    applicable_amount_max DECIMAL(15,2) COMMENT '适用金额上限',
    applicable_departments JSON COMMENT '适用部门',
    usage_count INT DEFAULT 0 COMMENT '使用次数',
    created_by BIGINT NOT NULL,
    approved_by BIGINT COMMENT '审批人',
    approved_date DATETIME COMMENT '审批日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_template_code (template_code),
    INDEX idx_template_type (template_type),
    INDEX idx_template_status (template_status)
);
```

### 3.3 合同条款库表 (contract_clauses)
```sql
CREATE TABLE contract_clauses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    clause_name VARCHAR(100) NOT NULL COMMENT '条款名称',
    clause_code VARCHAR(50) UNIQUE NOT NULL COMMENT '条款编码',
    clause_category ENUM('payment', 'delivery', 'quality', 'liability', 'confidentiality', 'termination', 'other') NOT NULL COMMENT '条款类别',
    clause_type ENUM('standard', 'optional', 'custom') DEFAULT 'standard' COMMENT '条款类型',
    clause_content TEXT NOT NULL COMMENT '条款内容',
    clause_variables JSON COMMENT '条款变量',
    risk_level ENUM('low', 'medium', 'high') DEFAULT 'low' COMMENT '风险等级',
    legal_review_required BOOLEAN DEFAULT FALSE COMMENT '是否需要法务审核',
    applicable_contract_types JSON COMMENT '适用合同类型',
    usage_frequency INT DEFAULT 0 COMMENT '使用频率',
    created_by BIGINT NOT NULL,
    approved_by BIGINT COMMENT '审批人',
    approved_date DATETIME COMMENT '审批日期',
    clause_status ENUM('active', 'inactive', 'archived') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_clause_code (clause_code),
    INDEX idx_clause_category (clause_category),
    INDEX idx_clause_type (clause_type)
);
```

### 3.4 合同审批记录表 (contract_approvals)
```sql
CREATE TABLE contract_approvals (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    contract_id BIGINT NOT NULL,
    approval_step INT NOT NULL COMMENT '审批步骤',
    approval_type ENUM('business', 'legal', 'finance', 'management') NOT NULL COMMENT '审批类型',
    approver_id BIGINT NOT NULL COMMENT '审批人ID',
    approval_status ENUM('pending', 'approved', 'rejected', 'cancelled') DEFAULT 'pending' COMMENT '审批状态',
    approval_date DATETIME COMMENT '审批日期',
    approval_comments TEXT COMMENT '审批意见',
    rejection_reason TEXT COMMENT '拒绝原因',
    required_changes TEXT COMMENT '要求修改内容',
    approval_deadline DATETIME COMMENT '审批截止时间',
    escalated BOOLEAN DEFAULT FALSE COMMENT '是否已升级',
    escalation_date DATETIME COMMENT '升级日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (contract_id) REFERENCES contracts(id),
    INDEX idx_contract_id (contract_id),
    INDEX idx_approver_id (approver_id),
    INDEX idx_approval_status (approval_status),
    INDEX idx_approval_deadline (approval_deadline)
);
```

### 3.5 合同执行记录表 (contract_executions)
```sql
CREATE TABLE contract_executions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    contract_id BIGINT NOT NULL,
    milestone_name VARCHAR(100) NOT NULL COMMENT '里程碑名称',
    milestone_type ENUM('delivery', 'payment', 'acceptance', 'service', 'other') NOT NULL COMMENT '里程碑类型',
    planned_date DATE NOT NULL COMMENT '计划日期',
    actual_date DATE COMMENT '实际日期',
    execution_status ENUM('pending', 'in_progress', 'completed', 'delayed', 'cancelled') DEFAULT 'pending' COMMENT '执行状态',
    completion_percentage DECIMAL(5,2) DEFAULT 0 COMMENT '完成百分比',
    milestone_amount DECIMAL(15,2) COMMENT '里程碑金额',
    deliverables TEXT COMMENT '交付物',
    acceptance_criteria TEXT COMMENT '验收标准',
    actual_deliverables TEXT COMMENT '实际交付物',
    acceptance_result ENUM('passed', 'failed', 'partial', 'pending') COMMENT '验收结果',
    acceptance_date DATE COMMENT '验收日期',
    acceptor_id BIGINT COMMENT '验收人ID',
    delay_reason TEXT COMMENT '延期原因',
    delay_days INT COMMENT '延期天数',
    penalty_amount DECIMAL(10,2) DEFAULT 0 COMMENT '违约金',
    responsible_person_id BIGINT COMMENT '负责人ID',
    remarks TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (contract_id) REFERENCES contracts(id),
    INDEX idx_contract_id (contract_id),
    INDEX idx_milestone_type (milestone_type),
    INDEX idx_execution_status (execution_status),
    INDEX idx_planned_date (planned_date)
);
```

### 3.6 合同变更记录表 (contract_changes)
```sql
CREATE TABLE contract_changes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    contract_id BIGINT NOT NULL,
    change_number VARCHAR(50) NOT NULL COMMENT '变更编号',
    change_type ENUM('amount', 'scope', 'timeline', 'terms', 'other') NOT NULL COMMENT '变更类型',
    change_reason TEXT NOT NULL COMMENT '变更原因',
    change_description TEXT NOT NULL COMMENT '变更描述',
    change_status ENUM('draft', 'submitted', 'approved', 'rejected', 'implemented') DEFAULT 'draft' COMMENT '变更状态',
    
    -- 变更前后对比
    original_amount DECIMAL(15,2) COMMENT '原金额',
    new_amount DECIMAL(15,2) COMMENT '新金额',
    amount_difference DECIMAL(15,2) COMMENT '金额差异',
    original_delivery_date DATE COMMENT '原交付日期',
    new_delivery_date DATE COMMENT '新交付日期',
    timeline_impact_days INT COMMENT '时间影响天数',
    
    -- 影响评估
    cost_impact DECIMAL(10,2) COMMENT '成本影响',
    schedule_impact_days INT COMMENT '进度影响天数',
    risk_impact TEXT COMMENT '风险影响',
    resource_impact TEXT COMMENT '资源影响',
    
    -- 审批信息
    requested_by BIGINT NOT NULL COMMENT '申请人',
    approved_by BIGINT COMMENT '审批人',
    approved_date DATETIME COMMENT '审批日期',
    implementation_date DATE COMMENT '实施日期',
    
    -- 文档信息
    change_document_path VARCHAR(500) COMMENT '变更文档路径',
    supplementary_agreement_path VARCHAR(500) COMMENT '补充协议路径',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (contract_id) REFERENCES contracts(id),
    INDEX idx_contract_id (contract_id),
    INDEX idx_change_number (change_number),
    INDEX idx_change_status (change_status),
    INDEX idx_requested_by (requested_by)
);
```

### 3.7 合同结算记录表 (contract_settlements)
```sql
CREATE TABLE contract_settlements (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    contract_id BIGINT NOT NULL,
    settlement_number VARCHAR(50) NOT NULL COMMENT '结算编号',
    settlement_type ENUM('milestone', 'periodic', 'final', 'advance') NOT NULL COMMENT '结算类型',
    settlement_period VARCHAR(50) COMMENT '结算周期',
    settlement_amount DECIMAL(15,2) NOT NULL COMMENT '结算金额',
    tax_amount DECIMAL(15,2) COMMENT '税额',
    total_amount DECIMAL(15,2) NOT NULL COMMENT '总金额',
    settlement_status ENUM('draft', 'submitted', 'approved', 'paid', 'completed') DEFAULT 'draft' COMMENT '结算状态',
    
    -- 结算明细
    work_completed TEXT COMMENT '已完成工作',
    deliverables_accepted TEXT COMMENT '已验收交付物',
    milestone_achieved VARCHAR(200) COMMENT '达成里程碑',
    
    -- 发票信息
    invoice_required BOOLEAN DEFAULT TRUE COMMENT '是否需要发票',
    invoice_type ENUM('vat_special', 'vat_ordinary', 'receipt') COMMENT '发票类型',
    invoice_title VARCHAR(200) COMMENT '发票抬头',
    invoice_number VARCHAR(50) COMMENT '发票号码',
    invoice_date DATE COMMENT '开票日期',
    invoice_amount DECIMAL(15,2) COMMENT '发票金额',
    
    -- 付款信息
    payment_method ENUM('bank_transfer', 'check', 'cash', 'letter_of_credit') COMMENT '付款方式',
    payment_account VARCHAR(100) COMMENT '收款账户',
    payment_date DATE COMMENT '付款日期',
    payment_reference VARCHAR(100) COMMENT '付款凭证号',
    
    -- 审批信息
    submitted_by BIGINT NOT NULL COMMENT '提交人',
    approved_by BIGINT COMMENT '审批人',
    approved_date DATETIME COMMENT '审批日期',
    
    remarks TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (contract_id) REFERENCES contracts(id),
    INDEX idx_contract_id (contract_id),
    INDEX idx_settlement_number (settlement_number),
    INDEX idx_settlement_status (settlement_status),
    INDEX idx_settlement_type (settlement_type)
);
```

## 4. API接口设计

### 4.1 合同管理接口

#### 4.1.1 合同查询
```http
GET /api/v1/contracts
GET /api/v1/contracts/{id}
GET /api/v1/contracts/search?keyword={keyword}&status={status}&type={type}
GET /api/v1/contracts/by_customer/{customer_id}
GET /api/v1/contracts/expiring?days={days}
```

#### 4.1.2 合同操作
```http
POST /api/v1/contracts
PUT /api/v1/contracts/{id}
DELETE /api/v1/contracts/{id}
POST /api/v1/contracts/{id}/submit
POST /api/v1/contracts/{id}/sign
PUT /api/v1/contracts/{id}/status
```

### 4.2 合同模板接口

#### 4.2.1 模板管理
```http
GET /api/v1/contracts/templates
POST /api/v1/contracts/templates
PUT /api/v1/contracts/templates/{id}
POST /api/v1/contracts/templates/{id}/generate
GET /api/v1/contracts/templates/by_type/{type}
```

### 4.3 合同审批接口

#### 4.3.1 审批流程
```http
GET /api/v1/contracts/{id}/approvals
POST /api/v1/contracts/{id}/approvals
PUT /api/v1/contracts/approvals/{id}/approve
PUT /api/v1/contracts/approvals/{id}/reject
GET /api/v1/contracts/approvals/pending
```

### 4.4 合同执行接口

#### 4.4.1 执行监控
```http
GET /api/v1/contracts/{id}/executions
POST /api/v1/contracts/{id}/executions
PUT /api/v1/contracts/executions/{id}
POST /api/v1/contracts/executions/{id}/complete
GET /api/v1/contracts/executions/overdue
```

### 4.5 合同变更接口

#### 4.5.1 变更管理
```http
GET /api/v1/contracts/{id}/changes
POST /api/v1/contracts/{id}/changes
PUT /api/v1/contracts/changes/{id}
POST /api/v1/contracts/changes/{id}/approve
POST /api/v1/contracts/changes/{id}/implement
```

### 4.6 合同结算接口

#### 4.6.1 结算管理
```http
GET /api/v1/contracts/{id}/settlements
POST /api/v1/contracts/{id}/settlements
PUT /api/v1/contracts/settlements/{id}
POST /api/v1/contracts/settlements/{id}/approve
POST /api/v1/contracts/settlements/{id}/pay
```

## 5. 业务规则

### 5.1 合同审批规则
- **金额≥100万**：需要总经理审批
- **金额≥50万**：需要部门总监审批
- **金额≥10万**：需要部门经理审批
- **所有合同**：需要法务审核

### 5.2 合同变更规则
- **金额变更≥10%**：需要重新审批
- **交期延长≥30天**：需要客户确认
- **重要条款变更**：需要法务审核
- **变更累计≥3次**：需要升级审批

### 5.3 结算规则
- **里程碑结算**：按完成进度结算
- **定期结算**：按约定周期结算
- **最终结算**：项目完成后结算
- **预付款**：合同签署后支付

### 5.4 风险控制规则
- **高风险合同**：加强监控和审核
- **逾期合同**：自动预警和升级
- **异常变更**：触发风险评估
- **付款逾期**：启动催收流程

## 6. 集成设计

### 6.1 与订单管理集成
- 大额订单自动生成合同
- 合同状态影响订单执行
- 订单变更触发合同变更

### 6.2 与客户管理集成
- 客户信息自动填充合同
- 合同历史影响客户信用
- 客户等级影响合同条款

### 6.3 与财务管理集成
- 合同金额影响财务预算
- 结算信息同步财务系统
- 发票管理与合同关联

### 6.4 与项目管理集成
- 合同里程碑对应项目节点
- 项目进度影响合同执行
- 项目变更触发合同变更

## 7. 性能优化

### 7.1 缓存策略
- **合同基础信息**：Redis缓存，TTL 2小时
- **合同模板**：Redis缓存，TTL 24小时
- **审批流程配置**：本地缓存，TTL 1小时

### 7.2 数据库优化
- 合同表按年份分区
- 执行记录表按合同ID分区
- 历史数据定期归档

### 7.3 文档处理优化
- 合同文档异步生成
- 大文件分片上传
- 文档预览缓存

## 8. 监控告警

### 8.1 业务监控
- 合同到期提醒
- 审批超时预警
- 执行进度监控
- 结算逾期告警

### 8.2 系统监控
- 文档生成性能监控
- 电子签署状态监控
- 数据同步监控
- 存储空间监控

## 9. 安全设计

### 9.1 数据安全
- 合同内容加密存储
- 敏感信息脱敏显示
- 文档数字签名验证
- 访问权限严格控制

### 9.2 操作安全
- 关键操作双重验证
- 完整操作审计日志
- 数据修改版本控制
- 异常操作实时告警

### 9.3 合规安全
- 电子签名法律效力
- 数据保留期限管理
- 隐私信息保护
- 跨境数据传输合规

## 10. 扩展性设计

### 10.1 多语言支持
- 合同模板多语言版本
- 界面国际化支持
- 法律条款本地化
- 多币种金额处理

### 10.2 智能化功能
- AI辅助合同审查
- 智能条款推荐
- 风险自动识别
- 执行进度预测

### 10.3 第三方集成
- 电子签名平台集成
- 法律数据库对接
- 企业征信系统集成
- 政府监管平台对接
