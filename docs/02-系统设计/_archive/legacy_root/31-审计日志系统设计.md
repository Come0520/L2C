# 审计日志系统设计

## 1. 概述

### 1.1 设计目标
- 全面记录系统操作行为，确保可追溯性
- 满足合规性要求（SOX、GDPR、等保等）
- 提供实时监控和异常检测能力
- 支持日志分析和报表生成
- 确保日志数据的完整性和不可篡改性

### 1.2 审计范围
- **用户操作审计**：登录、权限变更、敏感操作
- **数据访问审计**：数据查询、修改、删除、导出
- **系统操作审计**：配置变更、系统维护、备份恢复
- **安全事件审计**：异常登录、权限提升、安全告警
- **业务操作审计**：订单处理、财务操作、合同管理

### 1.3 合规要求
- **数据保护法规**：GDPR、个人信息保护法
- **行业标准**：ISO 27001、SOC 2、等保2.0
- **财务法规**：SOX法案、会计准则
- **内部审计**：内控制度、风险管理

## 2. 系统架构设计

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   业务系统层     │    │   日志收集层     │    │   日志处理层     │
│                 │    │                 │    │                 │
│ - Web应用       │───►│ - 日志代理      │───►│ - 日志解析      │
│ - API服务       │    │ - 消息队列      │    │ - 数据清洗      │
│ - 数据库        │    │ - 缓冲区        │    │ - 格式转换      │
│ - 中间件        │    │ - 负载均衡      │    │ - 数据验证      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   日志存储层     │    │   分析检索层     │    │   展示告警层     │
│                 │    │                 │    │                 │
│ - 时序数据库    │◄───│ - 搜索引擎      │◄───│ - 监控面板      │
│ - 对象存储      │    │ - 分析引擎      │    │ - 告警系统      │
│ - 归档存储      │    │ - 机器学习      │    │ - 报表系统      │
│ - 备份系统      │    │ - 实时计算      │    │ - API接口       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 技术栈选择
- **日志收集**：Fluentd、Logstash、Vector
- **消息队列**：Apache Kafka、RabbitMQ
- **存储系统**：ClickHouse、Elasticsearch、MongoDB
- **分析引擎**：Apache Spark、Flink
- **可视化**：Grafana、Kibana、自研Dashboard
- **告警系统**：Prometheus + Alertmanager

## 3. 数据库设计

### 3.1 审计日志主表 (audit_logs)
```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    log_id VARCHAR(64) NOT NULL UNIQUE COMMENT '日志唯一标识',
    event_time TIMESTAMP(6) NOT NULL COMMENT '事件发生时间',
    log_level ENUM('DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL') NOT NULL COMMENT '日志级别',
    event_type VARCHAR(50) NOT NULL COMMENT '事件类型',
    event_category ENUM('security', 'business', 'system', 'data', 'compliance') NOT NULL COMMENT '事件分类',
    source_system VARCHAR(50) NOT NULL COMMENT '来源系统',
    source_module VARCHAR(50) COMMENT '来源模块',
    user_id BIGINT COMMENT '操作用户ID',
    username VARCHAR(100) COMMENT '用户名',
    session_id VARCHAR(100) COMMENT '会话ID',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    request_id VARCHAR(64) COMMENT '请求ID',
    operation VARCHAR(100) NOT NULL COMMENT '操作类型',
    resource_type VARCHAR(50) COMMENT '资源类型',
    resource_id VARCHAR(100) COMMENT '资源ID',
    old_value JSON COMMENT '变更前值',
    new_value JSON COMMENT '变更后值',
    result ENUM('success', 'failure', 'partial') NOT NULL COMMENT '操作结果',
    error_code VARCHAR(20) COMMENT '错误代码',
    error_message TEXT COMMENT '错误信息',
    duration_ms INT COMMENT '操作耗时(毫秒)',
    data_size BIGINT COMMENT '数据大小(字节)',
    risk_level ENUM('low', 'medium', 'high', 'critical') DEFAULT 'low' COMMENT '风险级别',
    compliance_tags JSON COMMENT '合规标签',
    business_context JSON COMMENT '业务上下文',
    technical_context JSON COMMENT '技术上下文',
    checksum VARCHAR(64) NOT NULL COMMENT '日志校验和',
    signature TEXT COMMENT '数字签名',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_event_time (event_time),
    INDEX idx_event_type (event_type),
    INDEX idx_event_category (event_category),
    INDEX idx_user_id (user_id),
    INDEX idx_session_id (session_id),
    INDEX idx_ip_address (ip_address),
    INDEX idx_operation (operation),
    INDEX idx_resource (resource_type, resource_id),
    INDEX idx_result (result),
    INDEX idx_risk_level (risk_level),
    INDEX idx_checksum (checksum)
);
```

### 3.2 用户会话审计表 (session_audit_logs)
```sql
CREATE TABLE session_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(100) NOT NULL COMMENT '会话ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    username VARCHAR(100) NOT NULL COMMENT '用户名',
    login_time TIMESTAMP NOT NULL COMMENT '登录时间',
    logout_time TIMESTAMP NULL COMMENT '登出时间',
    login_method ENUM('password', 'sso', 'oauth', 'api_key', 'certificate') NOT NULL COMMENT '登录方式',
    ip_address VARCHAR(45) NOT NULL COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    device_fingerprint VARCHAR(100) COMMENT '设备指纹',
    location_info JSON COMMENT '地理位置信息',
    session_status ENUM('active', 'expired', 'terminated', 'timeout') NOT NULL COMMENT '会话状态',
    login_result ENUM('success', 'failure') NOT NULL COMMENT '登录结果',
    failure_reason VARCHAR(200) COMMENT '失败原因',
    mfa_used BOOLEAN DEFAULT FALSE COMMENT '是否使用多因子认证',
    risk_score DECIMAL(3,2) DEFAULT 0.00 COMMENT '风险评分',
    anomaly_flags JSON COMMENT '异常标记',
    session_duration INT COMMENT '会话时长(秒)',
    page_views INT DEFAULT 0 COMMENT '页面访问次数',
    api_calls INT DEFAULT 0 COMMENT 'API调用次数',
    data_accessed BIGINT DEFAULT 0 COMMENT '访问数据量(字节)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_login_time (login_time),
    INDEX idx_ip_address (ip_address),
    INDEX idx_session_status (session_status),
    INDEX idx_risk_score (risk_score)
);
```

### 3.3 数据访问审计表 (data_access_audit_logs)
```sql
CREATE TABLE data_access_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    access_id VARCHAR(64) NOT NULL UNIQUE COMMENT '访问唯一标识',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    session_id VARCHAR(100) COMMENT '会话ID',
    access_time TIMESTAMP(6) NOT NULL COMMENT '访问时间',
    access_type ENUM('read', 'write', 'delete', 'export', 'import', 'backup', 'restore') NOT NULL COMMENT '访问类型',
    data_source VARCHAR(100) NOT NULL COMMENT '数据源',
    database_name VARCHAR(100) COMMENT '数据库名',
    table_name VARCHAR(100) COMMENT '表名',
    record_count INT COMMENT '记录数量',
    field_list JSON COMMENT '访问字段列表',
    sensitive_fields JSON COMMENT '敏感字段列表',
    query_sql TEXT COMMENT 'SQL查询语句',
    query_conditions JSON COMMENT '查询条件',
    data_classification ENUM('public', 'internal', 'confidential', 'restricted') COMMENT '数据分类',
    access_purpose VARCHAR(200) COMMENT '访问目的',
    approval_required BOOLEAN DEFAULT FALSE COMMENT '是否需要审批',
    approval_status ENUM('pending', 'approved', 'rejected') COMMENT '审批状态',
    approver_id BIGINT COMMENT '审批人ID',
    data_size BIGINT COMMENT '数据大小(字节)',
    export_format VARCHAR(20) COMMENT '导出格式',
    export_destination VARCHAR(200) COMMENT '导出目标',
    encryption_used BOOLEAN DEFAULT FALSE COMMENT '是否使用加密',
    masking_applied BOOLEAN DEFAULT FALSE COMMENT '是否应用脱敏',
    access_result ENUM('success', 'failure', 'partial') NOT NULL COMMENT '访问结果',
    error_message TEXT COMMENT '错误信息',
    duration_ms INT COMMENT '访问耗时(毫秒)',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_access_time (access_time),
    INDEX idx_access_type (access_type),
    INDEX idx_data_source (data_source),
    INDEX idx_table_name (table_name),
    INDEX idx_data_classification (data_classification),
    INDEX idx_access_result (access_result)
);
```

### 3.4 系统操作审计表 (system_operation_audit_logs)
```sql
CREATE TABLE system_operation_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    operation_id VARCHAR(64) NOT NULL UNIQUE COMMENT '操作唯一标识',
    operator_id BIGINT COMMENT '操作员ID',
    operator_name VARCHAR(100) COMMENT '操作员姓名',
    operation_time TIMESTAMP(6) NOT NULL COMMENT '操作时间',
    operation_type ENUM('config_change', 'deployment', 'maintenance', 'backup', 'restore', 'security', 'monitoring') NOT NULL COMMENT '操作类型',
    operation_category VARCHAR(50) NOT NULL COMMENT '操作分类',
    target_system VARCHAR(100) NOT NULL COMMENT '目标系统',
    target_component VARCHAR(100) COMMENT '目标组件',
    operation_description TEXT NOT NULL COMMENT '操作描述',
    config_before JSON COMMENT '变更前配置',
    config_after JSON COMMENT '变更后配置',
    operation_script TEXT COMMENT '操作脚本',
    execution_environment VARCHAR(50) COMMENT '执行环境',
    approval_required BOOLEAN DEFAULT TRUE COMMENT '是否需要审批',
    approval_workflow_id VARCHAR(100) COMMENT '审批流程ID',
    approver_list JSON COMMENT '审批人列表',
    operation_result ENUM('success', 'failure', 'partial', 'rollback') NOT NULL COMMENT '操作结果',
    error_details TEXT COMMENT '错误详情',
    rollback_info JSON COMMENT '回滚信息',
    impact_assessment TEXT COMMENT '影响评估',
    risk_level ENUM('low', 'medium', 'high', 'critical') NOT NULL COMMENT '风险级别',
    downtime_duration INT COMMENT '停机时长(分钟)',
    affected_users INT COMMENT '影响用户数',
    business_impact TEXT COMMENT '业务影响',
    recovery_time INT COMMENT '恢复时间(分钟)',
    lessons_learned TEXT COMMENT '经验教训',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_operator_id (operator_id),
    INDEX idx_operation_time (operation_time),
    INDEX idx_operation_type (operation_type),
    INDEX idx_target_system (target_system),
    INDEX idx_operation_result (operation_result),
    INDEX idx_risk_level (risk_level)
);
```

### 3.5 安全事件审计表 (security_event_audit_logs)
```sql
CREATE TABLE security_event_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    event_id VARCHAR(64) NOT NULL UNIQUE COMMENT '事件唯一标识',
    event_time TIMESTAMP(6) NOT NULL COMMENT '事件时间',
    event_type ENUM('intrusion_attempt', 'privilege_escalation', 'data_breach', 'malware', 'ddos', 'unauthorized_access', 'policy_violation') NOT NULL COMMENT '事件类型',
    severity_level ENUM('low', 'medium', 'high', 'critical') NOT NULL COMMENT '严重级别',
    threat_level ENUM('info', 'low', 'medium', 'high', 'critical') NOT NULL COMMENT '威胁级别',
    source_ip VARCHAR(45) COMMENT '源IP地址',
    target_ip VARCHAR(45) COMMENT '目标IP地址',
    source_port INT COMMENT '源端口',
    target_port INT COMMENT '目标端口',
    protocol VARCHAR(20) COMMENT '协议类型',
    user_id BIGINT COMMENT '相关用户ID',
    session_id VARCHAR(100) COMMENT '会话ID',
    attack_vector VARCHAR(100) COMMENT '攻击向量',
    attack_signature TEXT COMMENT '攻击特征',
    payload_data TEXT COMMENT '载荷数据',
    detection_method VARCHAR(100) COMMENT '检测方法',
    detection_rule VARCHAR(200) COMMENT '检测规则',
    false_positive BOOLEAN DEFAULT FALSE COMMENT '是否误报',
    event_description TEXT NOT NULL COMMENT '事件描述',
    affected_assets JSON COMMENT '受影响资产',
    data_compromised BOOLEAN DEFAULT FALSE COMMENT '数据是否泄露',
    response_action VARCHAR(200) COMMENT '响应动作',
    response_time INT COMMENT '响应时间(分钟)',
    incident_id VARCHAR(100) COMMENT '关联事件ID',
    investigation_status ENUM('open', 'investigating', 'resolved', 'closed') DEFAULT 'open' COMMENT '调查状态',
    investigator_id BIGINT COMMENT '调查员ID',
    resolution_details TEXT COMMENT '解决详情',
    lessons_learned TEXT COMMENT '经验教训',
    compliance_impact TEXT COMMENT '合规影响',
    notification_sent BOOLEAN DEFAULT FALSE COMMENT '是否已通知',
    external_reported BOOLEAN DEFAULT FALSE COMMENT '是否外部报告',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_event_time (event_time),
    INDEX idx_event_type (event_type),
    INDEX idx_severity_level (severity_level),
    INDEX idx_threat_level (threat_level),
    INDEX idx_source_ip (source_ip),
    INDEX idx_user_id (user_id),
    INDEX idx_investigation_status (investigation_status)
);
```

### 3.6 合规审计配置表 (compliance_audit_configs)
```sql
CREATE TABLE compliance_audit_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    regulation_name VARCHAR(100) NOT NULL COMMENT '法规名称',
    regulation_code VARCHAR(50) NOT NULL UNIQUE COMMENT '法规代码',
    requirement_id VARCHAR(100) NOT NULL COMMENT '要求ID',
    requirement_description TEXT NOT NULL COMMENT '要求描述',
    audit_scope JSON NOT NULL COMMENT '审计范围',
    audit_frequency ENUM('real_time', 'daily', 'weekly', 'monthly', 'quarterly', 'annually') NOT NULL COMMENT '审计频率',
    retention_period INT NOT NULL COMMENT '保留期限(天)',
    log_level ENUM('DEBUG', 'INFO', 'WARN', 'ERROR') NOT NULL COMMENT '日志级别',
    event_types JSON NOT NULL COMMENT '事件类型列表',
    required_fields JSON NOT NULL COMMENT '必需字段',
    alert_conditions JSON COMMENT '告警条件',
    report_template VARCHAR(200) COMMENT '报告模板',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_regulation_code (regulation_code),
    INDEX idx_audit_frequency (audit_frequency)
);
```

## 4. 日志收集设计

### 4.1 日志收集策略
- **应用层日志**：通过日志框架（如Logback、Log4j）收集
- **中间件日志**：通过Agent或Sidecar模式收集
- **数据库日志**：通过Binlog、WAL等机制收集
- **系统日志**：通过Syslog、Journald等收集
- **网络日志**：通过网络设备和防火墙收集

### 4.2 日志格式标准
```json
{
  "timestamp": "2024-01-15T10:30:45.123Z",
  "logId": "audit-20240115-103045-001",
  "level": "INFO",
  "eventType": "user_login",
  "eventCategory": "security",
  "source": {
    "system": "web-app",
    "module": "auth",
    "version": "1.2.3",
    "hostname": "web-01"
  },
  "user": {
    "id": 12345,
    "username": "john.doe",
    "roles": ["user", "manager"],
    "sessionId": "sess-abc123"
  },
  "request": {
    "id": "req-xyz789",
    "method": "POST",
    "url": "/api/auth/login",
    "ip": "192.168.1.100",
    "userAgent": "Mozilla/5.0...",
    "headers": {
      "content-type": "application/json"
    }
  },
  "operation": {
    "type": "login",
    "resource": "user_account",
    "resourceId": "12345",
    "result": "success",
    "duration": 150
  },
  "data": {
    "oldValue": null,
    "newValue": {
      "lastLoginTime": "2024-01-15T10:30:45.123Z"
    },
    "size": 256
  },
  "security": {
    "riskLevel": "low",
    "anomalyFlags": [],
    "mfaUsed": true
  },
  "compliance": {
    "tags": ["GDPR", "SOX"],
    "dataClassification": "internal"
  },
  "context": {
    "business": {
      "department": "sales",
      "project": "crm"
    },
    "technical": {
      "traceId": "trace-123",
      "spanId": "span-456"
    }
  },
  "checksum": "sha256:abc123...",
  "signature": "digital_signature_here"
}
```

### 4.3 日志收集组件
```typescript
interface AuditLogger {
  // 记录用户操作
  logUserOperation(operation: UserOperation): Promise<void>;
  
  // 记录数据访问
  logDataAccess(access: DataAccess): Promise<void>;
  
  // 记录系统操作
  logSystemOperation(operation: SystemOperation): Promise<void>;
  
  // 记录安全事件
  logSecurityEvent(event: SecurityEvent): Promise<void>;
  
  // 批量记录日志
  logBatch(logs: AuditLog[]): Promise<void>;
  
  // 异步记录日志
  logAsync(log: AuditLog): void;
}

class AuditLoggerImpl implements AuditLogger {
  private messageQueue: MessageQueue;
  private encryptionService: EncryptionService;
  private signatureService: SignatureService;
  
  async logUserOperation(operation: UserOperation): Promise<void> {
    const log = this.buildAuditLog(operation);
    await this.processAndSend(log);
  }
  
  private async processAndSend(log: AuditLog): Promise<void> {
    // 1. 数据验证
    this.validateLog(log);
    
    // 2. 敏感数据脱敏
    this.maskSensitiveData(log);
    
    // 3. 计算校验和
    log.checksum = this.calculateChecksum(log);
    
    // 4. 数字签名
    log.signature = await this.signatureService.sign(log);
    
    // 5. 发送到消息队列
    await this.messageQueue.send('audit-logs', log);
  }
}
```

## 5. 日志存储设计

### 5.1 存储架构
- **热数据存储**：最近30天的日志存储在高性能数据库
- **温数据存储**：30天-1年的日志存储在时序数据库
- **冷数据存储**：1年以上的日志归档到对象存储
- **备份存储**：关键日志多地备份，确保可用性

### 5.2 分区策略
```sql
-- 按时间分区
CREATE TABLE audit_logs (
    -- 字段定义
) PARTITION BY RANGE (YEAR(event_time) * 100 + MONTH(event_time)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    PARTITION p202403 VALUES LESS THAN (202404),
    -- 更多分区...
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 按事件类型分区
CREATE TABLE audit_logs_security (
    -- 安全事件日志
) PARTITION BY LIST (event_category) (
    PARTITION p_security VALUES IN ('security'),
    PARTITION p_business VALUES IN ('business'),
    PARTITION p_system VALUES IN ('system'),
    PARTITION p_data VALUES IN ('data'),
    PARTITION p_compliance VALUES IN ('compliance')
);
```

### 5.3 索引优化
```sql
-- 复合索引
CREATE INDEX idx_user_time ON audit_logs (user_id, event_time);
CREATE INDEX idx_resource_operation ON audit_logs (resource_type, operation, event_time);
CREATE INDEX idx_ip_time ON audit_logs (ip_address, event_time);

-- 覆盖索引
CREATE INDEX idx_security_events ON audit_logs (event_category, risk_level, event_time) 
INCLUDE (user_id, operation, resource_type);

-- 函数索引
CREATE INDEX idx_event_date ON audit_logs ((DATE(event_time)));
CREATE INDEX idx_user_hash ON audit_logs ((HASH(user_id, ip_address)));
```

## 6. 日志分析设计

### 6.1 实时分析
```typescript
interface RealTimeAnalyzer {
  // 异常检测
  detectAnomalies(logs: AuditLog[]): Promise<Anomaly[]>;
  
  // 风险评估
  assessRisk(log: AuditLog): Promise<RiskAssessment>;
  
  // 模式识别
  identifyPatterns(logs: AuditLog[]): Promise<Pattern[]>;
  
  // 关联分析
  correlateEvents(logs: AuditLog[]): Promise<CorrelatedEvent[]>;
}

class SecurityAnalyzer implements RealTimeAnalyzer {
  async detectAnomalies(logs: AuditLog[]): Promise<Anomaly[]> {
    const anomalies: Anomaly[] = [];
    
    // 1. 异常登录检测
    const loginAnomalies = this.detectLoginAnomalies(logs);
    anomalies.push(...loginAnomalies);
    
    // 2. 权限异常检测
    const privilegeAnomalies = this.detectPrivilegeAnomalies(logs);
    anomalies.push(...privilegeAnomalies);
    
    // 3. 数据访问异常检测
    const dataAccessAnomalies = this.detectDataAccessAnomalies(logs);
    anomalies.push(...dataAccessAnomalies);
    
    return anomalies;
  }
  
  private detectLoginAnomalies(logs: AuditLog[]): Anomaly[] {
    // 检测异常登录模式
    // - 异常时间登录
    // - 异常地点登录
    // - 频繁失败登录
    // - 多设备同时登录
    return [];
  }
}
```

### 6.2 批量分析
```sql
-- 用户行为分析
SELECT 
    user_id,
    DATE(event_time) as log_date,
    COUNT(*) as operation_count,
    COUNT(DISTINCT resource_type) as resource_types,
    COUNT(CASE WHEN result = 'failure' THEN 1 END) as failure_count,
    AVG(duration_ms) as avg_duration,
    MAX(risk_level) as max_risk_level
FROM audit_logs 
WHERE event_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY user_id, DATE(event_time)
HAVING failure_count > 10 OR max_risk_level = 'critical';

-- 数据访问模式分析
SELECT 
    table_name,
    access_type,
    data_classification,
    COUNT(*) as access_count,
    COUNT(DISTINCT user_id) as unique_users,
    SUM(data_size) as total_data_size,
    AVG(duration_ms) as avg_duration
FROM data_access_audit_logs 
WHERE access_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY table_name, access_type, data_classification
ORDER BY access_count DESC;

-- 安全事件趋势分析
SELECT 
    DATE(event_time) as event_date,
    event_type,
    severity_level,
    COUNT(*) as event_count,
    COUNT(CASE WHEN false_positive = FALSE THEN 1 END) as real_events
FROM security_event_audit_logs 
WHERE event_time >= DATE_SUB(NOW(), INTERVAL 90 DAY)
GROUP BY DATE(event_time), event_type, severity_level
ORDER BY event_date DESC, event_count DESC;
```

## 7. 告警监控设计

### 7.1 告警规则配置
```json
{
  "alertRules": [
    {
      "id": "failed_login_threshold",
      "name": "登录失败次数告警",
      "description": "用户在5分钟内登录失败超过5次",
      "category": "security",
      "severity": "high",
      "condition": {
        "timeWindow": "5m",
        "query": "SELECT user_id FROM session_audit_logs WHERE login_result = 'failure' AND login_time >= NOW() - INTERVAL 5 MINUTE GROUP BY user_id HAVING COUNT(*) > 5"
      },
      "actions": [
        {
          "type": "email",
          "recipients": ["security@company.com"],
          "template": "failed_login_alert"
        },
        {
          "type": "webhook",
          "url": "https://api.company.com/security/alerts",
          "method": "POST"
        }
      ]
    },
    {
      "id": "privilege_escalation",
      "name": "权限提升告警",
      "description": "检测到权限提升操作",
      "category": "security",
      "severity": "critical",
      "condition": {
        "timeWindow": "1m",
        "query": "SELECT * FROM audit_logs WHERE operation = 'privilege_grant' AND risk_level = 'critical'"
      },
      "actions": [
        {
          "type": "sms",
          "recipients": ["+86138****1234"],
          "message": "检测到权限提升操作，请立即检查"
        }
      ]
    }
  ]
}
```

### 7.2 告警处理流程
```typescript
interface AlertManager {
  // 创建告警
  createAlert(rule: AlertRule, triggerData: any): Promise<Alert>;
  
  // 发送告警
  sendAlert(alert: Alert): Promise<void>;
  
  // 确认告警
  acknowledgeAlert(alertId: string, userId: number): Promise<void>;
  
  // 关闭告警
  closeAlert(alertId: string, resolution: string): Promise<void>;
  
  // 升级告警
  escalateAlert(alertId: string, escalationLevel: number): Promise<void>;
}

class AlertManagerImpl implements AlertManager {
  async createAlert(rule: AlertRule, triggerData: any): Promise<Alert> {
    const alert: Alert = {
      id: this.generateAlertId(),
      ruleId: rule.id,
      severity: rule.severity,
      status: 'open',
      triggerTime: new Date(),
      triggerData: triggerData,
      description: this.buildDescription(rule, triggerData)
    };
    
    await this.saveAlert(alert);
    await this.sendAlert(alert);
    
    return alert;
  }
  
  async sendAlert(alert: Alert): Promise<void> {
    const rule = await this.getAlertRule(alert.ruleId);
    
    for (const action of rule.actions) {
      switch (action.type) {
        case 'email':
          await this.emailService.send(action.recipients, alert);
          break;
        case 'sms':
          await this.smsService.send(action.recipients, alert);
          break;
        case 'webhook':
          await this.webhookService.call(action.url, alert);
          break;
      }
    }
  }
}
```

## 8. 合规性报告

### 8.1 报告模板
```typescript
interface ComplianceReport {
  // 生成GDPR合规报告
  generateGDPRReport(startDate: Date, endDate: Date): Promise<GDPRReport>;
  
  // 生成SOX合规报告
  generateSOXReport(startDate: Date, endDate: Date): Promise<SOXReport>;
  
  // 生成等保合规报告
  generateDengBaoReport(startDate: Date, endDate: Date): Promise<DengBaoReport>;
  
  // 生成自定义报告
  generateCustomReport(template: ReportTemplate, parameters: any): Promise<Report>;
}

interface GDPRReport {
  reportId: string;
  period: DateRange;
  dataProcessingActivities: DataProcessingActivity[];
  dataSubjectRequests: DataSubjectRequest[];
  dataBreaches: DataBreach[];
  consentManagement: ConsentRecord[];
  dataTransfers: DataTransfer[];
  complianceScore: number;
  recommendations: string[];
}
```

### 8.2 报告生成
```sql
-- GDPR数据处理活动报告
SELECT 
    'data_processing' as activity_type,
    resource_type as data_category,
    operation as processing_purpose,
    COUNT(*) as processing_count,
    COUNT(DISTINCT user_id) as processors_count,
    MIN(event_time) as first_processing,
    MAX(event_time) as last_processing
FROM audit_logs 
WHERE event_time BETWEEN ? AND ?
    AND event_category = 'data'
    AND compliance_tags LIKE '%GDPR%'
GROUP BY resource_type, operation;

-- SOX财务操作报告
SELECT 
    user_id,
    username,
    operation,
    resource_type,
    COUNT(*) as operation_count,
    SUM(CASE WHEN result = 'failure' THEN 1 ELSE 0 END) as failure_count,
    GROUP_CONCAT(DISTINCT ip_address) as access_ips
FROM audit_logs 
WHERE event_time BETWEEN ? AND ?
    AND (resource_type IN ('financial_data', 'accounting_record', 'audit_trail')
         OR compliance_tags LIKE '%SOX%')
GROUP BY user_id, username, operation, resource_type
ORDER BY operation_count DESC;
```

## 9. 性能优化

### 9.1 写入优化
- **批量写入**：收集多条日志后批量写入数据库
- **异步处理**：使用消息队列异步处理日志写入
- **分库分表**：按时间或业务维度分库分表
- **写入缓冲**：使用内存缓冲区减少磁盘I/O

### 9.2 查询优化
- **索引优化**：为常用查询字段创建合适索引
- **查询缓存**：缓存常用查询结果
- **分区查询**：利用分区剪枝提高查询效率
- **预聚合**：预先计算常用统计指标

### 9.3 存储优化
- **数据压缩**：使用压缩算法减少存储空间
- **冷热分离**：热数据和冷数据分别存储
- **自动归档**：定期将历史数据归档到低成本存储
- **数据清理**：定期清理过期和无用数据

## 10. 安全保护

### 10.1 日志完整性
- **数字签名**：对关键日志进行数字签名
- **校验和**：计算日志校验和防止篡改
- **区块链**：使用区块链技术保证日志不可篡改
- **时间戳**：使用可信时间戳服务

### 10.2 访问控制
- **最小权限**：用户只能访问必要的日志
- **角色权限**：基于角色控制日志访问权限
- **审计追踪**：记录日志访问操作
- **数据脱敏**：敏感日志数据脱敏显示

### 10.3 传输安全
- **TLS加密**：日志传输使用TLS加密
- **VPN隧道**：跨网络传输使用VPN
- **证书认证**：使用数字证书进行身份认证
- **消息签名**：对传输消息进行签名验证

## 11. 运维管理

### 11.1 容量规划
- **存储容量**：根据日志量规划存储容量
- **网络带宽**：评估日志传输带宽需求
- **计算资源**：规划日志处理计算资源
- **扩容策略**：制定自动扩容策略

### 11.2 监控告警
- **系统监控**：监控日志系统健康状态
- **性能监控**：监控日志处理性能指标
- **容量监控**：监控存储和网络容量
- **错误监控**：监控系统错误和异常

### 11.3 备份恢复
- **定期备份**：定期备份关键日志数据
- **异地备份**：重要日志异地备份
- **恢复测试**：定期测试数据恢复流程
- **灾难恢复**：制定灾难恢复预案
