# ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿ - æµ‹è¯•ç­–ç•¥å®Œå–„æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**é¡¹ç›®åç§°ï¼š** ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿæµ‹è¯•ç­–ç•¥  
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2024å¹´  
**è®¾è®¡ç›®æ ‡ï¼š** æ„å»ºå…¨é¢ã€é«˜æ•ˆã€å¯é çš„æµ‹è¯•ä½“ç³»ï¼Œç¡®ä¿ç³»ç»Ÿè´¨é‡  

---

## ğŸ¯ æµ‹è¯•ç›®æ ‡ä¸ä»·å€¼

### 1. æ ¸å¿ƒç›®æ ‡
- **è´¨é‡ä¿éšœ**ï¼šç¡®ä¿ç³»ç»ŸåŠŸèƒ½æ­£ç¡®æ€§å’Œç¨³å®šæ€§
- **é£é™©æ§åˆ¶**ï¼šæå‰å‘ç°å’Œé¢„é˜²æ½œåœ¨é—®é¢˜
- **æ€§èƒ½ä¿è¯**ï¼šéªŒè¯ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- **ç”¨æˆ·ä½“éªŒ**ï¼šä¿è¯è‰¯å¥½çš„ç”¨æˆ·äº¤äº’ä½“éªŒ
- **æŒç»­æ”¹è¿›**ï¼šå»ºç«‹æµ‹è¯•åé¦ˆå’Œä¼˜åŒ–æœºåˆ¶

### 2. æµ‹è¯•åŸåˆ™
- **å·¦ç§»æµ‹è¯•**ï¼šå°½æ—©å‘ç°é—®é¢˜ï¼Œé™ä½ä¿®å¤æˆæœ¬
- **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**ï¼šæé«˜æµ‹è¯•æ•ˆç‡å’Œè¦†ç›–ç‡
- **é£é™©é©±åŠ¨**ï¼šé‡ç‚¹æµ‹è¯•é«˜é£é™©å’Œæ ¸å¿ƒåŠŸèƒ½
- **æŒç»­é›†æˆ**ï¼šæµ‹è¯•ä¸å¼€å‘æµç¨‹æ— ç¼é›†æˆ
- **æ•°æ®é©±åŠ¨**ï¼šåŸºäºæ•°æ®åˆ†æä¼˜åŒ–æµ‹è¯•ç­–ç•¥

---

## ğŸ—ï¸ æµ‹è¯•é‡‘å­—å¡”æ¶æ„

### 1. æµ‹è¯•é‡‘å­—å¡”æ¨¡å‹

```mermaid
graph TD
    A[æ‰‹å·¥æ¢ç´¢æµ‹è¯•] --> B[E2Eæµ‹è¯• 10%]
    B --> C[é›†æˆæµ‹è¯• 20%]
    C --> D[å•å…ƒæµ‹è¯• 70%]
    
    style D fill:#90EE90
    style C fill:#FFE4B5
    style B fill:#FFB6C1
    style A fill:#DDA0DD
```

### 2. å„å±‚æµ‹è¯•ç­–ç•¥

#### 2.1 å•å…ƒæµ‹è¯•ï¼ˆ70%ï¼‰
```typescript
// å•å…ƒæµ‹è¯•ç¤ºä¾‹ - ç”¨æˆ·æœåŠ¡
// backend/src/services/__tests__/user.service.test.ts

import { UserService } from '../user.service';
import { UserRepository } from '../repositories/user.repository';
import { PasswordService } from '../password.service';

describe('UserService', () => {
  let userService: UserService;
  let userRepository: jest.Mocked<UserRepository>;
  let passwordService: jest.Mocked<PasswordService>;

  beforeEach(() => {
    userRepository = {
      findById: jest.fn(),
      findByEmail: jest.fn(),
      create: jest.fn(),
      update: jest.fn(),
      delete: jest.fn(),
    } as any;

    passwordService = {
      hash: jest.fn(),
      verify: jest.fn(),
    } as any;

    userService = new UserService(userRepository, passwordService);
  });

  describe('createUser', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºç”¨æˆ·', async () => {
      // Arrange
      const userData = {
        email: 'test@example.com',
        password: 'password123',
        name: 'æµ‹è¯•ç”¨æˆ·',
      };
      
      const hashedPassword = 'hashed_password';
      const createdUser = { id: 1, ...userData, password: hashedPassword };

      userRepository.findByEmail.mockResolvedValue(null);
      passwordService.hash.mockResolvedValue(hashedPassword);
      userRepository.create.mockResolvedValue(createdUser);

      // Act
      const result = await userService.createUser(userData);

      // Assert
      expect(userRepository.findByEmail).toHaveBeenCalledWith(userData.email);
      expect(passwordService.hash).toHaveBeenCalledWith(userData.password);
      expect(userRepository.create).toHaveBeenCalledWith({
        ...userData,
        password: hashedPassword,
      });
      expect(result).toEqual(createdUser);
    });

    it('å½“é‚®ç®±å·²å­˜åœ¨æ—¶åº”è¯¥æŠ›å‡ºé”™è¯¯', async () => {
      // Arrange
      const userData = {
        email: 'existing@example.com',
        password: 'password123',
        name: 'æµ‹è¯•ç”¨æˆ·',
      };

      userRepository.findByEmail.mockResolvedValue({ id: 1 } as any);

      // Act & Assert
      await expect(userService.createUser(userData)).rejects.toThrow(
        'é‚®ç®±å·²å­˜åœ¨'
      );
    });
  });

  describe('authenticateUser', () => {
    it('åº”è¯¥æˆåŠŸéªŒè¯ç”¨æˆ·', async () => {
      // Arrange
      const email = 'test@example.com';
      const password = 'password123';
      const user = {
        id: 1,
        email,
        password: 'hashed_password',
        name: 'æµ‹è¯•ç”¨æˆ·',
      };

      userRepository.findByEmail.mockResolvedValue(user);
      passwordService.verify.mockResolvedValue(true);

      // Act
      const result = await userService.authenticateUser(email, password);

      // Assert
      expect(userRepository.findByEmail).toHaveBeenCalledWith(email);
      expect(passwordService.verify).toHaveBeenCalledWith(password, user.password);
      expect(result).toEqual({ id: user.id, email: user.email, name: user.name });
    });
  });
});
```

#### 2.2 é›†æˆæµ‹è¯•ï¼ˆ20%ï¼‰
```typescript
// é›†æˆæµ‹è¯•ç¤ºä¾‹ - APIæµ‹è¯•
// backend/src/__tests__/integration/user.api.test.ts

import request from 'supertest';
import { app } from '../../app';
import { DatabaseService } from '../../services/database.service';

describe('User API Integration Tests', () => {
  let databaseService: DatabaseService;

  beforeAll(async () => {
    databaseService = new DatabaseService();
    await databaseService.connect();
    await databaseService.migrate();
  });

  afterAll(async () => {
    await databaseService.disconnect();
  });

  beforeEach(async () => {
    await databaseService.clearTables();
  });

  describe('POST /api/users', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºç”¨æˆ·', async () => {
      const userData = {
        email: 'test@example.com',
        password: 'password123',
        name: 'æµ‹è¯•ç”¨æˆ·',
        role: 'sales',
      };

      const response = await request(app)
        .post('/api/users')
        .send(userData)
        .expect(201);

      expect(response.body).toMatchObject({
        id: expect.any(Number),
        email: userData.email,
        name: userData.name,
        role: userData.role,
        createdAt: expect.any(String),
      });

      expect(response.body.password).toBeUndefined();
    });

    it('åº”è¯¥éªŒè¯å¿…å¡«å­—æ®µ', async () => {
      const response = await request(app)
        .post('/api/users')
        .send({})
        .expect(400);

      expect(response.body.errors).toContain('é‚®ç®±æ˜¯å¿…å¡«é¡¹');
      expect(response.body.errors).toContain('å¯†ç æ˜¯å¿…å¡«é¡¹');
      expect(response.body.errors).toContain('å§“åæ˜¯å¿…å¡«é¡¹');
    });
  });

  describe('POST /api/auth/login', () => {
    beforeEach(async () => {
      // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
      await request(app)
        .post('/api/users')
        .send({
          email: 'test@example.com',
          password: 'password123',
          name: 'æµ‹è¯•ç”¨æˆ·',
          role: 'sales',
        });
    });

    it('åº”è¯¥æˆåŠŸç™»å½•', async () => {
      const response = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'test@example.com',
          password: 'password123',
        })
        .expect(200);

      expect(response.body).toMatchObject({
        token: expect.any(String),
        user: {
          id: expect.any(Number),
          email: 'test@example.com',
          name: 'æµ‹è¯•ç”¨æˆ·',
        },
      });
    });

    it('å¯†ç é”™è¯¯æ—¶åº”è¯¥è¿”å›401', async () => {
      await request(app)
        .post('/api/auth/login')
        .send({
          email: 'test@example.com',
          password: 'wrongpassword',
        })
        .expect(401);
    });
  });
});
```

#### 2.3 ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ10%ï¼‰
```typescript
// E2Eæµ‹è¯•ç¤ºä¾‹ - Cypress
// cypress/e2e/user-management.cy.ts

describe('ç”¨æˆ·ç®¡ç†æµç¨‹', () => {
  beforeEach(() => {
    // é‡ç½®æ•°æ®åº“
    cy.task('db:seed');
    
    // ç™»å½•ç®¡ç†å‘˜è´¦æˆ·
    cy.login('admin@luolai.com', 'admin123');
  });

  it('åº”è¯¥èƒ½å¤Ÿå®Œæˆç”¨æˆ·ç®¡ç†å…¨æµç¨‹', () => {
    // è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢
    cy.visit('/users');
    cy.get('[data-testid="page-title"]').should('contain', 'ç”¨æˆ·ç®¡ç†');

    // åˆ›å»ºæ–°ç”¨æˆ·
    cy.get('[data-testid="add-user-btn"]').click();
    cy.get('[data-testid="user-form"]').should('be.visible');

    cy.get('[data-testid="email-input"]').type('newuser@luolai.com');
    cy.get('[data-testid="name-input"]').type('æ–°ç”¨æˆ·');
    cy.get('[data-testid="role-select"]').select('sales');
    cy.get('[data-testid="password-input"]').type('password123');
    cy.get('[data-testid="confirm-password-input"]').type('password123');

    cy.get('[data-testid="submit-btn"]').click();

    // éªŒè¯ç”¨æˆ·åˆ›å»ºæˆåŠŸ
    cy.get('[data-testid="success-message"]').should('contain', 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
    cy.get('[data-testid="user-table"]').should('contain', 'newuser@luolai.com');

    // ç¼–è¾‘ç”¨æˆ·
    cy.get('[data-testid="user-row"]')
      .contains('newuser@luolai.com')
      .parent()
      .find('[data-testid="edit-btn"]')
      .click();

    cy.get('[data-testid="name-input"]').clear().type('æ›´æ–°ç”¨æˆ·å');
    cy.get('[data-testid="submit-btn"]').click();

    // éªŒè¯ç”¨æˆ·æ›´æ–°æˆåŠŸ
    cy.get('[data-testid="success-message"]').should('contain', 'ç”¨æˆ·æ›´æ–°æˆåŠŸ');
    cy.get('[data-testid="user-table"]').should('contain', 'æ›´æ–°ç”¨æˆ·å');

    // åˆ é™¤ç”¨æˆ·
    cy.get('[data-testid="user-row"]')
      .contains('newuser@luolai.com')
      .parent()
      .find('[data-testid="delete-btn"]')
      .click();

    cy.get('[data-testid="confirm-dialog"]').should('be.visible');
    cy.get('[data-testid="confirm-delete-btn"]').click();

    // éªŒè¯ç”¨æˆ·åˆ é™¤æˆåŠŸ
    cy.get('[data-testid="success-message"]').should('contain', 'ç”¨æˆ·åˆ é™¤æˆåŠŸ');
    cy.get('[data-testid="user-table"]').should('not.contain', 'newuser@luolai.com');
  });

  it('åº”è¯¥éªŒè¯è¡¨å•è¾“å…¥', () => {
    cy.visit('/users');
    cy.get('[data-testid="add-user-btn"]').click();

    // æäº¤ç©ºè¡¨å•
    cy.get('[data-testid="submit-btn"]').click();

    // éªŒè¯é”™è¯¯æ¶ˆæ¯
    cy.get('[data-testid="email-error"]').should('contain', 'é‚®ç®±æ˜¯å¿…å¡«é¡¹');
    cy.get('[data-testid="name-error"]').should('contain', 'å§“åæ˜¯å¿…å¡«é¡¹');
    cy.get('[data-testid="password-error"]').should('contain', 'å¯†ç æ˜¯å¿…å¡«é¡¹');

    // è¾“å…¥æ— æ•ˆé‚®ç®±
    cy.get('[data-testid="email-input"]').type('invalid-email');
    cy.get('[data-testid="submit-btn"]').click();
    cy.get('[data-testid="email-error"]').should('contain', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');

    // è¾“å…¥ä¸åŒ¹é…çš„å¯†ç 
    cy.get('[data-testid="email-input"]').clear().type('valid@email.com');
    cy.get('[data-testid="name-input"]').type('æµ‹è¯•ç”¨æˆ·');
    cy.get('[data-testid="password-input"]').type('password123');
    cy.get('[data-testid="confirm-password-input"]').type('different');
    cy.get('[data-testid="submit-btn"]').click();
    cy.get('[data-testid="confirm-password-error"]').should('contain', 'å¯†ç ä¸åŒ¹é…');
  });
});
```

---

## ğŸš€ æ€§èƒ½æµ‹è¯•ç­–ç•¥

### 1. æ€§èƒ½æµ‹è¯•ç±»å‹

#### 1.1 è´Ÿè½½æµ‹è¯•
```javascript
// K6è´Ÿè½½æµ‹è¯•è„šæœ¬
// performance-tests/load-test.js

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

// è‡ªå®šä¹‰æŒ‡æ ‡
export let errorRate = new Rate('errors');

export let options = {
  stages: [
    { duration: '5m', target: 100 },   // 5åˆ†é’Ÿå†…å¢åŠ åˆ°100ç”¨æˆ·
    { duration: '10m', target: 100 },  // ä¿æŒ100ç”¨æˆ·10åˆ†é’Ÿ
    { duration: '5m', target: 200 },   // 5åˆ†é’Ÿå†…å¢åŠ åˆ°200ç”¨æˆ·
    { duration: '10m', target: 200 },  // ä¿æŒ200ç”¨æˆ·10åˆ†é’Ÿ
    { duration: '5m', target: 0 },     // 5åˆ†é’Ÿå†…å‡å°‘åˆ°0ç”¨æˆ·
  ],
  thresholds: {
    http_req_duration: ['p(95)<2000'],  // 95%çš„è¯·æ±‚åœ¨2ç§’å†…å®Œæˆ
    http_req_failed: ['rate<0.05'],     // é”™è¯¯ç‡å°äº5%
    errors: ['rate<0.1'],               // ä¸šåŠ¡é”™è¯¯ç‡å°äº10%
  },
};

const BASE_URL = 'https://crm-staging.luolai.com';

export function setup() {
  // ç™»å½•è·å–token
  let loginRes = http.post(`${BASE_URL}/api/auth/login`, {
    email: 'test@luolai.com',
    password: 'test123',
  });
  
  return { token: loginRes.json('token') };
}

export default function(data) {
  let params = {
    headers: {
      'Authorization': `Bearer ${data.token}`,
      'Content-Type': 'application/json',
    },
  };

  // æµ‹è¯•åœºæ™¯1ï¼šè·å–çº¿ç´¢åˆ—è¡¨
  let leadsRes = http.get(`${BASE_URL}/api/leads?page=1&limit=20`, params);
  check(leadsRes, {
    'è·å–çº¿ç´¢åˆ—è¡¨çŠ¶æ€ä¸º200': (r) => r.status === 200,
    'è·å–çº¿ç´¢åˆ—è¡¨å“åº”æ—¶é—´<1s': (r) => r.timings.duration < 1000,
  }) || errorRate.add(1);

  sleep(1);

  // æµ‹è¯•åœºæ™¯2ï¼šåˆ›å»ºçº¿ç´¢
  let createLeadRes = http.post(`${BASE_URL}/api/leads`, JSON.stringify({
    name: `æµ‹è¯•çº¿ç´¢_${Date.now()}`,
    phone: '13800138000',
    source: 'website',
    status: 'new',
  }), params);
  
  check(createLeadRes, {
    'åˆ›å»ºçº¿ç´¢çŠ¶æ€ä¸º201': (r) => r.status === 201,
    'åˆ›å»ºçº¿ç´¢å“åº”æ—¶é—´<2s': (r) => r.timings.duration < 2000,
  }) || errorRate.add(1);

  sleep(2);

  // æµ‹è¯•åœºæ™¯3ï¼šæœç´¢çº¿ç´¢
  let searchRes = http.get(`${BASE_URL}/api/leads/search?q=æµ‹è¯•`, params);
  check(searchRes, {
    'æœç´¢çº¿ç´¢çŠ¶æ€ä¸º200': (r) => r.status === 200,
    'æœç´¢çº¿ç´¢å“åº”æ—¶é—´<1.5s': (r) => r.timings.duration < 1500,
  }) || errorRate.add(1);

  sleep(1);
}

export function teardown(data) {
  // æ¸…ç†æµ‹è¯•æ•°æ®
  console.log('æ¸…ç†æµ‹è¯•æ•°æ®...');
}
```

#### 1.2 å‹åŠ›æµ‹è¯•
```javascript
// performance-tests/stress-test.js

import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 },   // æ­£å¸¸è´Ÿè½½
    { duration: '5m', target: 100 },   
    { duration: '2m', target: 200 },   // å¢åŠ è´Ÿè½½
    { duration: '5m', target: 200 },   
    { duration: '2m', target: 300 },   // é«˜è´Ÿè½½
    { duration: '5m', target: 300 },   
    { duration: '2m', target: 400 },   // æé™è´Ÿè½½
    { duration: '5m', target: 400 },   
    { duration: '10m', target: 0 },    // æ¢å¤
  ],
  thresholds: {
    http_req_duration: ['p(99)<5000'],  // 99%çš„è¯·æ±‚åœ¨5ç§’å†…å®Œæˆ
    http_req_failed: ['rate<0.1'],      // é”™è¯¯ç‡å°äº10%
  },
};

const BASE_URL = 'https://crm-staging.luolai.com';

export default function() {
  let response = http.get(`${BASE_URL}/api/health`);
  check(response, {
    'å¥åº·æ£€æŸ¥çŠ¶æ€ä¸º200': (r) => r.status === 200,
  });
}
```

#### 1.3 å®¹é‡æµ‹è¯•
```javascript
// performance-tests/volume-test.js

import http from 'k6/http';
import { check } from 'k6';

export let options = {
  vus: 50,                    // 50ä¸ªè™šæ‹Ÿç”¨æˆ·
  duration: '30m',            // æŒç»­30åˆ†é’Ÿ
  thresholds: {
    http_req_duration: ['p(95)<3000'],
    http_req_failed: ['rate<0.05'],
  },
};

const BASE_URL = 'https://crm-staging.luolai.com';

export default function() {
  // æ¨¡æ‹Ÿå¤§é‡æ•°æ®æ“ä½œ
  let batchData = [];
  for (let i = 0; i < 100; i++) {
    batchData.push({
      name: `æ‰¹é‡çº¿ç´¢_${i}_${Date.now()}`,
      phone: `138${String(Math.random()).substr(2, 8)}`,
      source: 'batch_import',
    });
  }

  let response = http.post(`${BASE_URL}/api/leads/batch`, JSON.stringify({
    leads: batchData
  }), {
    headers: { 'Content-Type': 'application/json' },
  });

  check(response, {
    'æ‰¹é‡åˆ›å»ºçŠ¶æ€ä¸º200': (r) => r.status === 200,
    'æ‰¹é‡åˆ›å»ºå“åº”æ—¶é—´<10s': (r) => r.timings.duration < 10000,
  });
}
```

### 2. æ€§èƒ½ç›‘æ§é…ç½®

#### 2.1 åº”ç”¨æ€§èƒ½ç›‘æ§
```yaml
# APMé…ç½® - New Relic
# newrelic.yml
common: &default_settings
  license_key: '<%= license_key %>'
  app_name: 'CRM System'
  
  # äº‹åŠ¡è¿½è¸ª
  transaction_tracer:
    enabled: true
    transaction_threshold: apdex_f
    record_sql: obfuscated
    stack_trace_threshold: 0.500
    
  # é”™è¯¯æ”¶é›†
  error_collector:
    enabled: true
    capture_source: true
    ignore_errors: "ActionController::RoutingError"
    
  # æµè§ˆå™¨ç›‘æ§
  browser_monitoring:
    auto_instrument: true
    
  # æ•°æ®åº“ç›‘æ§
  slow_sql:
    enabled: true
    use_longer_sql_id: true

production:
  <<: *default_settings
  app_name: 'CRM System (Production)'
  
staging:
  <<: *default_settings
  app_name: 'CRM System (Staging)'
```

#### 2.2 æ•°æ®åº“æ€§èƒ½ç›‘æ§
```sql
-- PostgreSQLæ€§èƒ½ç›‘æ§æŸ¥è¯¢
-- æ…¢æŸ¥è¯¢ç›‘æ§
SELECT 
  query,
  calls,
  total_time,
  mean_time,
  rows,
  100.0 * shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements 
ORDER BY total_time DESC 
LIMIT 10;

-- é”ç­‰å¾…ç›‘æ§
SELECT 
  blocked_locks.pid AS blocked_pid,
  blocked_activity.usename AS blocked_user,
  blocking_locks.pid AS blocking_pid,
  blocking_activity.usename AS blocking_user,
  blocked_activity.query AS blocked_statement,
  blocking_activity.query AS current_statement_in_blocking_process
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;

-- è¿æ¥æ•°ç›‘æ§
SELECT 
  state,
  count(*) 
FROM pg_stat_activity 
GROUP BY state;
```

---

## ğŸ”¥ æ··æ²Œå·¥ç¨‹å®è·µ

### 1. æ··æ²Œå·¥ç¨‹åŸåˆ™

#### 1.1 æ··æ²Œå®éªŒè®¾è®¡
```yaml
# Chaos Engineeringå®éªŒé…ç½®
# chaos-experiments/network-latency.yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-delay-experiment
  namespace: crm-system
spec:
  action: delay
  mode: one
  selector:
    labelSelectors:
      app: crm-backend
  delay:
    latency: "100ms"
    correlation: "100"
    jitter: "0ms"
  duration: "5m"
  scheduler:
    cron: "@every 1h"

---
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: pod-failure-experiment
  namespace: crm-system
spec:
  action: pod-failure
  mode: fixed-percent
  value: "20"
  selector:
    labelSelectors:
      app: crm-backend
  duration: "2m"
  scheduler:
    cron: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ

---
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: cpu-stress-experiment
  namespace: crm-system
spec:
  mode: one
  selector:
    labelSelectors:
      app: crm-backend
  stressors:
    cpu:
      workers: 2
      load: 80
  duration: "3m"
```

#### 1.2 æ··æ²Œå®éªŒè„šæœ¬
```bash
#!/bin/bash
# scripts/chaos-experiment.sh

set -e

NAMESPACE="crm-system"
EXPERIMENT_NAME=${1:-"network-delay-experiment"}
DURATION=${2:-"5m"}

echo "ğŸ”¥ å¼€å§‹æ··æ²Œå·¥ç¨‹å®éªŒ: $EXPERIMENT_NAME"

# æ£€æŸ¥ç³»ç»ŸåŸºçº¿çŠ¶æ€
echo "ğŸ“Š æ£€æŸ¥ç³»ç»ŸåŸºçº¿çŠ¶æ€..."
kubectl get pods -n $NAMESPACE
kubectl top pods -n $NAMESPACE

# è®°å½•å®éªŒå‰çš„å…³é”®æŒ‡æ ‡
echo "ğŸ“ˆ è®°å½•å®éªŒå‰æŒ‡æ ‡..."
BASELINE_RESPONSE_TIME=$(curl -w "%{time_total}" -s -o /dev/null https://crm.luolai.com/api/health)
BASELINE_ERROR_RATE=$(curl -s https://crm.luolai.com/api/metrics | grep error_rate | awk '{print $2}')

echo "åŸºçº¿å“åº”æ—¶é—´: ${BASELINE_RESPONSE_TIME}s"
echo "åŸºçº¿é”™è¯¯ç‡: ${BASELINE_ERROR_RATE}%"

# å¯åŠ¨æ··æ²Œå®éªŒ
echo "ğŸš€ å¯åŠ¨æ··æ²Œå®éªŒ..."
kubectl apply -f chaos-experiments/$EXPERIMENT_NAME.yaml

# ç›‘æ§å®éªŒè¿‡ç¨‹
echo "ğŸ‘€ ç›‘æ§å®éªŒè¿‡ç¨‹..."
for i in {1..10}; do
  sleep 30
  
  # æ£€æŸ¥å“åº”æ—¶é—´
  CURRENT_RESPONSE_TIME=$(curl -w "%{time_total}" -s -o /dev/null https://crm.luolai.com/api/health)
  CURRENT_ERROR_RATE=$(curl -s https://crm.luolai.com/api/metrics | grep error_rate | awk '{print $2}')
  
  echo "ç¬¬${i}æ¬¡æ£€æŸ¥ - å“åº”æ—¶é—´: ${CURRENT_RESPONSE_TIME}s, é”™è¯¯ç‡: ${CURRENT_ERROR_RATE}%"
  
  # æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦ä»ç„¶å¯ç”¨
  if ! curl -f -s https://crm.luolai.com/api/health > /dev/null; then
    echo "âš ï¸  ç³»ç»Ÿä¸å¯ç”¨ï¼Œåœæ­¢å®éªŒ"
    kubectl delete -f chaos-experiments/$EXPERIMENT_NAME.yaml
    exit 1
  fi
done

# åœæ­¢å®éªŒ
echo "ğŸ›‘ åœæ­¢æ··æ²Œå®éªŒ..."
kubectl delete -f chaos-experiments/$EXPERIMENT_NAME.yaml

# ç­‰å¾…ç³»ç»Ÿæ¢å¤
echo "â³ ç­‰å¾…ç³»ç»Ÿæ¢å¤..."
sleep 60

# æ£€æŸ¥ç³»ç»Ÿæ¢å¤çŠ¶æ€
echo "ğŸ” æ£€æŸ¥ç³»ç»Ÿæ¢å¤çŠ¶æ€..."
RECOVERY_RESPONSE_TIME=$(curl -w "%{time_total}" -s -o /dev/null https://crm.luolai.com/api/health)
RECOVERY_ERROR_RATE=$(curl -s https://crm.luolai.com/api/metrics | grep error_rate | awk '{print $2}')

echo "æ¢å¤åå“åº”æ—¶é—´: ${RECOVERY_RESPONSE_TIME}s"
echo "æ¢å¤åé”™è¯¯ç‡: ${RECOVERY_ERROR_RATE}%"

# ç”Ÿæˆå®éªŒæŠ¥å‘Š
echo "ğŸ“‹ ç”Ÿæˆå®éªŒæŠ¥å‘Š..."
cat > chaos-report-$(date +%Y%m%d-%H%M%S).md << EOF
# æ··æ²Œå·¥ç¨‹å®éªŒæŠ¥å‘Š

## å®éªŒä¿¡æ¯
- å®éªŒåç§°: $EXPERIMENT_NAME
- å®éªŒæ—¶é—´: $(date)
- å®éªŒæŒç»­æ—¶é—´: $DURATION

## å®éªŒç»“æœ
- åŸºçº¿å“åº”æ—¶é—´: ${BASELINE_RESPONSE_TIME}s
- å®éªŒæœŸé—´æœ€å¤§å“åº”æ—¶é—´: ${CURRENT_RESPONSE_TIME}s
- æ¢å¤åå“åº”æ—¶é—´: ${RECOVERY_RESPONSE_TIME}s
- åŸºçº¿é”™è¯¯ç‡: ${BASELINE_ERROR_RATE}%
- å®éªŒæœŸé—´æœ€å¤§é”™è¯¯ç‡: ${CURRENT_ERROR_RATE}%
- æ¢å¤åé”™è¯¯ç‡: ${RECOVERY_ERROR_RATE}%

## ç»“è®º
ç³»ç»Ÿåœ¨æ··æ²Œå®éªŒæœŸé—´ä¿æŒäº†åŸºæœ¬çš„å¯ç”¨æ€§ï¼Œè¯æ˜äº†ç³»ç»Ÿçš„å¼¹æ€§èƒ½åŠ›ã€‚
EOF

echo "âœ… æ··æ²Œå·¥ç¨‹å®éªŒå®Œæˆï¼"
```

### 2. æ•…éšœæ³¨å…¥æµ‹è¯•

#### 2.1 æ•°æ®åº“æ•…éšœæ¨¡æ‹Ÿ
```javascript
// tests/chaos/database-failure.test.js

const { Pool } = require('pg');
const request = require('supertest');
const app = require('../../src/app');

describe('æ•°æ®åº“æ•…éšœæµ‹è¯•', () => {
  let originalPool;
  
  beforeAll(() => {
    originalPool = app.get('db');
  });

  afterEach(() => {
    // æ¢å¤æ•°æ®åº“è¿æ¥
    app.set('db', originalPool);
  });

  it('åº”è¯¥åœ¨æ•°æ®åº“è¿æ¥å¤±è´¥æ—¶ä¼˜é›…é™çº§', async () => {
    // æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥å¤±è´¥
    const mockPool = {
      query: jest.fn().mockRejectedValue(new Error('Connection failed')),
    };
    app.set('db', mockPool);

    const response = await request(app)
      .get('/api/leads')
      .expect(503);

    expect(response.body).toMatchObject({
      error: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨',
      message: 'æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
    });
  });

  it('åº”è¯¥åœ¨æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶æ—¶è¿”å›é”™è¯¯', async () => {
    // æ¨¡æ‹ŸæŸ¥è¯¢è¶…æ—¶
    const mockPool = {
      query: jest.fn().mockImplementation(() => 
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Query timeout')), 100)
        )
      ),
    };
    app.set('db', mockPool);

    const response = await request(app)
      .get('/api/leads')
      .expect(504);

    expect(response.body).toMatchObject({
      error: 'è¯·æ±‚è¶…æ—¶',
      message: 'æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',
    });
  });
});
```

#### 2.2 ç½‘ç»œæ•…éšœæ¨¡æ‹Ÿ
```javascript
// tests/chaos/network-failure.test.js

const nock = require('nock');
const request = require('supertest');
const app = require('../../src/app');

describe('ç½‘ç»œæ•…éšœæµ‹è¯•', () => {
  afterEach(() => {
    nock.cleanAll();
  });

  it('åº”è¯¥åœ¨å¤–éƒ¨APIè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨ç¼“å­˜æ•°æ®', async () => {
    // æ¨¡æ‹Ÿå¤–éƒ¨APIå¤±è´¥
    nock('https://api.external-service.com')
      .get('/data')
      .replyWithError('Network error');

    const response = await request(app)
      .get('/api/external-data')
      .expect(200);

    expect(response.body).toMatchObject({
      data: expect.any(Array),
      source: 'cache',
      message: 'å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨ï¼Œè¿”å›ç¼“å­˜æ•°æ®',
    });
  });

  it('åº”è¯¥åœ¨ç½‘ç»œå»¶è¿Ÿæ—¶è®¾ç½®è¶…æ—¶', async () => {
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    nock('https://api.external-service.com')
      .get('/data')
      .delay(5000)
      .reply(200, { data: 'test' });

    const response = await request(app)
      .get('/api/external-data')
      .expect(504);

    expect(response.body).toMatchObject({
      error: 'è¯·æ±‚è¶…æ—¶',
      message: 'å¤–éƒ¨æœåŠ¡å“åº”è¶…æ—¶',
    });
  });
});
```

---

## ğŸ” æµ‹è¯•æ•°æ®ç®¡ç†

### 1. æµ‹è¯•æ•°æ®ç­–ç•¥

#### 1.1 æµ‹è¯•æ•°æ®ç”Ÿæˆ
```typescript
// tests/fixtures/data-factory.ts

import { faker } from '@faker-js/faker';

export class DataFactory {
  static createUser(overrides: Partial<User> = {}): User {
    return {
      id: faker.datatype.number(),
      email: faker.internet.email(),
      name: faker.name.fullName(),
      phone: faker.phone.number(),
      role: faker.helpers.arrayElement(['admin', 'sales', 'manager']),
      status: 'active',
      createdAt: faker.date.past(),
      updatedAt: faker.date.recent(),
      ...overrides,
    };
  }

  static createLead(overrides: Partial<Lead> = {}): Lead {
    return {
      id: faker.datatype.number(),
      name: faker.name.fullName(),
      phone: faker.phone.number(),
      email: faker.internet.email(),
      company: faker.company.name(),
      source: faker.helpers.arrayElement(['website', 'phone', 'referral']),
      status: faker.helpers.arrayElement(['new', 'contacted', 'qualified']),
      assignedTo: faker.datatype.number(),
      createdAt: faker.date.past(),
      updatedAt: faker.date.recent(),
      ...overrides,
    };
  }

  static createOrder(overrides: Partial<Order> = {}): Order {
    return {
      id: faker.datatype.number(),
      orderNumber: faker.random.alphaNumeric(10).toUpperCase(),
      customerId: faker.datatype.number(),
      totalAmount: faker.datatype.number({ min: 100, max: 10000 }),
      status: faker.helpers.arrayElement(['pending', 'confirmed', 'shipped']),
      items: Array.from({ length: faker.datatype.number({ min: 1, max: 5 }) }, () => ({
        productId: faker.datatype.number(),
        quantity: faker.datatype.number({ min: 1, max: 10 }),
        price: faker.datatype.number({ min: 10, max: 1000 }),
      })),
      createdAt: faker.date.past(),
      updatedAt: faker.date.recent(),
      ...overrides,
    };
  }

  static createBatchUsers(count: number): User[] {
    return Array.from({ length: count }, () => this.createUser());
  }

  static createBatchLeads(count: number): Lead[] {
    return Array.from({ length: count }, () => this.createLead());
  }
}
```

#### 1.2 æ•°æ®åº“ç§å­æ•°æ®
```typescript
// tests/seeds/database-seeder.ts

import { DatabaseService } from '../../src/services/database.service';
import { DataFactory } from '../fixtures/data-factory';

export class DatabaseSeeder {
  constructor(private db: DatabaseService) {}

  async seedAll(): Promise<void> {
    await this.clearAll();
    await this.seedUsers();
    await this.seedLeads();
    await this.seedOrders();
  }

  async clearAll(): Promise<void> {
    const tables = [
      'order_items',
      'orders',
      'leads',
      'users',
    ];

    for (const table of tables) {
      await this.db.query(`TRUNCATE TABLE ${table} RESTART IDENTITY CASCADE`);
    }
  }

  async seedUsers(): Promise<void> {
    const users = [
      // å›ºå®šæµ‹è¯•ç”¨æˆ·
      {
        email: 'admin@luolai.com',
        name: 'ç³»ç»Ÿç®¡ç†å‘˜',
        role: 'admin',
        password: 'admin123',
      },
      {
        email: 'sales@luolai.com',
        name: 'é”€å”®ä»£è¡¨',
        role: 'sales',
        password: 'sales123',
      },
      // éšæœºæµ‹è¯•ç”¨æˆ·
      ...DataFactory.createBatchUsers(50),
    ];

    for (const user of users) {
      await this.db.query(
        'INSERT INTO users (email, name, role, password, status) VALUES ($1, $2, $3, $4, $5)',
        [user.email, user.name, user.role, user.password, 'active']
      );
    }
  }

  async seedLeads(): Promise<void> {
    const leads = DataFactory.createBatchLeads(200);
    
    for (const lead of leads) {
      await this.db.query(
        'INSERT INTO leads (name, phone, email, company, source, status, assigned_to) VALUES ($1, $2, $3, $4, $5, $6, $7)',
        [lead.name, lead.phone, lead.email, lead.company, lead.source, lead.status, lead.assignedTo]
      );
    }
  }

  async seedOrders(): Promise<void> {
    const orders = DataFactory.createBatchOrders(100);
    
    for (const order of orders) {
      const orderId = await this.db.query(
        'INSERT INTO orders (order_number, customer_id, total_amount, status) VALUES ($1, $2, $3, $4) RETURNING id',
        [order.orderNumber, order.customerId, order.totalAmount, order.status]
      );

      for (const item of order.items) {
        await this.db.query(
          'INSERT INTO order_items (order_id, product_id, quantity, price) VALUES ($1, $2, $3, $4)',
          [orderId.rows[0].id, item.productId, item.quantity, item.price]
        );
      }
    }
  }
}
```

### 2. æµ‹è¯•ç¯å¢ƒéš”ç¦»

#### 2.1 Dockeræµ‹è¯•ç¯å¢ƒ
```yaml
# docker-compose.test.yml
version: '3.8'

services:
  test-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: crm_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    ports:
      - "5433:5432"
    volumes:
      - test_db_data:/var/lib/postgresql/data
    command: postgres -c log_statement=all

  test-redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - test_redis_data:/data

  test-elasticsearch:
    image: elasticsearch:8.8.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9201:9200"
    volumes:
      - test_es_data:/usr/share/elasticsearch/data

volumes:
  test_db_data:
  test_redis_data:
  test_es_data:
```

---

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šå’ŒæŒ‡æ ‡

### 1. æµ‹è¯•è¦†ç›–ç‡é…ç½®

#### 1.1 Jestè¦†ç›–ç‡é…ç½®
```javascript
// jest.config.js
module.exports = {
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: [
    'text',
    'lcov',
    'html',
    'json-summary',
  ],
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.test.{ts,tsx}',
    '!src/**/*.spec.{ts,tsx}',
    '!src/migrations/**',
    '!src/seeds/**',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
    './src/services/': {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90,
    },
  },
};
```

#### 1.2 SonarQubeè´¨é‡æŠ¥å‘Š
```xml
<!-- sonar-project.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<sonar>
  <property>
    <key>sonar.projectKey</key>
    <value>luolai-crm</value>
  </property>
  <property>
    <key>sonar.projectName</key>
    <value>ç½—è±CRMç³»ç»Ÿ</value>
  </property>
  <property>
    <key>sonar.sources</key>
    <value>src</value>
  </property>
  <property>
    <key>sonar.tests</key>
    <value>tests</value>
  </property>
  <property>
    <key>sonar.javascript.lcov.reportPaths</key>
    <value>coverage/lcov.info</value>
  </property>
  <property>
    <key>sonar.testExecutionReportPaths</key>
    <value>reports/test-results.xml</value>
  </property>
</sonar>
```

### 2. è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š

#### 2.1 æµ‹è¯•æŠ¥å‘Šç”Ÿæˆè„šæœ¬
```bash
#!/bin/bash
# scripts/generate-test-report.sh

set -e

REPORT_DIR="reports"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."

# åˆ›å»ºæŠ¥å‘Šç›®å½•
mkdir -p $REPORT_DIR

# è¿è¡Œå•å…ƒæµ‹è¯•
echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
npm run test:unit -- --coverage --ci --reporters=default --reporters=jest-junit

# è¿è¡Œé›†æˆæµ‹è¯•
echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
npm run test:integration -- --ci --reporters=jest-junit

# è¿è¡ŒE2Eæµ‹è¯•
echo "ğŸ­ è¿è¡ŒE2Eæµ‹è¯•..."
npm run test:e2e -- --reporter junit --reporter-options "mochaFile=$REPORT_DIR/e2e-results.xml"

# è¿è¡Œæ€§èƒ½æµ‹è¯•
echo "ğŸš€ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
k6 run --out json=$REPORT_DIR/performance-results.json performance-tests/load-test.js

# ç”Ÿæˆç»¼åˆæŠ¥å‘Š
echo "ğŸ“‹ ç”Ÿæˆç»¼åˆæŠ¥å‘Š..."
cat > $REPORT_DIR/test-summary-$TIMESTAMP.md << EOF
# æµ‹è¯•æŠ¥å‘Š - $(date)

## æµ‹è¯•æ¦‚è§ˆ
- æµ‹è¯•æ—¶é—´: $(date)
- æµ‹è¯•ç¯å¢ƒ: $CI_ENVIRONMENT_NAME
- ä»£ç ç‰ˆæœ¬: $CI_COMMIT_SHA

## å•å…ƒæµ‹è¯•ç»“æœ
$(cat $REPORT_DIR/unit-test-summary.txt)

## é›†æˆæµ‹è¯•ç»“æœ
$(cat $REPORT_DIR/integration-test-summary.txt)

## E2Eæµ‹è¯•ç»“æœ
$(cat $REPORT_DIR/e2e-test-summary.txt)

## æ€§èƒ½æµ‹è¯•ç»“æœ
$(cat $REPORT_DIR/performance-summary.txt)

## ä»£ç è¦†ç›–ç‡
$(cat coverage/coverage-summary.txt)
EOF

echo "âœ… æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $REPORT_DIR/test-summary-$TIMESTAMP.md"
```

è¿™ä¸ªå®Œæ•´çš„æµ‹è¯•ç­–ç•¥æ–¹æ¡ˆæä¾›äº†ä»å•å…ƒæµ‹è¯•åˆ°æ··æ²Œå·¥ç¨‹çš„å…¨æ–¹ä½æµ‹è¯•ä½“ç³»ï¼Œç¡®ä¿ç³»ç»Ÿçš„è´¨é‡ã€æ€§èƒ½å’Œå¯é æ€§ã€‚
