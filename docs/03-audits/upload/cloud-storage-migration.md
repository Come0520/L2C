# 上传模块云存储迁移架构预案

本方案旨在指导 `upload` 模块从当前的**本地磁盘存储**平滑迁移至**阿里云 OSS 对象存储**，以满足 L5 级别的高可用性、扩展性及性能要求。

## 1. 架构现状
- **存储方式**: 本地 `public/uploads` 目录。
- **隔离级别**: 目录级别根据 `tenantId` 进行硬链接/子目录隔离。
- **性能瓶颈**: 单机 IO 限制，不支持 CDN 加速，缺乏图片处理能力。

## 2. 目标架构 (OSS + CDN)
- **存储服务**: 阿里云 OSS (Object Storage Service)。
- **分发网络**: 阿里云 CDN，绑定租户子域名或统一加速域名。
- **鉴权机制**: 
  - **后端**: STS (Security Token Service) 临时凭证发放（已在 `oss-token.ts` 预留逻辑）。
  - **前端**: 客户端直传 (PostObject)，减少服务器带宽消耗。

## 3. 迁移任务清单
1. **环境准备**:
   - 创建 OSS Bucket。
   - 配置 CORS 规则允许业务域名跨域访问。
   - 创建 RAM 角色并授权 OSS 操作权限，获取 RoleArn。
2. **存量迁移**:
   - 使用 `ossutil` 工具将 `public/uploads` 下所有文件同步至 OSS 指定前缀。
3. **代码切换**:
   - 启用 `oss-token.ts` 中的逻辑。
   - 修改 `upload-button.tsx` 支持 OSS 直传。
   - 更新数据库中的文件 URL 路径。

## 4. 性能与处理策略
- **静态加速**: 全球 CDN 边缘节点缓存。
- **动态处理**: 启用 OSS 图片处理插件（例如：追加 `?x-oss-process=image/resize,w_100` 获取缩略图）。
- **图片压缩**: 配合前端客户端压缩，双重保障链路性能。

## 5. 安全规范
- 严禁在代码中硬编码 AccessKey。
- 所有上传必须通过 STS 临时凭证进行校验。
- 敏感文件存储在私有读 Bucket，通过签名 URL 访问。

## 6. 回滚预案
- 迁移期间保留本地存储双写能力（可选）。
- 切换 DNS/CDN 之前进行全面环境测试。
- 若 OSS 故障，可快速回退至本地存储路径。
