# ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿ - æŠ€æœ¯å®æ–½æ–¹æ¡ˆ (v4.0)

## ğŸ¯ æ–¹æ¡ˆæ¦‚è§ˆ

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v4.0  
**æ›´æ–°æ—¥æœŸï¼š** 2025-11-27  
**æ ¸å¿ƒæ–¹å‘ï¼š** åŸºäº Next.js + Supabase çš„ç°ä»£åŒ–å…¨æ ˆå¼€å‘å®æ–½æ–¹æ¡ˆ

### æ ¸å¿ƒæŒ‘æˆ˜ä¸åº”å¯¹ç­–ç•¥

#### 1. é«˜å¹¶å‘çº¿ç´¢å¤„ç† (High Concurrency)
**æŒ‘æˆ˜æè¿°ï¼š** å¤§ä¿ƒæœŸé—´ï¼ˆå¦‚åŒ11ï¼‰çº¿ç´¢åˆ›å»ºå’ŒæŠ¢å•çš„é«˜å¹¶å‘å†™å…¥ã€‚

**ä¼ ç»Ÿæ–¹æ¡ˆç¼ºé™·ï¼š** å¼•å…¥ Redis/Kafka å¯¼è‡´æ¶æ„å¤æ‚ï¼Œç»´æŠ¤æˆæœ¬é«˜ã€‚

**æ–°å®æ–½æ–¹æ¡ˆï¼š**
*   **æ•°æ®åº“å±‚**ï¼šåˆ©ç”¨ PostgreSQL çš„ `SKIP LOCKED` æœºåˆ¶å®ç°é«˜æ•ˆçš„æŠ¢å•é˜Ÿåˆ—ï¼Œæ— éœ€ Redisã€‚
*   **åº”ç”¨å±‚**ï¼šä½¿ç”¨ Server Actions è¿›è¡ŒåŸå­åŒ–æ“ä½œï¼Œç»“åˆ `useOptimistic` æå‡å‰ç«¯å“åº”é€Ÿåº¦ã€‚
*   **é™æµ**ï¼šåœ¨ Edge Middleware å±‚ä½¿ç”¨ Upstash/Vercel KV è¿›è¡Œ IP çº§åˆ«çš„é€Ÿç‡é™åˆ¶ã€‚

#### 2. å¤æ‚çŠ¶æ€æœºç®¡ç† (State Machine)
**æŒ‘æˆ˜æè¿°ï¼š** è®¢å•ä»"çº¿ç´¢"åˆ°"å®‰è£…å®Œæˆ"æ¶‰åŠ 10+ ä¸ªçŠ¶æ€æµè½¬ï¼Œéœ€ç¡®ä¿åˆæ³•æ€§ã€‚

**æ–°å®æ–½æ–¹æ¡ˆï¼š**
*   **Type-Safe State Machine**ï¼šåˆ©ç”¨ TypeScript çš„ Discriminated Unions å®šä¹‰çŠ¶æ€ã€‚
*   **Database Constraints**ï¼šåœ¨ Postgres ä¸­ä½¿ç”¨ `CHECK` çº¦æŸé˜²æ­¢éæ³•çŠ¶æ€å†™å…¥ã€‚
*   **Centralized Service**ï¼šåœ¨ `src/server/services/order.ts` ä¸­é›†ä¸­ç®¡ç†çŠ¶æ€æµè½¬é€»è¾‘ã€‚

#### 3. æ•°æ®ä¸€è‡´æ€§ (Consistency)
**æŒ‘æˆ˜æè¿°ï¼š** ç§¯åˆ†å‘æ”¾ã€è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡éœ€ä¿æŒäº‹åŠ¡ä¸€è‡´æ€§ã€‚

**æ–°å®æ–½æ–¹æ¡ˆï¼š**
*   **å•ä½“æ•°æ®åº“ä¼˜åŠ¿**ï¼šç”±äºä½¿ç”¨å•ä¸€ Supabase Postgres å®ä¾‹ï¼Œç›´æ¥ä½¿ç”¨ SQL Transaction (`BEGIN...COMMIT`) å³å¯ï¼Œæ— éœ€åˆ†å¸ƒå¼äº‹åŠ¡ (Saga/TCC)ã€‚
*   **Supabase RPC**ï¼šå°†å¤æ‚çš„è·¨è¡¨äº‹åŠ¡å°è£…ä¸º Postgres Functionï¼Œé€šè¿‡ RPC è°ƒç”¨ï¼Œç¡®ä¿åŸå­æ€§ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿå®æ–½æ¶æ„

### 1. æ€»ä½“æ¶æ„å›¾

```mermaid
graph TD
    User[ç”¨æˆ·] --> CDN[Vercel Edge Network]
    
    subgraph "Frontend (Next.js)"
        Page[React Server Components]
        Action[Server Actions]
        Store[Zustand Store]
    end
    
    subgraph "Backend Services (Supabase)"
        PG[(PostgreSQL DB)]
        Auth[GoTrue Auth]
        Realtime[Realtime Engine]
        Storage[S3 Compatible Storage]
    end
    
    CDN --> Page
    Page --> Action
    Action --> PG
    Page -->|Subscription| Realtime
    
    PG -->|Trigger| Realtime
    PG -->|RLS Policy| Auth
```

### 2. æ ¸å¿ƒæ¨¡å—å®æ–½ç»†èŠ‚

#### 2.1 è®¤è¯ä¸æƒé™ (Auth & RLS)

**å®æ–½ä»£ç ç¤ºä¾‹ (Middleware):**
```typescript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })
  
  const { data: { session } } = await supabase.auth.getSession()

  // è·¯ç”±ä¿æŠ¤é€»è¾‘
  if (!session && req.nextUrl.pathname.startsWith('/admin')) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  return res
}
```

**å®æ–½ä»£ç ç¤ºä¾‹ (RLS Policy):**
```sql
-- ä»…å…è®¸æ‹¥æœ‰ 'admin' è§’è‰²çš„ç”¨æˆ·æŸ¥çœ‹æ‰€æœ‰è®¢å•
create policy "Admins can view all orders"
on orders for select
using ( 
  auth.uid() in (
    select user_id from user_roles where role = 'admin'
  )
);
```

#### 2.2 çŠ¶æ€æœºå®ç° (TypeScript)

```typescript
// src/lib/constants/order-status.ts
export const ORDER_STATUS = {
  NEW: 'new',
  ASSIGNED: 'assigned',
  MEASURING: 'measuring',
  QUOTED: 'quoted',
  SIGNED: 'signed',
  PAID: 'paid',
  INSTALLING: 'installing',
  COMPLETED: 'completed',
  CANCELLED: 'cancelled',
} as const

export type OrderStatus = typeof ORDER_STATUS[keyof typeof ORDER_STATUS]

const TRANSITIONS: Record<OrderStatus, OrderStatus[]> = {
  [ORDER_STATUS.NEW]: [ORDER_STATUS.ASSIGNED, ORDER_STATUS.CANCELLED],
  [ORDER_STATUS.ASSIGNED]: [ORDER_STATUS.MEASURING, ORDER_STATUS.CANCELLED],
  // ... å…¶ä»–æµè½¬è§„åˆ™
}

export function canTransition(current: OrderStatus, next: OrderStatus): boolean {
  return TRANSITIONS[current]?.includes(next) ?? false
}
```

#### 2.3 å®æ—¶é€šçŸ¥ (Realtime)

å‰ç«¯ç»„ä»¶è®¢é˜…æ•°æ®åº“å˜æ›´ï¼Œå®ç°æ— åˆ·æ–°é€šçŸ¥ã€‚

```typescript
// src/components/OrderListener.tsx
'use client'
import { useEffect } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { toast } from 'sonner'

export function OrderListener() {
  const supabase = createClientComponentClient()

  useEffect(() => {
    const channel = supabase
      .channel('orders')
      .on('postgres_changes', { 
        event: 'INSERT', 
        schema: 'public', 
        table: 'orders' 
      }, (payload) => {
        toast.success(`æ–°è®¢å•: ${payload.new.order_no}`)
      })
      .subscribe()

    return () => { supabase.removeChannel(channel) }
  }, [supabase])

  return null
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ•°æ®åº“ç´¢å¼•ç­–ç•¥
é’ˆå¯¹é«˜é¢‘æŸ¥è¯¢åœºæ™¯å»ºç«‹ç»„åˆç´¢å¼•ï¼š

```sql
-- ä¼˜åŒ–ï¼šæŒ‰é”€å”®å‘˜æŸ¥è¯¢å¾…å¤„ç†è®¢å•
CREATE INDEX idx_orders_sales_status 
ON orders (sales_id, status) 
WHERE status NOT IN ('completed', 'cancelled');

-- ä¼˜åŒ–ï¼šæŒ‰æ‰‹æœºå·æ¨¡ç³Šæœç´¢çº¿ç´¢
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX idx_leads_phone_trgm 
ON leads USING gin (phone gin_trgm_ops);
```

### 2. Next.js ç¼“å­˜ç­–ç•¥
åˆ©ç”¨ Next.js çš„ Data Cache å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›ã€‚

```typescript
// src/server/actions/get-products.ts
'use server'
import { db } from '@/server/db'

// ç¼“å­˜ 1 å°æ—¶ï¼ŒæŒ‰ 'products' æ ‡ç­¾å¤±æ•ˆ
export async function getProducts() {
  const products = await db.query.products.findMany()
  return products
}

// åœ¨éœ€è¦æ›´æ–°æ—¶è°ƒç”¨
import { revalidateTag } from 'next/cache'
export async function updateProduct(id: string, data: any) {
  await db.update(products).set(data).where(eq(products.id, id))
  revalidateTag('products')
}
```

---

## ğŸš€ éƒ¨ç½²ä¸ç›‘æ§

### 1. éƒ¨ç½²æµç¨‹
*   **Frontend**: Git Push -> Vercel è‡ªåŠ¨æ„å»º -> Edge Network åˆ†å‘ã€‚
*   **Database**: Supabase Dashboard / CLI ç®¡ç† Schema Migrationsã€‚

### 2. ç›‘æ§å‘Šè­¦
*   **Sentry**: æ•è·å‰ç«¯ JS é”™è¯¯å’Œ API å¼‚å¸¸ã€‚
*   **Supabase Dashboard**: ç›‘æ§æ•°æ®åº“ CPUã€å†…å­˜ã€è¿æ¥æ•°ã€‚
*   **Vercel Analytics**: ç›‘æ§ Real User Metrics (LCP, FID, CLS)ã€‚

---
*æ³¨ï¼šæœ¬æ–¹æ¡ˆå®Œå…¨ç§»é™¤ Java/Spring Boot ç›¸å…³ä¾èµ–ï¼Œç»Ÿä¸€ä½¿ç”¨ TypeScript/Node.js æŠ€æœ¯æ ˆã€‚*
