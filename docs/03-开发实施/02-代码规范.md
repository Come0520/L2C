# ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿ - ä»£ç è§„èŒƒæ–‡æ¡£

## ğŸ¯ è§„èŒƒç›®æ ‡ä¸åŸåˆ™

### è§„èŒƒç›®æ ‡
- **å¯è¯»æ€§**ï¼šä»£ç åº”è¯¥åƒæ•£æ–‡ä¸€æ ·æ˜“äºé˜…è¯»å’Œç†è§£
- **å¯ç»´æŠ¤æ€§**ï¼šé™ä½ä»£ç ç»´æŠ¤æˆæœ¬ï¼Œæé«˜å›¢é˜Ÿåä½œæ•ˆç‡
- **ä¸€è‡´æ€§**ï¼šç»Ÿä¸€ç¼–ç é£æ ¼ï¼Œå‡å°‘è®¤çŸ¥è´Ÿæ‹…
- **å¯é æ€§**ï¼šé€šè¿‡è§„èŒƒé¿å…å¸¸è§é”™è¯¯å’Œé™·é˜±
- **æ€§èƒ½**ï¼šåœ¨ä¿è¯å¯è¯»æ€§çš„å‰æä¸‹ä¼˜åŒ–æ€§èƒ½

### è®¾è®¡åŸåˆ™
1. **SOLIDåŸåˆ™**ï¼šå•ä¸€èŒè´£ã€å¼€é—­åŸåˆ™ã€é‡Œæ°æ›¿æ¢ã€æ¥å£éš”ç¦»ã€ä¾èµ–å€’ç½®
2. **DRYåŸåˆ™**ï¼šDon't Repeat Yourselfï¼Œé¿å…é‡å¤ä»£ç 
3. **KISSåŸåˆ™**ï¼šKeep It Simple and Stupidï¼Œä¿æŒç®€å•
4. **YAGNIåŸåˆ™**ï¼šYou Aren't Gonna Need Itï¼Œä¸è¦è¿‡åº¦è®¾è®¡
5. **Clean Code**ï¼šä»£ç å³æ–‡æ¡£ï¼Œè‡ªè§£é‡Šæ€§ä¼˜å…ˆ

## ğŸ“ å‘½åè§„èŒƒ

> **ğŸ“‹ è¯¦ç»†å‘½åè§„èŒƒ**ï¼šæ›´è¯¦ç»†çš„å‘½åè§„èŒƒè¯·å‚è€ƒ [å‘½åè§„èŒƒæ ‡å‡†æ–‡æ¡£](./09-å‘½åè§„èŒƒæ ‡å‡†.md)
> 
> **ğŸ”Œ ç«¯å£åˆ†é…è§„èŒƒ**ï¼šå¼€å‘ç¯å¢ƒç«¯å£åˆ†é…è¯·å‚è€ƒ [ç«¯å£åˆ†é…è§„èŒƒæ–‡æ¡£](./08-ç«¯å£åˆ†é…è§„èŒƒ.md)
> 
> **âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®**ï¼šç¯å¢ƒå˜é‡å’Œé…ç½®ç®¡ç†è¯·å‚è€ƒ [ç¯å¢ƒå˜é‡é…ç½®è§„èŒƒ](./10-ç¯å¢ƒå˜é‡é…ç½®è§„èŒƒ.md)
> 
> **ğŸš¨ é”™è¯¯å¤„ç†è§„èŒƒ**ï¼šé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•è¯·å‚è€ƒ [é”™è¯¯å¤„ç†æ—¥å¿—è§„èŒƒ](./11-é”™è¯¯å¤„ç†æ—¥å¿—è§„èŒƒ.md)
> 
> **ğŸ”’ å®‰å…¨è§„èŒƒ**ï¼šå®‰å…¨å¼€å‘æœ€ä½³å®è·µè¯·å‚è€ƒ [å®‰å…¨è§„èŒƒæœ€ä½³å®è·µ](./12-å®‰å…¨è§„èŒƒæœ€ä½³å®è·µ.md)
> 
> **ğŸ”— APIè®¾è®¡è§„èŒƒ**ï¼šAPIè®¾è®¡å’Œç‰ˆæœ¬ç®¡ç†è¯·å‚è€ƒ [APIè®¾è®¡ç‰ˆæœ¬ç®¡ç†è§„èŒƒ](./13-APIè®¾è®¡ç‰ˆæœ¬ç®¡ç†è§„èŒƒ.md)
> 
> **ğŸ—„ï¸ æ•°æ®åº“è§„èŒƒ**ï¼šæ•°æ®åº“è®¾è®¡å’Œè¿ç§»è¯·å‚è€ƒ [æ•°æ®åº“è®¾è®¡è¿ç§»è§„èŒƒ](./14-æ•°æ®åº“è®¾è®¡è¿ç§»è§„èŒƒ.md)
> 
> **ğŸ“‹ Gitå·¥ä½œæµè§„èŒƒ**ï¼šGitå·¥ä½œæµå’Œä»£ç æäº¤è¯·å‚è€ƒ [Gitå·¥ä½œæµä»£ç æäº¤è§„èŒƒ](./15-Gitå·¥ä½œæµä»£ç æäº¤è§„èŒƒ.md)

### é€šç”¨å‘½åè§„åˆ™
```javascript
// âœ… å¥½çš„å‘½å
class CustomerLeadService {
    static MAX_PAGE_SIZE = 100;
    
    constructor(leadRepository) {
        this.leadRepository = leadRepository;
    }
    
    async searchLeads(criteria, pageable) {
        this.validateSearchCriteria(criteria);
        return await this.leadRepository.findByCriteria(criteria, pageable);
    }
}

// âŒ å·®çš„å‘½å
class CLS {  // ç¼©å†™ä¸æ¸…æ™°
    static mps = 100;  // é­”æ³•æ•°å­—
    
    constructor(repo) {  // è¿‡åº¦ç¼©å†™
        this.repo = repo;
    }
    
    async get(c, p) {  // æ–¹æ³•åä¸æ˜ç¡®
        this.check(c);  // æ–¹æ³•åä¸æ¸…æ™°
        return await this.repo.find(c, p);
    }
}
```

### æ–‡ä»¶å’Œç›®å½•å‘½åè§„èŒƒ
```
// é¡¹ç›®ç»“æ„è§„èŒƒ
src/
â”œâ”€â”€ config/                    // é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ database.js
â”‚   â”œâ”€â”€ redis.js
â”‚   â””â”€â”€ swagger.js
â”œâ”€â”€ controllers/               // æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ leadController.js
â”‚   â”œâ”€â”€ orderController.js
â”‚   â””â”€â”€ customerController.js
â”œâ”€â”€ services/                  // æœåŠ¡å±‚
â”‚   â”œâ”€â”€ leadService.js
â”‚   â”œâ”€â”€ orderService.js
â”‚   â””â”€â”€ pointService.js
â”œâ”€â”€ repositories/              // æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ leadRepository.js
â”‚   â”œâ”€â”€ orderRepository.js
â”‚   â””â”€â”€ userRepository.js
â”œâ”€â”€ models/                    // æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ Lead.js
â”‚   â”œâ”€â”€ Order.js
â”‚   â””â”€â”€ User.js
â”œâ”€â”€ middleware/                // ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ validation.js
â”‚   â””â”€â”€ errorHandler.js
â”œâ”€â”€ utils/                     // å·¥å…·ç±»
â”‚   â”œâ”€â”€ dateUtils.js
â”‚   â”œâ”€â”€ cryptoUtils.js
â”‚   â””â”€â”€ responseUtils.js
â””â”€â”€ constants/                 // å¸¸é‡å®šä¹‰
    â”œâ”€â”€ statusCodes.js
    â”œâ”€â”€ errorMessages.js
    â””â”€â”€ businessRules.js
```

### å˜é‡å’Œå‡½æ•°å‘½åè§„èŒƒ
```javascript
// âœ… å˜é‡å‘½åè§„èŒƒ
const leadId = 123;                    // IDå­—æ®µ
const customerName = 'å¼ ä¸‰';           // å®¢æˆ·å§“å
const customerPhone = '13800138000';   // å®¢æˆ·ç”µè¯
const budgetAmount = 50000;            // é¢„ç®—é‡‘é¢
const createdAt = new Date();          // åˆ›å»ºæ—¶é—´
const isQualified = true;              // å¸ƒå°”å€¼ï¼šæ˜¯å¦åˆæ ¼

// é›†åˆç±»å‹ï¼šä½¿ç”¨å¤æ•°å½¢å¼
const tags = ['VIP', 'é‡ç‚¹å®¢æˆ·'];      // æ ‡ç­¾åˆ—è¡¨
const categories = new Set(['çª—å¸˜', 'å¢™å¸ƒ']); // åˆ†ç±»é›†åˆ
const attributes = new Map();          // å±æ€§æ˜ å°„

// å¸¸é‡ï¼šå…¨éƒ¨å¤§å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”
const MAX_PHONE_LENGTH = 11;
const DEFAULT_STATUS = 'NEW';
const API_TIMEOUT = 5000;

// âœ… å‡½æ•°å‘½åè§„èŒƒ
class LeadService {
    // æŸ¥è¯¢æ–¹æ³•ï¼šä»¥get/find/search/queryå¼€å¤´
    async getLeadById(leadId) {
        // æ ¹æ®IDè·å–å•ä¸ªå¯¹è±¡
    }
    
    async findLeadsByStatus(status) {
        // æ ¹æ®æ¡ä»¶æŸ¥æ‰¾å¤šä¸ªå¯¹è±¡
    }
    
    async searchLeads(criteria, pageable) {
        // å¤æ‚æŸ¥è¯¢å’Œæœç´¢
    }
    
    // åˆ›å»ºæ–¹æ³•ï¼šä»¥create/add/saveå¼€å¤´
    async createLead(request) {
        // åˆ›å»ºæ–°å¯¹è±¡
    }
    
    // æ›´æ–°æ–¹æ³•ï¼šä»¥update/modify/changeå¼€å¤´
    async updateLead(leadId, request) {
        // æ›´æ–°ç°æœ‰å¯¹è±¡
    }
    
    async changeLeadStatus(leadId, newStatus) {
        // å˜æ›´çŠ¶æ€
    }
    
    // åˆ é™¤æ–¹æ³•ï¼šä»¥delete/removeå¼€å¤´
    async deleteLead(leadId) {
        // åˆ é™¤å¯¹è±¡
    }
    
    // éªŒè¯æ–¹æ³•ï¼šä»¥validate/check/verifyå¼€å¤´
    validateLeadData(lead) {
        // æ•°æ®éªŒè¯
    }
    
    async checkLeadExists(phoneNumber) {
        // æ£€æŸ¥å­˜åœ¨æ€§
    }
    
    // è½¬æ¢æ–¹æ³•ï¼šä»¥convert/transform/toå¼€å¤´
    convertToDTO(entity) {
        // å®ä½“è½¬DTO
    }
    
    toEntity(dto) {
        // DTOè½¬å®ä½“
    }
}
```

## ğŸ—ï¸ ä»£ç ç»“æ„è§„èŒƒ

### ç±»ç»“æ„è§„èŒƒ
```javascript
// âœ… ç±»ç»“æ„è§„èŒƒ
class LeadService {
    // 1. é™æ€å¸¸é‡
    static MAX_SEARCH_RESULTS = 1000;
    static CACHE_KEY_PREFIX = 'lead:';
    
    // 2. æ„é€ å‡½æ•°å’Œä¾èµ–æ³¨å…¥
    constructor(leadRepository, leadConverter, cacheManager) {
        this.leadRepository = leadRepository;
        this.leadConverter = leadConverter;
        this.cacheManager = cacheManager;
    }
    
    // 3. å…¬å…±æ–¹æ³•ï¼ˆæŒ‰åŠŸèƒ½åˆ†ç»„æ’åºï¼‰
    
    // ===== æŸ¥è¯¢æ–¹æ³• =====
    async getLeadById(leadId) {
        const lead = await this.leadRepository.findById(leadId);
        if (!lead) {
            throw new BusinessException('çº¿ç´¢ä¸å­˜åœ¨');
        }
        return this.leadConverter.toDTO(lead);
    }
    
    async searchLeads(criteria, pageable) {
        this.validateSearchCriteria(criteria);
        const leads = await this.leadRepository.findByCriteria(criteria, pageable);
        return leads.map(lead => this.leadConverter.toDTO(lead));
    }
    
    // ===== åˆ›å»ºæ–¹æ³• =====
    async createLead(request) {
        this.validateCreateRequest(request);
        
        const lead = this.leadConverter.toEntity(request);
        lead.status = 'NEW';
        lead.createdAt = new Date();
        
        const savedLead = await this.leadRepository.save(lead);
        
        console.log(`åˆ›å»ºçº¿ç´¢æˆåŠŸ: leadId=${savedLead.id}, customerName=${savedLead.customerName}`);
        
        return this.leadConverter.toDTO(savedLead);
    }
    
    // ===== æ›´æ–°æ–¹æ³• =====
    async updateLead(leadId, request) {
        const lead = await this.leadRepository.findById(leadId);
        if (!lead) {
            throw new BusinessException('çº¿ç´¢ä¸å­˜åœ¨');
        }
        
        this.updateLeadFields(lead, request);
        lead.updatedAt = new Date();
        
        const updatedLead = await this.leadRepository.save(lead);
        
        // æ¸…é™¤ç¼“å­˜
        this.evictLeadCache(leadId);
        
        return this.leadConverter.toDTO(updatedLead);
    }
    
    // 4. ç§æœ‰æ–¹æ³•ï¼ˆæŒ‰è°ƒç”¨é¡ºåºæ’åˆ—ï¼‰
    
    validateSearchCriteria(criteria) {
        if (criteria.pageSize > LeadService.MAX_SEARCH_RESULTS) {
            throw new BusinessException('æŸ¥è¯¢ç»“æœè¿‡å¤šï¼Œè¯·ç¼©å°æŸ¥è¯¢èŒƒå›´');
        }
    }
    
    validateCreateRequest(request) {
        if (!request.customerName || request.customerName.trim() === '') {
            throw new BusinessException('å®¢æˆ·å§“åä¸èƒ½ä¸ºç©º');
        }
        
        if (!this.isValidPhoneNumber(request.customerPhone)) {
            throw new BusinessException('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
        }
    }
    
    updateLeadFields(lead, request) {
        if (request.customerName && request.customerName.trim() !== '') {
            lead.customerName = request.customerName;
        }
        
        if (request.customerPhone && request.customerPhone.trim() !== '') {
            lead.customerPhone = request.customerPhone;
        }
        
        if (request.budget !== undefined && request.budget !== null) {
            lead.budget = request.budget;
        }
    }
    
    isValidPhoneNumber(phoneNumber) {
        return phoneNumber && /^1[3-9]\d{9}$/.test(phoneNumber);
    }
    
    evictLeadCache(leadId) {
        this.cacheManager.delete(`${LeadService.CACHE_KEY_PREFIX}${leadId}`);
    }
}
```

### å‡½æ•°ç»“æ„è§„èŒƒ
```javascript
// âœ… å‡½æ•°ç»“æ„è§„èŒƒ
async function createLead(request) {
    // 1. å‚æ•°éªŒè¯ï¼ˆè¾“å…¥éªŒè¯ï¼‰
    if (!request) {
        throw new Error('è¯·æ±‚å‚æ•°ä¸èƒ½ä¸ºç©º');
    }
    
    // 2. ä¸šåŠ¡éªŒè¯ï¼ˆä¸šåŠ¡è§„åˆ™æ£€æŸ¥ï¼‰
    validateCreateRequest(request);
    
    // 3. æ•°æ®å‡†å¤‡ï¼ˆæ„å»ºä¸šåŠ¡å¯¹è±¡ï¼‰
    const lead = buildLeadEntity(request);
    
    // 4. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆä¸»è¦ä¸šåŠ¡å¤„ç†ï¼‰
    const savedLead = await leadRepository.save(lead);
    
    // 5. åç»­å¤„ç†ï¼ˆäº‹ä»¶å‘å¸ƒã€ç¼“å­˜æ›´æ–°ç­‰ï¼‰
    publishLeadCreatedEvent(savedLead);
    updateLeadStatistics(savedLead);
    
    // 6. è¿”å›ç»“æœ
    return leadConverter.toDTO(savedLead);
}

// å¤æ‚å‡½æ•°çš„åˆ†è§£
async function searchLeadsWithComplexCriteria(criteria) {
    // å°†å¤æ‚å‡½æ•°åˆ†è§£ä¸ºå¤šä¸ªå°å‡½æ•°
    validateSearchCriteria(criteria);
    
    const queryBuilder = buildSearchQuery(criteria);
    const pageable = createPageRequest(criteria);
    
    const leadPage = await leadRepository.findAll(queryBuilder, pageable);
    
    return convertToLeadDTOPage(leadPage);
}

function buildSearchQuery(criteria) {
    const query = {};
    
    // çŠ¶æ€ç­›é€‰
    if (criteria.status) {
        query.status = criteria.status;
    }
    
    // æ—¶é—´èŒƒå›´ç­›é€‰
    if (criteria.startDate) {
        query.createdAt = { $gte: criteria.startDate };
    }
    
    if (criteria.endDate) {
        query.createdAt = { ...query.createdAt, $lte: criteria.endDate };
    }
    
    // å…³é”®è¯æœç´¢
    if (criteria.keyword) {
        query.$or = [
            { customerName: { $regex: criteria.keyword, $options: 'i' } },
            { customerPhone: { $regex: criteria.keyword, $options: 'i' } }
        ];
    }
    
    return query;
}
```

## ğŸ”§ ç¼–ç å®è·µè§„èŒƒ

### å¼‚å¸¸å¤„ç†è§„èŒƒ
```javascript
// âœ… å¼‚å¸¸å¤„ç†è§„èŒƒ
class LeadService {
    /**
     * åˆ›å»ºçº¿ç´¢ - å®Œæ•´çš„å¼‚å¸¸å¤„ç†
     */
    async createLead(request) {
        try {
            // 1. å‚æ•°éªŒè¯
            this.validateCreateRequest(request);
            
            // 2. ä¸šåŠ¡å¤„ç†
            const lead = this.buildLeadEntity(request);
            const savedLead = await this.leadRepository.save(lead);
            
            console.log(`åˆ›å»ºçº¿ç´¢æˆåŠŸ: leadId=${savedLead.id}, customerName=${savedLead.customerName}`);
            
            return this.leadConverter.toDTO(savedLead);
            
        } catch (error) {
            if (error instanceof ValidationError) {
                // å‚æ•°å¼‚å¸¸ - ç”¨æˆ·è¾“å…¥é”™è¯¯
                console.warn(`åˆ›å»ºçº¿ç´¢å‚æ•°é”™è¯¯: ${error.message}`);
                throw new BusinessException(`å‚æ•°é”™è¯¯: ${error.message}`);
                
            } else if (error.code === 'ER_DUP_ENTRY') {
                // æ•°æ®å®Œæ•´æ€§å¼‚å¸¸ - é‡å¤æ•°æ®ç­‰
                console.error(`åˆ›å»ºçº¿ç´¢æ•°æ®å†²çª: phoneNumber=${request.customerPhone}`, error);
                throw new BusinessException('è¯¥æ‰‹æœºå·å·²å­˜åœ¨');
                
            } else if (error instanceof BusinessException) {
                // ä¸šåŠ¡å¼‚å¸¸ - ç›´æ¥æŠ›å‡º
                console.warn(`åˆ›å»ºçº¿ç´¢ä¸šåŠ¡å¼‚å¸¸: ${error.message}`);
                throw error;
                
            } else {
                // æœªçŸ¥å¼‚å¸¸ - è®°å½•è¯¦ç»†æ—¥å¿—å¹¶æŠ›å‡ºé€šç”¨å¼‚å¸¸
                console.error(`åˆ›å»ºçº¿ç´¢ç³»ç»Ÿå¼‚å¸¸: request=${JSON.stringify(request)}, error=${error.message}`, error);
                throw new SystemException('åˆ›å»ºçº¿ç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
    }
    
    /**
     * æ‰¹é‡å¤„ç† - å¼‚å¸¸æ”¶é›†æ¨¡å¼
     */
    async batchCreateLeads(requests) {
        const successList = [];
        const errorList = [];
        
        for (let i = 0; i < requests.length; i++) {
            const request = requests[i];
            
            try {
                const lead = await this.createLead(request);
                successList.push(lead);
                
            } catch (error) {
                if (error instanceof BusinessException) {
                    // æ”¶é›†ä¸šåŠ¡å¼‚å¸¸
                    errorList.push({
                        index: i,
                        phone: request.customerPhone,
                        error: error.message
                    });
                    console.warn(`æ‰¹é‡åˆ›å»ºçº¿ç´¢å¤±è´¥: index=${i}, phone=${request.customerPhone}, error=${error.message}`);
                    
                } else {
                    // æ”¶é›†ç³»ç»Ÿå¼‚å¸¸
                    errorList.push({
                        index: i,
                        phone: request.customerPhone,
                        error: 'ç³»ç»Ÿå¼‚å¸¸'
                    });
                    console.error(`æ‰¹é‡åˆ›å»ºçº¿ç´¢ç³»ç»Ÿå¼‚å¸¸: index=${i}, request=${JSON.stringify(request)}`, error);
                }
            }
        }
        
        return {
            successCount: successList.length,
            failureCount: errorList.length,
            successList,
            errorList
        };
    }
}

// è‡ªå®šä¹‰å¼‚å¸¸ç±»
class BusinessException extends Error {
    constructor(message, errorCode = 'BUSINESS_ERROR', args = []) {
        super(message);
        this.name = 'BusinessException';
        this.errorCode = errorCode;
        this.args = args;
    }
}

class SystemException extends Error {
    constructor(message, cause = null) {
        super(message);
        this.name = 'SystemException';
        this.cause = cause;
    }
}

class ValidationError extends Error {
    constructor(message, field = null) {
        super(message);
        this.name = 'ValidationError';
        this.field = field;
    }
}
```

### å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ
```javascript
// âœ… å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ
class OrderService {
    // ä½¿ç”¨ async/await è€Œä¸æ˜¯ Promise.then()
    async createOrder(request) {
        try {
            // ä¸²è¡Œæ‰§è¡Œ
            const user = await this.userService.getUser(request.userId);
            const product = await this.productService.getProduct(request.productId);
            
            // å¹¶è¡Œæ‰§è¡Œ
            const [inventory, pricing] = await Promise.all([
                this.inventoryService.checkInventory(request.productId),
                this.pricingService.calculatePrice(request)
            ]);
            
            // æ¡ä»¶å¼‚æ­¥æ‰§è¡Œ
            if (inventory.available) {
                await this.inventoryService.reserve(request.productId, request.quantity);
            }
            
            const order = await this.orderRepository.save({
                userId: user.id,
                productId: product.id,
                quantity: request.quantity,
                price: pricing.totalPrice,
                status: 'CREATED'
            });
            
            // å¼‚æ­¥åç»­å¤„ç†ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
            setImmediate(() => {
                this.notificationService.sendOrderConfirmation(order);
                this.analyticsService.trackOrderCreated(order);
            });
            
            return order;
            
        } catch (error) {
            console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
            throw error;
        }
    }
    
    // é”™è¯¯çš„å¼‚æ­¥å¤„ç†æ–¹å¼
    createOrderBad(request) {
        // âŒ ä¸è¦æ··ç”¨ async/await å’Œ Promise.then()
        return this.userService.getUser(request.userId)
            .then(user => {
                return this.productService.getProduct(request.productId)
                    .then(product => {
                        // åµŒå¥—åœ°ç‹±
                        return this.orderRepository.save({
                            userId: user.id,
                            productId: product.id
                        });
                    });
            });
    }
}
```

### æ•°æ®éªŒè¯è§„èŒƒ
```javascript
// âœ… æ•°æ®éªŒè¯è§„èŒƒ
const Joi = require('joi');

// å®šä¹‰éªŒè¯æ¨¡å¼
const createLeadSchema = Joi.object({
    customerName: Joi.string()
        .trim()
        .min(2)
        .max(50)
        .required()
        .messages({
            'string.empty': 'å®¢æˆ·å§“åä¸èƒ½ä¸ºç©º',
            'string.min': 'å®¢æˆ·å§“åè‡³å°‘2ä¸ªå­—ç¬¦',
            'string.max': 'å®¢æˆ·å§“åä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦',
            'any.required': 'å®¢æˆ·å§“åæ˜¯å¿…å¡«é¡¹'
        }),
    
    customerPhone: Joi.string()
        .pattern(/^1[3-9]\d{9}$/)
        .required()
        .messages({
            'string.pattern.base': 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®',
            'any.required': 'æ‰‹æœºå·æ˜¯å¿…å¡«é¡¹'
        }),
    
    budget: Joi.number()
        .positive()
        .max(1000000)
        .optional()
        .messages({
            'number.positive': 'é¢„ç®—é‡‘é¢å¿…é¡»å¤§äº0',
            'number.max': 'é¢„ç®—é‡‘é¢ä¸èƒ½è¶…è¿‡100ä¸‡'
        }),
    
    source: Joi.string()
        .valid('ONLINE', 'OFFLINE', 'REFERRAL', 'ADVERTISEMENT')
        .default('ONLINE')
        .messages({
            'any.only': 'çº¿ç´¢æ¥æºå¿…é¡»æ˜¯æœ‰æ•ˆå€¼'
        }),
    
    tags: Joi.array()
        .items(Joi.string().trim().min(1).max(20))
        .max(10)
        .optional()
        .messages({
            'array.max': 'æ ‡ç­¾æ•°é‡ä¸èƒ½è¶…è¿‡10ä¸ª'
        })
});

// éªŒè¯ä¸­é—´ä»¶
function validateCreateLead(req, res, next) {
    const { error, value } = createLeadSchema.validate(req.body, {
        abortEarly: false,  // è¿”å›æ‰€æœ‰é”™è¯¯
        stripUnknown: true  // ç§»é™¤æœªçŸ¥å­—æ®µ
    });
    
    if (error) {
        const errors = error.details.map(detail => ({
            field: detail.path.join('.'),
            message: detail.message
        }));
        
        return res.status(400).json({
            success: false,
            message: 'è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥',
            errors
        });
    }
    
    req.body = value;  // ä½¿ç”¨éªŒè¯åçš„å€¼
    next();
}

// ä¸šåŠ¡éªŒè¯
class LeadValidator {
    static async validateUniquePhone(phone, excludeId = null) {
        const existingLead = await leadRepository.findByPhone(phone);
        if (existingLead && existingLead.id !== excludeId) {
            throw new ValidationError('è¯¥æ‰‹æœºå·å·²å­˜åœ¨', 'customerPhone');
        }
    }
    
    static validateLeadStatus(currentStatus, newStatus) {
        const validTransitions = {
            'NEW': ['CONTACTED', 'CANCELLED'],
            'CONTACTED': ['QUALIFIED', 'UNQUALIFIED', 'CANCELLED'],
            'QUALIFIED': ['CONVERTED', 'CANCELLED'],
            'UNQUALIFIED': ['CONTACTED'],
            'CONVERTED': [],
            'CANCELLED': []
        };
        
        if (!validTransitions[currentStatus]?.includes(newStatus)) {
            throw new ValidationError(`ä¸èƒ½ä»çŠ¶æ€ ${currentStatus} è½¬æ¢åˆ° ${newStatus}`, 'status');
        }
    }
}
```

### æ—¥å¿—è®°å½•è§„èŒƒ
```javascript
// âœ… æ—¥å¿—è®°å½•è§„èŒƒ
const winston = require('winston');

// æ—¥å¿—é…ç½®
const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.errors({ stack: true }),
        winston.format.json()
    ),
    defaultMeta: { service: 'l2c-service' },
    transports: [
        new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
        new winston.transports.File({ filename: 'logs/combined.log' }),
        new winston.transports.Console({
            format: winston.format.simple()
        })
    ]
});

class LeadService {
    async createLead(request) {
        const startTime = Date.now();
        const correlationId = generateCorrelationId();
        
        logger.info('å¼€å§‹åˆ›å»ºçº¿ç´¢', {
            correlationId,
            userId: request.userId,
            customerPhone: request.customerPhone,
            action: 'CREATE_LEAD_START'
        });
        
        try {
            const lead = await this.processLeadCreation(request);
            
            logger.info('åˆ›å»ºçº¿ç´¢æˆåŠŸ', {
                correlationId,
                leadId: lead.id,
                customerName: lead.customerName,
                duration: Date.now() - startTime,
                action: 'CREATE_LEAD_SUCCESS'
            });
            
            return lead;
            
        } catch (error) {
            logger.error('åˆ›å»ºçº¿ç´¢å¤±è´¥', {
                correlationId,
                error: error.message,
                stack: error.stack,
                request: JSON.stringify(request),
                duration: Date.now() - startTime,
                action: 'CREATE_LEAD_FAILURE'
            });
            
            throw error;
        }
    }
    
    // æ•æ„Ÿä¿¡æ¯è„±æ•
    logSafeRequest(request) {
        const safeRequest = { ...request };
        if (safeRequest.customerPhone) {
            safeRequest.customerPhone = safeRequest.customerPhone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
        }
        return safeRequest;
    }
}

// å®¡è®¡æ—¥å¿—
class AuditLogger {
    static async logUserAction(userId, action, resource, details = {}) {
        const auditLog = {
            userId,
            action,
            resource,
            details,
            timestamp: new Date(),
            ip: details.ip,
            userAgent: details.userAgent
        };
        
        await auditLogRepository.save(auditLog);
        
        logger.info('ç”¨æˆ·æ“ä½œå®¡è®¡', {
            userId,
            action,
            resource,
            timestamp: auditLog.timestamp
        });
    }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```javascript
// âœ… æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
class LeadRepository {
    // ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
    async findByStatusAndDateRange(status, startDate, endDate, limit = 100) {
        // ç¡®ä¿æœ‰å¤åˆç´¢å¼•: (status, created_at)
        return await this.model.find({
            status,
            created_at: {
                $gte: startDate,
                $lte: endDate
            }
        })
        .limit(limit)
        .sort({ created_at: -1 })
        .lean(); // è¿”å›æ™®é€šå¯¹è±¡è€Œä¸æ˜¯ Mongoose æ–‡æ¡£
    }
    
    // åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
    async findWithPagination(criteria, page = 1, pageSize = 20) {
        const skip = (page - 1) * pageSize;
        
        // ä½¿ç”¨èšåˆç®¡é“ä¼˜åŒ–
        const [results, total] = await Promise.all([
            this.model.aggregate([
                { $match: criteria },
                { $sort: { created_at: -1 } },
                { $skip: skip },
                { $limit: pageSize },
                {
                    $lookup: {
                        from: 'users',
                        localField: 'assigned_to',
                        foreignField: '_id',
                        as: 'assignee'
                    }
                }
            ]),
            this.model.countDocuments(criteria)
        ]);
        
        return {
            data: results,
            pagination: {
                page,
                pageSize,
                total,
                totalPages: Math.ceil(total / pageSize)
            }
        };
    }
    
    // æ‰¹é‡æ“ä½œä¼˜åŒ–
    async batchUpdateStatus(leadIds, newStatus) {
        return await this.model.updateMany(
            { _id: { $in: leadIds } },
            { 
                $set: { 
                    status: newStatus,
                    updated_at: new Date()
                }
            }
        );
    }
}
```

### ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
```javascript
// âœ… ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
class CacheService {
    constructor(redisClient) {
        this.redis = redisClient;
        this.localCache = new Map();
        this.maxLocalCacheSize = 1000;
    }
    
    // å¤šçº§ç¼“å­˜
    async get(key) {
        // 1. æœ¬åœ°ç¼“å­˜
        if (this.localCache.has(key)) {
            return this.localCache.get(key);
        }
        
        // 2. Redis ç¼“å­˜
        const cached = await this.redis.get(key);
        if (cached) {
            const value = JSON.parse(cached);
            this.setLocalCache(key, value);
            return value;
        }
        
        return null;
    }
    
    async set(key, value, ttl = 3600) {
        // è®¾ç½® Redis ç¼“å­˜
        await this.redis.setex(key, ttl, JSON.stringify(value));
        
        // è®¾ç½®æœ¬åœ°ç¼“å­˜
        this.setLocalCache(key, value);
    }
    
    setLocalCache(key, value) {
        // LRU æ·˜æ±°ç­–ç•¥
        if (this.localCache.size >= this.maxLocalCacheSize) {
            const firstKey = this.localCache.keys().next().value;
            this.localCache.delete(firstKey);
        }
        
        this.localCache.set(key, value);
    }
    
    // ç¼“å­˜é¢„çƒ­
    async warmupCache() {
        const hotKeys = await this.getHotKeys();
        
        for (const key of hotKeys) {
            try {
                const value = await this.loadFromDatabase(key);
                await this.set(key, value);
            } catch (error) {
                logger.warn(`ç¼“å­˜é¢„çƒ­å¤±è´¥: ${key}`, error);
            }
        }
    }
}

// ç¼“å­˜è£…é¥°å™¨
function cached(ttl = 3600, keyGenerator = null) {
    return function(target, propertyName, descriptor) {
        const method = descriptor.value;
        
        descriptor.value = async function(...args) {
            const cacheKey = keyGenerator ? 
                keyGenerator(...args) : 
                `${target.constructor.name}:${propertyName}:${JSON.stringify(args)}`;
            
            // å°è¯•ä»ç¼“å­˜è·å–
            let result = await cacheService.get(cacheKey);
            if (result !== null) {
                return result;
            }
            
            // æ‰§è¡ŒåŸæ–¹æ³•
            result = await method.apply(this, args);
            
            // è®¾ç½®ç¼“å­˜
            if (result !== null && result !== undefined) {
                await cacheService.set(cacheKey, result, ttl);
            }
            
            return result;
        };
        
        return descriptor;
    };
}

// ä½¿ç”¨ç¤ºä¾‹
class LeadService {
    @cached(1800, (leadId) => `lead:${leadId}`)
    async getLeadById(leadId) {
        return await this.leadRepository.findById(leadId);
    }
}
```

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### å•å…ƒæµ‹è¯•è§„èŒƒ
```javascript
// âœ… å•å…ƒæµ‹è¯•è§„èŒƒ
const { expect } = require('chai');
const sinon = require('sinon');
const LeadService = require('../src/services/LeadService');

describe('LeadService', () => {
    let leadService;
    let mockLeadRepository;
    let mockLeadConverter;
    
    beforeEach(() => {
        mockLeadRepository = {
            findById: sinon.stub(),
            save: sinon.stub(),
            findByCriteria: sinon.stub()
        };
        
        mockLeadConverter = {
            toDTO: sinon.stub(),
            toEntity: sinon.stub()
        };
        
        leadService = new LeadService(mockLeadRepository, mockLeadConverter);
    });
    
    afterEach(() => {
        sinon.restore();
    });
    
    describe('getLeadById', () => {
        it('åº”è¯¥è¿”å›çº¿ç´¢DTOå½“çº¿ç´¢å­˜åœ¨æ—¶', async () => {
            // Arrange
            const leadId = 123;
            const mockLead = { id: leadId, customerName: 'å¼ ä¸‰' };
            const mockLeadDTO = { id: leadId, customerName: 'å¼ ä¸‰' };
            
            mockLeadRepository.findById.resolves(mockLead);
            mockLeadConverter.toDTO.returns(mockLeadDTO);
            
            // Act
            const result = await leadService.getLeadById(leadId);
            
            // Assert
            expect(result).to.deep.equal(mockLeadDTO);
            expect(mockLeadRepository.findById).to.have.been.calledOnceWith(leadId);
            expect(mockLeadConverter.toDTO).to.have.been.calledOnceWith(mockLead);
        });
        
        it('åº”è¯¥æŠ›å‡ºBusinessExceptionå½“çº¿ç´¢ä¸å­˜åœ¨æ—¶', async () => {
            // Arrange
            const leadId = 999;
            mockLeadRepository.findById.resolves(null);
            
            // Act & Assert
            await expect(leadService.getLeadById(leadId))
                .to.be.rejectedWith('çº¿ç´¢ä¸å­˜åœ¨');
            
            expect(mockLeadRepository.findById).to.have.been.calledOnceWith(leadId);
            expect(mockLeadConverter.toDTO).to.not.have.been.called;
        });
    });
    
    describe('createLead', () => {
        it('åº”è¯¥æˆåŠŸåˆ›å»ºçº¿ç´¢', async () => {
            // Arrange
            const request = {
                customerName: 'æå››',
                customerPhone: '13800138001',
                budget: 50000
            };
            
            const mockEntity = { ...request, status: 'NEW', createdAt: new Date() };
            const mockSavedEntity = { ...mockEntity, id: 456 };
            const mockDTO = { ...mockSavedEntity };
            
            mockLeadConverter.toEntity.returns(mockEntity);
            mockLeadRepository.save.resolves(mockSavedEntity);
            mockLeadConverter.toDTO.returns(mockDTO);
            
            // Act
            const result = await leadService.createLead(request);
            
            // Assert
            expect(result).to.deep.equal(mockDTO);
            expect(mockLeadConverter.toEntity).to.have.been.calledOnceWith(request);
            expect(mockLeadRepository.save).to.have.been.calledOnce;
            expect(mockLeadConverter.toDTO).to.have.been.calledOnceWith(mockSavedEntity);
        });
        
        it('åº”è¯¥æŠ›å‡ºValidationErrorå½“å®¢æˆ·å§“åä¸ºç©ºæ—¶', async () => {
            // Arrange
            const request = {
                customerName: '',
                customerPhone: '13800138001'
            };
            
            // Act & Assert
            await expect(leadService.createLead(request))
                .to.be.rejectedWith('å®¢æˆ·å§“åä¸èƒ½ä¸ºç©º');
        });
    });
});
```

### é›†æˆæµ‹è¯•è§„èŒƒ
```javascript
// âœ… é›†æˆæµ‹è¯•è§„èŒƒ
const request = require('supertest');
const app = require('../src/app');
const { setupTestDB, cleanupTestDB } = require('./helpers/database');

describe('Lead API Integration Tests', () => {
    let authToken;
    
    before(async () => {
        await setupTestDB();
        
        // è·å–è®¤è¯ä»¤ç‰Œ
        const loginResponse = await request(app)
            .post('/api/auth/login')
            .send({
                username: 'test_user',
                password: 'test_password'
            });
        
        authToken = loginResponse.body.data.token;
    });
    
    after(async () => {
        await cleanupTestDB();
    });
    
    describe('POST /api/leads', () => {
        it('åº”è¯¥æˆåŠŸåˆ›å»ºçº¿ç´¢', async () => {
            const leadData = {
                customerName: 'æµ‹è¯•å®¢æˆ·',
                customerPhone: '13800138888',
                budget: 30000,
                source: 'ONLINE'
            };
            
            const response = await request(app)
                .post('/api/leads')
                .set('Authorization', `Bearer ${authToken}`)
                .send(leadData)
                .expect(201);
            
            expect(response.body.success).to.be.true;
            expect(response.body.data).to.include({
                customerName: leadData.customerName,
                customerPhone: leadData.customerPhone,
                status: 'NEW'
            });
            expect(response.body.data.id).to.be.a('number');
        });
        
        it('åº”è¯¥è¿”å›400å½“æ‰‹æœºå·æ ¼å¼é”™è¯¯æ—¶', async () => {
            const leadData = {
                customerName: 'æµ‹è¯•å®¢æˆ·',
                customerPhone: '12345678901',  // é”™è¯¯æ ¼å¼
                budget: 30000
            };
            
            const response = await request(app)
                .post('/api/leads')
                .set('Authorization', `Bearer ${authToken}`)
                .send(leadData)
                .expect(400);
            
            expect(response.body.success).to.be.false;
            expect(response.body.message).to.include('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
        });
    });
    
    describe('GET /api/leads', () => {
        it('åº”è¯¥è¿”å›çº¿ç´¢åˆ—è¡¨', async () => {
            const response = await request(app)
                .get('/api/leads')
                .set('Authorization', `Bearer ${authToken}`)
                .query({ page: 1, pageSize: 10 })
                .expect(200);
            
            expect(response.body.success).to.be.true;
            expect(response.body.data).to.have.property('data');
            expect(response.body.data).to.have.property('pagination');
            expect(response.body.data.data).to.be.an('array');
        });
    });
});
```

## ğŸ“‹ ä»£ç å®¡æŸ¥æ¸…å•

### æäº¤å‰æ£€æŸ¥æ¸…å•
- [ ] **ä»£ç æ ¼å¼åŒ–**ï¼šä½¿ç”¨ Prettier æ ¼å¼åŒ–ä»£ç 
- [ ] **ä»£ç æ£€æŸ¥**ï¼šé€šè¿‡ ESLint æ£€æŸ¥
- [ ] **å•å…ƒæµ‹è¯•**ï¼šæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] **é›†æˆæµ‹è¯•**ï¼šå…³é”®è·¯å¾„æµ‹è¯•é€šè¿‡
- [ ] **æ€§èƒ½æµ‹è¯•**ï¼šæ— æ˜æ˜¾æ€§èƒ½å›å½’
- [ ] **å®‰å…¨æ£€æŸ¥**ï¼šæ— å®‰å…¨æ¼æ´
- [ ] **æ–‡æ¡£æ›´æ–°**ï¼šç›¸å…³æ–‡æ¡£å·²æ›´æ–°

### ä»£ç å®¡æŸ¥è¦ç‚¹
1. **åŠŸèƒ½æ­£ç¡®æ€§**ï¼šä»£ç æ˜¯å¦å®ç°äº†é¢„æœŸåŠŸèƒ½
2. **ä»£ç è´¨é‡**ï¼šæ˜¯å¦éµå¾ªç¼–ç è§„èŒƒå’Œæœ€ä½³å®è·µ
3. **æ€§èƒ½è€ƒè™‘**ï¼šæ˜¯å¦å­˜åœ¨æ€§èƒ½é—®é¢˜
4. **å®‰å…¨æ€§**ï¼šæ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´
5. **å¯ç»´æŠ¤æ€§**ï¼šä»£ç æ˜¯å¦æ˜“äºç†è§£å’Œç»´æŠ¤
6. **æµ‹è¯•è¦†ç›–**ï¼šæ˜¯å¦æœ‰è¶³å¤Ÿçš„æµ‹è¯•è¦†ç›–

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2025å¹´1æœˆ  
**æœ€åæ›´æ–°ï¼š** 2025å¹´1æœˆ  
**ç»´æŠ¤äººå‘˜ï¼š** å¼€å‘å›¢é˜Ÿ