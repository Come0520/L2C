# ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿ - æµ‹è¯•ç­–ç•¥æ–‡æ¡£ v2.0

## ğŸ¯ æµ‹è¯•ç­–ç•¥æ¦‚è¿°

### æµ‹è¯•ç›®æ ‡
- **åŠŸèƒ½å®Œæ•´æ€§**ï¼šç¡®ä¿ Server Actions å’Œ RLS ç­–ç•¥æŒ‰éœ€æ±‚æ­£ç¡®å®ç°
- **æ•°æ®ä¸€è‡´æ€§**ï¼šéªŒè¯ Postgres çº¦æŸå’Œè§¦å‘å™¨é€»è¾‘çš„æ­£ç¡®æ€§
- **å®‰å…¨æ€§**ï¼šç¡®ä¿ Row Level Security (RLS) ä¸¥æ ¼éš”ç¦»å¤šç§Ÿæˆ·/å¤šè§’è‰²æ•°æ®
- **æ€§èƒ½è¾¾æ ‡**ï¼šAPI å“åº” < 500msï¼Œé¡µé¢ LCP < 2.5s
- **ç”¨æˆ·ä½“éªŒ**ï¼šç¡®ä¿ Next.js App Router çš„é¡µé¢åˆ‡æ¢å’Œ Streaming ä½“éªŒæµç•…

### æµ‹è¯•èŒƒå›´
- **å•å…ƒæµ‹è¯• (Unit Test)**ï¼šZod Schema éªŒè¯ã€çº¯å‡½æ•°å·¥å…·ç±»
- **é›†æˆæµ‹è¯• (Integration Test)**ï¼šServer Actions ä¸ Supabase Local æ•°æ®åº“çš„äº¤äº’
- **ç«¯åˆ°ç«¯æµ‹è¯• (E2E)**ï¼šä½¿ç”¨ Playwright æ¨¡æ‹Ÿç”¨æˆ·åœ¨ Next.js é¡µé¢ä¸Šçš„å®Œæ•´æ“ä½œæµç¨‹
- **å®‰å…¨æµ‹è¯•**ï¼šé’ˆå¯¹ RLS ç­–ç•¥çš„ä¸“é¡¹æ¸—é€æµ‹è¯•

## ğŸ“‹ æµ‹è¯•è®¡åˆ’

### æµ‹è¯•é˜¶æ®µä¸é‡Œç¨‹ç¢‘

#### ç¬¬ä¸€é˜¶æ®µï¼šRLS ä¸ Schema éªŒè¯ï¼ˆç¬¬1-2å‘¨ï¼‰
**ç›®æ ‡ï¼š** ç¡®ä¿æ•°æ®åº“å±‚é¢çš„å®‰å…¨å’Œé€»è¾‘æ­£ç¡®
- **æµ‹è¯•é‡ç‚¹ï¼š** Postgres è¡¨ç»“æ„ã€RLS ç­–ç•¥ã€è§¦å‘å™¨å‡½æ•°
- **å·¥å…·ï¼š** `pgTAP` æˆ– Supabase Test Helpers
- **å®Œæˆæ ‡å‡†ï¼š** æ‰€æœ‰ RLS ç­–ç•¥è¦†ç›–ç‡ 100%ï¼Œæ— è¶Šæƒæ¼æ´

#### ç¬¬äºŒé˜¶æ®µï¼šé›†æˆæµ‹è¯•ï¼ˆç¬¬3-4å‘¨ï¼‰
**ç›®æ ‡ï¼š** éªŒè¯ Server Actions ä¸šåŠ¡é€»è¾‘
- **æµ‹è¯•é‡ç‚¹ï¼š** Next.js Server Actions, Zod Input Validation, Supabase SDK è°ƒç”¨
- **ç¯å¢ƒï¼š** Supabase Local Development
- **å®Œæˆæ ‡å‡†ï¼š** æ ¸å¿ƒä¸šåŠ¡æµç¨‹é›†æˆæµ‹è¯•é€šè¿‡

#### ç¬¬ä¸‰é˜¶æ®µï¼šE2E ç³»ç»Ÿæµ‹è¯•ï¼ˆç¬¬5-6å‘¨ï¼‰
**ç›®æ ‡ï¼š** éªŒè¯å®Œæ•´ç³»ç»ŸåŠŸèƒ½
- **æµ‹è¯•é‡ç‚¹ï¼š** ç™»å½•æµç¨‹ã€çº¿ç´¢å½•å…¥ã€è®¢å•åˆ›å»ºç­‰å…³é”®è·¯å¾„
- **å·¥å…·ï¼š** Playwright
- **å®Œæˆæ ‡å‡†ï¼š** æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ 100% é€šè¿‡

#### ç¬¬å››é˜¶æ®µï¼šéªŒæ”¶æµ‹è¯•ï¼ˆç¬¬7å‘¨ï¼‰
**ç›®æ ‡ï¼š** ç”¨æˆ·éªŒæ”¶å’Œä¸Šçº¿å‡†å¤‡
- **æµ‹è¯•é‡ç‚¹ï¼š** çœŸå®æ•°æ®å¯¼å…¥åçš„ä¸šåŠ¡éªŒè¯
- **ç¯å¢ƒï¼š** Vercel Preview Deployment + Supabase Staging Project

### æµ‹è¯•ç¯å¢ƒé…ç½®

#### å¼€å‘æµ‹è¯•ç¯å¢ƒ (Supabase Local)
ä¸å†ä¾èµ–æ‰‹åŠ¨ç¼–å†™ docker-composeï¼Œç›´æ¥ä½¿ç”¨ Supabase CLIã€‚

```bash
# å¯åŠ¨æœ¬åœ°å®Œæ•´ç¯å¢ƒ (DB, Auth, Storage, Edge Functions)
npx supabase start

# è¿è¡Œæµ‹è¯•
npm run test
```

#### æµ‹è¯•æ•°æ®å‡†å¤‡ (Seed.sql)
```sql
-- supabase/seed.sql
-- è‡ªåŠ¨æ’å…¥æµ‹è¯•ç”¨æˆ·å’ŒåŸºç¡€å­—å…¸
INSERT INTO auth.users (id, email) VALUES 
('uuid-1', 'admin@example.com'),
('uuid-2', 'sales@example.com');

INSERT INTO public.profiles (id, role) VALUES 
('uuid-1', 'ADMIN'),
('uuid-2', 'SALES');
```

## ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•ä½“ç³»

### 1. å•å…ƒ/é›†æˆæµ‹è¯• (Vitest)
```typescript
// tests/integration/leads.test.ts
import { createClient } from '@supabase/supabase-js'

test('sales can create lead', async () => {
  const supabase = createClient(process.env.SUPABASE_URL, service_role_key)
  const { data, error } = await supabase.rpc('create_lead', { ... })
  expect(error).toBeNull()
  expect(data.id).toBeDefined()
})
```

### 2. ç«¯åˆ°ç«¯æµ‹è¯• (Playwright)
```typescript
// e2e/login.spec.ts
test('user can login', async ({ page }) => {
  await page.goto('/login');
  await page.fill('input[name="email"]', 'sales@example.com');
  await page.fill('input[name="password"]', 'password');
  await page.click('button[type="submit"]');
  await expect(page).toHaveURL('/dashboard');
});
```

## ğŸ“Š è´¨é‡é—¨ç¦ (CI Gate)
GitHub Actions æµæ°´çº¿ä¸­å¿…é¡»åŒ…å«ï¼š
1. `npm run lint` (ESLint)
2. `npm run type-check` (TypeScript)
3. `npm run test` (Vitest)
4. `npx supabase test db` (Database Tests)
