# 罗莱L2C销售管理系统 - 端口分配规范

## 🎯 规范目标

### 主要目标
- **避免端口冲突**：确保不同服务使用不同端口，避免开发和部署时的端口冲突
- **标准化管理**：统一端口分配策略，便于团队协作和运维管理
- **环境隔离**：不同环境使用不同端口段，避免环境间相互影响
- **易于维护**：清晰的端口分配规则，便于问题排查和系统维护

## 📋 端口分配策略

### 端口分配原则
1. **分段管理**：按服务类型和环境分配不同端口段
2. **预留空间**：为未来扩展预留端口空间
3. **避免系统端口**：避免使用1-1023的系统保留端口
4. **文档同步**：端口变更必须同步更新文档

### 环境端口分配

#### 开发环境 (Development) - 3000-3999
```yaml
# 前端应用
frontend_web: 3000          # Web前端应用
frontend_mobile: 3001       # 移动端H5应用
frontend_admin: 3002        # 管理后台前端

# 后端服务
backend_api: 3100           # 主API服务
backend_auth: 3101          # 认证服务
backend_file: 3102          # 文件服务
backend_notification: 3103  # 通知服务
backend_report: 3104        # 报表服务

# 数据库服务
postgresql_dev: 5432        # PostgreSQL数据库
redis_dev: 3379             # Redis缓存
mongodb_dev: 3017           # MongoDB文档数据库 (未使用)

# 开发工具
webpack_dev_server: 3200    # Webpack开发服务器
storybook: 3201             # Storybook组件库
api_docs: 3202              # API文档服务
```

#### 测试环境 (Testing) - 4000-4999
```yaml
# 前端应用
frontend_web: 4000          # Web前端应用
frontend_mobile: 4001       # 移动端H5应用
frontend_admin: 4002        # 管理后台前端

# 后端服务
backend_api: 4100           # 主API服务
backend_auth: 4101          # 认证服务
backend_file: 4102          # 文件服务
backend_notification: 4103  # 通知服务
backend_report: 4104        # 报表服务

# 数据库服务
postgresql_test: 5433       # PostgreSQL数据库
redis_test: 4379            # Redis缓存
mongodb_test: 4017          # MongoDB文档数据库 (未使用)

# 测试工具
test_runner: 4200           # 测试运行器
coverage_server: 4201       # 代码覆盖率服务
```

#### 预发布环境 (Staging) - 5000-5999
```yaml
# 前端应用
frontend_web: 5000          # Web前端应用
frontend_mobile: 5001       # 移动端H5应用
frontend_admin: 5002        # 管理后台前端

# 后端服务
backend_api: 5100           # 主API服务
backend_auth: 5101          # 认证服务
backend_file: 5102          # 文件服务
backend_notification: 5103  # 通知服务
backend_report: 5104        # 报表服务

# 数据库服务
postgresql_staging: 5434    # PostgreSQL数据库
redis_staging: 5379         # Redis缓存
mongodb_staging: 5017       # MongoDB文档数据库 (未使用)
```

#### 生产环境 (Production) - 8000-8999
```yaml
# 前端应用
frontend_web: 8000          # Web前端应用
frontend_mobile: 8001       # 移动端H5应用
frontend_admin: 8002        # 管理后台前端

# 后端服务
backend_api: 8100           # 主API服务
backend_auth: 8101          # 认证服务
backend_file: 8102          # 文件服务
backend_notification: 8103  # 通知服务
backend_report: 8104        # 报表服务

# 负载均衡
nginx_lb: 80                # Nginx负载均衡器
nginx_ssl: 443              # HTTPS端口

# 监控服务
prometheus: 8200            # Prometheus监控
grafana: 8201               # Grafana仪表板
alertmanager: 8202          # 告警管理器
```

## 🔧 配置管理

### 环境变量配置
```javascript
// config/ports.js
const PORTS = {
  development: {
    frontend: {
      web: process.env.FRONTEND_WEB_PORT || 3000,
      mobile: process.env.FRONTEND_MOBILE_PORT || 3001,
      admin: process.env.FRONTEND_ADMIN_PORT || 3002
    },
    backend: {
      api: process.env.BACKEND_API_PORT || 3100,
      auth: process.env.BACKEND_AUTH_PORT || 3101,
      file: process.env.BACKEND_FILE_PORT || 3102,
      notification: process.env.BACKEND_NOTIFICATION_PORT || 3103,
      report: process.env.BACKEND_REPORT_PORT || 3104
    },
    database: {
      postgresql: process.env.POSTGRES_PORT || 5432,
      redis: process.env.REDIS_PORT || 3379,
    }
  },
  testing: {
    frontend: {
      web: process.env.FRONTEND_WEB_PORT || 4000,
      mobile: process.env.FRONTEND_MOBILE_PORT || 4001,
      admin: process.env.FRONTEND_ADMIN_PORT || 4002
    },
    backend: {
      api: process.env.BACKEND_API_PORT || 4100,
      auth: process.env.BACKEND_AUTH_PORT || 4101,
      file: process.env.BACKEND_FILE_PORT || 4102,
      notification: process.env.BACKEND_NOTIFICATION_PORT || 4103,
      report: process.env.BACKEND_REPORT_PORT || 4104
    }
  }
};

module.exports = PORTS;
```

### Docker Compose 配置示例
```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  frontend-web:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000

  backend-api:
    build: ./backend
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=development
      - PORT=3100
      - DB_PORT=5432
      - REDIS_PORT=3379

  postgresql:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=dev_password

  redis:
    image: redis:7-alpine
    ports:
      - "3379:6379"
```

## 📝 端口使用规范

### 端口申请流程
1. **查询可用端口**：检查端口分配表，确认目标端口未被占用
2. **申请端口**：在团队内部申请端口使用权限
3. **更新文档**：在本文档中记录端口分配信息
4. **配置服务**：在相应的配置文件中设置端口
5. **测试验证**：确保服务能正常启动并监听指定端口

### 端口冲突解决
```bash
# 检查端口占用情况
lsof -i :3000
netstat -tulpn | grep :3000

# 查找并终止占用端口的进程
kill -9 $(lsof -t -i:3000)

# 使用不同端口启动服务
npm start -- --port 3001
```

### 端口监控脚本
```bash
#!/bin/bash
# scripts/check-ports.sh

echo "=== 端口占用检查 ==="

# 定义需要检查的端口
PORTS=(3000 3100 3306 3379)

for port in "${PORTS[@]}"; do
    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null ; then
        echo "✅ 端口 $port 正在使用"
        lsof -i :$port
    else
        echo "❌ 端口 $port 未被占用"
    fi
    echo "---"
done
```

## 🚀 最佳实践

### 开发环境配置
```javascript
// package.json
{
  "scripts": {
    "dev": "cross-env NODE_ENV=development PORT=3000 npm run start:dev",
    "dev:api": "cross-env NODE_ENV=development PORT=3100 npm run start:api",
    "dev:auth": "cross-env NODE_ENV=development PORT=3101 npm run start:auth"
  }
}
```

### 环境变量文件
```bash
# .env.development
NODE_ENV=development
FRONTEND_WEB_PORT=3000
FRONTEND_MOBILE_PORT=3001
FRONTEND_ADMIN_PORT=3002

BACKEND_API_PORT=3100
BACKEND_AUTH_PORT=3101
BACKEND_FILE_PORT=3102

POSTGRES_PORT=5432
REDIS_PORT=3379
```

### 服务发现配置
```javascript
// config/services.js
const getServiceUrl = (serviceName, environment = process.env.NODE_ENV) => {
  const ports = require('./ports')[environment];
  const host = process.env.SERVICE_HOST || 'localhost';
  
  switch (serviceName) {
    case 'api':
      return `http://${host}:${ports.backend.api}`;
    case 'auth':
      return `http://${host}:${ports.backend.auth}`;
    case 'file':
      return `http://${host}:${ports.backend.file}`;
    default:
      throw new Error(`Unknown service: ${serviceName}`);
  }
};

module.exports = { getServiceUrl };
```

## 📊 端口分配记录表

| 服务名称 | 开发环境 | 测试环境 | 预发布环境 | 生产环境 | 负责人 | 更新时间 |
|---------|---------|---------|-----------|---------|--------|----------|
| Web前端 | 3000 | 4000 | 5000 | 8000 | 前端团队 | 2024-01-15 |
| 移动端H5 | 3001 | 4001 | 5001 | 8001 | 前端团队 | 2024-01-15 |
| 管理后台 | 3002 | 4002 | 5002 | 8002 | 前端团队 | 2024-01-15 |
| 主API服务 | 3100 | 4100 | 5100 | 8100 | 后端团队 | 2024-01-15 |
| 认证服务 | 3101 | 4101 | 5101 | 8101 | 后端团队 | 2024-01-15 |
| 文件服务 | 3102 | 4102 | 5102 | 8102 | 后端团队 | 2024-01-15 |
| PostgreSQL | 5432 | 5433 | 5434 | 5432 | 运维团队 | 2024-01-15 |
| Redis | 3379 | 4379 | 5379 | 6379 | 运维团队 | 2024-01-15 |

## ⚠️ 注意事项

### 端口安全
1. **生产环境**：避免暴露不必要的端口到公网
2. **防火墙配置**：正确配置防火墙规则
3. **SSL/TLS**：生产环境必须使用HTTPS
4. **访问控制**：限制端口访问权限

### 性能考虑
1. **端口复用**：避免不必要的端口占用
2. **连接池**：合理配置数据库连接池
3. **负载均衡**：使用负载均衡器分发请求
4. **监控告警**：监控端口状态和服务健康度

### 故障排查
```bash
# 常用端口检查命令
netstat -tulpn | grep LISTEN
ss -tulpn | grep LISTEN
lsof -i -P -n | grep LISTEN

# 检查特定端口
telnet localhost 3000
nc -zv localhost 3000

# 查看进程端口占用
ps aux | grep node
```

---

**文档维护**：本文档应随着系统架构变化及时更新，确保端口分配信息的准确性。

**版本信息**：
- 创建时间：2024-01-15
- 最后更新：2024-01-15
- 文档版本：v1.0
- 维护人员：开发团队
