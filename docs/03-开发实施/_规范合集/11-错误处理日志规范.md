# ç½—è±L2Cé”€å”®ç®¡ç†ç³»ç»Ÿ - é”™è¯¯å¤„ç†ä¸æ—¥å¿—è§„èŒƒ

## ğŸ¯ è§„èŒƒç›®æ ‡

### ä¸»è¦ç›®æ ‡
- **ç»Ÿä¸€æ€§**ï¼šå»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•æ ‡å‡†
- **å®‰å…¨æ€§**ï¼šé˜²æ­¢æ•æ„Ÿä¿¡æ¯é€šè¿‡é”™è¯¯ä¿¡æ¯æˆ–æ—¥å¿—æ³„éœ²
- **å¯è¿½æº¯æ€§**ï¼šç¡®ä¿é—®é¢˜èƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œæ’æŸ¥
- **å¯ç»´æŠ¤æ€§**ï¼šä¾¿äºç³»ç»Ÿç›‘æ§ã€è°ƒè¯•å’Œç»´æŠ¤
- **ç”¨æˆ·ä½“éªŒ**ï¼šä¸ºç”¨æˆ·æä¾›å‹å¥½çš„é”™è¯¯æç¤º

## ğŸ“‹ é”™è¯¯å¤„ç†è§„èŒƒ

### é”™è¯¯åˆ†ç±»ä½“ç³»
```javascript
// é”™è¯¯ç±»å‹å®šä¹‰
const ERROR_TYPES = {
  // ä¸šåŠ¡é”™è¯¯ (4000-4999)
  BUSINESS_ERROR: {
    code: 4000,
    type: 'BUSINESS_ERROR',
    description: 'ä¸šåŠ¡é€»è¾‘é”™è¯¯'
  },
  
  // éªŒè¯é”™è¯¯ (4100-4199)
  VALIDATION_ERROR: {
    code: 4100,
    type: 'VALIDATION_ERROR',
    description: 'æ•°æ®éªŒè¯é”™è¯¯'
  },
  
  // è®¤è¯é”™è¯¯ (4200-4299)
  AUTHENTICATION_ERROR: {
    code: 4200,
    type: 'AUTHENTICATION_ERROR',
    description: 'èº«ä»½è®¤è¯é”™è¯¯'
  },
  
  // æˆæƒé”™è¯¯ (4300-4399)
  AUTHORIZATION_ERROR: {
    code: 4300,
    type: 'AUTHORIZATION_ERROR',
    description: 'æƒé™æˆæƒé”™è¯¯'
  },
  
  // èµ„æºé”™è¯¯ (4400-4499)
  RESOURCE_ERROR: {
    code: 4400,
    type: 'RESOURCE_ERROR',
    description: 'èµ„æºè®¿é—®é”™è¯¯'
  },
  
  // ç³»ç»Ÿé”™è¯¯ (5000-5999)
  SYSTEM_ERROR: {
    code: 5000,
    type: 'SYSTEM_ERROR',
    description: 'ç³»ç»Ÿå†…éƒ¨é”™è¯¯'
  },
  
  // æ•°æ®åº“é”™è¯¯ (5100-5199)
  DATABASE_ERROR: {
    code: 5100,
    type: 'DATABASE_ERROR',
    description: 'æ•°æ®åº“æ“ä½œé”™è¯¯'
  },
  
  // å¤–éƒ¨æœåŠ¡é”™è¯¯ (5200-5299)
  EXTERNAL_SERVICE_ERROR: {
    code: 5200,
    type: 'EXTERNAL_SERVICE_ERROR',
    description: 'å¤–éƒ¨æœåŠ¡è°ƒç”¨é”™è¯¯'
  },
  
  // ç½‘ç»œé”™è¯¯ (5300-5399)
  NETWORK_ERROR: {
    code: 5300,
    type: 'NETWORK_ERROR',
    description: 'ç½‘ç»œè¿æ¥é”™è¯¯'
  }
};

// å…·ä½“é”™è¯¯ç å®šä¹‰
const ERROR_CODES = {
  // å®¢æˆ·ç®¡ç†ç›¸å…³é”™è¯¯ (4001-4099)
  CUSTOMER_NOT_FOUND: {
    code: 4001,
    type: 'BUSINESS_ERROR',
    message: 'å®¢æˆ·ä¸å­˜åœ¨',
    userMessage: 'æœªæ‰¾åˆ°æŒ‡å®šçš„å®¢æˆ·ä¿¡æ¯'
  },
  CUSTOMER_ALREADY_EXISTS: {
    code: 4002,
    type: 'BUSINESS_ERROR',
    message: 'å®¢æˆ·å·²å­˜åœ¨',
    userMessage: 'è¯¥å®¢æˆ·ä¿¡æ¯å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æ·»åŠ '
  },
  CUSTOMER_HAS_ACTIVE_ORDERS: {
    code: 4003,
    type: 'BUSINESS_ERROR',
    message: 'å®¢æˆ·æœ‰æœªå®Œæˆè®¢å•',
    userMessage: 'è¯¥å®¢æˆ·è¿˜æœ‰æœªå®Œæˆçš„è®¢å•ï¼Œæ— æ³•åˆ é™¤'
  },
  
  // è®¢å•ç®¡ç†ç›¸å…³é”™è¯¯ (4011-4099)
  ORDER_NOT_FOUND: {
    code: 4011,
    type: 'BUSINESS_ERROR',
    message: 'è®¢å•ä¸å­˜åœ¨',
    userMessage: 'æœªæ‰¾åˆ°æŒ‡å®šçš„è®¢å•ä¿¡æ¯'
  },
  ORDER_STATUS_INVALID: {
    code: 4012,
    type: 'BUSINESS_ERROR',
    message: 'è®¢å•çŠ¶æ€æ— æ•ˆ',
    userMessage: 'å½“å‰è®¢å•çŠ¶æ€ä¸å…è®¸æ­¤æ“ä½œ'
  },
  ORDER_AMOUNT_INVALID: {
    code: 4013,
    type: 'BUSINESS_ERROR',
    message: 'è®¢å•é‡‘é¢æ— æ•ˆ',
    userMessage: 'è®¢å•é‡‘é¢å¿…é¡»å¤§äº0'
  },
  
  // æ•°æ®éªŒè¯é”™è¯¯ (4101-4199)
  PHONE_NUMBER_INVALID: {
    code: 4101,
    type: 'VALIDATION_ERROR',
    message: 'æ‰‹æœºå·æ ¼å¼æ— æ•ˆ',
    userMessage: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç '
  },
  EMAIL_INVALID: {
    code: 4102,
    type: 'VALIDATION_ERROR',
    message: 'é‚®ç®±æ ¼å¼æ— æ•ˆ',
    userMessage: 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€'
  },
  REQUIRED_FIELD_MISSING: {
    code: 4103,
    type: 'VALIDATION_ERROR',
    message: 'å¿…å¡«å­—æ®µç¼ºå¤±',
    userMessage: 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ'
  },
  
  // è®¤è¯ç›¸å…³é”™è¯¯ (4201-4299)
  TOKEN_INVALID: {
    code: 4201,
    type: 'AUTHENTICATION_ERROR',
    message: 'ä»¤ç‰Œæ— æ•ˆ',
    userMessage: 'ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
  },
  TOKEN_EXPIRED: {
    code: 4202,
    type: 'AUTHENTICATION_ERROR',
    message: 'ä»¤ç‰Œå·²è¿‡æœŸ',
    userMessage: 'ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
  },
  LOGIN_FAILED: {
    code: 4203,
    type: 'AUTHENTICATION_ERROR',
    message: 'ç™»å½•å¤±è´¥',
    userMessage: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
  },
  
  // æƒé™ç›¸å…³é”™è¯¯ (4301-4399)
  PERMISSION_DENIED: {
    code: 4301,
    type: 'AUTHORIZATION_ERROR',
    message: 'æƒé™ä¸è¶³',
    userMessage: 'æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ'
  },
  ROLE_INSUFFICIENT: {
    code: 4302,
    type: 'AUTHORIZATION_ERROR',
    message: 'è§’è‰²æƒé™ä¸è¶³',
    userMessage: 'å½“å‰è§’è‰²æ— æ³•æ‰§è¡Œæ­¤æ“ä½œ'
  },
  
  // ç³»ç»Ÿé”™è¯¯ (5001-5099)
  INTERNAL_SERVER_ERROR: {
    code: 5001,
    type: 'SYSTEM_ERROR',
    message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    userMessage: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•'
  },
  SERVICE_UNAVAILABLE: {
    code: 5002,
    type: 'SYSTEM_ERROR',
    message: 'æœåŠ¡ä¸å¯ç”¨',
    userMessage: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'
  },
  
  // æ•°æ®åº“é”™è¯¯ (5101-5199)
  DATABASE_CONNECTION_FAILED: {
    code: 5101,
    type: 'DATABASE_ERROR',
    message: 'æ•°æ®åº“è¿æ¥å¤±è´¥',
    userMessage: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•'
  },
  DATABASE_QUERY_FAILED: {
    code: 5102,
    type: 'DATABASE_ERROR',
    message: 'æ•°æ®åº“æŸ¥è¯¢å¤±è´¥',
    userMessage: 'æ•°æ®æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
  }
};
```

### è‡ªå®šä¹‰é”™è¯¯ç±»
```javascript
// errors/BaseError.js
class BaseError extends Error {
  constructor(errorCode, details = null, cause = null) {
    const errorInfo = ERROR_CODES[errorCode] || ERROR_CODES.INTERNAL_SERVER_ERROR;
    
    super(errorInfo.message);
    
    this.name = this.constructor.name;
    this.code = errorInfo.code;
    this.type = errorInfo.type;
    this.userMessage = errorInfo.userMessage;
    this.details = details;
    this.cause = cause;
    this.timestamp = new Date().toISOString();
    this.traceId = this.generateTraceId();
    
    // ä¿æŒå †æ ˆè·Ÿè¸ª
    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, this.constructor);
    }
  }
  
  generateTraceId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
  
  toJSON() {
    return {
      name: this.name,
      code: this.code,
      type: this.type,
      message: this.message,
      userMessage: this.userMessage,
      details: this.details,
      timestamp: this.timestamp,
      traceId: this.traceId,
      stack: this.stack
    };
  }
  
  // è·å–ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
  getUserMessage() {
    return this.userMessage || 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•';
  }
  
  // è·å–HTTPçŠ¶æ€ç 
  getHttpStatus() {
    if (this.code >= 4000 && this.code < 5000) {
      return 400; // å®¢æˆ·ç«¯é”™è¯¯
    } else if (this.code >= 5000) {
      return 500; // æœåŠ¡å™¨é”™è¯¯
    }
    return 500;
  }
}

// ä¸šåŠ¡é”™è¯¯ç±»
class BusinessError extends BaseError {
  constructor(errorCode, details = null, cause = null) {
    super(errorCode, details, cause);
  }
}

// éªŒè¯é”™è¯¯ç±»
class ValidationError extends BaseError {
  constructor(errorCode, details = null, cause = null) {
    super(errorCode, details, cause);
  }
}

// ç³»ç»Ÿé”™è¯¯ç±»
class SystemError extends BaseError {
  constructor(errorCode, details = null, cause = null) {
    super(errorCode, details, cause);
  }
}

module.exports = {
  BaseError,
  BusinessError,
  ValidationError,
  SystemError,
  ERROR_CODES
};
```

### é”™è¯¯å¤„ç†ä¸­é—´ä»¶
```javascript
// middleware/errorHandler.js
const { BaseError } = require('../errors/BaseError');
const logger = require('../utils/logger');

class ErrorHandler {
  // å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
  static handle(error, req, res, next) {
    // è®°å½•é”™è¯¯æ—¥å¿—
    logger.error('Error occurred:', {
      error: error.toJSON ? error.toJSON() : error,
      request: {
        method: req.method,
        url: req.url,
        headers: req.headers,
        body: req.body,
        user: req.user?.id
      }
    });
    
    // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
    if (error instanceof BaseError) {
      return this.handleCustomError(error, res);
    } else if (error.name === 'ValidationError') {
      return this.handleValidationError(error, res);
    } else if (error.name === 'CastError') {
      return this.handleCastError(error, res);
    } else if (error.code === 11000) {
      return this.handleDuplicateError(error, res);
    } else if (error.name === 'JsonWebTokenError') {
      return this.handleJWTError(error, res);
    } else {
      return this.handleUnknownError(error, res);
    }
  }
  
  // å¤„ç†è‡ªå®šä¹‰é”™è¯¯
  static handleCustomError(error, res) {
    res.status(error.getHttpStatus()).json({
      success: false,
      error: {
        code: error.code,
        type: error.type,
        message: error.getUserMessage(),
        traceId: error.traceId,
        timestamp: error.timestamp,
        details: error.details
      }
    });
  }
  
  // å¤„ç†éªŒè¯é”™è¯¯
  static handleValidationError(error, res) {
    const details = Object.values(error.errors).map(err => ({
      field: err.path,
      message: err.message,
      value: err.value
    }));
    
    res.status(400).json({
      success: false,
      error: {
        code: 4100,
        type: 'VALIDATION_ERROR',
        message: 'æ•°æ®éªŒè¯å¤±è´¥',
        details
      }
    });
  }
  
  // å¤„ç†ç±»å‹è½¬æ¢é”™è¯¯
  static handleCastError(error, res) {
    res.status(400).json({
      success: false,
      error: {
        code: 4104,
        type: 'VALIDATION_ERROR',
        message: 'æ•°æ®æ ¼å¼é”™è¯¯',
        details: {
          field: error.path,
          value: error.value,
          expectedType: error.kind
        }
      }
    });
  }
  
  // å¤„ç†é‡å¤æ•°æ®é”™è¯¯
  static handleDuplicateError(error, res) {
    const field = Object.keys(error.keyValue)[0];
    const value = error.keyValue[field];
    
    res.status(400).json({
      success: false,
      error: {
        code: 4105,
        type: 'VALIDATION_ERROR',
        message: 'æ•°æ®å·²å­˜åœ¨',
        details: {
          field,
          value,
          message: `${field} '${value}' å·²å­˜åœ¨`
        }
      }
    });
  }
  
  // å¤„ç†JWTé”™è¯¯
  static handleJWTError(error, res) {
    res.status(401).json({
      success: false,
      error: {
        code: 4201,
        type: 'AUTHENTICATION_ERROR',
        message: 'èº«ä»½éªŒè¯å¤±è´¥',
        details: {
          reason: error.message
        }
      }
    });
  }
  
  // å¤„ç†æœªçŸ¥é”™è¯¯
  static handleUnknownError(error, res) {
    // ç”Ÿæˆé”™è¯¯è¿½è¸ªID
    const traceId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
    logger.error('Unknown error occurred:', {
      traceId,
      error: {
        name: error.name,
        message: error.message,
        stack: error.stack
      }
    });
    
    res.status(500).json({
      success: false,
      error: {
        code: 5001,
        type: 'SYSTEM_ERROR',
        message: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•',
        traceId
      }
    });
  }
  
  // å¼‚æ­¥é”™è¯¯å¤„ç†åŒ…è£…å™¨
  static asyncHandler(fn) {
    return (req, res, next) => {
      Promise.resolve(fn(req, res, next)).catch(next);
    };
  }
}

module.exports = ErrorHandler;
```

## ğŸ“ æ—¥å¿—è®°å½•è§„èŒƒ

### æ—¥å¿—çº§åˆ«å®šä¹‰
```javascript
// æ—¥å¿—çº§åˆ«å®šä¹‰
const LOG_LEVELS = {
  ERROR: {
    level: 0,
    name: 'error',
    description: 'é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦ç«‹å³å…³æ³¨'
  },
  WARN: {
    level: 1,
    name: 'warn',
    description: 'è­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜'
  },
  INFO: {
    level: 2,
    name: 'info',
    description: 'ä¸€èˆ¬ä¿¡æ¯ï¼Œè®°å½•é‡è¦æ“ä½œ'
  },
  DEBUG: {
    level: 3,
    name: 'debug',
    description: 'è°ƒè¯•ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨'
  }
};

// æ—¥å¿—åˆ†ç±»
const LOG_CATEGORIES = {
  SYSTEM: 'system',           // ç³»ç»Ÿæ—¥å¿—
  BUSINESS: 'business',       // ä¸šåŠ¡æ—¥å¿—
  SECURITY: 'security',       // å®‰å…¨æ—¥å¿—
  PERFORMANCE: 'performance', // æ€§èƒ½æ—¥å¿—
  AUDIT: 'audit',            // å®¡è®¡æ—¥å¿—
  ACCESS: 'access'           // è®¿é—®æ—¥å¿—
};
```

### æ—¥å¿—è®°å½•å™¨å®ç°
```javascript
// utils/logger.js
const winston = require('winston');
const path = require('path');
const config = require('../config/config');

class Logger {
  constructor() {
    this.logger = this.createLogger();
  }
  
  createLogger() {
    const logFormat = winston.format.combine(
      winston.format.timestamp({
        format: 'YYYY-MM-DD HH:mm:ss.SSS'
      }),
      winston.format.errors({ stack: true }),
      winston.format.json(),
      winston.format.printf(({ timestamp, level, message, ...meta }) => {
        return JSON.stringify({
          timestamp,
          level,
          message,
          ...meta
        });
      })
    );
    
    const transports = [
      // æ§åˆ¶å°è¾“å‡º
      new winston.transports.Console({
        level: config.get('LOG_LEVEL', 'info'),
        format: winston.format.combine(
          winston.format.colorize(),
          winston.format.simple()
        )
      }),
      
      // é”™è¯¯æ—¥å¿—æ–‡ä»¶
      new winston.transports.File({
        filename: path.join(config.get('LOG_FILE_PATH', './logs'), 'error.log'),
        level: 'error',
        format: logFormat,
        maxsize: 100 * 1024 * 1024, // 100MB
        maxFiles: 30
      }),
      
      // ç»¼åˆæ—¥å¿—æ–‡ä»¶
      new winston.transports.File({
        filename: path.join(config.get('LOG_FILE_PATH', './logs'), 'combined.log'),
        format: logFormat,
        maxsize: 100 * 1024 * 1024, // 100MB
        maxFiles: 30
      }),
      
      // ä¸šåŠ¡æ—¥å¿—æ–‡ä»¶
      new winston.transports.File({
        filename: path.join(config.get('LOG_FILE_PATH', './logs'), 'business.log'),
        level: 'info',
        format: logFormat,
        maxsize: 100 * 1024 * 1024, // 100MB
        maxFiles: 30
      })
    ];
    
    return winston.createLogger({
      level: config.get('LOG_LEVEL', 'info'),
      format: logFormat,
      transports,
      exitOnError: false
    });
  }
  
  // åŸºç¡€æ—¥å¿—æ–¹æ³•
  log(level, message, meta = {}) {
    const logData = {
      ...meta,
      category: meta.category || LOG_CATEGORIES.SYSTEM,
      traceId: meta.traceId || this.generateTraceId(),
      userId: meta.userId,
      sessionId: meta.sessionId,
      ip: meta.ip,
      userAgent: meta.userAgent
    };
    
    // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
    const filteredData = this.filterSensitiveData(logData);
    
    this.logger.log(level, message, filteredData);
  }
  
  // é”™è¯¯æ—¥å¿—
  error(message, meta = {}) {
    this.log('error', message, {
      ...meta,
      category: LOG_CATEGORIES.SYSTEM
    });
  }
  
  // è­¦å‘Šæ—¥å¿—
  warn(message, meta = {}) {
    this.log('warn', message, {
      ...meta,
      category: LOG_CATEGORIES.SYSTEM
    });
  }
  
  // ä¿¡æ¯æ—¥å¿—
  info(message, meta = {}) {
    this.log('info', message, {
      ...meta,
      category: LOG_CATEGORIES.SYSTEM
    });
  }
  
  // è°ƒè¯•æ—¥å¿—
  debug(message, meta = {}) {
    this.log('debug', message, {
      ...meta,
      category: LOG_CATEGORIES.SYSTEM
    });
  }
  
  // ä¸šåŠ¡æ—¥å¿—
  business(action, details, meta = {}) {
    this.log('info', `Business action: ${action}`, {
      ...meta,
      category: LOG_CATEGORIES.BUSINESS,
      action,
      details
    });
  }
  
  // å®‰å…¨æ—¥å¿—
  security(event, details, meta = {}) {
    this.log('warn', `Security event: ${event}`, {
      ...meta,
      category: LOG_CATEGORIES.SECURITY,
      event,
      details
    });
  }
  
  // æ€§èƒ½æ—¥å¿—
  performance(operation, duration, meta = {}) {
    this.log('info', `Performance: ${operation}`, {
      ...meta,
      category: LOG_CATEGORIES.PERFORMANCE,
      operation,
      duration,
      unit: 'ms'
    });
  }
  
  // å®¡è®¡æ—¥å¿—
  audit(action, resource, meta = {}) {
    this.log('info', `Audit: ${action} on ${resource}`, {
      ...meta,
      category: LOG_CATEGORIES.AUDIT,
      action,
      resource
    });
  }
  
  // è®¿é—®æ—¥å¿—
  access(method, url, statusCode, responseTime, meta = {}) {
    this.log('info', `Access: ${method} ${url}`, {
      ...meta,
      category: LOG_CATEGORIES.ACCESS,
      method,
      url,
      statusCode,
      responseTime
    });
  }
  
  // è¿‡æ»¤æ•æ„Ÿæ•°æ®
  filterSensitiveData(data) {
    const sensitiveFields = [
      'password', 'token', 'secret', 'key', 'authorization',
      'cookie', 'session', 'credit_card', 'ssn', 'phone'
    ];
    
    const filtered = { ...data };
    
    const maskValue = (obj, path = '') => {
      for (const key in obj) {
        const currentPath = path ? `${path}.${key}` : key;
        
        if (typeof obj[key] === 'object' && obj[key] !== null) {
          maskValue(obj[key], currentPath);
        } else if (sensitiveFields.some(field => 
          key.toLowerCase().includes(field.toLowerCase())
        )) {
          obj[key] = '***MASKED***';
        }
      }
    };
    
    maskValue(filtered);
    return filtered;
  }
  
  // ç”Ÿæˆè¿½è¸ªID
  generateTraceId() {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
}

module.exports = new Logger();
```

### è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
```javascript
// middleware/requestLogger.js
const logger = require('../utils/logger');

class RequestLogger {
  static middleware() {
    return (req, res, next) => {
      const startTime = Date.now();
      const traceId = logger.generateTraceId();
      
      // å°†è¿½è¸ªIDæ·»åŠ åˆ°è¯·æ±‚å¯¹è±¡
      req.traceId = traceId;
      
      // è®°å½•è¯·æ±‚å¼€å§‹
      logger.access(req.method, req.url, null, null, {
        traceId,
        userId: req.user?.id,
        ip: req.ip,
        userAgent: req.get('User-Agent'),
        requestBody: this.sanitizeRequestBody(req.body),
        query: req.query,
        params: req.params
      });
      
      // ç›‘å¬å“åº”ç»“æŸ
      res.on('finish', () => {
        const responseTime = Date.now() - startTime;
        
        logger.access(req.method, req.url, res.statusCode, responseTime, {
          traceId,
          userId: req.user?.id,
          ip: req.ip,
          userAgent: req.get('User-Agent'),
          responseTime
        });
      });
      
      next();
    };
  }
  
  // æ¸…ç†è¯·æ±‚ä½“ä¸­çš„æ•æ„Ÿä¿¡æ¯
  static sanitizeRequestBody(body) {
    if (!body || typeof body !== 'object') {
      return body;
    }
    
    const sanitized = { ...body };
    const sensitiveFields = ['password', 'token', 'secret'];
    
    sensitiveFields.forEach(field => {
      if (sanitized[field]) {
        sanitized[field] = '***MASKED***';
      }
    });
    
    return sanitized;
  }
}

module.exports = RequestLogger;
```

## ğŸ” æ—¥å¿—åˆ†æå’Œç›‘æ§

### æ—¥å¿—èšåˆé…ç½®
```javascript
// config/logAggregation.js
const elasticsearch = require('@elastic/elasticsearch');
const config = require('./config');

class LogAggregation {
  constructor() {
    this.client = new elasticsearch.Client({
      node: config.get('ELASTICSEARCH_URL', 'http://localhost:9200')
    });
  }
  
  // å‘é€æ—¥å¿—åˆ°Elasticsearch
  async sendLog(logData) {
    try {
      await this.client.index({
        index: `luolai-l2c-logs-${new Date().toISOString().slice(0, 7)}`,
        body: {
          ...logData,
          '@timestamp': new Date().toISOString()
        }
      });
    } catch (error) {
      console.error('Failed to send log to Elasticsearch:', error);
    }
  }
  
  // æŸ¥è¯¢é”™è¯¯æ—¥å¿—
  async queryErrorLogs(startTime, endTime, filters = {}) {
    const query = {
      bool: {
        must: [
          {
            range: {
              '@timestamp': {
                gte: startTime,
                lte: endTime
              }
            }
          },
          {
            term: {
              level: 'error'
            }
          }
        ]
      }
    };
    
    // æ·»åŠ è¿‡æ»¤æ¡ä»¶
    if (filters.userId) {
      query.bool.must.push({
        term: { userId: filters.userId }
      });
    }
    
    if (filters.category) {
      query.bool.must.push({
        term: { category: filters.category }
      });
    }
    
    try {
      const response = await this.client.search({
        index: 'luolai-l2c-logs-*',
        body: {
          query,
          sort: [
            { '@timestamp': { order: 'desc' } }
          ],
          size: 100
        }
      });
      
      return response.body.hits.hits.map(hit => hit._source);
    } catch (error) {
      console.error('Failed to query error logs:', error);
      return [];
    }
  }
}

module.exports = LogAggregation;
```

### æ—¥å¿—å‘Šè­¦é…ç½®
```javascript
// monitoring/logAlerts.js
const logger = require('../utils/logger');
const config = require('../config/config');

class LogAlerts {
  constructor() {
    this.errorThreshold = config.getNumber('ERROR_THRESHOLD_PER_MINUTE', 10);
    this.warningThreshold = config.getNumber('WARNING_THRESHOLD_PER_MINUTE', 50);
    this.errorCounts = new Map();
    this.warningCounts = new Map();
    
    // æ¯åˆ†é’Ÿé‡ç½®è®¡æ•°å™¨
    setInterval(() => {
      this.resetCounters();
    }, 60000);
  }
  
  // æ£€æŸ¥é”™è¯¯é¢‘ç‡
  checkErrorFrequency(error) {
    const minute = Math.floor(Date.now() / 60000);
    const currentCount = this.errorCounts.get(minute) || 0;
    this.errorCounts.set(minute, currentCount + 1);
    
    if (currentCount + 1 >= this.errorThreshold) {
      this.sendAlert('ERROR_THRESHOLD_EXCEEDED', {
        count: currentCount + 1,
        threshold: this.errorThreshold,
        minute
      });
    }
  }
  
  // æ£€æŸ¥è­¦å‘Šé¢‘ç‡
  checkWarningFrequency(warning) {
    const minute = Math.floor(Date.now() / 60000);
    const currentCount = this.warningCounts.get(minute) || 0;
    this.warningCounts.set(minute, currentCount + 1);
    
    if (currentCount + 1 >= this.warningThreshold) {
      this.sendAlert('WARNING_THRESHOLD_EXCEEDED', {
        count: currentCount + 1,
        threshold: this.warningThreshold,
        minute
      });
    }
  }
  
  // å‘é€å‘Šè­¦
  async sendAlert(type, data) {
    const alertData = {
      type,
      timestamp: new Date().toISOString(),
      data,
      severity: type.includes('ERROR') ? 'high' : 'medium'
    };
    
    // è®°å½•å‘Šè­¦æ—¥å¿—
    logger.error('Log alert triggered', {
      category: 'ALERT',
      alert: alertData
    });
    
    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    await this.sendToMonitoringSystem(alertData);
    
    // å‘é€é‚®ä»¶é€šçŸ¥
    await this.sendEmailNotification(alertData);
  }
  
  // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
  async sendToMonitoringSystem(alertData) {
    // å®ç°å‘é€åˆ°Prometheusã€Grafanaç­‰ç›‘æ§ç³»ç»Ÿçš„é€»è¾‘
  }
  
  // å‘é€é‚®ä»¶é€šçŸ¥
  async sendEmailNotification(alertData) {
    // å®ç°é‚®ä»¶é€šçŸ¥é€»è¾‘
  }
  
  // é‡ç½®è®¡æ•°å™¨
  resetCounters() {
    const currentMinute = Math.floor(Date.now() / 60000);
    
    // æ¸…ç†5åˆ†é’Ÿå‰çš„æ•°æ®
    for (const [minute] of this.errorCounts) {
      if (minute < currentMinute - 5) {
        this.errorCounts.delete(minute);
      }
    }
    
    for (const [minute] of this.warningCounts) {
      if (minute < currentMinute - 5) {
        this.warningCounts.delete(minute);
      }
    }
  }
}

module.exports = LogAlerts;
```

## ğŸš€ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
```javascript
// âœ… æ­£ç¡®çš„é”™è¯¯å¤„ç†æ–¹å¼
async function createCustomer(customerData) {
  try {
    // æ•°æ®éªŒè¯
    const validationResult = validateCustomerData(customerData);
    if (!validationResult.isValid) {
      throw new ValidationError('REQUIRED_FIELD_MISSING', {
        fields: validationResult.missingFields
      });
    }
    
    // æ£€æŸ¥å®¢æˆ·æ˜¯å¦å·²å­˜åœ¨
    const existingCustomer = await Customer.findOne({
      phoneNumber: customerData.phoneNumber
    });
    
    if (existingCustomer) {
      throw new BusinessError('CUSTOMER_ALREADY_EXISTS', {
        phoneNumber: customerData.phoneNumber
      });
    }
    
    // åˆ›å»ºå®¢æˆ·
    const customer = await Customer.create(customerData);
    
    // è®°å½•ä¸šåŠ¡æ—¥å¿—
    logger.business('CREATE_CUSTOMER', {
      customerId: customer.id,
      customerName: customer.name
    }, {
      userId: req.user.id,
      traceId: req.traceId
    });
    
    return customer;
    
  } catch (error) {
    // è®°å½•é”™è¯¯æ—¥å¿—
    logger.error('Failed to create customer', {
      error: error.toJSON ? error.toJSON() : error,
      customerData: logger.filterSensitiveData(customerData),
      userId: req.user?.id,
      traceId: req.traceId
    });
    
    throw error;
  }
}
```

### 2. æ—¥å¿—è®°å½•æœ€ä½³å®è·µ
```javascript
// âœ… æ­£ç¡®çš„æ—¥å¿—è®°å½•æ–¹å¼
class CustomerService {
  async updateCustomer(customerId, updateData, userId) {
    const startTime = Date.now();
    
    try {
      // è®°å½•æ“ä½œå¼€å§‹
      logger.info('Starting customer update', {
        customerId,
        userId,
        operation: 'UPDATE_CUSTOMER'
      });
      
      const customer = await Customer.findById(customerId);
      if (!customer) {
        throw new BusinessError('CUSTOMER_NOT_FOUND', { customerId });
      }
      
      const oldData = customer.toJSON();
      const updatedCustomer = await customer.update(updateData);
      
      // è®°å½•å®¡è®¡æ—¥å¿—
      logger.audit('UPDATE_CUSTOMER', 'customer', {
        customerId,
        userId,
        oldData: logger.filterSensitiveData(oldData),
        newData: logger.filterSensitiveData(updatedCustomer.toJSON()),
        changes: this.getChanges(oldData, updatedCustomer.toJSON())
      });
      
      // è®°å½•æ€§èƒ½æ—¥å¿—
      const duration = Date.now() - startTime;
      logger.performance('UPDATE_CUSTOMER', duration, {
        customerId,
        userId
      });
      
      return updatedCustomer;
      
    } catch (error) {
      logger.error('Customer update failed', {
        error: error.toJSON ? error.toJSON() : error,
        customerId,
        userId,
        duration: Date.now() - startTime
      });
      
      throw error;
    }
  }
  
  getChanges(oldData, newData) {
    const changes = {};
    for (const key in newData) {
      if (oldData[key] !== newData[key]) {
        changes[key] = {
          old: oldData[key],
          new: newData[key]
        };
      }
    }
    return changes;
  }
}
```

### 3. æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ
```javascript
// utils/logAnalyzer.js
class LogAnalyzer {
  // åˆ†æé”™è¯¯è¶‹åŠ¿
  async analyzeErrorTrends(timeRange) {
    const logs = await this.queryLogs({
      level: 'error',
      timeRange
    });
    
    const trends = {};
    logs.forEach(log => {
      const hour = new Date(log.timestamp).getHours();
      trends[hour] = (trends[hour] || 0) + 1;
    });
    
    return trends;
  }
  
  // åˆ†æç”¨æˆ·è¡Œä¸º
  async analyzeUserBehavior(userId, timeRange) {
    const logs = await this.queryLogs({
      userId,
      category: 'business',
      timeRange
    });
    
    const actions = logs.map(log => ({
      action: log.action,
      timestamp: log.timestamp,
      details: log.details
    }));
    
    return actions;
  }
  
  // æ€§èƒ½åˆ†æ
  async analyzePerformance(operation, timeRange) {
    const logs = await this.queryLogs({
      category: 'performance',
      operation,
      timeRange
    });
    
    const durations = logs.map(log => log.duration);
    
    return {
      average: durations.reduce((a, b) => a + b, 0) / durations.length,
      min: Math.min(...durations),
      max: Math.max(...durations),
      count: durations.length
    };
  }
}
```

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
```javascript
// æ•æ„Ÿä¿¡æ¯è¿‡æ»¤è§„åˆ™
const SENSITIVE_PATTERNS = [
  /password/i,
  /token/i,
  /secret/i,
  /key/i,
  /authorization/i,
  /credit[_-]?card/i,
  /ssn/i,
  /social[_-]?security/i,
  /\b\d{4}[_-]?\d{4}[_-]?\d{4}[_-]?\d{4}\b/, // ä¿¡ç”¨å¡å·
  /\b\d{3}[_-]?\d{2}[_-]?\d{4}\b/,           // SSN
  /\b1[3-9]\d{9}\b/                          // æ‰‹æœºå·
];

function sanitizeLogData(data) {
  const sanitized = JSON.parse(JSON.stringify(data));
  
  function maskSensitiveData(obj, path = '') {
    for (const key in obj) {
      const value = obj[key];
      const fullPath = path ? `${path}.${key}` : key;
      
      if (typeof value === 'object' && value !== null) {
        maskSensitiveData(value, fullPath);
      } else if (typeof value === 'string') {
        // æ£€æŸ¥å­—æ®µåæ˜¯å¦åŒ…å«æ•æ„Ÿè¯
        const isSensitiveField = SENSITIVE_PATTERNS.some(pattern => 
          pattern.test(key)
        );
        
        // æ£€æŸ¥å€¼æ˜¯å¦åŒ¹é…æ•æ„Ÿæ¨¡å¼
        const isSensitiveValue = SENSITIVE_PATTERNS.some(pattern => 
          pattern.test(value)
        );
        
        if (isSensitiveField || isSensitiveValue) {
          obj[key] = '***MASKED***';
        }
      }
    }
  }
  
  maskSensitiveData(sanitized);
  return sanitized;
}
```

### 2. æ—¥å¿—è®¿é—®æ§åˆ¶
```javascript
// middleware/logAccess.js
class LogAccessControl {
  static checkLogAccess(req, res, next) {
    const userRole = req.user?.role;
    const requestedLogLevel = req.query.level;
    
    // åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹é”™è¯¯æ—¥å¿—
    if (requestedLogLevel === 'error' && userRole !== 'admin') {
      return res.status(403).json({
        success: false,
        error: {
          code: 4301,
          message: 'æƒé™ä¸è¶³ï¼Œæ— æ³•æŸ¥çœ‹é”™è¯¯æ—¥å¿—'
        }
      });
    }
    
    // åªæœ‰ç®¡ç†å‘˜å’Œç»ç†å¯ä»¥æŸ¥çœ‹å®¡è®¡æ—¥å¿—
    if (req.path.includes('/audit') && !['admin', 'manager'].includes(userRole)) {
      return res.status(403).json({
        success: false,
        error: {
          code: 4301,
          message: 'æƒé™ä¸è¶³ï¼Œæ— æ³•æŸ¥çœ‹å®¡è®¡æ—¥å¿—'
        }
      });
    }
    
    next();
  }
}
```

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬æ–‡æ¡£åº”éšç€ç³»ç»Ÿéœ€æ±‚å˜åŒ–åŠæ—¶æ›´æ–°ï¼Œç¡®ä¿é”™è¯¯å¤„ç†å’Œæ—¥å¿—è§„èŒƒçš„å‡†ç¡®æ€§å’Œå®ç”¨æ€§ã€‚

**ç‰ˆæœ¬ä¿¡æ¯**ï¼š
- åˆ›å»ºæ—¶é—´ï¼š2024-01-15
- æœ€åæ›´æ–°ï¼š2024-01-15
- æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0
- ç»´æŠ¤äººå‘˜ï¼šå¼€å‘å›¢é˜Ÿ