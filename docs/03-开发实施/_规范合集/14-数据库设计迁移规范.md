# 罗莱L2C销售管理系统 - 数据库设计与迁移规范

## 1. 规范目标

### 1.1 核心目标
- **一致性**: 统一数据库设计标准和命名规范
- **可维护性**: 确保数据库结构清晰、易于维护
- **可扩展性**: 支持业务增长和功能扩展
- **性能优化**: 提供高效的数据访问和查询性能
- **数据完整性**: 保证数据的准确性和一致性

### 1.2 适用范围
- PostgreSQL 15+ 数据库设计
- 数据库迁移脚本
- 索引设计和优化
- 数据备份和恢复

## 2. 数据库设计原则

### 2.1 命名规范

#### 2.1.1 数据库命名
```sql
-- 格式: l2c_{环境}_{业务模块}
l2c_dev_sales     -- 开发环境销售模块
l2c_test_sales    -- 测试环境销售模块
l2c_prod_sales    -- 生产环境销售模块
```

#### 2.1.2 表命名规范
```sql
-- 格式: {业务前缀}_{实体名称}
-- 业务前缀:
-- usr_ : 用户相关
-- prd_ : 产品相关
-- ord_ : 订单相关
-- inv_ : 库存相关
-- fin_ : 财务相关
-- sys_ : 系统相关

usr_users          -- 用户表
usr_roles          -- 角色表
usr_permissions    -- 权限表
prd_products       -- 产品表
prd_categories     -- 产品分类表
ord_orders         -- 订单表
ord_order_items    -- 订单明细表
inv_inventory      -- 库存表
fin_payments       -- 支付记录表
sys_configs        -- 系统配置表
```

#### 2.1.3 字段命名规范
```sql
-- 主键: id (BIGSERIAL PRIMARY KEY)
-- 外键: {关联表前缀}_id
-- 创建时间: created_at (DATETIME)
-- 更新时间: updated_at (DATETIME)
-- 删除时间: deleted_at (DATETIME, 软删除)
-- 状态字段: status (TINYINT)
-- 排序字段: sort_order (INT)

CREATE TABLE usr_users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ NULL
);
```

### 2.2 数据类型规范

#### 2.2.1 字符串与文档类型（PostgreSQL）
```sql
-- 短字符串 (≤50字符): VARCHAR(50)
-- 中等字符串 (≤255字符): VARCHAR(255)
-- 长文本: TEXT
-- 文档/结构化数据: JSONB
-- 标识符: UUID

username VARCHAR(50)
title VARCHAR(255)
description TEXT
payload JSONB
entity_id UUID DEFAULT gen_random_uuid()
```

#### 2.2.2 数值类型（PostgreSQL）
```sql
-- 主键: BIGSERIAL 或 GENERATED ALWAYS AS IDENTITY
-- 外键: BIGINT
-- 整数: INTEGER / BIGINT
-- 小整数: SMALLINT
-- 金额: NUMERIC(10,2)
-- 百分比: NUMERIC(5,2)

id BIGSERIAL
user_id BIGINT
age SMALLINT
price NUMERIC(10,2)
discount_rate NUMERIC(5,2)
```

#### 2.2.3 时间类型（PostgreSQL）
```sql
-- 日期时间: TIMESTAMPTZ（建议）
-- 日期: DATE
-- 时间: TIME

created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
birth_date DATE
work_time TIME
updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
```

### 2.3 索引设计规范

#### 2.3.1 主键索引
```sql
-- 每个表必须有主键
-- 主键使用 BIGSERIAL 或 GENERATED AS IDENTITY
-- 在建表时定义主键

CREATE TABLE usr_users (
  id BIGSERIAL PRIMARY KEY,
  username VARCHAR(50) NOT NULL
);
```

#### 2.3.2 唯一索引
```sql
-- 唯一约束字段创建唯一索引
-- 命名格式: uk_{表名}_{字段名}
CREATE UNIQUE INDEX IF NOT EXISTS uk_usr_users_username ON usr_users(username);
```
ALTER TABLE usr_users ADD UNIQUE INDEX uk_usr_users_username (username);
ALTER TABLE usr_users ADD UNIQUE INDEX uk_usr_users_email (email);
```

#### 2.3.3 普通索引
```sql
-- 查询频繁的字段创建索引
-- 命名格式: idx_{表名}_{字段名}

CREATE INDEX IF NOT EXISTS idx_usr_users_status ON usr_users(status);
CREATE INDEX IF NOT EXISTS idx_usr_users_created_at ON usr_users(created_at);
```

#### 2.3.4 复合索引
```sql
-- 多字段组合查询创建复合索引
-- 命名格式: idx_{表名}_{字段1}_{字段2}

CREATE INDEX IF NOT EXISTS idx_ord_orders_user_status ON ord_orders(user_id, status);
CREATE INDEX IF NOT EXISTS idx_ord_orders_created_status ON ord_orders(created_at, status);
```

## 3. 表结构设计规范

### 3.1 基础字段规范
```sql
-- 每个业务表必须包含的基础字段
CREATE TABLE template_table (
    id BIGSERIAL PRIMARY KEY,
    -- 业务字段...
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at DATETIME NULL COMMENT '删除时间(软删除)',
    
    INDEX idx_template_status (status),
    INDEX idx_template_created_at (created_at),
    INDEX idx_template_deleted_at (deleted_at)
);
```

### 3.2 关联表设计
```sql
-- 多对多关系使用中间表
-- 命名格式: {表1前缀}_{表2前缀}_relations

CREATE TABLE usr_role_relations (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    role_id BIGINT UNSIGNED NOT NULL COMMENT '角色ID',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    UNIQUE KEY uk_usr_role_user_role (user_id, role_id),
    INDEX idx_usr_role_user_id (user_id),
    INDEX idx_usr_role_role_id (role_id),
    
    FOREIGN KEY (user_id) REFERENCES usr_users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES usr_roles(id) ON DELETE CASCADE
);
```

### 3.3 枚举值设计
```sql
-- 状态枚举使用 SMALLINT，并在文档中说明取值范围
-- 创建对应的常量定义

-- 用户状态
status SMALLINT DEFAULT 1

-- 订单状态
order_status SMALLINT DEFAULT 1

-- 支付状态
payment_status SMALLINT DEFAULT 0
```

## 4. 数据库迁移规范

### 4.1 迁移文件命名
```bash
# 格式: YYYY_MM_DD_HHMMSS_操作描述.sql
2024_01_15_143000_create_usr_users_table.sql
2024_01_15_143100_add_phone_to_usr_users_table.sql
2024_01_15_143200_create_index_on_usr_users_email.sql
2024_01_15_143300_alter_usr_users_status_default.sql
```

### 4.2 迁移脚本结构（PostgreSQL）
```sql
-- 迁移脚本模板
-- ==========================================
-- 迁移描述: 创建用户表
-- 创建时间: 2024-01-15 14:30:00
-- 创建人员: 开发者姓名
-- ==========================================

BEGIN;
CREATE TABLE IF NOT EXISTS usr_users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ NULL
);
CREATE UNIQUE INDEX IF NOT EXISTS uk_usr_users_username ON usr_users(username);
CREATE UNIQUE INDEX IF NOT EXISTS uk_usr_users_email ON usr_users(email);
CREATE INDEX IF NOT EXISTS idx_usr_users_status ON usr_users(status);
CREATE INDEX IF NOT EXISTS idx_usr_users_created_at ON usr_users(created_at);

INSERT INTO sys_migrations (migration_name, executed_at, description)
VALUES ('2024_01_15_143000_create_usr_users_table', NOW(), '创建用户表')
ON CONFLICT (migration_name) DO NOTHING;
COMMIT;
```

### 4.3 回滚脚本
```sql
-- 回滚脚本: rollback_2024_01_15_143000_create_usr_users_table.sql
-- ==========================================
-- 回滚描述: 删除用户表
-- 创建时间: 2024-01-15 14:30:00
-- ==========================================

-- 删除表
DROP TABLE IF EXISTS usr_users;

-- 删除迁移记录
DELETE FROM sys_migrations 
WHERE migration_name = '2024_01_15_143000_create_usr_users_table';
```

### 4.4 迁移管理表
```sql
-- 系统迁移记录表
CREATE TABLE sys_migrations (
    id BIGSERIAL PRIMARY KEY,
    migration_name VARCHAR(255) NOT NULL COMMENT '迁移文件名',
    executed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    description TEXT COMMENT '迁移描述',
    
    UNIQUE KEY uk_sys_migrations_name (migration_name),
    INDEX idx_sys_migrations_executed_at (executed_at)
);
```

## 5. 性能优化规范

### 5.1 查询优化
```sql
-- 1. 避免SELECT *，明确指定字段
SELECT id, username, email FROM usr_users WHERE status = 1;

-- 2. 使用LIMIT限制结果集
SELECT id, username FROM usr_users ORDER BY created_at DESC LIMIT 20;

-- 3. 合理使用索引
-- 好的查询（使用索引）
SELECT * FROM usr_users WHERE username = 'john';

-- 避免的查询（无法使用索引）
SELECT * FROM usr_users WHERE UPPER(username) = 'JOHN';
```

### 5.2 索引优化策略
```sql
-- 1. 为WHERE条件字段创建索引
CREATE INDEX IF NOT EXISTS idx_ord_orders_status ON ord_orders(status);

-- 2. 为ORDER BY字段创建索引
CREATE INDEX IF NOT EXISTS idx_ord_orders_created_at ON ord_orders(created_at);

-- 3. 复合索引遵循最左前缀原则
CREATE INDEX IF NOT EXISTS idx_ord_orders_user_status_created ON ord_orders(user_id, status, created_at);
```

### 5.3 分页查询优化
```sql
-- 使用覆盖索引优化深分页
-- 不推荐
SELECT * FROM usr_users ORDER BY id OFFSET 10000 LIMIT 20;

-- 推荐
SELECT u.* FROM usr_users u
INNER JOIN (
    SELECT id FROM usr_users ORDER BY id OFFSET 10000 LIMIT 20
) t ON u.id = t.id;
```

## 6. 数据安全规范

### 6.1 敏感数据处理
```sql
-- 密码字段使用哈希存储
password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希(bcrypt)',

-- 敏感信息加密存储
id_card_encrypted VARCHAR(255) COMMENT '身份证号(AES加密)',
bank_account_encrypted VARCHAR(255) COMMENT '银行账号(AES加密)',

-- 个人信息脱敏
phone_masked VARCHAR(20) COMMENT '手机号脱敏显示',
email_masked VARCHAR(100) COMMENT '邮箱脱敏显示'
```

### 6.2 权限控制
```sql
-- 创建专用数据库角色与用户 (PostgreSQL)
CREATE ROLE l2c_app LOGIN PASSWORD 'strong_password' NOSUPERUSER NOCREATEDB NOCREATEROLE NOINHERIT;

-- 授予最小必要权限（按schema授予）
GRANT USAGE ON SCHEMA public TO l2c_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO l2c_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO l2c_app;
```

## 7. 备份与恢复规范

### 7.1 备份策略
```bash
# 每日全量备份
pg_dump --verbose --clean --no-acl --no-owner \
  --format=custom --compress=9 \
  l2c_prod_sales > backup_20240115.dump

# 模式备份
pg_dump --verbose --schema-only \
  l2c_prod_sales > schema_backup_20240115.sql
```

### 7.2 恢复流程
```bash
# 1. 停止应用服务
systemctl stop l2c-api

# 恢复全量备份
pg_restore --verbose --clean --no-acl --no-owner \
--dbname=l2c_prod_sales backup_20240115.dump

# 恢复模式备份
psql -d l2c_prod_sales -f schema_backup_20240115.sql

# 验证数据完整性
psql -d l2c_prod_sales -c "SELECT COUNT(*) FROM usr_users;"

# 5. 重启应用服务
systemctl start l2c-api
```

## 8. 监控与维护

### 8.1 性能监控
```sql
-- 启用并使用 pg_stat_statements 分析慢查询 (PostgreSQL)
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- 查看最近慢查询
SELECT query,
       calls,
       round(total_time)::int AS total_time_ms,
       round(mean_time,2)     AS mean_time_ms
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 50;
```

### 8.2 空间监控
```sql
-- 监控表空间使用情况 (PostgreSQL)
SELECT 
  schemaname AS table_schema,
  relname    AS table_name,
  pg_size_pretty(pg_total_relation_size(relid)) AS total_size
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC;
```

## 9. 最佳实践

### 9.1 开发阶段
- 使用数据库版本控制工具（如Flyway、Liquibase）
- 每个功能分支创建对应的迁移脚本
- 迁移脚本必须经过代码审查
- 在开发环境充分测试迁移脚本

### 9.2 测试阶段
- 在测试环境验证迁移脚本的正确性
- 测试数据回滚功能
- 验证性能影响
- 确保数据完整性

### 9.3 生产部署
- 在维护窗口执行数据库变更
- 提前备份相关数据
- 准备回滚方案
- 监控部署过程和结果

### 9.4 日常维护
- 定期分析表结构和索引使用情况
- 清理过期数据和日志
- 优化慢查询
- 更新表统计信息

## 10. 常见问题与解决方案

### 10.1 字符集问题
```sql
-- 统一使用 UTF8 编码：在创建数据库时指定
CREATE DATABASE l2c_prod_sales 
  WITH ENCODING 'UTF8' LC_COLLATE 'zh_CN.UTF-8' LC_CTYPE 'zh_CN.UTF-8';
```

### 10.2 时区问题
```sql
-- 设置时区 (PostgreSQL)
SET TIME ZONE 'Asia/Shanghai';

-- JDBC连接字符串示例（PostgreSQL）
jdbc:postgresql://localhost:5432/l2c_prod_sales?options=-c%20TimeZone=Asia/Shanghai
```

### 10.3 锁等待问题
```sql
-- 查看锁等待情况 (PostgreSQL)
SELECT l.*,
       a.query,
       a.state,
       a.wait_event_type,
       a.wait_event
FROM pg_locks l
LEFT JOIN pg_stat_activity a ON l.pid = a.pid;

-- 优化：减少事务时间，合理设计索引
```

---

**文档版本**: v1.0  
**最后更新**: 2024-01-15  
**维护人员**: 开发团队
