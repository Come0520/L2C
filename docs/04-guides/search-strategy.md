# 搜索策略配置指南 (Search Strategy Guide)

本指南详细说明了系统全局搜索模块的内在逻辑、权重分配、安全策略及未来演进路线，旨在指导开发者理解并优化搜索体验。

## 1. 搜索权重与排序策略

当前搜索采用**多实体并发 ilike 检索方案**。搜索结果按模块分组显示，内部排序遵循以下原则：

### 1.1 匹配模式
- **ILike 包含匹配**: 采用 `%query%` 模式进行不区分大小写的匹配。
- **匹配字段优先级**:
    - **客户 (Customers)**: 姓名 (Name) > 电话 (Phone)
    - **线索 (Leads)**: 客户姓名 (CustomerName) > 客户电话 (CustomerPhone)
    - **订单/报价/工单/账单**: 单号 (No) 具有唯一性索引，具有最高精确度。
    - **产品 (Products)**: 名称 (Name) > SKU

### 1.2 结果排列
多实体结果在 UI 层级按以下静态顺序排列：
1. **搜索历史 (History)**: 提升交互效率。
2. **客户 (Customers)** / **线索 (Leads)**: 核心业务实体。
3. **订单 (Orders)** / **报价 (Quotes)**: 交易流转实体。
4. **其他模块**: 产品、工单、渠道、财务。

## 2. 全文索引配置说明

### 2.1 当前方案: `ILIKE`
目前数据规模（单表 < 10万行）下，使用 PostgreSQL 的 `ILIKE` 结合 `B-Tree` 索引前缀匹配或全扫描。优点是实现简单，缺点是由于前缀包含通配符 `%`，常规索引无法完全发挥效能。

### 2.2 性能边界与迁移路线
- **GIN/GiST 索引**: 建议在单表数据超过 **50,000** 行时，针对搜索字段（如 `name`, `note`）引入 `trgm` (trigram) 索引。
- **全文检索 (FTS)**: 当需要支持分词、同义词或模糊相关度评分时，应迁移至 `tsvector`。
    - **触发阈值**: 单表 > 50万行，或需要非前缀匹配的极速搜索。
    - **升级操作**: 创建 `GENERATED ALWAYS AS (to_tsvector(...))` 存储列并建立 `GIN` 索引。

## 3. 安全与合规策略

### 3.1 SQL 注入防御
- **通配符过滤**: 在 `actions.ts` 中，Zod Schema 显式使用 `.transform(val => val.replace(/[%_]/g, ''))` 剔除 SQL 特殊通配符，防止恶意利用索引扫描漏洞。
- **参数化查询**: 使用 Drizzle ORM 的参数化驱动，彻底消除 SQL 注入隐患。

### 3.2 敏感字符转义
- 前端高亮逻辑 (`highlightText`) 包含正则转义规则 `replace(/[.*+?^${}()|[\]\\]/g, '\\$&')`，确保特殊字符作为纯文本匹配。

## 4. 缓存与降级逻辑 (High Availability)

### 4.1 Redis 搜索历史驱动
- **存储方案**: `search:history:{tenantId}:{userId}` (List 结构)。
- **操作**: `LPUSH` + `LTRIM(0, 9)` 保持最新10条记录。
- **降级机制**: 若 Redis 宕机，逻辑将捕获异常并静默降级（记录日志但不影响搜索流程），搜索历史将暂时显示为空。

### 4.2 unstable_cache
- **策略**: 结果按 `tenantId`, `query`, `scope`, `limit`, `permissions` 进行分片缓存。
- **有效期**: 60秒 (Short-term cache)。

## 5. 基于权限的搜索范围收窄

模块内置 **隐式权限过滤**:
- 系统自动检索当前用户的 `PERMISSIONS` 集合。
- 仅当用户拥有特定模块的 `VIEW` 权限时，对应的数据库查询 Promise 才会进入执行队列。
- 若 `PERMISSIONS` 包含 `*` 或 `**`，则视为拥有全量检索权。
