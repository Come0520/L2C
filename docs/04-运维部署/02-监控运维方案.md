# 罗莱L2C销售管理系统 - 监控运维方案

## 目录
- [方案概述](#方案概述)
- [前端与性能监控 (Vercel)](#前端与性能监控-vercel)
- [后端与数据库监控 (Supabase)](#后端与数据库监控-supabase)
- [错误追踪 (Sentry)](#错误追踪-sentry)
- [日志管理](#日志管理)
- [告警策略](#告警策略)

## 方案概述

本系统利用 **Vercel** 和 **Supabase** 的托管监控能力，结合 **Sentry** 进行全栈错误追踪，构建轻量级、零维护成本的监控体系，替代传统的 Prometheus + Grafana + ELK 堆栈。

### 核心监控组件
1. **Vercel Analytics & Speed Insights**: 监控前端性能、Web Vitals (LCP, FID, CLS) 和用户访问数据。
2. **Supabase Dashboard**: 监控数据库负载、存储使用量、API 请求数、Edge Functions 执行情况。
3. **Sentry**: 捕获前端 (Browser) 和后端 (Next.js Server / Edge) 的运行时异常。

## 前端与性能监控 (Vercel)

### 1. 开启 Vercel Analytics
在 Vercel Dashboard 中：
1. 进入 "Analytics" 标签页。
2. 点击 "Enable"。
3. 代码集成：
   ```tsx
   // app/layout.tsx
   import { Analytics } from '@vercel/analytics/react';

   export default function RootLayout({ children }) {
     return (
       <html lang="zh-CN">
         <body>
           {children}
           <Analytics />
         </body>
       </html>
     );
   }
   ```

### 2. 开启 Speed Insights (Web Vitals)
1. 进入 "Speed Insights" 标签页。
2. 点击 "Enable"。
3. 代码集成：
   ```tsx
   // app/layout.tsx
   import { SpeedInsights } from "@vercel/speed-insights/next"

   export default function RootLayout({ children }) {
     return (
       <html lang="zh-CN">
         <body>
           {children}
           <SpeedInsights />
         </body>
       </html>
     );
   }
   ```

### 3. 监控指标
- **Real Experience Score**: 真实用户体验评分。
- **Web Vitals**: LCP (加载速度), FID (交互延迟), CLS (视觉稳定性)。
- **Visitor Stats**: PV, UV, Top Paths, Referrers, Countries.

## 后端与数据库监控 (Supabase)

### 1. 数据库监控
Supabase Dashboard -> Database -> Reports：
- **CPU & RAM**: 数据库实例资源使用率。
- **Disk IO**: 磁盘读写吞吐量。
- **Active Connections**: 当前连接数 (监控是否接近连接池上限)。

### 2. API 与网络监控
Supabase Dashboard -> Reports -> API：
- **Requests**: API 调用总数和频率。
- **Response Errors**: 4xx/5xx 错误分布。
- **Response Speed**: API 平均响应时间。

### 3. Edge Functions 监控
Supabase Dashboard -> Edge Functions -> [Function Name] -> Metrics：
- **Invocations**: 调用次数。
- **Execution Time**: 执行耗时。
- **Failures**: 失败次数。

## 错误追踪 (Sentry)

### 1. 集成 Sentry
使用 `@sentry/nextjs` SDK 自动捕获异常。

```bash
npx @sentry/wizard@latest -i nextjs
```

### 2. 配置
wizard 会自动创建 `sentry.client.config.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`。

### 3. Source Maps
构建时自动上传 Source Maps 到 Sentry，确保错误堆栈可读。

## 日志管理

### 1. Vercel Logs
- 查看 Next.js Server Actions 和 Middleware 的运行日志。
- 支持实时流式查看 (Runtime Logs)。
- 关键日志建议使用结构化输出 (JSON)。

### 2. Supabase Logs (Log Explorer)
Supabase 提供基于 BigQuery 的日志查询界面 (Logs Explorer)。

**常用查询语句 (SQL-like)**:

```sql
-- 查询最近的数据库慢查询 (耗时 > 100ms)
select
  event_message,
  timestamp
from
  postgres_logs
where
  cast(parsed.duration_ms as float) > 100
order by
  timestamp desc
limit 10;

-- 查询 API 500 错误
select
  timestamp,
  method,
  path,
  status_code,
  remote_addr
from
  edge_logs
where
  status_code >= 500
order by
  timestamp desc;
```

## 告警策略

### 1. 资源告警 (Supabase)
在 Supabase Project Settings -> Billing & Usage 中设置 Usage Caps 或 Spend Cap，防止意外超支。
(Pro Plan 支持 Prometheus Endpoint 导出指标到外部监控系统，如需高级告警)。

### 2. 错误告警 (Sentry)
在 Sentry Dashboard 配置 Alert Rules：
- **New Issue**: 首次出现新错误时发送通知 (邮件/Slack/钉钉)。
- **High Volume**: 某错误频率激增时发送告警。
- **Regression**: 已修复问题再次出现时发送告警。

### 3. 网站宕机监控 (UptimeRobot)
配置外部探针 (如 UptimeRobot) 定时 ping 系统健康检查接口：
- URL: `https://l2c.luolai.com/api/health` (需自行实现该 Server Action 或 Route Handler)
- 频率: 每 5 分钟
- 通知: 邮件/短信

```typescript
// app/api/health/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/utils/supabase/server'

export async function GET() {
  const supabase = createClient()
  const { error } = await supabase.from('profiles').select('count').single()
  
  if (error) {
    return NextResponse.json({ status: 'error', db: 'disconnected' }, { status: 500 })
  }
  
  return NextResponse.json({ status: 'ok', timestamp: new Date().toISOString() })
}
```
