# 🚨 故障响应机制 (Incident Response)

## 1. 监控告警体系

我们使用 Sentry 结合阿里云云监控构建全栈监控体系。

### 1.1 关键告警指标 (Sentry Alerts)
以下规则应在 Sentry 项目设置中配置：

| 告警名称 | 触发条件 | 级别 | 响应时效 |
| :--- | :--- | :--- | :--- |
| **High Error Rate** | 5分钟内错误率 > 5% | P0 (Critical) | 15分钟内响应 |
| **Payment Failure** | 支付接口失败次数 > 5次/分 | P0 (Critical) | 15分钟内响应 |
| **API Latency High** | P95 响应时间 > 2000ms (持续10分钟) | P1 (High) | 1小时内响应 |
| **Frontend Crash** | 页面崩溃率 (Crash Free Rate) < 99% | P1 (High) | 1小时内响应 |
| **New Issue Spike** | 新增异常类型数量 > 10个/小时 | P2 (Medium) | 当日解决 |

### 1.2 资源告警 (Aliyun CloudMonitor)
| 指标 | 阈值 | 级别 |
| :--- | :--- | :--- |
| **CPU Usage** | > 85% (持续5分钟) | Warning |
| **Memory Usage** | > 90% | Critical |
| **Disk Usage** | > 85% | Warning |

## 2. 值班响应流程 (On-Call)

### 2.1 值班人员职责
- **早间检查 (9:30)**: 检查 Sentry 昨夜遗留 Issue，确认无 P1 以上未处理告警。
- **实时响应**: 接收飞书/钉钉/邮件告警，第一时间认领并在群内同步。
- **发布支持**: 重要功能上线时需加强监控关注。

### 2.2 故障处理 SOP

**Step 1: 响应与定级**
- 收到告警后，立即在 Sentry 查看堆栈详情。
- 确认影响范围（受影响用户数、核心功能是否可用）。
- 按照上述表格确定故障级别 (P0/P1/P2)。

**Step 2: 止损 (止血)**
- **优先恢复服务**，而非查找根因。
- 可用手段：
  - **回滚 (Rollback)**: 执行 `/opt/l2c/scripts/deploy/blue-green-deploy.sh rollback`。
  - **降级 (Degrade)**: 关闭非核心功能开关 (Feature Flags)。
  - **重启**: 重启相关服务容器。

**Step 3: 排查与修复**
- 服务恢复后，保留现场日志 (`docker logs`)。
- 本地复现问题，修复代码。
- 走紧急变更流程 (`Hotfix`) 上线。

**Step 4: 复盘 (Post-Mortem)**
- 故障解决后 24小时内输出《故障复盘报告》。
- 内容包括：故障时间线、根本原因 (Root Cause)、改进措施 (Action Items)。

## 3. 常用排查工具

- **Sentry**: 查看错误堆栈、用户行为轨迹 (Breadcrumbs)。
- **Log Stream**: `docker-compose logs -f --tail=200 web-app`。
- **Database**: 检查数据库慢查询与连接数。

## 4. 联系人
- **运维负责人**: [姓名/电话]
- **后端负责人**: [姓名/电话]
- **前端负责人**: [姓名/电话]
