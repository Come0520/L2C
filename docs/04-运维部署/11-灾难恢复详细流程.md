# 灾难恢复 (Disaster Recovery) 指南

本文档定义了 L2C 销售管理系统的灾难恢复策略、RPO/RTO 目标以及具体的恢复演练步骤。

## 1. 策略与目标

### RPO (Recovery Point Objective) - 数据恢复点目标
- **目标**: < 1 分钟 (生产环境), 24 小时 (开发/测试环境)
- **说明**: 在发生灾难时，我们最多允许丢失多少数据。
- **实现**:
  - 生产环境依赖 Supabase 的 Point-in-Time Recovery (PITR)，可恢复到任意秒级时间点。
  - 非生产环境依赖每日自动备份。

### RTO (Recovery Time Objective) - 恢复时间目标
- **目标**: < 1 小时
- **说明**: 从灾难发生到系统恢复服务所需的时间。
- **实现**: 
  - 数据库恢复通常在 20-40 分钟内完成（取决于数据量）。
  - 应用服务部署通常在 10 分钟内完成。

### 数据保留策略 (Data Retention)
- **自动备份**: 保留 7 天 (Free Plan) 或 30 天 (Pro Plan)。
- **PITR**: 保留 7 天 (Pro Plan 默认)。
- **审计日志**: 永久保留（通过单独的日志表 `audit_logs`）。

## 2. 备份机制

### 数据库 (Supabase)
- **自动备份**: Supabase 每天自动进行全量备份。
- **PITR (Point-in-Time Recovery)**: 记录所有 WAL (Write Ahead Log) 日志，允许恢复到特定时间戳。
- **手动备份**: 在重大变更前，应手动执行数据库导出。

### 代码与配置
- **代码**: 托管在 GitHub，支持版本回滚。
- **环境变量**: 
  - 生产环境配置存储在 Vercel/部署平台。
  - 本地开发配置存储在 `.env` 文件（不入库）。
  - 敏感密钥文档参考 `SECURITY.md`。

## 3. 恢复演练流程 (Drill Guide)

**警告**: 演练应在**隔离环境**（如 Staging 或全新的 Supabase Project）中进行，严禁直接覆盖生产环境。

### 场景 A: 误删数据恢复 (使用 PITR)

1. **确定恢复时间点**: 
   - 确认数据误删的确切时间（例如：2025-01-15 14:30:00 UTC）。
   - 选择误删前的时间点（例如：2025-01-15 14:29:00 UTC）。

2. **克隆环境 (推荐)**:
   - 在 Supabase Dashboard 中选择 "Restore to new project"。
   - 选择源项目和恢复时间点。
   - 等待新项目创建完成。

3. **验证数据**:
   - 连接到新项目的数据库。
   - 验证误删的数据是否存在。
   - 验证关键业务流程（登录、下单）是否正常。

4. **切换流量 (如果需要全量回滚)**:
   - 更新应用的环境变量 `NEXT_PUBLIC_SUPABASE_URL` 和 `NEXT_PUBLIC_SUPABASE_ANON_KEY` 指向新项目。
   - 重新部署应用。

### 场景 B: 灾难性故障恢复 (从每日备份)

1. **下载备份**:
   - 从 Supabase Dashboard -> Database -> Backups 下载最新的 `.sql` 备份文件。

2. **恢复到新实例**:
   - 使用 Supabase CLI 或 `psql` 工具将备份导入新实例。
   ```bash
   psql -h <host> -p 5432 -U postgres -f backup.sql postgres
   ```

3. **验证与切换**:
   - 同场景 A。

### 场景 C: 本地演练 (Local Drill)

开发者应定期在本地进行恢复演练，确保备份文件的有效性。

1. **导出生产数据 (Schema + Data)**:
   ```bash
   # 仅供有权限的管理员执行
   supabase db dump --db-url "$PRODUCTION_DB_URL" -f production_backup.sql
   ```

2. **重置本地数据库**:
   ```bash
   supabase db reset
   ```

3. **导入数据**:
   ```bash
   psql -h localhost -p 54322 -U postgres -f production_backup.sql postgres
   ```
   *(注意: 本地端口可能不同，默认为 54322)*

## 4. 灾难恢复联系人

| 角色 | 姓名 | 联系方式 | 职责 |
|-----|-----|---------|-----|
| 技术负责人 | 待定 | 待定 | 决策是否启动 DR 流程 |
| 数据库管理员 | 待定 | 待定 | 执行数据库恢复操作 |
| 运维工程师 | 待定 | 待定 | 协助环境切换与部署 |

## 5. 演练记录

每次演练后应记录以下信息：

- **演练日期**: YYYY-MM-DD
- **演练场景**: (如：误删数据恢复)
- **实际恢复耗时**: XX 分钟
- **发现的问题**: ...
- **改进措施**: ...

---
*最后更新时间: 2025-12-08*
