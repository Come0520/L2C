# L2C æ•°æ®å¤‡ä»½ç­–ç•¥è®¾è®¡ä¸å®æ–½æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-20  
> **çŠ¶æ€**: å¾…å®æ–½

---

## 1. æ¦‚è¿°

### 1.1 ç›®æ ‡

å»ºç«‹ç¬¦åˆ **3-2-1 å¤‡ä»½åŸåˆ™**çš„æ•°æ®ä¿æŠ¤æœºåˆ¶ï¼š
- **3** ä»½æ•°æ®å‰¯æœ¬
- **2** ç§ä¸åŒå­˜å‚¨ä»‹è´¨
- **1** ä»½å¼‚åœ°å­˜å‚¨

### 1.2 èŒƒå›´

| æ•°æ®ç±»å‹ | å¤‡ä»½æ–¹å¼ | ä¼˜å…ˆçº§ |
|---------|---------|-------|
| PostgreSQL æ•°æ®åº“ | å…¨é‡å¤‡ä»½ + å‹ç¼© | ğŸ”´ é«˜ |
| ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ (OSS) | OSS ç‰ˆæœ¬æ§åˆ¶ + è·¨åŒºåŸŸå¤åˆ¶ | ğŸŸ  ä¸­ |
| åº”ç”¨é…ç½® | Git ç‰ˆæœ¬æ§åˆ¶ | ğŸŸ¢ ä½ |

---

## 2. æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         L2C å¤‡ä»½æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  PostgreSQL â”‚â”€â”€â”€â”€â–¶â”‚  æœ¬åœ°å¤‡ä»½   â”‚â”€â”€â”€â”€â–¶â”‚  OSS å¤‡ä»½   â”‚      â”‚
â”‚   â”‚   (ä¸»åº“)    â”‚     â”‚  backups/   â”‚     â”‚ æ­å· Region â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                              â”‚                    â”‚             â”‚
â”‚                              â–¼                    â–¼             â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                       â”‚  å¼€å‘ä¸»æœº   â”‚     â”‚  OSS è·¨åŒºåŸŸ â”‚      â”‚
â”‚                       â”‚  (å¯é€‰)     â”‚     â”‚  ä¸Šæµ· Regionâ”‚      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                 â”‚
â”‚   ç¬¬ 1 å±‚: æœ¬åœ° (10ä»½)  ç¬¬ 2 å±‚: ä¸»æœº  ç¬¬ 3 å±‚: äº‘ç«¯ (30ä»½)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å¤‡ä»½ç­–ç•¥

### 3.1 å¤‡ä»½é¢‘ç‡

| ç¯å¢ƒ | ç±»å‹ | é¢‘ç‡ | ä¿ç•™æœŸ |
|-----|------|------|-------|
| ç”Ÿäº§ | å…¨é‡å¤‡ä»½ | æ¯æ—¥ 02:00 | 30 å¤© |
| ç”Ÿäº§ | å‘¨å½’æ¡£ | æ¯å‘¨æ—¥ 03:00 | 12 å‘¨ |
| å¼€å‘ | æ‰‹åŠ¨å¤‡ä»½ | æŒ‰éœ€ | 10 ä»½ |

### 3.2 RPO / RTO ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|-----|-------|------|
| **RPO** (æ¢å¤ç‚¹ç›®æ ‡) | â‰¤ 24 å°æ—¶ | æœ€å¤šä¸¢å¤± 1 å¤©æ•°æ® |
| **RTO** (æ¢å¤æ—¶é—´ç›®æ ‡) | â‰¤ 2 å°æ—¶ | ä»ç¾éš¾åˆ°æ¢å¤çš„æ—¶é—´ |

### 3.3 å­˜å‚¨å±‚çº§

```
æœ¬åœ°å¤‡ä»½ (ç¬¬ 1 å±‚)
â”œâ”€â”€ æ ¼å¼: .sql.gz (gzip å‹ç¼©)
â”œâ”€â”€ ä½ç½®: /app/backups/
â”œâ”€â”€ ä¿ç•™: æœ€è¿‘ 10 ä»½
â””â”€â”€ ç”¨é€”: å¿«é€Ÿå›æ»šã€å¼€å‘æµ‹è¯•

OSS ä¸»å¤‡ä»½ (ç¬¬ 2 å±‚)
â”œâ”€â”€ Bucket: l2c-backups (æ­å·)
â”œâ”€â”€ è·¯å¾„: db-backups/backup_YYYY-MM-DD.sql.gz
â”œâ”€â”€ ä¿ç•™: æœ€è¿‘ 30 ä»½
â”œâ”€â”€ ç‰ˆæœ¬æ§åˆ¶: å¯ç”¨
â””â”€â”€ ç”¨é€”: æ—¥å¸¸æ¢å¤ã€å‹’ç´¢é˜²æŠ¤

OSS è·¨åŒºåŸŸå¤åˆ¶ (ç¬¬ 3 å±‚) [å¯é€‰]
â”œâ”€â”€ Bucket: l2c-backups-dr (ä¸Šæµ·)
â”œâ”€â”€ åŒæ­¥æ–¹å¼: è‡ªåŠ¨è·¨åŒºåŸŸå¤åˆ¶
â””â”€â”€ ç”¨é€”: åŒºåŸŸçº§ç¾éš¾æ¢å¤
```

---

## 4. å®æ–½æ–¹æ¡ˆ

### 4.1 å·²å®Œæˆ

- [x] å¤‡ä»½è„šæœ¬ `scripts/db-backup.ts`
- [x] Gzip å‹ç¼©åŠŸèƒ½
- [x] OSS ä¸Šä¼ åŠŸèƒ½ (å¾…é…ç½®å¯†é’¥)
- [x] è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½
- [x] `.gitignore` æ’é™¤æœ¬åœ°æ•°æ®åº“ç›®å½•

### 4.2 å¾…å®æ–½

#### é˜¶æ®µ 1: OSS é…ç½® (ç«‹å³)

1. **åˆ›å»ºå¤‡ä»½ Bucket**
   ```bash
   # é˜¿é‡Œäº‘æ§åˆ¶å° æˆ– aliyun-cli
   aliyun oss mb oss://l2c-backups --region cn-hangzhou
   ```

2. **å¯ç”¨ç‰ˆæœ¬æ§åˆ¶**
   ```bash
   aliyun oss bucket-versioning --method put oss://l2c-backups --status Enabled
   ```

3. **é…ç½®ç¯å¢ƒå˜é‡**
   ```env
   # .env.local
   OSS_ACCESS_KEY_ID=ä½ çš„AccessKeyId
   OSS_ACCESS_KEY_SECRET=ä½ çš„AccessKeySecret
   OSS_BACKUP_BUCKET=l2c-backups
   ```

4. **éªŒè¯å¤‡ä»½**
   ```bash
   pnpm db:backup
   ```

#### é˜¶æ®µ 2: è‡ªåŠ¨åŒ–è°ƒåº¦ (æœ¬å‘¨)

**ç”Ÿäº§ç¯å¢ƒ Cron é…ç½®**:
```bash
# /etc/cron.d/l2c-backup
# æ¯æ—¥ 02:00 æ‰§è¡Œå¤‡ä»½
0 2 * * * root cd /app && pnpm db:backup >> /var/log/l2c-backup.log 2>&1
```

**æˆ– Docker Compose å¤‡ä»½å®¹å™¨**:
```yaml
# docker-compose.prod.yml
services:
  backup:
    image: node:22-alpine
    volumes:
      - .:/app
      - l2c_backups:/app/backups
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
      - OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
    command: |
      sh -c "
        apk add --no-cache docker-cli
        while true; do
          cd /app && npx tsx scripts/db-backup.ts
          sleep 86400  # 24 å°æ—¶
        done
      "
```

#### é˜¶æ®µ 3: ç”Ÿå‘½å‘¨æœŸç®¡ç† (ä¸‹å‘¨)

**OSS ç”Ÿå‘½å‘¨æœŸè§„åˆ™**:
```json
{
  "Rules": [
    {
      "ID": "è½¬ä½é¢‘å­˜å‚¨",
      "Prefix": "db-backups/",
      "Status": "Enabled",
      "Transitions": [
        { "Days": 30, "StorageClass": "IA" },
        { "Days": 90, "StorageClass": "Archive" }
      ]
    }
  ]
}
```

#### é˜¶æ®µ 4: è·¨åŒºåŸŸå¤åˆ¶ (å¯é€‰)

```bash
# åˆ›å»ºç¾å¤‡ Bucket
aliyun oss mb oss://l2c-backups-dr --region cn-shanghai

# é…ç½®è·¨åŒºåŸŸå¤åˆ¶
aliyun oss replication --method put \
  --source oss://l2c-backups \
  --target oss://l2c-backups-dr \
  --target-region cn-shanghai
```

---

## 5. æ¢å¤æµç¨‹

### 5.1 ä»æœ¬åœ°å¤‡ä»½æ¢å¤

```bash
# 1. æŸ¥çœ‹å¯ç”¨å¤‡ä»½
ls -la backups/

# 2. è§£å‹å¤‡ä»½ (å¦‚æœæ˜¯ .gz)
gunzip -k backups/backup_2026-01-20T02-00-00.sql.gz

# 3. æ¢å¤æ•°æ®åº“
pnpm db:restore backup_2026-01-20T02-00-00.sql
```

### 5.2 ä» OSS æ¢å¤

```bash
# 1. ä¸‹è½½å¤‡ä»½
aliyun oss cp oss://l2c-backups/db-backups/backup_2026-01-20.sql.gz ./

# 2. è§£å‹
gunzip backup_2026-01-20.sql.gz

# 3. æ¢å¤
pnpm db:restore backup_2026-01-20.sql
```

### 5.3 ç¾éš¾æ¢å¤æ¼”ç»ƒ

| é¢‘ç‡ | å†…å®¹ | è´Ÿè´£äºº |
|-----|------|-------|
| æ¯æœˆ | æœ¬åœ°å¤‡ä»½æ¢å¤æµ‹è¯• | è¿ç»´ |
| æ¯å­£ | OSS å¤‡ä»½å®Œæ•´æ¢å¤æ¼”ç»ƒ | è¿ç»´ + å¼€å‘ |
| æ¯å¹´ | è·¨åŒºåŸŸç¾éš¾æ¢å¤æ¼”ç»ƒ | å…¨å›¢é˜Ÿ |

---

## 6. ç›‘æ§ä¸å‘Šè­¦

### 6.1 å¤‡ä»½æˆåŠŸç›‘æ§

```typescript
// scripts/db-backup.ts æœ«å°¾æ·»åŠ 
async function notifyBackupStatus(success: boolean, details: string) {
    // å‘é€åˆ°é’‰é’‰/ä¼å¾®/Slack
    await fetch(process.env.WEBHOOK_URL, {
        method: 'POST',
        body: JSON.stringify({
            msgtype: 'text',
            text: { content: `[L2C å¤‡ä»½] ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}: ${details}` }
        })
    });
}
```

### 6.2 å‘Šè­¦è§„åˆ™

| äº‹ä»¶ | å‘Šè­¦çº§åˆ« | é€šçŸ¥æ–¹å¼ |
|-----|---------|---------|
| å¤‡ä»½å¤±è´¥ | ğŸ”´ ç´§æ€¥ | é’‰é’‰ + çŸ­ä¿¡ |
| OSS ä¸Šä¼ å¤±è´¥ | ğŸŸ  è­¦å‘Š | é’‰é’‰ |
| å¤‡ä»½æ—¶é—´è¶…è¿‡ 30 åˆ†é’Ÿ | ğŸŸ¡ æç¤º | æ—¥å¿—è®°å½• |

---

## 7. æˆæœ¬ä¼°ç®—

### 7.1 OSS å­˜å‚¨æˆæœ¬ (æ­å·)

| é¡¹ç›® | è§„æ ¼ | æœˆè´¹ç”¨ |
|-----|------|-------|
| æ ‡å‡†å­˜å‚¨ | 10 GB (30å¤©å¤‡ä»½) | Â¥1.2 |
| ä½é¢‘å­˜å‚¨ | 20 GB (60-90å¤©) | Â¥0.8 |
| API è¯·æ±‚ | ~1000æ¬¡/æœˆ | Â¥0.01 |
| å¤–ç½‘æµå‡º | æŒ‰éœ€ | æŒ‰é‡ |
| **åˆè®¡** | | **~Â¥2-5/æœˆ** |

### 7.2 è·¨åŒºåŸŸå¤åˆ¶ (å¯é€‰)

| é¡¹ç›® | æœˆè´¹ç”¨ |
|-----|-------|
| å¤åˆ¶æµé‡ | Â¥0.5/GB |
| ç¾å¤‡å­˜å‚¨ | Â¥1-2 |
| **åˆè®¡** | **~Â¥5-10/æœˆ** |

---

## 8. å®‰å…¨è€ƒè™‘

### 8.1 è®¿é—®æ§åˆ¶

```json
// OSS Bucket Policy - ä»…å…è®¸å¤‡ä»½è„šæœ¬è®¿é—®
{
  "Version": "1",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["oss:PutObject", "oss:GetObject", "oss:DeleteObject"],
      "Resource": ["acs:oss:*:*:l2c-backups/db-backups/*"],
      "Condition": {
        "IpAddress": { "acs:SourceIp": ["æœåŠ¡å™¨IP"] }
      }
    }
  ]
}
```

### 8.2 åŠ å¯† (å¯é€‰å¢å¼º)

```bash
# å¤‡ä»½æ—¶åŠ å¯†
pg_dump ... | gpg --encrypt --recipient backup@l2c.com | gzip > backup.sql.gpg.gz

# æ¢å¤æ—¶è§£å¯†
gunzip -c backup.sql.gpg.gz | gpg --decrypt | psql ...
```

### 8.3 Object Lock (é˜²å‹’ç´¢)

```bash
# å¯ç”¨ WORM ä¿æŠ¤ (éœ€è¦å¼€é€šç™½åå•)
aliyun oss bucket-worm --method put oss://l2c-backups --retention-days 30
```

---

## 9. é™„å½•

### 9.1 ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|-----|------|
| [scripts/db-backup.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/scripts/db-backup.ts) | å¤‡ä»½è„šæœ¬ |
| [scripts/db-restore.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/scripts/db-restore.ts) | æ¢å¤è„šæœ¬ |
| [docker-compose.prod.yml](file:///c:/Users/bigey/Documents/Antigravity/L2C/docker-compose.prod.yml) | ç”Ÿäº§é…ç½® |

### 9.2 å‘½ä»¤é€ŸæŸ¥

```bash
# æ‰‹åŠ¨å¤‡ä»½
pnpm db:backup

# æŸ¥çœ‹æœ¬åœ°å¤‡ä»½
ls -lh backups/

# æ¢å¤å¤‡ä»½
pnpm db:restore backup_YYYY-MM-DD.sql

# æŸ¥çœ‹ OSS å¤‡ä»½
aliyun oss ls oss://l2c-backups/db-backups/
```

### 9.3 æ•…éšœæ’æŸ¥

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|
| Docker å®¹å™¨è¿æ¥å¤±è´¥ | æ£€æŸ¥å®¹å™¨åç§°ï¼Œç¡®è®¤ PostgreSQL è¿è¡Œä¸­ |
| OSS ä¸Šä¼  403 | æ£€æŸ¥ AccessKey æƒé™ï¼Œç¡®è®¤ Bucket å­˜åœ¨ |
| å‹ç¼©å¤±è´¥ | æ£€æŸ¥ç£ç›˜ç©ºé—´ |
| æ¢å¤åæ•°æ®ä¸å®Œæ•´ | æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å®Œæ•´ (gunzip -t) |
