# L2C E2E 测试设计文档

> 设计时间：2026-01-15
> 用途：供测试同事执行测试动作

---

## 📊 测试覆盖现状

### 已有测试 (26 个)

| 模块 | 测试文件 | 覆盖场景 |
|------|----------|----------|
| 线索 | 12 个 | 创建、生命周期、跟进、筛选、批量操作、并发、数据完整性等 |
| 报价 | 2 个 | 快速报价流程、报价生命周期 |
| 订单 | 1 个 | 订单生命周期 |
| 财务 | 3 个 | AR 收款、AR 高级、AP 付款 |
| 服务 | 2 个 | 测量单、安装单 |
| 售后 | 1 个 | 售后工单 |
| 供应链 | 1 个 | 采购单 |
| 权限 | 1 个 | 权限控制 |
| 搜索 | 1 个 | 全局搜索筛选 |
| 客户 | 1 个 | 客户生命周期 |
| 闭环 | 1 个 | 完整销售流程 |

### 缺失测试 (待补充)

| 模块 | 优先级 | 状态 |
|------|--------|------|
| Products 产品管理 | P2 | ❌ 无测试 |
| Analytics 数据分析 | P1 | ❌ 无测试 |
| Channels 渠道管理 | P1 | ❌ 无测试 |
| Notifications 通知中心 | P0 | ❌ 无测试 |
| Approval 审批流程 | P0 | ❌ 无测试 |

---

## 🔴 P0 紧急 - 必须补充

### 1. 审批流程测试 (`approval.spec.ts`)

#### 测试用例 1.1：发起报价折扣审批

| 项目 | 内容 |
|------|------|
| **前置条件** | 已登录销售角色，存在一个草稿报价单 |
| **测试步骤** | 1. 进入报价单详情页<br>2. 设置折扣 > 20%<br>3. 点击"提交审批"按钮<br>4. 填写审批说明<br>5. 确认提交 |
| **预期结果** | - 报价单状态变为"审批中"<br>- 审批人收到待办通知<br>- 提交者看到审批流程进度 |
| **验证点** | - `data-testid="submit-approval-btn"` 可点击<br>- 审批状态显示正确<br>- 审批历史可查看 |

#### 测试用例 1.2：审批人审核通过

| 项目 | 内容 |
|------|------|
| **前置条件** | 已登录店长角色，存在待审批的报价单 |
| **测试步骤** | 1. 进入工作台/待办列表<br>2. 点击待审批项<br>3. 查看审批详情<br>4. 点击"通过"按钮<br>5. 填写审批意见<br>6. 确认 |
| **预期结果** | - 报价单状态变为"已审批"<br>- 发起人收到通过通知<br>- 审批历史更新 |
| **验证点** | - 待办数量减少<br>- 审批时间记录正确 |

#### 测试用例 1.3：审批人驳回

| 项目 | 内容 |
|------|------|
| **前置条件** | 同 1.2 |
| **测试步骤** | 1. 进入待审批项<br>2. 点击"驳回"按钮<br>3. 填写驳回原因（必填）<br>4. 确认 |
| **预期结果** | - 报价单状态变为"已驳回"<br>- 折扣恢复为可编辑<br>- 发起人收到驳回通知 |
| **验证点** | - 驳回原因必填校验<br>- 状态回退正确 |

#### 测试用例 1.4：多级审批流程

| 项目 | 内容 |
|------|------|
| **前置条件** | 折扣 > 30% 需要店长 + 总监两级审批 |
| **测试步骤** | 1. 提交高折扣报价<br>2. 店长审批通过<br>3. 总监审批通过 |
| **预期结果** | - 两级都通过后状态才变为"已审批"<br>- 审批流程显示两个节点 |

---

### 2. 通知中心测试 (`notifications.spec.ts`)

#### 测试用例 2.1：站内通知接收

| 项目 | 内容 |
|------|------|
| **前置条件** | 用户 A 已登录 |
| **测试步骤** | 1. 用户 B 创建一条与用户 A 相关的线索<br>2. 用户 A 刷新页面<br>3. 查看通知铃铛 |
| **预期结果** | - 铃铛显示未读数量<br>- 点击可展开通知列表<br>- 通知内容正确 |
| **验证点** | - `data-testid="notification-bell"` 显示红点<br>- 未读计数正确 |

#### 测试用例 2.2：标记已读

| 项目 | 内容 |
|------|------|
| **前置条件** | 存在未读通知 |
| **测试步骤** | 1. 点击通知铃铛<br>2. 点击某条通知<br>3. 或点击"全部标记已读" |
| **预期结果** | - 单条/全部通知变为已读<br>- 未读数量更新 |

#### 测试用例 2.3：通知偏好设置

| 项目 | 内容 |
|------|------|
| **前置条件** | 进入设置页面 |
| **测试步骤** | 1. 导航到通知偏好设置<br>2. 修改某类通知的接收方式<br>3. 保存 |
| **预期结果** | - 设置保存成功<br>- 后续通知按新设置分发 |
| **验证点** | - 开关状态正确保存 |

#### 测试用例 2.4：SLA 预警通知

| 项目 | 内容 |
|------|------|
| **前置条件** | 存在即将超时的任务 |
| **测试步骤** | 1. 手动触发 SLA 检查<br>2. 或等待系统自动检查 |
| **预期结果** | - 相关人员收到预警通知<br>- 通知包含超时详情 |

---

## 🟠 P1 高优先级

### 3. 渠道管理测试 (`channels.spec.ts`)

#### 测试用例 3.1：创建渠道

| 项目 | 内容 |
|------|------|
| **前置条件** | 已登录管理员 |
| **测试步骤** | 1. 进入渠道管理页面<br>2. 点击"新建渠道"<br>3. 填写渠道名称、类型、父级渠道<br>4. 保存 |
| **预期结果** | - 渠道创建成功<br>- 列表显示新渠道<br>- 层级关系正确 |
| **验证点** | - 三级结构显示正确 |

#### 测试用例 3.2：渠道关联线索

| 项目 | 内容 |
|------|------|
| **前置条件** | 渠道已创建 |
| **测试步骤** | 1. 创建新线索<br>2. 选择来源渠道<br>3. 保存 |
| **预期结果** | - 线索关联渠道正确<br>- 渠道统计数量 +1 |

#### 测试用例 3.3：渠道效果分析

| 项目 | 内容 |
|------|------|
| **前置条件** | 渠道下有多条线索，部分已转化 |
| **测试步骤** | 1. 进入渠道分析页面<br>2. 查看转化率、客单价 |
| **预期结果** | - 数据计算正确<br>- 图表展示正常 |

---

### 4. 数据分析测试 (`analytics.spec.ts`)

#### 测试用例 4.1：Dashboard 加载

| 项目 | 内容 |
|------|------|
| **前置条件** | 已登录，系统有数据 |
| **测试步骤** | 1. 进入数据分析/仪表盘页面<br>2. 等待数据加载 |
| **预期结果** | - 统计卡片显示正确数值<br>- 图表渲染正常<br>- 无报错 |
| **验证点** | - `data-testid="stat-card-*"` 显示数据<br>- 图表容器有内容 |

#### 测试用例 4.2：销售漏斗

| 项目 | 内容 |
|------|------|
| **前置条件** | 各阶段有数据 |
| **测试步骤** | 1. 查看销售漏斗图<br>2. 悬停查看详情 |
| **预期结果** | - 各阶段数量正确<br>- 转化率计算正确 |

#### 测试用例 4.3：日期筛选

| 项目 | 内容 |
|------|------|
| **前置条件** | Dashboard 已加载 |
| **测试步骤** | 1. 修改日期范围<br>2. 观察数据变化 |
| **预期结果** | - 数据按日期过滤<br>- 图表更新 |

#### 测试用例 4.4：数据导出

| 项目 | 内容 |
|------|------|
| **前置条件** | Dashboard 显示数据 |
| **测试步骤** | 1. 点击导出按钮<br>2. 选择 CSV 或 Excel 格式<br>3. 下载文件 |
| **预期结果** | - 文件下载成功<br>- 内容与页面数据一致 |

---

## 🟡 P2 中优先级

### 5. 产品管理测试 (`products.spec.ts`)

#### 测试用例 5.1：创建产品

| 项目 | 内容 |
|------|------|
| **前置条件** | 已登录管理员 |
| **测试步骤** | 1. 进入产品管理<br>2. 点击"新建产品"<br>3. 填写名称、品类、单价、单位<br>4. 选择供应商<br>5. 保存 |
| **预期结果** | - 产品创建成功<br>- 列表可见新产品 |
| **验证点** | - 必填项校验生效 |

#### 测试用例 5.2：编辑产品

| 项目 | 内容 |
|------|------|
| **前置条件** | 产品已存在 |
| **测试步骤** | 1. 点击产品行<br>2. 修改价格<br>3. 保存 |
| **预期结果** | - 修改成功<br>- 列表价格更新 |

#### 测试用例 5.3：产品导入

| 项目 | 内容 |
|------|------|
| **前置条件** | 准备 Excel 模板文件 |
| **测试步骤** | 1. 点击"批量导入"<br>2. 上传 Excel 文件<br>3. 预览数据<br>4. 确认导入 |
| **预期结果** | - 数据预览正确<br>- 导入成功<br>- 错误行有提示 |
| **验证点** | - 重复产品提示<br>- 格式错误提示 |

#### 测试用例 5.4：产品搜索筛选

| 项目 | 内容 |
|------|------|
| **前置条件** | 产品列表有数据 |
| **测试步骤** | 1. 输入搜索关键词<br>2. 选择品类筛选 |
| **预期结果** | - 列表正确过滤 |

#### 测试用例 5.5：动态属性模板

| 项目 | 内容 |
|------|------|
| **前置条件** | 已配置属性模板 |
| **测试步骤** | 1. 创建窗帘产品<br>2. 查看动态属性字段<br>3. 填写并保存 |
| **预期结果** | - 动态字段按模板显示<br>- 值正确保存 |

---

## 🟢 P3 增强测试

### 6. 现有测试增强建议

#### 6.1 订单模块 (`order-lifecycle.spec.ts`) 扩展

| 测试用例 | 描述 |
|----------|------|
| 订单拆单 | 将一个订单拆分为多个子订单 |
| 发货申请 | 销售申请发货，填写物流信息 |
| 订单变更 | 提交变更申请，走审批流程 |

#### 6.2 财务模块增强

| 测试用例 | 描述 |
|----------|------|
| 多节点收款计划 | 设置分期收款，验证到期提醒 |
| 坏账核销 | 提交核销申请，审批通过后核销 |

#### 6.3 供应链模块增强

| 测试用例 | 描述 |
|----------|------|
| 跨订单合并采购 | 从待采购池合并多个订单商品 |
| 加工单流程 | 创建加工单，跟踪完成 |

---

## 📋 测试执行检查清单

### 执行前准备

- [ ] 确认测试环境 (`TEST001` 租户)
- [ ] 确认测试数据已播种 (`pnpm db:seed:test`)
- [ ] 确认测试账号可用 (sales@test.com, manager@test.com)
- [ ] 确认开发服务器运行 (`pnpm dev`)

### 执行命令

```bash
# 运行全部 E2E 测试
pnpm test:e2e

# 运行单个测试文件
pnpm test:e2e e2e/flows/approval.spec.ts

# 带 UI 界面运行
pnpm test:e2e:ui

# 仅 Chromium
pnpm test:e2e:chromium
```

### 执行后检查

- [ ] 查看 `playwright-report/` 报告
- [ ] 记录失败用例
- [ ] 截图/录屏存档

---

## 🔧 测试数据 (Test IDs)

### 常用 data-testid 列表

| 组件 | testid | 用途 |
|------|--------|------|
| 创建线索按钮 | `create-lead-btn` | 新建线索 |
| 提交表单按钮 | `submit-lead-btn` | 提交线索表单 |
| 通知铃铛 | `notification-bell` | 通知入口 |
| 审批提交按钮 | `submit-approval-btn` | 发起审批 |
| 审批通过按钮 | `approve-btn` | 审批通过 |
| 审批驳回按钮 | `reject-btn` | 审批驳回 |
| 统计卡片 | `stat-card-*` | 数据统计 |
| 渠道选择器 | `channel-picker` | 选择渠道 |
| 产品表格 | `product-table` | 产品列表 |
| 导出按钮 | `export-btn` | 数据导出 |

---

## 📅 测试排期建议

| 阶段 | 时间 | 内容 |
|------|------|------|
| 第 1 天 | 上午 | 审批流程测试用例 1.1 - 1.4 |
| 第 1 天 | 下午 | 通知中心测试用例 2.1 - 2.4 |
| 第 2 天 | 上午 | 渠道管理测试用例 3.1 - 3.3 |
| 第 2 天 | 下午 | 数据分析测试用例 4.1 - 4.4 |
| 第 3 天 | 全天 | 产品管理测试用例 5.1 - 5.5 |
| 第 4 天 | 全天 | 现有测试增强 + 回归测试 |

---

*文档维护：发现问题请及时反馈*
*设计人：Antigravity AI*
*执行人：______________*
