# 设置模块需求设计

> 日期: 2026-01-20
> 模块: 收款配置、付款策略配置、工作流配置

---

## 一、收款配置 (`/settings/finance/ar`)

### 1.1 分期付款规则

| 配置项 | 类型 | 说明 |
|:---|:---|:---|
| 是否允许分期 | 开关 | 控制是否可分期收款 |
| 定金最低比例 | 百分比 | 如 30% |
| 定金最低金额 | 金额 | 如 500 元 |
| 定金计算规则 | 选择 | 百分比与金额取**孰高** |

### 1.2 安装前收款检查

| 配置项 | 类型 | 说明 |
|:---|:---|:---|
| 现结客户是否允许欠款安装 | 开关 | 禁用则必须全款结清 |
| 欠款安装是否需审批 | 开关 | 启用则走审批流程 |

### 1.3 渠道结算方式

在渠道管理中增加字段：

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| 结算方式 | 枚举 | `月结` / `现结` |
| 授信额度 | 金额 | 仅月结渠道需设置 |

### 1.4 安装单生成检查逻辑

```
生成安装单时：
├── 获取订单来源渠道
├── 判断渠道结算方式
│   ├── 【月结渠道】
│   │   └── 检查: 渠道已欠款 + 本单金额 ≤ 授信额度
│   │       ├── 通过 → 允许生成
│   │       └── 不通过 → 拦截或走超额审批
│   └── 【现结渠道】
│       └── 检查: 本单是否全款结清
│           ├── 已结清 → 允许生成
│           └── 未结清 → 根据配置拦截或审批
```

---

## 二、付款策略配置 (`/settings/finance/ap`)

### 2.1 采购付款

| 结算方式 | 说明 |
|:---|:---|
| **现付** | 货到即付（默认） |
| **月结** | 按月汇总付款 |
| **预存** | 先充值后扣款 |

**预存模式**：
- 充值时可赠送：商品 或 货款比例
- 示例：存 1 万，账户显示 1.1 万（赠 10%）

### 2.2 劳务结算

| 结算方式 | 说明 |
|:---|:---|
| **按单即时结** | 完成任务后立即结算 |
| **月结** | 按月汇总工单结算 |

### 2.3 物流费用

| 结算方式 | 说明 |
|:---|:---|
| **按单即时结** | 每次配送后即时结算 |
| **月结** | 按月汇总配送费结算 |

### 2.4 配置位置

- 在**供应商/劳务人员资料**中单独设置
- 新增时默认**现付**

---

## 三、工作流配置 (`/settings/workflow`)

### 3.1 核心理念

根据租户规模（小店 vs 大店），配置不同的业务流程模式。

### 3.2 业务模式开关

| 模块 | 配置项 | 小店模式 | 大店模式 |
|:---|:---|:---|:---|
| **线索管理** | 启用线索分配 | ❌ 禁用 | ✅ 启用 |
| **测量派单** | 派单模式 | 自己做 | 派单员/销售派单 |
| **安装派单** | 派单模式 | 自己做 | 派单员/销售派单 |
| **劳务费用** | 启用工费计算 | ❌ 禁用 | ✅ 启用 |
| **外发加工** | 启用加工费 | ❌ 禁用 | ✅ 启用 |
| **采购审批** | 启用审批流程 | ❌ 禁用 | ✅ 启用 |

### 3.3 配置项详情

| 配置项 | 类型 | 说明 |
|:---|:---|:---|
| 启用线索分配 | 开关 | 禁用则所有线索归当前用户 |
| 测量派单模式 | 选择 | `自己做` / `派单员派单` / `销售直接派单` |
| 安装派单模式 | 选择 | `自己做` / `派单员派单` / `销售直接派单` |
| 启用劳务费用计算 | 开关 | 禁用则不计算测量/安装工费 |
| 启用外发加工 | 开关 | 禁用则不计加工费 |
| 启用采购审批 | 开关 | 禁用则直接付款无审批 |

---

## 数据模型变更

### 渠道表 (market_channels)

新增字段：
- `settlement_type`: `MONTHLY` | `CASH`
- `credit_limit`: 授信额度（Decimal）

### 供应商/劳务人员

新增字段：
- `settlement_type`: 结算方式
- `prepaid_balance`: 预存余额

### 租户配置 (tenant_config)

新增 JSON 字段或独立配置表，存储以上业务模式开关。
