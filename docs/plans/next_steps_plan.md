# 批量操作功能后续工作计划

> **制定时间**: 2025-12-13 10:50  
> **当前状态**: Day 1+2 已完成并部署  
> **下一阶段**: 测试验证 + UI集成

---

## ✅ 已完成工作回顾

### Day 1 (2025-12-12, 3小时)
- ✅ 订单状态流转边界情况处理
- ✅ 状态审计日志增强

### Day 2 (2025-12-13, 1.5小时)
- ✅ 批量分配销售人员功能
- ✅ 批量导出订单功能
- ✅ 批量操作进度UI组件

### 部署 (2025-12-13, 0.5小时)
- ✅ 数据库迁移（3个文件）
- ✅ Edge Function部署
- ✅ Storage配置

**总计**: 5小时，~1600行代码，100%部署完成

---

## 🎯 短期计划（本周，2025-12-13 - 12-15）

### Day 3: 功能验证与测试 (预计4小时)

#### 上午（2小时）：数据库功能验证
- [ ] **测试1**: 乐观锁机制
  ```sql
  -- 测试并发冲突检测
  SELECT update_order_status_v2(...);
  ```
  - 验证version冲突报错
  - 验证正常更新成功
  
- [ ] **测试2**: 批量分配功能
  ```sql
  -- 测试权限验证
  -- 测试批量容错
  SELECT batch_assign_sales_person(...);
  ```
  - 验证权限控制正确
  - 验证失败详情返回

- [ ] **测试3**: 审计日志查询
  ```sql
  -- 测试历史查询
  -- 测试统计功能
  SELECT * FROM get_order_status_history_enhanced(...);
  ```
  - 验证数据完整性
  - 验证分页正确

**交付物**: `docs/reports/testing_results.md`

#### 下午（2小时）：Edge Function和前端验证
- [ ] **测试4**: CSV导出功能
  ```bash
  curl -X POST .../export-orders ...
  ```
  - 验证CSV生成正确
  - 验证中文显示正常
  - 验证文件上传成功
  - 验证下载URL有效

- [ ] **测试5**: 前端API调用
  ```typescript
  // 浏览器Console测试
  await salesOrderService.batchAssignSalesPerson(...)
  await salesOrderService.exportOrders(...)
  ```
  - 验证API响应正确
  - 验证错误处理完善

- [ ] **测试6**: UI组件单独测试
  - 创建测试页面 `/test-bulk-ui`
  - 验证进度动画
  - 验证失败列表
  - 验证重试功能

**交付物**: 
- 测试报告更新
- 问题清单（如果有）

---

### Day 4: UI集成到订单列表 (预计3小时)

#### 上午（1.5小时）：订单列表页集成
- [ ] **任务1**: 添加批量操作按钮
  ```typescript
  // 在订单列表页添加：
  - 全选checkbox
  - 批量分配按钮
  - 批量导出按钮
  - 批量修改状态按钮（可选）
  ```
  **文件**: `src/app/orders/page.tsx`

- [ ] **任务2**: 集成BulkOperationProgress
  ```typescript
  import { BulkOperationProgress } from '@/components/ui/bulk-operation-progress'
  // 连接到实际API
  ```

#### 下午（1.5小时）：完善交互和测试
- [ ] **任务3**: 批量分配流程
  - 选择订单 → 点击批量分配
  - 选择销售人员（模态框）
  - 显示进度UI → 完成/失败提示

- [ ] **任务4**: 批量导出流程
  - 选择订单 → 点击批量导出  
  - 选择格式和字段（模态框）
  - 显示进度 → 下载链接

- [ ] **任务5**: 端到端测试
  - 完整流程测试
  - 边界情况测试
  - 性能测试（100+订单）

**交付物**:
- 更新的订单列表页
- E2E测试报告

---

### Day 5: 补充文档和单元测试 (预计2小时)

#### 上午（1小时）：单元测试
- [ ] **任务1**: 批量分配测试
  ```typescript
  // src/services/__tests__/salesOrders.batch.test.ts
  describe('批量分配', () => {
    it('应该成功分配')
    it('应该处理权限错误')
    it('应该返回失败详情')
  })
  ```

- [ ] **任务2**: 导出功能测试
  ```typescript
  // src/services/__tests__/salesOrders.export.test.ts
  ```

#### 下午（1小时）：用户文档
- [ ] **任务3**: 更新用户手册
  - 添加批量操作章节
  - 添加操作截图
  - 添加常见问题
  
- [ ] **任务4**: 更新技术文档
  - API文档更新
  - 数据库函数说明
  - Edge Function说明

**交付物**:
- 单元测试文件
- 更新的用户手册

---

## 📅 中期计划（下周，2025-12-16 - 12-20）

### 订单管理剩余工作

#### Day 6-7: 批量修改订单状态UI优化 (预计2天)
- [ ] 创建 `BulkStatusChangeModal` 组件
  - 显示允许的状态选项（基于workflow规则）
  - 实时验证转换规则
  - 显示预计影响的订单数
  - 批注原因输入

- [ ] 集成到订单列表
- [ ] 测试和优化

**交付物**: 批量修改状态功能上线

#### Day 8-9: 审批超时处理 (预计2天)
- [ ] 数据库层
  ```sql
  -- 创建审批超时配置表
  -- 创建超时检测函数
  ```

- [ ] Edge Function
  ```typescript
  // supabase/functions/approval-timeout-handler
  // 定时检测超时审批
  // 自动升级或通知
  ```

- [ ] 前端UI
  - 超时配置页面
  - 超时提醒展示

**交付物**: 审批超时处理上线

---

## 🎯 长期计划（本月末，2025-12-21 - 12-31）

### 财务管理完善 (原计划Day 10-16)
参考 `modules_completion_plan.md` 第2节

**优先任务**:
1. 销售收入报表
2. 发票管理CRUD
3. 账期管理

**预计**: 5-7天

---

## 📊 本周工作量汇总

| 日期 | 任务 | 预计工时 | 状态 |
|------|------|----------|------|
| 12-13 上午 | 部署到生产 | 0.5h | ✅ 完成 |
| 12-13 下午 | 数据库功能验证 | 2h | ⏳ 计划中 |
| 12-13 晚上 | API和UI验证 | 2h | ⏳ 计划中 |
| 12-14 全天 | UI集成到订单列表 | 3h | ⏳ 计划中 |
| 12-15 全天 | 文档和单元测试 | 2h | ⏳ 计划中 |

**本周总计**: 9.5小时

---

## ✅ 本周验收标准

### 功能验收
- [ ] 所有数据库函数测试通过
- [ ] Edge Function导出正常
- [ ] 订单列表集成批量操作
- [ ] 端到端流程完整

### 质量验收
- [ ] 单元测试覆盖新功能
- [ ] 无P0/P1级别bug
- [ ] 用户文档完善

### 性能验收
- [ ] 批量分配100订单 < 5秒
- [ ] CSV导出1000订单 < 30秒
- [ ] UI响应流畅，无卡顿

---

## 🔧 资源需求

### 人力
- **开发**: 1人（自己）
- **测试**: 可选，1人协助测试
- **设计**: 如需UI调整，1人协助

### 环境
- ✅ 生产环境（已部署）
- ⏳ 测试数据（需准备100+测试订单）
- ⏳ 测试账号（不同角色）

### 工具
- ✅ Supabase Dashboard
- ✅ SQL Editor
- ✅ Chrome DevTools
- ⏳ Postman/Insomnia（可选，测试API）

---

## 🚨 风险提示

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 测试数据不足 | 无法充分测试 | 使用SQL生成测试数据 |
| Excel导出中文乱码 | 用户体验差 | 已添加BOM，需验证 |
| 批量操作性能问题 | 用户等待时间长 | 优化SQL，考虑分批处理 |
| UI组件兼容性 | 某些浏览器bug | 测试主流浏览器 |

---

## 📝 下一步行动

**立即执行**（今天下午）:
1. 按照 `testing_guide.md` 执行验证测试
2. 记录测试结果和问题
3. 修复发现的问题

**明天**（12-14）:
1. UI集成到订单列表
2. 端到端测试

**本周末前**（12-15）:
1. 完成文档更新
2. 补充单元测试
3. 准备下周工作

---

**计划制定人**: 来长城  
**审批状态**: 待审批  
**预计开始**: 2025-12-13 下午
