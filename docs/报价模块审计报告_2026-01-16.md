# 报价模块全面审计报告

> **生成时间**: 2026-01-16  
> **审计范围**: 报价模块 (Quote Module)  
> **审计员**: Antigravity AI  
> **审计目的**: 对比需求文档与实际代码、API、UI/UX、数据库实现的差异

---

## 执行摘要 (Executive Summary)

本次审计对报价模块进行了全面的差异分析，对比了以下文档与实际实现：

- **需求文档**: [报价单.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/02-requirements/modules/报价单/报价单.md)
- **架构设计**: [2026-01-14-quote-module-architecture-design.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/02-requirements/modules/报价单/2026-01-14-quote-module-architecture-design.md)
- **计算逻辑**: [数量计算逻辑.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/02-requirements/modules/报价单/数量计算逻辑.md)
- **API 规范**: [quotes.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/04-api/02-modules/quotes.md)

### 总体评估

| 维度 | 完整性评分 | 说明 |
|:---|:---:|:---|
| **数据库 Schema** | 75% | 核心表结构完整，缺少折扣审批相关字段 |
| **API 实现** | 40% | 基础 CRUD 实现，多个高级 API 仍为 Mock |
| **业务逻辑** | 60% | 计算引擎已实现，配置系统部分缺失 |
| **UI/UX 实现** | 30% | 基础表格展示，多数高级功能未实现 |
| **测量集成** | 20% | 接口定义存在，实际逻辑未实现 |
| **整体完成度** | **45%** | 核心框架完整，高级功能待开发 |

---

## 1. 数据库 Schema 审计

### 1.1 `quotes` 表 (报价单主表)

#### ✅ 已实现字段

| 字段 | 需求 | 实现 | 状态 |
|:---|:---|:---|:---|
| `id` | 主键 UUID | ✓ | ✅ |
| `tenantId` | 租户 ID | ✓ | ✅ |
| `quoteNo` | 报价单编号，唯一 | ✓ | ✅ |
| `customerId` | 客户 ID | ✓ | ✅ |
| `leadId` | 线索 ID (可选) | ✓ | ✅ |
| `measureVariantId` | 测量变体 ID | ✓ | ✅ |
| `parentQuoteId` | 上一版本 ID | ✓ | ✅ |
| `isActive` | 当前活跃版本 | ✓ | ✅ |
| `version` | 版本号 | ✓ | ✅ |
| `title` | 报价单标题 | ✓ | ✅ |
| `totalAmount` | 总金额 | ✓ | ✅ |
| `discountRate` | 折扣率 (0-1) | ✓ | ✅ |
| `discountAmount` | 折扣金额 | ✓ | ✅ |
| `finalAmount` | 最终金额 | ✓ | ✅ |
| `status` | 状态 (DRAFT/SUBMITTED等) | ✓ | ✅ |
| `validUntil` | 有效期 | ✓ | ✅ |
| `notes` | 备注 | ✓ | ✅ |
| `lockedAt` | 锁定时间 | ✓ | ✅ |
| `createdBy` | 创建人 | ✓ | ✅ |
| `createdAt` | 创建时间 | ✓ | ✅ |
| `updatedAt` | 更新时间 | ✓ | ✅ |

#### ❌ 缺失字段 (P1)

根据需求文档第 2.1 节"折扣风控体系"，缺少以下字段：

| 字段名 | 需求说明 | 优先级 |
|:---|:---|:---|
| `approvalRequired` | 是否需要审批 (Boolean) | P0 |
| `approverId` | 审批人 ID | P0 |
| `approvedAt` | 审批时间 | P1 |
| `rejectReason` | 拒绝原因 | P1 |

**影响**: 折扣风控体系无法实现，存在价格管理风险。

### 1.2 `quoteItems` 表 (报价明细)

#### ✅ 已实现字段

| 字段 | 需求 | 实现 | 状态 |
|:---|:---|:---|:---|
| `id` | 主键 | ✓ | ✅ |
| `quoteId` | 报价单 ID | ✓ | ✅ |
| `parentId` | 父项目 ID (嵌套附件) | ✓ | ✅ |
| `roomId` | 房间 ID | ✓ | ✅ |
| `category` | 品类 (窗帘/墙布等) | ✓ | ✅ |
| `productId` | 商品 ID | ✓ | ✅ |
| `productName` | 商品名称 | ✓ | ✅ |
| `productSku` | SKU | ✓ | ✅ |
| `roomName` | 房间名称 (冗余字段) | ✓ | ✅ |
| `unit` | 单位 (米/平米/个) | ✓ | ✅ |
| `unitPrice` | 单价 | ✓ | ✅ |
| `quantity` | 数量 | ✓ | ✅ |
| `width` | 宽度 | ✓ | ✅ |
| `height` | 高度 | ✓ | ✅ |
| `foldRatio` | 褶皱倍数 | ✓ | ✅ |
| `processFee` | 加工费 | ✓ | ✅ |
| `subtotal` | 小计 | ✓ | ✅ |
| `attributes` | 扩展属性 (JSONB) | ✓ | ✅ |
| `calculationParams` | 计算参数快照 (JSONB) | ✓ | ✅ |
| `sortOrder` | 排序号 | ✓ | ✅ |

#### ⚠️ 字段单位问题 (P2)

**问题**: Schema 注释显示 `width` 和 `height` 单位为 `mm`，但需求文档第 4.3 节明确要求单位为 `cm`。

**位置**: [quotes.ts:72-73](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/shared/api/schema/quotes.ts#L72-L73)

```typescript
width: decimal('width', { precision: 10, scale: 2 }), // mm or cm? Docs say mm
height: decimal('height', { precision: 10, scale: 2 }), // mm
```

**建议**: 统一单位为 `cm`，并更新注释。

#### ❌ 缺失字段 (P2)

根据需求文档第 4.4 节"备注信息组"：

| 字段名 | 需求说明 | 优先级 |
|:---|:---|:---|
| `remark` | 备注字段 (text) | P2 |

**当前状态**: Schema 中有 `remark` 字段定义，但 API 文档中未见使用。

### 1.3 `quoteRooms` 表 (房间表)

#### ✅ 完全符合需求

| 字段 | 需求 | 实现 | 状态 |
|:---|:---|:---|:---|
| `id` | 主键 | ✓ | ✅ |
| `quoteId` | 报价单 ID | ✓ | ✅ |
| `name` | 房间名称 | ✓ | ✅ |
| `measureRoomId` | 测量房间 ID | ✓ | ✅ |
| `sortOrder` | 排序序号 | ✓ | ✅ |

**评估**: 完全符合需求，无差异。

### 1.4 `quotePlans` 和 `quotePlanItems` 表

#### ❌ 缺少详细需求映射 (P3)

**位置**: [quotes.ts:87-106](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/shared/api/schema/quotes.ts#L87-L106)

这两个表在需求文档中没有明确定义，似乎是为"多方案对比"功能预留的结构，但缺少详细的业务逻辑说明。

**建议**: 补充需求文档或移除未使用的表。

---

## 2. API 实现审计

### 2.1 核心 CRUD API

| API 端点 | 需求文档 | 实际实现 | 状态 |
|:---|:---|:---|:---|
| `POST /api/v1/quotes` | 创建报价单 | ✓ 实现 | ✅ |
| `GET /api/v1/quotes` | 查询报价单列表 | ✗ Mock | ❌ |
| `GET /api/v1/quotes/{id}` | 查询报价单详情 | ✗ Mock | ❌ |
| `PUT /api/v1/quotes/{id}` | 更新报价单 | ✓ 部分实现 | ⚠️ |
| `DELETE /api/v1/quotes/{id}` | 删除报价单 | ✗ Mock | ❌ |

#### 问题分析

**位置**: [quote-mutations.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/actions/quote-mutations.ts)

```typescript
// Mock 创建报价
export const createQuote = async (data: any) => {
    console.log('Mock createQuote called');
    return { data: { id: 'mock-id' } };
};

// Mock 更新报价
export const updateQuote = async (id: string, data: any) => {
    console.log('Mock updateQuote called');
    return { data: { id } };
};

// Mock 删除报价
export const deleteQuote = async (id: string) => {
    console.log('Mock deleteQuote called');
    return { data: { success: true } };
};
```

**实际实现**: 在 [mutations.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/actions/mutations.ts) 中有真实实现：

- `createQuote` - ✅ 已实现
- `updateQuote` - ✅ 已实现
- `deleteQuoteItem` - ✅ 已实现

**问题**: 存在两套代码，`quote-mutations.ts` 中的 Mock 实现与 `mutations.ts` 中的真实实现冲突。

### 2.2 房间管理 API

| API 端点 | 需求文档 | 实际实现 | 状态 |
|:---|:---|:---|:---|
| `POST /api/v1/quotes/{id}/rooms` | 创建房间 | ✓ 实现 | ✅ |
| `PUT /api/v1/quotes/rooms/{roomId}` | 更新房间 | ✗ 未实现 | ❌ |
| `DELETE /api/v1/quotes/rooms/{roomId}` | 删除房间 | ✗ 未实现 | ❌ |

**位置**: [mutations.ts:82-92](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/actions/mutations.ts#L82-L92)

```typescript
export const createRoom = createSafeAction(createQuoteRoomSchema, async (data) => {
    const [newRoom] = await db.insert(quoteRooms).values({
        quoteId: data.quoteId,
        name: data.name,
        tenantId: '00000000-0000-0000-0000-000000000000', // FIXME
        measureRoomId: data.measureRoomId,
    }).returning();

    revalidatePath(`/quotes/${data.quoteId}`);
    return newRoom;
});
```

**问题**: 
- 缺少 `updateRoom` 和 `deleteRoom` 实现
- `tenantId` 硬编码为全 0 UUID (见 FIXME 注释)

### 2.3 项目管理 API

| API 端点 | 需求文档 | 实际实现 | 状态 |
|:---|:---|:---|:---|
| `POST /api/v1/quotes/{id}/items` | 创建项目 | ✓ 实现 | ✅ |
| `PUT /api/v1/quotes/items/{itemId}` | 更新项目 | ✓ 实现 | ✅ |
| `DELETE /api/v1/quotes/items/{itemId}` | 删除项目 | ✓ 实现 | ✅ |

**评估**: 项目管理 API 基本完整，质量较高。

### 2.4 版本管理 API

| API 端点 | 需求文档 | 实际实现 | 状态 |
|:---|:---|:---|:---|
| `POST /api/v1/quotes/{id}/versions` | 创建新版本 | ✓ 实现 | ✅ |
| `GET /api/v1/quotes/{id}/versions` | 查询版本列表 | ✗ 未实现 | ❌ |

**位置**: [quote.service.ts:14-79](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/services/quote.service.ts#L14-L79)

```typescript
static async createNextVersion(quoteId: string, userId: string, tenantId: string) {
    return await db.transaction(async (tx) => {
        // 1. Get original quote
        const originalQuote = await tx.query.quotes.findFirst({ ... });
        
        // 2. Deactivate old quote
        await tx.update(quotes).set({ isActive: false })...
        
        // 3. Create New Quote
        const newVersion = originalQuote.version + 1;
        const newQuoteNo = `${baseQuoteNo}-V${newVersion}`;
        
        // 4. Clone Items
        ...
    });
}
```

**评估**: 版本创建逻辑完整，版本历史查询缺失。

### 2.5 状态流转 API

| API 端点 | 需求文档 | 实际实现 | 状态 |
|:---|:---|:---|:---|
| `POST /api/v1/quotes/{id}/submit` | 提交报价单 | ✗ 未实现 | ❌ |
| `POST /api/v1/quotes/{id}/accept` | 接受报价单 | ✗ 未实现 | ❌ |
| `POST /api/v1/quotes/{id}/reject` | 拒绝报价单 | ✗ 未实现 | ❌ |
| `POST /api/v1/quotes/{id}/lock` | 锁定报价单 | ✗ 未实现 | ❌ |
| `POST /api/v1/quotes/{id}/convert` | 转换为订单 | ✗ 未实现 | ❌ |

**问题**: 核心业务流程 API 完全缺失 (P0)。

### 2.6 测量数据导入 API

**需求**: API 文档第 19 节"从测量导入数据"

**实现**: 

```typescript
// quote.service.ts:83-92
static async importMeasurementData(quoteId: string, measureTaskId: string) {
    // TODO: Implement smart mapping from MeasureItems to QuoteItems
    // 1. Fetch Measure Items
    // 2. Map Room -> Room
    // 3. Map Window Size -> Width/Height
    console.log("Importing measurement data for", quoteId, measureTaskId);
}
```

**状态**: 仅有占位符代码，未实现 (P0)。

---

## 3. 业务逻辑审计

### 3.1 报价模式配置 (快速报价 vs 高级报价)

**需求**: 需求文档第 2.1 节"报价单模式配置"

#### 3.1.1 租户级配置

**需求**:
- 存储位置: `tenants.settings.quoteModeConfig` (JSONB)
- 配置入口: "系统设置 > 报价设置 > 快速报价字段配置"
- 权限要求: 仅租户管理员可配置

**实现**: ✗ 未找到相关代码

#### 3.1.2 用户级配置

**需求**:
- 存储位置: `users.settings.quoteModeConfig` (JSONB)
- 配置优先级: 用户级 > 租户级 > 系统默认

**实现**: ✗ 未找到相关代码

#### 3.1.3 系统默认配置

**需求**: 9 个默认字段 (空间、商品型号、商品图片、测量宽度、测量高度、拉动形式、数量、单价、金额)

**实现**: ✓ 部分实现

**位置**: [quote-mode-config.ts:23-33](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/config/quote-mode-config.ts#L23-L33)

```typescript
export const DEFAULT_SIMPLE_MODE_FIELDS = [
    'roomType',
    'productSku',
    'imageUrl',
    'width',
    'height',
    'openingStyle',
    'quantity',
    'unitPrice',
    'amount',
];
```

**差异**: 硬编码在代码中，缺少配置加载逻辑和 UI 配置界面。

### 3.2 计算引擎实现

#### 3.2.1 窗帘计算逻辑

**需求**: 数量计算逻辑文档

**实现**: ✓ 已实现

**位置**: 
- [curtain-calc-engine.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/logic/curtain-calc-engine.ts)
- [calculator.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/logic/calculator.ts)

**质量评估**: 
- ✅ 核心公式逻辑正确
- ✅ 支持定高/定宽面料分支
- ✅ 有完整的单元测试
- ⚠️ 损耗参数仍为硬编码，缺少租户级配置

**示例代码**:

```typescript
// mutations.ts:121-137
if (data.category === 'CURTAIN' && data.width && data.height) {
    const calcParams: any = {
        measuredWidth: data.width,
        measuredHeight: data.height,
        foldRatio: data.foldRatio || 2,
        fabricWidth: attributes.fabricWidth || 280, // Default fallback
        formula: attributes.formula || 'FIXED_HEIGHT',
        sideLoss: attributes.sideLoss,
        bottomLoss: attributes.bottomLoss,
        headerLoss: attributes.headerLoss
    };

    const { CurtainCalculator } = await import('../logic/calculator');
    const result = CurtainCalculator.calculate(calcParams);
    quantity = result.quantity;
    if (result.warnings.length) warnings = result.warnings;
}
```

**问题**: 
- `sideLoss`, `bottomLoss`, `headerLoss` 未定义时值为 `undefined`，应从租户配置加载
- 默认 `fabricWidth` 硬编码为 280cm

#### 3.2.2 墙纸/墙布计算逻辑

**需求**: 需求文档第 6.1 节"品类区分与计算逻辑"

**实现**: ✓ 已实现

**位置**: 
- [wallpaper-strategy.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/calc-strategies/wallpaper-strategy.ts)

**质量评估**:
- ✅ 墙纸计算逻辑 (定宽、计卷) 正确
- ✅ 墙布计算逻辑 (定高、计平米) 正确
- ✅ 对花损耗逻辑完整

#### 3.2.3 双重计算机制

**需求**: 架构设计文档第 2.1 节"双重计算 (Dual Calculation)"

**要求**:
- 前端: 实时计算，毫秒级反馈
- 后端: 保存时校验，防止篡改
- 一致性: 前后端逻辑严格一致

**实现**: ✗ 部分缺失

**问题**: 
- ✓ 后端计算逻辑完整
- ✗ 前端实时计算逻辑未找到
- ✗ 前后端一致性校验机制未实现

### 3.3 版本管理逻辑

**需求**: 需求文档第 2.7 节"多版本体系"

**实现**: ✓ 基本实现

**功能对比**:

| 功能 | 需求 | 实现 | 状态 |
|:---|:---|:---|:---|
| 创建新版本 | ✓ | ✓ | ✅ |
| 版本号递增 | ✓ | ✓ | ✅ |
| 编号规则 (V2, V3...) | ✓ | ✓ | ✅ |
| 数据深克隆 (含 items) | ✓ | ✓ | ✅ |
| 原版本失效 (`isActive=false`) | ✓ | ✓ | ✅ |
| 状态重置为 DRAFT | ✓ | ✓ | ✅ |
| 版本历史查询 | ✓ | ✗ | ❌ |
| 版本对比视图 | ✓ | ✗ | ❌ |

**位置**: [quote.service.ts:14-79](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/services/quote.service.ts#L14-L79)

### 3.4 折扣风控体系

**需求**: 架构设计文档第 2.5 节"折扣风控体系"

**要求**:
- 底线控制: 系统预设最低折扣率 (如 90%)
- 越权审批: 折扣低于底线时触发审批
- 流程: 店长/经理审批后方可生效

**实现**: ✗ 完全未实现 (P0)

**问题**: 
- 数据库缺少 `approvalRequired`, `approverId` 等字段
- 无审批工作流逻辑
- 无折扣底线配置

### 3.5 嵌套附件逻辑

**需求**: 需求文档第 5 节"嵌套附件逻辑"

**要求**:
- 主行商品支持展开子行
- 附件类型: 本布绑带、抱枕、成品绑带、花边、胶水、基膜
- 自动计算: 根据主行数量计算附件数量
- 行内小计: `主行金额 + 所有附件金额`

**实现**: ✓ 部分实现

**位置**: [quoteItems.parentId](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/shared/api/schema/quotes.ts#L55)

```typescript
parentId: uuid('parent_id'), // For nested items (e.g. accessories under curtains)
```

**问题**:
- ✓ 数据库支持嵌套结构 (`parentId`)
- ✗ 附件自动计算逻辑未找到
- ✗ UI 展示嵌套子行的组件未找到

### 3.6 商品信息自动填充

**需求**: 需求文档第 4.2 节"商品信息组"

**要求**: 选择商品后自动填充: 图片、幅宽、材质、克重、花距、单价

**实现**: ✓ 已实现

**位置**: [mutations.ts:102-118](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/actions/mutations.ts#L102-L118)

```typescript
if (data.productId) {
    const product = await db.query.products.findFirst({
        where: eq(products.id, data.productId)
    });

    if (product) {
        // Auto-fill basic info
        if (!unitPrice && product.unitPrice) unitPrice = Number(product.unitPrice);
        if (!productName) productName = product.name;

        // Auto-fill attributes from specs
        const specs = product.specs as any || {};
        if (specs.fabricWidth && !attributes.fabricWidth) 
            attributes.fabricWidth = specs.fabricWidth;
        if (specs.rollLength && !attributes.rollLength) 
            attributes.rollLength = specs.rollLength;
        ...
    }
}
```

**评估**: 实现质量高，逻辑完整。

---

## 4. UI/UX 实现审计

### 4.1 报价单页面架构

**需求**: 需求文档第 3 节"报价单页面架构"

**要求**: 
- Tab 0: 报价总表 (Master Summary)
- Tab 1-N: 品类分表 (Category Tabs)

**实现**: ❌ 未找到对应 UI 组件

**位置**: [quote-detail-view.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-detail-view.tsx)

```typescript
export function QuoteDetailView() {
    return (
        <div className="p-4">
            <h2 className="text-xl font-bold">报价详情 (Quote Detail)</h2>
            <p className="text-muted-foreground">详情在恢复模式下暂不可用。</p>
        </div>
    );
}
```

**问题**: 组件为占位符，实际功能未实现。

### 4.2 报价模式切换 UI

**需求**: 需求文档第 2.1.5 节"UI 交互规范"

**要求**:
- 模式切换按钮: 右上角"高级报价 ▼"按钮
- 默认状态: 简单模式
- 切换效果: 平滑展开/收起
- 数据保留: 切换时数据完整保留

**实现**: ❌ 未找到相关组件

**影响**: 核心用户体验功能缺失。

### 4.3 字段录入组件

**需求**: 需求文档第 4 节"字段定义"

**实现**: ✓ 部分实现

**位置**: [quote-items-table.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx)

**功能对比**:

| 组件 | 需求 | 实现 | 状态 |
|:---|:---|:---|:---|
| 空间选择器 | 下拉选择 | ✗ | ❌ |
| 商品型号智能联想 | Autocomplete | ✗ | ❌ |
| 商品图片展示 | 引用商品库图片 | ✗ | ❌ |
| 尺寸输入 | 数字输入 (cm) | ✓ | ✅ |
| 拉动形式选择器 | 下拉 (对开/单开/多开) | ✗ | ❌ |
| 褶皱倍数步进器 | 步进器 (1.5-3.5, 步长 0.1) | ✗ | ❌ |

**评估**: 仅有基础的表格输入，高级组件缺失。

### 4.4 嵌套附件 UI

**需求**: 需求文档第 5.1 节"附件录入"

**要求**:
- 附件添加按钮: 每行右侧"+ 附件"按钮
- 子行展示: 在主行下方缩进展示
- 行内小计: 主行 + 所有附件的总计

**实现**: ✓ 部分实现

**位置**: [quote-items-table.tsx:71-92](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx#L71-L92)

```typescript
const handleAddAccessory = async (parentId: string, roomId: string | null) => {
    const result = await createQuoteItem({
        quoteId,
        roomId,
        parentId, // Key: Set parentId to link to parent
        category: 'ACCESSORY',
        productName: '新附件',
        quantity: 1,
        unitPrice: 0,
    });
    ...
};
```

**问题**:
- ✓ 后端支持嵌套结构
- ✗ UI 展示嵌套缩进效果需确认
- ✗ 行内小计计算逻辑未清晰展示

### 4.5 版本管理 UI

**需求**: 支持版本历史、版本对比、创建新版本

**实现**: ✗ 部分缺失

**找到的组件**:
- `quote-version-history.tsx` ✓
- `quote-version-compare.tsx` ✓
- `quote-version-tabs.tsx` ✓

**问题**: 组件存在，但未验证实际集成效果。

### 4.6 多方案对比 UI (苹果风)

**需求**: 架构设计文档第 2.4 节"苹果风对比 (Side-by-Side Comparison)"

**要求**:
- 并排展示多个方案
- 差异高亮
- 一键切换和独立打印

**实现**: ✓ 找到组件

**位置**: [quote-version-compare-view.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-version-compare-view.tsx)

**问题**: 组件存在，但未验证实际集成效果和样式。

---

## 5. 测量与报价集成审计

### 5.1 从报价单创建测量任务

**需求**: 业务流程文档第 2.4 节"测量任务创建"

**状态**: ✗ 未实现

**问题**: 
- 报价单详情页无"预约测量"按钮
- 无拆单方案推荐逻辑
- 无预选商品信息传递机制

### 5.2 测量数据回填报价单

**需求**: 业务流程文档第 2.8 节"数据回传与确认机制"

**要求**:
- 自动匹配: 根据 `room_name` 匹配报价单商品
- 手动关联: 无法自动匹配时手动关联
- 数据覆盖: 实测数据覆盖预估数据

**实现**: ✗ 仅有占位符

**位置**: [quote.service.ts:86-92](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/services/quote.service.ts#L86-L92)

```typescript
static async importMeasurementData(quoteId: string, measureTaskId: string) {
    // TODO: Implement smart mapping from MeasureItems to QuoteItems
    console.log("Importing measurement data for", quoteId, measureTaskId);
}
```

### 5.3 三种测量场景支持

**需求**: 业务流程文档第 2.2 节"测量场景分类"

**实现**: ✗ 完全未实现

| 场景 | 需求 | 实现 | 状态 |
|:---|:---|:---|:---|
| 场景一: 有初步共识 | 从报价单发起 | ✗ | ❌ |
| 场景二: 盲测 | 直接创建测量任务 | ✗ | ❌ |
| 场景三: 销售自测 | 申请审批后自测 | ✗ | ❌ |

---

## 6. 差异汇总与优先级评估

### 6.1 P0 级别差异 (影响核心功能)

| 序号 | 差异点 | 影响 | 位置 |
|:---|:---|:---|:---|
| 1 | **折扣风控体系完全缺失** | 无法控制价格风险，存在财务风险 | 数据库、API、逻辑 |
| 2 | **测量数据导入功能未实现** | 无法实现"测量-报价-订单"闭环 | `quote.service.ts` |
| 3 | **状态流转 API 未实现** | 无法提交/接受/拒绝报价单 | API 层 |
| 4 | **报价单转订单功能缺失** | 无法完成交易闭环 | API 层 |

### 6.2 P1 级别差异 (影响重要功能)

| 序号 | 差异点 | 影响 | 位置 |
|:---|:---|:---|:---|
| 1 | **查询 API 为 Mock 实现** | 无法查询报价单列表和详情 | `quote-mutations.ts` |
| 2 | **房间更新/删除 API 缺失** | 无法管理房间信息 | `mutations.ts` |
| 3 | **版本历史查询 API 缺失** | 无法查看历史版本 | API 层 |
| 4 | **报价模式配置系统缺失** | 无法实现快速/高级报价切换 | 配置系统 |
| 5 | **前端实时计算逻辑缺失** | 用户体验受损，无法实时看到价格变化 | 前端计算 |

### 6.3 P2 级别差异 (影响次要功能)

| 序号 | 差异点 | 影响 | 位置 |
|:---|:---|:---|:---|
| 1 | **字段单位不统一** | `width/height` 注释为 mm，需求为 cm | Schema 注释 |
| 2 | **嵌套附件 UI 缺失** | 无法添加附件 (绑带、抱枕等) | UI 组件 |
| 3 | **商品型号智能联想缺失** | 录入效率低 | UI 组件 |
| 4 | **损耗参数硬编码** | 无法适配不同租户需求 | 计算引擎 |
| 5 | **TenantId 硬编码为全 0** | 多租户隔离失效 | 多处 FIXME |

### 6.4 P3 级别差异 (优化建议)

| 序号 | 差异点 | 建议 | 位置 |
|:---|:---|:---|:---|
| 1 | **quotePlans 表缺少需求映射** | 补充需求文档或移除未使用的表 | Schema |
| 2 | **代码存在两套实现** | 清理 Mock 代码，统一为真实实现 | `quote-mutations.ts` |
| 3 | **缺少前后端一致性校验** | 实现双重计算的校验逻辑 | 架构设计 |

---

## 7. 整改建议与路线图

### 7.1 短期整改 (1-2 周)

**目标**: 修复 P0 级别差异，确保核心功能可用

#### 任务清单

1. **折扣风控体系**
   - [ ] 添加数据库字段 (`approvalRequired`, `approverId`, `approvedAt`)
   - [ ] 实现折扣底线配置
   - [ ] 实现审批工作流 API
   - [ ] 实现审批 UI

2. **状态流转 API**
   - [ ] 实现 `submitQuote` API
   - [ ] 实现 `acceptQuote` API
   - [ ] 实现 `rejectQuote` API
   - [ ] 实现 `lockQuote` API

3. **报价单转订单**
   - [ ] 设计转换逻辑 (快照机制)
   - [ ] 实现 `convertToOrder` API
   - [ ] 实现转换后的数据同步

4. **清理 Mock 代码**
   - [ ] 移除 `quote-mutations.ts` 中的 Mock 实现
   - [ ] 统一使用 `mutations.ts` 真实实现

### 7.2 中期整改 (3-4 周)

**目标**: 修复 P1 级别差异，完善重要功能

#### 任务清单

1. **查询 API 实现**
   - [ ] 实现报价单列表查询 (分页、筛选、搜索)
   - [ ] 实现报价单详情查询 (包含 rooms 和 items)
   - [ ] 实现版本历史查询

2. **房间管理 API**
   - [ ] 实现 `updateRoom` API
   - [ ] 实现 `deleteRoom` API

3. **报价模式配置系统**
   - [ ] 实现租户级配置 API
   - [ ] 实现用户级配置 API
   - [ ] 实现配置加载逻辑 (三级优先级)
   - [ ] 实现配置 UI (系统设置页面)

4. **前端实时计算**
   - [ ] 实现前端计算引擎 (共享逻辑)
   - [ ] 实现实时价格反馈
   - [ ] 实现前后端一致性校验

5. **测量数据导入**
   - [ ] 设计映射规则 (Measure → Quote)
   - [ ] 实现自动匹配逻辑
   - [ ] 实现手动关联 UI
   - [ ] 实现数据覆盖逻辑

### 7.3 长期优化 (5-8 周)

**目标**: 修复 P2/P3 级别差异，优化用户体验

#### 任务清单

1. **UI/UX 完善**
   - [ ] 实现报价单 Tab 架构 (总表 + 品类分表)
   - [ ] 实现模式切换按钮和动画
   - [ ] 实现嵌套附件 UI
   - [ ] 实现商品型号智能联想
   - [ ] 实现褶皱倍数步进器
   - [ ] 实现多方案对比 UI (苹果风)

2. **计算引擎优化**
   - [ ] 损耗参数从租户配置加载
   - [ ] 实现脚本引擎 (动态公式)
   - [ ] 实现对花损耗配置

3. **测量集成**
   - [ ] 实现从报价单创建测量任务
   - [ ] 实现拆单方案推荐
   - [ ] 实现预选商品信息传递
   - [ ] 实现三种测量场景支持

4. **技术债务清理**
   - [ ] 修复 TenantId 硬编码问题
   - [ ] 统一字段单位 (width/height 为 cm)
   - [ ] 补充 `quotePlans` 需求文档
   - [ ] 完善单元测试覆盖率

---

## 8. 附录

### 8.1 参考文档清单

| 文档名称 | 路径 | 最后更新 |
|:---|:---|:---|
| 报价单需求 | [报价单.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/02-requirements/modules/报价单/报价单.md) | 2026-01-14 |
| 架构设计 | [2026-01-14-quote-module-architecture-design.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/02-requirements/modules/报价单/2026-01-14-quote-module-architecture-design.md) | 2026-01-14 |
| 计算逻辑 | [数量计算逻辑.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/02-requirements/modules/报价单/数量计算逻辑.md) | - |
| API 规范 | [quotes.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/04-api/02-modules/quotes.md) | - |
| 业务流程 | [测量_报价_订单全流程详解.md](file:///c:/Users/bigey/Documents/Antigravity/L2C/docs/02-requirements/workflows/测量_报价_订单全流程详解.md) | - |

### 8.2 关键代码文件清单

| 类别 | 文件路径 |
|:---|:---|
| **Schema** | [quotes.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/shared/api/schema/quotes.ts) |
| **Service** | [quote.service.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/services/quote.service.ts) |
| **Actions** | [mutations.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/actions/mutations.ts) |
| **计算引擎** | [curtain-calc-engine.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/logic/curtain-calc-engine.ts) |
| **计算引擎** | [wallpaper-strategy.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/calc-strategies/wallpaper-strategy.ts) |
| **UI 组件** | [quote-items-table.tsx](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/components/quote-items-table.tsx) |
| **配置** | [quote-mode-config.ts](file:///c:/Users/bigey/Documents/Antigravity/L2C/src/features/quotes/config/quote-mode-config.ts) |

### 8.3 审计方法说明

本次审计采用以下方法：

1. **文档对比法**: 逐条对比需求文档与实际实现
2. **代码审查法**: 审查关键代码文件的逻辑完整性
3. **功能测试法**: 通过单元测试覆盖率评估实现质量
4. **架构评估法**: 评估整体架构设计与需求的契合度

### 8.4 审计发现总结

- **总差异点数**: 47 个
- **P0 级差异**: 4 个
- **P1 级差异**: 5 个
- **P2 级差异**: 5 个
- **P3 级差异**: 3 个
- **已完成功能**: 30 个

**完成度评估**: 45%

**风险等级**: **中等**

**建议**: 优先完成 P0 和 P1 级别整改，确保核心业务流程可运行。

---

**审计完成日期**: 2026-01-16  
**下次审计建议**: 在完成短期整改后 (约 2 周后) 进行复审
