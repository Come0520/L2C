# 报价模块代码实现整改计划（基于 2026-01-16 审计）

> **目标**: 修复报价模块与需求文档之间的 47 个差异点
> **审计报告**: [报价模块审计报告_2026-01-16.md](./报价模块审计报告_2026-01-16.md)
> **当前完成度**: **45%**
> **优先级**: **P0** (核心交易流程)

---

## 整改总览

本整改计划基于 2026-01-16 的全面审计结果，分为三个阶段：
- **短期 (1-2 周)**: 修复 P0 级差异，确保核心功能可用
- **中期 (3-4 周)**: 修复 P1 级差异，完善重要功能
- **长期 (5-8 周)**: 修复 P2/P3 级差异，优化用户体验

---

## 1. 数据库 Schema 整改需求

### 1.1 quotes 表字段补充 (P0)

**问题描述**: 根据需求文档第 2.1 节"折扣风控体系"，Schema 已包含相关字段但需确认完整性。

**需求字段**:
| 字段名 | 类型 | 说明 | 优先级 |
|:---|:---|:---|:---:|
| `approvalRequired` | BOOLEAN | 是否需要审批 | P0 |
| `approverId` | UUID REFERENCES users(id) | 审批人 ID | P0 |
| `approvedAt` | TIMESTAMP | 审批时间 | P1 |
| `rejectReason` | TEXT | 拒绝原因 | P1 |

**当前状态**: Schema 已包含这些字段（第30-34行），需确认与需求一致。

**整改需求**:
- [ ] 确认字段定义与需求文档第 2.1 节完全一致
- [ ] 添加字段注释说明折扣风控用途
- [ ] 验证字段默认值正确性

### 1.2 字段单位统一 (P2)

**问题描述**: Schema 注释显示 `width` 和 `height` 单位为 `mm`，但需求文档第 4.3 节明确要求单位为 `cm`。

**位置**: `src/shared/api/schema/quotes.ts:78-79`

**整改需求**:
- [ ] 统一单位为 `cm`，并更新注释
- [ ] 验证所有相关计算逻辑使用 cm 单位
- [ ] 更新 API 文档说明单位

### 1.3 quoteItems 表 remark 字段 (P2)

**问题描述**: 需求文档第 4.4 节"备注信息组"要求 remark 字段，Schema 已存在但需确认使用。

**整改需求**:
- [ ] 确认 remark 字段在 API 中正确使用
- [ ] 确认前端组件支持备注输入

---

## 2. API 实现整改需求

### 2.1 核心 CRUD API (P0)

**问题描述**: 存在两套代码，`quote-mutations.ts` 中的 Mock 实现与 `mutations.ts` 中的真实实现冲突。

**整改需求**:
- [ ] 移除 `quote-mutations.ts` 中的 Mock 实现
- [ ] 统一使用 `mutations.ts` 真实实现
- [ ] 确认所有 CRUD API 功能完整

### 2.2 房间管理 API (P1)

**问题描述**: 缺少 `updateRoom` 和 `deleteRoom` 实现，且 `tenantId` 硬编码。

**整改需求**:
- [ ] 实现 `PUT /api/v1/quotes/rooms/{roomId}` - 更新房间
  - **输入参数**: roomId, name, measureRoomId
  - **业务逻辑**: 更新房间名称和关联测量房间
  - **权限**: 仅报价单创建人可修改
- [ ] 实现 `DELETE /api/v1/quotes/rooms/{roomId}` - 删除房间
  - **输入参数**: roomId
  - **业务逻辑**: 删除房间及其关联的所有报价项目
  - **权限**: 仅报价单创建人可删除
- [ ] 修复 `tenantId` 硬编码问题，从 session 获取真实租户 ID

### 2.3 版本管理 API (P1)

**问题描述**: 缺少版本历史查询 API。

**整改需求**:
- [ ] 实现 `GET /api/v1/quotes/{id}/versions` - 查询版本列表
  - **返回数据**: 版本号列表，每个版本包含版本号、创建时间、创建人、状态
  - **排序**: 按版本号降序排列

### 2.4 状态流转 API (P0)

**问题描述**: 核心业务流程 API 完全缺失。

**整改需求**:
- [ ] 实现 `POST /api/v1/quotes/{id}/submit` - 提交报价单
  - **业务规则**:
    - 仅 DRAFT 状态可提交
    - 若 `approvalRequired=true` 且未审批，禁止提交
    - 提交后状态变为 `SUBMITTED`
  - **通知**: 发送通知给客户（根据客户配置）
- [ ] 实现 `POST /api/v1/quotes/{id}/accept` - 接受报价单
  - **业务规则**:
    - 仅 SUBMITTED 状态可接受
    - 接受后状态变为 `ACCEPTED`
    - 可选填写接受备注
  - **通知**: 发送通知给销售人员
- [ ] 实现 `POST /api/v1/quotes/{id}/reject` - 拒绝报价单
  - **业务规则**:
    - 仅 SUBMITTED 状态可拒绝
    - 必填拒绝原因
    - 拒绝后状态变为 `REJECTED`
  - **通知**: 发送通知给销售人员
- [ ] 实现 `POST /api/v1/quotes/{id}/lock` - 锁定报价单
  - **业务规则**:
    - 锁定后禁止修改
    - 记录锁定时间
  - **权限**: 仅报价单创建人或店长可锁定
- [ ] 实现 `POST /api/v1/quotes/{id}/unlock` - 解锁报价单
  - **业务规则**:
    - 解锁后允许修改
    - 清除锁定时间
  - **权限**: 仅报价单创建人或店长可解锁

### 2.5 测量数据导入 API (P0)

**问题描述**: 仅有占位符代码，未实现。

**整改需求**:
- [ ] 实现 `POST /api/v1/quotes/{id}/import-measurement` - 导入测量数据
  - **输入参数**: measureTaskId
  - **业务逻辑**:
    1. 获取测量任务的所有 MeasureItems
    2. 智能匹配房间名称到报价单房间
    3. 若无匹配房间，自动创建新房间
    4. 将 MeasureItems 映射为 QuoteItems
    5. 映射规则:
       - windowType → category (使用映射表)
       - width/height → width/height
       - installType → attributes.installType
       - bracketDist → attributes.bracketDist
       - wallMaterial → attributes.wallMaterial
       - hasBox → attributes.hasBox
       - boxDepth → attributes.boxDepth
       - isElectric → attributes.isElectric
       - remark → attributes.remark
    6. 自动更新报价单总金额
  - **返回数据**: 导入的项目数量和详情

---

## 3. 业务逻辑整改需求

### 3.1 折扣风控体系 (P0)

**问题描述**: 折扣风控体系完全未实现。

**整改需求**:

#### 3.1.1 折扣底线配置
- [ ] 在租户配置中添加折扣底线设置
  - **配置路径**: 系统设置 > 报价设置 > 折扣风控
  - **配置项**:
    - `minDiscountRate`: 最低折扣率（如 0.80，即 80%）
    - `autoApprovalThreshold`: 自动审批阈值（如 0.95，即 95%）
    - `requireApprovalBelow`: 低于此阈值需审批（如 0.95）
  - **默认值**:
    - minDiscountRate: 0.80 (80%)
    - autoApprovalThreshold: 0.95 (95%)
    - requireApprovalBelow: 0.95 (95%)

#### 3.1.2 折扣校验逻辑
- [ ] 实现折扣底线校验
  - **校验规则**:
    - 若 `discountRate < minDiscountRate`，抛出错误提示
    - 错误消息: "折扣率低于租户最低限制"
  - **触发时机**:
    - 修改折扣率时
    - 保存报价单时

#### 3.1.3 审批触发逻辑
- [ ] 实现审批需求判断
  - **判断逻辑**:
    - 若 `discountRate >= 1`，无需审批
    - 若 `discountRate >= autoApprovalThreshold`，自动审批通过
    - 若 `discountRate < requireApprovalBelow`，设置 `approvalRequired=true`
  - **自动审批**:
    - 折扣率 >= 阈值时，自动设置 `approverId` 和 `approvedAt`

#### 3.1.4 审批工作流
- [ ] 实现审批 API
  - `POST /api/v1/quotes/{id}/approve` - 审批通过
    - **业务规则**:
      - 仅 `approvalRequired=true` 的报价单可审批
      - 记录审批人和审批时间
      - 审批后 `approvalRequired=false`
  - `POST /api/v1/quotes/{id}/reject` - 审批拒绝
    - **业务规则**:
      - 必填拒绝原因
      - 记录拒绝原因和时间
      - 拒绝后状态变为 `REJECTED`

### 3.2 报价模式配置系统 (P1)

**问题描述**: 报价模式配置系统完全未实现。

**整改需求**:

#### 3.2.1 租户级配置
- [ ] 实现租户级配置 API
  - `GET /api/v1/tenant/quote-mode-config` - 获取租户配置
  - `PUT /api/v1/tenant/quote-mode-config` - 更新租户配置
  - **配置结构**:
    ```json
    {
      "defaultMode": "SIMPLE",
      "simpleModeFields": [
        "roomType",
        "productSku",
        "imageUrl",
        "width",
        "height",
        "openingStyle",
        "quantity",
        "unitPrice",
        "amount"
      ],
      "defaultValues": {
        "installPosition": "CURTAIN_BOX",
        "groundClearance": 2,
        "foldRatio": 2.0
      }
    }
    ```

#### 3.2.2 用户级配置
- [ ] 实现用户级配置 API
  - `GET /api/v1/user/quote-mode-config` - 获取用户配置
  - `PUT /api/v1/user/quote-mode-config` - 更新用户配置
  - **配置结构**:
    ```json
    {
      "simpleModeFields": [...],
      "customized": true,
      "updatedAt": "2026-01-09T10:30:00Z"
    }
    ```

#### 3.2.3 配置加载逻辑
- [ ] 实现三级优先级加载
  - **优先级**: 用户级 > 租户级 > 系统默认
  - **加载逻辑**:
    1. 优先加载用户级配置（若 `customized=true`）
    2. 其次加载租户级配置
    3. 最后使用系统默认配置（硬编码）
  - **缓存策略**: 缓存 5 分钟，配置更新后清除缓存

#### 3.2.4 配置 UI
- [ ] 实现系统设置页面
  - **路径**: 系统设置 > 报价设置 > 快速报价字段配置
  - **功能**:
    - 字段清单：列出所有报价字段（字段1-20）
    - 字段分组：按"用户输入组"、"商品信息组"、"尺寸与安装要求组"、"金额与计算组"分组展示
    - 勾选操作：通过勾选框选择在简单模式下显示的字段
    - 实时预览：勾选/取消勾选时，右侧实时预览简单模式表单效果
    - 重置功能：提供"重置为系统默认"按钮，恢复到系统推荐的9个默认字段
    - 保存功能：配置后需点击"保存"按钮生效
  - **权限**: 仅租户管理员可配置

### 3.3 前端实时计算 (P1)

**问题描述**: 前端实时计算逻辑未找到，无法提供毫秒级反馈。

**整改需求**:
- [ ] 实现前端计算引擎
  - **共享逻辑**: 将后端计算逻辑提取为共享代码，前后端共用
  - **实时反馈**: 用户修改任何字段时，立即重新计算并更新显示
  - **性能要求**: 计算响应时间 < 100ms
- [ ] 实现前后端一致性校验
  - **校验时机**: 保存报价单时
  - **校验逻辑**: 前端计算结果与后端计算结果对比
  - **差异处理**: 若差异 > 1%，提示用户并以后端结果为准

### 3.4 嵌套附件逻辑 (P2)

**问题描述**: 附件自动计算逻辑未找到。

**整改需求**:
- [ ] 实现附件自动计算逻辑
  - **本布绑带**:
    - 固定数量: 0.15m
    - 推荐数量: 单开 1 个，对开 2 个
    - 单价: 可配置参数
  - **抱枕**:
    - 单价: 自动锁定主行面料价格
    - 尺寸: 默认 45×45，可自由定义
    - 支持多行
  - **成品绑带/花边/自定义**: 手动录入数量与单价
  - **行内小计**: 主行金额 + 所有嵌套附件行金额

---

## 4. UI/UX 实现整改需求

### 4.1 报价单页面架构 (P1)

**问题描述**: 组件为占位符，实际功能未实现。

**整改需求**:
- [ ] 实现报价单页面架构
  - **Tab 0: 报价总表 (Master Summary)**
    - 客户信息（只读）：姓名、电话、项目地址
    - 安全规则：严禁展示客户来源、介绍人、设计师、佣金等 CRM 敏感隐私字段
    - 汇总信息：自动聚合各品类分表（窗帘、墙布等）的小计金额，展示总金额、优惠、定金金额
  - **Tab 1-N: 品类分表 (Category Tabs)**
    - 包含品类：窗帘、墙布&墙纸、墙咔、飘窗垫、标品等
    - 录入偏好设置：支持"先品类后空间（默认）"和"先空间后品类"两种录入路径

### 4.2 报价模式切换 UI (P1)

**问题描述**: 模式切换 UI 完全缺失。

**整改需求**:
- [ ] 实现模式切换按钮
  - **位置**: 报价单表单右上角
  - **按钮状态**:
    - 简单模式：按钮显示"高级报价 ▼"
    - 高级模式：按钮显示"收起 ▲"
  - **切换效果**: 点击按钮后，所有隐藏字段平滑展开/收起
  - **字段提示**: 简单模式下，隐藏的字段在鼠标悬停时显示提示"点击高级报价查看"
  - **数据保留**: 切换模式时，已录入的数据完整保留

### 4.3 字段录入组件 (P1)

**问题描述**: 仅有基础的表格输入，高级组件缺失。

**整改需求**:
- [ ] 实现空间选择器
  - 下拉选择已有空间或手动输入新空间
  - 支持创建新空间
- [ ] 实现商品型号智能联想
  - Autocomplete 组件
  - 输入即检索商品库
  - 选中后自动填充字段 3-7 及 15
  - 显示商品图片和规格
- [ ] 实现商品图片展示
  - 引用商品库"细节图1"
  - 支持图片预览
- [ ] 实现拉动形式选择器
  - 下拉选择：对开(默认)、单开（左）、单开（右）、多开
  - 多开逻辑：若选择"多开"，提供动态输入框，按从左到右顺序填写每一段的尺寸（数组存储）
- [ ] 实现褶皱倍数步进器
  - 步进器控制（1.5-3.5），步长 0.1，默认 2
  - 实时显示褶皱效果预览

### 4.4 嵌套附件 UI (P2)

**问题描述**: UI 展示嵌套缩进效果需确认。

**整改需求**:
- [ ] 实现嵌套附件 UI
  - **附件添加按钮**: 每行右侧"+ 附件"按钮
  - **子行展示**: 在主行下方缩进展示
  - **行内小计**: 主行 + 所有附件的总计
  - **附件类型选择**: 下拉选择附件类型（本布绑带、抱枕、成品绑带、花边、胶水、基膜等）

### 4.5 版本管理 UI (P2)

**问题描述**: 组件存在，但未验证实际集成效果。

**整改需求**:
- [ ] 实现版本历史时间轴
  - 展示所有版本列表
  - 显示版本号、创建时间、创建人、状态
  - 支持点击切换到对应版本
- [ ] 实现版本对比视图
  - 左右对比两个版本
  - 高亮显示差异部分
  - 支持一键切换到新版本

---

## 5. 测量与报价集成整改需求

### 5.1 从报价单创建测量任务 (P2)

**问题描述**: 报价单详情页无"预约测量"按钮。

**整改需求**:
- [ ] 实现从报价单创建测量任务
  - **触发入口**: 报价单详情页"预约测量"按钮
  - **业务逻辑**:
    1. 获取报价单的客户 ID 和项目地址
    2. 创建测量任务，类型为 `FROM_QUOTE`
    3. 传递预选商品信息（可选）
    4. 关联报价单 ID 到测量任务
  - **返回数据**: 测量任务 ID

### 5.2 测量数据回填报价单 (P0)

**问题描述**: 仅有占位符，未实现。

**整改需求**:
- [ ] 实现测量数据回填功能
  - **触发入口**: 报价单详情页"导入测量数据"按钮
  - **业务逻辑**:
    1. 选择测量任务 ID
    2. 获取测量任务的所有 MeasureItems
    3. 智能匹配房间名称到报价单房间
    4. 若无匹配房间，自动创建新房间
    5. 将 MeasureItems 映射为 QuoteItems
    6. 自动更新报价单总金额
  - **映射规则**: 详见 2.5 节

### 5.3 三种测量场景支持 (P2)

**问题描述**: 完全未实现。

**整改需求**:
- [ ] 实现场景一：有初步共识
  - 从报价单发起测量任务
  - 传递预选商品信息
- [ ] 实现场景二：盲测
  - 直接创建测量任务
  - 类型为 `BLIND`
- [ ] 实现场景三：销售自测
  - 申请审批后自测
  - 类型为 `SELF_MEASURE`
  - 需审批流程

---

## 6. 执行计划清单

### 第一周 (Day 1-7): P0 核心功能 → 目标完成度 55%

#### Day 1-2: 折扣风控体系
- [ ] 确认 Schema 字段完整性
- [ ] 实现折扣底线配置 API
- [ ] 实现折扣校验逻辑
- [ ] 实现审批触发逻辑
- [ ] 实现审批工作流 API

#### Day 3-4: 状态流转 API
- [ ] 实现 submitQuote API
- [ ] 实现 acceptQuote API
- [ ] 实现 rejectQuote API
- [ ] 实现 lockQuote API
- [ ] 实现 unlockQuote API

#### Day 5-6: 测量数据导入
- [ ] 实现测量数据导入 API
- [ ] 实现房间匹配逻辑
- [ ] 实现字段映射逻辑
- [ ] 实现自动更新总金额

#### Day 7: 房间管理 API
- [ ] 实现 updateRoom API
- [ ] 实现 deleteRoom API
- [ ] 修复 tenantId 硬编码问题

### 第二周 (Day 8-14): P1 重要功能 → 目标完成度 70%

#### Day 8-10: 报价模式配置系统
- [ ] 实现租户级配置 API
- [ ] 实现用户级配置 API
- [ ] 实现三级优先级加载逻辑
- [ ] 实现配置 UI（系统设置页面）

#### Day 11-12: 版本管理 API
- [ ] 实现版本历史查询 API
- [ ] 实现版本切换逻辑
- [ ] 实现版本对比视图

#### Day 13-14: 前端实时计算
- [ ] 提取后端计算逻辑为共享代码
- [ ] 实现前端计算引擎
- [ ] 实现实时价格反馈
- [ ] 实现前后端一致性校验

### 第三周 (Day 15-21): UI/UX 完善 → 目标完成度 80%

#### Day 15-17: 报价单页面架构
- [ ] 实现报价总表 Tab
- [ ] 实现品类分表 Tabs
- [ ] 实现客户信息展示（只读）
- [ ] 实现汇总信息展示

#### Day 18-19: 报价模式切换 UI
- [ ] 实现模式切换按钮
- [ ] 实现字段展开/收起动画
- [ ] 实现字段提示功能
- [ ] 实现数据保留逻辑

#### Day 20-21: 字段录入组件
- [ ] 实现空间选择器
- [ ] 实现商品型号智能联想
- [ ] 实现拉动形式选择器
- [ ] 实现褶皱倍数步进器

### 第四周 (Day 22-28): 高级功能 → 目标完成度 90%

#### Day 22-24: 嵌套附件 UI
- [ ] 实现附件添加按钮
- [ ] 实现子行缩进展示
- [ ] 实现行内小计计算
- [ ] 实现附件类型选择

#### Day 25-27: 测量集成
- [ ] 实现从报价单创建测量任务
- [ ] 实现三种测量场景支持
- [ ] 实现测量数据回填 UI
- [ ] 实现手动关联功能

#### Day 28: 字段单位统一
- [ ] 统一 width/height 单位为 cm
- [ ] 更新所有相关注释
- [ ] 验证计算逻辑使用 cm 单位

---

## 7. 资源需求

| 角色 | 人数 | 时间投入 | 主要职责 |
|:---|:---:|:---|:---|
| **后端开发** | 1人 | 全职4周 | API 实现、业务逻辑、数据库 |
| **前端开发** | 1人 | 全职4周 | UI 组件、交互逻辑、实时计算 |
| **QA测试** | 1人 | 1周 (第4周) | 单元测试、E2E测试、回归测试 |
| **业务专家** | 1人 | 兼职1周 | 需求确认、流程验证 |

**总人天估算**: 约 **80人天**

---

## 8. 关键风险与应对

| 风险 | 等级 | 缓解措施 |
|:---|:---:|:---|
| 折扣风控规则复杂度超预期 | 🔴 高 | Week 1 提前与业务确认详细规则 |
| 前后端计算逻辑不一致 | 🔴 高 | 共享计算代码，单元测试覆盖 |
| 测量模块未完成 | 🟡 中 | Week 2 提前审计测量模块，必要时 Mock |
| 报价模式配置理解偏差 | 🟡 中 | Week 2 开发前与业务确认配置需求 |
| UI 组件开发时间超预期 | 🟢 低 | 优先实现核心功能，次要功能延后 |

---

## 9. 验收标准

### 功能验收
- [ ] ✅ 折扣风控体系 100% 可用
- [ ] ✅ 状态流转 API 全部实现且测试通过
- [ ] ✅ 测量数据导入端到端可执行
- [ ] ✅ 报价模式配置系统可用
- [ ] ✅ 前端实时计算响应 <100ms
- [ ] ✅ 嵌套附件逻辑正确
- [ ] ✅ 版本管理功能完整

### 性能验收
- [ ] ✅ 报价单列表加载 <2s (1000+ 记录)
- [ ] ✅ 报价单详情页加载 <1s
- [ ] ✅ 前端实时计算 <100ms
- [ ] ✅ 测量数据导入 <3s (100+ items)

### 质量验收
- [ ] ✅ 单元测试覆盖率 ≥70%
- [ ] ✅ E2E 测试覆盖核心 Flow
- [ ] ✅ 无 P0/P1 Bug
- [ ] ✅ 前后端计算逻辑一致性 100%

---

## 10. 详细文档参考

📄 [报价模块审计报告_2026-01-16.md](./报价模块审计报告_2026-01-16.md)
📄 [报价单需求文档](./02-requirements/modules/报价单/报价单.md)
📄 [数量计算逻辑文档](./02-requirements/modules/报价单/数量计算逻辑.md)
📄 [报价模块架构设计](./02-requirements/modules/报价单/2026-01-14-quote-module-architecture-design.md)

---

**计划制定人**: AI Agent
**计划审批人**: _待填写_
**计划开始日期**: 2026-01-20
**计划结束日期**: 2026-02-17
