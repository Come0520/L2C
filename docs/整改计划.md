# 审批流程需求文档整改计划

> **目标文档**：`docs/02-requirements/modules/审批流程.md`
> **涉及模块**：审批流程 (Approval Workflow)
> **优先级**：P0 (文档质量直接影响开发实现)

---

## 1. 业务逻辑一致性修正 (Logic Consistency)

### 1.1 阈值配置统一
**问题描述**：文档中对于同一业务指标的阈值定义前后不一致。
**整改动作**：
- [x] **特殊工费阈值**：全文统一为 **120%**。
  - 修正 6.1 节触发场景中的 `1.5 (150%)` 为 `1.2 (120%)`，与 4.6.1 节保持一致。
- [x] **坏账核销账龄**：全文统一为 **90天**。
  - 修正 6.1 节触发场景中的 `180天` 为 `90天`，与 4.7.1 节保持一致。

### 1.2 叫停恢复逻辑澄清
**问题描述**：4.4.2 流程图（48小时无条件自动恢复）与 4.4.3 规则（最多7天）存在逻辑冲突。
**整改动作**：
- [ ] **重写叫停恢复规则** (4.4.3 & 4.4.6)：
  - **叫停申请**：销售发起 → 店长/采购审批（叫停原因：客户原因/现场变化等）
  - **叫停状态**：
    - 每12小时提醒一次（由弱到强）：
      - 0-24小时：弱提醒（系统通知）
      - 24-48小时：中提醒（系统通知+微信）
      - 48小时：强提醒（短信+强弹窗）
    - 48小时后自动恢复生产（如果未延期）
    - 记录"超时自动恢复"日志
  - **延期机制**：
    - 延期申请：无需审批
    - 延期通知：抄送给采购同事
    - 延期时长：7天
    - 延期次数：无限制
  - **7天节点决策**：
    - 强提醒申请人："叫停即将到期，请确认是否继续"
    - 选项1：恢复生产 → 状态变更为"生产中"
    - 选项2：继续延期 → 重新进入7天计时
  - 更新 Mermaid 流程图以反映此逻辑。

---

## 2. 核心审批场景补充 (Missing Scenes)

### 2.1 新增付款审批
**问题描述**：2.2 节提到付款审批，但 4 节中缺失。
**整改动作**：
- [x] **增加 4.11 付款审批章节**：
  - **供应商付款**：采购单生成付款申请 -> 财务审核金额与发票 -> 老板审核(大额)。
  - **劳务费结算**：安装/加工完成验收 -> 生成劳务费账单 -> 财务批量/单笔审核。
  - **数据结构**：补充对应的配置 JSON 示例。

### 2.2 新增退款审批
**问题描述**：涉及资金流出的高风险操作缺失审批定义。
**整改动作**：
- [x] **增加 4.12 退款审批章节**：
  - **触发条件**：订单撤销、多收退款、售后赔付。
  - **审批路径**：店长(确认事实) -> 财务(核对原支付渠道) -> 老板(金额>阈值)。
  - **风险控制**：强调原路退回原则。

---

## 3. 规范与定义统一 (Standardization)

### 3.1 通知渠道枚举统一
**问题描述**：混用 `WECHAT` 和 `WECHAT_MINI`。
**整改动作**：
- [x] **统一枚举值**：
  - `SYSTEM`: 系统通知（用户登录后查看）
  - `WECHAT_MINI`: 微信小程序（业务通知，推送至微信小程序）
  - `SMS`: 短信（紧急通知，直接发送短信）
  - `WECHAT_OFFICIAL`: 微信服务号（模板消息推送，预留）
- [ ] **更新所有相关配置项**：
  - 检查 3.4, 4.1.7, 6.5 等所有涉及通知渠道的章节
  - 补充通知渠道使用场景配置：
    - **普通通知**：`SYSTEM` + `WECHAT_MINI`（审批通知、一般提醒）
    - **紧急通知**：`SMS` + `SYSTEM` + `WECHAT_MINI`（叫停到期、强提醒）
    - **弱提醒**：`SYSTEM`（日常提醒）
  - 补充通知渠道优先级：
    - 紧急通知：SMS > WECHAT_MINI > SYSTEM
    - 普通通知：WECHAT_MINI > SYSTEM
    - 弱提醒：SYSTEM

### 3.2 审批人角色枚举定义
**问题描述**：角色代码分散，缺乏统一索引。
**整改动作**：
- [ ] **新增 5.5 审批人角色枚举章节**：
  - 此表作为系统的 Single Source of Truth。
  ```markdown
  | 角色代码 | 角色名称 | 职责说明 | 层级 |
  |:---|:---|:---|:---|
  | STORE_MANAGER | 店长 | 门店业务管理，负责一级审批 | 2 |
  | ADMIN | 老板/管理员 | 公司决策，负责大额/异常审批，最大权限 | 1 |
  | FINANCE | 财务 | 资金往来审核，负责收付款审批 | 2 |
  | PURCHASING | 采购 | 供应链管理，负责成本/叫停审批 | 2 |
  | DISPATCHER | 派单员 | 任务调度，负责免费测量审批（可选）| 3 |
  ```
- [ ] **补充资金相关审批规则**：
  - **审批与抄送机制**：
    - 审批模式：需要审批人同意才能通过
    - 抄送模式：仅通知，无需审批
    - 全审批模式：所有相关人员都需要审批
  - **金额阈值配置**：
    - 小额（< 阈值1）：店长审批，财务抄送
    - 中额（阈值1 ≤ 金额 < 阈值2）：店长审批 + 财务审批，老板抄送
    - 大额（≥ 阈值2）：店长审批 + 财务审批 + 老板审批
    - 全审批开关：开启后，所有金额都需要老板和财务审批
  - **资金相关审批类型**：付款审批、退款审批、坏账核销、特殊工费审批
- [ ] **补充角色层级关系**：
  - ADMIN (老板/管理员) 最大权限
  - STORE_MANAGER、FINANCE、PURCHASING 平级
  - DISPATCHER 最低层级
- [ ] **补充多租户支持**：
  - 预设角色：系统提供5个预设角色
  - 自定义角色：租户可以创建自定义角色
  - 角色继承：自定义角色可以继承预设角色的权限
  - 角色配置：每个租户可以独立配置角色的审批权限和金额阈值

---

## 4. 功能增强与完善 (Feature Enhancement)

### 4.1 并行会签支持
**问题描述**：功能列表中提到并行审批，但无具体落地设计。
**整改动作**：
- [ ] **更新 5.1 数据结构**：
  - 在 `nodes` 结构中增加 `approver_mode` 字段（`ANY`/`ALL`/`MAJORITY` 会签）
  - 增加 `timeout_hours` 字段（超时时间）
  - 增加 `timeout_action` 字段（超时处理方式，默认 `REMIND`）
- [ ] **补充会签模式定义**：
  - **ANY（任意通过）**：任意一人审批通过即可，适用于低风险事项，快速决策
  - **ALL（全部通过）**：所有人审批通过才行，适用于高风险事项，严格风控
  - **MAJORITY（多数通过）**：超过半数通过即可，适用于平衡效率与风险
- [ ] **补充场景示例**：
  - 坏账核销（ALL模式）：店长 + 老板，两人都必须审批通过
  - 叫停申请（ANY模式）：店长 + 采购，任意一人审批通过即可
  - 特殊工费（MAJORITY模式）：店长 + 财务 + 老板，至少2人审批通过
- [ ] **补充审批人可见性规则**：
  - 实时可见：审批人可以看到其他人的审批状态（已通过/已驳回/待审批）
  - 审批意见可见：审批人可以看到其他人的审批意见和备注
  - 不需要盲审模式
- [ ] **补充超时处理规则**：
  - 超时配置：每个审批节点可以设置超时时间（如：24小时、48小时）
  - 超时后处理：继续提醒（不自动通过/驳回）
  - 提醒频率：每12小时提醒一次（由弱到强）
- [ ] **补充驳回处理规则**：
  - 任意一人驳回：申请即被驳回
  - 驳回后通知：其他审批人收到通知："申请已被XXX驳回"
  - 驳回后处理：发起人可以修改后重新提交
  - 驳回原因记录：记录在审批历史中
- [ ] **补充租户配置**：
  - 默认配置：系统提供默认的会签模式配置
  - 租户自定义：租户可以在系统设置中为不同审批类型配置会签模式
  - 配置项：会签模式（ANY/ALL/MAJORITY）、超时时间、超时处理方式（REMIND）

### 4.2 审批撤回与修正
**问题描述**：缺乏容错机制定义。
**整改动作**：
- [ ] **新增 6.6 撤回规则章节**：
  - **发起人撤回**：
    - 撤回条件：状态为 `PENDING`（待审批）、提交时间在 24 小时内、尚未被任何审批人查看/处理
    - 撤回限制：仅发起人可以撤回自己的申请
    - 撤回后处理：审批状态变更为 `WITHDRAWN`（已撤回）、通知所有审批人、记录撤回操作到审批历史
    - 撤回原因：必填（如：信息填写错误、需要修改内容等）
  - **审批人撤回**：
    - 撤回条件：审批人已通过（`APPROVED`）、下一节点尚未处理、审批通过时间在 30 分钟内
    - 撤回限制：仅审批人可以撤回自己的审批
    - 撤回后处理：审批状态变更为 `PENDING`（待审批）、通知发起人和其他审批人、记录撤回操作到审批历史
    - 撤回原因：必填（如：审批错误、需要重新考虑等）
- [ ] **补充撤回权限表**：
  | 角色 | 撤回权限 | 说明 |
  |:---|:---|:---|
  | 发起人 | ✅ 可以撤回 | 仅限自己的申请 |
  | 审批人 | ✅ 可以撤回 | 仅限自己的审批 |
  | 店长/老板 | ❌ 不可撤回 | 无权撤回下属的审批 |
- [ ] **补充撤回记录内容**：
  - 撤回人（user_id）
  - 撤回时间（timestamp）
  - 撤回原因（comment）
  - 撤回类型（发起人撤回/审批人撤回）
- [ ] **补充撤回流程图**：
  - 发起人撤回流程：检查条件 → 填写原因 → 确认撤回 → 状态变更 → 通知审批人 → 记录历史
  - 审批人撤回流程：检查条件 → 填写原因 → 确认撤回 → 状态变更 → 通知发起人和其他审批人 → 记录历史
- [ ] **补充前端界面设计**：
  - 撤回按钮显示条件：发起人（状态为 `PENDING` 且提交时间在 24 小时内）、审批人（状态为 `APPROVED` 且审批通过时间在 30 分钟内）
  - 撤回确认弹窗：显示撤回原因输入框（必填）

### 4.3 审批委托 (Delegation)
**问题描述**：缺乏人员缺勤时的处理方案。
**整改动作**：
- [ ] **新增 6.7 审批委托章节**：
  - **委托类型**：
    - 临时委托：短期缺勤（如：请假、出差、会议等）
    - 长期委托：长期缺勤（如：病假、产假等）
    - 单次转交：将当前审批单转交给其他人处理
  - **委托权限**：
    - 被委托人必须具备与委托人相同或更高的审批权限
    - 系统自动校验权限，不符合则提示"被委托人权限不足"
    - 委托针对所有审批类型（不区分特定审批类型）
  - **委托方式**：
    - 设置委托（长期/临时）：委托人设置委托关系，指定被委托人、有效时间段，委托期间所有待审批单据自动转交给被委托人
    - 单次转交：委托人将当前审批单转交给其他人，仅针对当前审批单有效
  - **委托生效与失效**：
    - 委托设置后立即生效，委托期间所有待审批单据自动转交给被委托人
    - 到期后自动失效，委托人可以提前取消委托
    - 委托设置需要店长审批，店长审批通过后委托才生效
  - **委托通知**：
    - 委托设置成功后：通知被委托人
    - 委托期间收到审批单：通知被委托人（标注"委托审批"）
    - 委托取消后：通知被委托人
    - 委托到期后：通知委托人和被委托人
  - **定义委托表 (approval_delegations) 结构**：
    - delegation_id, delegator_id, delegator_name, delegatee_id, delegatee_name
    - start_time, end_time, status, approved_by, approved_at, created_at
  - **定义转交记录表 (approval_transfers) 结构**：
    - transfer_id, approval_id, from_user_id, from_user_name, to_user_id, to_user_name
    - reason, created_at
  - **审批记录标注**：
    - 委托审批：注明"由 XXX（委托人）委托给 YYY（被委托人）代审"
    - 转交审批：注明"由 XXX（转交人）转交给 YYY（被转交人）处理"
  - **补充前端界面设计**：
    - 委托设置页面：选择被委托人、设置有效时间段、填写委托原因
    - 单次转交页面：选择被转交人、填写转交原因
  - **补充委托流程图**：
    - 设置委托流程：设置委托 → 校验权限 → 提交审批 → 店长审批 → 委托生效 → 通知被委托人
    - 单次转交流程：选择被转交人 → 校验权限 → 确认转交 → 转交审批单 → 通知被转交人

### 4.4 移动端体验定义
**问题描述**：缺失移动端交互描述。
**整改动作**：
- [ ] **新增 7.6 移动端界面原型描述**（Phase 2 暂缓）：
  - **审批卡片**：关键信息摘要（金额、原因、发起人）。
  - **快捷操作**：列表页左滑通过/驳回。
  - **附件预览**：移动端图片/PDF 预览体验。
- [ ] **补充附件预览功能**（Phase 1）：
  - **支持的文件类型**：
    - 图片：JPG、PNG、GIF、WEBP
    - 文档：PDF、Word、Excel、PPT
    - 其他：TXT、CSV
  - **预览方式**：
    - 在线预览：直接在浏览器/小程序内预览，无需下载
    - 下载预览：下载到本地后预览
  - **预览功能**：
    - 缩放：支持放大/缩小
    - 旋转：支持旋转图片
    - 全屏：支持全屏查看
    - 分页：支持PDF多页浏览
  - **附件操作**：
    - 下载：支持下载附件到本地
    - 分享：支持分享附件（微信、邮件等）
    - 打印：支持打印附件（PDF、图片）

### 4.5 报表可视化规范
**问题描述**：报表描述过于抽象。
**整改动作**：
- [ ] **细化 13. 报表章节**：
  - **报表指标**：
    - 审批类型：按审批类型统计（如：付款审批、退款审批、坏账核销、叫停申请、特殊工费等）
    - 数量：审批单数量（通过/驳回/待审批/撤回）
    - 审批时长：平均审批时长、最长审批时长、最短审批时长
  - **图表类型推荐**：
    | 指标 | 推荐图表类型 | 说明 |
    |:---|:---|:---|
    | 审批类型 | 饼图（Pie Chart） | 显示各审批类型占比，直观了解审批分布 |
    | 数量 | 柱状图（Bar Chart） | 显示各状态数量对比（通过/驳回/待审批/撤回） |
    | 审批时长 | 趋势图（Trend Line） | 显示审批时长变化趋势，发现审批效率问题 |
    | 综合报表 | 表格（Table） | 详细数据展示，支持排序和筛选 |
  - **时间维度切换**：
    - 月：按月统计数据（如：2026年1月）
    - 年：按年统计数据（如：2026年）
    - 切换按钮：可以在月、年之间切换
    - 时间范围选择：支持自定义时间范围（如：2026-01-01 ~ 2026-01-31）
    - 快捷选择：支持快捷选择（如：最近7天、最近30天、本月、上月、本年、去年）
  - **钻取功能**：
    - 钻取层级：第一层（按时间维度汇总）→ 第二层（按审批类型分类）→ 第三层（按审批状态细分）→ 第四层（审批单列表）
    - 钻取操作：点击图表中的数据块，钻取到下一层级
    - 返回上一级：支持返回上一级
    - 跳转详情：支持跳转到审批单列表
  - **报表导出**：
    - 导出格式：Excel（.xlsx）、PDF（.pdf）
    - 导出内容：图表截图、数据表格、统计摘要、导出时间
    - 导出权限：仅老板、管理员、店长可以导出报表
  - **报表权限**：
    | 角色 | 可见报表 | 说明 |
    |:---|:---|:---|
    | 老板（ADMIN） | 全部报表 | 可以查看所有报表，包括所有门店的数据 |
    | 管理员（ADMIN） | 全部报表 | 可以查看所有报表，包括所有门店的数据 |
    | 店长（STORE_MANAGER） | 审批报表 | 仅限查看自己门店的审批报表 |
    | 财务（FINANCE） | 审批报表 | 仅限查看资金相关的审批报表 |
    | 采购（PURCHASING） | 审批报表 | 仅限查看供应链相关的审批报表 |
  - **补充报表页面设计**：
    - 报表概览页面：时间维度切换、审批类型分布（饼图）、审批数量统计（柱状图）、审批时长趋势（趋势图）

---

## 5. 执行计划清单 (Action Checklist)

- [ ] **第一步：基础修正**
  - [ ] 修正阈值不一致 (1.1)
  - [ ] 统一通知渠道枚举 (3.1)
  - [ ] 补充审批人角色枚举 (3.2)

- [ ] **第二步：场景补全**
  - [ ] 撰写付款审批章节 (2.1)
  - [ ] 撰写退款审批章节 (2.2)
  - [ ] 修正叫停恢复逻辑 (1.2)

- [ ] **第三步：机制完善**
  - [ ] 定义并行会签数据结构 (4.1)
  - [ ] 定义撤回规则 (4.2)
  - [ ] 定义委托机制 (4.3)

- [ ] **第四步：体验与报表**
  - [ ] 补充移动端界面描述 (4.4)
  - [ ] 细化报表可视化要求 (4.5)

<br/>

---
---

# 商品管理需求文档整改计划

> **目标文档**：`docs/02-requirements/modules/商品.md`
> **涉及模块**：商品管理 (Product Management)
> **优先级**：P1 (核心基础数据，需完善细节)

---

## 1. 业务逻辑一致性与澄清 (Logic Consistency)

### 1.1 套餐超出处理模式 (Overflow Handling)
**问题描述**：在 8.4和 20.5 节中，`PackageOverflowMode.FIXED` 的定义存在歧义。20.5 解释为 "超出部分不计费" (如同无限畅饮)，但 8.4 的命名 `FIXED` 通常暗示 "超出部分按固定单价计算"。
**整改动作**：
- [ ] **重定义枚举值**：
  | 枚举值 | 名称 | 说明 | 示例 |
  |:---|:---|:---|:---|
  | `FIXED_PRICE` | 固定单价 | 超出部分按设定的固定单价计算 | 套餐外每米 50 元 |
  | `IGNORE` | 不计费 | 超出部分不计费（封顶模式） | 超出部分免费 |
  | `ORIGINAL` | 原价 | 超出部分按原价计算 | 超出部分按商品原价计费 |
  | `DISCOUNT` | 折扣 | 超出部分按折扣计算 | 超出部分按8折计费 |
- [ ] **补充套餐超出场景定义**：
  - 窗帘套餐：超出固定长度（如：套餐包含3米，实际使用5米）
  - 套餐内商品：超出商品数量（如：套餐包含5件商品，实际购买6件）
  - 其他套餐：超出套餐规定的任何限制条件
- [ ] **补充配置级别**：
  - 配置位置：套餐级别配置
  - 每个套餐可以独立设置超出处理模式
  - 配置示例：package_id, package_name, package_limit, overflow_mode, overflow_price, overflow_discount
- [ ] **补充计算逻辑**：
  - FIXED_PRICE（固定单价）：超出数量 × 固定单价
  - IGNORE（不计费）：超出部分不计费
  - ORIGINAL（原价）：超出数量 × 商品原价
  - DISCOUNT（折扣）：超出数量 × 商品原价 × 折扣率
- [ ] **补充默认模式**：
  - 默认模式：`DISCOUNT`（折扣）
  - 如果没有特殊设置，默认使用折扣模式
  - 折扣率可以在套餐级别配置
- [ ] **更新 8.4 和 20.5 章节**，确保定义与计算逻辑一致。

### 1.2 单位换算逻辑 (Unit Conversion)
**问题描述**：面料库存（9.2）使用 `米/卷`，但销售可能按 `平米` 计价。缺失 "库存单位" 与 "销售单位" 的换算定义。
**整改动作**：
- [ ] **新增 4.7 单位换算章节**：
  - 定义 `stock_unit` (库存单位) 和 `sales_unit` (销售单位)。
  - 定义 `conversion_rate` (换算率)，如：1 卷 = 50 米，或 1 米 = 2.8 平米 (依赖幅宽)。
  - 明确库存扣减时均转换为库存单位计算。

---

## 2. 核心功能缺失补充 (Missing Features)

### 2.1 图片管理 (Image Management)
**问题描述**：商品模块严重缺失图片相关定义。商品表和属性中均未提及图片存储，导致前端无法展示商品缩略图。
**整改动作**：
- [ ] **更新 4.1 基础字段**：新增 `images` 字段 (JSONB array of URLs)，并定义首图为封面图。
- [ ] **更新 4.4 属性模板**：在属性中增加 `sketch_image` (示意图) 字段定义（如：窗帘款式图）。
- [ ] **更新 14.1 UI组件**：增加 `ProductImageUpload` 组件需求，支持多图拖拽排序。

### 2.2 SKU 生成规则
**问题描述**：未定义 SKU 是手动输入还是系统自动生成。
**整改动作**：
- [ ] **新增 4.8 SKU 生成规则章节**：
  - 规则示例：`{CategoryCode}-{YYYY}{Increment}` (e.g., CUR-2026001)。
  - 允许管理员手动修改自动生成的 SKU。
  - 唯一性校验逻辑描述。

### 2.3 价格变动记录 (Price History)
**问题描述**：价格是敏感数据，缺失变更审计。
**整改动作**：
- [ ] **新增 15.3 价格历史表 (product_price_history)**：
  - 记录 `product_id`, `field_name` (retail/channel/purchase), `old_value`, `new_value`, `changed_by`, `changed_at`。
- [ ] **新增 16.6 调价流程**：
  - 描述价格修改后的记录生成逻辑。

---

## 3. 技术规范与数据结构 (Technical Specs)

### 3.1 导入导出逻辑
**问题描述**：14.1 提及了 `product-import-dialog`，但未说明如何处理复杂的 JSONB 属性导入。
**整改动作**：
- [ ] **新增 16.7 批量导入/导出章节**：
  - **导入模板**：
    - 不同品类有不同的 Excel 模板
    - 根据品类字段自动生成模板
    - 模板包含：基础信息、价格、库存、属性等
    - 必填项：标注为红色或加粗（如：SKU、商品名称、品类）
    - 选填项：标注为灰色或普通字体
    - 示例数据：第一行为示例数据，方便用户理解
  - **属性解析**：
    - 使用 `attr:字段名` 格式（如：`attr:width`、`attr:color`）
    - 嵌套属性：使用 `attr:父字段:子字段` 格式（如：`attr:dimensions:width`）
    - 系统自动将 `attr:字段名` 映射到 JSONB 对象
  - **校验机制**：
    - 校验内容：必填字段、数据类型、枚举值、唯一性、格式校验
    - 校验失败处理：
      - 错误报告：生成错误报告 Excel，标注错误行和错误原因
      - 部分导入：跳过错误行，导入正确行（可选）
      - 全部回滚：如果有错误，全部回滚（可选）
      - 用户选择：让用户选择处理方式（跳过错误行/全部回滚）
  - **导出功能**：
    - 导出筛选：按品类、按状态、按时间范围、按关键字
    - 导出格式：Excel（.xlsx）
    - 导出内容：基础信息、价格、库存、属性
    - 导出字段：用户可以选择导出哪些字段
  - **导入导出权限**：
    | 角色 | 导入权限 | 导出权限 | 说明 |
    |:---|:---|:---|:---|
    | 老板（ADMIN） | ✅ 可以导入 | ✅ 可以导出 | 全部权限 |
    | 管理员（ADMIN） | ✅ 可以导入 | ✅ 可以导出 | 全部权限 |
    | 采购（PURCHASING） | ✅ 可以导入 | ❌ 不可导出 | 仅限导入 |
    | 店长（STORE_MANAGER） | ❌ 不可导入 | ❌ 不可导出 | 无权限 |
    | 销售 | ❌ 不可导入 | ❌ 不可导出 | 无权限 |
  - **补充导入导出流程**：
    - 导入流程：选择品类 → 下载模板 → 填写数据 → 上传文件 → 校验数据 → 导入成功/生成错误报告
    - 导出流程：选择筛选条件 → 选择导出字段 → 点击导出 → 下载文件

### 3.2 下架与上架
**问题描述**：15.1 提及 `deleted_at` (软删除)，但实际业务需要下架功能，而非软删除。
**整改动作**：
- [ ] **补充下架功能定义**：
  - 定义：数据库层面记录 `status` 字段为 `OFF_SHELF`，业务层面商品不能下单，但可以搜索、可以编辑、可以查看
  - 目的：暂时不销售，但保留商品信息，类似暂停销售
  - 使用场景：商品暂时缺货、商品需要调整价格、商品需要修改信息、商品需要重新上架
- [ ] **补充下架权限**：
  | 角色 | 下架权限 | 上架权限 | 说明 |
  |:---|:---|:---|:---|
  | 老板（ADMIN） | ✅ 可以下架 | ✅ 可以上架 | 全部权限 |
  | 管理员（ADMIN） | ✅ 可以下架 | ✅ 可以上架 | 全部权限 |
  | 采购（PURCHASING） | ✅ 可以下架 | ✅ 可以上架 | 供应链商品 |
  | 店长（STORE_MANAGER） | ✅ 可以下架 | ✅ 可以上架 | 门店商品 |
  | 销售 | ❌ 不可下架 | ❌ 不可上架 | 无权限 |
- [ ] **补充下架后处理**：
  - 搜索：可以搜索到下架商品，搜索结果中标注"已下架"状态
  - 查看：可以查看下架商品详情
  - 编辑：可以编辑下架商品信息
  - 下单：不能下单
  - 历史数据：已有的订单、报价单等历史数据不受影响
- [ ] **补充上架功能**：
  - 上架操作：点击"上架"按钮，商品状态变更为 `ACTIVE`（正常），可以正常下单
  - 上架权限：与下架权限相同
- [ ] **补充 SKU 重用规则**：
  - 下架后的 SKU 可以继续使用
  - 不需要重新生成 SKU
  - 商品状态变更不影响 SKU
- [ ] **补充下架上架流程**：
  - 下架流程：点击"下架"按钮 → 填写下架原因（选填）→ 确认下架 → 商品状态变更为 OFF_SHELF → 记录下架操作到商品历史
  - 上架流程：点击"上架"按钮 → 确认上架 → 商品状态变更为 ACTIVE → 记录上架操作到商品历史
- [ ] **补充商品状态枚举**：
  | 枚举值 | 名称 | 说明 |
  |:---|:---|:---|
  | `ACTIVE` | 正常 | 可以搜索、可以查看、可以编辑、可以下单 |
  | `OFF_SHELF` | 下架 | 可以搜索、可以查看、可以编辑、不能下单 |
- [ ] **补充前端界面设计**：
  - 商品列表页面：显示商品状态（正常/已下架），提供"下架"/"上架"操作按钮
  - 下架确认弹窗：显示下架原因输入框（选填），确认后执行下架操作

---

## 4. 执行计划清单 (Action Checklist)

- [ ] **第一步：逻辑修正**
  - [ ] 修正套餐超出处理模式枚举 (1.1)
  - [x] 补充单位换算逻辑 (1.2)

- [ ] **第二步：字段补全**
  - [x] 在 Products 表添加 `images` 字段 (2.1)
  - [x] 定义 SKU 生成规则 (2.2)
  - [x] 设计价格历史表结构 (2.3)

- [ ] **第三步：高级特性**
  - [ ] 撰写批量导入 Excel 映射逻辑 (3.1)
  - [ ] 完善归档与恢复流程 (3.2)

<br/>

---
---

# 客户与渠道模块需求整改计划

> **目标文档**：
> - `docs/02-requirements/modules/客户&渠道/客户.md`
> - `docs/02-requirements/modules/客户&渠道/渠道.md`
> **涉及模块**：客户档案 (CRM), 渠道管理 (PRM)
> **优先级**：P1 (核心业务闭环)

---

## 客户档案模块 (Customer)

### 1. 数据安全与隐私 (Privacy & Security)
**问题描述**：文档中未提及敏感信息（如手机号）的脱敏展示与查看权限控制。
**整改动作**：
- [ ] **新增 7.4 数据安全章节**：
  - **手机号脱敏**：默认展示 `138****1234`。
  - **查看权限**：仅 "归属销售" 和 "店长" 可点击查看完整号码，并记录操作日志 (Audit Log)。
  - **导出控制**：导出 Excel 时需二次密码确认或仅导出脱敏数据。

### 2. 合并逻辑细化 (Merge Logic)
**问题描述**：5.3 节提到客户合并，但后端逻辑描述不足，容易导致数据丢失。
**整改动作**：
- [ ] **完善 6.3 合并规则**：
  - **字段优先**：非空字段优先，若冲突则默认保留 "最新更新" 或 "主档案" 的值。
  - **关联数据迁移**：明确 Orders, Quotes, Leads, AfterSales 等所有子表外键需全部 update 指向新的 Customer ID。
  - **不可逆警告**：强调合并操作不可撤销（除非DBA介入）。

### 3. CRM 状态流转补充
**问题描述**：状态流转规则中未考虑 "退单/撤单" 对状态的影响。
**整改动作**：
- [ ] **更新 6.5 状态自动流转表格**：
  - 新增 **订单取消/全额退款** 事件：若无其他活跃订单，状态回退至 `SIGNED` 或 `OPPORTUNITY`（视是否有未付款订单定）。

---

## 渠道管理模块 (Channel)

### 1. 佣金回退机制 (Commission Clawback)
**问题描述**：6.2 佣金结算仅考虑了成交，未定义发生退款时的佣金处理。
**整改动作**：
- [ ] **新增 6.4 退单佣金处理**：
  - **全额退款**：已生成的待结算佣金标记为 "Void" (作废)。若已结算，则在下期结算单中生成 "负向扣减" 记录。
  - **部分退款**：按比例重新计算佣金，并在下期结算中进行差额调整。

### 2. 外部访问性澄清 (External Access)
**问题描述**：文档偏向内部管理，未明确渠道方（如设计师）是否可登录系统查看业绩。
**整改动作**：
- [ ] **新增 1.1 系统边界说明**：
  - 明确 Phase 1 阶段 **仅供内部使用**（销售/店长代录）。
  - 渠道方需通过 "微信通知" 或 "短信" 接收业绩通报，暂无独立后台账号。

### 3. 渠道与财务的交互
**问题描述**：提及了结算，但未定义与财务模块的具体单据交互。
**整改动作**：
- [ ] **完善 6.2 结算单据链路**：
  - 渠道佣金结算 -> 生成 `PaymentRequest` (付款申请单) -> 流转至财务模块审批 -> 出纳打款。
  - 需在财务模块中增加 `COMMISSION_PAYOUT` (佣金支付) 的款项类型。

---

## 执行计划清单 (Action Checklist)

- [ ] **第一步：客户模块增强**
  - [x] 定义手机号脱敏与查看日志 (Privacy)
  - [x] 细化客户合并的数据库级处理逻辑 (Merge)
  - [x] 补充退单导致的状态回退逻辑 (State)

- [ ] **第二步：渠道模块完善**
  - [x] 定义退单时的佣金回退/扣减规则 (Clawback)
  - [x] 明确 Phase 1 不提供渠道端 Portal (Scope)
  - [x] 定义佣金结算单到财务付款单的流转接口 (Finance Integration)

<br/>

---
---

# 线索模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/线索/线索.md`
> **涉及模块**：线索管理 (Leads)
> **优先级**：P1 (营销漏斗入口)

---

## 1. 数据接入与交互 (Integration)

### 1.1 批量导入机制
**问题描述**：文档未提及 Excel 批量导入线索的逻辑，这是上线初期的强需求。
**整改动作**：
- [ ] **新增 11. 数据导入章节**：
  - **查重策略**：导入时必须执行 "手机号" 查重。若重复，提供 "覆盖"、"跳过" 或 "生成新线索" 选项。
  - **错误处理**：导入失败的行应生成错误报告 Excel 供下载。
  - **渠道匹配**：支持通过 "渠道名称" 模糊匹配 `source_category` 和 `source_sub`。

### 1.2 外部线索捕获 API
**问题描述**：2.1 提及 "线上获客"，但未定义系统如何接收这些数据。
**整改动作**：
- [ ] **新增 12. 开放接口 (Webhook)**：
  - 定义 `POST /api/v1/leads/webhook` 接口标准。
  - 字段映射：定义外部字段 (如 `douyin_id`, `ad_source`) 如何映射到内部字段。
  - 签名验证：简单的 `Access-Token` 或签名校验机制。

---

## 2. 业务规则明确 (Business Rules)

### 2.1 分配规则 Scope 界定 (Phase 1)
**问题描述**：3.2 节列出的 "负载均衡"、"渠道指定"、"优秀奖励" 算法过于复杂，Phase 1 难以全部实现。
**整改动作**：
- [ ] **标记 Phase 1 范围**：
  - **分配策略**：
    - 手动分配：店长手动分配线索给销售
    - 简单轮转：默认按销售顺序分配
    - 负载均衡：可选，可以点选启用
  - **高级策略（Phase 2）**：负载均衡（自动）、渠道指定、优秀奖励
- [ ] **补充手动分配规则**：
  - 分配权限：店长可以手动分配线索
  - 分配流程：店长选择线索 → 选择销售 → 填写分配备注（选填）→ 确认分配 → 线索状态变更为"待跟踪" → 通知被分配的销售
  - 分配后处理：线索状态变更为"待跟踪"、通知被分配的销售（系统通知、微信小程序）、销售的待办列表中显示该线索
- [ ] **补充简单轮转规则**：
  - 默认规则：按销售顺序分配，循环分配，确保公平
  - 可选规则：负载均衡，可以点选启用，按销售当前线索数量分配，优先分配给线索数量少的销售
  - 轮转配置：系统设置中可以配置轮转规则，默认按销售顺序，可选负载均衡
- [ ] **补充分配限制**：
  - 暂时不限制：不限制销售的最大线索数量、不限制销售的最大未处理线索数量
  - 未来扩展（Phase 2）：可以设置销售的最大线索数量、可以设置销售的最大未处理线索数量
- [ ] **补充重新分配规则**：
  - 重新分配场景：销售离职、销售请假、销售调整岗位
  - 重新分配权限：店长可以重新分配线索
  - 重新分配流程：店长选择需要重新分配的线索 → 选择新的销售 → 填写重新分配原因（选填）→ 确认重新分配 → 线索状态变更为"待跟踪" → 通知原销售和新销售
  - 离职交接：一旦销售离职，店长必须将该销售的所有线索重新分配，系统提醒店长："销售 XXX 已离职，请重新分配其线索"，重新分配后，原销售无法查看这些线索
- [ ] **补充分配权限表**：
  | 角色 | 手动分配权限 | 重新分配权限 | 说明 |
  |:---|:---|:---|:---|
  | 店长（STORE_MANAGER） | ✅ 可以分配 | ✅ 可以重新分配 | 全部权限 |
  | 销售 | ❌ 不可分配 | ❌ 不可重新分配 | 无权限 |
- [ ] **补充线索状态流转**：
  - 分配后状态：`PENDING_DISPATCH`（待分配）→ `PENDING_FOLLOWUP`（待跟踪）
  - 重新分配后状态：`PENDING_FOLLOWUP`（待跟踪）→ `PENDING_FOLLOWUP`（待跟踪），重新分配不改变状态，只改变归属销售
- [ ] **补充前端界面设计**：
  - 线索列表页面：显示线索状态（待分配/待跟踪），提供"分配"/"重新分配"操作按钮
  - 分配弹窗：显示线索信息、选择销售、分配备注输入框（选填），确认后执行分配操作
  - 重新分配弹窗：显示线索信息、当前归属销售、选择新销售、重新分配原因输入框（选填），确认后执行重新分配操作

### 2.2 重复线索判定细节
**问题描述**：6.1 的 "活跃校验" 比较模糊，什么才算 "活跃"？
**整改动作**：
- [ ] **精确定义 "活跃线索"**：
  - 定义确认：状态 **不等于** `WON` (已成交) 且 **不等于** `VOID` (已作废)
  - 即：`PENDING_DISPATCH`, `PENDING_FOLLOWUP`, `FOLLOWING` 状态的线索均视为活跃
  - **线索状态枚举**：
    | 枚举值 | 名称 | 是否活跃 |
    |:---|:---|:---|
    | `PENDING_DISPATCH` | 待分配 | ✅ 活跃 |
    | `PENDING_FOLLOWUP` | 待跟踪 | ✅ 活跃 |
    | `FOLLOWING` | 跟进中 | ✅ 活跃 |
    | `WON` | 已成交 | ❌ 不活跃 |
    | `VOID` | 已作废 | ❌ 不活跃 |
- [ ] **补充重复线索检测规则**：
  - 检测规则：按手机号查重，若同一手机号存在活跃线索，视为重复线索
  - 检测时机：创建线索时、导入线索时、Webhook 接收线索时
- [ ] **补充重复线索处理流程**：
  - 检测到重复线索 → 显示重复线索信息 → 提供处理选项（合并线索/取消创建/强制创建）→ 用户选择处理方式 → 记录操作到线索历史
  - 建议合并处理：系统建议合并线索，最后交给人工判断
- [ ] **补充强制创建规则**：
  - 使用场景：同一客户的不同需求、同一客户的多个联系人、特殊业务场景
  - 权限要求：老板（ADMIN）、店长（STORE_MANAGER）可以使用 `force_create=true` 参数，其他角色不能使用
  - API 示例：POST /api/v1/leads，参数包含 `force_create: true`（仅老板/店长可以使用）
- [ ] **补充重复线索通知**：
  - 通知时机：检测到重复线索时
  - 通知对象：归属销售（如果存在活跃线索）
  - 通知内容："检测到重复线索：手机号 138****1234，已存在活跃线索 L-001"
  - 通知渠道：系统通知、微信小程序
- [ ] **补充合并线索流程**：
  - 合并权限：老板、店长可以合并线索
  - 合并流程：选择主线索（保留的线索）→ 选择从线索（合并的线索）→ 选择合并字段优先级（非空字段优先/最新更新优先/主线索优先）→ 填写合并原因（选填）→ 确认合并 → 从线索状态变更为 VOID（已作废）→ 主线索保留，从线索数据合并到主线索 → 记录合并操作到线索历史
- [ ] **补充前端界面设计**：
  - 重复线索提示弹窗：显示重复线索信息（线索ID、客户姓名、状态、归属销售），提供处理选项（合并线索/取消创建/强制创建）
  - 合并线索弹窗：选择主线索、选择从线索、选择合并字段优先级、合并原因输入框（选填），确认后执行合并操作

---

## 执行计划清单 (Action Checklist)

- [ ] **第一步：数据接入**
  - [x] 撰写 Excel 导入需求与查重逻辑 (Import)
  - [x] 定义通用线索接收 Webhook 接口 (API)

- [ ] **第二步：规则界定**
  - [ ] 明确 Phase 1 分配策略仅限手动和轮转 (Scope)
  - [ ] 精确定义活跃线索状态集合 (Logic)

<br/>

---
---

# 订单模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/订单/订单.md`
> **涉及模块**：订单管理 (Order Management)
> **优先级**：P1 (核心交易流程)

---

## 1. 业务一致性与数据完整性 (Data Integrity)

### 1.1 报价/客户数据快照 (Snapshot Logic)
**问题描述**：订单创建后，若引用的 `Quote` 或 `Customer` 数据发生变更（如客户改名、商品改价），历史订单数据会随之改变，破坏交易快照。
**整改动作**：
- [ ] **新增 4.4 订单快照字段**：
  - **快照内容**：报价（Quote）完整数据（含 Items）、客户（Customer）基础信息、商品信息、价格信息
  - **快照时机**：订单创建时
  - **更新规则**：订单创建后，快照不再更新，保持下单时刻的原始数据
  - **快照展示**：同时展示快照和最新数据（对比显示）
  - **存储方式**：订单表的 JSONB 字段
  - **归档规则**：不需要归档，快照数据永久保存在订单表中
- [ ] **补充快照数据结构**：
  - orders.snapshot_data (JSONB): 存储下单时刻的 Quote 完整数据（含 Items）、Customer 基础信息、商品信息、价格信息
  - 数据结构示例：quote（含 items）、customer、products、prices
- [ ] **补充快照展示规则**：
  - 优先级：订单详情页优先展示快照数据，同时展示最新数据作为参考
  - 数据来源：快照数据从 `orders.snapshot_data` 读取，最新数据通过 ID 关联查询最新数据
  - 对比显示：快照数据显示为灰色或标注"快照"，最新数据显示为正常颜色或标注"最新"，如果数据有变化，高亮显示差异
- [ ] **补充前端界面设计**：
  - 订单详情页面：显示快照数据（下单时刻）和最新数据（当前），对比显示，高亮标注差异
  - 布局：订单信息、客户信息（快照/最新）、商品信息（快照/最新）、价格信息（快照/最新）

### 1.2 "待客户确认" 状态增加 (Wait-for-Customer)
**问题描述**：状态流转图中 `PENDING_PO` (待下单) 后直接进入采购/生产流程。对于需要客户二次确认排版图或深化图的场景，缺乏挂起状态。
**整改动作**：
- [ ] **优化状态机**：
  - 在 `PENDING_PO` 和 `IN_PRODUCTION` 之间插入 `PENDING_CONFIRMATION` (待确认深化图)。
  - **动作**：设计师上传深化图 -> 客户/销售确认 -> 触发进入生产。

---

## 2. 流程完善 (Process Improvement)

### 2.1 外部系统交互 (External Integration)
**问题描述**：提及了物流单号，但未定义如何获取物流轨迹。
**整改动作**：
- [ ] **新增 9. 外接物流查询**：
  - 定义 `LogisticsService`：对接快递 100 或类似 API。
  - **展示**：在订单详情页展示物流时间轴。

### 2.2 变更单机制 (Change Order)
**问题描述**：只能撤单，不能修改。实际业务中常有 "加减商品" 或 "修改尺寸" 的需求。
**整改动作**：
- [ ] **新增 3.4 变更单 (Change Order) 流程**：
  - **Scope**：仅限 `PENDING_PO` 和 `PENDING_CONFIRMATION` 状态下允许变更。
  - **操作**：创建关联的 "变更报价单" -> 补差价/退差价 -> 审批 -> 更新原订单 Items。
  - **限制**：一旦进入生产 (`IN_PRODUCTION` / `FABRIC_PURCHASING`)，禁止变更，只能走 "局部退货+新开单"。

---

## 执行计划清单 (Action Checklist)

- [ ] **第一步：数据快照**
  - [ ] 定义订单快照 JSON 结构 (Snapshot)
  - [ ] 确保详情页数据源优先读取快照

- [ ] **第二步：流程增强**
  - [ ] 插入 "待确认深化图" 状态 (State)
  - [ ] 定义变更单流程与限制条件 (Change Order)
  - [ ] 集成物流轨迹查询 (Logistics)

<br/>

---
---

# 供应链模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/供应链.md`
> **涉及模块**：供应链 (Supply Chain)
> **优先级**：P2 (支撑核心交易)

---

## 1. 业务逻辑补充 (Logic Enhancement)

### 1.1 面料批次管理 (Batch Management)
**问题描述**：4.5.5 面料库存提及了 "自动生成批次号"，但缺乏批次追踪的完整链路。面料存在色差问题，不同批次的布料不能混用。
**整改动作**：
- [ ] **完善 4.5.2 面料库存表**：
  - 明确 **SKU + 批次号** 为唯一库存键 (Unique Key)。即同一 SKU 不同批次号在逻辑上视为不同库存行。
- [ ] **新增 4.5.7 批次优选规则**：
  - **FIFO (先进先出)**：默认逻辑。
  - **指定批次**：允许加工单明确指定使用某一批次（解决补单色差问题）。

### 1.2 安全库存与自动补货 (Auto-Replenishment)
**问题描述**：4.5.5 提及 "库存预警"，但未定义预警后的动作。
**整改动作**：
- [ ] **新增 4.6 补货建议**：
  - 定义补货触发点：`available_quantity` < `safety_stock`。
  - **动作**：系统自动生成 "待确认采购单" (Draft PO)，推送给采购员。
  - **计算数量**：`补货量 = 最大库存水位 - 当前可用库存`。

---

## 2. 数据结构完善 (Data Structure)

### 2.1 供应商资质管理
**问题描述**：供应商仅有基础信息，缺乏合同、营业执照等资质文件管理。
**整改动作**：
- [ ] **新增 2.3 供应商资质字段**：
  - `suppliers.documents` (JSONB): 存储合同 URL、营业执照 URL、到期日。
  - **提醒**：合同到期前 30 天提醒采购员续签。

### 2.2 多单位支持详情
**问题描述**：3.1 节简单提及了 `unit`，但在 4.5 中面料使用了 "米/卷"。需明确多单位转换在数据库层面的存储。
**整改动作**：
- [ ] **细化 3.1 单位字段**：
  - `main_unit`: 主计量单位 (如 "米")，库存以此为准。
  - `aux_unit`: 辅助单位 (如 "卷")。
  - `unit_relation`: 转换关系 (如 "1卷=50米", 固定的或浮动的)。

---

## 执行计划清单 (Action Checklist)

- [ ] **第一步：批次与单位**
  - [ ] 强化面料批次管理的逻辑 (Batch)
  - [ ] 完善多单位 / 辅助单位定义 (Unit)

- [ ] **第二步：补货与资质**
  - [ ] 定义自动补货建议逻辑 (Replenishment)
  - [ ] 增加供应商资质文件字段 (Compliance)

<br/>

---
---

# 报价单模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/报价单/报价单.md`
> **涉及模块**：报价中心 (Quote System)
> **优先级**：P1 (核心业务)

---

## 1. 版本管理与快照 (Versioning & Snapshots)

### 1.1 版本控制机制
**问题描述**：7.8.2 中提及了版本管理，但详细逻辑（如版本号规则、何时触发新版本）未定义。
**整改动作**：
- [ ] **新增 10. 版本管理策略**：
  - **触发条件**：每次 "发送给客户" 或 "审批通过" 之前的修改操作，或用户手动点击 "保存新版本"。
  - **版本号规则**：`V1`, `V2`, `V3`。
  - **状态隔离**：仅最新版本可被编辑。旧版本只读，用于历史回溯。
  - **关联性**：订单关联的是特定的 `quote_version_id` 而非动态的 `quote_id`。

### 1.2 快照持久化
**问题描述**：7.5.2 提及 "报价单转订单时，保存商品属性快照"，但具体实现未落地到数据库设计。
**整改动作**：
- [ ] **完善 7.3.3 快照存储结构**：
  - `quote_items.snapshot_data`: 存储下单时的 `product` 表完整镜像（含成本、材质、图片）。
  - **目的**：确保即便商品库删改，历史报价单内容不变。

---

## 2. 验证规则增强 (Validation Rules)

### 2.1 利润与折扣风控
**问题描述**：4.4 和 6.7 提及 "折扣" 和 "金额"，但缺乏对 **负毛利** 的拦截机制。销售可能误操作导致亏本报价。
**整改动作**：
- [ ] **新增 4.6 报价风控验证**：
  - **最低价校验**：`FinalPrice < FloorPrice` 时，强制弹窗警告，并标记为 "需特批"。
  - **负毛利拦截**：`FinalPrice < CostPrice` 时，禁止提交，除非有超级管理员权限。

### 2.2 尺寸合理性校验
**问题描述**：对 "测量宽度/高度" 仅定义了数字类型，缺乏业务合理性范围。
**整改动作**：
- [ ] **新增 4.3.1 尺寸校验规则**：
  - **高度限制**：若 `Height > 400cm`（一般层高极限），提示确认 "是否为复式/挑高"。
  - **宽度限制**：若 `Width > 1000cm`，提示确认 "是否需分段"。

---

## 3. 功能补充 (Feature Enhancement)

### 3.1 报价单有效期
**问题描述**：报价单未定义有效期，导致原材料涨价后，客户仍持旧报价单要求成交。
**整改动作**：
- [ ] **新增 3.3 报价单有效期**：
  - 默认有效期：7 天 / 15 天 / 30 天（租户可配）。
  - **过期处理**：状态变为 `EXPIRED`。客户确认时需刷新价格或重新审批。

### 3.2 打印与分享模板
**问题描述**：文档侧重于录入，忽略了 "输出" 环节。客户需要的是 PDF 或精美 H5。
**整改动作**：
- [ ] **新增 11. 输出与分享**：
  - **PDF 模板**：定义 "极简版" (仅总价)、"标准版" (含明细)、"详细版" (含工艺图解) 三种模板。
  - **隐藏成本**：打印时确保存储的成本字段、供应商信息绝对不可见。

---

## 执行计划清单 (Action Checklist)

- [ ] **第一步：版本与快照**
  - [ ] 定义 Quote Versioning 数据库模型与触发逻辑 (Versioning)
  - [ ] 落实 Item 级的 Product Snapshot 存储 (Snapshot)

- [ ] **第二步：风控与验证**
  - [ ] 实现最低价与负毛利阻断逻辑 (Risk Control)
  - [ ] 添加尺寸合理性 Warning (Validation)

- [ ] **第三步：输出体验**
  - [ ] 定义报价单有效期逻辑 (Expiration)
  - [ ] 设计打印/分享的 PDF 模板规范 (Export)

<br/>

---
---

# 安装单模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/安装单/安装单.md`
> **涉及模块**：安装交付 (Installation)
> **优先级**：P1 (服务交付闭环)

---

## 1. 业务流程与逻辑澄清 (Workflow Logic)

### 1.1 客户电子签名 (Digital Signature)
**问题描述**：文档提及"客户签名"用于验收，但数据库中未见字段，且缺乏小程序端的交互定义。
**整改动作**：
- [ ] **更新 4.1 主表字段**：新增 `customer_signature_url` (String) 和 `signed_at` (DateTime)。
- [ ] **新增 5.3.4 签名交互章节**：
  - 师傅在小程序展示"验收单预览"。
  - 客户使用手指/触控笔在屏幕签字。
  - 生成带水印的签名图片并上传。

### 1.2 调度冲突检测 (Conflict Detection)
**问题描述**：13.4 提到了客户预约时的空闲计算，但派单员手动指派时（5.2）未定义冲突检测机制。
**整改动作**：
- [ ] **新增 6.7 调度防撞规则**：
  - **强冲突**：同一时段（如 14:00-16:00）已存在 `PENDING_VISIT` 任务，禁止指派。
  - **软冲突**：前后任务地理位置相距超过 50km，且间隔时间 < 2小时，触发"赶场风险"警告。

### 1.3 返工与补装的单据定义 (Rework vs. Supplement)
**问题描述**："返工"和"补装"在文档中混用。3.1 提到"驳回返工"是状态回滚，但 2.2 又说"售后返工"是新单据。
**整改动作**：
- [ ] **明确术语定义 (Terminology)**：
  - **驳回返工 (Immediate Rework)**：现场验收不通过 -> 状态回退至 `PENDING_VISIT` -> 师傅当场或次日整改 -> 使用**同一张**安装单。
  - **售后返工 (After-Sales Rework)**：交付 N 天后发现问题 -> 创建**新**安装单 (Type=REWORK) -> 关联原单 -> 走独立结算流程。

---

## 2. 字段与功能增强 (Enhancements)

### 2.1 实时定位/签退 (Tracking)
**问题描述**：仅定义了"签到"，缺乏"签退"。无法计算实际工时，也无法在争议时证明离场时间。
**整改动作**：
- [ ] **新增字段**：`check_out_time` (DateTime) 和 `check_out_location` (Point)。
- [ ] **新增逻辑**：必须在"完工提交"前执行签退动作，或将签退动作与完工提交合并，自动捕获坐标。

---

## 执行计划清单 (Action Checklist)

- [ ] **第一步：签名与凭证**
  - [ ] 数据库增加电子签名 URL 字段 (Signature)
  - [ ] 定义小程序端画布签名组件 (UI)

- [ ] **第二步：调度逻辑**
  - [ ] 实现手动指派时的冲突检测算法 (Scheduling)
  - [ ] 区分"驳回返工"与"售后返工"的单据流转逻辑 (Rework)

<br/>

---
---

# 售后模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/售后.md`
> **涉及模块**：售后管理 (After Sales)
> **优先级**：P2 (客户体验保障)

---

## 1. 业务场景与交互 (Scenario & UI)

### 1.1 仲裁与定责视图 (Arbitration UI)
**问题描述**：文档提及"有异议"进入仲裁，但未定义仲裁界面的形态。管理者难以在海量信息中快速裁决。
**整改动作**：
- [ ] **新增 9.6 仲裁/定责工作台设计**：
  - **左右分屏**：左侧展示"客诉照片/描述"，右侧展示"责任方申诉/证据"。
  - **时间轴比对**：将量尺、安装、报修三个节点的时间轴并列，辅助判断是"原发性"还是"继发性"问题。
  - **一键裁决**：提供"维持原判"、"改判"、"各打五十大板(修改比例)"三个快捷按钮。

### 1.2 客户评价闭环 (Feedback Loop)
**问题描述**：提及"满意度"，但未定义客户如何评价。
**整改动作**：
- [ ] **新增 6.8 评价通知机制**：
  - **渠道**：售后关闭后，发送短信/微信模板消息。
  - **载体**：H5 极简页面（无需登录）。
  - **内容**：服务态度 (1-5)、解决速度 (1-5)、文字建议。

---

## 2. 财务风控 (Financial Safety)

### 2.1 扣款安全水位 (Deduction Safety)
**问题描述**：自动扣款逻辑（5.6）未考虑"扣款金额 > 待结算金额"的极端情况，可能导致负数结算单引发财务系统异常。
**整改动作**：
- [ ] **新增 5.6.3 扣款风控规则**：
  - 若 `Deduction > PendingPayment`：
    - 动作 1：扣光当前待结算金额，结算单金额置为 0。
    - 动作 2：剩余欠款生成一笔 `DEBT` (欠款) 类型的负向单据，记入该供应商/师傅的**欠款账本**，在未来结算中优先抵扣。

### 2.2 虚拟成本核算
**问题描述**：5.8.1 提及"公司责任"计入虚拟成本，但未说明其对财报的影响。
**整改动作**：
- [ ] **明确核算逻辑**：
  - "公司责任"的售后成本，不产生实际资金流出（不付给供应商），但在 **损益表 (P&L)** 中应记入 `Cost of Goods Sold (COGS) - After Sales Loss` 科目，从而真实降低"销售毛利"。

---

## 执行计划清单 (Action Checklist)

- [ ] **第一步：仲裁体验**
  - [ ] 设计定责仲裁工作台的 UI 布局 (UI)
  - [ ] 定义 H5 评价页面的数据接口 (Feedback)

- [ ] **第二步：财务风控**
  - [ ] 实现"欠款账本"逻辑，处理超额扣款 (Debt Management)
  - [ ] 明确公司责任成本的会计科目映射 (Accounting)

<br/>

---
---

# 财务模块需求整改计划

> **目标文档**：
> - `docs/02-requirements/modules/财务模块/财务基础.md`
> - `docs/02-requirements/modules/财务模块/收款单.md`
> - `docs/02-requirements/modules/财务模块/付款单.md`
> - `docs/02-requirements/modules/财务模块/对账单.md`
>
> **涉及模块**：财务 (Finance)
> **优先级**：P0 (核心资金流)

---

## 1. 基础架构整合 (Infrastructure & Master Data)

### 1.1 资金账户定义下沉
**问题描述**：`financial_accounts` (资金账户) 目前在 `付款单.md` 中定义，但 `收款单.md` 也强依赖此表。
**整改动作**：
- [ ] **移动定义**：将 4.1 账户类型、4.2 核心字段、4.3 账户流水表 从 `付款单.md` 移动至 `财务基础.md`。
- [ ] **新增账户类型**：增加 `VIRTUAL` (虚拟账户) 类型，用于处理平台代扣、积分抵扣等非实体资金流动。

### 1.2 资金调拨 (Internal Transfer)
**问题描述**：缺失内部账户互转（如：提现、充值、备用金划转）的业务定义。
**整改动作**：
- [ ] **新增章节**：在 `财务基础.md` 中增加 "资金调拨" 章节。
- [ ] **数据结构**：定义 `internal_transfers` 表 (source_account, target_account, amount, fee)。
- [ ] **流水处理**：明确一笔调拨生成两条流水（一进一出）。

---

## 2. 逆向流程补全 (Refunds & Returns)

### 2.1 客户退款 (Customer Refunds)
**问题描述**：`付款单.md` 和 `审批流程.md` 提及了退款，但未明确财务端的执行单据。
**整改动作**：
- [ ] **明确单据性质**：客户退款 = **付款单 (Payment Bill)** 的一种特殊类型 (`REFUND_TO_CUSTOMER`)。
- [ ] **关联红字单据**：退款必须关联 **红字AR对账单 (Credit Note)**，由订单取消/售后赔付生成。
- [ ] **流程补充**：在 `付款单.md` 中增加退款场景描述，强调 "原路退回" 规则和审批强校验。

### 2.2 供应商退款 (Supplier Refunds)
**问题描述**：供应商退货导致的资金回流未定义。
**整改动作**：
- [ ] **明确单据性质**：供应商退款 = **收款单 (Payment Order)** 的一种特殊类型 (`REFUND_FROM_SUPPLIER`)。
- [ ] **关联红字单据**：关联 **红字AP对账单 (Debit Note)**，由采购退货生成。
- [ ] **更新 `收款单.md`**：增加相关类型枚举和处理逻辑。

---

## 3. 对账逻辑分层 (Reconciliation Hierarchy)

### 3.1 明确 "日常核销" vs "期末对账"
**问题描述**：`对账单.md` (Reconciliation) 与 AR/AP 中的 `paid_amount` 更新逻辑似有重叠。
**整改动作**：
- [ ] **定义分层**：
  - **L1 业务核销 (Transaction Match)**：我们在 AR/AP 中做的 `PaymentItem` 关联，实时更新余额，**用于控制订单流程**（如：款到发货）。
  - **L2 账单确认 (Statement Confirmation)**：`对账单.md` 定义的功能，用于 **周期性（月结）** 与客户/供应商确认往来余额，生成 "对账单据" 供双方盖章。
- [ ] **重命名建议**：将 `对账单.md` 里的实体改名为 `StatementConfirmation` 或 `PeriodReconciliation` 以示区别。

---

## 4. 业务联动增强 (Cross-Module Linkage)

### 4.1 劳务结算联动
**问题描述**：`付款单.md` 中劳务结算依赖 "安装单完成"，但安装单侧未详细描述推送逻辑。
**整改动作**：
- [ ] **双向检查**：确保 `安装单.md` 的 "结算规则" 章节与 `付款单.md` 的 "劳务结算" 逻辑（基础费+加项费）字段完全对应。

### 4.2 佣金结算被动触发
**问题描述**：确保渠道佣金计算是 **被动触发** 的。
**整改动作**：
- [ ] **确认逻辑**：在 `收款单.md` 中再次确认：仅当 AR Statement `status = PAID` 时，才抛出事件触发佣金计算。

---

## 5. 执行计划清单 (Action Checklist)

- [ ] **第一步：基础重构**
  - [ ] 迁移资金账户定义至 `财务基础.md`
  - [ ] 定义资金调拨流程

- [ ] **第二步：逆向流程**
  - [ ] 定义客户退款（红字AR + 付款单）
  - [ ] 定义供应商退款（红字AP + 收款单）

- [ ] **第三步：对账澄清**
  - [ ] 重写 `对账单.md` 概述，明确其 "周期性账单确认" 的定位
  - [ ] 确保 AR/AP 自身的余额核销逻辑保持独立且实时

<br/>

---
---

# 数据报表需求整改计划

> **目标文档**：`docs/02-requirements/modules/数据报表.md`
> **涉及模块**：数据报表 (Analytics & Dashboard)
> **优先级**：P1 (管理决策支持)

---

## 1. 核心指标定义一致性 (Metric Consistency)

### 1.1 利润率计算 (Profit Margin)
**问题描述**：2.2 提及店长关注"利润率"，但未定义计算公式，且需与财务模块联动。
**整改动作**：
- [ ] **新增指标定义**：
  - `毛利 (Gross Profit)` = 销售额 - 采购成本 - 渠道佣金 - 虚拟成本(公司责任)。
  - `毛利率 (Gross Margin)` = 毛利 / 销售额。
- [ ] **联动说明**：明确引用财务模块的 `Virtual Cost` (虚拟成本) 和 `Commission` (佣金) 数据。

### 1.2 售后健康度 (After-Sales Health)
**问题描述**：缺乏售后相关的管理指标。
**整改动作**：
- [ ] **新增 4.9 售后监控组件**：
  - `退款率 (Refund Rate)` = 退款金额 / 销售总额。
  - `客诉率 (Complaint Rate)` = 售后工单数 / 成交订单数。
  - `责任分布` = 饼图展示 (供应商责任/测量责任/安装责任/公司责任/客户责任)。

---

## 2. 交互与体验增强 (UX Enhancements)

### 2.1 图表钻取 (Drill-down)
**问题描述**：仅提及 Alert Table 可点击，未定义图表的交互。
**整改动作**：
- [ ] **新增 3.3 交互定义**：
  - 点击柱状图/饼图扇区，应跳转至对应列表页（带筛选状态）。
  - 例：点击漏斗图的"成交"，跳转至订单列表，自动筛选 `status=COMPLETED` 且 `created_at` 在当前时间范围内。

### 2.2 移动端适配 (Mobile Experience)
**问题描述**：`react-grid-layout` 在移动端体验不佳，需定义降级策略。
**整改动作**：
- [ ] **新增 6.3 移动端布局**：
  - 强制单列流式布局 (Stack Layout)。
  - 隐藏"自定义布局"功能。
  - 简化图表：Trend Line 简化为 Sparkline (迷你图)，隐藏复杂坐标轴。

---

## 3. 执行计划清单 (Action Checklist)

- [ ] **第一步：指标口径**
  - [ ] 定义毛利率计算公式 (Finance Linkage)
  - [ ] 定义售后健康度指标 (After-Sales Linkage)

- [ ] **第二步：交互细化**
  - [ ] 定义图表钻取逻辑 (Drill-down)
  - [ ] 设计移动端降级布局 (Mobile Layout)

<br/>

---
---

# 通知模块需求整改计划

> **目标文档**：`docs/02-requirements/modules/通知.md`
> **涉及模块**：通知中心 (Notification Center)
> **优先级**：P2 (体验支撑)

---

## 1. 模板管理与变量映射 (Template Management)

### 1.1 模板配置化
**问题描述**：当前设计假设通知内容由业务代码直接拼接，无法适应短信/微信的严格模板审核机制。
**整改动作**：
- [ ] **新增 3.4 模板表 (notification_templates)**：
  - 字段：`code` (业务编码), `channel` (渠道), `external_template_id` (第三方ID), `content_pattern` (内容模板 `您的验证码是 {{code}}`).
- [ ] **重构发送接口**：业务方仅传递 `event_code` 和 `params` (变量)，由通知服务负责渲染。

### 1.2 变量映射标准化
**问题描述**：未定义业务变量如何映射到第三方模板参数（如微信的 `thing1`, `date3`）。
**整改动作**：
- [ ] **新增 Mapping 字段**：在模板表中增加 `param_mapping` (JSON)，定义 `{ "order_no": "thing1.value" }` 的映射关系。

---

### 1. 供应链与商品 (Supply Chain & Product)

- [x] **1.1 商品 (Product)** `docs/02-requirements/modules/商品.md`
    - [x] **Add `images` field** (JSONB array) to `products` table.
    - [x] **Add `sketch_image`** to attribute templates.
    - [x] **Add "Unit Conversion"** logic (e.g., Pieces -> Meters).
    - [x] **Add "SKU Generation Strategy"** chapter.
    - [x] **Add `product_price_history`** table for audit.
- [x] **1.2 供应链 (Supply Chain)** `docs/02-requirements/modules/供应链.md`
    - [x] **Add `batch_management`** (Lot Tracking) details.
    - [x] **Add `safety_stock`** and **`replenishment_point`**.
    - [x] **Supplier Qualification**: Add expiry reminders.

### 2. 销售与订单 (Sales & Order)

- [x] **2.1 订单 (Order)** `docs/02-requirements/modules/订单/订单.md`
    - [x] **Status Machine**: Clarify `PENDING_MEASUREMENT` vs `PENDING_QUOTE`.
    - [x] **Change Order**: Add detailed "Change Order Process" (CO).
    - [x] **Snapshot**: Ensure `order_items` stores snapshot data (`price`, `attrs`).
- [x] **2.2 报价单 (Quote)** `docs/02-requirements/modules/报价单/报价单.md`
    - [x] **Versioning**: Add `version` field and "Snapshot History".
    - [x] **Profit Margin**: Add "Low Profit Warning" logic.
- [x] **2.3 线索 (Lead)** `docs/02-requirements/modules/线索/线索.md`
    - [x] **Import**: Add "Excel Batch Import" rules (Deduplication).
    - [x] **API**: Add "External Lead Capture API" specs.

### 3. 财务与审批 (Finance & Approval)

- [x] **3.1 财务基础 (Finance Basic)** `docs/02-requirements/modules/财务模块/财务基础.md`
    - [x] **Internal Transfer**: Add `INTERNAL_TRANSFER` transaction type.
    - [x] **Reconciliation**: Move `INCOME`/`EXPENSE` definitions to Transaction.
- [x] **3.2 收款单 (Payment Order)** `docs/02-requirements/modules/财务模块/收款单.md`
    - [x] **Supplier Refund**: Add `SUPPLIER_REFUND` type.
    - [x] **Commission**: Add "Commission Settlement" linkage.
- [x] **3.3 付款单 (Payment Bill)** `docs/02-requirements/modules/财务模块/付款单.md`
    - [x] **Customer Refund**: Add `CUSTOMER_REFUND` type.
- [x] **3.4 对账单 (Statement)** `docs/02-requirements/modules/财务模块/对账单.md`
    - [x] **Hierarchy**: Define L1 (Business Write-off) vs L2 (Statement Confirmation).
- [x] **3.5 审批流程 (Approval)** `docs/02-requirements/modules/审批流程.md`
    - [x] **Bad Debt**: Fix threshold inconsistency (unified to single integer, default 90 days).

### 4. 交付与售后 (Delivery & After-sales)

- [x] **4.1 安装单 (Installation)** `docs/02-requirements/modules/安装单/安装单.md`
    - [x] **Signature**: Add `customer_signature` (Digital Signature).
    - [x] **Rework**: Define "Rework" vs "Supplement" clearly.
- [x] **4.2 售后 (After-sales)** `docs/02-requirements/modules/售后.md`
    - [x] **Liability**: Add "Arbitration" and "Liability Ratio".
    - [x] **Cost**: Add "Virtual Cost" for company-liable items.
- [x] **4.3 通知 (Notification)** `docs/02-requirements/modules/通知.md`
    - [x] **Templates**: Add `notification_templates` with variable mapping.
    - [x] **Queue**: Add `notification_queue` for async sending.

### 5. 客户与渠道 (Customer & Channel)

- [x] **5.1 客户 (Customer)** `docs/02-requirements/modules/客户&渠道/客户.md`
    - [x] **Privacy**: Add "Phone Number Anonymization" rules.
    - [x] **Merge**: Add "Customer Merge" logic (Field priority).
- [x] **5.2 渠道 (Channel)** `docs/02-requirements/modules/客户&渠道/渠道.md`
    - [x] **Commission Clawback**: Add rules for refunding commissions on order returns.
    - [x] **Access Control**: Phase 1 internal use only.

### 6. 通用 (General)

- [x] **6.1 全链路溯源 (Traceability)** `docs/02-requirements/modules/全链路溯源.md`
    - [x] **Batch**: Add `batch_no` to `product_items`.
- [x] **6.2 数据报表 (Analytics)** `docs/02-requirements/modules/数据报表.md`
    - [x] **Dashboard**: Add "Boss Dashboard" and "Sales Funnel".

---

## 2. 稳定性增强 (Reliability)

### 2.1 异步队列 (Async Queue)
**问题描述**：10.5 提到队列是 TODO，但对于外部 API 调用（飞书/短信），队列是必须的，否则会阻塞主线程且无法重试。
**整改动作**：
- [ ] **强制要求**：所有外部渠道发送 **必须** 走异步队列 (推荐 `Request Queue` 表 + 定时轮询 或者 Redis/BullMQ)。
- [ ] **重试策略**：定义 `max_retries` (默认3次) 和 `backoff` (指数退避)。

### 2.2 系统广播优化 (Broadcast)
**问题描述**：系统公告目前暗示给每个用户插入一条记录，数据量大时不可行。
**整改动作**：
- [ ] **新增 3.5 广播表 (system_announcements)**：存储全局消息。
- [ ] **读状态逻辑**：用户仅存储 `last_read_announcement_id` 或在 `notification_reads` 表中记录已读的广播ID，拉取时混合查询。

---

## 3. 执行计划清单 (Action Checklist)

- [ ] **第一步：模板引擎**
  - [ ] 设计模板表结构与变量替换逻辑 (Templates)
  - [ ] 制定微信/短信参数映射规则 (Mapping)

- [ ] **第二步：基础设施**
  - [ ] 实现基于数据库的简单消息队列 (Queue)
  - [ ] 优化全员广播存储逻辑 (Broadcast)

<br/>

---
---

# 系统设置需求整改计划

> **目标文档**：`docs/02-requirements/modules/系统设置.md`
> **涉及模块**：系统设置 (System Settings)
> **优先级**：P1 (业务基础配置)

---

## 1. 业务规则配置化 (Business Rule Configuration)

### 1.1 劳务工费定价 (Labor Pricing)
**问题描述**：安装单和财务模块计算工费时，依赖"基础费"、"高空费"等标准，但系统设置中缺失相关定价表的配置界面。
**整改动作**：
- [x] **新增 2.9 工费定价设置**：
  - **基础工价表 (labor_prices)**：`task_type` (测量/安装), `unit_price`, `unit` (米/个/平米).
  - **特殊费用规则**：`high_altitude_fee` (高空作业费起始高度及金额), `remote_fee` (远程费起始公里数及单价).

### 1.2 财务基础配置
**问题描述**：报价系统和财务模块涉及税率、币种等计算，目前散落在各处硬编码或未定义。
**整改动作**：
- [x] **新增 2.10 财务通用设置**：
  - `default_tax_rate` (默认税率，如 0.00).
  - `tax_mode` (默认计税模式：价内税/价外税).
  - `currency_symbol` (货币符号，默认 ¥).

---

## 2. 功能开关标准化 (Feature Flags)

### 2.1 租户功能控制
**问题描述**：功能开关散落在各模块配置中（如 `ENABLE_SMS`），不利于套餐分级管理（如标准版 vs 专业版）。
**整改动作**：
- [x] **新增 2.11 租户权益配置**：
  - 定义 `tenant_features` JSON 结构，统一管理所有 `ENABLE_` 开头的特性开关。
  - 界面上支持只读展示权益（由运营后台控制），或部分可配置项（由租户管理员控制）。

---

## 3. 执行计划清单 (Action Checklist)

- [x] **第一步：定价引擎**
  - [x] 设计工费定价的数据结构与配置界面 (Pricing)
  - [x] 确保安装单模块在计算时调用此配置接口

- [x] **第二步：统一开关**
  - [x] 聚合所有 Feature Flags (Licensing)

<br/>

---
---

# 全链路溯源需求整改计划

> **目标文档**：`docs/02-requirements/modules/全链路溯源.md`
> **涉及模块**：全链路溯源 (Traceability)
> **优先级**：P2 (质量闭环，依赖供应链改造)

---

## 1. 深度集成 (Deep Integration)

### 1.1 面料缸号/批次追踪 (Fabric Batch)
**问题描述**：2.2.4 明确注明"无批次追溯字段"，但 1.3 核心场景又包含"批次质量问题"。供应链模块已计划增加缸号管理，此处需同步。
**整改动作**：
- [x] **新增 2.2.4 批次字段**：
  - 在 `po_items` (采购明细) 或 `inventory_records` (库存记录) 中关联 `batch_no` (缸号) / `roll_no` (卷号)。
- [x] **更新查询逻辑**：
  - 更新 3.2.2 SQL：增加 `GROUP BY batch_no` 的统计维度，识别特定缸号的次品率。

### 1.2 风险控制闭环 (Risk Feedback Loop)
**问题描述**：6.3 提到 "中风险 -> 暂停新订单"，但缺乏系统自动执行机制。
**整改动作**：
- [x] **新增 3.4 熔断机制 (Circuit Breaker)**：
  - 规则：当特定 `supplier_id` 或 `batch_no` 的预警级别达到 `HIGH`。
  - 动作：调用供应链/商品 API，自动将对应供应商/SKU 状态置为 `SUSPENDED` (暂停采购/销售)。
  - 通知：发送 `URGENT` 级别通知给采购主管。

---

## 2. 数据标准化 (Data Standardization)

### 2.1 证据链 Schema 定义
**问题描述**：4.2 看板展示了证据链，但 2.2.2 中仅定义为 JSONB，缺乏结构约束，前端难以渲染。
**整改动作**：
- [x] **新增 2.3 证据链结构定义**：
  ```typescript
  interface EvidenceChain {
    measure_report?: { url: string; date: string; };
    production_sheet?: { url: string; batch: string; };
    install_photos_before?: string[];
    install_photos_after?: string[];
    issue_photos: string[];
  }
  ```

---

## 3. 执行计划清单 (Action Checklist)

- [x] **第一步：关联增强**
  - [x] 引入供应链模块的 `batch_no` 字段 (Dependency)
  - [x] 定义证据链 JSON Schema

- [x] **第二步：自动控制**
  - [x] 实现高风险自动熔断逻辑 (Logic)

<br/>

---
---

# 测量模块需求整改计划

> **目标文档**: `docs/02-requirements/modules/测量/测量单.md`
> **分析报告**: `docs/02-requirements/modules/测量/测量模块差异分析报告_20260116.md`
> **详细计划**: `docs/02-requirements/modules/测量/测量模块整改计划_20260116.md`
> **涉及模块**: 测量管理 (Measurement)
> **优先级**: P0 (核心业务流程入口)
> **当前完成度**: 40-45%
> **目标完成度**: 85%+

---

## 1. 数据库Schema修正 (Database Schema)

### 1.1 版本管理字段缺失
**问题描述**: 需求文档中定义的 Round + Variant 双层版本体系，在 `measure_tasks` 表中缺少关键字段。
**整改动作**:
- [ ] **新增字段**:
  - `version_display` (VARCHAR): 版本展示号，如 V1.A, V2.B
  - `parent_id` (UUID): 关联上一版本ID，用于版本追溯
- [ ] **更新业务逻辑**: 完善 `createNewMeasureVersion` 函数，自动生成版本号

### 1.2 API文档与Schema枚举不一致
**问题描述**: API文档使用了 `PENDING_REVIEW` 和 `REJECTED` 状态，但 `enums.ts` 未定义。
**整改动作**:
- [ ] **修正API文档**: 将 `PENDING_REVIEW` 统一改为 `PENDING_CONFIRM`
- [ ] **删除REJECTED状态**: 使用 `rejectCount > 0` 判断驳回状态

---

## 2. 核心业务逻辑补齐 (P0 - Critical)

### 2.1 拆单机制 (2天)
**问题描述**: 完全缺失按品类拆分测量任务的功能，影响多品类业务。
**整改动作**:
- [ ] **数据库**: 创建 `measure_task_splits` 表
- [ ] **业务逻辑**:
  - [ ] 实现 `analyzeSplitRequirement(quoteId)` - 品类分析
  - [ ] 实现 `recommendWorkers(category)` - 师傅推荐
  - [ ] 实现 `splitMeasureTask(quoteId, splitPlan)` - 执行拆单
  - [ ] 添加拆单唯一性校验
- [ ] **UI组件**: 创建 `SplitTaskDialog.tsx`

### 2.2 费用准入机制 (1.5天)
**问题描述**: 定金检查、审批豁免功能完全缺失，可能导致免费测量滥用。
**整改动作**:
- [ ] **业务逻辑**:
  - [ ] 实现 `checkEarnestMoney(leadId)` - 定金查询
  - [ ] 实现 `applyFeeWaiver(taskId, reason)` - 申请豁免
- [ ] **API Actions**:
  - [ ] 新增 `checkMeasureFeeStatus(taskId)`
  - [ ] 新增 `requestFeeWaiver(taskId, reason)`
- [ ] **UI组件**: 创建 `FeeWaiverDialog.tsx`

### 2.3 现场考核增强 (1天)
**问题描述**: 签到仅保存GPS，未实现距离校验、迟到判定。
**整改动作**:
- [ ] **GPS距离校验**:
  - [ ] 实现 Haversine 公式计算距离
  - [ ] 距离 > 500m 显示警告但允许签到
- [ ] **迟到判定**:
  - [ ] 比较 `checkInAt` 和 `scheduledAt`
  - [ ] 添加 `isLate` 和 `lateMinutes` 字段
- [ ] **UI反馈**: 签到时显示距离和迟到信息

### 2.4 驳回预警机制 (0.5天)
**问题描述**: 累计驳回3次预警逻辑缺失。
**整改动作**:
- [ ] 在 `reviewMeasureTask` 中添加驳回次数检查
- [ ] **驳回≥3次**: 自动通知店长
- [ ] **UI展示**: 任务详情页显示驳回次数徽章

---

## 3. UI/UX完善 (P1 - High Priority)

### 3.1 分页与筛选 (1天)
**整改动作**:
- [ ] **分页组件**: 替换 `{/* Pagination TODO */}` 注释
- [ ] **日期筛选**: 在 `MeasurementFilterBar` 添加日期范围选择
- [ ] **高级筛选**: 添加测量师、销售人员筛选

### 3.2 版本管理UI (1.5天)
**整改动作**:
- [ ] **创建组件**: `VersionSwitcher.tsx`
- [ ] **显示当前版本**: 如 V1.A
- [ ] **版本切换**: 列出所有历史版本
- [ ] **新建功能**: "创建方案B"、"发起复测" 按钮

### 3.3 操作日志 (1天)
**整改动作**:
- [ ] **查询审计日志**: 从 `audit_logs` 表获取历史
- [ ] **创建组件**: `OperationTimeline.tsx`
- [ ] **时间轴展示**: 驳回记录标红显示

### 3.4 转报价功能 (0.5天)
**整改动作**:
- [ ] 列表页添加"转报价"按钮 (仅COMPLETED状态)
- [ ] 跳转至报价创建页并自动带入测量数据

---

## 4. 小程序端开发 (P0 - Critical)

### 4.1 任务列表页 (1.5天)
**整改动作**:
- [ ] 创建 `src/app/(mobile)/measure/page.tsx`
- [ ] 卡片式布局展示任务
- [ ] 实现筛选Tab (待接单/待上门/已完成)
- [ ] 一键导航功能 (调用微信 `openLocation`)

### 4.2 测量数据录入 (2天)
**整改动作**:
- [ ] 创建 `[id]/submit/page.tsx`
- [ ] 大按钮设计 (高度 56px)
- [ ] 步骤式录入表单
- [ ] **实时保存草稿** (localStorage)
- [ ] **照片上传**:
  - [ ] 调用微信 `chooseImage`
  - [ ] 前端压缩至 500KB
  - [ ] 上传到OSS

### 4.3 签到打卡增强 (0.5天)
**整改动作**:
- [ ] 完善 `gps-check-in.tsx`
- [ ] 显示距离客户地址距离
- [ ] 超范围黄色警告

### 4.4 离线能力 (2天)
**整改动作**:
- [ ] **离线缓存**: 使用 IndexedDB 存储任务
- [ ] **离线录入**: 数据暂存队列
- [ ] **网络恢复同步**:
  - [ ] 监听 `onNetworkStatusChange`
  - [ ] 自动上传队列
  - [ ] 显示同步进度
- [ ] **冲突处理**: 弹窗提示用户选择

---

## 5. 缺失API补充

### 5.1 高优先级API (P0)
- [ ] `POST /tasks/{id}/cancel` - 取消测量任务
- [ ] `POST /tasks/{id}/fee-waiver` - 费用豁免申请
- [ ] `GET /tasks/{id}/fee-status` - 费用状态查询
- [ ] `POST /tasks/{id}/remeasure` - 创建复测任务

---

## 6. 执行计划清单 (4周时间表)

### **第一周 (Day 1-7)**: 核心业务逻辑 → 目标完成度 55%
- [ ] 拆单机制实现
- [ ] 费用准入功能
- [ ] 现场考核增强
- [ ] 驳回预警机制

### **第二周 (Day 8-14)**: UI/UX完善 → 目标完成度 70%
- [ ] 分页与筛选增强
- [ ] 版本管理UI
- [ ] 操作日志展示
- [ ] 状态进度条
- [ ] 转报价功能

### **第三周 (Day 15-21)**: 小程序端开发 → 目标完成度 85%
- [ ] 小程序任务列表
- [ ] 测量数据录入表单
- [ ] 签到打卡增强
- [ ] 离线能力基础版

### **第四周 (Day 22-28)**: 集成测试 → 目标完成度 90%+
- [ ] E2E测试 (完整流程、拆单、驳回、离线)
- [ ] 性能优化
- [ ] 文档与培训

---

## 7. 资源需求

| 角色 | 人数 | 时间投入 | 主要职责 |
|:---|:---:|:---|:---|
| **后端工程师** | 1人 | 全职4周 | 业务逻辑、API、数据库 |
| **前端工程师** | 1人 | 全职4周 | Web端UI/UX |
| **小程序工程师** | 1人 | 2周 (第3-4周) | 小程序开发、离线能力 |
| **测试工程师** | 1人 | 1周 (第4周) | E2E测试、Bug修复 |

**总人天估算**: 约 **80人天**

---

## 8. 风险提示

1. **🔴 严重**: 拆单逻辑与实际业务不符 - 第一周完成后立即与业务方验证
2. **🔴 严重**: 小程序端缺失导致测量师无法实际使用
3. **🟡 高**: 离线同步冲突处理 - 需实现版本号机制
4. **🟡 高**: GPS定位不准确 - 允许500m误差，记录但不阻塞

---

## 9. 参考文档

- [测量模块差异分析报告](./02-requirements/modules/测量/测量模块差异分析报告_20260116.md)
- [测量模块整改计划详细版](./02-requirements/modules/测量/测量模块整改计划_20260116.md)
- [测量模块整改任务清单](./02-requirements/modules/测量/测量模块整改任务清单_20260116.md)

---

<br/>

---
---

# 报价模块需求整改计划

> **目标文档**: `docs/02-requirements/modules/报价单/报价单.md` (911行, 36.5KB)
> **审计报告**: `docs/02-requirements/modules/报价单/quote-module-audit-20260116.md`
> **涉及模块**: 智能报价与订单闭环系统 (Quote & Calculation Engine)
> **优先级**: P0 (核心交易转化入口)
> **当前完成度**: 30-40%
> **目标完成度**: 85%+
> **复杂度**: ⭐⭐⭐⭐⭐ (系统最复杂模块)

---

## 1. 数据库Schema修正与增强 (Database Schema)

### 1.1 版本管理约束 (P0 - 阻塞Bug)
**问题描述**: 需求要求"同一时间只能有一个 ACTIVE 版本"，但数据库层无唯一约束，可能导致数据不一致。

**整改动作**:
- [ ] **添加部分唯一索引**:
  ```sql
  CREATE UNIQUE INDEX idx_quotes_active_version 
  ON quotes (quote_no, is_active) 
  WHERE is_active = true;
  ```
- [ ] **业务层事务保证**:
  - [ ] 修改 `setActiveVersion` 函数，使用数据库事务
  - [ ] 同一事务内：先降级旧版本，再激活新版本
  
**验证**: 尝试同时激活两个版本，应抛出唯一性错误

---

### 1.2 JSONB 字段结构标准化 (P1)
**问题描述**: `quote_items.attributes` 和 `calculationParams` 无 TypeScript 类型定义，导致类型不安全。

**整改动作**:
- [ ] **定义 TypeScript 接口**:
  ```typescript
  // src/features/quotes/types/quote-item-attributes.ts
  interface CurtainAttributes {
    openingStyle: 'DOUBLE' | 'LEFT' | 'RIGHT' | 'MULTI';
    installPosition: 'CURTAIN_BOX' | 'INSIDE' | 'OUTSIDE';
    groundClearance: number; // cm
    foldRatio: number;
    fabricWidth: number; // cm
    material: string;
    weight?: number; // g/㎡
    patternRepeat?: number; // cm
  }
  
  interface WallpaperAttributes {
    fabricWidth: number; // 幅宽 (定宽值)
    rollLength: number; // 卷长
    patternRepeat: number; // 花距
    patternMatch: 'STRAIGHT' | 'OFFSET';
  }
  
  interface CalculationParams {
    formulaType: 'FIXED_HEIGHT' | 'FIXED_WIDTH' | 'WALLPAPER' | 'WALLCLOTH';
    sideLoss: number;
    headerLoss: number;
    bottomLoss: number;
    strips?: number; // 墙纸条数
    rollStrips?: number; // 每卷条数
    // ... 其他计算参数
  }
  ```
- [ ] **Schema 验证**: 使用 Zod 在 Server Action 中验证 JSONB 结构

---

### 1.3 快照表设计 (P0 - 关键)
**问题描述**: 转单时需"深度克隆 JSONB 数据"，但无快照存储机制，订单可能受商品库变更影响。

**整改动作**:
- [ ] **方案选择评估**:
  - **方案 A**: 在 `orders` 表中冗余 `quote_snapshot` JSONB 字段
  - **方案 B**: 创建 `quote_snapshots` 表
  - **推荐**: 方案 A (简化查询，数据内聚)
  
- [ ] **实现快照逻辑**:
  ```typescript
  async function convertQuoteToOrder(quoteId: string) {
    const quote = await db.query.quotes.findFirst({
      where: eq(quotes.id, quoteId),
      with: {
        items: true,
        rooms: true,
      }
    });
    
    // 深度克隆，包含商品图片URL、计算参数等
    const snapshot = JSON.parse(JSON.stringify(quote));
    
    await db.insert(orders).values({
      quoteSnapshot: snapshot, // 存储完整报价快照
      totalAmount: quote.finalAmount,
      // ... 其他字段
    });
  }
  ```

---

## 2. 核心业务逻辑补齐 (P0 - Critical)

### 2.1 报价模式配置系统 (3天)
**问题描述**: "快速模式 vs 高级模式" 完全未实现，用户无法自定义报价表单。

**整改动作**:

#### 2.1.1 数据结构设计
- [ ] **租户级配置** (`tenants.settings.quoteModeConfig`):
  ```json
  {
    "defaultMode": "SIMPLE",
    "simpleModeFields": [
      "roomType", "productSku", "imageUrl", 
      "width", "height", "openingStyle",
      "quantity", "unitPrice", "amount"
    ],
    "defaultValues": {
      "installPosition": "CURTAIN_BOX",
      "groundClearance": 2,
      "foldRatio": 2.0
    }
  }
  ```

#### 2.1.2 配置管理 API
- [ ] `GET /api/quote-config` - 获取当前用户的配置 (三级优先级)
- [ ] `PUT /api/tenant/quote-config` - 租户管理员配置
- [ ] `PUT /api/user/quote-config` - 用户个人配置

#### 2.1.3 前端动态表单
- [ ] **创建组件**: `DynamicQuoteForm.tsx`
- [ ] **模式切换**: 右上角 "高级报价 ▼" 按钮
- [ ] **字段显示/隐藏**: 基于配置动态渲染
- [ ] **数据保留**: 切换模式时保留已录入数据

---

### 2.2 计算引擎完整性审查与修复 (4天)

**问题描述**: 计算引擎是报价模块的核心，但完整性存疑，需逐一验证。

#### 2.2.1 窗帘计算引擎
- [ ] **审查现有代码**: `src/features/quotes/calc-strategies/curtain-*.ts`
- [ ] **验证公式**:
  - [ ] 成品高度: `H_f = 测量高度 + 轨道调节 - 离地高度`
  - [ ] 成品宽度: `W_f = 测量宽度 + 修正宽度`
  - [ ] 面料裁剪高度: `H_c = H_f + 帘头损耗 + 底边损耗`
  - [ ] 面料裁剪宽度: `W_c = W_f × 褶皱倍数 + (片数 × 2 × 侧边损耗)`
- [ ] **定高/定宽分支**:
  - [ ] 定高面料: `Q = W_c / 100` (米)
  - [ ] 定宽面料: `Q = ⌈W_c / 幅宽⌉ × H_c / 100`
- [ ] **超高预警**: `H_f > 275cm` 触发警告
- [ ] **单元测试**: 覆盖所有计算场景

#### 2.2.2 墙纸计算引擎
- [ ] **实现/审查代码**: `src/features/quotes/calc-strategies/wallpaper.ts`
- [ ] **验证公式**:
  - [ ] 条数: `⌈(宽度 + 宽度损耗) / 墙纸宽度⌉`
  - [ ] 单条高度 (无对花): `测量高度 + 裁剪损耗`
  - [ ] 对花高度: `⌈H_base / 花距⌉ × 花距`
  - [ ] 每卷条数: `⌊卷长 / 单条高度⌋`
  - [ ] 总卷数: `⌈总条数 / 每卷条数⌉`
- [ ] **多墙段聚合**: 支持同一空间多面墙
- [ ] **单元测试**: 包含对花/无对花场景

#### 2.2.3 墙布计算引擎
- [ ] **实现/审查代码**: `src/features/quotes/calc-strategies/wallcloth.ts`
- [ ] **验证公式**:
  - [ ] 用料宽度: `测量宽度 + 宽度损耗`
  - [ ] 墙布高度: `幅宽 + 上下损耗`
  - [ ] 面积: `总宽度 × 墙布高度 / 10000` (平方米)
- [ ] **高度约束**: `测量高度 > 幅宽` 触发超高预警
- [ ] **单元测试**

#### 2.2.4 嵌套附件联动计算
- [ ] **本布绑带**: 固定数量 `0.15m`，推荐数量逻辑 (单开1个, 对开2个)
- [ ] **抱枕**: 单价锁定主行价格，尺寸默认 `45×45`
- [ ] **胶水/基膜**: 按面积自动计算用量
- [ ] **行内小计**: `主行金额 + Σ附件金额`

---

### 2.3 版本管理业务逻辑 (2天)
**问题描述**: 版本切换、自动降级逻辑可能不完整。

**整改动作**:
- [ ] **审查 `version-actions.ts`**
- [ ] **实现完整状态机**:
  ```typescript
  async function setActiveVersion(quoteId: string, versionId: string) {
    return await db.transaction(async (tx) => {
      // 1. 查询当前ACTIVE版本
      const currentActive = await tx.query.quotes.findFirst({
        where: and(
          eq(quotes.quoteNo, quoteNo),
          eq(quotes.isActive, true)
        )
      });
      
      // 2. 降级旧版本
      if (currentActive && currentActive.id !== versionId) {
        await tx.update(quotes)
          .set({ isActive: false, status: 'DRAFT' })
          .where(eq(quotes.id, currentActive.id));
      }
      
      // 3. 激活新版本
      await tx.update(quotes)
        .set({ isActive: true })
        .where(eq(quotes.id, versionId));
    });
  }
  ```
- [ ] **克隆版本功能**: 深度复制当前版本的所有 items 和 rooms
- [ ] **防护逻辑**: ACTIVE 版本禁止编辑

---

### 2.4 订单流转与拆单路由 (2天)
**问题描述**: "基于 `category_tag` 自动分流" 逻辑缺失。

**整改动作**:
- [ ] **实现分流逻辑**:
  ```typescript
  async function convertToOrder(quoteId: string) {
    const quote = await db.query.quotes.findFirst({
      where: eq(quotes.id, quoteId),
      with: { items: true }
    });
    
    const itemsByCategory = groupBy(quote.items, 'category');
    
    // 窗帘/墙布主材 -> 供应商采购单
    const fabricItems = itemsByCategory['CURTAIN_FABRIC'] || [];
    if (fabricItems.length > 0) {
      await createPurchaseOrder({
        type: 'FABRIC',
        items: fabricItems,
        // ...
      });
    }
    
    // 绑带/抱枕 -> 内部工单
    const accessoryItems = itemsByCategory['CURTAIN_ACCESSORY'] || [];
    if (accessoryItems.length > 0) {
      await createWorkOrder({
        type: 'SEWING',
        items: accessoryItems,
        // ...
      });
    }
    
    // 胶水/基膜 -> 供应商采购单
    const consumableItems = itemsByCategory['WALLPAPER_CONSUMABLE'] || [];
    // ...
  }
  ```
- [ ] **快照存储**: 转单时保存完整 quote 快照到 `orders.quote_snapshot`

---

## 3. TypeScript 类型错误修复 (P0 - 立即处理)

**问题清单**:
```
src/features/quotes/components/curtain-fabric-quote-dialog.tsx
src/features/quotes/components/version-compare.tsx
src/features/quotes/components/quote-summary-panel.tsx
```

**整改动作**:
- [ ] **运行类型检查**: `pnpm type-check > quote-type-errors.log`
- [ ] **逐个修复**: 
  - [ ] 移除所有 `any` 类型
  - [ ] 补充缺失的接口定义
  - [ ] 修正 props 传递错误
- [ ] **验证**: 类型检查 0 错误

---

## 4. UI/UX 组件审查与完善 (P1)

### 4.1 智能联想 (Autocomplete) 优化 (1天)
**需求**: "输入即检索商品库，选中后自动填充字段 3-7 及 15"

**整改动作**:
- [ ] **性能优化**: 
  - [ ] 防抖 (300ms)
  - [ ] 客户端缓存 (React Query)
  - [ ] 服务端索引优化
- [ ] **拼音搜索**: 商品库添加 `pinyin` 字段
- [ ] **自动填充**:
  ```typescript
  const handleProductSelect = (product: Product) => {
    form.setValue('productSku', product.sku);
    form.setValue('imageUrl', product.images[0]);
    form.setValue('fabricWidth', product.attributes.fabricWidth);
    form.setValue('material', product.attributes.material);
    form.setValue('weight', product.attributes.weight);
    form.setValue('patternRepeat', product.attributes.patternRepeat);
    form.setValue('unitPrice', product.basePrice);
  };
  ```

---

### 4.2 嵌套附件 UI (2天)
**需求**: 支持树形数据结构的表格编辑

**整改动作**:
- [ ] **技术选型**: 评估 Tanstack Table 的嵌套行功能
- [ ] **创建组件**: `NestedItemTable.tsx`
- [ ] **交互逻辑**:
  - [ ] "+" 按钮插入子行
  - [ ] 子行缩进显示
  - [ ] 行内小计自动更新
- [ ] **数据结构**: 使用 `parentId` 关联

---

### 4.3 版本对比视图 (P2 - 增值功能, 3天)
**需求**: "苹果风"侧并侧对比 + 差异高亮

**整改动作**:
- [ ] **创建组件**: `VersionCompareView.tsx`
- [ ] **布局设计**:
  - [ ] 侧并侧网格 (Grid 2列)
  - [ ] Header 吸顶显示总价
- [ ] **差异算法**:
  ```typescript
  function calculateDiff(v1: QuoteItem[], v2: QuoteItem[]) {
    const added = v2.filter(item => !v1.find(i => i.id === item.id));
    const removed = v1.filter(item => !v2.find(i => i.id === item.id));
    const modified = v2.filter(item => {
      const old = v1.find(i => i.id === item.id);
      return old && JSON.stringify(old) !== JSON.stringify(item);
    });
    return { added, removed, modified };
  }
  ```
- [ ] **高亮样式**: 新增 (绿), 删除 (红), 修改 (黄)

---

## 5. 执行计划清单 (6周时间表)

### **第一周 (Day 1-7)**: 类型错误 + Schema修正 → 目标完成度 45%
- [ ] 修复所有 TypeScript 类型错误
- [ ] 版本管理数据库约束
- [ ] 定义 JSONB TypeScript 接口
- [ ] 实现快照机制

### **第二周 (Day 8-14)**: 计算引擎审查 → 目标完成度 60%
- [ ] 窗帘计算引擎验证与修复
- [ ] 墙纸计算引擎实现/验证
- [ ] 墙布计算引擎实现/验证
- [ ] 编写单元测试 (覆盖率 >80%)

### **第三周 (Day 15-21)**: 模式配置系统 → 目标完成度 70%
- [ ] 配置数据结构设计
- [ ] 配置管理 API
- [ ] 前端动态表单
- [ ] 租户级配置UI

### **第四周 (Day 22-28)**: 版本管理与流转 → 目标完成度 80%
- [ ] 版本管理业务逻辑
- [ ] 状态机完善
- [ ] 订单流转与拆单路由
- [ ] E2E测试 (创建-编辑-转单)

### **第五周 (Day 29-35)**: UI/UX完善 → 目标完成度 90%
- [ ] 智能联想优化
- [ ] 嵌套附件 UI
- [ ] 用户体验优化

### **第六周 (Day 36-42)**: 集成测试与文档 → 目标完成度 95%+
- [ ] 完整业务流程测试
- [ ] 性能优化 (计算引擎缓存)
- [ ] 开发文档与培训材料
- [ ] (可选) 版本对比视图

---

## 6. 资源需求

| 角色 | 人数 | 时间投入 | 主要职责 |
|:---|:---:|:---|:---|
| **后端工程师** | 2人 | 全职6周 | 计算引擎、API、数据库、快照 |
| **前端工程师** | 2人 | 全职6周 | 动态表单、UI组件、版本对比 |
| **测试工程师** | 1人 | 2周 (第5-6周) | 单元测试、E2E测试 |
| **业务专家** | 1人 | 兼职1周 | 计算公式验证、流程确认 |

**总人天估算**: 约 **160人天**

---

## 7. 风险提示

1. **🔴 严重**: 计算引擎错误导致报价金额不准 - 第二周完成后必须人工验证 10+ 真实场景
2. **🔴 严重**: 快照机制缺失导致订单价格变动 - 第一周必须优先实现
3. **🟡 高**: 墙纸/墙布计算逻辑与实际业务不符 - 需业务方深度参与验证
4. **🟡 高**: JSONB 结构不一致导致数据迁移困难 - 尽早标准化
5. **🟢 中**: 版本对比UI开发成本高 - 可降为 P2 优先级

---

## 8. 验收标准

### 8.1 功能验收
- [ ] ✅ 报价模式切换流畅，字段正确显示/隐藏
- [ ] ✅ 窗帘/墙纸/墙布计算结果与手工计算一致 (误差<1%)
- [ ] ✅ 版本管理符合"唯一 ACTIVE"约束
- [ ] ✅ 转单后订单数据不受商品库变更影响
- [ ] ✅ 嵌套附件联动计算正确

### 8.2 性能验收
- [ ] ✅ 报价单加载时间 <2秒 (含 100+ 行项目)
- [ ] ✅ 计算响应时间 <500ms
- [ ] ✅ 商品联想搜索 <300ms

### 8.3 代码质量验收
- [ ] ✅ TypeScript 类型检查 0 错误
- [ ] ✅ 单元测试覆盖率 >80% (计算引擎 100%)
- [ ] ✅ E2E 测试覆盖核心流程

---

## 9. 参考文档

- [报价模块审计报告](./02-requirements/modules/报价单/quote-module-audit-20260116.md)
- [报价单需求文档](./02-requirements/modules/报价单/报价单.md)
- [数量计算逻辑文档](./数量计算逻辑.md)

---

<br/>

---
---

# 采购单模块需求整改计划

> **目标文档**: `docs/02-requirements/modules/采购单/采购单.md` (312行)
> **审计报告**: `docs/02-requirements/modules/采购单/po-module-audit-20260116.md`
> **涉及模块**: 采购单管理 (Purchase Order Management)
> **优先级**: P0 (供应链核心入口)
> **当前完成度**: 50-60%
> **目标完成度**: 85%+

---

## 1. 数据库Schema修正 (P0 - 阻塞)

### 1.1 purchase_orders 表补充 (13个缺失字段)

**整改动作**:
- [ ] **售后溯源字段**:
  ```sql
  ALTER TABLE purchase_orders ADD COLUMN after_sales_id UUID;
  ALTER TABLE purchase_orders ADD CONSTRAINT fk_po_after_sales 
    FOREIGN KEY (after_sales_id) REFERENCES after_sales_tickets(id);
  ```

- [ ] **供应商对接字段**:
  ```sql
  ALTER TABLE purchase_orders ADD COLUMN external_po_no VARCHAR(100);
  ALTER TABLE purchase_orders ADD COLUMN supplier_quote_img TEXT;
  ALTER TABLE purchase_orders ADD COLUMN sent_method VARCHAR(20);
  ALTER TABLE purchase_orders ADD COLUMN sent_at TIMESTAMP WITH TIME ZONE;
  ```

- [ ] **生产跟踪字段**:
  ```sql
  ALTER TABLE purchase_orders ADD COLUMN produced_at TIMESTAMP WITH TIME ZONE;
  ```

- [ ] **物流字段**:
  ```sql
  ALTER TABLE purchase_orders ADD COLUMN logistics_company VARCHAR(50);
  ALTER TABLE purchase_orders ADD COLUMN logistics_no VARCHAR(100);
  ALTER TABLE purchase_orders ADD COLUMN shipped_at TIMESTAMP WITH TIME ZONE;
  ALTER TABLE purchase_orders ADD COLUMN delivered_at TIMESTAMP WITH TIME ZONE;
  ```

- [ ] **付款状态**:
  ```sql
  ALTER TABLE purchase_orders ADD COLUMN payment_status VARCHAR(20) 
    DEFAULT 'PENDING' CHECK (payment_status IN ('PENDING', 'PARTIAL', 'PAID'));
  ```

---

### 1.2 purchase_order_items 表补充 (6个缺失字段)

**整改动作**:
- [ ] **关联字段**:
  ```sql
  ALTER TABLE purchase_order_items ADD COLUMN order_item_id UUID NOT NULL;
  ALTER TABLE purchase_order_items ADD COLUMN product_id UUID;
  ALTER TABLE purchase_order_items ADD COLUMN product_sku VARCHAR(100);
  ALTER TABLE purchase_order_items ADD COLUMN category VARCHAR(50);
  
  ALTER TABLE purchase_order_items 
    ADD CONSTRAINT fk_poi_order_item 
    FOREIGN KEY (order_item_id) REFERENCES order_items(id);
  ```

- [ ] **尺寸与成本**:
  ```sql
  ALTER TABLE purchase_order_items ADD COLUMN width DECIMAL(10, 2);
  ALTER TABLE purchase_order_items ADD COLUMN height DECIMAL(10, 2);
  ALTER TABLE purchase_order_items ADD COLUMN subtotal DECIMAL(12, 2);
  ```

---

### 1.3 状态枚举标准化

**问题**: 当前 `status` 为 `VARCHAR(50)`，无类型安全

**整改动作**:
- [ ] **定义成品采购单状态枚举**:
  ```sql
  CREATE TYPE po_finished_status AS ENUM (
    'DRAFT',           -- 草稿
    'IN_PRODUCTION',   -- 生产中
    'READY',           -- 备货完成
    'SHIPPED',         -- 已发货
    'DELIVERED',       -- 已到货
    'CANCELLED'        -- 已取消
  );
  ```

- [ ] **定义面料采购单状态枚举**:
  ```sql
  CREATE TYPE po_fabric_status AS ENUM (
    'DRAFT',           -- 草稿
    'IN_PRODUCTION',   -- 采购中
    'DELIVERED',       -- 已到货
    'STOCKED',         -- 已入库
    'CANCELLED'        -- 已取消
  );
  ```

- [ ] **Schema迁移**: 根据 `type` 字段使用对应枚举

---

## 2. 核心业务逻辑实现 (P0 - Critical)

### 2.1 订单拆单逻辑 (2天)

**问题描述**: 采购单的唯一来源是订单拆分，但该逻辑完全缺失。

**整改动作**:

#### 2.1.1 拆单策略实现
- [ ] **创建 Service**: `src/services/po-split.service.ts`
  ```typescript
  export class POSplitService {
    /**
     * 订单转采购单主函数
     */
    async splitOrderToPOs(orderId: string) {
      const order = await db.query.orders.findFirst({
        where: eq(orders.id, orderId),
        with: { 
          items: { with: { product: true } }
        }
      });
      
      // 1. 按供应商分组
      const itemsBySupplier = this.groupBySupplier(order.items);
      
      // 2. 为每个供应商生成采购单
      const pos = [];
      for (const [supplierId, items] of itemsBySupplier) {
        const po = await this.createPOForSupplier({
          orderId,
          supplierId,
          items,
          type: this.determinePOType(items),
        });
        pos.push(po);
      }
      
      return pos;
    }
    
    /**
     * 判断采购单类型
     */
    private determinePOType(items: OrderItem[]): POType {
      // 检查是否有标品 → STOCK
      if (items.every(i => i.product.isStandard)) {
        return 'STOCK';
      }
      
      // 检查是否为面料 → FABRIC
      if (items.some(i => i.category === 'CURTAIN_FABRIC')) {
        return 'FABRIC';
      }
      
      // 默认成品 → FINISHED
      return 'FINISHED';
    }
    
    /**
     * 按供应商分组
     */
    private groupBySupplier(items: OrderItem[]) {
      return items.reduce((acc, item) => {
        const supplierId = item.product.defaultSupplierId;
        if (!acc.has(supplierId)) {
          acc.set(supplierId, []);
        }
        acc.get(supplierId)!.push(item);
        return acc;
      }, new Map());
    }
  }
  ```

#### 2.1.2 触发时机
- [ ] **订单状态变更时触发**:
  ```typescript
  // src/services/order.service.ts
  async updateOrderStatus(orderId: string, newStatus: string) {
    // ... 状态更新逻辑
    
    // 当订单确认时，自动拆单
    if (newStatus === 'CONFIRMED') {
      await poSplitService.splitOrderToPOs(orderId);
    }
  }
  ```

---

### 2.2 状态联动逻辑 (1.5天)

**问题描述**: 采购单状态变更需向上驱动订单状态，但该逻辑缺失。

**整改动作**:

#### 2.2.1 状态聚合函数
- [ ] **创建聚合逻辑**:
  ```typescript
  // src/services/po-status-aggregator.service.ts
  export class POStatusAggregator {
    /**
     * 检查订单下所有采购单状态，更新订单状态
     */
    async updateOrderStatusByPOs(orderId: string) {
      const pos = await db.query.purchaseOrders.findMany({
        where: eq(purchaseOrders.orderId, orderId)
      });
      
      // 区分成品和面料采购单
      const finishedPOs = pos.filter(p => p.type === 'FINISHED');
      const fabricPOs = pos.filter(p => p.type === 'FABRIC');
      
      // 状态判定规则
      let newOrderStatus = await this.determineOrderStatus(finishedPOs, fabricPOs);
      
      // 更新订单状态
      await orderService.updateOrderStatus(orderId, newOrderStatus);
    }
    
    private async determineOrderStatus(finishedPOs, fabricPOs) {
      // 规则1: 任一成品PO进入生产 → 订单IN_PRODUCTION
      if (finishedPOs.some(p => p.status === 'IN_PRODUCTION')) {
        return 'IN_PRODUCTION';
      }
      
      // 规则2: 所有成品PO备货完成 + 所有面料PO入库 → 订单PENDING_DELIVERY
      const allFinishedReady = finishedPOs.every(p => p.status === 'READY');
      const allFabricStocked = fabricPOs.every(p => p.status === 'STOCKED');
      if (allFinishedReady && allFabricStocked) {
        return 'PENDING_DELIVERY';
      }
      
      // 规则3: 所有PO已发货 → 订单SHIPPED
      if (pos.every(p => p.status === 'SHIPPED')) {
        return 'SHIPPED';
      }
      
      // 规则4: 所有PO已到货 → 订单PENDING_INSTALL
      if (pos.every(p => p.status === 'DELIVERED')) {
        return 'PENDING_INSTALL';
      }
      
      return null; // 保持当前状态
    }
  }
  ```

#### 2.2.2 触发机制
- [ ] **PO状态变更时触发**:
  ```typescript
  async updatePOStatus(poId: string, newStatus: string) {
    const po = await db.update(purchaseOrders)
      .set({ status: newStatus })
      .where(eq(purchaseOrders.id, poId))
      .returning();
    
    // 触发订单状态联动
    await poStatusAggregator.updateOrderStatusByPOs(po.orderId);
  }
  ```

---

### 2.3 物流管理功能 (1天)

**整改动作**:

#### 2.3.1 物流信息填写 API
- [ ] **Server Action**: `src/features/supply-chain/actions/po-actions.ts`
  ```typescript
  export async function addPOLogistics(
    poId: string, 
    logistics: {
      company: string;
      trackingNo: string;
      shippedAt?: Date;
      remark?: string;
    }
  ) {
    const po = await db.update(purchaseOrders)
      .set({
        logistics_company: logistics.company,
        logistics_no: logistics.trackingNo,
        shipped_at: logistics.shippedAt || new Date(),
        status: 'SHIPPED',
      })
      .where(eq(purchaseOrders.id, poId))
      .returning();
    
    // 触发状态联动
    await poStatusAggregator.updateOrderStatusByPOs(po.orderId);
    
    // 发送通知给销售
    await notificationService.send({
      type: 'PO_SHIPPED',
      userId: po.order.salesId,
      content: `采购单 ${po.poNo} 已发货`,
    });
    
    revalidatePath('/purchase-orders');
    return { success: true, po };
  }
  ```

#### 2.3.2 物流填写弹窗组件
- [ ] **创建组件**: `src/features/supply-chain/components/add-logistics-dialog.tsx`
  ```typescript
  export function AddLogisticsDialog({ poId, open, onClose }) {
    const form = useForm({
      defaultValues: {
        company: '',
        trackingNo: '',
      }
    });
    
    const handleSubmit = async (data) => {
      await addPOLogistics(poId, data);
      toast.success('物流信息已填写');
      onClose();
    };
    
    return (
      <Dialog open={open} onOpenChange={onClose}>
        <DialogContent>
          <DialogHeader>填写物流信息</DialogHeader>
          <Form {...form}>
            <FormField name="company" label="物流公司" />
            <FormField name="trackingNo" label="物流单号" />
            <Button onClick={form.handleSubmit(handleSubmit)}>确认</Button>
          </Form>
        </DialogContent>
      </Dialog>
    );
  }
  ```

---

### 2.4 售后补件创建 (1天)

**需求**: 售后工单定责为"补件"时，自动生成补件采购单

**整改动作**:
- [ ] **在售后工单Service中添加逻辑**:
  ```typescript
  // src/services/after-sales.service.ts
  async createAfterSalesTicket(data: CreateTicketDto) {
    const ticket = await db.insert(afterSalesTickets).values(data).returning();
    
    // 如果责任判定为"补件"，自动生成采购单
    if (data.liability === 'RESTOCK') {
      await this.createRestockPO(ticket);
    }
    
    return ticket;
  }
  
  private async createRestockPO(ticket: AfterSalesTicket) {
    const po = await db.insert(purchaseOrders).values({
      poNo: await generatePONo(),
      orderId: ticket.orderId,
      after_sales_id: ticket.id, // 溯源字段
      supplierId: ticket.product.defaultSupplierId,
      type: 'FINISHED',
      status: 'DRAFT',
      // ... 其他字段
    });
    
    await db.insert(purchaseOrderItems).values({
      poId: po.id,
      productId: ticket.productId,
      quantity: 1,
      // ...
    });
  }
  ```

---

## 3. UI/UX 组件完善 (P1)

### 3.1 列表页增强 (0.5天)
- [ ] 添加筛选条件 (时间范围、供应商、付款状态)
- [ ] 添加批量操作 (批量确认下单)
- [ ] 优化分页组件

### 3.2 详情页完善 (1天)
- [ ] **状态进度条**: 可视化展示当前状态
- [ ] **供应商确认截图上传**: 集成 `PhotoUpload` 组件
- [ ] **物流信息卡片**: 已发货后显示物流跟踪
- [ ] **操作日志**: 从 `audit_logs` 获取历史

### 3.3 物流填写弹窗 (已在2.3.2实现)

---

## 4. 执行计划清单 (2周时间表)

### **第一周 (Day 1-7)**: Schema + 拆单 + 状态联动 → 目标完成度 70%
- [ ] **Day 1**: 数据库Schema修正 (添加19个字段)
- [ ] **Day 2**: 定义状态枚举，生成migration
- [ ] **Day 3-4**: 实现订单拆单逻辑
- [ ] **Day 5-6**: 实现状态联动逻辑
- [ ] **Day 7**: 单元测试 (拆单 + 联动)

### **第二周 (Day 8-14)**: 物流 + 售后 + UI → 目标完成度 85%+
- [ ] **Day 8**: 物流管理功能 (API + 组件)
- [ ] **Day 9**: 售后补件创建
- [ ] **Day 10-11**: UI组件完善 (列表页 + 详情页)
- [ ] **Day 12**: E2E测试 (完整流程)
- [ ] **Day 13**: 性能优化与Bug修复
- [ ] **Day 14**: 文档与交付

---

## 5. 资源需求

| 角色 | 人数 | 时间投入 | 主要职责 |
|:---|:---:|:---|:---|
| **后端工程师** | 1人 | 全职2周 | Schema、拆单逻辑、状态联动、API |
| **前端工程师** | 1人 | 全职2周 | UI组件、物流弹窗、详情页 |
| **测试工程师** | 1人 | 1周 (第2周) | E2E测试、回归测试 |

**总人天估算**: 约 **40人天**

---

## 6. 风险提示

1. **🔴 严重**: 订单拆单逻辑错误导致采购单数据不准 - 需与订单模块深度协调
2. **🔴 严重**: 状态联动规则理解偏差 - 第一周完成后必须业务方验证
3. **🟡 高**: 售后补件场景复杂 - 可能需要多轮迭代
4. **🟡 高**: 物流API集成成本 - 初期可仅支持手工填写

---

## 7. 验收标准

### 7.1 功能验收
- [ ] ✅ 订单确认后自动生成采购单 (按供应商拆分)
- [ ] ✅ 采购单状态变更正确驱动订单状态
- [ ] ✅ 物流信息填写后状态自动变为"已发货"
- [ ] ✅ 售后补件工单自动生成补件采购单
- [ ] ✅ 采购单详情页完整展示所有信息

### 7.2 数据完整性验收
- [ ] ✅ 所有采购单都有 `order_item_id` 关联
- [ ] ✅ 物流信息字段不为空 (已发货状态下)
- [ ] ✅ 付款状态与财务模块一致

### 7.3 性能验收
- [ ] ✅ 订单拆单响应时间 <2秒 (10+商品)
- [ ] ✅ 列表页加载时间 <1秒 (100条记录)

---

## 8. 参考文档

- [采购单模块审计报告](./02-requirements/modules/采购单/po-module-audit-20260116.md)
- [采购单需求文档](./02-requirements/modules/采购单/采购单.md)

---

**最后更新**: 2026-01-16

# 报价模块代码实现整改计划（基于 2026-01-16 审计）

> **目标**: 修复报价模块与需求文档之间的 47 个差异点
> **审计报告**: [报价模块审计报告_2026-01-16.md](./报价模块审计报告_2026-01-16.md)
> **当前完成度**: **45%**
> **优先级**: **P0** (核心交易流程)

---

## 整改总览

本整改计划基于 2026-01-16 的全面审计结果，分为三个阶段：
- **短期 (1-2 周)**: 修复 P0 级差异，确保核心功能可用
- **中期 (3-4 周)**: 修复 P1 级差异，完善重要功能
- **长期 (5-8 周)**: 修复 P2/P3 级差异，优化用户体验

---

## 📦 报价模块 (Quote Module) 整改计划

**生成时间**: 2026-01-16
**当前完成度**: **45%**
**目标完成度**: **85%+**
**整改周期**: 6周 (2026-01-20 ~ 2026-03-02)

### 核心问题

1. **🔴 折扣风控体系完全缺失** - 无折扣底线配置、审批工作流
2. **🔴 状态流转 API 未实现** - 无法提交/接受/拒绝报价单
3. **🔴 测量数据导入功能未实现** - 无法实现"测量-报价-订单"闭环
4. **🔴 报价模式配置系统缺失** - 无法实现快速/高级报价切换
5. **🔴 前端实时计算逻辑缺失** - 用户体验受损

### 分周计划

| 周次 | 核心任务 | 预计完成度 |
|:---:|:---|:---:|
| Week 1 | 折扣风控体系 + 状态流转API | 55% |
| Week 2 | 测量数据导入 + 房间管理API | 65% |
| Week 3 | 报价模式配置系统 + 版本管理 | 75% |
| Week 4 | 前端实时计算 + 嵌套附件 | 85% |
| Week 5 | UI/UX完善 + 测量集成 | 90% |
| Week 6 | 测试覆盖 + 上线准备 | 95%+ |

### 资源需求

- **后端开发**: 1人全职 (24天工作量)
- **前端开发**: 1人全职 (20天工作量)
- **QA测试**: 1人兼职 (5天工作量)
- **总计**: 49人日 (2人并行6周完成)

### 关键风险

| 风险 | 等级 | 缓解措施 |
|:---|:---:|:---|
| 折扣风控规则复杂度超预期 | 🔴 高 | Week 1提前与业务确认详细规则 |
| 前后端计算逻辑不一致 | 🔴 高 | 共享计算代码，单元测试覆盖 |
| 测量模块未完成 | 🟡 中 | Week 2提前审计测量模块，必要时Mock |
| 报价模式配置理解偏差 | 🟡 中 | Week 3开发前与业务确认配置需求 |

### 验收标准

**功能**:
- ✅ 折扣风控体系100%可用
- ✅ 状态流转API全部实现
- ✅ 测量数据导入端到端可执行
- ✅ 报价模式配置系统可用
- ✅ 前端实时计算响应 <100ms

**性能**:
- ✅ 报价单列表加载 <2s (1000+记录)
- ✅ 报价单详情页加载 <1s
- ✅ 测量数据导入 <3s (100+ items)

**质量**:
- ✅ 单元测试覆盖率≥70%
- ✅ E2E测试覆盖核心Flow
- ✅ 前后端计算逻辑一致性100%
- ✅ 无P0/P1 Bug

### 详细文档

📄 [报价模块审计报告_20260116.md](./报价模块审计报告_20260116.md)
📋 [报价模块整改计划_20260116.md](./报价模块整改计划_20260116.md)

---

## 📦 订单模块 (Order Module) 整改计划

**生成时间**: 2026-01-16  
**当前完成度**: **~35%**  
**目标完成度**: **90%+**  
**整改周期**: 6周 (2026-01-20 ~ 2026-03-02)

### 核心问题

1. **🔴 订单快照机制缺失** - Schema缺少 `snapshotData` 字段，无法保存报价快照
2. **🔴 变更单流程完全缺失** - 无 `changeRequests` 表，订单修改功能不可用
3. **🔴 智能拆单逻辑Mock** - 仅5行Mock代码，无供应商匹配算法
4. **🔴 叫停机制缺失** - Schema缺少 `HALTED` 状态和相关字段
5. **🔴 API完成度低** - 18个核心API仅3个完整实现 (16.7%)

### 分周计划

| 周次 | 核心任务 | 预计完成度 |
|:---:|:---|:---:|
| Week 1 | Schema变更 + 订单快照机制 | 45% |
| Week 2 | 变更单完整流程 (API + UI) | 55% |
| Week 3 | 智能拆单逻辑实现 | 65% |
| Week 4 | 发货与物流流程 | 75% |
| Week 5 | 叫停机制 + P1功能 + 前端优化 | 85% |
| Week 6 | 测试覆盖 + 性能优化 + 上线准备 | 90%+ |

### 资源需求

- **后端开发**: 1人全职 (21天工作量)
- **前端开发**: 1人全职 (11天工作量)
- **QA测试**: 1人兼职 (3天工作量)
- **总计**: 35人日 (2人并行6周完成)

### 关键风险

| 风险 | 等级 | 缓解措施 |
|:---|:---:|:---|
| 拆单算法复杂度超预期 | 🔴 高 | Week 1提前原型验证，降级为手动拆单 |
| 采购模块未完成 | 🔴 高 | Week 1立即审计PO模块，必要时Mock |
| 审批流程未完成 | 🟡 中 | 简化为店长直接审批 |
| 快递100 API不稳定 | 🟡 中 | 增加手动录入降级方案 |

### 验收标准

**功能**:
- ✅ 订单快照机制100%可用
- ✅ 变更单端到端流程可执行
- ✅ 智能拆单准确率≥95%
- ✅ 18个核心API全部实现

**性能**:
- ✅ 1000+订单列表加载 <2s
- ✅ 拆单算法响应 <3s

**质量**:
- ✅ 单元测试覆盖率≥70%
- ✅ E2E测试覆盖核心Flow
- ✅ 无P0/P1 Bug

### 详细文档

📄 [订单模块差异分析报告_20260116.md](./02-requirements/modules/订单/订单模块差异分析报告_20260116.md)  
📋 [订单模块整改计划_20260116.md](./02-requirements/modules/订单/订单模块整改计划_20260116.md)

---

**整改计划持续更新中...**

