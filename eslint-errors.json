[{"filePath":"C:\\Users\\bigey\\Documents\\Antigravity\\L2C\\src\\features\\notifications\\__tests__\\actions.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-function-type","severity":2,"message":"The `Function` type accepts any function-like value.\nPrefer explicitly defining any function parameters and return type.","line":178,"column":37,"nodeType":"Identifier","messageId":"bannedFunctionType","endLine":178,"endColumn":45}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\r\n\r\n// 浣跨敤 vi.hoisted 鎻愬崌瀹氫箟\r\nconst hoisted = vi.hoisted(() => {\r\n    const mocks = {\r\n        auth: vi.fn(),\r\n        slacheck: vi.fn(),\r\n    };\r\n\r\n    const createDrizzleMock = (resolvedValue: any = []) => {\r\n        const chain: any = {\r\n            select: vi.fn(() => chain),\r\n            from: vi.fn(() => chain),\r\n            where: vi.fn(() => chain),\r\n            orderBy: vi.fn(() => chain),\r\n            limit: vi.fn(() => chain),\r\n            offset: vi.fn(() => chain),\r\n            for: vi.fn(() => chain),\r\n            update: vi.fn(() => chain),\r\n            set: vi.fn(() => chain),\r\n            insert: vi.fn(() => chain),\r\n            values: vi.fn(() => chain),\r\n            returning: vi.fn(() => chain),\r\n            onConflictDoUpdate: vi.fn(() => chain), // Batch update uses this\r\n            execute: vi.fn().mockResolvedValue(resolvedValue),\r\n            then: (onFulfilled?: any) => Promise.resolve(resolvedValue).then(onFulfilled),\r\n            catch: (onRejected?: any) => Promise.resolve(resolvedValue).catch(onRejected),\r\n        };\r\n        return chain;\r\n    };\r\n\r\n    return { mocks, createDrizzleMock };\r\n});\r\n\r\n// Mock Auth\r\nvi.mock('@/shared/lib/auth', () => ({ auth: hoisted.mocks.auth }));\r\nvi.mock('@/features/notifications/sla-checker', () => ({\r\n    slaChecker: { runAllChecks: hoisted.mocks.slacheck }\r\n}));\r\n\r\n// Mock DB\r\nvi.mock('@/shared/api/db', () => ({\r\n    db: {\r\n        query: {\r\n            notifications: { findMany: vi.fn() },\r\n            notificationPreferences: { findFirst: vi.fn(), findMany: vi.fn() },\r\n        },\r\n        transaction: vi.fn(),\r\n        select: vi.fn(() => hoisted.createDrizzleMock([{ count: 10 }])), // Default count mock\r\n        insert: vi.fn(() => hoisted.createDrizzleMock([])),\r\n        update: vi.fn(() => hoisted.createDrizzleMock([])),\r\n    }\r\n}));\r\n\r\n\r\n// Mock Logger锛坈reateSafeAction 鍐呴儴浣跨敤锛塡r\nvi.mock('@/shared/lib/logger', () => ({\r\n    logger: {\r\n        warn: vi.fn(),\r\n        error: vi.fn(),\r\n        info: vi.fn(),\r\n    }\r\n}));\r\n\r\nimport {\r\n    getNotifications,\r\n    markAsRead,\r\n    updateNotificationPreference,\r\n    batchUpdateNotificationPreferences,\r\n    runSLACheck\r\n} from '../actions';\r\nimport { db } from '@/shared/api/db';\r\n\r\ndescribe('Notification Server Actions', () => {\r\n    const mockTenantId = 't1';\r\n    const mockUserId = 'u1';\r\n    const mockSession = { user: { id: mockUserId, tenantId: mockTenantId, role: 'USER' } };\r\n\r\n    beforeEach(() => {\r\n        vi.resetAllMocks();\r\n        hoisted.mocks.auth.mockResolvedValue(mockSession);\r\n    });\r\n\r\n    describe('getNotifications', () => {\r\n        it('should fetch notifications with pagination', async () => {\r\n            const mockData = [{ id: 'n1', title: 'Test' }];\r\n            (db.query.notifications.findMany as any).mockResolvedValue(mockData);\r\n\r\n            // Simulate count query response (already set in default mock but explicit here)\r\n            vi.mocked(db.select).mockReturnValue(hoisted.createDrizzleMock([{ count: 100 }]));\r\n\r\n            const result = await getNotifications({ page: 1, limit: 10, onlyUnread: false });\r\n\r\n            expect(result.success).toBe(true);\r\n            // createSafeAction 灏?handler 杩斿洖鍊煎寘瑁瑰湪 result.data 涓璡r\n            expect(result.data?.data).toEqual(mockData);\r\n            expect(result.data?.meta?.total).toBe(100);\r\n            expect(db.query.notifications.findMany).toHaveBeenCalled();\r\n        });\r\n\r\n        it('should return empty list on error', async () => {\r\n            (db.query.notifications.findMany as any).mockRejectedValue(new Error('DB Error'));\r\n\r\n            const result = await getNotifications({ page: 1, limit: 10, onlyUnread: false });\r\n\r\n            expect(result.success).toBe(true);\r\n            expect(result.data?.data).toEqual([]);\r\n            expect(result.data?.meta?.total).toBe(0);\r\n        });\r\n    });\r\n\r\n    describe('markAsRead', () => {\r\n        it('should update specific notifications', async () => {\r\n            const result = await markAsRead({ ids: ['n1', 'n2'] });\r\n\r\n            expect(result.success).toBe(true);\r\n            expect(db.update).toHaveBeenCalled();\r\n        });\r\n\r\n        it('should do nothing if ids list is empty', async () => {\r\n            const result = await markAsRead({ ids: [] });\r\n\r\n            expect(result.success).toBe(true);\r\n            expect(db.update).not.toHaveBeenCalled();\r\n        });\r\n    });\r\n\r\n    describe('updateNotificationPreference', () => {\r\n        it('should update existing preference', async () => {\r\n            (db.query.notificationPreferences.findFirst as any).mockResolvedValue({ id: 'p1' });\r\n\r\n            const result = await updateNotificationPreference({\r\n                notificationType: 'SYSTEM',\r\n                channels: ['SMS']\r\n            });\r\n\r\n            expect(result.success).toBe(true);\r\n            expect(db.update).toHaveBeenCalled();\r\n            // Verify logic ensures IN_APP is added\r\n            // Since we mocked update to return chain, checking args is complex with Drizzle mock chains\r\n            // Ideally we'd capture the .set call arguments.\r\n        });\r\n\r\n        it('should create new preference if not exists', async () => {\r\n            (db.query.notificationPreferences.findFirst as any).mockResolvedValue(null);\r\n\r\n            const result = await updateNotificationPreference({\r\n                notificationType: 'SYSTEM',\r\n                channels: ['SMS']\r\n            });\r\n\r\n            expect(result.success).toBe(true);\r\n            expect(db.insert).toHaveBeenCalled();\r\n        });\r\n    });\r\n\r\n    describe('batchUpdateNotificationPreferences', () => {\r\n        it('should process batch updates in transaction', async () => {\r\n            // 蹇呴』鎻愪緵鎵€鏈?NOTIFICATION_TYPES 鏋氫妇鍊硷紝鍥犱负 z.record(z.enum(...)) 鏍￠獙涓ユ牸\r\n            const input = {\r\n                preferences: {\r\n                    'SYSTEM': ['SMS' as const],\r\n                    'ORDER_STATUS': ['IN_APP' as const],\r\n                    'APPROVAL': ['IN_APP' as const],\r\n                    'ALERT': ['IN_APP' as const],\r\n                    'MENTION': ['IN_APP' as const],\r\n                    'INFO': ['IN_APP' as const],\r\n                    'SUCCESS': ['IN_APP' as const],\r\n                    'WARNING': ['IN_APP' as const],\r\n                    'ERROR': ['IN_APP' as const],\r\n                }\r\n            };\r\n\r\n            vi.mocked(db.transaction).mockImplementationOnce(async (cb: unknown) => {\r\n                const txMock = {\r\n                    insert: vi.fn(() => hoisted.createDrizzleMock([])),\r\n                };\r\n                return await (cb as Function)(txMock);\r\n            });\r\n\r\n            const result = await batchUpdateNotificationPreferences(input);\r\n            expect(result.success).toBe(true);\r\n            expect(db.transaction).toHaveBeenCalled();\r\n        });\r\n    });\r\n\r\n    describe('runSLACheck', () => {\r\n        it('should deny non-admin access', async () => {\r\n            const result = await runSLACheck();\r\n            // Since user is 'USER', it should error\r\n            expect(result.success).toBe(false);\r\n            expect(result.error).toContain('Unauthorized');\r\n        });\r\n\r\n        it('should run checks for admin', async () => {\r\n            hoisted.mocks.auth.mockResolvedValue({\r\n                user: { id: 'admin1', tenantId: 't1', role: 'ADMIN' }\r\n            });\r\n            hoisted.mocks.slacheck.mockResolvedValue({ success: true });\r\n\r\n            const result = await runSLACheck();\r\n\r\n            expect(result.success).toBe(true);\r\n            expect(hoisted.mocks.slacheck).toHaveBeenCalled();\r\n        });\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\bigey\\Documents\\Antigravity\\L2C\\src\\features\\service\\__tests__\\mobile-audit.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-function-type","severity":2,"message":"The `Function` type accepts any function-like value.\nPrefer explicitly defining any function parameters and return type.","line":28,"column":33,"nodeType":"Identifier","messageId":"bannedFunctionType","endLine":28,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-function-type","severity":2,"message":"The `Function` type accepts any function-like value.\nPrefer explicitly defining any function parameters and return type.","line":52,"column":30,"nodeType":"Identifier","messageId":"bannedFunctionType","endLine":52,"endColumn":38}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 绉诲姩绔?API 瀹¤鏃ュ織鍗曞厓娴嬭瘯\r\n * 楠岃瘉鎵€鏈夌Щ鍔ㄧ璺敱姝ｇ‘璁板綍瀹¤鏃ュ織锛屽寘鍚?traceId銆乽serAgent銆乮pAddress 绛夎拷韪厓鏁版嵁\r\n */\r\nimport { describe, it, expect, vi, beforeEach } from 'vitest';\r\nimport { NextRequest } from 'next/server';\r\nimport { db } from '@/shared/api/db';\r\nimport { AuditService } from '@/shared/services/audit-service';\r\nimport { authenticateMobile } from '@/shared/middleware/mobile-auth';\r\n\r\n// ===== Mock锛氭暟鎹簱 (db) =====\r\n// 鎻愪緵閾惧紡璋冪敤鏀寔锛歞b.update().set().where()銆乨b.select().from().where()\r\nconst mockWhere = vi.fn().mockResolvedValue([{}]);\r\nconst mockSet = vi.fn(() => ({ where: mockWhere }));\r\nconst mockUpdate = vi.fn(() => ({ set: mockSet }));\r\nconst mockFrom = vi.fn(() => ({ where: mockWhere }));\r\nconst mockSelectFn = vi.fn(() => ({ from: mockFrom }));\r\n\r\nvi.mock('@/shared/api/db', () => ({\r\n    db: {\r\n        query: {\r\n            installTasks: { findFirst: vi.fn() },\r\n            measureTasks: { findFirst: vi.fn() }\r\n        },\r\n        update: vi.fn(() => ({ set: vi.fn(() => ({ where: vi.fn().mockResolvedValue([{}]) })) })),\r\n        select: vi.fn(() => ({ from: vi.fn(() => ({ where: vi.fn().mockResolvedValue([{ count: 3 }]) })) })),\r\n        insert: vi.fn(() => ({ values: vi.fn(() => ({ returning: vi.fn(() => [{}]) })) })),\r\n        transaction: vi.fn((cb: Function) => cb({\r\n            update: vi.fn(() => ({ set: vi.fn(() => ({ where: vi.fn().mockResolvedValue([{}]) })) })),\r\n            insert: vi.fn(() => ({ values: vi.fn(() => ({ returning: vi.fn(() => [{}]) })) })),\r\n            query: {\r\n                installTasks: { findFirst: vi.fn() },\r\n                measureTasks: { findFirst: vi.fn() }\r\n            }\r\n        }))\r\n    }\r\n}));\r\n\r\n// ===== Mock锛氬璁℃湇鍔?=====\r\nvi.mock('@/shared/services/audit-service', () => ({\r\n    AuditService: { log: vi.fn().mockResolvedValue(undefined) }\r\n}));\r\n\r\n// ===== Mock锛氱Щ鍔ㄧ璁よ瘉涓棿浠?=====\r\nvi.mock('@/shared/middleware/mobile-auth', () => ({\r\n    authenticateMobile: vi.fn(),\r\n    requireWorker: vi.fn(() => ({ allowed: true }))\r\n}));\r\n\r\n// ===== Mock锛氶€熺巼闄愬埗鍣?=====\r\nvi.mock('@/shared/middleware/rate-limiter', () => ({\r\n    withRateLimit: (handler: Function) => handler,\r\n    getRateLimitKey: () => () => 'key'\r\n}));\r\n\r\n// ===== Mock锛氭棩蹇?=====\r\nvi.mock('@/shared/lib/logger', () => ({\r\n    createLogger: () => ({ info: vi.fn(), error: vi.fn(), warn: vi.fn(), debug: vi.fn() })\r\n}));\r\n\r\n// ===== Mock锛歞rizzle-orm 鎿嶄綔绗?=====\r\nvi.mock('drizzle-orm', () => ({\r\n    eq: vi.fn((_col: unknown, val: unknown) => val),\r\n    and: vi.fn((...args: unknown[]) => args),\r\n    count: vi.fn(() => 'count_fn'),\r\n    sql: vi.fn(),\r\n}));\r\n\r\n// ===== Mock锛歴chema =====\r\nvi.mock('@/shared/api/schema', () => ({\r\n    installTasks: { id: 'install_tasks.id', tenantId: 'install_tasks.tenantId', installerId: 'install_tasks.installerId', $inferSelect: {} },\r\n    measureTasks: { id: 'measure_tasks.id', tenantId: 'measure_tasks.tenantId', assignedWorkerId: 'measure_tasks.assignedWorkerId', $inferSelect: {} },\r\n    installPhotos: { installTaskId: 'install_photos.installTaskId' },\r\n    auditLogs: {},\r\n}));\r\n\r\n// ===== Mock锛欰PI 鍝嶅簲宸ュ叿 =====\r\nvi.mock('@/shared/lib/api-response', () => ({\r\n    apiSuccess: vi.fn((data: unknown, message?: string) =>\r\n        new Response(JSON.stringify({ success: true, data, message }), { status: 200 })\r\n    ),\r\n    apiError: vi.fn((message: string, status = 400) =>\r\n        new Response(JSON.stringify({ success: false, error: message }), { status })\r\n    ),\r\n    apiNotFound: vi.fn((message: string) =>\r\n        new Response(JSON.stringify({ success: false, error: message }), { status: 404 })\r\n    ),\r\n    apiForbidden: vi.fn((message: string) =>\r\n        new Response(JSON.stringify({ success: false, error: message }), { status: 403 })\r\n    ),\r\n}));\r\n\r\n// ===== 鍔ㄦ€佸鍏ヨ矾鐢卞鐞嗗櫒锛堢‘淇?mock 鍏堟敞鍐岋級 =====\r\nconst importHandlers = async () => {\r\n    const completeRoute = await import('@/app/api/mobile/tasks/[id]/complete/route');\r\n    const installCheckInRoute = await import('@/app/api/mobile/tasks/[id]/install-check-in/route');\r\n    const installCompleteRoute = await import('@/app/api/mobile/tasks/[id]/install-complete/route');\r\n    const acceptRoute = await import('@/app/api/mobile/tasks/[id]/accept/route');\r\n    const installAcceptRoute = await import('@/app/api/mobile/tasks/[id]/install-accept/route');\r\n    return {\r\n        complete: completeRoute.POST,\r\n        installCheckIn: installCheckInRoute.POST,\r\n        installComplete: installCompleteRoute.POST,\r\n        accept: acceptRoute.POST,\r\n        installAccept: installAcceptRoute.POST\r\n    };\r\n};\r\n\r\ndescribe('绉诲姩绔?API 瀹¤鏃ュ織', () => {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    let handlers: Awaited<ReturnType<typeof importHandlers>>;\r\n    const mockSession = {\r\n        tenantId: 't1',\r\n        userId: 'u1',\r\n        role: 'WORKER',\r\n        traceId: 'trace-abc-123',\r\n        userAgent: 'MobileApp/1.0',\r\n        ipAddress: '192.168.1.100'\r\n    };\r\n\r\n    beforeEach(async () => {\r\n        vi.clearAllMocks();\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        (authenticateMobile as any).mockResolvedValue({ success: true, session: mockSession });\r\n        handlers = await importHandlers();\r\n    });\r\n\r\n    // ----- 娴嬭瘯1锛氫换鍔″畬宸?(complete) -----\r\n    it('浠诲姟瀹屽伐搴旇褰?COMPLETE_MOBILE 瀹¤鏃ュ織', async () => {\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        (db.query.measureTasks.findFirst as any).mockResolvedValue({\r\n            id: 'task-1', status: 'IN_PROGRESS', assignedWorkerId: 'u1', tenantId: 't1'\r\n        });\r\n\r\n        const req = new NextRequest('http://test/api/mobile/tasks/task-1/complete', {\r\n            method: 'POST',\r\n            body: JSON.stringify({})\r\n        });\r\n\r\n        await handlers.complete(req, { params: Promise.resolve({ id: 'task-1' }) });\r\n\r\n        expect(AuditService.log).toHaveBeenCalledWith(\r\n            expect.anything(),\r\n            expect.objectContaining({\r\n                action: 'COMPLETE_MOBILE',\r\n                traceId: 'trace-abc-123',\r\n                userAgent: 'MobileApp/1.0',\r\n                ipAddress: '192.168.1.100',\r\n            })\r\n        );\r\n    });\r\n\r\n    // ----- 娴嬭瘯2锛氬畨瑁呯鍒?(install-check-in) -----\r\n    it('瀹夎绛惧埌搴旇褰?INSTALL_CHECK_IN_MOBILE 瀹¤鏃ュ織', async () => {\r\n        // 杩斿洖鐘舵€佷负 PENDING_VISIT 涓?installerId 鍖归厤褰撳墠鐢ㄦ埛\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        (db.query.installTasks.findFirst as any).mockResolvedValue({\r\n            id: 'task-2', status: 'PENDING_VISIT', installerId: 'u1', tenantId: 't1'\r\n        });\r\n\r\n        const req = new NextRequest('http://test/api/mobile/tasks/task-2/install-check-in', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ latitude: 30.123, longitude: 120.456, accuracy: 10, address: '鏉窞甯傝タ婀栧尯' })\r\n        });\r\n\r\n        // install-check-in 鐨?POST 绛惧悕锛歅OST(request, { params })\r\n        await handlers.installCheckIn(req, { params: Promise.resolve({ id: 'task-2' }) });\r\n\r\n        expect(AuditService.log).toHaveBeenCalledWith(\r\n            expect.anything(),\r\n            expect.objectContaining({\r\n                action: 'INSTALL_CHECK_IN_MOBILE',\r\n                tableName: 'install_tasks',\r\n                recordId: 'task-2',\r\n                traceId: 'trace-abc-123',\r\n            })\r\n        );\r\n    });\r\n\r\n    // ----- 娴嬭瘯3锛氬畨瑁呭畬宸?(install-complete) -----\r\n    it('瀹夎瀹屽伐搴旇褰?INSTALL_COMPLETE_MOBILE 瀹¤鏃ュ織', async () => {\r\n        // 浠诲姟鐘舵€?IN_PROGRESS锛宨nstallerId 鍖归厤\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        (db.query.installTasks.findFirst as any).mockResolvedValue({\r\n            id: 'task-3', status: 'IN_PROGRESS', installerId: 'u1', tenantId: 't1'\r\n        });\r\n\r\n        const req = new NextRequest('http://test/api/mobile/tasks/task-3/install-complete', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ latitude: 30.1, longitude: 120.4, accuracy: 5, address: '鍦板潃' })\r\n        });\r\n\r\n        await handlers.installComplete(req, { params: Promise.resolve({ id: 'task-3' }) });\r\n\r\n        expect(AuditService.log).toHaveBeenCalledWith(\r\n            expect.anything(),\r\n            expect.objectContaining({\r\n                action: 'INSTALL_COMPLETE_MOBILE',\r\n                tableName: 'install_tasks',\r\n                recordId: 'task-3',\r\n                traceId: 'trace-abc-123',\r\n            })\r\n        );\r\n    });\r\n\r\n    // ----- 娴嬭瘯4锛氭祴閲忎换鍔℃帴鍗?(accept) -----\r\n    it('娴嬮噺浠诲姟鎺ュ崟搴旇褰?ACCEPT_TASK_MOBILE 瀹¤鏃ュ織', async () => {\r\n        // accept 璺敱鍏堟煡 measureTasks锛岄渶瑕?assignedWorkerId 鍖归厤 + 鐘舵€佷负 PENDING_ACCEPT\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        (db.query.measureTasks.findFirst as any).mockResolvedValue({\r\n            id: 'task-4', status: 'PENDING_ACCEPT', assignedWorkerId: 'u1', tenantId: 't1'\r\n        });\r\n\r\n        const req = new NextRequest('http://test/api/mobile/tasks/task-4/accept', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ accept: true })\r\n        });\r\n\r\n        // accept 璺敱绛惧悕锛歅OST(request, props: { params: Promise<{ id }> })\r\n        await handlers.accept(req, { params: Promise.resolve({ id: 'task-4' }) });\r\n\r\n        expect(AuditService.log).toHaveBeenCalledWith(\r\n            expect.anything(),\r\n            expect.objectContaining({\r\n                action: 'ACCEPT_TASK_MOBILE',\r\n                tableName: 'measure_tasks',\r\n                recordId: 'task-4',\r\n                traceId: 'trace-abc-123',\r\n            })\r\n        );\r\n    });\r\n\r\n    // ----- 娴嬭瘯5锛氬畨瑁呬换鍔℃嫆鍗?(install-accept) -----\r\n    it('瀹夎浠诲姟鎷掑崟搴旇褰?REJECT_TASK_MOBILE 瀹¤鏃ュ織', async () => {\r\n        // install-accept 璺敱锛歛ction 涓哄瓧绗︿覆 'accept' | 'reject'锛岀姸鎬侀渶涓?PENDING_ACCEPT\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        (db.query.installTasks.findFirst as any).mockResolvedValue({\r\n            id: 'task-5', status: 'PENDING_ACCEPT', installerId: 'u1', tenantId: 't1'\r\n        });\r\n\r\n        const req = new NextRequest('http://test/api/mobile/tasks/task-5/install-accept', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ action: 'reject', reason: '宸ユ湡鍐茬獊' })\r\n        });\r\n\r\n        await handlers.installAccept(req, { params: Promise.resolve({ id: 'task-5' }) });\r\n\r\n        expect(AuditService.log).toHaveBeenCalledWith(\r\n            expect.anything(),\r\n            expect.objectContaining({\r\n                action: 'REJECT_TASK_MOBILE',\r\n                tableName: 'install_tasks',\r\n                recordId: 'task-5',\r\n                traceId: 'trace-abc-123',\r\n            })\r\n        );\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\bigey\\Documents\\Antigravity\\L2C\\src\\features\\supply-chain\\components\\confirm-receipt-dialog.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\bigey\\Documents\\Antigravity\\L2C\\src\\features\\supply-chain\\components\\confirm-receipt-dialog.tsx:97:13\n   95 |     useEffect(() => {\n   96 |         if (open) {\n>  97 |             setLoadingWarehouses(true);\n      |             ^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n   98 |             getWarehouses()\n   99 |                 .then(res => {\n  100 |                     if (res.success && res.data) {","line":97,"column":13,"nodeType":null,"endLine":97,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { useForm, useFieldArray } from 'react-hook-form';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { z } from 'zod';\r\nimport { confirmPoReceipt, confirmReceiptSchema } from '../actions/po-actions';\r\nimport { getWarehouses } from '../actions/inventory-actions';\r\nimport { Button } from '@/shared/ui/button';\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogFooter,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from '@/shared/ui/dialog';\r\nimport { Input } from '@/shared/ui/input';\r\nimport { Label } from '@/shared/ui/label';\r\nimport { Textarea } from '@/shared/ui/textarea';\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from '@/shared/ui/select';\r\nimport {\r\n    Table,\r\n    TableBody,\r\n    TableCell,\r\n    TableHead,\r\n    TableHeader,\r\n    TableRow,\r\n} from '@/shared/ui/table';\r\nimport { toast } from 'sonner';\r\nimport Loader2 from 'lucide-react/dist/esm/icons/loader-2';\r\nimport { useRouter } from 'next/navigation';\r\nimport { format } from 'date-fns';\r\n\r\ntype ConfirmReceiptFormData = z.infer<typeof confirmReceiptSchema>;\r\n\r\ninterface Warehouse {\r\n    id: string;\r\n    name: string;\r\n}\r\n\r\ninterface ConfirmReceiptDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    po: {\r\n        id: string;\r\n        items: {\r\n            productId: string;\r\n            productName: string;\r\n            quantity: string | number;\r\n        }[];\r\n    };\r\n}\r\n\r\nexport function ConfirmReceiptDialog({\r\n    open,\r\n    onOpenChange,\r\n    po\r\n}: ConfirmReceiptDialogProps) {\r\n    const router = useRouter();\r\n    const [warehouses, setWarehouses] = useState<Warehouse[]>([]);\r\n    const [loadingWarehouses, setLoadingWarehouses] = useState(false);\r\n\r\n    const {\r\n        register,\r\n        control,\r\n        handleSubmit,\r\n        setValue,\r\n        formState: { errors, isSubmitting },\r\n        reset\r\n    } = useForm<ConfirmReceiptFormData>({\r\n        resolver: zodResolver(confirmReceiptSchema),\r\n        defaultValues: {\r\n            poId: po.id,\r\n            receivedDate: format(new Date(), 'yyyy-MM-dd HH:mm'),\r\n            remark: '',\r\n            items: po.items.map(item => ({\r\n                productId: item.productId,\r\n                quantity: Number(item.quantity)\r\n            }))\r\n        }\r\n    });\r\n\r\n    const { fields } = useFieldArray({\r\n        control,\r\n        name: \"items\"\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (open) {\r\n            setLoadingWarehouses(true);\r\n            getWarehouses()\r\n                .then(res => {\r\n                    if (res.success && res.data) {\r\n                        setWarehouses(res.data);\r\n                        // Default to first warehouse if available\r\n                        if (res.data.length > 0) {\r\n                            setValue('warehouseId', res.data[0].id);\r\n                        }\r\n                    }\r\n                })\r\n                .finally(() => setLoadingWarehouses(false));\r\n\r\n            reset({\r\n                poId: po.id,\r\n                receivedDate: format(new Date(), 'yyyy-MM-dd HH:mm'),\r\n                remark: '',\r\n                items: po.items.map(item => ({\r\n                    productId: item.productId,\r\n                    quantity: Number(item.quantity)\r\n                }))\r\n            });\r\n        }\r\n    }, [open, po, reset, setValue]);\r\n\r\n    const onSubmit = async (data: ConfirmReceiptFormData) => {\r\n        try {\r\n            const result = await confirmPoReceipt({\r\n                ...data,\r\n                // Ensure quantity is number\r\n                items: data.items.map(item => ({\r\n                    ...item,\r\n                    quantity: Number(item.quantity)\r\n                }))\r\n            });\r\n\r\n            if (!result.success) {\r\n                toast.error(result.error || '纭鏀惰揣澶辫触');\r\n                return;\r\n            }\r\n\r\n            toast.success('鏀惰揣宸茬‘璁わ紝搴撳瓨宸叉洿鏂?);\r\n            onOpenChange(false);\r\n            router.refresh();\r\n        } catch (error) {\r\n            toast.error('璇锋眰澶辫触');\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-[700px]\">\r\n                <DialogHeader>\r\n                    <DialogTitle>纭鏀惰揣鍏ュ簱</DialogTitle>\r\n                    <DialogDescription>\r\n                        璇风‘璁ゅ叆搴撲粨搴撳拰瀹炴敹鏁伴噺銆俓r\n                        <br />\r\n                        纭鍚庣姸鎬佸皢鏇翠负 <strong>宸插畬鎴?/strong>锛屽苟澧炲姞鐩稿簲搴撳瓨銆俓r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"warehouseId\">鍏ュ簱浠撳簱</Label>\r\n                            <Select\r\n                                onValueChange={(val) => setValue('warehouseId', val)}\r\n                                disabled={loadingWarehouses}\r\n                            >\r\n                                <SelectTrigger>\r\n                                    <SelectValue placeholder={loadingWarehouses ? \"鍔犺浇涓?..\" : \"閫夋嫨浠撳簱\"} />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {warehouses.map(warehouse => (\r\n                                        <SelectItem key={warehouse.id} value={warehouse.id}>\r\n                                            {warehouse.name}\r\n                                        </SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                            {errors.warehouseId && (\r\n                                <p className=\"text-sm text-red-500\">{errors.warehouseId.message}</p>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label htmlFor=\"receivedDate\">鏀惰揣鏃堕棿</Label>\r\n                            <Input\r\n                                id=\"receivedDate\"\r\n                                type=\"datetime-local\"\r\n                                {...register('receivedDate')}\r\n                            />\r\n                            {errors.receivedDate && (\r\n                                <p className=\"text-sm text-red-500\">{errors.receivedDate.message}</p>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2 max-h-[300px] overflow-y-auto border rounded-md\">\r\n                        <Table>\r\n                            <TableHeader>\r\n                                <TableRow>\r\n                                    <TableHead>鍟嗗搧</TableHead>\r\n                                    <TableHead className=\"w-[100px]\">閲囪喘鏁伴噺</TableHead>\r\n                                    <TableHead className=\"w-[120px]\">瀹炴敹鏁伴噺</TableHead>\r\n                                </TableRow>\r\n                            </TableHeader>\r\n                            <TableBody>\r\n                                {fields.map((field, index) => {\r\n                                    const orderedItem = po.items.find(i => i.productId === field.productId);\r\n                                    return (\r\n                                        <TableRow key={field.id}>\r\n                                            <TableCell className=\"font-medium\">\r\n                                                {orderedItem?.productName || '鏈煡鍟嗗搧'}\r\n                                            </TableCell>\r\n                                            <TableCell>\r\n                                                {Number(orderedItem?.quantity || 0)}\r\n                                            </TableCell>\r\n                                            <TableCell>\r\n                                                <Input\r\n                                                    type=\"number\"\r\n                                                    min=\"0\"\r\n                                                    step=\"1\"\r\n                                                    className=\"h-8\"\r\n                                                    {...register(`items.${index}.quantity`, { valueAsNumber: true })}\r\n                                                />\r\n                                            </TableCell>\r\n                                        </TableRow>\r\n                                    );\r\n                                })}\r\n                            </TableBody>\r\n                        </Table>\r\n                        {errors.items && (\r\n                            <p className=\"text-sm text-red-500 px-4 py-2\">璇锋鏌ュ叆搴撴暟閲?/p>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"remark\">澶囨敞</Label>\r\n                        <Textarea\r\n                            id=\"remark\"\r\n                            rows={2}\r\n                            placeholder=\"濉啓鏀惰揣澶囨敞...\"\r\n                            {...register('remark')}\r\n                        />\r\n                        {errors.remark && (\r\n                            <p className=\"text-sm text-red-500\">{errors.remark.message}</p>\r\n                        )}\r\n                    </div>\r\n\r\n                    <DialogFooter>\r\n                        <Button type=\"button\" variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n                            鍙栨秷\r\n                        </Button>\r\n                        <Button type=\"submit\" disabled={isSubmitting}>\r\n                            {isSubmitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                            纭鍏ュ簱\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </form>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]}]
