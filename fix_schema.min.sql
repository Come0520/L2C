ALTER TABLE "market_channels" ADD COLUMN "code" varchar(50); ALTER TABLE "market_channels" ADD COLUMN "sort_order" integer DEFAULT 0; ALTER TABLE "market_channels" ADD COLUMN "cooperation_mode" varchar(20) DEFAULT 'REBATE'; ALTER TABLE "market_channels" ADD COLUMN "commission_rate" numeric(5, 4) DEFAULT '0.1'; CREATE TABLE IF NOT EXISTS "product_price_history" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "product_id" uuid NOT NULL, "supplier_id" uuid, "channel_id" uuid, "price_type" varchar(20) NOT NULL, "old_price" numeric(12, 2), "new_price" numeric(12, 2), "effective_date" timestamp with time zone, "change_type" varchar(50) NOT NULL, "reason" text, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "product_price_history_pkey" PRIMARY KEY ("id") ); ALTER TABLE "products" ADD COLUMN "product_type" product_type NOT NULL DEFAULT 'FINISHED'; ALTER TABLE "products" ADD COLUMN "images" jsonb DEFAULT '[]'::jsonb; ALTER TABLE "products" ADD COLUMN "stock_unit" varchar(20); ALTER TABLE "products" ADD COLUMN "sales_unit" varchar(20); ALTER TABLE "products" ADD COLUMN "conversion_rate" numeric(10, 4); CREATE TABLE IF NOT EXISTS "customer_merge_logs" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "primary_customer_id" uuid NOT NULL, "merged_customer_ids" uuid[] NOT NULL, "operator_id" uuid NOT NULL, "field_conflicts" jsonb, "affected_tables" text[], "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "customer_merge_logs_pkey" PRIMARY KEY ("id") ); ALTER TABLE "customers" ADD COLUMN "wechat_openid" varchar(100); ALTER TABLE "customers" ADD COLUMN "updated_by" uuid; CREATE TABLE IF NOT EXISTS "phone_view_logs" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "customer_id" uuid NOT NULL, "viewer_id" uuid NOT NULL, "viewer_role" varchar(50) NOT NULL, "ip_address" varchar(50), "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "phone_view_logs_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "customer_addresses" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "customer_id" uuid NOT NULL, "label" varchar(50), "province" varchar(50), "city" varchar(50), "district" varchar(50), "community" varchar(100), "address" varchar(255) NOT NULL, "is_default" boolean DEFAULT false, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "customer_addresses_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "lead_activities" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "lead_id" uuid NOT NULL, "quote_id" uuid, "purchase_intention" intention_level, "customer_level" varchar(20), "activity_type" lead_activity_type NOT NULL, "content" text NOT NULL, "location" varchar(200), "next_followup_date" timestamp with time zone, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "lead_activities_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "lead_status_history" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "lead_id" uuid NOT NULL, "old_status" varchar(50), "new_status" varchar(50) NOT NULL, "changed_by" uuid, "changed_at" timestamp with time zone DEFAULT now(), "reason" text, CONSTRAINT "lead_status_history_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "leads" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "lead_no" varchar(50) NOT NULL, "customer_name" varchar(50) NOT NULL, "customer_phone" varchar(20) NOT NULL, "customer_wechat" varchar(50), "address" text, "community" varchar(100), "house_type" varchar(50), "status" lead_status DEFAULT 'PENDING_ASSIGNMENT', "intention_level" intention_level, "channel_id" uuid, "channel_contact_id" uuid, "source_channel_id" uuid, "source_sub_id" uuid, "distribution_rule_id" uuid, "source_detail" varchar(100), "url_params" jsonb, "referrer_name" varchar(100), "referrer_customer_id" uuid, "estimated_amount" numeric(12, 2), "tags" text[], "notes" text, "lost_reason" text, "external_id" varchar(100), "assigned_sales_id" uuid, "assigned_at" timestamp with time zone, "last_activity_at" timestamp with time zone, "next_followup_at" timestamp with time zone, "next_followup_recommendation" timestamp with time zone, "decoration_progress" decoration_progress, "quoted_at" timestamp with time zone, "visited_store_at" timestamp with time zone, "won_at" timestamp with time zone, "customer_id" uuid, "created_by" uuid NOT NULL, "updated_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "deleted_at" timestamp with time zone, CONSTRAINT "leads_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "channel_categories" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "name" varchar(50) NOT NULL, "code" varchar(50) NOT NULL, "description" text, "is_active" boolean DEFAULT true, "sort_order" integer DEFAULT 0, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "channel_categories_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "channel_commissions" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "channel_id" uuid NOT NULL, "lead_id" uuid, "order_id" uuid, "commission_type" cooperation_mode, "order_amount" numeric(15, 2), "commission_rate" numeric(5, 4), "amount" numeric(15, 2) NOT NULL, "status" varchar(20) DEFAULT 'PENDING', "settlement_id" uuid, "formula" jsonb, "remark" text, "settled_at" timestamp with time zone, "settled_by" uuid, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "channel_commissions_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "channel_contacts" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "channel_id" uuid NOT NULL, "name" varchar(100) NOT NULL, "position" varchar(50), "phone" varchar(20) NOT NULL, "is_main" boolean DEFAULT false, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "channel_contacts_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "channel_settlements" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "settlement_no" varchar(50) NOT NULL, "channel_id" uuid NOT NULL, "period_start" timestamp with time zone NOT NULL, "period_end" timestamp with time zone NOT NULL, "total_commission" numeric(15, 2) NOT NULL, "adjustment_amount" numeric(15, 2) DEFAULT '0', "final_amount" numeric(15, 2) NOT NULL, "status" varchar(20) DEFAULT 'DRAFT', "payment_bill_id" uuid, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "approved_by" uuid, "approved_at" timestamp with time zone, "paid_at" timestamp with time zone, CONSTRAINT "channel_settlements_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "channels" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "parent_id" uuid, "hierarchy_level" integer NOT NULL DEFAULT 1, "category_id" uuid, "category" channel_category NOT NULL DEFAULT 'OFFLINE', "channel_type" channel_type NOT NULL, "name" varchar(100) NOT NULL, "code" varchar(50) NOT NULL, "level" channel_level NOT NULL DEFAULT 'C', "contact_name" varchar(100) NOT NULL, "phone" varchar(20) NOT NULL, "commission_rate" numeric(5, 2) NOT NULL, "commission_type" commission_type, "tiered_rates" jsonb, "cooperation_mode" cooperation_mode NOT NULL, "price_discount_rate" numeric(5, 4), "settlement_type" channel_settlement_type NOT NULL, "credit_limit" numeric(15, 2) DEFAULT '0', "commission_trigger_mode" commission_trigger_mode DEFAULT 'PAYMENT_COMPLETED', "bank_info" jsonb, "contract_files" jsonb, "total_leads" integer DEFAULT 0, "total_deal_amount" numeric(15, 2) DEFAULT '0', "status" channel_status DEFAULT 'ACTIVE', "assigned_manager_id" uuid, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "channels_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "commission_adjustments" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "channel_id" uuid NOT NULL, "original_commission_id" uuid NOT NULL, "adjustment_type" varchar(20) NOT NULL, "adjustment_amount" numeric(15, 2) NOT NULL, "reason" text NOT NULL, "order_id" uuid, "refund_amount" numeric(15, 2), "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "commission_adjustments_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "quote_id" uuid NOT NULL, "parent_id" uuid, "room_id" uuid, "category" varchar(50) NOT NULL, "product_id" uuid, "product_name" varchar(200) NOT NULL, "product_sku" varchar(100), "room_name" varchar(100), "unit" varchar(20), "unit_price" numeric(10, 2) NOT NULL, "cost_price" numeric(10, 2), "quantity" numeric(10, 2) NOT NULL, "width" numeric(10, 2), "height" numeric(10, 2), "fold_ratio" numeric(4, 2), "process_fee" numeric(10, 2), "subtotal" numeric(12, 2) NOT NULL, "attributes" jsonb DEFAULT '{}'::jsonb, "calculation_params" jsonb, "remark" text, "sort_order" integer DEFAULT 0, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "quote_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_plan_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "plan_id" uuid NOT NULL, "template_id" uuid NOT NULL, "override_price" numeric(10, 2), "role" varchar(50) NOT NULL, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "quote_plan_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_plans" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "code" varchar(50) NOT NULL, "name" varchar(100) NOT NULL, "description" text, "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "quote_plans_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_rooms" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "quote_id" uuid NOT NULL, "name" varchar(100) NOT NULL, "measure_room_id" uuid, "sort_order" integer DEFAULT 0, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "quote_rooms_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_template_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "template_id" uuid NOT NULL, "room_id" uuid, "parent_id" uuid, "category" varchar(50) NOT NULL, "product_id" uuid, "product_name" varchar(200) NOT NULL, "default_width" numeric(10, 2), "default_height" numeric(10, 2), "default_fold_ratio" numeric(4, 2), "unit_price" numeric(10, 2), "attributes" jsonb DEFAULT '{}'::jsonb, "sort_order" integer DEFAULT 0, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "quote_template_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_template_rooms" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "template_id" uuid NOT NULL, "name" varchar(100) NOT NULL, "sort_order" integer DEFAULT 0, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "quote_template_rooms_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_templates" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "name" varchar(200) NOT NULL, "description" text, "category" varchar(50), "tags" jsonb DEFAULT '[]'::jsonb, "source_quote_id" uuid, "is_public" boolean DEFAULT false, "is_active" boolean DEFAULT true, "created_by" uuid NOT NULL, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "quote_templates_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quotes" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "quote_no" varchar(50) NOT NULL, "customer_id" uuid NOT NULL, "lead_id" uuid, "measure_variant_id" uuid, "bundle_id" uuid, "root_quote_id" uuid, "parent_quote_id" uuid, "is_active" boolean DEFAULT true, "title" varchar(200), "total_amount" numeric(12, 2) DEFAULT '0', "discount_rate" numeric(5, 4), "discount_amount" numeric(12, 2) DEFAULT '0', "final_amount" numeric(12, 2) DEFAULT '0', "min_profit_margin" numeric(5, 4), "status" quote_status DEFAULT 'DRAFT', "version" integer NOT NULL DEFAULT 1, "valid_until" timestamp with time zone, "notes" text, "approval_required" boolean DEFAULT false, "approver_id" uuid, "approved_at" timestamp with time zone, "reject_reason" text, "locked_at" timestamp with time zone, "customer_signature_url" text, "confirmed_at" timestamp with time zone, "created_by" uuid NOT NULL, "updated_by" uuid, "archived_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "deleted_at" timestamp with time zone, CONSTRAINT "quotes_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "order_changes" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "order_id" uuid NOT NULL, "type" change_request_type NOT NULL, "reason" text NOT NULL, "status" change_request_status DEFAULT 'PENDING', "diff_amount" numeric(12, 2) DEFAULT '0', "original_data" jsonb, "new_data" jsonb, "requested_by" uuid, "approved_by" uuid, "approved_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "order_changes_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "order_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "order_id" uuid NOT NULL, "quote_item_id" uuid NOT NULL, "room_name" varchar(100) NOT NULL, "product_id" uuid NOT NULL, "product_name" varchar(200) NOT NULL, "category" product_category NOT NULL, "quantity" numeric(10, 2) NOT NULL, "width" numeric(10, 2), "height" numeric(10, 2), "unit_price" numeric(10, 2) NOT NULL, "subtotal" numeric(12, 2) NOT NULL, "po_id" uuid, "supplier_id" uuid, "status" order_item_status DEFAULT 'PENDING', "remark" text, "sort_order" integer DEFAULT 0, "attributes" jsonb DEFAULT '{}'::jsonb, "calculation_params" jsonb, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "order_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "orders" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "order_no" varchar(50) NOT NULL, "quote_id" uuid NOT NULL, "quote_version_id" uuid NOT NULL, "lead_id" uuid, "channel_id" uuid, "channel_contact_id" uuid, "channel_cooperation_mode" cooperation_mode, "customer_id" uuid NOT NULL, "customer_name" varchar(100), "customer_phone" varchar(20), "delivery_address" text, "total_amount" numeric(12, 2) DEFAULT '0', "paid_amount" numeric(12, 2) DEFAULT '0', "balance_amount" numeric(12, 2) DEFAULT '0', "settlement_type" order_settlement_type NOT NULL, "confirmation_img" text, "payment_proof_img" text, "payment_amount" numeric(12, 2), "payment_method" payment_method, "payment_time" timestamp with time zone, "prepaid_payment_id" uuid, "status" order_status DEFAULT 'DRAFT', "is_locked" boolean DEFAULT false, "locked_at" timestamp with time zone, "sales_id" uuid, "remark" text, "snapshot_data" jsonb, "quote_snapshot" jsonb, "logistics" jsonb, "created_by" uuid NOT NULL, "updated_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "completed_at" timestamp with time zone, "closed_at" timestamp with time zone, "paused_at" timestamp with time zone, "pause_reason" text, "pause_cumulative_days" integer DEFAULT 0, "deleted_at" timestamp with time zone, CONSTRAINT "orders_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "payment_schedules" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "order_id" uuid NOT NULL, "statement_id" uuid, "name" varchar(100) NOT NULL, "amount" numeric(12, 2) NOT NULL, "expected_date" date, "actual_date" date, "status" payment_schedule_status DEFAULT 'PENDING', "proof_img" text, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "payment_schedules_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "channel_discount_overrides" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "scope" varchar(20) NOT NULL, "target_id" varchar(100) NOT NULL, "target_name" varchar(200), "s_level_discount" numeric(5, 2), "a_level_discount" numeric(5, 2), "b_level_discount" numeric(5, 2), "c_level_discount" numeric(5, 2), "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "channel_discount_overrides_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "channel_specific_prices" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "product_id" uuid NOT NULL, "channel_id" uuid NOT NULL, "special_price" numeric(12, 2) NOT NULL, "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "channel_specific_prices_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "fabric_inventory" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "fabric_product_id" uuid NOT NULL, "fabric_sku" varchar(100) NOT NULL, "fabric_name" varchar(200) NOT NULL, "fabric_color" varchar(50), "fabric_width" numeric(10, 2), "fabric_roll_length" numeric(10, 2), "batch_no" varchar(50), "purchase_order_id" uuid, "supplier_id" uuid, "available_quantity" numeric(12, 2) NOT NULL, "reserved_quantity" numeric(12, 2) DEFAULT '0', "total_quantity" numeric(12, 2) NOT NULL, "purchase_date" timestamp with time zone, "expiry_date" timestamp with time zone, "warehouse_location" varchar(100), "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "fabric_inventory_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "fabric_inventory_logs" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "fabric_inventory_id" uuid NOT NULL, "log_type" fabric_inventory_log_type NOT NULL, "quantity" numeric(12, 2) NOT NULL, "before_quantity" numeric(12, 2) NOT NULL, "after_quantity" numeric(12, 2) NOT NULL, "reference_id" uuid, "reference_type" varchar(50), "remark" text, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "fabric_inventory_logs_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "package_products" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "package_id" uuid NOT NULL, "product_id" uuid NOT NULL, "is_required" boolean DEFAULT false, "min_quantity" numeric(10, 2), "max_quantity" numeric(10, 2), "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "package_products_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "product_bundle_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "bundle_id" uuid NOT NULL, "product_id" uuid NOT NULL, "quantity" numeric(10, 2) NOT NULL, "unit" varchar(20), "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "product_bundle_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "product_bundles" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "bundle_sku" varchar(50) NOT NULL, "bundle_name" varchar(200) NOT NULL, "category" varchar(50), "retail_price" numeric(12, 2) DEFAULT '0', "channel_price" numeric(12, 2) DEFAULT '0', "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "product_bundles_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "product_packages" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "package_no" varchar(50) NOT NULL, "package_name" varchar(200) NOT NULL, "package_type" package_type NOT NULL, "package_price" numeric(12, 2) NOT NULL, "original_price" numeric(12, 2), "description" text, "rules" jsonb DEFAULT '{}'::jsonb, "overflow_mode" package_overflow_mode DEFAULT 'DISCOUNT', "overflow_price" numeric(12, 2), "overflow_discount_rate" numeric(5, 4), "is_active" boolean DEFAULT true, "start_date" timestamp with time zone, "end_date" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "product_packages_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "product_suppliers" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "product_id" uuid NOT NULL, "supplier_id" uuid NOT NULL, "is_default" boolean DEFAULT false, "purchase_price" numeric(12, 2), "logistics_cost" numeric(12, 2), "processing_cost" numeric(12, 2), "lead_time_days" integer DEFAULT 7, "min_order_quantity" numeric(10, 2), "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "product_suppliers_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "production_tasks" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "task_no" varchar(50) NOT NULL, "order_id" uuid NOT NULL, "order_item_id" uuid, "workshop" varchar(50) NOT NULL, "status" varchar(50) DEFAULT 'PENDING', "assigned_worker_id" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "production_tasks_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "purchase_order_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "po_id" uuid NOT NULL, "order_item_id" uuid, "product_id" uuid, "product_sku" varchar(100), "category" varchar(50), "product_name" varchar(200) NOT NULL, "quantity" numeric(10, 2) NOT NULL, "unit_price" numeric(10, 2) DEFAULT '0', "width" numeric(10, 2), "height" numeric(10, 2), "subtotal" numeric(12, 2), "quote_item_id" uuid, "remark" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "purchase_order_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "purchase_orders" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "po_no" varchar(50) NOT NULL, "order_id" uuid, "after_sales_id" uuid, "supplier_id" uuid NOT NULL, "supplier_name" varchar(100) NOT NULL, "type" po_type DEFAULT 'FINISHED', "split_rule_id" uuid, "status" purchase_order_status DEFAULT 'DRAFT', "total_amount" numeric(12, 2) DEFAULT '0', "external_po_no" varchar(100), "supplier_quote_img" text, "sent_method" varchar(20), "sent_at" timestamp with time zone, "produced_at" timestamp with time zone, "logistics_company" varchar(50), "logistics_no" varchar(100), "shipped_at" timestamp with time zone, "delivered_at" timestamp with time zone, "payment_status" payment_status DEFAULT 'PENDING', "expected_date" timestamp with time zone, "remark" text, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "purchase_orders_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "split_route_rules" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "priority" integer DEFAULT 0, "name" varchar(100) NOT NULL, "conditions" jsonb NOT NULL DEFAULT '[]'::jsonb, "target_type" varchar(50) NOT NULL, "target_supplier_id" uuid, "is_active" boolean DEFAULT true, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "split_route_rules_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "suppliers" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "supplier_no" varchar(50) NOT NULL, "name" varchar(200) NOT NULL, "supplier_type" supplier_type DEFAULT 'SUPPLIER', "contact_person" varchar(100), "phone" varchar(50), "payment_period" varchar(50) DEFAULT 'CASH', "is_active" boolean DEFAULT true, "address" text, "remark" text, "processing_prices" jsonb, "contract_url" text, "contract_expiry_date" timestamp with time zone, "business_license_url" text, "bank_account" varchar(100), "bank_name" varchar(100), "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "suppliers_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "work_order_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "wo_id" uuid NOT NULL, "order_item_id" uuid NOT NULL, "status" work_order_item_status DEFAULT 'PENDING', "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "work_order_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "work_orders" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "wo_no" varchar(50) NOT NULL, "order_id" uuid NOT NULL, "po_id" uuid NOT NULL, "supplier_id" uuid NOT NULL, "status" work_order_status DEFAULT 'PENDING', "start_at" timestamp with time zone, "completed_at" timestamp with time zone, "remark" text, "created_by" uuid NOT NULL, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "deleted_at" timestamp with time zone, CONSTRAINT "work_orders_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "install_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "install_task_id" uuid NOT NULL, "order_item_id" uuid, "product_name" varchar(200) NOT NULL, "room_name" varchar(100), "quantity" numeric(12, 2) NOT NULL, "actual_installed_quantity" numeric(12, 2), "issue_category" install_item_issue_category DEFAULT 'NONE', "is_installed" boolean NOT NULL DEFAULT false, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "install_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "install_photos" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "install_task_id" uuid NOT NULL, "photo_type" install_photo_type NOT NULL, "photo_url" text NOT NULL, "room_name" varchar(100), "remark" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "install_photos_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "install_tasks" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "task_no" varchar(50) NOT NULL, "source_type" install_task_source_type NOT NULL DEFAULT 'ORDER', "order_id" uuid NOT NULL, "after_sales_id" uuid, "customer_id" uuid NOT NULL, "customer_name" varchar(100), "customer_phone" varchar(20), "address" text, "category" install_task_category NOT NULL DEFAULT 'CURTAIN', "status" install_task_status NOT NULL DEFAULT 'PENDING_DISPATCH', "sales_id" uuid, "dispatcher_id" uuid, "installer_id" uuid, "installer_name" varchar(100), "assigned_at" timestamp with time zone, "scheduled_date" timestamp with time zone, "scheduled_time_slot" varchar(50), "actual_start_at" timestamp with time zone, "actual_end_at" timestamp with time zone, "logistics_ready_status" boolean NOT NULL DEFAULT false, "check_in_at" timestamp with time zone, "check_in_location" jsonb, "check_out_at" timestamp with time zone, "check_out_location" jsonb, "customer_signature_url" text, "signed_at" timestamp with time zone, "labor_fee" numeric(12, 2), "actual_labor_fee" numeric(12, 2), "adjustment_reason" text, "fee_breakdown" jsonb, "checklist_status" jsonb, "field_discovery" jsonb, "rating" integer, "rating_comment" text, "remark" text, "notes" text, "reject_count" integer NOT NULL DEFAULT 0, "reject_reason" text, "confirmed_by" uuid, "confirmed_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "completed_at" timestamp with time zone, CONSTRAINT "install_tasks_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "measure_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "sheet_id" uuid NOT NULL, "room_name" varchar(100) NOT NULL, "window_type" window_type NOT NULL, "width" numeric(12, 2) NOT NULL, "height" numeric(12, 2) NOT NULL, "install_type" install_type, "bracket_dist" numeric(12, 2), "wall_material" wall_material, "has_box" boolean DEFAULT false, "box_depth" numeric(12, 2), "is_electric" boolean DEFAULT false, "remark" text, "segment_data" jsonb, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "measure_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "measure_sheets" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "task_id" uuid NOT NULL, "status" measure_sheet_status DEFAULT 'DRAFT', "round" integer NOT NULL, "variant" varchar(50) NOT NULL, "site_photos" jsonb, "sketch_map" text, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "measure_sheets_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "measure_task_splits" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "original_task_id" uuid NOT NULL, "new_task_id" uuid NOT NULL, "reason" text, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "measure_task_splits_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "measure_tasks" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "measure_no" varchar(50) NOT NULL, "lead_id" uuid NOT NULL, "customer_id" uuid NOT NULL, "status" measure_task_status DEFAULT 'PENDING', "scheduled_at" timestamp with time zone, "check_in_at" timestamp with time zone, "check_in_location" jsonb, "type" measure_type DEFAULT 'BLIND', "assigned_worker_id" uuid, "version_display" varchar(20), "parent_id" uuid, "round" integer NOT NULL DEFAULT 1, "remark" text, "reject_count" integer NOT NULL DEFAULT 0, "reject_reason" text, "is_fee_exempt" boolean DEFAULT false, "fee_check_status" fee_check_status DEFAULT 'NONE', "fee_approval_id" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "completed_at" timestamp with time zone, "deleted_at" timestamp with time zone, CONSTRAINT "measure_tasks_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "account_transactions" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "transaction_no" varchar(50) NOT NULL, "account_id" uuid NOT NULL, "transaction_type" varchar(20) NOT NULL, "amount" numeric(12, 2) NOT NULL, "balance_before" numeric(12, 2) NOT NULL, "balance_after" numeric(12, 2) NOT NULL, "related_type" varchar(50) NOT NULL, "related_id" uuid NOT NULL, "remark" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "account_transactions_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "ap_labor_fee_details" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "statement_id" uuid NOT NULL, "install_task_id" uuid, "install_task_no" varchar(50), "liability_notice_id" uuid, "liability_notice_no" varchar(50), "fee_type" varchar(20) NOT NULL, "description" varchar(200) NOT NULL, "calculation" varchar(200) NOT NULL, "amount" numeric(12, 2) NOT NULL, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "ap_labor_fee_details_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "ap_labor_statements" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "statement_no" varchar(50) NOT NULL, "worker_id" uuid NOT NULL, "worker_name" varchar(100) NOT NULL, "settlement_period" varchar(20) NOT NULL, "total_amount" numeric(12, 2) NOT NULL, "paid_amount" numeric(12, 2) NOT NULL DEFAULT '0', "pending_amount" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL, "completed_at" timestamp with time zone, "verified_by" uuid, "verified_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "ap_labor_statements_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "ap_supplier_statements" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "statement_no" varchar(50) NOT NULL, "purchase_order_id" uuid NOT NULL, "supplier_id" uuid NOT NULL, "supplier_name" varchar(100) NOT NULL, "total_amount" numeric(12, 2) NOT NULL, "paid_amount" numeric(12, 2) NOT NULL DEFAULT '0', "pending_amount" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL, "invoice_no" varchar(100), "invoiced_at" timestamp with time zone, "invoice_amount" numeric(12, 2), "tax_rate" numeric(5, 4), "tax_amount" numeric(12, 2), "is_tax_inclusive" boolean DEFAULT false, "completed_at" timestamp with time zone, "purchaser_id" uuid NOT NULL, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "ap_supplier_statements_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "ar_statements" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "statement_no" varchar(50) NOT NULL, "order_id" uuid NOT NULL, "customer_id" uuid NOT NULL, "customer_name" varchar(100) NOT NULL, "settlement_type" varchar(20) NOT NULL, "total_amount" numeric(12, 2) NOT NULL, "received_amount" numeric(12, 2) NOT NULL DEFAULT '0', "pending_amount" numeric(12, 2) NOT NULL, "status" ar_statement_status NOT NULL, "invoice_no" varchar(100), "invoiced_at" timestamp with time zone, "tax_rate" numeric(5, 4), "tax_amount" numeric(12, 2), "is_tax_inclusive" boolean DEFAULT false, "completed_at" timestamp with time zone, "sales_id" uuid NOT NULL, "channel_id" uuid, "commission_rate" numeric(5, 4), "commission_amount" numeric(12, 2), "commission_status" commission_status, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "ar_statements_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "commission_records" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "commission_no" varchar(50) NOT NULL, "ar_statement_id" uuid NOT NULL, "order_id" uuid NOT NULL, "channel_id" uuid NOT NULL, "channel_name" varchar(100) NOT NULL, "cooperation_mode" varchar(20) NOT NULL, "order_amount" numeric(12, 2) NOT NULL, "commission_rate" numeric(5, 4) NOT NULL, "commission_amount" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL, "calculated_at" timestamp with time zone, "paid_at" timestamp with time zone, "remark" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "commission_records_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "credit_notes" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "credit_note_no" varchar(50) NOT NULL, "customer_id" uuid NOT NULL, "customer_name" varchar(100) NOT NULL, "order_id" uuid, "ar_statement_id" uuid, "type" varchar(20) NOT NULL, "amount" numeric(12, 2) NOT NULL, "reason" varchar(200) NOT NULL, "description" text, "status" varchar(20) NOT NULL DEFAULT 'DRAFT', "applied_at" timestamp with time zone, "created_by" uuid NOT NULL, "approved_by" uuid, "approved_at" timestamp with time zone, "remark" text, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "credit_notes_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "debit_notes" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "debit_note_no" varchar(50) NOT NULL, "supplier_id" uuid NOT NULL, "supplier_name" varchar(100) NOT NULL, "purchase_order_id" uuid, "ap_statement_id" uuid, "type" varchar(20) NOT NULL, "amount" numeric(12, 2) NOT NULL, "reason" varchar(200) NOT NULL, "description" text, "status" varchar(20) NOT NULL DEFAULT 'DRAFT', "applied_at" timestamp with time zone, "created_by" uuid NOT NULL, "approved_by" uuid, "approved_at" timestamp with time zone, "remark" text, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "debit_notes_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "finance_accounts" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "account_no" varchar(50) NOT NULL, "account_name" varchar(100) NOT NULL, "account_type" varchar(20) NOT NULL, "account_number" varchar(100), "bank_name" varchar(100), "branch_name" varchar(100), "holder_name" varchar(100) NOT NULL, "balance" numeric(12, 2) NOT NULL DEFAULT '0', "is_active" boolean DEFAULT true, "is_default" boolean DEFAULT false, "remark" text, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "finance_accounts_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "finance_configs" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "config_key" varchar(100) NOT NULL, "config_value" text NOT NULL, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "finance_configs_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "internal_transfers" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "transfer_no" varchar(50) NOT NULL, "from_account_id" uuid NOT NULL, "to_account_id" uuid NOT NULL, "amount" numeric(12, 2) NOT NULL, "from_transaction_id" uuid, "to_transaction_id" uuid, "status" varchar(20) NOT NULL DEFAULT 'PENDING', "remark" text, "created_by" uuid NOT NULL, "approved_by" uuid, "approved_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "internal_transfers_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "payment_bill_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "payment_bill_id" uuid NOT NULL, "statement_type" varchar(50) NOT NULL, "statement_id" uuid NOT NULL, "statement_no" varchar(50) NOT NULL, "amount" numeric(12, 2) NOT NULL, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "payment_bill_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "payment_bills" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "payment_no" varchar(50) NOT NULL, "type" varchar(20) DEFAULT 'SUPPLIER', "payee_type" varchar(20) NOT NULL, "payee_id" uuid NOT NULL, "payee_name" varchar(100) NOT NULL, "order_id" uuid, "amount" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL, "payment_method" varchar(20) NOT NULL, "account_id" uuid, "proof_url" text NOT NULL, "paid_at" timestamp with time zone, "recorded_by" uuid NOT NULL, "remark" text, "is_verified" boolean DEFAULT false, "verified_by" uuid, "verified_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "payment_bills_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "payment_order_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "payment_order_id" uuid NOT NULL, "order_id" uuid NOT NULL, "statement_id" uuid, "schedule_id" uuid, "order_no" varchar(50) NOT NULL, "amount" numeric(12, 2) NOT NULL, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "payment_order_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "payment_orders" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "payment_no" varchar(50) NOT NULL, "type" varchar(20) NOT NULL, "customer_id" uuid, "customer_name" varchar(100) NOT NULL, "customer_phone" varchar(20) NOT NULL, "total_amount" numeric(12, 2) NOT NULL, "used_amount" numeric(12, 2) NOT NULL DEFAULT '0', "remaining_amount" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL, "payment_method" varchar(20) NOT NULL, "account_id" uuid, "proof_url" text NOT NULL, "received_at" timestamp with time zone NOT NULL, "remark" text, "created_by" uuid NOT NULL, "verified_by" uuid, "verified_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "payment_orders_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "receipt_bill_items" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "receipt_bill_id" uuid NOT NULL, "order_id" uuid NOT NULL, "statement_id" uuid, "schedule_id" uuid, "order_no" varchar(50) NOT NULL, "amount" numeric(12, 2) NOT NULL, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "receipt_bill_items_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "receipt_bills" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "receipt_no" varchar(50) NOT NULL, "type" varchar(20) NOT NULL, "customer_id" uuid, "customer_name" varchar(100) NOT NULL, "customer_phone" varchar(20) NOT NULL, "total_amount" numeric(12, 2) NOT NULL, "used_amount" numeric(12, 2) NOT NULL DEFAULT '0', "remaining_amount" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL, "payment_method" varchar(20) NOT NULL, "account_id" uuid, "proof_url" text NOT NULL, "received_at" timestamp with time zone NOT NULL, "remark" text, "created_by" uuid NOT NULL, "verified_by" uuid, "verified_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "receipt_bills_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "reconciliation_details" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "reconciliation_id" uuid NOT NULL, "document_type" varchar(50) NOT NULL, "document_id" uuid NOT NULL, "document_no" varchar(50) NOT NULL, "document_amount" numeric(12, 2) NOT NULL, "reconciliation_amount" numeric(12, 2) NOT NULL, "difference" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL, "remark" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "reconciliation_details_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "reconciliations" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "reconciliation_no" varchar(50) NOT NULL, "reconciliation_type" varchar(20) NOT NULL, "target_type" varchar(20) NOT NULL, "target_id" uuid NOT NULL, "target_name" varchar(100) NOT NULL, "total_amount" numeric(12, 2) NOT NULL, "matched_amount" numeric(12, 2) NOT NULL DEFAULT '0', "unmatched_amount" numeric(12, 2) NOT NULL DEFAULT '0', "status" varchar(20) NOT NULL, "reconciled_at" timestamp with time zone, "confirmed_by" uuid, "confirmed_at" timestamp with time zone, "completed_at" timestamp with time zone, "remark" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "reconciliations_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "statement_confirmation_details" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "confirmation_id" uuid NOT NULL, "document_type" varchar(30) NOT NULL, "document_id" uuid NOT NULL, "document_no" varchar(50) NOT NULL, "document_date" date NOT NULL, "document_amount" numeric(12, 2) NOT NULL, "status" varchar(20) NOT NULL DEFAULT 'PENDING', "dispute_reason" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "statement_confirmation_details_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "statement_confirmations" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "confirmation_no" varchar(50) NOT NULL, "type" varchar(20) NOT NULL, "target_id" uuid NOT NULL, "target_name" varchar(100) NOT NULL, "period_start" date NOT NULL, "period_end" date NOT NULL, "period_label" varchar(50) NOT NULL, "total_amount" numeric(12, 2) NOT NULL, "confirmed_amount" numeric(12, 2) DEFAULT '0', "disputed_amount" numeric(12, 2) DEFAULT '0', "status" varchar(20) NOT NULL DEFAULT 'PENDING', "sent_at" timestamp with time zone, "confirmed_at" timestamp with time zone, "confirmed_by" varchar(100), "remark" text, "created_by" uuid NOT NULL, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "statement_confirmations_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "approval_delegations" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "delegator_id" uuid NOT NULL, "delegatee_id" uuid NOT NULL, "type" delegation_type DEFAULT 'GLOBAL', "flow_id" uuid, "start_time" timestamp with time zone NOT NULL, "end_time" timestamp with time zone NOT NULL, "reason" text, "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "approval_delegations_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "approval_flows" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "code" varchar(50) NOT NULL, "name" varchar(100) NOT NULL, "description" text, "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "definition" jsonb DEFAULT '{"nodes":[],"edges":[]}'::jsonb, CONSTRAINT "approval_flows_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "approval_nodes" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "flow_id" uuid NOT NULL, "name" varchar(100) NOT NULL, "approver_role" approver_role, "approver_user_id" uuid, "node_type" varchar(20) DEFAULT 'APPROVAL', "approver_mode" approval_node_mode DEFAULT 'ANY', "timeout_hours" integer, "timeout_action" approval_timeout_action DEFAULT 'REMIND', "min_amount" numeric(12, 2), "max_amount" numeric(12, 2), "conditions" jsonb DEFAULT '[]'::jsonb, "sort_order" integer DEFAULT 0, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "approval_nodes_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "approval_tasks" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "approval_id" uuid NOT NULL, "node_id" uuid, "approver_id" uuid, "status" varchar(50) DEFAULT 'PENDING', "comment" text, "is_dynamic" boolean DEFAULT false, "parent_task_id" uuid, "action_at" timestamp with time zone, "timeout_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "approval_tasks_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "approvals" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "flow_id" uuid, "entity_type" varchar(50) NOT NULL, "entity_id" uuid NOT NULL, "status" varchar(50) DEFAULT 'PENDING', "requester_id" uuid NOT NULL, "current_node_id" uuid, "comment" text, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "completed_at" timestamp with time zone, CONSTRAINT "approvals_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "after_sales_tickets" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "ticket_no" varchar(50) NOT NULL, "order_id" uuid NOT NULL, "customer_id" uuid NOT NULL, "install_task_id" uuid, "type" varchar(50) NOT NULL, "status" after_sales_status NOT NULL DEFAULT 'PENDING', "priority" varchar(20) DEFAULT 'MEDIUM', "description" text, "photos" text[], "resolution" text, "estimated_cost" numeric(12, 2), "total_actual_cost" numeric(12, 2) DEFAULT '0.00', "actual_deduction" numeric(12, 2) DEFAULT '0.00', "internal_loss" numeric(12, 2) DEFAULT '0.00', "is_warranty" boolean DEFAULT true, "satisfaction" integer, "channel_satisfaction" integer, "assigned_to" uuid, "created_by" uuid, "created_at" timestamp with time zone NOT NULL DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), "closed_at" timestamp with time zone, "sla_response_deadline" timestamp with time zone, "sla_visit_deadline" timestamp with time zone, "sla_closure_deadline" timestamp with time zone, CONSTRAINT "after_sales_tickets_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "liability_notices" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "notice_no" varchar(50) NOT NULL, "after_sales_id" uuid NOT NULL, "liable_party_type" liable_party_type NOT NULL, "liable_party_id" uuid, "liable_party_credit" jsonb, "reason" text NOT NULL, "liability_reason_category" liability_reason_category, "amount" numeric(12, 2) NOT NULL, "cost_items" jsonb, "source_purchase_order_id" uuid, "source_install_task_id" uuid, "status" liability_status NOT NULL DEFAULT 'DRAFT', "evidence_photos" text[], "confirmed_at" timestamp with time zone, "confirmed_by" uuid, "dispute_reason" text, "dispute_evidence" text[], "arbitration_result" text, "arbitrated_by" uuid, "arbitrated_at" timestamp with time zone, "finance_status" varchar(20) DEFAULT 'PENDING', "finance_statement_id" uuid, "finance_synced_at" timestamp with time zone, "created_at" timestamp with time zone NOT NULL DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "liability_notices_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "audit_logs" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "table_name" text NOT NULL, "record_id" text NOT NULL, "action" text NOT NULL, "user_id" uuid, "changed_fields" jsonb, "old_values" jsonb, "new_values" jsonb, "created_at" timestamp with time zone NOT NULL DEFAULT now(), CONSTRAINT "audit_logs_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "notification_preferences" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "user_id" uuid NOT NULL, "notification_type" varchar(50) NOT NULL, "channels" jsonb DEFAULT '[]'::jsonb, "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "notification_preferences_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "notification_queue" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "template_id" uuid, "template_code" varchar(50), "user_id" uuid, "target_phone" varchar(20), "target_email" varchar(100), "channel" varchar(20) NOT NULL, "title" varchar(200) NOT NULL, "content" text NOT NULL, "status" varchar(20) DEFAULT 'PENDING', "priority" varchar(20) DEFAULT 'NORMAL', "retry_count" varchar(10) DEFAULT '0', "max_retries" varchar(10) DEFAULT '3', "last_error" text, "scheduled_at" timestamp with time zone, "processed_at" timestamp with time zone, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "notification_queue_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "notification_templates" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid, "code" varchar(50) NOT NULL, "name" varchar(100) NOT NULL, "description" text, "notification_type" varchar(50) NOT NULL, "channels" jsonb DEFAULT '["IN_APP"]'::jsonb, "title_template" varchar(200) NOT NULL, "content_template" text NOT NULL, "sms_template" varchar(500), "wechat_template_id" varchar(100), "param_mapping" jsonb, "is_active" boolean DEFAULT true, "priority" varchar(20) DEFAULT 'NORMAL', "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "notification_templates_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "notifications" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "user_id" uuid NOT NULL, "title" varchar(200) NOT NULL, "content" text, "type" varchar(50) DEFAULT 'SYSTEM', "channel" varchar(20) DEFAULT 'IN_APP', "is_read" boolean DEFAULT false, "read_at" timestamp with time zone, "link_url" text, "metadata" jsonb, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "notifications_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "system_announcements" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid, "title" varchar(200) NOT NULL, "content" text NOT NULL, "type" varchar(50) DEFAULT 'INFO', "target_roles" jsonb, "start_at" timestamp with time zone NOT NULL, "end_at" timestamp with time zone, "is_pinned" boolean DEFAULT false, "created_by" uuid, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "system_announcements_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "loyalty_transactions" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "customer_id" uuid NOT NULL, "type" varchar(20) NOT NULL, "source" varchar(50) NOT NULL, "points" integer NOT NULL, "balance_after" integer NOT NULL, "reference_type" varchar(50), "reference_id" uuid, "description" text, "created_at" timestamp with time zone DEFAULT now(), "created_by" uuid, CONSTRAINT "loyalty_transactions_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "quote_config" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "type" text NOT NULL, "entity_id" uuid NOT NULL, "config" jsonb NOT NULL DEFAULT '{}', "updated_at" timestamp DEFAULT now(), "updated_by" uuid, CONSTRAINT "quote_config_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "inventory" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "warehouse_id" uuid NOT NULL, "product_id" uuid NOT NULL, "quantity" integer NOT NULL DEFAULT 0, "min_stock" integer DEFAULT 0, "location" text, "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "inventory_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "inventory_logs" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "warehouse_id" uuid NOT NULL, "product_id" uuid NOT NULL, "type" inventory_log_type NOT NULL, "quantity" integer NOT NULL, "balance_after" integer NOT NULL, "reason" text, "reference_type" text, "reference_id" uuid, "operator_id" uuid, "description" text, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "inventory_logs_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "warehouses" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "name" text NOT NULL, "address" text, "manager_id" uuid, "is_default" boolean DEFAULT false, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "warehouses_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "verification_codes" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "user_id" uuid NOT NULL, "phone" varchar(20) NOT NULL, "code" varchar(10) NOT NULL, "type" verification_code_type NOT NULL, "expires_at" timestamp with time zone NOT NULL, "used" boolean DEFAULT false, "created_at" timestamp with time zone DEFAULT now(), "ip" varchar(50), CONSTRAINT "verification_codes_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "labor_rates" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "entity_type" labor_rate_entity_type NOT NULL, "entity_id" uuid NOT NULL, "category" labor_category NOT NULL, "unit_price" numeric(10, 2) NOT NULL DEFAULT '0', "base_fee" numeric(10, 2) NOT NULL DEFAULT '0', "unit_type" labor_unit_type NOT NULL, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "labor_rates_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "worker_skills" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "worker_id" uuid NOT NULL, "skill_type" worker_skill_type NOT NULL, "created_at" timestamp with time zone DEFAULT now(), CONSTRAINT "worker_skills_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "system_settings_history" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "setting_id" uuid NOT NULL, "key" varchar(100) NOT NULL, "old_value" text, "new_value" text NOT NULL, "changed_by" uuid NOT NULL, "changed_at" timestamp with time zone DEFAULT now(), CONSTRAINT "system_settings_history_pkey" PRIMARY KEY ("id") ); CREATE TABLE IF NOT EXISTS "invitations" ( "id" uuid NOT NULL DEFAULT gen_random_uuid(), "tenant_id" uuid NOT NULL, "inviter_id" uuid NOT NULL, "code" varchar(10) NOT NULL, "role" varchar(50) NOT NULL, "expires_at" timestamp with time zone NOT NULL, "max_uses" varchar(10) DEFAULT '1', "used_count" varchar(10) DEFAULT '0', "is_active" boolean DEFAULT true, "created_at" timestamp with time zone DEFAULT now(), "updated_at" timestamp with time zone DEFAULT now(), CONSTRAINT "invitations_pkey" PRIMARY KEY ("id") );