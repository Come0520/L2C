version: '1.0'
name: L2C-Production-Deploy

sources:
  my_repo:
    type: codeup
    name: CodeupRepo
    endpoint: https://codeup.aliyun.com/697359d3b28d0aba0f5e4ff2/l2c.git
    branch: main
    trigger_events:
      - push

envs:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.15.0'

stages:
  # ============================================================
  # é˜¶æ®µ 1: è´¨é‡æ£€æŸ¥ (Quality Gate)
  # ============================================================
  - stage:
      name: quality-gate
      displayName: è´¨é‡æ£€æŸ¥
      steps:
        - step:
            name: lint-and-typecheck
            displayName: ESLint + TypeScript æ£€æŸ¥
            image: registry.cn-hangzhou.aliyuncs.com/flow-templates/node:20
            script:
              - echo "=== è´¨é‡æ£€æŸ¥å¼€å§‹ ==="
              - echo "Node $(node -v) | NPM $(npm -v)"

              - echo "å®‰è£… pnpm..."
              - npm install -g pnpm@${PNPM_VERSION}

              - echo "å®‰è£…ä¾èµ–..."
              - pnpm install --frozen-lockfile

              - echo "è¿è¡Œ ESLint..."
              - pnpm lint || { echo "âŒ ESLint æ£€æŸ¥å¤±è´¥"; exit 1; }

              - echo "è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
              - pnpm type-check || { echo "âŒ ç±»å‹æ£€æŸ¥å¤±è´¥"; exit 1; }

              - echo "âœ… è´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡"

  # ============================================================
  # é˜¶æ®µ 2: æ‰“åŒ…æºç å¹¶ä¸Šä¼  (Package & Upload)
  # ============================================================
  - stage:
      name: package-stage
      displayName: æ‰“åŒ…æºç 
      steps:
        - step:
            name: package-source
            displayName: æ‰“åŒ…ä¸ä¸Šä¼ 
            image: registry.cn-hangzhou.aliyuncs.com/flow-templates/node:20
            script:
              - echo "=== æ‰“åŒ…æºç  ==="

              - echo "ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
              - export GIT_COMMIT_SHA=$(git rev-parse --short HEAD)
              - export BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              - echo "Commit: $GIT_COMMIT_SHA | Time: $BUILD_TIME"

              - echo "ç”Ÿæˆç‰ˆæœ¬æ–‡ä»¶..."
              - mkdir -p public
              - echo "{\"sha\":\"$GIT_COMMIT_SHA\",\"time\":\"$BUILD_TIME\"}" > public/version.json

              # ç”Ÿæˆ .build-args æ–‡ä»¶ï¼Œä¾› ECS ä¸Š docker compose æ—¶ä½¿ç”¨
              - echo "GIT_COMMIT_SHA=$GIT_COMMIT_SHA" > .build-args
              - echo "BUILD_TIME=$BUILD_TIME" >> .build-args

              - echo "æ‰“åŒ…æºç  (æ’é™¤ node_modules/.next/.git)..."
              - tar -czf release.tar.gz \
                  --exclude='node_modules' \
                  --exclude='.next' \
                  --exclude='.git' \
                  --exclude='test-results' \
                  --exclude='playwright-report' \
                  --exclude='coverage' \
                  --exclude='*.log' \
                  .

              - echo "äº§ç‰©å¤§å°:"
              - ls -lh release.tar.gz

              - mv release.tar.gz $FLOW_ARTIFACT_PATH/
              - echo "âœ… æ‰“åŒ…å®Œæˆ"

            artifacts:
              - name: release-package
                path: ./release.tar.gz

  # ============================================================
  # é˜¶æ®µ 3: éƒ¨ç½²åˆ° ECS (Deploy)
  # ============================================================
  - stage:
      name: deploy-stage
      displayName: éƒ¨ç½²åˆ° ECS
      steps:
        - step:
            name: deploy-to-ecs
            displayName: å®‰å…¨éƒ¨ç½²
            image: registry.cn-hangzhou.aliyuncs.com/flow-templates/deploy:latest
            env:
              ECS_HOST: $ECS_HOST
              ECS_PASSWORD: $ECS_PASSWORD
              ECS_USER: root
            script:
              - echo "=== å¼€å§‹éƒ¨ç½²åˆ° $ECS_HOST ==="

              # å®‰è£… sshpass (å…¼å®¹ Debian/Ubuntu å’Œ Alpine)
              - if command -v apt-get >/dev/null; then apt-get update && apt-get install -y sshpass; elif command -v apk >/dev/null; then apk add --no-cache sshpass; else echo "Unable to install sshpass"; exit 1; fi

              # éªŒè¯ ECS_PASSWORD æ˜¯å¦å­˜åœ¨
              - if [ -z "$ECS_PASSWORD" ]; then echo "Error: ECS_PASSWORD variable is not set"; exit 1; fi

              # ä¸Šä¼ æºç åŒ…
              - echo "ä¸Šä¼ æºç åŒ…..."
              - sshpass -p "$ECS_PASSWORD" scp -o StrictHostKeyChecking=no $FLOW_ARTIFACT_PATH/release.tar.gz $ECS_USER@$ECS_HOST:/root/L2C/release.tar.gz

              # è¿œç¨‹éƒ¨ç½²è„šæœ¬
              - |
                sshpass -p "$ECS_PASSWORD" ssh -o StrictHostKeyChecking=no $ECS_USER@$ECS_HOST << 'DEPLOY_EOF'
                  set -e
                  cd /root/L2C

                  echo "ğŸ“¦ Step 1: å¤‡ä»½å½“å‰ .env..."
                  if [ -f .env ]; then
                    cp .env /root/.env.l2c_backup
                    echo "  âœ… .env å·²å¤‡ä»½åˆ° /root/.env.l2c_backup"
                  else
                    echo "  âš ï¸ æœªæ‰¾åˆ° .env æ–‡ä»¶ï¼éƒ¨ç½²åè¯·æ‰‹åŠ¨é…ç½®ã€‚"
                  fi

                  echo "ğŸ“¦ Step 2: ä¿ç•™ä¸Šä¸€ç‰ˆæœ¬ (å›æ»šç”¨)..."
                  if [ -f release.prev.tar.gz ]; then
                    rm -f release.prev.tar.gz
                  fi
                  if [ -f release.current.tar.gz ]; then
                    mv release.current.tar.gz release.prev.tar.gz
                    echo "  âœ… ä¸Šä¸€ç‰ˆæœ¬å·²ä¿å­˜ä¸º release.prev.tar.gz"
                  fi

                  echo "ğŸ“‚ Step 3: è§£å‹æºç ..."
                  tar -xzf release.tar.gz
                  mv release.tar.gz release.current.tar.gz

                  echo "ğŸ”’ Step 4: æ¢å¤ç¯å¢ƒå˜é‡..."
                  if [ -f /root/.env.l2c_backup ]; then
                    cp /root/.env.l2c_backup .env
                    echo "  âœ… .env å·²æ¢å¤"
                  fi

                  echo "ğŸ“ Step 5: æ³¨å…¥ç‰ˆæœ¬ä¿¡æ¯åˆ° docker-compose..."
                  if [ -f .build-args ]; then
                    source .build-args
                    export GIT_COMMIT_SHA BUILD_TIME
                    echo "  ç‰ˆæœ¬: $GIT_COMMIT_SHA | æ—¶é—´: $BUILD_TIME"
                  fi

                  echo "ğŸ³ Step 6: åœæ­¢æ—§å®¹å™¨..."
                  docker compose -f docker-compose.prod.yml down || true

                  echo "ğŸ³ Step 7: æ„å»ºå¹¶å¯åŠ¨æ–°å®¹å™¨ (å¤šé˜¶æ®µ Docker æ„å»º)..."
                  docker compose -f docker-compose.prod.yml up -d --build --force-recreate

                  echo "âœ… å®¹å™¨å·²å¯åŠ¨"
                DEPLOY_EOF

              - echo "âœ… éƒ¨ç½²è„šæœ¬æ‰§è¡Œå®Œæ¯•"

  # ============================================================
  # é˜¶æ®µ 4: éƒ¨ç½²éªŒè¯ (Smoke Test)
  # ============================================================
  - stage:
      name: verify-stage
      displayName: éƒ¨ç½²éªŒè¯
      steps:
        - step:
            name: smoke-test
            displayName: çƒŸé›¾æµ‹è¯•ä¸æ¸…ç†
            image: registry.cn-hangzhou.aliyuncs.com/flow-templates/deploy:latest
            env:
              ECS_HOST: $ECS_HOST
              ECS_PASSWORD: $ECS_PASSWORD
              ECS_USER: root
            script:
              - echo "=== éƒ¨ç½²éªŒè¯ ==="

              # å®‰è£… sshpass
              - if command -v apt-get >/dev/null; then apt-get update && apt-get install -y sshpass; elif command -v apk >/dev/null; then apk add --no-cache sshpass; else echo "Unable to install sshpass"; exit 1; fi

              # éªŒè¯ ECS_PASSWORD
              - if [ -z "$ECS_PASSWORD" ]; then echo "Error: ECS_PASSWORD variable is not set"; exit 1; fi

              - |
                sshpass -p "$ECS_PASSWORD" ssh -o StrictHostKeyChecking=no $ECS_USER@$ECS_HOST << 'VERIFY_EOF'
                  set -e
                  cd /root/L2C

                  echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨ (æœ€å¤š 120 ç§’)..."
                  HEALTHY=false
                  for i in $(seq 1 24); do
                    if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                      echo "  âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (ç¬¬ ${i} æ¬¡å°è¯•, è€—æ—¶çº¦ $((i*5)) ç§’)"
                      HEALTHY=true
                      break
                    fi
                    echo "  â³ ç­‰å¾…ä¸­... (${i}/24)"
                    sleep 5
                  done

                  if [ "$HEALTHY" = "false" ]; then
                    echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶ï¼æœ€è¿‘å®¹å™¨æ—¥å¿—:"
                    docker compose -f docker-compose.prod.yml logs --tail=80 app
                    exit 1
                  fi

                  echo ""
                  echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
                  docker compose -f docker-compose.prod.yml ps
                  echo ""

                  echo "ğŸ” HTTP çŠ¶æ€éªŒè¯:"
                  HTTP_CODE=$(curl -so /dev/null -w '%{http_code}' http://localhost:3000/api/health)
                  echo "  /api/health -> HTTP $HTTP_CODE"
                  if [ "$HTTP_CODE" != "200" ]; then
                    echo "  âŒ éé¢„æœŸçŠ¶æ€ç !"
                    exit 1
                  fi

                  echo ""
                  echo "ğŸ§¹ æ¸…ç†æ— ç”¨ Docker èµ„æº..."
                  docker image prune -f
                  docker builder prune -f --keep-storage=2GB || true

                  echo ""
                  echo "=== âœ… L2C éƒ¨ç½²éªŒè¯å®Œæˆ ==="
                VERIFY_EOF

              - echo "ğŸ‰ L2C éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
