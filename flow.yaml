variables:
  - key: PNPM_VERSION
    value: '9.15.0'

sources:
  codeup_source:
    type: codeup
    name: "Codeup 代码源"
    endpoint: https://codeup.aliyun.com/697359d3b28d0aba0f5e4ff2/l2c.git
    branch: main
    certificate:
      type: serviceConnection
      serviceConnection: "n91ncnbpmgw4ybzk"

# 代码提交自动触发流水线
triggers:
  push_trigger:
    name: "代码推送触发"
    type: push
    enabled: true
    branches:
      include:
        - main

stages:
  quality_gate:
    name: "质量检查"
    jobs:
      lint_job:
        name: "ESLint + TypeScript 检查"
        runsOn:
          group: public/cn-beijing
          container: build-steps-public-registry.cn-beijing.cr.aliyuncs.com/build-steps/alinux3:latest
        steps:
          lint_step:
            step: Command
            name: "代码质量检查"
            with:
              run: |
                echo "=== 质量检查开始 ==="
                # 使用 npmmirror 国内镜像安装 Node.js
                curl -fsSL https://npmmirror.com/mirrors/node/v20.19.0/node-v20.19.0-linux-x64.tar.xz -o node.tar.xz
                tar -xJf node.tar.xz -C /usr/local --strip-components=1
                rm -f node.tar.xz
                npm config set registry https://registry.npmmirror.com
                npm install -g pnpm@${PNPM_VERSION}
                echo "Node $(node -v) | pnpm $(pnpm -v)"
                pnpm config set registry https://registry.npmmirror.com
                pnpm install --frozen-lockfile
                echo "运行 ESLint..."
                pnpm lint || { echo "ESLint 检查失败"; exit 1; }
                echo "运行 TypeScript 类型检查..."
                pnpm type-check || { echo "类型检查失败"; exit 1; }
                echo "=== 质量检查通过 ==="

  deploy_stage:
    name: "构建与部署"
    jobs:
      deploy_job:
        name: "云效构建 → 镜像直传 → ECS 部署"
        runsOn:
          group: public/cn-beijing
          container: build-steps-public-registry.cn-beijing.cr.aliyuncs.com/build-steps/alinux3:latest
        steps:
          deploy_step:
            step: Command
            name: "构建镜像、传输并部署"
            with:
              run: |
                echo "=== 方案A：云效构建镜像 + 直传 ECS ==="

                # ========== 第一步：准备版本信息 ==========
                export GIT_COMMIT_SHA=$(git rev-parse --short HEAD)
                export BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                echo "Commit: $GIT_COMMIT_SHA | Time: $BUILD_TIME"
                mkdir -p public
                echo "{\"sha\":\"$GIT_COMMIT_SHA\",\"time\":\"$BUILD_TIME\"}" > public/version.json

                # ========== 第二步：在云效构建 Docker 镜像 ==========
                echo "=== 在云效 CI 上构建 Docker 镜像（不在 ECS 上构建）==="
                docker build \
                  --target runner \
                  --build-arg NEXT_PUBLIC_GIT_COMMIT_SHA="$GIT_COMMIT_SHA" \
                  --build-arg NEXT_PUBLIC_BUILD_TIME="$BUILD_TIME" \
                  -t l2c-app:latest \
                  -f Dockerfile .

                docker build \
                  --target migrator \
                  -t l2c-db-migrate:latest \
                  -f Dockerfile .

                echo "✅ 镜像构建完成"
                docker images | grep l2c

                # ========== 第三步：打包镜像为文件 ==========
                echo "=== 导出镜像为压缩文件 ==="
                docker save l2c-app:latest l2c-db-migrate:latest | gzip > /tmp/l2c-images.tar.gz
                ls -lh /tmp/l2c-images.tar.gz
                echo "✅ 镜像打包完成"

                # ========== 第四步：安装部署工具 ==========
                if command -v apt-get >/dev/null; then
                  apt-get update -qq && apt-get install -y -qq sshpass curl
                elif command -v yum >/dev/null; then
                  yum install -y sshpass curl
                elif command -v apk >/dev/null; then
                  apk add --no-cache sshpass curl
                else
                  echo "无法安装 sshpass"; exit 1
                fi

                # 检查环境变量
                if [ -z "$ECS_PASSWORD" ]; then echo "错误: ECS_PASSWORD 未设置"; exit 1; fi
                if [ -z "$ECS_HOST" ]; then echo "错误: ECS_HOST 未设置"; exit 1; fi

                # ========== 第五步：传输镜像和配置到 ECS ==========
                echo "=== 上传镜像到 ECS (这一步可能需要几分钟) ==="
                sshpass -p "$ECS_PASSWORD" scp -o StrictHostKeyChecking=no \
                  /tmp/l2c-images.tar.gz root@$ECS_HOST:/root/L2C/l2c-images.tar.gz

                # 同步 docker-compose 和 nginx 配置
                echo "=== 同步部署配置文件 ==="
                sshpass -p "$ECS_PASSWORD" scp -o StrictHostKeyChecking=no \
                  docker-compose.prod.yml root@$ECS_HOST:/root/L2C/docker-compose.prod.yml
                sshpass -p "$ECS_PASSWORD" scp -o StrictHostKeyChecking=no -r \
                  nginx root@$ECS_HOST:/root/L2C/
                sshpass -p "$ECS_PASSWORD" scp -o StrictHostKeyChecking=no \
                  drizzle.config.ts root@$ECS_HOST:/root/L2C/

                echo "✅ 文件传输完成"

                # ========== 第六步：远程部署 ==========
                sshpass -p "$ECS_PASSWORD" ssh -o StrictHostKeyChecking=no root@$ECS_HOST << 'DEPLOY_EOF'
                  set -e
                  cd /root/L2C

                  # 1. 停止旧容器
                  echo "=== 停止旧容器 ==="
                  docker compose -f docker-compose.prod.yml down || true

                  # 2. 清理空间
                  echo "=== 清理 Docker 缓存 ==="
                  docker system prune -f
                  docker builder prune -f

                  # 3. 加载预构建的镜像（核心步骤！不再在 ECS 上构建）
                  echo "=== 加载预构建镜像 ==="
                  docker load -i l2c-images.tar.gz
                  rm -f l2c-images.tar.gz
                  echo "✅ 镜像加载完成"
                  docker images | grep l2c

                  # 4. 执行数据库迁移（超时 120 秒）
                  echo "=== 执行数据库迁移 ==="
                  timeout 120 docker compose -f docker-compose.prod.yml run --rm db-migrate && {
                    echo "✅ 数据库迁移完成"
                  } || {
                    echo "⚠️ 数据库迁移跳过（可能已是最新），继续部署..."
                  }

                  # 5. 启动应用和 Nginx
                  echo "=== 启动应用 ==="
                  docker compose -f docker-compose.prod.yml up -d --force-recreate app nginx
                  echo "容器已启动，等待健康检查..."

                  # 6. 健康检查（最多等 3 分钟）
                  HEALTHY=false
                  for i in $(seq 1 36); do
                    if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                      echo "✅ 健康检查通过 (第 ${i} 次尝试)"
                      HEALTHY=true
                      break
                    fi
                    echo "  等待中... ($i/36)"
                    sleep 5
                  done

                  if [ "$HEALTHY" = "false" ]; then
                    echo "❌ 健康检查超时！"
                    echo "=== Docker 容器状态 ==="
                    docker compose -f docker-compose.prod.yml ps
                    echo "=== 最近容器日志 ==="
                    docker compose -f docker-compose.prod.yml logs --tail=80 app
                    exit 1
                  fi

                  # 7. 输出最终状态
                  docker compose -f docker-compose.prod.yml ps
                  docker image prune -f --filter "until=24h"
                  echo "=== L2C 部署成功完成 ==="
                DEPLOY_EOF
                echo "=== 流水线结束 ==="
