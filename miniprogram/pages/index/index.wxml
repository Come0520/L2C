<!--pages/index/index.wxml-->
<view class="container index-page">

  <!-- ============================= -->
  <!-- æœªç™»å½•ï¼šç™»å½•å¡ç‰‡æˆ–å“ç‰Œé¡µ       -->
  <!-- ============================= -->
  <block wx:if="{{!isLoggedIn}}">
    <view class="brand-header animate-fade-in">
      <view class="logo-row">
        <!-- <image class="logo" src="/assets/logo.png" mode="aspectFit" /> -->
        <view class="brand-text">
          <text class="brand-name">L2C</text>
          <text class="brand-tag">PRO</text>
        </view>
      </view>
    </view>

    <view class="login-section animate-slide-up">
      <view class="card login-card">
        <view class="login-header">
          <text class="login-title">æ¬¢è¿ä½¿ç”¨ L2C</text>
          <text class="login-desc">ç™»å½•ä»¥è®¿é—®æ‚¨çš„ä¼ä¸šå·¥ä½œå°</text>
        </view>

        <button class="btn-wechat" open-type="getPhoneNumber" bindgetphonenumber="onGetPhoneNumber" loading="{{loading}}">
          <text>å¾®ä¿¡ä¸€é”®ç™»å½•</text>
        </button>

        <view class="login-footer">
          <text class="footer-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</text>
          <view class="footer-link" bindtap="goToRegister">
            <text>ç”³è¯·å…¥é©» â†’</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="copyright">
      L2C Sales Management System v1.0
    </view>
  </block>

  <!-- ============================= -->
  <!-- å·²ç™»å½•ï¼šæ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒè§†å›¾   -->
  <!-- ============================= -->
  <block wx:else>

    <!-- å¼‚å¸¸çŠ¶æ€ï¼šå…¥é©»ä¸­/è¢«æ‹’ç» -->
    <block wx:if="{{tenantStatus === 'pending_approval' || tenantStatus === 'rejected'}}">
      <view class="brand-header animate-fade-in">
        <view class="logo-row">
          <!-- <image class="logo" src="/assets/logo.png" mode="aspectFit" /> -->
          <view class="brand-text">
            <text class="brand-name">L2C</text>
            <text class="brand-tag">PRO</text>
          </view>
        </view>
      </view>
      <view class="dashboard animate-slide-up">
        <view class="card user-summary">
          <view class="user-row">
            <view class="avatar-wrap">
              <image class="user-avatar" src="{{userInfo.avatarUrl || '/assets/default-avatar.png'}}" />
            </view>
            <view class="user-info">
              <text class="user-name">{{userInfo.name || 'ç”¨æˆ·'}}</text>
              <view class="tenant-badge {{tenantStatus === 'active' ? 'active' : ''}}">
                {{userInfo.tenantName || 'æœªç»‘å®šä¼ä¸š'}}
              </view>
            </view>
            <view class="badge {{tenantStatus === 'active' ? 'badge-success' : 'badge-warning'}}">
              {{statusText}}
            </view>
          </view>

          <view wx:if="{{tenantStatus === 'pending_approval'}}" class="alert alert-warning">
            <text>â³ ä¼ä¸šå…¥é©»ç”³è¯·å®¡æ ¸ä¸­</text>
          </view>
          <view wx:elif="{{tenantStatus === 'rejected'}}" class="alert alert-danger">
            <text>å®¡æ ¸æœªé€šè¿‡: {{rejectReason}}</text>
          </view>
        </view>

        <!-- ä»…æä¾›åŸºç¡€èœå• -->
        <view class="menu-grid">
          <view class="card menu-item" bindtap="goToStatus" hover-class="card-hover">
            <view class="menu-icon-wrap blue">
              <image class="menu-icon-img" src="/assets/icons/list-active.svg" />
            </view>
            <text class="menu-name">å®¡æ‰¹è¿›åº¦</text>
          </view>
          <view class="card menu-item" bindtap="logout" hover-class="card-hover">
            <view class="menu-icon-wrap gray">
              <image class="menu-icon-img" src="/assets/icons/support-active.svg" />
            </view>
            <text class="menu-name">é€€å‡ºç™»å½•</text>
          </view>
        </view>
      </view>
    </block>

    <!-- æ­£å¸¸å·¥ä½œå°ï¼šå·²æ¿€æ´»ç”¨æˆ·çš„è§†å›¾èšåˆ -->
    <block wx:else>
      <view class="workbench-page">
        <!-- é€šç”¨é¡¶éƒ¨ï¼šé—®å€™ + å¤´åƒ -->
        <view class="header animate-fade-in">
          <view class="greeting">
            <text class="greeting-text">ä½ å¥½ï¼Œ{{userInfo.name || 'ç”¨æˆ·'}}</text>
            <text class="greeting-date">{{today}}</text>
          </view>
          <image class="header-avatar" src="{{userInfo.avatarUrl || '/assets/default-avatar.png'}}" />
        </view>

        <!-- BOSS / ADMIN è§†å›¾ -->
        <block wx:if="{{role === 'boss' || role === 'admin' || role === 'tester'}}">
          <view class="stats-grid animate-slide-up">
            <view class="stat-card">
              <text class="stat-num primary">{{dashboard.targetCompletion || '0'}}%</text>
              <text class="stat-desc">ç›®æ ‡è¾¾æˆ</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.leads || '0'}}</text>
              <text class="stat-desc">æ–°çº¿ç´¢</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.orders || '0'}}</text>
              <text class="stat-desc">è®¢å•</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.cash || '0'}}</text>
              <text class="stat-desc">ä¸‡å…ƒå›æ¬¾</text>
            </view>
          </view>
          
          <view class="section-title">å¿«æ·å…¥å£</view>
          <view class="quick-actions animate-slide-up">
            <view class="action-item" bindtap="navigateToReports">
              <view class="action-icon-box orange">
                <!-- ä¹‹å‰çš„è·³è½¬é€»è¾‘å·²ä¿®æ”¹ä¸º navigateTo -->
                <image class="action-icon" src="/assets/icons/chart-active.svg" />
              </view>
              <text class="action-text">æ•°æ®æŠ¥è¡¨</text>
            </view>
            <view class="action-item" bindtap="navigateToTargets">
              <view class="action-icon-box green">
                <image class="action-icon" src="/assets/icons/success-active.svg" />
              </view>
              <text class="action-text">é”€å”®ç›®æ ‡</text>
            </view>
            <view class="action-item" bindtap="navigateToCreateQuote">
              <view class="action-icon-box blue">
                <image class="action-icon" src="/assets/icons/flash-active.svg" />
              </view>
              <text class="action-text">å¿«é€ŸæŠ¥ä»·</text>
            </view>
            <view class="action-item" bindtap="navigateToShowroom">
              <view class="action-icon-box purple">
                <image class="action-icon" src="/assets/icons/gallery-active.svg" />
              </view>
              <text class="action-text">äº‘å±•å…</text>
            </view>
            <view class="action-item" bindtap="goToInvite">
              <view class="action-icon-box green">
                <image class="action-icon" src="/assets/icons/invite-active.svg" />
              </view>
              <text class="action-text">é‚€è¯·å‘˜å·¥</text>
            </view>
          </view>

          <view class="section-title">å¾…åŠäº‹é¡¹</view>
          <view class="todo-list animate-slide-up">
            <block wx:for="{{dashboard.todos}}" wx:key="id">
              <view class="card todo-item" bindtap="handleTodoTap" data-id="{{item.id}}">
                <view class="todo-main">
                  <view class="todo-title">{{item.title}}</view>
                  <view class="todo-desc">{{item.desc}}</view>
                </view>
                <view class="todo-right">
                  <view class="badge {{item.status === 'urgent' ? 'badge-danger' : item.status === 'pending' ? 'badge-warning' : 'badge-info'}}">
                    {{item.statusText || item.status}}
                  </view>
                  <view class="todo-time">{{item.time}}</view>
                </view>
              </view>
            </block>
            <view class="empty-state" wx:if="{{!dashboard.todos || !dashboard.todos.length}}">æš‚æ— å¾…åŠäº‹é¡¹</view>
          </view>
        </block>

        <!-- MANAGER è§†å›¾ -->
        <block wx:if="{{role === 'manager' || role === 'tester'}}">
          <view class="stats-grid animate-slide-up">
            <view class="stat-card">
              <text class="stat-num primary">{{dashboard.targetCompletion || '0'}}%</text>
              <text class="stat-desc">å›¢é˜Ÿç›®æ ‡</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.leads || '0'}}</text>
              <text class="stat-desc">çº¿ç´¢</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.quotes || '0'}}</text>
              <text class="stat-desc">æŠ¥ä»·</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.orders || '0'}}</text>
              <text class="stat-desc">è®¢å•</text>
            </view>
          </view>
          
          <view class="section-title">å¿«æ·å…¥å£</view>
          <view class="quick-actions animate-slide-up">
            <view class="action-item" bindtap="navigateToTargets">
              <view class="action-icon-box green">
                <image class="action-icon" src="/assets/icons/success-active.svg" />
              </view>
              <text class="action-text">é”€å”®ç›®æ ‡</text>
            </view>
            <view class="action-item" bindtap="navigateToReports">
              <view class="action-icon-box orange">
                <image class="action-icon" src="/assets/icons/chart-active.svg" />
              </view>
              <text class="action-text">æ•°æ®æŠ¥è¡¨</text>
            </view>
            <view class="action-item" bindtap="navigateToCreateQuote">
              <view class="action-icon-box blue">
                <image class="action-icon" src="/assets/icons/flash-active.svg" />
              </view>
              <text class="action-text">å¿«é€ŸæŠ¥ä»·</text>
            </view>
            <view class="action-item" bindtap="goToInvite">
              <view class="action-icon-box green">
                <image class="action-icon" src="/assets/icons/invite-active.svg" />
              </view>
              <text class="action-text">é‚€è¯·å‘˜å·¥</text>
            </view>
          </view>
          
          <view class="section-title">å¾…åŠäº‹é¡¹</view>
          <view class="todo-list animate-slide-up">
            <block wx:for="{{dashboard.todos}}" wx:key="id">
              <view class="card todo-item" bindtap="handleTodoTap" data-id="{{item.id}}">
                <view class="todo-main">
                  <view class="todo-title">{{item.title}}</view>
                  <view class="todo-desc">{{item.desc}}</view>
                </view>
                <view class="todo-right">
                  <view class="badge badge-warning">{{item.statusText || item.status}}</view>
                  <view class="todo-time">{{item.time}}</view>
                </view>
              </view>
            </block>
            <view class="empty-state" wx:if="{{!dashboard.todos || !dashboard.todos.length}}">æš‚æ— å¾…åŠäº‹é¡¹</view>
          </view>
        </block>

        <!-- SALES è§†å›¾ -->
        <block wx:if="{{role === 'sales' || role === 'tester'}}">
          <view class="stats-grid animate-slide-up">
            <view class="stat-card">
              <text class="stat-num primary">{{dashboard.targetCompletion || '0'}}%</text>
              <text class="stat-desc">æœ¬æœˆä¸šç»©</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.leads || '0'}}</text>
              <text class="stat-desc">æˆ‘çš„çº¿ç´¢</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.quotes || '0'}}</text>
              <text class="stat-desc">æŠ¥ä»·å•</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">{{dashboard.stats.orders || '0'}}</text>
              <text class="stat-desc">è®¢å•</text>
            </view>
          </view>
          
          <view class="section-title">å¿«æ·å…¥å£</view>
          <view class="quick-actions animate-slide-up">
            <view class="action-item" bindtap="navigateToCreateQuote">
              <view class="action-icon-box blue">
                <image class="action-icon" src="/assets/icons/flash-active.svg" />
              </view>
              <text class="action-text">æ–°å»ºæŠ¥ä»·</text>
            </view>
            <view class="action-item" bindtap="navigateToCreateCustomer">
              <view class="action-icon-box teal">
                <image class="action-icon" src="/assets/icons/list-active.svg" />
              </view>
              <text class="action-text">æ–°å»ºå®¢æˆ·</text>
            </view>
            <view class="action-item" bindtap="navigateToShowroom">
              <view class="action-icon-box purple">
                <image class="action-icon" src="/assets/icons/gallery-active.svg" />
              </view>
              <text class="action-text">äº‘å±•å…</text>
            </view>
          </view>
          
          <view class="section-title">ä»Šæ—¥è·Ÿè¿›</view>
          <view class="todo-list animate-slide-up">
            <block wx:for="{{dashboard.todos}}" wx:key="id">
              <view class="card todo-item" bindtap="handleTodoTap" data-id="{{item.id}}">
                <view class="todo-main">
                  <view class="todo-title">{{item.title}}</view>
                  <view class="todo-desc">{{item.desc}}</view>
                </view>
                <view class="todo-right">
                  <view class="badge badge-info">{{item.statusText || item.status}}</view>
                  <view class="todo-time">{{item.time}}</view>
                </view>
              </view>
            </block>
            <view class="empty-state" wx:if="{{!dashboard.todos || !dashboard.todos.length}}">ä»Šæ—¥æš‚æ— è·Ÿè¿›äº‹é¡¹</view>
          </view>
        </block>

        <!-- WORKER è§†å›¾ -->
        <block wx:if="{{role === 'worker' || role === 'installer' || role === 'tester'}}">
          <view class="stats-grid animate-slide-up">
            <view class="stat-card" bindtap="goToTasks">
              <text class="stat-num primary">{{todayTaskCount}}</text>
              <text class="stat-desc">ä»Šæ—¥ä»»åŠ¡</text>
            </view>
            <view class="stat-card">
              <text class="stat-num">Â¥{{pendingEarnings}}</text>
              <text class="stat-desc">å¾…ç»“ç®—</text>
            </view>
          </view>
          <view class="section-title">å¿«æ·æ“ä½œ</view>
          <view class="quick-actions animate-slide-up">
            <view class="action-item" bindtap="goToTasks">
              <view class="action-icon-box blue">
                <image class="action-icon" src="/assets/tabbar/task.svg" />
              </view>
              <text class="action-text">æŸ¥çœ‹ä»»åŠ¡</text>
            </view>
            <view class="action-item" bindtap="goToEarnings">
              <view class="action-icon-box green">
                <image class="action-icon" src="/assets/icons/success-active.svg" />
              </view>
              <text class="action-text">æˆ‘çš„æ”¶ç›Š</text>
            </view>
          </view>
        </block>

        <!-- CUSTOMER è§†å›¾ -->
        <block wx:if="{{role === 'customer' || role === 'tester'}}">
          <view class="advisor-card animate-slide-up" wx:if="{{advisorInfo}}">
            <image class="advisor-avatar" src="{{advisorInfo.avatarUrl || '/assets/default-avatar.png'}}" />
            <view class="advisor-info">
              <view class="advisor-name">{{advisorInfo.name}}</view>
              <view class="advisor-title">æ‚¨çš„ä¸“å±é¡¾é—®</view>
            </view>
            <view class="advisor-call" bindtap="callAdvisor">
              <image class="call-icon" src="/assets/icons/flash-active.svg" />
              <text>è”ç³»</text>
            </view>
          </view>
          <view class="advisor-card-empty animate-slide-up" wx:else>
            <text class="advisor-empty-text">é¡¾é—®ä¿¡æ¯åŠ è½½ä¸­â€¦</text>
          </view>

          <view class="pending-sign-card animate-slide-up" wx:if="{{pendingSignCount > 0}}" bindtap="goToPendingSign">
            <view class="pending-sign-left">
              <view class="pending-sign-badge">{{pendingSignCount}}</view>
              <view class="pending-sign-text">ä»½æ–‡ä»¶å¾…æ‚¨ç­¾å­—ç¡®è®¤</view>
            </view>
            <view class="pending-sign-arrow">â†’</view>
          </view>

          <view class="section-title">æˆ‘çš„æœåŠ¡</view>
          <view class="customer-grid animate-slide-up">
            <view class="customer-grid-item" bindtap="goToShowroom">
              <view class="grid-icon-box purple">ğŸ›ï¸</view>
              <text class="grid-text">äº§å“å±•å…</text>
            </view>
            <view class="customer-grid-item" bindtap="goToPendingSign">
              <view class="grid-icon-box blue">âœï¸</view>
              <text class="grid-text">ç­¾å­—ç¡®è®¤</text>
            </view>
            <view class="customer-grid-item" bindtap="goToWarranty">
              <view class="grid-icon-box teal">ğŸ”§</view>
              <text class="grid-text">ä¿ä¿®ç”³è¯·</text>
            </view>
            <view class="customer-grid-item" bindtap="goToReview">
              <view class="grid-icon-box orange">â­</view>
              <text class="grid-text">å®Œå·¥è¯„ä»·</text>
            </view>
          </view>
        </block>

        <!-- æœªçŸ¥/å…¶ä»–è§’è‰² å…œåº•è§†å›¾ -->
        <block wx:if="{{role !== 'boss' && role !== 'admin' && role !== 'manager' && role !== 'sales' && role !== 'worker' && role !== 'installer' && role !== 'customer' && role !== 'tester'}}">
          <view class="empty-state">
            <text class="empty-desc">æ— æ³•è¯†åˆ«æ‚¨çš„ä¸šåŠ¡è§’è‰² ({{role}})</text>
            <text class="empty-sub">è¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ä¸ºæ‚¨åˆ†é…æ­£ç¡®çš„å²—ä½è§’è‰²æƒé™ã€‚</text>
          </view>
          
          <view class="section-title">åŸºç¡€åŠŸèƒ½</view>
          <view class="quick-actions animate-slide-up">
            <view class="action-item" bindtap="goToEarnings">
              <view class="action-icon-box gray">
                <image class="action-icon" src="/assets/icons/support-active.svg" />
              </view>
              <text class="action-text">ä¸ªäººä¸­å¿ƒ</text>
            </view>
            <view class="action-item" bindtap="logout">
              <view class="action-icon-box orange">
                <image class="action-icon" src="/assets/icons/error-active.svg" />
              </view>
              <text class="action-text">é€€å‡ºç™»å½•</text>
            </view>
          </view>
        </block>

      </view>
    </block>

  </block>

  <!-- loading é®ç½© -->
  <view class="loading-mask" wx:if="{{loading}}">
    <view class="loading-spinner" />
  </view>

</view>
