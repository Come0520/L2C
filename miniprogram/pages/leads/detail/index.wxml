
<view class="container" wx:if="{{!loading}}">
    <!-- Header -->
    <view class="header-card">
        <view class="header-top">
            <view class="name-wrap">
                <text class="name">{{lead.customerName}}</text>
                <view class="status-tag {{lead.status}}">{{lead.statusText || lead.status}}</view>
            </view>
            <view class="actions">
                <view class="action-btn call" bindtap="onCall">
                    <text>ğŸ“</text> æ‹¨æ‰“
                </view>
            </view>
        </view>
        <view class="header-info">
            <view class="info-item" bindtap="onCopy" data-text="{{lead.customerPhone}}">
                <text class="label">æ‰‹æœºï¼š</text>
                <text class="value">{{lead.customerPhone}}</text> 
                <text class="copy-icon">â§‰</text> 
            </view>
            <view class="info-item" wx:if="{{lead.customerWechat}}" bindtap="onCopy" data-text="{{lead.customerWechat}}">
                <text class="label">å¾®ä¿¡ï¼š</text>
                <text class="value">{{lead.customerWechat}}</text>
                <text class="copy-icon">â§‰</text>
            </view>
        </view>
    </view>

    <!-- Details -->
    <view class="section-card">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="detail-grid">
             <view class="grid-item">
                <text class="label">æ„å‘ç­‰çº§</text>
                <text class="value">{{lead.intentionLevel || '-'}}</text>
            </view>
            <view class="grid-item full">
                <text class="label">åœ°å€</text>
                <text class="value">{{lead.address || '-'}}</text>
            </view>
            <view class="grid-item full">
                <text class="label">æ¥æºæ¸ é“</text>
                <text class="value">{{lead.channelName || '-'}} {{lead.channelContactName ? '> ' + lead.channelContactName : ''}}</text>
            </view>
             <view class="grid-item full" wx:if="{{lead.notes}}">
                <text class="label">å¤‡æ³¨</text>
                <text class="value">{{lead.notes}}</text>
            </view>
        </view>
    </view>

    <!-- Timeline -->
    <view class="section-card timeline-section">
        <view class="section-title">è·Ÿè¿›è®°å½•</view>
        <view class="timeline">
            <block wx:for="{{lead.activities}}" wx:key="id">
                <view class="timeline-item">
                    <view class="timeline-dot"></view>
                    <view class="timeline-content">
                        <view class="timeline-header">
                            <text class="user">{{item.creator.name || 'ç³»ç»Ÿ'}}</text>
                            <text class="time">{{item.createdAt}}</text>
                        </view>
                        <view class="timeline-body">
                           <text wx:if="{{item.activityType === 'SYSTEM'}}" class="type-tag system">ç³»ç»Ÿ</text>
                           <text wx:elif="{{item.activityType === 'PHONE_CALL'}}" class="type-tag phone">ç”µè¯</text>
                           <text wx:elif="{{item.activityType === 'WECHAT_CHAT'}}" class="type-tag wechat">å¾®ä¿¡</text>
                           <text wx:elif="{{item.activityType === 'HOME_VISIT'}}" class="type-tag visit">ä¸Šé—¨</text>
                           <text wx:elif="{{item.activityType === 'STORE_VISIT'}}" class="type-tag visit">åˆ°åº—</text>
                           <text>{{item.content}}</text>
                        </view>
                         <view class="timeline-footer" wx:if="{{item.nextFollowupDate}}">
                            ä¸‹æ¬¡è·Ÿè¿›ï¼š{{item.nextFollowupDate}}
                        </view>
                    </view>
                </view>
            </block>
            <view class="empty-timeline" wx:if="{{!lead.activities || lead.activities.length === 0}}">
                æš‚æ— è·Ÿè¿›è®°å½•
            </view>
        </view>
    </view>

    <!-- Bottom Actions -->
    <view class="bottom-bar">
        <view class="btn-group">
            <button class="btn btn-secondary" bindtap="onShowVoid" wx:if="{{lead.status !== 'VOID' && lead.status !== 'WON'}}">ä½œåºŸ</button>
            <button class="btn btn-primary" bindtap="onShowFollowup" wx:if="{{lead.status !== 'VOID' && lead.status !== 'WON'}}">å†™è·Ÿè¿›</button>
            <button class="btn btn-success" bindtap="onConvert" wx:if="{{lead.status !== 'VOID' && lead.status !== 'WON'}}">è½¬å®¢æˆ·</button>
        </view>
    </view>

    <!-- Followup Modal -->
    <view class="modal {{showFollowupModal ? 'show' : ''}}">
        <view class="mask" bindtap="onHideFollowup"></view>
        <view class="modal-content">
            <view class="modal-header">æ·»åŠ è·Ÿè¿›è®°å½•</view>
            <view class="modal-body">
                <view class="form-field">
                    <text class="label">è·Ÿè¿›æ–¹å¼</text>
                    <view class="tags-group">
                        <view 
                            wx:for="{{followupTypes}}" 
                            wx:key="value" 
                            class="tag-radio {{followupForm.type === item.value ? 'active' : ''}}"
                            bindtap="onFollowupTypeChange"
                            data-type="{{item.value}}"
                        >
                            {{item.name}}
                        </view>
                    </view>
                </view>
                <view class="form-field">
                    <text class="label">è·Ÿè¿›å†…å®¹</text>
                    <textarea 
                        class="textarea" 
                        placeholder="è¯·è¾“å…¥è·Ÿè¿›æƒ…å†µ" 
                        value="{{followupForm.content}}"
                        bindinput="onFollowupInput"
                    />
                </view>
                <view class="form-field">
                    <text class="label">ä¸‹æ¬¡è·Ÿè¿›</text>
                     <picker mode="date" bindchange="onNextDateChange">
                        <view class="picker-trigger">
                            {{followupForm.nextFollowupAt || 'é€‰æ‹©æ—¥æœŸ (å¯é€‰)'}}
                        </view>
                    </picker>
                </view>
            </view>
            <view class="modal-footer">
                <button class="btn-cancel" bindtap="onHideFollowup">å–æ¶ˆ</button>
                <button class="btn-confirm" bindtap="onSubmitFollowup">æäº¤</button>
            </view>
        </view>
    </view>

    <!-- Void Modal -->
    <view class="modal {{showVoidModal ? 'show' : ''}}">
        <view class="mask" bindtap="onHideVoid"></view>
        <view class="modal-content">
            <view class="modal-header">ä½œåºŸçº¿ç´¢</view>
            <view class="modal-body">
                <view class="form-field">
                    <text class="label">ä½œåºŸåŸå› </text>
                    <textarea 
                        class="textarea" 
                        placeholder="è¯·è¾“å…¥ä½œåºŸåŸå› ï¼Œå¦‚ï¼šæ— æ„å‘ã€å·ç ç©ºå·ç­‰" 
                        value="{{voidReason}}"
                        bindinput="onVoidReasonInput"
                    />
                </view>
            </view>
            <view class="modal-footer">
                <button class="btn-cancel" bindtap="onHideVoid">å–æ¶ˆ</button>
                <button class="btn-confirm danger" bindtap="onSubmitVoid">ç¡®è®¤ä½œåºŸ</button>
            </view>
        </view>
    </view>
</view>
