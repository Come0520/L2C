<!--pages/orders/detail/index.wxml-->
<view class="container" wx:if="{{order}}">
  <scroll-view class="content" scroll-y>
    <!-- Header Status -->
    <view class="card header-status animate-slide-up">
        <view class="status-title">{{statusMap[order.status] || order.status}}</view>
        <view class="order-no">订单号: {{order.orderNo}}</view>
    </view>

    <!-- Address -->
    <view class="card address-card animate-slide-up" wx:if="{{order.deliveryAddress}}" style="animation-delay: 0.05s;">
        <text class="label">收货地址</text>
        <text class="address-text">{{order.deliveryAddress}}</text>
    </view>

    <!-- Items -->
    <view class="card items-list animate-slide-up" style="animation-delay: 0.1s;">
        <view class="section-title">商品清单</view>
        <block wx:for="{{order.items}}" wx:key="id">
            <view class="item-row">
                <view class="item-info">
                   <text class="prod-name">{{item.roomName}} - {{item.productName}}</text>
                   <text class="sku">{{item.attributes || ''}}</text>
                </view>
                <view class="item-meta">
                    <text>x{{item.quantity}}</text>
                    <text class="price">¥{{item.subtotal}}</text>
                </view>
            </view>
        </block>
        <view class="total-row">
             <text>合计：</text>
             <text class="total-price">¥{{order.totalAmount}}</text>
        </view>
    </view>

    <!-- Payment Schedules -->
    <view class="card payment-list animate-slide-up" style="animation-delay: 0.15s;">
        <view class="section-title">付款进度 (已付: ¥{{order.paidAmount}})</view>
        <block wx:for="{{order.paymentSchedules}}" wx:key="id">
            <view class="pay-item">
                <view class="pay-left">
                    <text class="pay-name">{{item.name}}</text>
                    <text class="pay-status {{item.status}}">{{item.status === 'PAID' ? '已支付' : '待支付'}}</text>
                </view>
                <view class="pay-right">
                    <text class="pay-amount">¥{{item.amount}}</text>
                    <button 
                        class="btn-pay-action" 
                        size="mini" 
                        wx:if="{{item.status !== 'PAID'}}"
                        bindtap="onOpenPayModal"
                        data-id="{{item.id}}"
                        data-amount="{{item.amount}}"
                    >录入</button>
                    <!-- Show proof thumb if paid -->
                    <image 
                        wx:if="{{item.status === 'PAID' && item.proofImg}}" 
                        src="{{item.proofImg}}" 
                        class="proof-thumb" 
                        bindtap="onPreviewImage" 
                        data-src="{{item.proofImg}}"
                    />
                </view>
            </view>
        </block>
    </view>

    <!-- After Sales Action -->
    <view class="action-footer animate-slide-up" wx:if="{{order.status === 'COMPLETED'}}" style="animation-delay: 0.2s;">
        <button class="outline-btn" bindtap="onApplyAfterSales">申请售后服务</button>
    </view>
  </scroll-view>

  <!-- Payment Modal -->
  <view class="pay-modal {{showPayModal ? 'show' : ''}}">
    <view class="modal-mask" bindtap="onClosePayModal"></view>
    <view class="modal-content">
        <view class="modal-header">录入支付信息</view>
        <view class="modal-body">
            <view class="form-item">
                <text class="label">应付金额</text>
                <text class="value-static">¥{{pendingPayAmount}}</text>
            </view>
            <view class="form-item">
                <text class="label">实付金额(元)</text>
                <input class="input" type="digit" placeholder="请输入实际金额" value="{{actualAmount}}" bindinput="onAmountInput" />
            </view>
            <view class="form-item">
                <text class="label">支付方式</text>
                <picker mode="selector" range="{{paymentMethods}}" bindchange="onMethodChange">
                    <view class="picker-inner">
                        <text>{{paymentMethods[paymentMethodIndex]}}</text>
                        <text class="picker-arrow">▾</text>
                    </view>
                </picker>
            </view>
            <view class="form-item col">
                <text class="label">支付凭证</text>
                <view class="upload-box" bindtap="onChooseImage">
                    <image wx:if="{{proofImg}}" src="{{proofImg}}" mode="aspectFill" class="preview" />
                    <view wx:else class="placeholder">+</view>
                </view>
            </view>
        </view>
        <view class="modal-footer">
            <button class="modal-btn-cancel" bindtap="onClosePayModal">取消</button>
            <button class="modal-btn-submit" bindtap="onSubmitPayment" loading="{{submitting}}">确认提交</button>
        </view>
    </view>
  </view>

</view>
