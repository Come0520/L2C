<!--pages/tasks/detail/detail.wxml-->
<view class="container" wx:if="{{task}}">
  <!-- 头部信息 -->
  <view class="header">
    <view class="title-row">
      <text class="task-no">{{task.measureNo || task.taskNo}}</text>
      <van-tag type="{{statusType}}" size="medium">{{statusText}}</van-tag>
    </view>
    <view class="time-row">
      <van-icon name="clock-o" style="margin-right: 4px;" />
      <text>预约时间：{{scheduledTime}}</text>
    </view>
  </view>

  <!-- 客户信息 -->
  <view class="section">
    <view class="section-title">客户信息</view>
    <view class="address-box">
      <view class="address-text">{{task.customerAddress || task.address}}</view>
      <view class="contact-row">
        <view class="contact-info">
          <text class="name">{{task.customerName}}</text>
          <text class="phone" bindtap="makePhoneCall" data-phone="{{task.customerPhone}}">{{task.customerPhone}}</text>
        </view>
        <view class="action-bar">
           <view class="action-icon" bindtap="openLocation">
             <van-icon name="location-o" size="24px" color="#1989fa" />
             <text>导航</text>
           </view>
           <view class="action-icon" bindtap="makePhoneCall" data-phone="{{task.customerPhone}}">
             <van-icon name="phone-o" size="24px" color="#07c160" />
             <text>拨打</text>
           </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 备注信息 -->
  <view class="section" wx:if="{{task.remark}}">
    <view class="section-title">备注</view>
    <view style="padding: 12px 0; color: #666; font-size: 14px;">{{task.remark}}</view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar">
     <van-button 
        wx:if="{{task.status === 'PENDING' || task.status === 'PENDING_DISPATCH'}}" 
        type="primary" 
        block 
        class="btn-flex"
        bindtap="updateStatus" 
        data-status="IN_PROGRESS"
        data-action="accept"
     >接单出发</van-button>

     <van-button 
        wx:if="{{task.status === 'IN_PROGRESS' || task.status === 'ASSIGNED'}}" 
        type="info" 
        block 
        class="btn-flex"
        bindtap="checkIn"
     >签到</van-button>

     <van-button 
        wx:if="{{task.status === 'IN_PROGRESS'}}" 
        type="primary" 
        block 
        class="btn-flex"
        bindtap="completeTask"
     >完成任务</van-button>
  </view>
</view>

<!-- Loading State -->
<view wx:if="{{loading}}" style="text-align: center; padding-top: 50px;">
    <van-loading type="spinner" />
</view>

<!-- Error State -->
<view wx:if="{{error}}" style="text-align: center; padding-top: 50px; color: #999;">
    <text>{{error}}</text>
    <van-button size="small" type="default" bindtap="onLoad" style="margin-top: 10px;">重试</van-button>
</view>
