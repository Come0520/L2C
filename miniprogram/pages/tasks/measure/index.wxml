<!--
  测量数据录入页
  pages/tasks/measure/index.wxml
-->
<view class="container">
  <!-- 方案 Tab 栏 -->
  <view class="variant-tabs">
    <scroll-view scroll-x class="tabs-scroll">
      <view 
        wx:for="{{variants}}" 
        wx:key="*this"
        class="tab-item {{activeVariant === item ? 'active' : ''}}"
        bindtap="switchVariant"
        data-variant="{{item}}"
      >
        方案 {{item}}
      </view>
      <view class="tab-item add-btn" bindtap="addVariant">
        + 新增方案
      </view>
    </scroll-view>
  </view>

  <!-- 窗户列表 -->
  <scroll-view class="content" scroll-y>
    <view wx:if="{{items.length === 0}}" class="empty">
      <text>暂无窗户数据，点击下方按钮添加</text>
    </view>

    <view wx:for="{{items}}" wx:key="id" class="item-card {{item.expanded ? 'expanded' : ''}}">
      <!-- 卡片头部 -->
      <view class="card-header" bindtap="toggleExpand" data-index="{{index}}">
        <view class="header-left">
          <text class="room-name">{{item.roomName || '未命名房间'}}</text>
          <text class="dimensions">{{item.width}}×{{item.height}}</text>
        </view>
        <view class="header-right">
          <text class="expand-icon">{{item.expanded ? '▲' : '▼'}}</text>
        </view>
      </view>

      <!-- 卡片内容（可折叠） -->
      <view wx:if="{{item.expanded}}" class="card-content">
        <!-- 房间名称 -->
        <view class="form-row">
          <text class="label">房间名称</text>
          <input 
            class="input" 
            placeholder="如：客厅、卧室"
            value="{{item.roomName}}"
            bindinput="onFieldChange"
            data-index="{{index}}"
            data-field="roomName"
          />
        </view>

        <!-- 窗户类型 -->
        <view class="form-row">
          <text class="label">窗户类型</text>
          <picker 
            mode="selector"
            range="{{windowTypes}}"
            range-key="label"
            value="{{0}}"
            bindchange="onPickerChange"
            data-index="{{index}}"
            data-field="windowType"
            data-options="{{windowTypes}}"
          >
            <view class="picker">{{item.windowType || '请选择'}}</view>
          </picker>
        </view>

        <!-- 宽度和高度 -->
        <view class="form-row-group">
          <view class="form-row half">
            <text class="label">宽度 (mm)</text>
            <input 
              class="input" 
              type="digit"
              placeholder="宽度"
              value="{{item.width}}"
              bindinput="onFieldChange"
              data-index="{{index}}"
              data-field="width"
            />
          </view>
          <view class="form-row half">
            <text class="label">高度 (mm)</text>
            <input 
              class="input" 
              type="digit"
              placeholder="高度"
              value="{{item.height}}"
              bindinput="onFieldChange"
              data-index="{{index}}"
              data-field="height"
            />
          </view>
        </view>

        <!-- 安装方式 -->
        <view class="form-row">
          <text class="label">安装方式</text>
          <picker 
            mode="selector"
            range="{{installTypes}}"
            range-key="label"
            bindchange="onPickerChange"
            data-index="{{index}}"
            data-field="installType"
            data-options="{{installTypes}}"
          >
            <view class="picker">{{item.installType || '请选择'}}</view>
          </picker>
        </view>

        <!-- 墙体材质 -->
        <view class="form-row">
          <text class="label">墙体材质</text>
          <picker 
            mode="selector"
            range="{{wallMaterials}}"
            range-key="label"
            bindchange="onPickerChange"
            data-index="{{index}}"
            data-field="wallMaterial"
            data-options="{{wallMaterials}}"
          >
            <view class="picker">{{item.wallMaterial || '请选择'}}</view>
          </picker>
        </view>

        <!-- 是否有窗盒 -->
        <view class="form-row">
          <text class="label">是否有窗盒</text>
          <switch 
            checked="{{item.hasBox}}"
            bindchange="onSwitchChange"
            data-index="{{index}}"
            data-field="hasBox"
          />
        </view>

        <!-- 是否电动 -->
        <view class="form-row">
          <text class="label">是否电动</text>
          <switch 
            checked="{{item.isElectric}}"
            bindchange="onSwitchChange"
            data-index="{{index}}"
            data-field="isElectric"
          />
        </view>

        <!-- 备注 -->
        <view class="form-row">
          <text class="label">备注</text>
          <textarea 
            class="textarea" 
            placeholder="其他说明"
            value="{{item.remark}}"
            bindinput="onFieldChange"
            data-index="{{index}}"
            data-field="remark"
          />
        </view>

        <!-- 删除按钮 -->
        <view class="delete-btn" bindtap="removeItem" data-index="{{index}}">
          删除此窗户
        </view>
      </view>
    </view>

    <!-- 添加窗户按钮 -->
    <view class="add-item-btn" bindtap="addItem">
      + 添加窗户
    </view>

    <!-- 照片区域 -->
    <view class="photo-section">
      <view class="section-title">现场照片</view>
      <view class="photo-grid">
        <view wx:for="{{photos}}" wx:key="*this" class="photo-item">
          <image src="{{item}}" mode="aspectFill" />
          <view class="remove-icon" bindtap="removePhoto" data-index="{{index}}">×</view>
        </view>
        <view wx:if="{{photos.length < 9}}" class="photo-item add-photo" bindtap="choosePhoto">
          <text>+</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 底部提交按钮 -->
  <view class="footer">
    <button 
      class="submit-btn" 
      bindtap="submitData"
      disabled="{{submitting}}"
      loading="{{submitting}}"
    >
      {{submitting ? '提交中...' : '提交测量数据'}}
    </button>
  </view>
</view>
