name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - '**/*.json'
      - '**/*.yaml'
      - '**/*.yml'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - '**/*.json'
      - '**/*.yaml'
      - '**/*.yml'
  # 定期运行测试 - 每天凌晨2点(UTC)
  schedule:
    - cron: '0 2 * * *'

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Run lint
        run: pnpm run lint
        
      - name: Run type check
        run: pnpm run typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Run unit tests with coverage
        run: pnpm run test:ci
        
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unit-tests
          name: codecov-umbrella
          fail_ci_if_error: false

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://example.supabase.co' }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'test_anon_key' }}
      E2E_TEST: '1'
      NEXT_PUBLIC_E2E_TEST: 'true'
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps
        
      - name: Build application
        run: pnpm run build
        
      - name: Run E2E tests
        run: pnpm run e2e:chromium
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Build application
        run: pnpm run build
        
      - name: Run performance test
        run: pnpm run performance:test

  # Required for merging PRs
  check-coverage:
    name: Check Coverage Threshold
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Check coverage thresholds
        run: pnpm run test:coverage

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run npm audit
        run: pnpm audit --audit-level=high
        continue-on-error: true
        
      - name: Run dependency check
        run: pnpm dlx depcheck
        continue-on-error: true

  # 测试结果通知
  notify:
    name: Test Results Notification
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests, check-coverage]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
        
      - name: Install dependencies
        run: pnpm install
        
      - name: Send Slack notification on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
        
      - name: Create issue on test failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { workflow, run_id, event_name } = context;
            
            // Create a unique issue title
            const title = `Test Failure Alert: ${workflow} #${run_id} (${event_name})`;
            
            // Check if an issue already exists for this failure
            const existingIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 10,
              labels: ['test-failure', 'automated']
            });
            
            const existingIssue = existingIssues.data.find(issue => 
              issue.title.includes(title.split(':')[0]) && 
              issue.title.includes(`#${run_id}`)
            );
            
            if (!existingIssue) {
              // Create a new issue
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body: `Automated test failure detected in workflow run [${workflow} #${run_id}](https://github.com/${owner}/${repo}/actions/runs/${run_id})\n\nPlease investigate the test failures and take appropriate action.\n\n- Workflow: ${workflow}\n- Run ID: ${run_id}\n- Event: ${event_name}\n- Repository: ${owner}/${repo}`,
                labels: ['test-failure', 'automated', 'bug']
              });
            }
