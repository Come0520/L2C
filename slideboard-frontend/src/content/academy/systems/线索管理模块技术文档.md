# çº¿ç´¢ç®¡ç†æ¨¡å—æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### ä»€ä¹ˆæ˜¯çº¿ç´¢ç®¡ç†æ¨¡å—ï¼Ÿ

çº¿ç´¢ç®¡ç†æ¨¡å—æ˜¯ L2C ç³»ç»Ÿçš„æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†ä»å®¢æˆ·åˆæ¬¡æ¥è§¦åˆ°æœ€ç»ˆæˆäº¤çš„å®Œæ•´é”€å”®æµç¨‹ã€‚å®ƒæ˜¯é”€å”®å›¢é˜Ÿçš„æ—¥å¸¸å·¥ä½œä¸­å¿ƒï¼Œæ”¯æŒçº¿ç´¢åˆ†é…ã€è·Ÿè¸ªã€è½¬åŒ–ç­‰å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

### æ ¸å¿ƒç‰¹æ€§

```
âœ… å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
   39ä¸ªçŠ¶æ€èŠ‚ç‚¹ï¼Œè¦†ç›–ä»çº¿ç´¢åˆ°å®Œæˆçš„æ‰€æœ‰é˜¶æ®µ

âœ… ä¸¥æ ¼æ—¶æ•ˆæ§åˆ¶
   æ¯ä¸ªçŠ¶æ€éƒ½æœ‰æ˜ç¡®çš„æ—¶æ•ˆè¦æ±‚å’Œè¶…æ—¶å¤„ç½šæœºåˆ¶

âœ… ç²¾ç»†åŒ–æƒé™æ§åˆ¶
   åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œ8ç§ç”¨æˆ·è§’è‰²

âœ… æ™ºèƒ½é¢„è­¦ç³»ç»Ÿ
   8ç§é¢„è­¦ç±»å‹ï¼Œä¸»åŠ¨å‘ç°é£é™©çº¿ç´¢

âœ… æ•°æ®é©±åŠ¨å†³ç­–
   å®æ—¶ç»Ÿè®¡ã€è½¬åŒ–æ¼æ–—ã€ä¸šç»©åˆ†æ
```

---

## ğŸ¯ ä¸šåŠ¡æµç¨‹

### çº¿ç´¢å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

```mermaid
graph TB
    A[çº¿ç´¢åˆ›å»º] --> B[å¾…åˆ†é… PENDING_ASSIGNMENT]
    B --> C[å¾…è·Ÿè¸ª PENDING_FOLLOW_UP]
    C --> D[è·Ÿè¸ªä¸­ FOLLOWING_UP]
    D --> E[è‰ç­¾ DRAFT_SIGNED]
    E --> F[å¾…æµ‹é‡ PENDING_MEASUREMENT]
    F --> G[æµ‹é‡é˜¶æ®µ 4ä¸ªå­çŠ¶æ€]
    G --> H[æ–¹æ¡ˆå¾…ç¡®è®¤ PLAN_PENDING_CONFIRMATION]
    H --> I[å¾…æ¨å• PENDING_PUSH]
    I --> J[è®¢å•é˜¶æ®µ 5ä¸ªå­çŠ¶æ€]
    J --> K[å®‰è£…é˜¶æ®µ 4ä¸ªå­çŠ¶æ€]
    K --> L[è´¢åŠ¡é˜¶æ®µ 3ä¸ªå­çŠ¶æ€]
    L --> M[å·²å®Œæˆ COMPLETED]
    
    D -.-> N[å·²å¤±æ•ˆ EXPIRED]
    style M fill:#90EE90
    style N fill:#FFB6C1
```

### 39ä¸ªçŠ¶æ€è¯¦è§£

#### 1. çº¿ç´¢é˜¶æ®µï¼ˆ6ä¸ªçŠ¶æ€ï¼‰

| çŠ¶æ€ | ä¸­æ–‡ | è¯´æ˜ | æ—¶æ•ˆ |
|------|------|------|------|
| PENDING_ASSIGNMENT | å¾…åˆ†é… | æ–°çº¿ç´¢ç­‰å¾…é”€å”®ä¸»ç®¡åˆ†é… | 24å°æ—¶ |
| PENDING_FOLLOW_UP | å¾…è·Ÿè¸ª | å·²åˆ†é…ç»™é”€å”®ï¼Œå¾…å¼€å§‹è·Ÿè¿› | 72å°æ—¶ |
| FOLLOWING_UP | è·Ÿè¸ªä¸­ | é”€å”®æ­£åœ¨è·Ÿè¿›å®¢æˆ· | 7å¤©å†…éœ€è·Ÿè¿› |
| DRAFT_SIGNED | è‰ç­¾ | å®¢æˆ·å£å¤´åŒæ„æˆ–æ”¯ä»˜å®šé‡‘ | 72å°æ—¶å†…ç”ŸæˆæŠ¥ä»·å• |
| EXPIRED | å·²å¤±æ•ˆ | è¶…æ—¶æœªå¤„ç†æˆ–å®¢æˆ·æµå¤± | - |

#### 2. æµ‹é‡é˜¶æ®µï¼ˆ5ä¸ªçŠ¶æ€ï¼‰

| çŠ¶æ€ | ä¸­æ–‡ | è¯´æ˜ | æ—¶æ•ˆ |
|------|------|------|------|
| PENDING_MEASUREMENT | å¾…æµ‹é‡ | ç­‰å¾…å®‰æ’æµ‹é‡ | 48å°æ—¶ |
| MEASURING_PENDING_ASSIGNMENT | æµ‹é‡ä¸­-å¾…åˆ†é… | è°ƒåº¦éœ€åˆ†é…æµ‹é‡å¸ˆ | 4å°æ—¶ |
| MEASURING_ASSIGNING | æµ‹é‡ä¸­-åˆ†é…ä¸­ | æµ‹é‡å¸ˆéœ€æ¥å• | 2å°æ—¶ |
| MEASURING_PENDING_VISIT | æµ‹é‡ä¸­-å¾…ä¸Šé—¨ | æµ‹é‡å¸ˆå³å°†ä¸Šé—¨ | 48å°æ—¶ |
| MEASURING_PENDING_CONFIRMATION | æµ‹é‡ä¸­-å¾…ç¡®è®¤ | é”€å”®éœ€ç¡®è®¤æµ‹é‡ç»“æœ | 48å°æ—¶ |

#### 3. æ–¹æ¡ˆä¸è®¢å•é˜¶æ®µï¼ˆ6ä¸ªçŠ¶æ€ï¼‰

| çŠ¶æ€ | ä¸­æ–‡ | è¯´æ˜ | æ—¶æ•ˆ |
|------|------|------|------|
| PLAN_PENDING_CONFIRMATION | æ–¹æ¡ˆå¾…ç¡®è®¤ | è®¾è®¡å¸ˆå·²å‡ºå›¾ï¼Œç­‰å®¢æˆ·ç¡®è®¤ | 72å°æ—¶ |
| PENDING_PUSH | å¾…æ¨å• | æ–¹æ¡ˆç¡®è®¤ï¼Œé”€å”®æ¨é€è®¢å• | æ— å¼ºåˆ¶æ—¶æ•ˆ |
| PENDING_ORDER | å¾…ä¸‹å• | äº¤ä»˜éƒ¨é—¨å®¡æ ¸è®¢å• | 48å°æ—¶ |
| IN_PRODUCTION | ç”Ÿäº§ä¸­ | äº§å“ç”Ÿäº§é˜¶æ®µ | æ ¹æ®äº§å“å®š |
| STOCK_PREPARED | å¤‡è´§å®Œæˆ | äº§å“å·²å¤‡å¥½ï¼Œå¾…å‘è´§ | 24å°æ—¶ |
| PENDING_SHIPMENT | å¾…å‘è´§ | å¡«å†™å¿«é€’å•å· | 24å°æ—¶ |

#### 4. å®‰è£…é˜¶æ®µï¼ˆ4ä¸ªçŠ¶æ€ï¼‰

| çŠ¶æ€ | ä¸­æ–‡ | è¯´æ˜ | æ—¶æ•ˆ |
|------|------|------|------|
| INSTALLING_PENDING_ASSIGNMENT | å®‰è£…ä¸­-å¾…åˆ†é… | è°ƒåº¦åˆ†é…å®‰è£…å¸ˆ | 4å°æ—¶ |
| INSTALLING_ASSIGNING | å®‰è£…ä¸­-åˆ†é…ä¸­ | å®‰è£…å¸ˆæ¥å•ä¸­ | 2å°æ—¶ |
| INSTALLING_PENDING_VISIT | å®‰è£…ä¸­-å¾…ä¸Šé—¨ | å®‰è£…å¸ˆå³å°†ä¸Šé—¨ | - |
| INSTALLING_PENDING_CONFIRMATION | å®‰è£…ä¸­-å¾…ç¡®è®¤ | é”€å”®å®¡æ ¸å®‰è£…ç»“æœ | - |

#### 5. è´¢åŠ¡ä¸å®Œæˆé˜¶æ®µï¼ˆ4ä¸ªçŠ¶æ€ï¼‰

| çŠ¶æ€ | ä¸­æ–‡ | è¯´æ˜ |
|------|------|------|
| PENDING_RECONCILIATION | å¾…å¯¹è´¦ | è´¢åŠ¡å¯¹è´¦ä¸­ |
| PENDING_INVOICE | å¾…å¼€å‘ç¥¨ | ç­‰å¾…å¼€å…·å‘ç¥¨ |
| PENDING_PAYMENT | å¾…å›æ¬¾ | ç­‰å¾…å®¢æˆ·ä»˜æ¬¾ |
| COMPLETED | å·²å®Œæˆ | è®¢å•å®Œæˆ |

#### 6. å¼‚å¸¸çŠ¶æ€ï¼ˆ3ä¸ªçŠ¶æ€ï¼‰

| çŠ¶æ€ | ä¸­æ–‡ | è¯´æ˜ |
|------|------|------|
| CANCELLED | å·²å–æ¶ˆ | å®¢æˆ·å–æ¶ˆè®¢å• |
| PAUSED | æš‚åœ | æš‚æ—¶åœæ­¢æ¨è¿› |
| ABNORMAL | å¼‚å¸¸ | å‡ºç°é—®é¢˜éœ€å¤„ç† |

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### leads è¡¨ï¼ˆçº¿ç´¢ä¸»è¡¨ï¼‰

```sql
CREATE TABLE leads (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_number VARCHAR(50) UNIQUE NOT NULL,  -- çº¿ç´¢ç¼–å· L20251212001
    
    -- å®¢æˆ·ä¿¡æ¯
    name VARCHAR(100) NOT NULL,               -- å®¢æˆ·å§“å
    phone VARCHAR(20) NOT NULL,               -- è”ç³»ç”µè¯
    project_address TEXT,                     -- é¡¹ç›®åœ°å€
    source VARCHAR(50),                       -- æ¥æºæ¸ é“
    
    -- çŠ¶æ€ä¿¡æ¯
    status VARCHAR(50) NOT NULL,              -- å½“å‰çŠ¶æ€
    customer_level VARCHAR(10),               -- å®¢æˆ·ç­‰çº§ A/B/C/D
    business_tags TEXT[],                     -- ä¸šåŠ¡æ ‡ç­¾
    
    -- éœ€æ±‚ä¿¡æ¯
    budget_min DECIMAL(10,2),                 -- é¢„ç®—ä¸‹é™
    budget_max DECIMAL(10,2),                 -- é¢„ç®—ä¸Šé™
    requirements TEXT[],                      -- éœ€æ±‚åˆ—è¡¨
    area_size DECIMAL(10,2),                  -- é¢ç§¯
    construction_progress VARCHAR(50),        -- è£…ä¿®è¿›åº¦
    expected_purchase_date DATE,              -- é¢„è®¡è´­ä¹°æ—¥æœŸ
    expected_check_in_date DATE,              -- é¢„è®¡å…¥ä½æ—¥æœŸ
    
    -- çº¦è§ä¿¡æ¯
    appointment_time TIMESTAMP,               -- é¢„çº¦æ—¶é—´
    appointment_reminder VARCHAR(50),         -- æé†’è®¾ç½®
    
    -- äººå‘˜å…³è”
    assigned_to_id UUID,                      -- åˆ†é…ç»™è°ï¼ˆé”€å”®ï¼‰
    designer_id UUID,                         -- è®¾è®¡å¸ˆ
    shopping_guide_id UUID,                   -- å¯¼è´­
    created_by_id UUID,                       -- åˆ›å»ºäºº
    
    -- ç»Ÿè®¡ä¿¡æ¯
    quote_versions INT DEFAULT 0,             -- æŠ¥ä»·å•ç‰ˆæœ¬æ•°
    measurement_completed BOOLEAN DEFAULT FALSE,  -- æ˜¯å¦å·²æµ‹é‡
    installation_completed BOOLEAN DEFAULT FALSE, -- æ˜¯å¦å·²å®‰è£…
    total_quote_amount DECIMAL(12,2),         -- æŠ¥ä»·æ€»é¢
    
    -- çŠ¶æ€è¿½è¸ª
    last_status_change_at TIMESTAMP,          -- æœ€åçŠ¶æ€å˜æ›´æ—¶é—´
    last_status_change_by_id UUID,            -- æœ€åå˜æ›´äºº
    is_cancelled BOOLEAN DEFAULT FALSE,       -- æ˜¯å¦å·²å–æ¶ˆ
    cancellation_reason TEXT,                 -- å–æ¶ˆåŸå› 
    is_paused BOOLEAN DEFAULT FALSE,          -- æ˜¯å¦æš‚åœ
    pause_reason TEXT,                        -- æš‚åœåŸå› 
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- å¤–é”®
    FOREIGN KEY (assigned_to_id) REFERENCES users(id),
    FOREIGN KEY (designer_id) REFERENCES users(id),
    FOREIGN KEY (shopping_guide_id) REFERENCES users(id),
    FOREIGN KEY (created_by_id) REFERENCES users(id)
);

-- ç´¢å¼•
CREATE INDEX idx_leads_status ON leads(status);
CREATE INDEX idx_leads_assigned_to ON leads(assigned_to_id);
CREATE INDEX idx_leads_phone ON leads(phone);
CREATE INDEX idx_leads_created_at ON leads(created_at);
```

---

#### lead_follow_up_records è¡¨ï¼ˆè·Ÿè¿›è®°å½•ï¼‰

```sql
CREATE TABLE lead_follow_up_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_id UUID NOT NULL,                    -- å…³è”çº¿ç´¢
    
    follow_up_type VARCHAR(20),               -- è·Ÿè¿›æ–¹å¼ï¼šç”µè¯/å¾®ä¿¡/é¢è°ˆ
    content TEXT,                             -- è·Ÿè¿›å†…å®¹
    result VARCHAR(50),                       -- ç»“æœï¼šinterested/not-interested/follow-up
    note TEXT,                                -- å¤‡æ³¨
    
    next_follow_up_time TIMESTAMP,            -- ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´
    appointment_time TIMESTAMP,               -- é¢„çº¦æ—¶é—´ï¼ˆå¦‚çº¦åˆ°åº—ï¼‰
    
    created_at TIMESTAMP DEFAULT NOW(),
    created_by_id UUID,                       -- è·Ÿè¿›äºº
    
    FOREIGN KEY (lead_id) REFERENCES leads(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by_id) REFERENCES users(id)
);

CREATE INDEX idx_follow_up_lead ON lead_follow_up_records(lead_id);
CREATE INDEX idx_follow_up_created_at ON lead_follow_up_records(created_at);
```

---

#### lead_assignments è¡¨ï¼ˆåˆ†é…è®°å½•ï¼‰

```sql
CREATE TABLE lead_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_id UUID NOT NULL,                    -- çº¿ç´¢ID
    
    assigned_to_id UUID NOT NULL,             -- åˆ†é…ç»™è°
    assigned_by_id UUID,                      -- è°åˆ†é…çš„
    assignment_method VARCHAR(20),            -- åˆ†é…æ–¹å¼ï¼šmanual/auto
    reason TEXT,                              -- åˆ†é…åŸå› 
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    FOREIGN KEY (lead_id) REFERENCES leads(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_to_id) REFERENCES users(id),
    FOREIGN KEY (assigned_by_id) REFERENCES users(id)
);

CREATE INDEX idx_assignment_lead ON lead_assignments(lead_id);
CREATE INDEX idx_assignment_to ON lead_assignments(assigned_to_id);
```

---

#### lead_status_history è¡¨ï¼ˆçŠ¶æ€å†å²ï¼‰

```sql
CREATE TABLE lead_status_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    lead_id UUID NOT NULL,                    -- çº¿ç´¢ID
    
    from_status VARCHAR(50),                  -- åŸçŠ¶æ€
    to_status VARCHAR(50) NOT NULL,           -- æ–°çŠ¶æ€
    comment TEXT,                             -- å˜æ›´è¯´æ˜
    
    changed_at TIMESTAMP DEFAULT NOW(),
    changed_by_id UUID,                       -- å˜æ›´äºº
    
    FOREIGN KEY (lead_id) REFERENCES leads(id) ON DELETE CASCADE,
    FOREIGN KEY (changed_by_id) REFERENCES users(id)
);

CREATE INDEX idx_status_history_lead ON lead_status_history(lead_id);
CREATE INDEX idx_status_history_changed_at ON lead_status_history(changed_at);
```

---

## ğŸ” æƒé™æ§åˆ¶ï¼ˆRLSï¼‰

### è§’è‰²å®šä¹‰

```typescript
enum UserRole {
  SALES_STORE = 'SALES_STORE',           // é©»åº—é”€å”®
  SALES_REMOTE = 'SALES_REMOTE',         // è¿œç¨‹é”€å”®
  LEAD_SALES = 'LEAD_SALES',             // é”€å”®ä¸»ç®¡
  SALES_CHANNEL = 'SALES_CHANNEL',       // æ¸ é“ä¸»ç®¡
  SERVICE_DISPATCH = 'SERVICE_DISPATCH', // æœåŠ¡è°ƒåº¦
  SERVICE_MEASURE = 'SERVICE_MEASURE',   // æµ‹é‡å¸ˆ
  SERVICE_INSTALL = 'SERVICE_INSTALL',   // å®‰è£…å¸ˆ
  PARTNER_DESIGNER = 'PARTNER_DESIGNER', // è®¾è®¡å¸ˆ
  DELIVERY_SERVICE = 'DELIVERY_SERVICE', // äº¤ä»˜æœåŠ¡
  OTHER_FINANCE = 'OTHER_FINANCE',       // è´¢åŠ¡
  OTHER_CUSTOMER = 'OTHER_CUSTOMER',     // å®¢æˆ·
  LEAD_ADMIN = 'LEAD_ADMIN',             // ç³»ç»Ÿç®¡ç†å‘˜
  LEAD_CHANNEL = 'LEAD_CHANNEL',         // æ¸ é“è¿è¥
  LEAD_GENERAL = 'LEAD_GENERAL'          // æ™®é€šå‘˜å·¥
}
```

---

### RLS ç­–ç•¥

#### åŸºæœ¬æŸ¥çœ‹æƒé™

```sql
-- é”€å”®åªèƒ½çœ‹åˆ°è‡ªå·±çš„çº¿ç´¢
CREATE POLICY "é”€å”®æŸ¥çœ‹æƒé™"
ON leads FOR SELECT
TO authenticated
USING (
  assigned_to_id = auth.uid()
  OR
  created_by_id = auth.uid()
  OR
  EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role IN ('LEAD_SALES', 'LEAD_ADMIN')
  )
);
```

#### çŠ¶æ€å˜æ›´æƒé™

```sql
-- ä¸åŒè§’è‰²å¯ä»¥ä¿®æ”¹ä¸åŒçŠ¶æ€çš„çº¿ç´¢
CREATE POLICY "çŠ¶æ€å˜æ›´æƒé™"
ON leads FOR UPDATE
TO authenticated
USING (
  validate_lead_status_transition(id, status, auth.uid())
);

-- éªŒè¯å‡½æ•°
CREATE OR REPLACE FUNCTION validate_lead_status_transition(
  lead_id UUID,
  new_status VARCHAR,
  user_id UUID
) RETURNS BOOLEAN AS $$
DECLARE
  user_role VARCHAR;
  current_status VARCHAR;
  allowed_roles TEXT[];
BEGIN
  -- è·å–ç”¨æˆ·è§’è‰²
  SELECT role INTO user_role FROM users WHERE id = user_id;
  
  -- è·å–å½“å‰çŠ¶æ€
  SELECT status INTO current_status FROM leads WHERE id = lead_id;
  
  -- æ ¹æ®é…ç½®æ£€æŸ¥æƒé™
  SELECT visibleTo INTO allowed_roles
  FROM lead_status_config
  WHERE status_key = new_status;
  
  RETURN user_role = ANY(allowed_roles);
END;
$$ LANGUAGE plpgsql;
```

---

## â° æ—¶æ•ˆç®¡ç†

### æ—¶æ•ˆé…ç½®è¡¨

```typescript
export const LEAD_STATUS_TIMELIMIT_CONFIG = {
  PENDING_ASSIGNMENT: {
    timeLimitHours: 24,        // 24å°æ—¶å†…å¿…é¡»åˆ†é…
    reminderHours: 12,         // 12å°æ—¶æ—¶æé†’
    timeoutAction: 'alert',    // è¶…æ—¶åæŠ¥è­¦
    timeoutPenalty: {
      48: 5,                    // è¶…è¿‡48å°æ—¶æ‰£5åˆ†
      72: 10                    // è¶…è¿‡72å°æ—¶æ‰£10åˆ†
    }
  },
  PENDING_FOLLOW_UP: {
    timeLimitHours: 72,
    reminderHours: 48,
    timeoutAction: 'alert',
    timeoutPenalty: {
      96: 'alert_manager',
      120: { penalty: 5, action: 'return' }  // é€€å›å¾…åˆ†é…
    }
  },
  FOLLOWING_UP: {
    timeLimitHours: 720,       // 30å¤©
    reminderHours: 672,        // 28å¤©
    timeoutAction: 'alert',
    timeoutPenalty: {
      1008: 5                   // è¶…è¿‡42å¤©æ‰£5åˆ†
    }
  }
  // ... å…¶ä»–39ä¸ªçŠ¶æ€çš„é…ç½®
};
```

### æ—¶æ•ˆæ£€æŸ¥å‡½æ•°

```sql
CREATE OR REPLACE FUNCTION check_lead_timeout()
RETURNS TABLE(
  lead_id UUID,
  status VARCHAR,
  hours_overdue INT,
  penalty INT
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    l.id,
    l.status,
    EXTRACT(EPOCH FROM (NOW() - l.last_status_change_at)) / 3600 AS hours,
    calculate_penalty(l.status, hours) AS penalty
  FROM leads l
  WHERE l.status IN (
    SELECT status_key FROM lead_status_time_limits
    WHERE time_limit_hours IS NOT NULL
  )
  AND (NOW() - l.last_status_change_at) > 
      (SELECT time_limit_hours * INTERVAL '1 hour' 
       FROM lead_status_time_limits 
       WHERE status_key = l.status);
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸš¨ é¢„è­¦ç³»ç»Ÿ

### 8ç§é¢„è­¦ç±»å‹

#### 1. è·Ÿè¸ªé€¾æœŸé¢„è­¦ï¼ˆfollow_up_staleï¼‰

**å®šä¹‰**ï¼šçº¿ç´¢è¶…è¿‡7å¤©æ— è·Ÿè¿›è®°å½•

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT id, name, phone, last_follow_up_time
FROM leads
WHERE status = 'FOLLOWING_UP'
  AND (
    SELECT MAX(created_at) 
    FROM lead_follow_up_records 
    WHERE lead_id = leads.id
  ) < NOW() - INTERVAL '7 days'
  OR NOT EXISTS (
    SELECT 1 FROM lead_follow_up_records 
    WHERE lead_id = leads.id
  );
```

---

#### 2. å·²æŠ¥ä»·æ— è‰ç­¾é¢„è­¦ï¼ˆquoted_no_draftï¼‰

**å®šä¹‰**ï¼šå·²å‘æŠ¥ä»·å•14å¤©ï¼Œå®¢æˆ·æœªè‰ç­¾

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT l.id, l.name, q.created_at AS quote_created
FROM leads l
JOIN quotes q ON q.lead_id = l.id
WHERE l.status = 'FOLLOWING_UP'
  AND q.created_at < NOW() - INTERVAL '14 days'
  AND l.status != 'DRAFT_SIGNED';
```

---

#### 3. æµ‹é‡é€¾æœŸé¢„è­¦ï¼ˆmeasurement_overdueï¼‰

**å®šä¹‰**ï¼šå®‰æ’æµ‹é‡åè¶…è¿‡48å°æ—¶æœªå®Œæˆ

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT id, name, status, last_status_change_at
FROM leads
WHERE status IN ('MEASURING_PENDING_VISIT', 'MEASURING_PENDING_CONFIRMATION')
  AND last_status_change_at < NOW() - INTERVAL '48 hours';
```

---

#### 4. è¿ç»­æ— è·Ÿè¿›é¢„è­¦ï¼ˆno_follow_up_7daysï¼‰

**å®šä¹‰**ï¼šä»»æ„çº¿ç´¢7å¤©å†…æ— ä»»ä½•æ“ä½œ

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT id, name, status, updated_at
FROM leads
WHERE updated_at < NOW() - INTERVAL '7 days'
  AND status NOT IN ('COMPLETED', 'CANCELLED', 'EXPIRED');
```

---

#### 5. é«˜æ„å‘å®¢æˆ·æ— è·Ÿè¿›ï¼ˆhigh_intent_staleï¼‰

**å®šä¹‰**ï¼šA/Bçº§å®¢æˆ·7å¤©æ— è·Ÿè¿›

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT l.id, l.name, l.customer_level
FROM leads l
LEFT JOIN lead_follow_up_records f ON f.lead_id = l.id
WHERE l.customer_level IN ('A', 'B')
  AND l.status = 'FOLLOWING_UP'
  AND (
    SELECT MAX(created_at) 
    FROM lead_follow_up_records 
    WHERE lead_id = l.id
  ) < NOW() - INTERVAL '7 days';
```

---

#### 6. é¢„ç®—è¶…æ”¯é¢„è­¦ï¼ˆbudget_exceededï¼‰

**å®šä¹‰**ï¼šæŠ¥ä»·é‡‘é¢è¶…å‡ºå®¢æˆ·é¢„ç®—30%

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT l.id, l.name, l.budget_max, q.total_amount
FROM leads l
JOIN quotes q ON q.lead_id = l.id
WHERE q.total_amount > l.budget_max * 1.3;
```

---

#### 7. æµå¤±é£é™©é¢„è­¦ï¼ˆchurn_riskï¼‰

**å®šä¹‰**ï¼šå®¢æˆ·é•¿æ—¶é—´åœæ»åœ¨æŸé˜¶æ®µ

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT id, name, status, last_status_change_at,
       EXTRACT(DAY FROM NOW() - last_status_change_at) AS days_in_status
FROM leads
WHERE last_status_change_at < NOW() - INTERVAL '30 days'
  AND status IN ('FOLLOWING_UP', 'DRAFT_SIGNED', 'PLAN_PENDING_CONFIRMATION');
```

---

#### 8. ç«å“å¨èƒé¢„è­¦ï¼ˆcompetitor_threatï¼‰

**å®šä¹‰**ï¼šè·Ÿè¿›è®°å½•ä¸­æåˆ°ç«äº‰å¯¹æ‰‹

**SQL æŸ¥è¯¢**ï¼š
```sql
SELECT DISTINCT l.id, l.name, f.content
FROM leads l
JOIN lead_follow_up_records f ON f.lead_id = l.id
WHERE f.content ~* '(ç«äº‰å¯¹æ‰‹|å…¶ä»–å…¬å¸|æ¯”ä»·|å¯¹æ¯”)'
  AND f.created_at > NOW() - INTERVAL '7 days';
```

---

### é¢„è­¦æ•°æ®åº“å‡½æ•°

```sql
CREATE OR REPLACE FUNCTION get_lead_warnings()
RETURNS JSON AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'followUpStale', (SELECT COUNT(*) FROM leads WHERE ...),
    'quotedNoDraft', (SELECT COUNT(*) FROM leads WHERE ...),
    'measurementOverdue', (SELECT COUNT(*) FROM leads WHERE ...),
    'noFollowUp7Days', (SELECT COUNT(*) FROM leads WHERE ...),
    'highIntentStale', (SELECT COUNT(*) FROM leads WHERE ...),
    'budgetExceeded', (SELECT COUNT(*) FROM leads WHERE ...),
    'churnRisk', (SELECT COUNT(*) FROM leads WHERE ...),
    'competitorThreat', (SELECT COUNT(*) FROM leads WHERE ...),
    'total', ...,
    'generated_at', NOW()
  ) INTO result;
  
  RETURN result;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ’» æŠ€æœ¯å®ç°

### å‰ç«¯æ¶æ„

```
/src/features/leads/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ list/
â”‚   â”‚   â”œâ”€â”€ LeadTable.tsx          # çº¿ç´¢åˆ—è¡¨è¡¨æ ¼
â”‚   â”‚   â”œâ”€â”€ LeadFilters.tsx        # ç­›é€‰ç»„ä»¶
â”‚   â”‚   â””â”€â”€ LeadActionButtons.tsx  # æ“ä½œæŒ‰é’®
â”‚   â”œâ”€â”€ detail/
â”‚   â”‚   â”œâ”€â”€ LeadDetailDrawer.tsx   # çº¿ç´¢è¯¦æƒ…æŠ½å±‰
â”‚   â”‚   â””â”€â”€ LeadTimeline.tsx       # æ—¶é—´è½´
â”‚   â”œâ”€â”€ dialogs/
â”‚   â”‚   â”œâ”€â”€ LeadFollowUpController.tsx    # è·Ÿè¿›å¯¹è¯æ¡†
â”‚   â”‚   â”œâ”€â”€ LeadAssignmentController.tsx  # åˆ†é…å¯¹è¯æ¡†
â”‚   â”‚   â””â”€â”€ LeadTrackingController.tsx    # ç¡®è®¤è·Ÿè¸ª
â”‚   â””â”€â”€ dashboard/
â”‚       â”œâ”€â”€ LeadStatsCards.tsx     # ç»Ÿè®¡å¡ç‰‡
â”‚       â””â”€â”€ LeadsPageHeader.tsx    # é¡µé¢å¤´éƒ¨
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useLeadActions.ts          # çº¿ç´¢æ“ä½œé€»è¾‘
â”‚   â””â”€â”€ useLeadsFilters.ts         # ç­›é€‰é€»è¾‘
â””â”€â”€ services/
    â””â”€â”€ leads.client.ts            # API è°ƒç”¨
```

---

### æ ¸å¿ƒ API

#### è·å–çº¿ç´¢åˆ—è¡¨

```typescript
async function getLeads(
  page: number,
  pageSize: number,
  filters: LeadFilter
): Promise<{
  data: Lead[];
  total: number;
  hasNextPage: boolean;
}> {
  let query = supabase
    .from('leads')
    .select('*', { count: 'exact' });
  
  // åº”ç”¨ç­›é€‰
  if (filters.searchTerm) {
    query = query.or(`name.ilike.%${filters.searchTerm}%,phone.ilike.%${filters.searchTerm}%`);
  }
  if (filters.status) {
    query = query.eq('status', filters.status);
  }
  
  // åˆ†é¡µ
  query = query
    .order('created_at', { ascending: false })
    .range((page - 1) * pageSize, page * pageSize - 1);
  
  const { data, count, error } = await query;
  
  return {
    data: data || [],
    total: count || 0,
    hasNextPage: count > page * pageSize
  };
}
```

---

#### æ›´æ–°çº¿ç´¢çŠ¶æ€

```typescript
async function updateLeadStatus(
  id: string,
  status: LeadStatus,
  comment?: string
): Promise<void> {
  const { data: { user } } = await supabase.auth.getUser();
  
  // 1. éªŒè¯çŠ¶æ€æµè½¬
  const { data: validationResult } = await supabase
    .rpc('validate_lead_status_transition', {
      lead_id: id,
      new_status: status,
      current_user_id: user.id
    });
  
  if (!validationResult?.is_valid) {
    throw new Error('Invalid status transition');
  }
  
  // 2. æ›´æ–°çŠ¶æ€
  await supabase
    .from('leads')
    .update({
      status,
      last_status_change_by_id: user.id,
      last_status_change_at: new Date().toISOString()
    })
    .eq('id', id);
  
  // 3. è®°å½•å†å²
  await supabase
    .from('lead_status_history')
    .insert({
      lead_id: id,
      to_status: status,
      changed_by_id: user.id,
      comment
    });
}
```

---

## ğŸ“± ç”¨æˆ·ç•Œé¢

### çº¿ç´¢åˆ—è¡¨é¡µ

**åŠŸèƒ½**ï¼š
- è¡¨æ ¼å±•ç¤ºæ‰€æœ‰çº¿ç´¢
- æ”¯æŒç­›é€‰ï¼ˆçŠ¶æ€/æ¥æº/æ ‡ç­¾/äººå‘˜ï¼‰
- æ”¯æŒæœç´¢ï¼ˆå§“å/ç”µè¯ï¼‰
- æ‰¹é‡æ“ä½œ
- å®æ—¶åˆ·æ–°

**å…³é”®ç»„ä»¶**ï¼š
```tsx
<LeadsPage>
  <LeadsPageHeader stats={stats} />
  <LeadFilters filters={filters} onFilterChange={handleFilter} />
  <LeadTable leads={leads} onAction={handleAction} />
</LeadsPage>
```

---

### çº¿ç´¢è¯¦æƒ…æŠ½å±‰

**åŠŸèƒ½**ï¼š
- æŸ¥çœ‹çº¿ç´¢å®Œæ•´ä¿¡æ¯
- æŸ¥çœ‹è·Ÿè¿›è®°å½•æ—¶é—´è½´
- æŸ¥çœ‹å…³è”çš„æŠ¥ä»·å•
- å¿«é€Ÿæ“ä½œï¼ˆè·Ÿè¿›/åˆ†é…/çŠ¶æ€å˜æ›´ï¼‰

**å…³é”®ç»„ä»¶**ï¼š
```tsx
<LeadDetailDrawer leadId={leadId}>
  <BasicInfo lead={lead} />
  <LeadTimeline records={followUpRecords} />
  <QuotesList quotes={quotes} />
  <ActionButtons lead={lead} />
</LeadDetailDrawer>
```

---

## ğŸ”„ ä¸šåŠ¡è§„åˆ™

### çŠ¶æ€æµè½¬è§„åˆ™

**è§„åˆ™1ï¼šå•å‘æµè½¬**
```
çº¿ç´¢çŠ¶æ€åªèƒ½å¾€å‰æ¨è¿›ï¼Œä¸èƒ½å›é€€
ï¼ˆé™¤éç®¡ç†å‘˜æ‰‹åŠ¨è°ƒæ•´ï¼‰
```

**è§„åˆ™2**ï¼š**å¼ºåˆ¶è·¯å¾„**
```
è‰ç­¾ â†’ å¿…é¡»ç»è¿‡æµ‹é‡ â†’ æ‰èƒ½åˆ°æ–¹æ¡ˆç¡®è®¤
ä¸èƒ½è·³è¿‡æµ‹é‡ç›´æ¥åˆ°æ–¹æ¡ˆ
```

**è§„åˆ™3ï¼šç»ˆæ€é”å®š**
```
COMPLETED/CANCELLED/EXPIRED â†’ ä¸èƒ½å†å˜æ›´
éœ€è¦é‡æ–°åˆ›å»ºçº¿ç´¢
```

---

### åˆ†é…è§„åˆ™

**è§„åˆ™1ï¼šè´Ÿè½½å‡è¡¡**
```
æ–°çº¿ç´¢è‡ªåŠ¨åˆ†é…æ—¶ï¼Œä¼˜å…ˆåˆ†é…ç»™ï¼š
1. å½“å‰è·Ÿè¸ªçº¿ç´¢å°‘çš„é”€å”®
2. æ“…é•¿è¯¥ç±»å‹å®¢æˆ·çš„é”€å”®
3. åœ°ç†ä½ç½®è¿‘çš„é”€å”®
```

**è§„åˆ™2ï¼šé˜²æŠ¢å•**
```
çº¿ç´¢ä¸€æ—¦åˆ†é…ï¼Œ48å°æ—¶å†…ä¸èƒ½é‡æ–°åˆ†é…
ï¼ˆé™¤éé”€å”®ä¸»åŠ¨ç”³è¯·è½¬ç§»ï¼‰
```

**è§„åˆ™3ï¼šæ–°äººä¿æŠ¤**
```
æ–°é”€å”®å…¥èŒ30å¤©å†…ï¼Œæ¯å¤©æœ€å¤šåˆ†é…5ä¸ªçº¿ç´¢
é¿å…å‹åŠ›è¿‡å¤§
```

---

## ğŸ“Š æ•°æ®åˆ†æ

### è½¬åŒ–æ¼æ–—

```sql
SELECT 
  'æ€»çº¿ç´¢æ•°' AS stage, COUNT(*) AS count, 100.0 AS rate
FROM leads
UNION ALL
SELECT 
  'å¼€å§‹è·Ÿè¸ª', 
  COUNT(*), 
  COUNT(*)::FLOAT / (SELECT COUNT(*) FROM leads) * 100
FROM leads WHERE status NOT IN ('PENDING_ASSIGNMENT', 'PENDING_FOLLOW_UP')
UNION ALL
SELECT 
  'è‰ç­¾', 
  COUNT(*), 
  COUNT(*)::FLOAT / (SELECT COUNT(*) FROM leads) * 100
FROM leads WHERE status IN ('DRAFT_SIGNED', ...)
UNION ALL
SELECT 
  'æˆäº¤', 
  COUNT(*), 
  COUNT(*)::FLOAT / (SELECT COUNT(*) FROM leads) * 100
FROM leads WHERE status = 'COMPLETED';
```

**å…¸å‹è½¬åŒ–ç‡**ï¼š
```
100ä¸ªçº¿ç´¢
  â†’ 85ä¸ªå¼€å§‹è·Ÿè¸ªï¼ˆ85%ï¼‰
  â†’ 30ä¸ªè‰ç­¾ï¼ˆ30%ï¼‰
  â†’ 20ä¸ªæˆäº¤ï¼ˆ20%ï¼‰
```

---

## ğŸš€ éƒ¨ç½²ä¸é…ç½®

### 1. æ•°æ®åº“è¿ç§»

```bash
# è¿è¡Œè¿ç§»è„šæœ¬
supabase db push

# éªŒè¯è¡¨ç»“æ„
supabase db diff
```

### 2. RLS ç­–ç•¥å¯ç”¨

```sql
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE lead_follow_up_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE lead_assignments ENABLE ROW LEVEL SECURITY;
```

### 3. å®šæ—¶ä»»åŠ¡é…ç½®

```sql
-- æ¯å°æ—¶æ£€æŸ¥è¶…æ—¶çº¿ç´¢
SELECT cron.schedule(
  'check-lead-timeout',
  '0 * * * *',  -- æ¯å°æ—¶
  $$
    SELECT check_lead_timeout();
  $$
);

-- æ¯å¤©ç”Ÿæˆé¢„è­¦æŠ¥å‘Š
SELECT cron.schedule(
  'generate-warnings',
  '0 8 * * *',  -- æ¯å¤©æ—©ä¸Š8ç‚¹
  $$
    REFRESH MATERIALIZED VIEW lead_warnings_summary;
  $$
);
```

---

## ğŸ”® æœªæ¥è§„åˆ’

### Phase 4ï¼šæ™ºèƒ½åŒ–åŠŸèƒ½

- [ ] AI å®¢æˆ·æ„å‘è¯„åˆ†
- [ ] æ™ºèƒ½åˆ†é…ç®—æ³•ä¼˜åŒ–
- [ ] è‡ªåŠ¨è·Ÿè¿›æé†’ï¼ˆåŸºäºå®¢æˆ·è¡Œä¸ºï¼‰
- [ ] é¢„æµ‹å®¢æˆ·æµå¤±é£é™©

### Phase 5ï¼šé›†æˆä¸æ‰©å±•

- [ ] ä¸å¾®ä¿¡/ä¼ä¸šå¾®ä¿¡é›†æˆ
- [ ] ä¸ç”µè¯ç³»ç»Ÿé›†æˆï¼ˆè‡ªåŠ¨è®°å½•é€šè¯ï¼‰
- [ ] ä¸BIç³»ç»Ÿé›†æˆï¼ˆé«˜çº§åˆ†æï¼‰
- [ ] Open APIï¼ˆç¬¬ä¸‰æ–¹ç³»ç»Ÿå¯¹æ¥ï¼‰

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**é‡åˆ°é—®é¢˜ï¼Ÿ**

| ç±»å‹ | è”ç³»æ–¹å¼ |
|------|----------|
| ç³»ç»ŸBug | æäº¤ GitHub Issue |
| åŠŸèƒ½å»ºè®® | äº§å“ç»ç†é‚®ç®± |
| ç´§æ€¥æ•…éšœ | æŠ€æœ¯æ”¯æŒçƒ­çº¿ 400-XXX-XXXX |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-12-12  
**ç»´æŠ¤è€…**: L2C æŠ€æœ¯å›¢é˜Ÿ
