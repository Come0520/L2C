# After-Sales (售后管理) 模块

## 模块概述
售后管理模块负责处理客户订单完成后的退换货、维修及投诉流程。该模块处于系统的核心交付链路末端，直接影响客户满意度和公司成本控制。

## 核心业务流程
1. **工单创建**: 支持按订单发起售后申请（退货、维修、投诉等）。
2. **保修判定**: 自动根据订单完成时间和租户配置判定是否在保修期。
3. **现场处理**: 记录调查、预约、回访及处理过程。
4. **定责管理**:
   - 发起定责：针对工厂、安装工、物流等责任方。
   - 业务闭环：草稿 -> 提交待确认 -> (确认 / 争议 -> 仲裁) -> 财务同步。
5. **财务同步**: 确认后的定责单自动生成供应商扣款对账单（仅限工厂/外部供应商）。

## 关键技术点
- **状态机控制**: 通过 `logic/state-machine.ts` 严格限制工单状态流转。
- **扣款安全控制**: 集成 `logic/deduction-safety.ts` 实时校验责任方信用额度，防止欠款流失。
- **虚拟成本核算**: 使用 `logic/virtual-cost-accounting.ts` 按照科目代码和归属部门进行多维度的成本分摊和报表统计。
- **审计日志**: 所有核心修改操作通过 `AuditService` 记录详细的变更前/后快照。

## 状态机定义
| 状态 | 说明 |
| :--- | :--- |
| PENDING | 待处理 |
| INVESTIGATING | 调查中 |
| PROCESSING | 处理中 |
| PENDING_VISIT | 待上门 |
| PENDING_CALLBACK | 待回访 |
| PENDING_VERIFY | 待核销/验收 |
| CLOSED | 已关闭 (终态) |
| REJECTED | 已驳回 (终态) |

## 目录结构
- `components/`: UI 组件，包括列表、详情、对话框等。
- `logic/`: 核心业务逻辑（状态机、扣款安全、成本核算）。
- `actions.ts`: Server Actions 处理前端请求。
- `utils.ts`: 通用工具函数。
- `__tests__/`: 单元测试。

## 测试标准
- 核心逻辑 (`logic/`) 必须保证 100% 单元测试覆盖。
- 关键 Action 必须包含多场景（常规、边界值、异常路径）测试。
