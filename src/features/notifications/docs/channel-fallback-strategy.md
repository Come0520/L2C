# 通知多通道发送策略与回退机制

> 版本：v1.0 | 最后更新：2026-02-23

---

## 一、通道优先级

系统采用"主通道失败 → 自动降级备用通道"的弹性策略。

| 优先级 | 通道 | 场景 | 触发条件 |
|:---:|:---|:---|:---|
| 1 | 企业微信 (WeChat Work) | 内部员工通知 | 用户绑定了企微账号 |
| 2 | 飞书 (Lark) | 内部员工通知 | 租户配置飞书集成 |
| 3 | 短信 (SMS) | 客户/外部联系人 | 有手机号且业务场景适配 |
| 4 | 站内信 (In-App) | 所有登录用户 | 兜底方案，始终可用 |

---

## 二、回退策略 (Fallback Strategy)

```
发送企微/飞书
  │
  ├── 成功 → 记录日志 → 完成
  │
  └── 失败(DNS/HTTP 5xx/超时)
        │
        ├── 重试 1 次 (指数退避 2s)
        │     │
        │     ├── 成功 → 完成
        │     └── 失败 → 降级至短信
        │               │
        │               ├── 成功 → 完成
        │               └── 失败 → 写入站内信 + 告警 logger.error
```

### 风控阻断场景

当同一号码被短信服务商风控（频率超限）时：

1. `sms-adapter` 捕获 `ERR_RATE_LIMIT` 或 HTTP 429 响应
2. 写入降级记录：`notification_failures` 表
3. 自动切换为站内信兜底
4. 如果目标用户未登录（无法查看站内信），触发 `logger.warn('SMS 风控阻断，无兜底通路')` 并通知管理员

---

## 三、重要注意事项

> [!WARNING]
> 当前实现缺少分布式幂等锁。在多实例/无服务器部署环境下，SLA 超时触发可能导致重复推送。待引入 Redis 锁后解决。

> [!NOTE]
> 用户可在个人设置 → 通知偏好 中拒绝接受非紧急短信或飞书消息。拒绝后系统将仅发送站内信。
