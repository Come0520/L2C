# Quotes 模块内部开发手册 (L5)

## 模块定位
本模块承接了销售线索（Leads）并作为订单（Orders）的前置节点。用户可以通过它管理基础报价单和高级组合报价套餐，同时提供房间（Room）与项目（Item）的多维空间报价。

## 最新 L5 特性与质量保障
经过最近的 L5 重构与演进，Quotes 模块达到了卓越级的企业级开发标准：
- **安全拦截与权限 (L3+)**：全量的租户鉴权，防范越权的数据隔离。包含针对跨租户的引用及查询防护（已验证）。
- **悲观/乐观锁模型**：所有状态流转操作（更新、提交、审批、转订单、解锁等）严格校验并发访问的乐观锁机制，防止高冲突下的脏数据更新。
- **动态算料插件系统**：运用 `StrategyFactory` 为不同建材（墙布、窗帘等）配置特有的算料与打褶策略计算。
- **完善的操作审计与溯源 (D7)**：使用企业级 `logger` 以及配合 `AuditService`，详细落盘每一个 CRUD 修改细节 (新旧值对比)。

## 系统基础目录结构
- `/actions`：Server Actions，被 `createSafeAction` 强封装的数据库执行逻辑。包含安全效验、并发判定。所有的 Schema 都存在 `schema.ts` 并且携带有完整的中文 `.describe()`。
- `/components`：React 客户端视图与重用组件。
- `/calc-strategies`：算料策略的核心接口定义及其独立计算工厂。
- `/services`：用于跨模块处理或需要脱离会话直接被调用的基础抽象（通常和 `actions` 联动）。
- `/__tests__`：涵盖 100 多个分支和安全校验、生命周期、复杂套餐的白盒测试集。

## 开发与验证建议
本模块全面剔除了 `any` 与 `@ts-expect-error`。如果在开发过程中遇到 TS 报红，**请勿使用抑制注释或 `any` 断言**，应始终寻找匹配的 Zod 推导类型或是使用 `unknown` 并强制 `typeof` 验证收窄。
新增加任何算料类别时，请实现在 `calc-strategies` 模式下的新的 `Strategy` 接口即可，无需修改入口核心代码 (Open-Closed Principle)。
