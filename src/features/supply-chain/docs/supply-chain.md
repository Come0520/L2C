# 供应链管理模块需求文档 (Supply Chain)

## 模块概述
供应链模块是 L2C 系统中连接销售订单与实际执行的关键环节。它主要负责从订单拆单、供应商管理、采购流程、加工管理到仓储库存的全链路闭环。

## 核心业务流程

### 1. 拆单引擎 (Split Engine)
拆单引擎负责将主订单 (Order) 转化为可执行的单据。
- **阶段一 (硬拆)**: 根据产品类型 (`productType`) 区分。
    - 成品 (`FINISHED`): 进入成品采购流程。
    - 定制品 (`CUSTOM`): 进入定制加工流程。
- **阶段二 (流向拆)**: 根据供应商能力决定单据类型。
    - 仅供应 -> 采购单 (PO - FABRIC)
    - 仅加工 -> 加工任务 (WO)
    - 兼具 -> 采购单 (PO - FABRIC) + 关联加工

### 2. 采购单管理 (Purchase Order)
- **状态流转**: `DRAFT` -> `PENDING_APPROVAL` -> `CONFIRMED` -> `IN_TRANSIT` -> `RECEIVED` -> `COMPLETED`。
- **财务集成**: 支持预付款、尾款支付确认，以及费用分析（采购成本、物流费、加工费、损耗费）。

### 3. 加工管理 (Processing)
- **加工单**: 针对定制品生成的加工任务。
- **状态流转**: `PENDING` -> `PROCESSING` -> `COMPLETED`。
- **车间分配**: 目前支持缝制 (`SEWING`) 等车间分类。

### 4. 库存管理 (Inventory)
- **多仓库支持**: 支持仓库间的库存调拨。
- **库存预警**: 支持设置安全库存 (`minStock`)，并自动生成补货建议。
- **库存审计**: 所有的库存变动（调整、调拨、入库）均记录审计日志。

### 5. 供应商管理 (Supplier)
- **画像记录**: 基础资料、联系人、供应商类型、评级。
- **价格矩阵**: 支持为同一种产品设置不同供应商的采购价和前置期。
- **等级系统**: 基于交付及时率和质量指标计算实时排名。

## 技术规范
- **Actions 层**: 所有 Server Actions 使用 `createSafeAction` 封装，集成 Zod 校验、权限检查和审计日志。
- **数据一致性**: 涉及多表变动的操作（如拆单、状态批量更新）强制使用事务。
- **性能优化**: 核心列表支持分页，关键路径查询已进行 N+1 优化。

## 审计与合规
- **全链路追踪**: 所有核心 CRUD 操作均记录 `AuditService` 日志，包含操作人、变动前后快照及租户 ID。

## L5 升级标准承诺 (2026-02-22)
- **文档密度 (D4)**: 全量 Action 导出函数均配备详细中文 JSDoc，包含逻辑说明、参数定义及异常抛出。
- **可运维性 (D7)**: 注入高密度系统日志（Prefix: `[supply-chain]`），覆盖所有逻辑入口、分支判断及异常捕获。
- **安全性与隔离**: 严格遵循 Drizzle 租户隔离规范，所有查询强制携带 `tenantId` 过滤。
